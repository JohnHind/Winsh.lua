<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<script id="versionArea" type="text/javascript">
//<![CDATA[
var version = {title: "TiddlyWiki", major: 2, minor: 7, revision: 0, date: new Date("December 15, 2012"), extensions: {}};
//]]>
</script>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="copyright" content="
TiddlyWiki created by Jeremy Ruston, (jeremy [at] osmosoft [dot] com)

Copyright (c) Jeremy Ruston 2004-2007
Copyright (c) UnaMesa Association 2007-2012

Redistribution and use in source and binary forms, with or without modification,
are permitted provided that the following conditions are met:

Redistributions of source code must retain the above copyright notice, this
list of conditions and the following disclaimer.

Redistributions in binary form must reproduce the above copyright notice, this
list of conditions and the following disclaimer in the documentation and/or other
materials provided with the distribution.

Neither the name of the UnaMesa Association nor the names of its contributors may be
used to endorse or promote products derived from this software without specific
prior written permission.

THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS 'AS IS' AND ANY
EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT
SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR
BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN
ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH
DAMAGE.
" />
<!--PRE-HEAD-START-->
<!--{{{-->
<link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' />
<!--}}}-->

<!--PRE-HEAD-END-->
<title> Winsh.lua - Windows shell scripting with the Lua language </title>
<style id="styleArea" type="text/css">
#saveTest {display:none;}
#messageArea {display:none;}
#copyright {display:none;}
#storeArea {display:none;}
#storeArea div {padding:0.5em; margin:1em 0em 0em 0em; border-color:#fff #666 #444 #ddd; border-style:solid; border-width:2px; overflow:auto;}
#shadowArea {display:none;}
#javascriptWarning {width:100%; text-align:center; font-weight:bold; background-color:#dd1100; color:#fff; padding:1em 0em;}
</style>
<!--POST-HEAD-START-->

<!--POST-HEAD-END-->
</head>
<body onload="main();" onunload="if(window.unload) unload();">
<!--PRE-BODY-START-->

<!--PRE-BODY-END-->
<div id="copyright">
Welcome to TiddlyWiki created by Jeremy Ruston; Copyright &copy; 2004-2007 Jeremy Ruston, Copyright &copy; 2007-2011 UnaMesa Association
</div>
<noscript>
<div id="javascriptWarning">
This page requires JavaScript to function properly.<br /><br />If you are using Microsoft Internet Explorer you may need to click on the yellow bar above and select 'Allow Blocked Content'. You must then click 'Yes' on the following security warning.
</div>
</noscript>
<div id="saveTest"></div>
<div id="backstageCloak"></div>
<div id="backstageButton"></div>
<div id="backstageArea"><div id="backstageToolbar"></div></div>
<div id="backstage">
	<div id="backstagePanel"></div>
</div>
<div id="contentWrapper"></div>
<div id="contentStash"></div>
<div id="shadowArea">
<div title="ColorPalette">
<pre>Background: #fff
Foreground: #000
PrimaryPale: #8cf
PrimaryLight: #18f
PrimaryMid: #04b
PrimaryDark: #014
SecondaryPale: #ffc
SecondaryLight: #fe8
SecondaryMid: #db4
SecondaryDark: #841
TertiaryPale: #eee
TertiaryLight: #ccc
TertiaryMid: #999
TertiaryDark: #666
Error: #f88
</pre>
</div>
<div title="EditTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="GettingStarted">
<pre>To get started with this blank [[TiddlyWiki]], you'll need to modify the following tiddlers:
* [[SiteTitle]] &amp; [[SiteSubtitle]]: The title and subtitle of the site, as shown above (after saving, they will also appear in the browser title bar)
* [[MainMenu]]: The menu (usually on the left)
* [[DefaultTiddlers]]: Contains the names of the tiddlers that you want to appear when the TiddlyWiki is opened
You'll also need to enter your username for signing your edits: &lt;&lt;option txtUserName&gt;&gt;
</pre>
</div>
<div title="ImportTiddlers">
<pre>&lt;&lt;importTiddlers&gt;&gt;
</pre>
</div>
<div title="MarkupPreHead">
<pre>&lt;!--{{{--&gt;
&lt;link rel='alternate' type='application/rss+xml' title='RSS' href='index.xml' /&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="OptionsPanel">
<pre>These [[InterfaceOptions]] for customising [[TiddlyWiki]] are saved in your browser

Your username for signing your edits. Write it as a [[WikiWord]] (eg [[JoeBloggs]])

&lt;&lt;option txtUserName&gt;&gt;
&lt;&lt;option chkSaveBackups&gt;&gt; [[SaveBackups]]
&lt;&lt;option chkAutoSave&gt;&gt; [[AutoSave]]
&lt;&lt;option chkRegExpSearch&gt;&gt; [[RegExpSearch]]
&lt;&lt;option chkCaseSensitiveSearch&gt;&gt; [[CaseSensitiveSearch]]
&lt;&lt;option chkAnimate&gt;&gt; [[EnableAnimations]]

----
Also see [[AdvancedOptions]]
</pre>
</div>
<div title="PageTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='header' role='banner' macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;div class='headerShadow'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='headerForeground'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;&amp;nbsp;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;/div&gt;
&lt;div id='mainMenu' role='navigation' refresh='content' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='sidebar'&gt;
&lt;div id='sidebarOptions' role='navigation' refresh='content' tiddler='SideBarOptions'&gt;&lt;/div&gt;
&lt;div id='sidebarTabs' role='complementary' refresh='content' force='true' tiddler='SideBarTabs'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id='displayArea' role='main'&gt;
&lt;div id='messageArea'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div>
<div title="StyleSheetColors">
<pre>/*{{{*/
body {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}

a {color:[[ColorPalette::PrimaryMid]];}
a:hover {background-color:[[ColorPalette::PrimaryMid]]; color:[[ColorPalette::Background]];}
a img {border:0;}

h1,h2,h3,h4,h5,h6 {color:[[ColorPalette::SecondaryDark]]; background:transparent;}
h1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]];}
h2,h3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

.button {color:[[ColorPalette::PrimaryDark]]; border:1px solid [[ColorPalette::Background]];}
.button:hover {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::SecondaryLight]]; border-color:[[ColorPalette::SecondaryMid]];}
.button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::SecondaryDark]];}

.header {background:[[ColorPalette::PrimaryMid]];}
.headerShadow {color:[[ColorPalette::Foreground]];}
.headerShadow a {font-weight:normal; color:[[ColorPalette::Foreground]];}
.headerForeground {color:[[ColorPalette::Background]];}
.headerForeground a {font-weight:normal; color:[[ColorPalette::PrimaryPale]];}

.tabSelected {color:[[ColorPalette::PrimaryDark]];
	background:[[ColorPalette::TertiaryPale]];
	border-left:1px solid [[ColorPalette::TertiaryLight]];
	border-top:1px solid [[ColorPalette::TertiaryLight]];
	border-right:1px solid [[ColorPalette::TertiaryLight]];
}
.tabUnselected {color:[[ColorPalette::Background]]; background:[[ColorPalette::TertiaryMid]];}
.tabContents {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::TertiaryPale]]; border:1px solid [[ColorPalette::TertiaryLight]];}
.tabContents .button {border:0;}

#sidebar {}
#sidebarOptions input {border:1px solid [[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel {background:[[ColorPalette::PrimaryPale]];}
#sidebarOptions .sliderPanel a {border:none;color:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:hover {color:[[ColorPalette::Background]]; background:[[ColorPalette::PrimaryMid]];}
#sidebarOptions .sliderPanel a:active {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::Background]];}

.wizard {background:[[ColorPalette::PrimaryPale]]; border:1px solid [[ColorPalette::PrimaryMid]];}
.wizard h1 {color:[[ColorPalette::PrimaryDark]]; border:none;}
.wizard h2 {color:[[ColorPalette::Foreground]]; border:none;}
.wizardStep {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];
	border:1px solid [[ColorPalette::PrimaryMid]];}
.wizardStep.wizardStepDone {background:[[ColorPalette::TertiaryLight]];}
.wizardFooter {background:[[ColorPalette::PrimaryPale]];}
.wizardFooter .status {background:[[ColorPalette::PrimaryDark]]; color:[[ColorPalette::Background]];}
.wizard .button {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryLight]]; border: 1px solid;
	border-color:[[ColorPalette::SecondaryPale]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryDark]] [[ColorPalette::SecondaryPale]];}
.wizard .button:hover {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Background]];}
.wizard .button:active {color:[[ColorPalette::Background]]; background:[[ColorPalette::Foreground]]; border: 1px solid;
	border-color:[[ColorPalette::PrimaryDark]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryPale]] [[ColorPalette::PrimaryDark]];}

.wizard .notChanged {background:transparent;}
.wizard .changedLocally {background:#80ff80;}
.wizard .changedServer {background:#8080ff;}
.wizard .changedBoth {background:#ff8080;}
.wizard .notFound {background:#ffff80;}
.wizard .putToServer {background:#ff80ff;}
.wizard .gotFromServer {background:#80ffff;}

#messageArea {border:1px solid [[ColorPalette::SecondaryMid]]; background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]];}
#messageArea .button {color:[[ColorPalette::PrimaryMid]]; background:[[ColorPalette::SecondaryPale]]; border:none;}

.popupTiddler {background:[[ColorPalette::TertiaryPale]]; border:2px solid [[ColorPalette::TertiaryMid]];}

.popup {background:[[ColorPalette::TertiaryPale]]; color:[[ColorPalette::TertiaryDark]]; border-left:1px solid [[ColorPalette::TertiaryMid]]; border-top:1px solid [[ColorPalette::TertiaryMid]]; border-right:2px solid [[ColorPalette::TertiaryDark]]; border-bottom:2px solid [[ColorPalette::TertiaryDark]];}
.popup hr {color:[[ColorPalette::PrimaryDark]]; background:[[ColorPalette::PrimaryDark]]; border-bottom:1px;}
.popup li.disabled {color:[[ColorPalette::TertiaryMid]];}
.popup li a, .popup li a:visited {color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border: none;}
.popup li a:active {background:[[ColorPalette::SecondaryPale]]; color:[[ColorPalette::Foreground]]; border: none;}
.popupHighlight {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
.listBreak div {border-bottom:1px solid [[ColorPalette::TertiaryDark]];}

.tiddler .defaultCommand {font-weight:bold;}

.shadow .title {color:[[ColorPalette::TertiaryDark]];}

.title {color:[[ColorPalette::SecondaryDark]];}
.subtitle {color:[[ColorPalette::TertiaryDark]];}

.toolbar {color:[[ColorPalette::PrimaryMid]];}
.toolbar a {color:[[ColorPalette::TertiaryLight]];}
.selected .toolbar a {color:[[ColorPalette::TertiaryMid]];}
.selected .toolbar a:hover {color:[[ColorPalette::Foreground]];}

.tagging, .tagged {border:1px solid [[ColorPalette::TertiaryPale]]; background-color:[[ColorPalette::TertiaryPale]];}
.selected .tagging, .selected .tagged {background-color:[[ColorPalette::TertiaryLight]]; border:1px solid [[ColorPalette::TertiaryMid]];}
.tagging .listTitle, .tagged .listTitle {color:[[ColorPalette::PrimaryDark]];}
.tagging .button, .tagged .button {border:none;}

.footer {color:[[ColorPalette::TertiaryLight]];}
.selected .footer {color:[[ColorPalette::TertiaryMid]];}

.error, .errorButton {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::Error]];}
.warning {color:[[ColorPalette::Foreground]]; background:[[ColorPalette::SecondaryPale]];}
.lowlight {background:[[ColorPalette::TertiaryLight]];}

.zoomer {background:none; color:[[ColorPalette::TertiaryMid]]; border:3px solid [[ColorPalette::TertiaryMid]];}

.imageLink, #displayArea .imageLink {background:transparent;}

.annotation {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; border:2px solid [[ColorPalette::SecondaryMid]];}

.viewer .listTitle {list-style-type:none; margin-left:-2em;}
.viewer .button {border:1px solid [[ColorPalette::SecondaryMid]];}
.viewer blockquote {border-left:3px solid [[ColorPalette::TertiaryDark]];}

.viewer table, table.twtable {border:2px solid [[ColorPalette::TertiaryDark]];}
.viewer th, .viewer thead td, .twtable th, .twtable thead td {background:[[ColorPalette::SecondaryMid]]; border:1px solid [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::Background]];}
.viewer td, .viewer tr, .twtable td, .twtable tr {border:1px solid [[ColorPalette::TertiaryDark]];}

.viewer pre {border:1px solid [[ColorPalette::SecondaryLight]]; background:[[ColorPalette::SecondaryPale]];}
.viewer code {color:[[ColorPalette::SecondaryDark]];}
.viewer hr {border:0; border-top:dashed 1px [[ColorPalette::TertiaryDark]]; color:[[ColorPalette::TertiaryDark]];}

.highlight, .marked {background:[[ColorPalette::SecondaryLight]];}

.editor input {border:1px solid [[ColorPalette::PrimaryMid]];}
.editor textarea {border:1px solid [[ColorPalette::PrimaryMid]]; width:100%;}
.editorFooter {color:[[ColorPalette::TertiaryMid]];}
.readOnly {background:[[ColorPalette::TertiaryPale]];}

#backstageArea {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::TertiaryMid]];}
#backstageArea a {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstageArea a:hover {background:[[ColorPalette::SecondaryLight]]; color:[[ColorPalette::Foreground]]; }
#backstageArea a.backstageSelTab {background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]];}
#backstageButton a {background:none; color:[[ColorPalette::Background]]; border:none;}
#backstageButton a:hover {background:[[ColorPalette::Foreground]]; color:[[ColorPalette::Background]]; border:none;}
#backstagePanel {background:[[ColorPalette::Background]]; border-color: [[ColorPalette::Background]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]] [[ColorPalette::TertiaryDark]];}
.backstagePanelFooter .button {border:none; color:[[ColorPalette::Background]];}
.backstagePanelFooter .button:hover {color:[[ColorPalette::Foreground]];}
#backstageCloak {background:[[ColorPalette::Foreground]]; opacity:0.6; filter:alpha(opacity=60);}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLayout">
<pre>/*{{{*/
* html .tiddler {height:1%;}

body {font-size:.75em; font-family:arial,helvetica; margin:0; padding:0;}

h1,h2,h3,h4,h5,h6 {font-weight:bold; text-decoration:none;}
h1,h2,h3 {padding-bottom:1px; margin-top:1.2em;margin-bottom:0.3em;}
h4,h5,h6 {margin-top:1em;}
h1 {font-size:1.35em;}
h2 {font-size:1.25em;}
h3 {font-size:1.1em;}
h4 {font-size:1em;}
h5 {font-size:.9em;}

hr {height:1px;}

a {text-decoration:none;}

dt {font-weight:bold;}

ol {list-style-type:decimal;}
ol ol {list-style-type:lower-alpha;}
ol ol ol {list-style-type:lower-roman;}
ol ol ol ol {list-style-type:decimal;}
ol ol ol ol ol {list-style-type:lower-alpha;}
ol ol ol ol ol ol {list-style-type:lower-roman;}
ol ol ol ol ol ol ol {list-style-type:decimal;}

.txtOptionInput {width:11em;}

#contentWrapper .chkOptionInput {border:0;}

.externalLink {text-decoration:underline;}

.indent {margin-left:3em;}
.outdent {margin-left:3em; text-indent:-3em;}
code.escaped {white-space:nowrap;}

.tiddlyLinkExisting {font-weight:bold;}
.tiddlyLinkNonExisting {font-style:italic;}

/* the 'a' is required for IE, otherwise it renders the whole tiddler in bold */
a.tiddlyLinkNonExisting.shadow {font-weight:bold;}

#mainMenu .tiddlyLinkExisting,
	#mainMenu .tiddlyLinkNonExisting,
	#sidebarTabs .tiddlyLinkNonExisting {font-weight:normal; font-style:normal;}
#sidebarTabs .tiddlyLinkExisting {font-weight:bold; font-style:normal;}

.header {position:relative;}
.header a:hover {background:transparent;}
.headerShadow {position:relative; padding:4.5em 0 1em 1em; left:-1px; top:-1px;}
.headerForeground {position:absolute; padding:4.5em 0 1em 1em; left:0; top:0;}

.siteTitle {font-size:3em;}
.siteSubtitle {font-size:1.2em;}

#mainMenu {position:absolute; left:0; width:10em; text-align:right; line-height:1.6em; padding:1.5em 0.5em 0.5em 0.5em; font-size:1.1em;}

#sidebar {position:absolute; right:3px; width:16em; font-size:.9em;}
#sidebarOptions {padding-top:0.3em;}
#sidebarOptions a {margin:0 0.2em; padding:0.2em 0.3em; display:block;}
#sidebarOptions input {margin:0.4em 0.5em;}
#sidebarOptions .sliderPanel {margin-left:1em; padding:0.5em; font-size:.85em;}
#sidebarOptions .sliderPanel a {font-weight:bold; display:inline; padding:0;}
#sidebarOptions .sliderPanel input {margin:0 0 0.3em 0;}
#sidebarTabs .tabContents {width:15em; overflow:hidden;}

.wizard {padding:0.1em 1em 0 2em;}
.wizard h1 {font-size:2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizard h2 {font-size:1.2em; font-weight:bold; background:none; padding:0; margin:0.4em 0 0.2em;}
.wizardStep {padding:1em 1em 1em 1em;}
.wizard .button {margin:0.5em 0 0; font-size:1.2em;}
.wizardFooter {padding:0.8em 0.4em 0.8em 0;}
.wizardFooter .status {padding:0 0.4em; margin-left:1em;}
.wizard .button {padding:0.1em 0.2em;}

#messageArea {position:fixed; top:2em; right:0; margin:0.5em; padding:0.5em; z-index:2000; _position:absolute;}
.messageToolbar {display:block; text-align:right; padding:0.2em;}
#messageArea a {text-decoration:underline;}

.tiddlerPopupButton {padding:0.2em;}
.popupTiddler {position: absolute; z-index:300; padding:1em; margin:0;}

.popup {position:absolute; z-index:300; font-size:.9em; padding:0; list-style:none; margin:0;}
.popup .popupMessage {padding:0.4em;}
.popup hr {display:block; height:1px; width:auto; padding:0; margin:0.2em 0;}
.popup li.disabled {padding:0.4em;}
.popup li a {display:block; padding:0.4em; font-weight:normal; cursor:pointer;}
.listBreak {font-size:1px; line-height:1px;}
.listBreak div {margin:2px 0;}

.tabset {padding:1em 0 0 0.5em;}
.tab {margin:0 0 0 0.25em; padding:2px;}
.tabContents {padding:0.5em;}
.tabContents ul, .tabContents ol {margin:0; padding:0;}
.txtMainTab .tabContents li {list-style:none;}
.tabContents li.listLink { margin-left:.75em;}

#contentWrapper {display:block;}
#splashScreen {display:none;}

#displayArea {margin:1em 17em 0 14em;}

.toolbar {text-align:right; font-size:.9em;}

.tiddler {padding:1em 1em 0;}

.missing .viewer,.missing .title {font-style:italic;}

.title {font-size:1.6em; font-weight:bold;}

.missing .subtitle {display:none;}
.subtitle {font-size:1.1em;}

.tiddler .button {padding:0.2em 0.4em;}

.tagging {margin:0.5em 0.5em 0.5em 0; float:left; display:none;}
.isTag .tagging {display:block;}
.tagged {margin:0.5em; float:right;}
.tagging, .tagged {font-size:0.9em; padding:0.25em;}
.tagging ul, .tagged ul {list-style:none; margin:0.25em; padding:0;}
.tagClear {clear:both;}

.footer {font-size:.9em;}
.footer li {display:inline;}

.annotation {padding:0.5em; margin:0.5em;}

* html .viewer pre {width:99%; padding:0 0 1em 0;}
.viewer {line-height:1.4em; padding-top:0.5em;}
.viewer .button {margin:0 0.25em; padding:0 0.25em;}
.viewer blockquote {line-height:1.5em; padding-left:0.8em;margin-left:2.5em;}
.viewer ul, .viewer ol {margin-left:0.5em; padding-left:1.5em;}

.viewer table, table.twtable {border-collapse:collapse; margin:0.8em 1.0em;}
.viewer th, .viewer td, .viewer tr,.viewer caption,.twtable th, .twtable td, .twtable tr,.twtable caption {padding:3px;}
table.listView {font-size:0.85em; margin:0.8em 1.0em;}
table.listView th, table.listView td, table.listView tr {padding:0 3px 0 3px;}

.viewer pre {padding:0.5em; margin-left:0.5em; font-size:1.2em; line-height:1.4em; overflow:auto;}
.viewer code {font-size:1.2em; line-height:1.4em;}

.editor {font-size:1.1em;}
.editor input, .editor textarea {display:block; width:100%; font:inherit;}
.editorFooter {padding:0.25em 0; font-size:.9em;}
.editorFooter .button {padding-top:0; padding-bottom:0;}

.fieldsetFix {border:0; padding:0; margin:1px 0px;}

.zoomer {font-size:1.1em; position:absolute; overflow:hidden;}
.zoomer div {padding:1em;}

* html #backstage {width:99%;}
* html #backstageArea {width:99%;}
#backstageArea {display:none; position:relative; overflow: hidden; z-index:150; padding:0.3em 0.5em;}
#backstageToolbar {position:relative;}
#backstageArea a {font-weight:bold; margin-left:0.5em; padding:0.3em 0.5em;}
#backstageButton {display:none; position:absolute; z-index:175; top:0; right:0;}
#backstageButton a {padding:0.1em 0.4em; margin:0.1em;}
#backstage {position:relative; width:100%; z-index:50;}
#backstagePanel {display:none; z-index:100; position:absolute; width:90%; margin-left:3em; padding:1em;}
.backstagePanelFooter {padding-top:0.2em; float:right;}
.backstagePanelFooter a {padding:0.2em 0.4em;}
#backstageCloak {display:none; z-index:20; position:absolute; width:100%; height:100px;}

.whenBackstage {display:none;}
.backstageVisible .whenBackstage {display:block;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetLocale">
<pre>/***
StyleSheet for use when a translation requires any css style changes.
This StyleSheet can be used directly by languages such as Chinese, Japanese and Korean which need larger font sizes.
***/
/*{{{*/
body {font-size:0.8em;}
#sidebarOptions {font-size:1.05em;}
#sidebarOptions a {font-style:normal;}
#sidebarOptions .sliderPanel {font-size:0.95em;}
.subtitle {font-size:0.8em;}
.viewer table.listView {font-size:0.95em;}
/*}}}*/
</pre>
</div>
<div title="StyleSheetPrint">
<pre>/*{{{*/
@media print {
#mainMenu, #sidebar, #messageArea, .toolbar, #backstageButton, #backstageArea {display: none !important;}
#displayArea {margin: 1em 1em 0em;}
noscript {display:none;} /* Fixes a feature in Firefox 1.5.0.2 where print preview displays the noscript content */
}
/*}}}*/
</pre>
</div>
<div title="ViewTemplate">
<pre>&lt;!--{{{--&gt;
&lt;div class='toolbar' role='navigation' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;div class='subtitle'&gt;&lt;span macro='view modifier link'&gt;&lt;/span&gt;, &lt;span macro='view modified date'&gt;&lt;/span&gt; (&lt;span macro='message views.wikified.createdPrompt'&gt;&lt;/span&gt; &lt;span macro='view created date'&gt;&lt;/span&gt;)&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='tagged' macro='tags'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;
</pre>
</div></div>
<!--POST-SHADOWAREA-->
<div id="storeArea">
<div title="(default) on http://www.tiddlytools.com/" creator="John Hind" modifier="John Hind" created="201102131527" modified="201102131619" tags="systemServer excludeLists excludeSearch excludeMissing" changecount="3">
<pre>|''Type:''|file|
|''URL:''|http://www.tiddlytools.com/|
|''Workspace:''|(default)|

This tiddler was automatically created to record the details of this server</pre>
</div>
<div title="AdvancedOptions" creator="John Hind" modifier="John Hind" created="201102031653" modified="201102061448" tags="excludeLists excludeSearch excludeMissing" changecount="3">
<pre>&lt;&lt;options&gt;&gt;{{smallform{{{wrap{&lt;&lt;tiddler PluginOptions&gt;&gt;}}}}}}</pre>
</div>
<div title="AdvancedOptionsPlugin" modifier="ELSDesignStudios" created="200804081651" modified="200907240906" tags="systemConfig BasicsPackage excludeSearch excludeLists excludeMissing" changecount="2">
<pre>/***
|Name|AdvancedOptionsPlugin|
|Source|http://www.TiddlyTools.com/#AdvancedOptionsPlugin|
|Documentation|http://www.TiddlyTools.com/#AdvancedOptionsPlugin|
|Version|1.2.0|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.3|
|Type|plugin|
|Requires||
|Overrides||
|Options|##Configuration|
|Description|automatically add plugin-defined options to the [[AdvancedOptions]] shadow tiddler|
!!!!!Usage
&lt;&lt;&lt;
At document startup, this plugin examines each tiddler tagged with &lt;&lt;tag systemConfig&gt;&gt; and looks for a tiddler slice named &quot;Options&quot; whose value refers to a tiddler section (or separate tiddler) that contains an 'advanced options control panel' for configuring that plugin's features and behavior.  For each plugin that contains an &quot;Options&quot; slice, a tabbed entry is automatically created in the [[AdvancedOptions]] shadow tiddler to display that plugin's control panel.

As an optional fallback for backward-compatibility with plugin tiddlers that do not define the &quot;Options&quot; slice, this plugin will also look for a section heading named &quot;Configuration&quot; within those tiddlers, so that older plugins that define this section can automatically have their settings added to the [[AdvancedOptions]] tiddler without requiring the &quot;Options&quot; slice to be added.

This plugin also extends the standard {{{&lt;&lt;option&gt;&gt;}}} macro syntax so you can directly set the internal value of a boolean or text option, without displaying a corresponding checkbox or input field control simply by appending {{{=value}}} syntax to the end of the option ID parameter:
{{{
&lt;&lt;option &quot;txtSomeOption=some text&quot;&gt;&gt;
&lt;&lt;option chkSomeOtherOption=true&gt;&gt; OR &lt;&lt;option chkSomeOtherOption=false&gt;&gt;
}}}
Example: {{{&lt;&lt;option chkAnimate=false&gt;&gt;}}}
&lt;&lt;&lt;
!!!!!Configuration
&lt;&lt;&lt;
&lt;&lt;option chkAdvancedOptions&gt;&gt; automatically add plugin-defined options to the [[AdvancedOptions]] shadow tiddler
&lt;&lt;option chkAdvancedOptionsBackstage&gt;&gt; automatically add plugin-defined options to Backstage menu
&lt;&lt;option chkAdvancedOptionsFallback&gt;&gt; use &lt;&lt;option txtAdvancedOptionsFallback&gt;&gt; section as a fallback for plugins that don't define an ~AdvancedOptions slice
//note: these settings only take effect after reloading the document//
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2009.07.23 [1.2.0] added support for enhanced {{{&lt;&lt;option id=value&gt;&gt;}}} 'direct assignment' syntax
2008.05.09 [1.1.0] add &quot;options&quot; panel to backstage
2008.04.08 [1.0.0] initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.AdvancedOptionsPlugin= {major: 1, minor: 2, revision: 0, date: new Date(2009,7,23)};

if (config.options.chkAdvancedOptions===undefined)
	config.options.chkAdvancedOptions=true;
if (config.options.chkAdvancedOptionsBackstage===undefined)
	config.options.chkAdvancedOptionsBackstage=true;
if (config.options.chkAdvancedOptionsFallback===undefined)
	config.options.chkAdvancedOptionsFallback=true;
if (config.options.txtAdvancedOptionsFallback===undefined)
	config.options.txtAdvancedOptionsFallback=&quot;Configuration&quot;;
if (config.optionsDesc) config.optionsDesc.chkAdvancedOptions=
	&quot;automatically add plugin-defined options to [[AdvancedOptions]]&quot;;
//}}}
//{{{
var items=[];
var fmt=&quot;[[%0 ]] [[view options for %0]] [[%1]]\n&quot;;
var section=config.options.txtAdvancedOptionsFallback;
var plugins=store.getTaggedTiddlers(&quot;systemConfig&quot;);
for (var p=0; p&lt;plugins.length; p++) {
	var tid=plugins[p].title;
	var settings=store.getTiddlerSlice(tid,&quot;Options&quot;);
	if (!settings &amp;&amp; config.options.chkAdvancedOptionsFallback &amp;&amp; store.getTiddlerText(tid+&quot;##&quot;+section))
		settings=&quot;##&quot;+section; // fallback handling for older plugins
	if (settings&amp;&amp;settings.length) {
		if (settings.substr(0,2)==&quot;##&quot;) settings=tid+settings;
		items.push(fmt.format([tid,settings]));
	}
}
if (items.length) config.shadowTiddlers.PluginOptions=
	&quot;!![[Plugin-defined options|PluginManager]]\n&gt;@@text-align:left;&lt;&lt;tabs '' \n&quot;+items.join(' ')+&quot;&gt;&gt;@@&quot;;
if (config.options.chkAdvancedOptions)
	config.shadowTiddlers.AdvancedOptions+=&quot;{{smallform{{{wrap{&lt;&lt;tiddler PluginOptions&gt;&gt;}}}}}}&quot;;
//}}}
//{{{
// // add &quot;options&quot; backstage task
if (config.tasks &amp;&amp; config.options.chkAdvancedOptionsBackstage) { // for TW2.2b3 or above
	config.tasks.options = {
		text: &quot;options&quot;,
		tooltip: &quot;manage plugin-defined option settings&quot;,
		content: &quot;{{smallform{{{groupbox{{{wrap{&lt;&lt;tiddler PluginOptions&gt;&gt;}}}}}}\n{{groupbox small {&lt;&lt;options&gt;&gt;}}}}}}&quot;
	}
	config.backstageTasks.splice(config.backstageTasks.indexOf(&quot;plugins&quot;)+1,0,&quot;options&quot;);
}
//}}}
//{{{
config.macros.option.AOPsave_handler=config.macros.option.handler;
config.macros.option.handler=function(place,macroName,params,wikifier,paramString,tiddler) {
	var parts=params[0].split('=');
	if (parts.length==1) return this.AOPsave_handler.apply(this,arguments);
	var id=parts[0]; var val=(id.substr(0,3)=='txt')?parts[1]:(parts[1]=='true');
	config.options[id]=val;
}
//}}}</pre>
</div>
<div title="AliasList" creator="John Hind" modifier="John Hind" created="201102161722" modified="201102221439" tags="excludeLists excludeMissing excludeSearch" changecount="16">
<pre>Edit to add alias macros here - any text will be dropped.

&lt;&lt;alias hello &quot;//Hello from %0//&quot;&gt;&gt; {{{&lt;&lt;alias hello &quot;//Hello from %0//&quot;&gt;&gt;}}} would be used e.g. {{{&lt;&lt;hello &quot;John&quot;&gt;&gt;}}} producing: &lt;&lt;hello &quot;John&quot;&gt;&gt;
</pre>
</div>
<div title="AliasPlugin" creator="John Hind" modifier="John Hind" created="200509280700" modified="201102161714" tags="systemConfig excludeLists excludeMissing excludeSearch" changecount="2">
<pre>/***
|Name|AliasPlugin|
|Source|http://www.TiddlyTools.com/#AliasPlugin|
|Documentation|http://www.TiddlyTools.com/#AliasPluginInfo|
|Version|1.1.1|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Create text-substitution macros|
Define macros for abbreviations and other &quot;aliases&quot;, and then embed them in the rest of your tiddler content to quickly insert common terms, phrases and links without a lot of repetitive typing.
!!!!!Documentation
&gt; see [[AliasPluginInfo]]
!!!!!Revisions
&lt;&lt;&lt;
2009.09.09 1.1.1 'tiddler' arg passed to wikify() so aliases containing macros render with correct context
| Please see [[AliasPluginInfo]] for previous revision details |
2005.08.12 1.0.0 initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.AliasPlugin= {major: 1, minor: 1, revision: 1, date: new Date(2009,9,9)};
config.macros.alias= { };
config.macros.alias.handler = function(place,macroName,params,wikifier,paramString,tiddler) {
	var alias=params.shift(); if (!alias) return; alias=alias.replace(/ /g,&quot;_&quot;); // don't allow spaces in alias
	if (config.macros[alias]==undefined) { // create new macro (as needed)
		config.macros[alias] = { };
		config.macros[alias].handler =
			function (place,macroName,params,wikifier,paramString,tiddler)
				{ wikify(config.macros[macroName].text.format(params),place,null,tiddler); }
	}
	config.macros[alias].text = params[0]?params.join(' '):alias;	// set alias text
}
//}}}</pre>
</div>
<div title="AppJS" creator="AppJS" modifier="John Hind" created="201208211941" modified="201302082222" tags="systemConfig excludeLists excludeMissing excludeSearch" changecount="2">
<pre>/***
|Name|AppJSPlugin|
|Version|1.1.0|
|Author|Simon Horton, John Hind|
|~CoreVersion|2.7|
|Type|plugin|
|Description|Allows saving in customised AppJS based browser|
!!!!!Code
***/
//{{{
/** 
AppJS Support tested with TikiWiki 2.7 February 08, 2013
**/

if(config.userAgent.indexOf(&quot;appjstw&quot;) != -1)
{
    // The AppJS browser can always load and save using its external functions.
    readOnly = false;
    window.allowSave = function()
    {
        return true;
    }

    window.getLocalPath = function(fileUrl)
    {
        return window.externalJsPath(fileUrl);
    }

    window.saveFile = function(filePath,content)
    {
        return window.externalJsSave(filePath,content);
    }

    window.loadFile = function(filePath)
    {
	return window.externalJsLoad(filePath);
    }	
}
//}}}
</pre>
</div>
<div title="Application Class" creator="John Hind" modifier="John Hind" created="201006021922" modified="201402051520" changecount="15">
<pre>!obj = task.Application(command [, directory])
!obj = task.Application(handle)
Returns a new Application object. Objects of this class each represent a graphical or command-line application. Application objects can be used to start and stop applications, manipulate application windows and to receive notification when the user closes an application. 

The first form with ''command'' string and optional ''directory'' string simply stores these strings in the [[application.Command]] and [[application.Directory]] fields. Use the [[application:open]] method to execute the command and open the application.

The second form takes a ''handle'' to an application which is already open. Handles are returned by the  [[task.application]] function. 
!!Methods
[[application:open]] - Open (start) an application.
[[application:close]] - Close the current window of an application or the entire application.
[[application:window]] - Get or change the current window of an application.
[[application:windowframe]] - Get or set the position and size of the current window of an application.
[[application:windowstate]] - Read or set the state of the current window of an application.
[[application:windowtitle]] - Read the title of the current window of an application.
[[application:sendkeys]] - Make the current window active and send keystrokes to it.
!!Fields
[[application.OnClose]] - Schedule an action to happen when the application is closed.
[[application.Command]] - Command that will run to start the application.
[[application.Directory]] - Home directory in which the application will be started.
[[application.Environment]] - Table of environment variables passed when the application is started.
[[application.WindowFrame]] - Frame object to specify starting window position and size.
[[application.ExitCode]] - The exit code (number) of an application that has closed.
[[application.ImagePath]] - Full path of the process executable when it is running.
[[application.BaseName]] - Base name of the process when it is running.
!!Examples
[[Application Examples]]
</pre>
</div>
<div title="Application Examples" creator="John Hind" modifier="John Hind" created="201402051524" modified="201402141750" changecount="8">
<pre>!! Asyncronous Running
{{{
app = task.Application(&quot;notepad.exe&quot;)
app.OnClose = function() print(&quot;App Closed. Exit Code: &quot;..app.ExitCode) end
if app:open() then
    print(&quot;Script still running after starting Notepad&quot;)
else
    print(&quot;Failed to start Notepad&quot;)
end
}}}
!! Synchronous Running
{{{
app = task.Application(&quot;notepad.exe&quot;)
print(&quot;Starting Notepad - script will hold until it is closed&quot;)
print(app:open('sync'))
print(&quot;Script running again&quot;)
}}}
!! Interact With Running Application
{{{
-- Start notepad before running this example
h = task.application('suffix', &quot;Notepad&quot;)
if h then
    app = task.Application(h)
    print(app)
    f = task.monitors()[1]
    f = f:place('lefttop', app:windowframe())
    app:windowframe(f)
    app:sendkeys(&quot;Typed automatically by Winsh&quot;)
else
    print(&quot;Notepad not running&quot;)
end
}}}
</pre>
</div>
<div title="Bitfield Class" creator="John Hind" modifier="John Hind" created="201312221441" modified="201402041033" changecount="8">
<pre>!bf = Bitfield([template,][ init ...])
''template'' may be the width (a number between 1 and 256), a bitfield to be copied, a Named Range Table (NRT) or it may be omitted provided the initialiser list contains no numbers and does not start with a bitfield. If a bitfield is copied, it will have the same width and NRT (if any) as the original. It will also have the same values initially, but these may be overwritten by initialisers. In all other cases, the bitfield is initialised all {{{false}}} prior to application of initialisers.

If used, the NRT must be a Lua table in which the keys are strings obeying the restrictions for Lua identifiers and the values are range keys returned by the [[bitrange function]]. The width of the produced bitfield is determined from the largest index used in the range keys.

''init'' is a list of zero or more initialisation values which are applied right to left. An internal index cursor is initialised to {{{1}}}. If an initialiser specifies bits outside the width, those bits are discarded.

A binary string value is inserted at the cursor which is then incremented by the length of the string. If the binary string is at the left end of the list, it is duplicated to fill the rest of the width to the left.

A bitfield is copied into the new bitfield at the cursor which is then incremented by the width of the copied bitfield.

A boolean value sets or resets the bit at the cursor which is then incremented by one.

A number (unsigned) may only be used in the left most list position and fills the remaining width from the cursor.

A string which is the name of a constant in the NRT for [[range names]] may also be used. An unbound constant is inserted at the cursor which is then incremented by the width. A bound constant is inserted in its bound range and the cursor moved to the end of the bound range plus one.
{{{
print(Bitfield(4,&quot;1&quot;), &quot;1111&quot;)
print(Bitfield(12,123), &quot;000001111011&quot;)
print(Bitfield(&quot;0110&quot;), &quot;0110&quot;)
print(Bitfield(Bitfield(&quot;10&quot;)), &quot;10&quot;)
print(Bitfield(true,false,true), &quot;101&quot;)
}}}
Bitfield objects support a range of indexing and comparison [[bitfield operations]].
</pre>
</div>
<div title="Bitfield Library" creator="John Hind" modifier="John Hind" created="201312221241" modified="201402211628" changecount="4">
<pre>The Bitfield Library is an alternative to the standard Bitwise Operations library which is deprecated in Winsh.lua. Load the [[Bitfield Class]] and the [[bitrange function]] into the global environment as follows:
{{{
Bitfield = require(&quot;bitfield&quot;).Bitfield
bitrange = require(&quot;bitfield&quot;).bitrange
}}}
The [[Bitfield Class]] returns an object based on Lua userdata which stores a vector of bits (or Booleans) between 1 and 256 bits wide. The state of the bits in a bitfield is mutable, but the width is not (it is established when the bitfield is created).

The [[bitrange function]] returns an opaque string which can be used as an index for a Bitfield object. The string index encodes a contiguous range of bits within the bitfield and also a format to represent the indexed range.

Bitfields may be converted to and from Boolean, binary string, unsigned integer (Number) and [[packed string]] formats.</pre>
</div>
<div title="Class Library" creator="John Hind" modifier="John Hind" created="201005311949" modified="201402211540" changecount="33">
<pre>The Class Library adds generic object orientation support to basic Lua. Most of the other libraries use the Class Library and will load it if it is not already loaded.

The use of Lua's Table Manipulation library is deprecated in Winsh Lua. Instead, Winsh Lua provides object oriented wrappers on the Lua table type. The generic [[Table Class]] is a thin wrapper which does not restrict the use of the table type at all, but adds a couple of useful methods and a self-iterator. [[List Class]] restricts the keys in the table to integers contiguous from {{{1}}} up and provides the features of the Lua Table Manipulation Library extended and implemented as methods. [[Set Class]] allows unrestricted keys, but the only value allowed is boolean {{{true}}}. It provides a comprehensive set of operator overrides expressing set operations. [[DelegateList Class]] is a specialised version of [[List Class]] in which the values are restricted to Lua callable objects (generally this means functions, but ~DelegateList objects are themselves callable as is any table or userdata object with a {{{call}}} metamethod). When you call a ~DelegateList object, it calls all the objects in the list in list order. This is useful in Winsh.lua when you want to assign more than one action to the same event.

Classes are function closures with a specific upvalue pattern. When this function is executed, it returns an //object//. The system supports a wide range of object implementations based on table, userdata or function. The classes implemented in this library produce objects based on table with a metatable. The metatable is also referenced in a class upvalue and characterises the type identity of the class and its objects. These classes implement collections of values and all support in-place conversion of raw tables. Combining this with a syntax shortcut in standard Lua allows a syntax similar to table constructors:
{{{
tab = Table{first=&quot;Mary&quot;,middle=&quot;Jane&quot;,last=&quot;Smith&quot;}
for k,v in tab do print(k .. &quot; = &quot; .. v) end
}}}
The class library can also be used to create new classes in Lua: see [[Creating Classes]].
!!Functions
[[class.istype]] - Return true if a value is of the specified class or type.
[[class.checkmethod]] - Check that a method is correctly called.
[[class.newmeta]] - Create metatable for a new metatable-based class.
[[class.newproto]] - Create a new prototype-based class.
[[class.gettid]] - Return the TID (type identity) of a value.

The following Lua basic functions are also exposed as functions of the class library to facilitate class creation in Lua: ''type'', ''tostring'', ''tonumber'', ''getmetatable'', ''setmetatable'', ''pairs'', ''next'', ''rawget'', ''rawset''.
!!Classes
[[Table Class]] - Basic associative key/value table.
[[List Class]] - Table representing an ordered list of values.
[[Set Class]] - Table representing a set of values.
[[DelegateList Class]] - Specialised callable List containing callables.
</pre>
</div>
<div title="Class Pattern: Function" creator="John Hind" modifier="John Hind" created="201402101252" modified="201402101330" changecount="3">
<pre>The function class pattern is useful for simple objects that only need a single method. The single method is implemented by a function which forms a closure over the fields stored in upvalues.

The following is a simple implementation of this pattern:
{{{
do -- Class 'Counter'
  local _TID = &quot;CounterClass&quot;
  local _TID_O = _TID
  local _C = function()
    local tid = _TID
    local val = 0
    return function()
      local tid = _TID_O
      val = val + 1
      return val
    end
  end
  Counter = _C
end -- Class 'Counter'
}}}
Using this class we can quickly implement two independent counters:
{{{
c1 = Counter()
c2 = Counter()
print(c1(),1)
print(c1(),2)
print(c2(),1)
}}}
In this pattern, the TID is purely used for type testing purposes and is just an arbitrary (but unique) string. The dummy assignments within the Class and Object function closures just put the TID in the upvalues so the type testing works. In order to allow the type matcher to know that the function object is not a class, the upvalue name &quot;_TID&quot; has an arbitrary extension (&quot;&quot;&quot;&quot;_TID_O&quot;&quot;&quot;&quot;), set to the same value. This is a protocol built into the TID determination algorithm:  the name of the TID must be exactly &quot;_TID&quot; for a class, and must begin &quot;_TID&quot; for an object. A class is an object, but an object is not (in this case) a class.
{{{
print(istype(c1, Counter), &quot;true&quot;)
print(istype(c1,'class'), &quot;false&quot;)
print(istype(Counter, 'class'), &quot;true&quot;)
}}}
</pre>
</div>
<div title="Class Pattern: Metatable" creator="John Hind" modifier="John Hind" created="201402101251" modified="201402121627" changecount="5">
<pre>The metatable class pattern is the one used for most of the classes defined by Winsh and it can be used to create new classes in Lua. The objects of this class are based on Lua tables with methods and meta-methods implemented in a class metatable which also characterises the identity of the class. This pattern can also be used to implement classes in 'C' and in this case objects may be either table or userdata.

To create a new class using this pattern, first create a new metatable using the helper function [[class.newmeta]], then create the class closure, methods and metamethods:
{{{
do  -- Class 'MyClass'
  local _TID = class.newmeta()

  -- Class Closure:
  local _C = function(p1)
    local o
    if class.istype(p1, 'rawtable') then o = p1 else o = {} end
    -- Initialisation with other parameter types here
    class.setmetatable(o, _TID)
    return o
  end

  -- Methods:
  function _TID:mymethod()
    class.checkmethod(self, _C)
    print(&quot;Executing 'mymethod'&quot;)
  end

  -- Metamethods:
  function _TID.__add(p1, p2)
    class.checkmethod(p1, _C)
    class.checkmethod(p2, _C)
    local rv = _C()
    rv.value = p1.value + p2.value
    print(&quot;Executing add metamethod&quot;)
    return rv
  end
  
  -- Class Closure is a first-class value, for example, store it as a global:
  MyClass = _C
end -- Class 'MyClass'
}}}
The following code shows this class in action:
{{{
myobject1 = MyClass{value = 13}
myobject2 = MyClass{value = 10}
myobject1:mymethod()
myobject3 = myobject1 + myobject2
print(myobject3.value, 23)
}}}
This pattern readily supports single inheritance by making the base class metatable the metatable of the child class metatable:
{{{
do  -- Class 'ChildClass' (Inherits MyClass)
  local _TID, _PC = class.newmeta(MyClass)

  -- Class Closure:
  local _C = function(p1)
    local o = _PC(p1)
    -- Extra initialisation for child class
    class.setmetatable(o, _TID)
    return o
  end

  -- Methods are inherited automatically, but may be overridden.

  -- To inherit metamethods add explicit delegations:
  _TID.__add = class.gettid(_PC).__add

  ChildClass = _C
end -- Class 'ChildClass'
}}}
The following tests show that &quot;&quot;&quot;ChildClass&quot;&quot;&quot; has successfully inherited the methods and metamethods of the base class:
{{{
myobject1 = ChildClass{value = 13}
myobject2 = ChildClass{value = 10}
myobject1:mymethod()
myobject3 = myobject1 + myobject2
print(myobject3.value, 23)
}}}
&quot;&quot;&quot;MyClass&quot;&quot;&quot; and &quot;&quot;&quot;ChildClass&quot;&quot;&quot; respond to type tests as expected:
{{{
local pc = MyClass()
local cc = ChildClass()
print(istype(cc, ChildClass), &quot;true&quot;)
print(istype(cc, MyClass), &quot;true&quot;)
print(istype(cc, &quot;table&quot;), &quot;true&quot;)
print(istype(pc, MyClass), &quot;true&quot;)
print(istype(pc, ChildClass), &quot;false&quot;)
}}}
</pre>
</div>
<div title="Class Pattern: Prototype" creator="John Hind" modifier="John Hind" created="201402101253" modified="201402121621" changecount="20">
<pre>The prototype class pattern is similar to [[Class Pattern: Metatable]] the key difference being that the methods are referenced in the object table itself rather than in a class metatable. A template object is shallow copied by the class to produce each new object. The class closure encloses a generic copy function with the prototype table stored as an upvalue.

To create a new base class, we use the [[class.newproto]] function with no parameters and then add fields and methods to the prototype table:
{{{
do  -- Class 'MyClass'
  local _C, _PRT = class.newproto()
  _PRT.field = &quot;Hello from MyClass&quot;
  function _PRT:method()
    class.checkmethod(self, _C)
    print(self.field)
  end
  MyClass = _C
end -- Class 'MyClass'
}}}
We can now use this class to create new objects:
{{{
obj = MyClass()
obj:method()
}}}
We can also overwrite (initialise) existing fields when creating a new object:
{{{
obj = MyClass{field = &quot;Hello from obj&quot;}
obj:method()
}}}
Multiple inheritance (aggregation) is supported by supplying a list of objects (not classes) to merge into the prototype:
{{{
do  -- Class 'MyAggregate'
  local _C, _PRT = class.newproto(MyClass())
  _PRT.field = &quot;Hello from MyAggregate&quot;
  MyAggregate = _C
end -- Class 'MyAggregate'

obj = MyAggregate()
obj:method()
}}}
With these class definitions, type checking works as expected:
{{{
ob1 = MyClass()
ob2 = MyAggregate()
print(istype(ob1, MyClass), &quot;true&quot;)
print(istype(ob1, MyAggregate), &quot;false&quot;)
print(istype(ob2, MyClass), &quot;true&quot;)
print(istype(ob2, MyAggregate), &quot;true&quot;)
print(istype(ob2, ob1), &quot;true&quot;)
print(istype(ob1, ob2), &quot;false&quot;)
print(istype(MyClass, 'class'), &quot;true&quot;)
print(istype(ob2, 'class'), &quot;false&quot;)
}}}
</pre>
</div>
<div title="Clipboard Handling" creator="John Hind" modifier="John Hind" created="201311071055" modified="201402151143" changecount="11">
<pre>A number of features of Winsh combine to provide a comprehensive system for automating the Windows Clipboard.

[[task.getclipboard]] and [[task.setclipboard]] allow the clipboard to be accessed and changed in the most common clipboard formats.

[[winsh.onevent]] with the {{{WM.CLIPBOARDUPDATE}}} event (not supported in Windows XP) allows a Lua function to be scheduled to execute whenever the contents of the clipboard is changed.

[[task.application]] with the {{{'cbowner'}}} key allows the creation of an object of the [[Application Class]] representing the application that wrote the data currently on the clipboard. Having created this object, its [[application:window]] method with the {{{'cbowner'}}} key ensures that the correct window of that application is the 'active window'. It would then be possible, for example, to paste data back into that application using its [[application:sendkeys]] method to send a Ctrl+V key sequence to it.

The following script monitors the clipboard for the macro &quot;|date|&quot; and pastes back the current date.
{{{
local replacedate = function()
    if task.getclipboard() ~= &quot;|date|&quot; then return end
    local ap = task.Application(task.application(&quot;cbowner&quot;))
    ap:window(&quot;cbowner&quot;)
    task.setclipboard(Time():format(&quot;%x&quot;))
    ap:sendkeys(VK.CONTROL, &quot;v&quot;)
end
winsh.onevent(WM.CLIPBOARDUPDATE, replacedate)
-- Test: select and copy this |date|
}}}
After executing this script, highlight the text &quot;|date|&quot; in any application and copy it to the clipboard. It will be automatically replaced by the current date.</pre>
</div>
<div title="CollapseTiddlersPlugin" modifier="ELSDesignStudios" created="200601231504" modified="200803062028" tags="systemConfig BasicsPackage excludeSearch excludeLists excludeMissing" changecount="8">
<pre>/***
|Name|CollapseTiddlersPlugin|
|Source|http://gensoft.revhost.net/Collapse.html|
|Version|2008.10.05|
|Author|Bradley Meck (modified by ELS)|
|License|unknown|
|~CoreVersion|2.1|
|Type|plugin|
|Requires|CollapsedTemplate|
|Overrides||
|Description|show/hide content of a tiddler while leaving tiddler title visible|

|ELS 10/5/2008: collapseAll() and expandAll(): added &quot;return false&quot; to button handlers to prevent IE page transition |
|ELS 3/6/2008: refactored code for size reduction, readability, and I18N/L10N-readiness.  Also added 'folded' flag to tiddler elements (for use by other plugins that need to know if tiddler is folded (e.g., [[SinglePageModePlugin]]) |
|ELS 10/11/2007: moved [[FoldFirst]] inline script and converted to {{{&lt;&lt;foldFirst&gt;&gt;}}} macro. |
|ELS 9/12/2007: suspend/resume SinglePageMode (SPM/TPM/BPM) when folding/unfolding tiddlers |
|ELS 6/5/2007: add &quot;return false&quot; at the end of each command handler to prevent IE 'page transition' problem. |
|ELS 3/30/2007: add a shadow definition for CollapsedTemplate.  Tweak ViewTemplate shadow so &quot;fold/unfold&quot; and &quot;focus&quot; toolbar items automatically appear when using default templates.  Remove error check for &quot;CollapsedTemplate&quot; existence, since shadow version will now always work as a fallback. |
|ELS 2/24/2006: added fallback to &quot;CollapsedTemplate&quot; if &quot;WebCollapsedTemplate&quot; is not found |
|ELS 2/6/2006: added check for 'readOnly' flag to use alternative &quot;WebCollapsedTemplate&quot; |

***/

//{{{
config.shadowTiddlers.CollapsedTemplate=
	&quot;&lt;!--{{{--&gt;\
	&lt;div class='toolbar' macro='toolbar expandTiddler collapseOthers closeTiddler closeOthers +editTiddler permalink references jump'&gt;&lt;/div&gt;\
	&lt;div class='title' macro='view title'&gt;&lt;/div&gt;\
	&lt;!--}}}--&gt;&quot;;

// automatically tweak shadow ViewTemplate to add &quot;collapseTiddler collapseOthers&quot; commands
config.shadowTiddlers.ViewTemplate=config.shadowTiddlers.ViewTemplate.replace(/closeTiddler/,&quot;collapseTiddler collapseOthers closeTiddler&quot;);

config.commands.collapseTiddler = {
	text: &quot;fold&quot;,
	tooltip: &quot;Collapse this tiddler&quot;,
	collapsedTemplate: &quot;CollapsedTemplate&quot;,
	webCollapsedTemplate: &quot;WebCollapsedTemplate&quot;,
	handler: function(event,src,title) {
		var e = story.findContainingTiddler(src); if (!e) return false;
		// don't fold tiddlers that are being edited!
		if(story.isDirty(e.getAttribute(&quot;tiddler&quot;))) return false;
		var t=config.commands.collapseTiddler.getCollapsedTemplate();
		config.commands.collapseTiddler.saveTemplate(e);
		config.commands.collapseTiddler.display(title,t);
		e.setAttribute(&quot;folded&quot;,&quot;true&quot;);
		return false;
	},
	getCollapsedTemplate: function() {
		if (readOnly&amp;&amp;store.tiddlerExists(this.webCollapsedTemplate))
			return this.webCollapsedTemplate;
		else
			return this.collapsedTemplate
	},
	saveTemplate: function(e) {
		if (e.getAttribute(&quot;savedTemplate&quot;)==undefined)
			e.setAttribute(&quot;savedTemplate&quot;,e.getAttribute(&quot;template&quot;));

	},
	// fold/unfold tiddler with suspend/resume of single/top/bottom-of-page mode
	display: function(title,t) {
		var opt=config.options;
		var saveSPM=opt.chkSinglePageMode; opt.chkSinglePageMode=false;
		var saveTPM=opt.chkTopOfPageMode; opt.chkTopOfPageMode=false;
		var saveBPM=opt.chkBottomOfPageMode; opt.chkBottomOfPageMode=false;
		story.displayTiddler(null,title,t);
		opt.chkBottomOfPageMode=saveBPM;
		opt.chkTopOfPageMode=saveTPM;
		opt.chkSinglePageMode=saveSPM;
	}
}

config.commands.expandTiddler = {
	text: &quot;unfold&quot;,
	tooltip: &quot;Expand this tiddler&quot;,
	handler: function(event,src,title) {
		var e = story.findContainingTiddler(src); if (!e) return false;
		var t = e.getAttribute(&quot;savedTemplate&quot;);
		config.commands.collapseTiddler.display(title,t);
		e.setAttribute(&quot;folded&quot;,&quot;false&quot;);
		return false;
	}
}

config.macros.collapseAll = {
	text: &quot;collapse all&quot;,
	tooltip: &quot;Collapse all tiddlers&quot;,
	handler: function(place,macroName,params,wikifier,paramString,tiddler){
		createTiddlyButton(place,this.text,this.tooltip,function(){
			story.forEachTiddler(function(title,tiddler){
				if(story.isDirty(title)) return;
				var t=config.commands.collapseTiddler.getCollapsedTemplate();


				config.commands.collapseTiddler.saveTemplate(tiddler);
				config.commands.collapseTiddler.display(title,t);
				tiddler.folded=true;
			});
			return false;
		})
	}
}

config.macros.expandAll = {
	text: &quot;expand all&quot;,
	tooltip: &quot;Expand all tiddlers&quot;,
	handler: function(place,macroName,params,wikifier,paramString,tiddler){
		createTiddlyButton(place,this.text,this.tooltip,function(){
			story.forEachTiddler(function(title,tiddler){
				var t=config.commands.collapseTiddler.getCollapsedTemplate();
				if(tiddler.getAttribute(&quot;template&quot;)!=t) return; // re-display only if collapsed
				var t=tiddler.getAttribute(&quot;savedTemplate&quot;);
				config.commands.collapseTiddler.display(title,t);
				tiddler.folded=false;
			});
			return false;
		})
	}
}

config.commands.collapseOthers = {
	text: &quot;focus&quot;,
	tooltip: &quot;Expand this tiddler and collapse all others&quot;,
	handler: function(event,src,title) {
		var e = story.findContainingTiddler(src); if (!e) return false;
		story.forEachTiddler(function(title,tiddler) {
			if(story.isDirty(title)) return;
			var t=config.commands.collapseTiddler.getCollapsedTemplate();
			if (e==tiddler) t=e.getAttribute(&quot;savedTemplate&quot;);
			config.commands.collapseTiddler.saveTemplate(tiddler);
			config.commands.collapseTiddler.display(title,t);
			tiddler.folded=(e!=tiddler);
		})
		return false;
	}
}

// {{{&lt;&lt;foldFirst&gt;&gt;}}} macro forces tiddler to be folded when *initially* displayed.
// Subsequent re-render does NOT re-fold tiddler, but closing/re-opening tiddler DOES cause it to fold first again.
config.macros.foldFirst = {
	handler: function(place,macroName,params,wikifier,paramString,tiddler){
		var e=story.findContainingTiddler(place);
		if (e.getAttribute(&quot;foldedFirst&quot;)==&quot;true&quot;) return; // already been folded once
		var title=e.getAttribute(&quot;tiddler&quot;)
		var t=config.commands.collapseTiddler.getCollapsedTemplate();
		config.commands.collapseTiddler.saveTemplate(e);
		config.commands.collapseTiddler.display(title,t);
		e.setAttribute(&quot;folded&quot;,&quot;true&quot;);
		e.setAttribute(&quot;foldedFirst&quot;,&quot;true&quot;); // only when tiddler is first rendered
		return false;
	}
}
//}}}</pre>
</div>
<div title="CollapsedTemplate" modifier="John Hind" created="200601231511" modified="201102192117" tags="BasicsPackage template excludeSearch excludeLists excludeMissing" changecount="12">
<pre>&lt;!--{{{--&gt;
&lt;div class='viewHeadingC'&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::CollapsedToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ComLink Library" creator="John Hind" modifier="John Hind" created="201410111923" modified="201410112244" changecount="5">
<pre>The &quot;&quot;&quot;ComLink&quot;&quot;&quot; library provides a ''Winsh Link'' interface using the Windows Operating System com devices ({{{com1:}}} etc.). This includes physical serial ports and virtual com port drivers (VCP) such as USB to serial converters.

As with all ''Winsh Link'' libraries, the Port Class provided by this library is intended to be a base class which can be inherited in Lua by objects implementing higher-level, more specific, interface protocols.

A {{{require}}} statement must be used to load the library and obtain a table of library functions:
{{{
com = require(&quot;ComLink&quot;)
}}}
The library table contains an iterator for device ports and a class from which Port objects may be created.
!!Functions
[[com.ports]] Iterator returns information about available ports.
[[com.op]] Returns an opaque op code for use in [[comport:write]].
!!Classes
[[com.Port Class]] Objects represent an individual port.
</pre>
</div>
<div title="Command Class" creator="John Hind" modifier="John Hind" created="201311231117" modified="201311281837" changecount="12">
<pre>!cmd = winsh.Command([p1 [,action [,value]]])
The Command Class generates objects which represent actions or settings that users may interact with using UI elements such as menus.

Can be initialised using a table constructor, or p1 may be a string which initialises the ''title'' field and optionally a callable which initialises the ''action'' field. A final optional parameter initialises the ''value'' field.

Command objects are callable to trigger an action or implement a change to a setting and may receive three parameters (allowing direct use as a message handler). The first two parameters are ignored and the third is passed through as the second parameter when ''action'' is called. Boolean ''value'' fields are handled automatically, being toggled each time the Command is called (before any ''action'' field is called). Other ''value'' types must be explicitly handled in the ''action'' function.

The Command object has the following fields:
;action
:If present, this field must be a Lua callable object (such as a function). When the Command object is called, this function is called and passed two parameters, the ''value'' field and the third parameter passed in the Command call. If the ''disabled'' field is {{{true}}}, this function is not called.
;value
:If present this field may be of any type which can be edited by a UI element. Currently, only boolean values are supported which correspond to check mark menu items.
;title
:This must be a string value which is used as the label text in UI elements.
;icon
:If present this must be the string name of an icon image in the resources, or an object of [[Icon Class]] from the [[Shell Library]] which is used to represent the command in UI elements.
;disabled
:If present this must be a boolean value indicating if the command is currently available. If this is {{{true}}} an appropriate visual cue will be shown in any UI and the action will not be called.
;default
:If present this must be a boolean value. If {{{true}}} causes the command to be the default command in any UI which supports multiple Commands.
</pre>
</div>
<div title="Command-line Execution" creator="John Hind" modifier="John Hind" created="201005292128" modified="201410030953" changecount="10">
<pre>Winsh.lua supports the same [[command-line]] options as {{{Lua.exe}}} allowing scripts to be stored in separate files with the {{{.lua}}} extension (by default). This is extended with the concept of //script folders//. If the path on the command-line specifies a folder rather than a file, Winsh loads a file {{{start.lua}}} (by default) from that folder. In this case, the folder may also contain library files ({{{.lua}}} and {{{.dll}}}) which may be loaded using Lua {{{require}}} statements. The defaults for the script extension and folder start script may be changed by editing string resources in the exe file (see [[String Table Resources]]).

For example, assuming the following folder layout (relative to the current folder):
{{{
\winsh.exe
\test.lua
\app\start.lua
\app\lib\library1.lua
\app\library2.dll
\app\WinshLua.dll
}}}
Then the command line:
{{{
winsh test.lua
}}}
Would load and run the script {{{test.lua}}}. The command line:
{{{
winsh app
}}}
Would load and run the script {{{app\start.lua}}}. In this case, the script could load libraries using the following Lua statements:
{{{
lib1 = require(&quot;lib.library1&quot;)
lib2 = require(&quot;library2&quot;)
}}}
These examples assume that {{{winsh.exe}}} is copied and renamed from one of the [[Winsh Executables]]. To load a DLL library, the executable must be copied from a {{{D}}} variant and {{{WinshLua.dll}}} must also be present in the app folder.</pre>
</div>
<div title="Console Applications" creator="John Hind" modifier="John Hind" created="201402171127" modified="201402171234" changecount="6">
<pre>Console applications do not have any graphical UI elements and are designed to be run from a '''Command Window'''. Usually, such applications will be built using one of the [[Winsh Executables]] with the Console Subsystem Flag, but what actually characterises such applications is the absence of any graphical UI element usage.

Options for user interaction are limited to:
# Accepting [[command-line]] parameters.
# Detecting that the user pressed a keyboard key ([[winsh.kbhit]]).
# Reading ''stdin'' ([[winsh.file]]).
# Writing to ''stdout'' or ''stderr'' ([[winsh.outputmode]]).
# Returning an ''errorlevel'' value on completion.
</pre>
</div>
<div title="Creating Classes" creator="John Hind" modifier="John Hind" created="201402111951" modified="201402111955" changecount="5">
<pre>Classes in Winsh are function closures which return objects when called. Three different object models are supported:
;[[Class Pattern: Metatable]]
:Objects are based on table class with a class metatable which contains methods and metamethods. Fields are contained in the object table which is built procedurally by the class function. Classes using this pattern defined in C may alternatively be based on userdata type.
;[[Class Pattern: Prototype]]
:Objects are based on table class, but the metatable only contains metamethods. Methods and fields are contained in the object table. New objects are built by copying one or more prototype objects.
;[[Class Pattern: Function]]
:Objects are based on function closures, similar to classes. These objects have only one method and no metamethods. Fields are contained in function upvalues and are built procedurally by the class function.
</pre>
</div>
<div title="Date Formats" modifier="John Hind" created="201103021331" modified="201103021345" tags="excludeLists excludeMissing excludePublished excludeSearch">
<pre>Date formats are strings which contain any combination of the following tokens embedded in literal text and punctuation, for example {{{&quot;DDD the DDth of MMM, YYYY at 0hh:0mm&quot;}}} will format a date and time like {{{&quot;Monday the 23rd of May, 2010 at 13:15&quot;}}}.
| Code | Output |h
|DDD|day of week in full (e.g. &quot;Monday&quot;)|
|ddd|day of week in short (e.g. &quot;Mon&quot;)|
|DD|day of month, without leading zero|
|0DD|day of month, with leading zero if necessary|
|~DDth|day of month with suffix|
|WW|~ISO-8601 week number of year, without leading zero|
|0WW|~ISO-8601 week number, with leading zero if necessary|
|MMM|month in full (e.g. &quot;July&quot;)|
|mmm|short month (e.g. &quot;Jul&quot;)|
|MM|month number, without leading zero|
|0MM|month number, with leading zero if necessary|
|YYYY|four-digit year number|
|YY|two-digit year|
|wYYYY|four-digit year number with respect to week number|
|wYY|two-digit year with respect to week number|
|hh|hours, 24-hour format, without leading zero|
|0hh|hours, 24-hour format, with leading zero if necessary|
|hh12|hours, 12-hour format, without leading zero|
|0hh12|hours, 12-hour format, with leading zero if necessary|
|mm|minutes, without leading zero|
|0mm|minutes, with leading zero if necessary|
|ss|seconds, without leading zero|
|0ss|seconds, with leading zero if necessary|
|am or pm|lowercase AM/PM indicator|
|AM or PM|uppercase AM/PM indicator|
</pre>
</div>
<div title="DefaultTheme" creator="John Hind" modifier="John Hind" created="201102171351" modified="201102181116" tags="excludeLists excludeMissing excludeSearch template" changecount="4">
<pre>|ViewTemplateReadOnly|ViewTemplateReadOnly|

</pre>
</div>
<div title="DefaultTiddlers" creator="ELSDesignStudios" modifier="John Hind" created="200903251247" modified="201005291952" tags="setup excludeSearch excludeLists excludeMissing" changecount="5">
<pre>[tag[startup]]</pre>
</div>
<div title="DelegateList Call" creator="John Hind" modifier="John Hind" created="201005312059" modified="201402040935" changecount="11">
<pre>The ''call'' operation is overridden for objects of the [[DelegateList Class]]. You may call an object of this class with any number of parameters of any type. This results in the callables in the list being called serially and passed these parameters. If one of the callables returns a non-nil value as its first return, no further calls are made and the call to the object returns all of the return values of this callable.
{{{
del = DelegateList{function(...) print(&quot;f1&quot;, ...) end}
del:add(function(p1) print(&quot;f2&quot;, p1) end)
del(&quot;forward&quot;)
del:reverse()
del(&quot;reverse&quot;)
}}}
</pre>
</div>
<div title="DelegateList Class" creator="John Hind" modifier="John Hind" created="201005312042" modified="201402040932" changecount="10">
<pre>!delegate = ~DelegateList( ... )
Creates an object of the ~DelegateList Class, a specialised version of the [[List Class]]. With no parameters, a new empty list is created. With a single table parameter having no metatable, that table is converted in-place into a ~DelegateList object. With any other parameters, a new list is created and the parameters (which must be lua callable objects) are added in order to the list.

The ~DelegateList is a wrapper for a Lua table which inherits all the members of the [[List Class]], restricts the values in the table to Lua callable objects, and adds a metamethod for the call operation. Calling a ~DelegateList object causes all the objects in the list to be called.
!!Methods
[[list:add]] - Add callables to the end of the list.
[[list:insert]] - Insert callables anywhere in the list.
[[list:remove]] - Remove callables from the list.
[[list:reverse]] - Reverse the order of the callables.
!!Metamethods
[[DelegateList Call]] - Call all the callables in the list.
</pre>
</div>
<div title="Drive Class" creator="John Hind" modifier="John Hind" created="201006022001" modified="201402211944" changecount="6">
<pre>!obj = shell.Drive([name] [,free])
Returns a Drive object. This can be used to access information about an existing drive letter, to find the drive letter containing a volume with a specified name or to locate a free drive letter on which to mount a volume.

Parameter ''name'' is a string or an object of [[ShellObject Class]]. If a string, it must either be a volume label or a drive letter followed by a colon (&quot;A:&quot;). If a &quot;&quot;&quot;ShellObject&quot;&quot;&quot;, it is resolved to the drive letter represented by, or containing the object. With a volume label parameter, all available drive letters are checked for a volume with that name and the drive letter of the first match is selected.

Parameter ''free'' is a Boolean and if {{{true}}}, specifies that a free drive letter should be located. Without any parameters, the first free drive letter 'C' or above is selected ('B' then 'A' will be selected if they are free and there are no other free letters). With only the drive letter parameter, that drive letter is selected whether free or not. With a second parameter which evaluates to Boolean {{{true}}}, the specified drive letter is selected if it is free, otherwise the nearest free drive letter is selected.

The function will return {{{nil}}} rather than an object if a drive cannot be selected as specified. There can only be one object for a given drive letter and if the same one is selected again, the same object will be returned.
!!Methods
[[drive:ejectvolume]] - Eject and/or dismount a drive or media.
[[drive:name]] - Return the path string for the drive.
[[drive:type]] - Return information about a volume or drive.
[[drive:space]] - Return the amount of total and free space.
[[drive:emptybin]] - Empty the recycle bin for this drive.
[[drive:label]] - Set a drive label for this drive.
[[drive:format]] - Brings up the format dialog for the drive.
!!Fields
[[drive:OnChange]] - Execute an action when the drive is mounted or dismounted.
!!Examples
[[Drive Examples]]
</pre>
</div>
<div title="Drive Examples" creator="John Hind" modifier="John Hind" created="201402051713" modified="201402051907" changecount="8">
<pre>!!Access Existing Drive
{{{
d = shell.Drive(&quot;C:&quot;)
if d then
    print(d:name('display'))
    print(d:space())
else
    print(&quot;Drive not found&quot;)
end
}}}
!!Find a Free Drive Letter
{{{
d = shell.Drive(&quot;C:&quot;, true)
if d then
    print(&quot;Free drive letter: &quot; .. d:name('letter'))
else
    print(&quot;No free drive letter found&quot;)
end
}}}
!!Find a Drive Letter by Label
{{{
d = shell.Drive(&quot;WRK&quot;)
if d then
    print(&quot;Drive letter: &quot; .. d:name('letter'))
else
    print(&quot;No drive letter has this label&quot;)
end
}}}
!!Respond When a DVD is Changed
{{{
d = shell.Drive(&quot;G:&quot;)
dvdchange = function(...)
    ty, fs, sr = d:type()
    print()
    if fs then
        print(&quot;++ Volume Type: &quot; .. fs .. &quot; Serial: &quot; .. sr)
        print(&quot;   Label: &quot; .. d:name('display'))
        print(&quot;   Size:  &quot; .. d:space())
    else
	print(&quot;-- No Volume Present&quot;)
    end
end
if d and d:type() == 'optical' then
    d.OnChange = dvdchange
    dvdchange()
else
    print(&quot;This drive does not exist or is not DVD&quot;)
end
}}}
!!Physical and Logical Drive Map
The following function returns a table which maps the relationship between physical and logical drives. In this table there is an entry for each logical drive (drive letter) which contains a list of the physical drives carrying its data. There is also a reverse entry for each physical drive which contains a list of the drive letters which depend on it.
{{{
drivemap = function(drv)
  if not drv then drv = &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot; end
  local tab = Table()
  for i = 1, #drv do
    local dl = drv:sub(i,i) .. &quot;:&quot;
    local ob = shell.Drive(dl)
    if ob:type() then
      local pc = ob:name(&quot;physical&quot;)
      if type(pc) ~= &quot;number&quot; then pc = 1 end
      for j = 1, pc do
        local pd = ob:name(&quot;physical&quot;,j)
        if tab[dl] == nil then tab[dl] = List() end
        tab[dl]:add(pd)
      	if tab[pd] == nil then tab[pd] = List() end
      	tab[pd]:add(dl)
      end
    end
  end
  return tab
end

for k,v in drivemap() do
  print(k)
  for i in v do print(&quot;++ &quot;, i) end
end
}}}</pre>
</div>
<div title="EditTemplate" creator="ELSDesignStudios" modifier="John Hind" created="200903251820" modified="201210221854" tags="setup template excludeSearch excludeLists excludeMissing" changecount="11">
<pre>&lt;!--{{{--&gt;
&lt;div class='viewHeading'&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::EditToolbar]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class='editor' macro='edit title'&gt;&lt;/div&gt;
&lt;div macro='annotations'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit text'&gt;&lt;/div&gt;
&lt;div class='editor' macro='edit tags'&gt;&lt;/div&gt;&lt;div class='editorFooter'&gt;&lt;span macro='message views.editor.tagPrompt'&gt;&lt;/span&gt;&lt;span macro='tagChooser excludeLists'&gt;&lt;/span&gt;&lt;/div&gt;
&lt;!--}}}--&gt;&lt;span macro='resizeEditor'&gt;&lt;/span&gt;</pre>
</div>
<div title="Embedded Execution" creator="John Hind" modifier="John Hind" created="201005292133" modified="201402211502" changecount="11">
<pre>Script files and Lua libraries may be embedded in a copy of one of the [[Winsh Executables]] using a [[Resource Editor]]. A ''LUA'' resource named '''START''' (by default) will be loaded and run automatically. Alternatively, a ''LUA'' resource with any name may be specified on the command line. ''LUA'' resources with names starting with a period character can be loaded using Lua {{{require}}} statements (dropping the leading period).

For example, suppose one of the standard executables has been copied and renamed to {{{myapp.exe}}} and resource edited to include the following resources of type '''LUA''':
{{{
START
TEST
.LIBRARY1
.LIB.LIBRARY2
}}}
Executing {{{myapp.exe}}} will run the script in the resource '''START'''. Executing {{{myapp.exe test}}} will run the script in the resource '''TEST'''. In either case, the script may load libraries from the resources using the Lua statements:
{{{
lib1 = require(&quot;library1&quot;)
lib2 = require(&quot;lib.library2&quot;)
}}}
Notice that the leading period must be present in the resource name and absent in the {{{require}}} statement and that resource names are not case sensitive.</pre>
</div>
<div title="Frame Class" creator="John Hind" modifier="John Hind" created="201006021902" modified="201402211744" changecount="8">
<pre>!frame = task.Frame([left , top [,width [, height]]])
Called with two number parameters, the object represents a coordinate pair (point). These parameters default to {{{0}}}. Called with four parameters, the object represents an area. ''height'' defaults to ''width'', so called with three parameters, the object represents a square area.
!!Methods
[[frame:position]] - Return the position.
[[frame:size]] - Return the size (or {{{nil}}}).
[[frame:place]] - Place a frame within another.
</pre>
</div>
<div title="FtdiLink Library" creator="John Hind" modifier="John Hind" created="201407191329" modified="201410112242" changecount="18">
<pre>The &quot;&quot;&quot;FtdiLink&quot;&quot;&quot; library provides a ''Winsh Link'' interface with a number of USB interface chips from Future Technology Devices International (FTDI) via their '&quot;&quot;&quot;D2XX&quot;&quot;&quot; Direct' device driver which must be installed on the computer to enable operation.

http://www.ftdichip.com/Drivers/D2XX.htm

As with all ''Winsh Link'' libraries, the Port Class provided by this library is intended to be a base class which can be inherited in Lua by objects implementing higher-level, more specific, interface protocols.

The library is a superset of the [[ComLink Library]] which can also be used with FTDI devices via their VCP (virtual com port) driver. The &quot;&quot;&quot;FtdiLink&quot;&quot;&quot; library provides more specific port (device) selection features and access to enhanced device features such as GPIO and other link protocols.

This library is dynamically loaded and the file {{{FtdiLink.dll}}} must be located either in the same folder as the Winsh.lua executable or in a side-by-side folder. The Winsh.lua executable cannot be a stand-alone version, it must be linked against {{{WinshLua.dll}}} which itself must be present either in the same, or in a side-by-side folder.

A {{{require}}} statement must be used to load the library and obtain a table of library functions:
{{{
ftdi = require(&quot;FtdiLink&quot;)
}}}
The library table contains an iterator for device ports and a class from which Port objects may be created.
!!Functions
[[ftdi.ports]] Iterator returns information about available ports (FTDI device channels).
{{{ftdi.op}}} (See [[com.op]]) Returns an opaque op code for use in {{{ftdiport:write}}}.
!!Classes
[[ftdi.Port Class]] Objects represent an individual FTDI device port.
</pre>
</div>
<div title="GT table" creator="John Hind" modifier="John Hind" created="201005302021" modified="201311231448" changecount="9">
<pre>The WM table is installed by a standard Lua script stored in a resource and loaded when the ''winsh'' library is loaded. It contains constant definitions for a number of Winsh messages which may be useful to use in [[winsh.onevent]].
;{{{GT.STARTUP}}}
:Occurs when Winsh starts, after all start and initialisation scripts have been executed.
;{{{GT.ERROR}}}
:Occurs whenever an error is reported.
;{{{GT.NOTIFY_LCLICK}}}
:Occurs when the user left-clicks on an icon installed using [[winsh.taskicon]] which does not have a menu assigned to that action.
;{{{GT.NOTIFY_RCLICK}}}
:Occurs when the user right-clicks on an icon installed using [[winsh.taskicon]] which does not have a menu assigned to that action.</pre>
</div>
<div title="GettingStarted" creator="John Hind" modifier="John Hind" created="201102152100" modified="201103091525" tags="menu excludeLists excludePublished excludeSearch excludeMissing">
<pre>{{groupbox{
!Basic Setup
Edit the [[SiteTitle]], [[SiteSubtitle]] and optionally [[SiteCredit]] tiddlers to set the page header.
Enter your name (the author name) {{nowrap{here: &lt;&lt;option txtUserName&gt;&gt; &lt;&lt;refreshDisplay&gt;&gt;.}}} Click here to create your &lt;&lt;editTiddler label:&quot;author record&quot; prompt:{{&quot;create author record for &quot;+author();}} title:{{author();}} text:{{transclude(&quot;NewTiddlerMenu##author&quot;)}} tag:{{transclude(&quot;NewTiddlerMenu::authorTags&quot;)}} focus:text fields:&quot;form:author&quot;&gt;&gt;.
Check here to save changes {{nowrap{automatically: &lt;&lt;option chkAutoSave&gt;&gt;}}} and here to save backups when changes are saved (manually or {{nowrap{automatically): &lt;&lt;option chkSaveBackups&gt;&gt;.}}}
!Editing
The ''new'' menu item provides a list of forms used to create new tiddlers. Alternatively create a link by wrapping a word or phrase in double square brackets ({{{[[link]]}}}) and then click on it. Use the ''form'' edit menu command to assign a form to a tiddler created in this way. You can add or delete forms by editing [[NewTiddlerMenu]]. The [[Markup]] tiddler provides a crib of codes used when editing tiddlers. You can add useful editing macros (aliases) by editing [[AliasList]]. To include a tab with a manually edited table of contents on the left sidebar, add a tiddler [[TabContents]]. The [[Nested Sliders]] markup is useful for producing collapsable heirarchical tables of contents. Add the tag ''excludeLists'' to exclude any tiddler from the Index and Timeline lists. Add the tag ''startup'' to any tiddlers you want to show automatically when the file is opened or alternatively, edit [[DefaultTiddlers]] to specify the tiddlers if the order is important.
&quot;&quot;&quot;|&quot;&quot;&quot; [[Markup]] | [[Nested Sliders]] | [[Macros]] | [[Date Formats]] |
!Checks
These menus show tiddlers which may require editing attention:
| &lt;&lt;tiddler ShowPopup with:
        GettingStarted##alltags tags &quot;list tagged tiddlers&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
        GettingStarted##orphans orphans &quot;list orphan tiddlers&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
        GettingStarted##missing missing &quot;list missing tiddlers&quot; tiddlyLinkExisting auto&gt;&gt; |
!Publication
Publishing the document creates a read-only copy: this original draft must be retained to allow future modifications and re-publication. Tiddlers may be excluded from publication by adding the ''excludePublished'' tag. To publish, press here to create a new &lt;&lt;newTiddler label:imprint prompt:&quot;create a new imprint (release note)&quot; focus:title title:&quot;Release 1.0&quot; text:{{transclude(&quot;NewTiddlerMenu##imprint&quot;)}} tag:imprint tag:excludeLists&gt;&gt; tiddler. Close this slider and complete the imprint form, then press the ''publish as...'' button at the bottom of the imprint tiddler. Imprint tiddlers are listed on the menu below and may be re-used, however it is probably better to use a new one for each release to preserve an audit trail of releases.
| &lt;&lt;tiddler ShowPopup with:
        GettingStarted##imprints imprints &quot;list imprints&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
        GettingStarted##authors authors &quot;list authors&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
        GettingStarted##pubexcl excluded &quot;list tiddlers excluded from publication&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
        GettingStarted##pubincl included &quot;list tiddlers included in publication&quot; tiddlyLinkExisting auto&gt;&gt; |
!Advanced Configuration
Check the ''options'' tab for more configuration options. The menus below show tiddlers which may be edited to customise operation:
| &lt;&lt;tiddler ShowPopup with:
	GettingStarted##settings settings &quot;list settings&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
	GettingStarted##templates templates &quot;list templates&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
	GettingStarted##stylesheets stylesheets &quot;list stylesheets&quot; tiddlyLinkExisting auto&gt;&gt; | /%
%/&lt;&lt;tiddler ShowPopup with:
	GettingStarted##menus menus &quot;list menus&quot; tiddlyLinkExisting auto&gt;&gt; | /%
!%/&lt;&lt;tiddler ShowPopup with:
        GettingStarted##shadowed shadowed &quot;list shadowed tiddlers&quot; tiddlyLinkExisting auto&gt;&gt; |
}}}{{center{{{tiny{-- TiddlyWiki Core Version: &lt;&lt;version&gt;&gt; --}}}}}}/%
!alltags
&lt;&lt;allTags&gt;&gt;
!orphans
&lt;&lt;list orphans&gt;&gt;
!missing
&lt;&lt;list missing&gt;&gt;
!shadowed
&lt;&lt;list shadowed&gt;&gt;
!imprints
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:modified imprint&gt;&gt;
!authors
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title author&gt;&gt;
!pubexcl
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title excludePublished&gt;&gt;
!pubincl
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title not excludePublished&gt;&gt;
!settings
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title settings&gt;&gt;
!templates
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title template&gt;&gt;
!stylesheets
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title stylesheet&gt;&gt;
!menus
&lt;&lt;matchTags inline &quot;[[%0]]&quot; &quot;&lt;br&gt;&quot; sort:title menu&gt;&gt;
!
%/</pre>
</div>
<div title="GotoPlugin" modifier="ELSDesignStudios" created="200605052341" modified="200905221854" tags="NavigationPackage systemConfig BasicsPackage excludeSearch excludeLists excludeMissing" changecount="2">
<pre>/***
|Name|GotoPlugin|
|Source|http://www.TiddlyTools.com/#GotoPlugin|
|Documentation|http://www.TiddlyTools.com/#GotoPluginInfo|
|Version|1.9.2|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides||
|Description|view any tiddler by entering it's title - displays list of possible matches|
''View a tiddler by typing its title and pressing //enter//.''  As you type, a list of possible matches is displayed.  You can scroll-and-click (or use arrows+enter) to select/view a tiddler, or press escape to close the listbox to resume typing.  When the listbox is not displayed, pressing //escape// clears the current input.
!!!Documentation
&gt;see [[GotoPluginInfo]]
!!!Configuration
&lt;&lt;&lt;
*Match titles only after {{twochar{&lt;&lt;option txtIncrementalSearchMin&gt;&gt;}}} or more characters are entered.&lt;br&gt;Use down-arrow to start matching with shorter input.  //Note: This option value is also set/used by [[SearchOptionsPlugin]]//.
*To set the maximum height of the listbox, you can create a tiddler tagged with &lt;&lt;tag systemConfig&gt;&gt;, containing:
//{{{
config.macros.gotoTiddler.listMaxSize=10;  // change this number
//}}}
&lt;&lt;&lt;
!!!Revisions
&lt;&lt;&lt;
2009.05.22 [1.9.2] use reverseLookup() for IncludePlugin
|please see [[GotoPluginInfo]] for additional revision details|
2006.05.05 [0.0.0] started
&lt;&lt;&lt;
!!!Code
***/
//{{{
version.extensions.GotoPlugin= {major: 1, minor: 9, revision: 2, date: new Date(2009,5,22)};

// automatically tweak shadow SideBarOptions to add &lt;&lt;gotoTiddler&gt;&gt; macro above &lt;&lt;search&gt;&gt;
config.shadowTiddlers.SideBarOptions=config.shadowTiddlers.SideBarOptions.replace(/&lt;&lt;search&gt;&gt;/,&quot;{{button{goto}}}\n&lt;&lt;gotoTiddler&gt;&gt;&lt;&lt;search&gt;&gt;&quot;);

if (config.options.txtIncrementalSearchMin===undefined) config.options.txtIncrementalSearchMin=3;

config.macros.gotoTiddler= {
	listMaxSize: 10,
	listHeading: 'Found %0 matching title%1...',
	searchItem: &quot;Search for '%0'...&quot;,
	handler:
	function(place,macroName,params,wikifier,paramString,tiddler) {
		var quiet	=params.contains(&quot;quiet&quot;);
		var showlist	=params.contains(&quot;showlist&quot;);
		var search	=params.contains(&quot;search&quot;);
		params = paramString.parseParams(&quot;anon&quot;,null,true,false,false);
		var instyle	=getParam(params,&quot;inputstyle&quot;,&quot;&quot;);
		var liststyle	=getParam(params,&quot;liststyle&quot;,&quot;&quot;);
		var filter	=getParam(params,&quot;filter&quot;,&quot;&quot;);
		var html=this.html;
		var keyevent=window.event?&quot;onkeydown&quot;:&quot;onkeypress&quot;; // IE event fixup for ESC handling
		html=html.replace(/%keyevent%/g,keyevent);
		html=html.replace(/%search%/g,search);
		html=html.replace(/%quiet%/g,quiet);
		html=html.replace(/%showlist%/g,showlist);
		html=html.replace(/%display%/g,showlist?'block':'none');
		html=html.replace(/%position%/g,showlist?'static':'absolute');
		html=html.replace(/%instyle%/g,instyle);
		html=html.replace(/%liststyle%/g,liststyle);
		html=html.replace(/%filter%/g,filter);
		if (config.browser.isIE) html=this.IEtableFixup.format([html]);
		var span=createTiddlyElement(place,'span');
		span.innerHTML=html; var form=span.getElementsByTagName(&quot;form&quot;)[0];
		if (showlist) this.fillList(form.list,'',filter,search,0);
	},
	html:
	'&lt;form onsubmit=&quot;return false&quot; style=&quot;display:inline;margin:0;padding:0&quot;&gt;\
		&lt;input name=gotoTiddler type=text autocomplete=&quot;off&quot; accesskey=&quot;G&quot; style=&quot;%instyle%&quot;\
			title=&quot;Enter title text... ENTER=goto, SHIFT-ENTER=search for text, DOWN=select from list&quot;\
			onfocus=&quot;this.select(); this.setAttribute(\'accesskey\',\'G\');&quot;\
			%keyevent%=&quot;return config.macros.gotoTiddler.inputEscKeyHandler(event,this,this.form.list,%search%,%showlist%);&quot;\
			onkeyup=&quot;return config.macros.gotoTiddler.inputKeyHandler(event,this,%quiet%,%search%,%showlist%);&quot;&gt;\
		&lt;select name=list style=&quot;display:%display%;position:%position%;%liststyle%&quot;\
			onchange=&quot;if (!this.selectedIndex) this.selectedIndex=1;&quot;\
			onblur=&quot;this.style.display=%showlist%?\'block\':\'none\';&quot;\
			%keyevent%=&quot;return config.macros.gotoTiddler.selectKeyHandler(event,this,this.form.gotoTiddler,%showlist%);&quot;\
			onclick=&quot;return config.macros.gotoTiddler.processItem(this.value,this.form.gotoTiddler,this,%showlist%);&quot;&gt;\
		&lt;/select&gt;&lt;input name=&quot;filter&quot; type=&quot;hidden&quot; value=&quot;%filter%&quot;&gt;\
	&lt;/form&gt;',
	IEtableFixup:
	&quot;&lt;table style='width:100%;display:inline;padding:0;margin:0;border:0;'&gt;\
		&lt;tr style='padding:0;margin:0;border:0;'&gt;&lt;td style='padding:0;margin:0;border:0;'&gt;\
		%0&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&quot;,
	getItems:
	function(list,val,filter) {
		if (!list.cache || !list.cache.length || val.length&lt;=config.options.txtIncrementalSearchMin) {
			// starting new search, fetch and cache list of tiddlers/shadows/tags
			list.cache=new Array();
			if (filter.length) {
				var fn=store.getMatchingTiddlers||store.getTaggedTiddlers;
				var tiddlers=store.sortTiddlers(fn.apply(store,[filter]),'title');
			} else
				var tiddlers=store.reverseLookup('tags','excludeLists');
			for(var t=0; t&lt;tiddlers.length; t++) list.cache.push(tiddlers[t].title);
			if (!filter.length) {
				for (var t in config.shadowTiddlers) list.cache.pushUnique(t);
				var tags=store.getTags();
				for(var t=0; t&lt;tags.length; t++) list.cache.pushUnique(tags[t][0]);
			}
		}
		var found = [];
		var match=val.toLowerCase();
		for(var i=0; i&lt;list.cache.length; i++)
			if (list.cache[i].toLowerCase().indexOf(match)!=-1) found.push(list.cache[i]);
		return found;
	},
	getItemSuffix:
	function(t) {
		if (store.tiddlerExists(t)) return &quot;&quot;;  // tiddler
		if (store.isShadowTiddler(t)) return &quot; (shadow)&quot;; // shadow
		return &quot; (tag)&quot;; // tag
	},
	fillList:
	function(list,val,filter,search,key) {
		if (list.style.display==&quot;none&quot;) return; // not visible... do nothing!
		var indent='\xa0\xa0\xa0';
		var found = this.getItems(list,val,filter); // find matching items...
		found.sort(); // alpha by title
		while (list.length &gt; 0) list.options[0]=null; // clear list
		var hdr=this.listHeading.format([found.length,found.length==1?&quot;&quot;:&quot;s&quot;]);
		list.options[0]=new Option(hdr,&quot;&quot;,false,false);
		for (var t=0; t&lt;found.length; t++) list.options[list.length]=
			new Option(indent+found[t]+this.getItemSuffix(found[t]),found[t],false,false);
		if (search)
			list.options[list.length]=new Option(this.searchItem.format([val]),&quot;*&quot;,false,false);
		list.size=(list.length&lt;this.listMaxSize?list.length:this.listMaxSize); // resize list...
		list.selectedIndex=key==38?list.length-1:key==40?1:0;
	},
	keyProcessed:
	function(ev) { // utility function
		ev.cancelBubble=true; // IE4+
		try{event.keyCode=0;}catch(e){}; // IE5
		if (window.event) ev.returnValue=false; // IE6
		if (ev.preventDefault) ev.preventDefault(); // moz/opera/konqueror
		if (ev.stopPropagation) ev.stopPropagation(); // all
		return false;
	},
	inputEscKeyHandler:
	function(event,here,list,search,showlist) {
		if (event.keyCode==27) {
			if (showlist) { // clear input, reset list
				here.value=here.defaultValue;
				this.fillList(list,'',here.form.filter.value,search,0);
			}
			else if (list.style.display==&quot;none&quot;) // clear input
				here.value=here.defaultValue;
			else list.style.display=&quot;none&quot;; // hide list
			return this.keyProcessed(event);
		}
		return true; // key bubbles up
	},
	inputKeyHandler:
	function(event,here,quiet,search,showlist) {
		var key=event.keyCode;
		var list=here.form.list;
		var filter=here.form.filter;
		// non-printing chars bubble up, except for a few:
		if (key&lt;48) switch(key) {
			// backspace=8, enter=13, space=32, up=38, down=40, delete=46
			case 8: case 13: case 32: case 38: case 40: case 46: break; default: return true;
		}
		// blank input... if down/enter... fall through (list all)... else, and hide or reset list
		if (!here.value.length &amp;&amp; !(key==40 || key==13)) {
			if (showlist) this.fillList(here.form.list,'',here.form.filter.value,search,0);
			else list.style.display=&quot;none&quot;;
			return this.keyProcessed(event);
		}
		// hide list if quiet, or below input minimum (and not showlist)
		list.style.display=(!showlist&amp;&amp;(quiet||here.value.length&lt;config.options.txtIncrementalSearchMin))?'none':'block';
		// non-blank input... enter=show/create tiddler, SHIFT-enter=search for text
		if (key==13 &amp;&amp; here.value.length) return this.processItem(event.shiftKey?'*':here.value,here,list,showlist);
		// up or down key, or enter with blank input... shows and moves to list...
		if (key==38 || key==40 || key==13) { list.style.display=&quot;block&quot;; list.focus(); }
		this.fillList(list,here.value,filter.value,search,key);
		return true; // key bubbles up
	},
	selectKeyHandler:
	function(event,list,editfield,showlist) {
		if (event.keyCode==27) // escape... hide list, move to edit field
			{ editfield.focus(); list.style.display=showlist?'block':'none'; return this.keyProcessed(event); }
		if (event.keyCode==13 &amp;&amp; list.value.length) // enter... view selected item
			{ this.processItem(list.value,editfield,list,showlist); return this.keyProcessed(event); }
		return true; // key bubbles up
	},
	processItem:
	function(title,here,list,showlist) {
		if (!title.length) return;
		list.style.display=showlist?'block':'none';
		if (title==&quot;*&quot;)	{ story.search(here.value); return false; } // do full-text search
		if (!showlist) here.value=title;
		story.displayTiddler(null,title); // show selected tiddler
		return false;
	}
}
//}}}</pre>
</div>
<div title="Icon Class" creator="John Hind" modifier="John Hind" created="201009231002" modified="201402212000" changecount="7">
<pre>!obj = shell.Icon(name [,width [, height]])
Return an Icon object representing one of the icons in the resources of the Winsh exe file. ''name'' must be the name of an Icon Resource. Optional ''width'' and ''height'' enable the size of the icon to be specified in pixels. If missing or less than one, the default size for the computer is used. If only one number is specified, a square icon of that dimension is returned. Returns ''nil'' if the icon cannot be found.

This object can be used to set an icon in [[winsh.taskicon]] or in a [[Command Class]] object used to create a menu. However, it is not normally necessary to construct an Icon object directly as these uses will both accept the icon name in string form. The main purpose of this class is to represent file icons returned by [[shellobject:icon]] allowing them to be used as menu icons.
{{{
ico = shell.Icon(&quot;LOCK&quot;)
}}}</pre>
</div>
<div title="Icon Resources" creator="John Hind" modifier="John Hind" created="201005292258" modified="201402101013" changecount="3">
<pre>You can edit the icon-sets available in the executable. You can change the default icon for Winsh or you can add additional icons which can be used in [[winsh.setidentity]] or [[winsh.taskicon]].
;'''WINSH.LUA'''
:The default icon set used for the application (windows and taskbar). Note that this icon name must match string resource '''9-128'''.
;'''LOCK'''
:This is a sample icon set which may safely be removed if not required.
;'''//xxxx//'''
:Arbitrarily named icon sets may be added and will be available for use in script library functions. The resource must be named with a string not a number.
</pre>
</div>
<div title="InlineJavascriptPlugin" modifier="John Hind" created="200512130544" modified="201102131622" tags="DiscoveryPackage IconPackage MediaPackage TaskPackage TidIDEPackage systemConfig ScrollbarPackage excludeLists excludeSearch excludeMissing" changecount="2">
<pre>/***
|Name|InlineJavascriptPlugin|
|Source|http://www.TiddlyTools.com/#InlineJavascriptPlugin|
|Documentation|http://www.TiddlyTools.com/#InlineJavascriptPluginInfo|
|Version|1.9.6|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Insert Javascript executable code directly into your tiddler content.|
''Call directly into TW core utility routines, define new functions, calculate values, add dynamically-generated TiddlyWiki-formatted output'' into tiddler content, or perform any other programmatic actions each time the tiddler is rendered.
!!!!!Documentation
&gt;see [[InlineJavascriptPluginInfo]]
!!!!!Revisions
&lt;&lt;&lt;
2010.12.15 1.9.6 allow (but ignore) type=&quot;...&quot; syntax
|please see [[InlineJavascriptPluginInfo]] for additional revision details|
2005.11.08 1.0.0 initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.InlineJavascriptPlugin= {major: 1, minor: 9, revision: 6, date: new Date(2010,12,15)};

config.formatters.push( {
	name: &quot;inlineJavascript&quot;,
	match: &quot;\\&lt;script&quot;,
	lookahead: &quot;\\&lt;script(?: type=\\\&quot;[^\\\&quot;]*\\\&quot;)?(?: src=\\\&quot;([^\\\&quot;]*)\\\&quot;)?(?: label=\\\&quot;([^\\\&quot;]*)\\\&quot;)?(?: title=\\\&quot;([^\\\&quot;]*)\\\&quot;)?(?: key=\\\&quot;([^\\\&quot;]*)\\\&quot;)?( show)?\\&gt;((?:.|\\n)*?)\\&lt;/script\\&gt;&quot;,
	handler: function(w) {
		var lookaheadRegExp = new RegExp(this.lookahead,&quot;mg&quot;);
		lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = lookaheadRegExp.exec(w.source)
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var src=lookaheadMatch[1];
			var label=lookaheadMatch[2];
			var tip=lookaheadMatch[3];
			var key=lookaheadMatch[4];
			var show=lookaheadMatch[5];
			var code=lookaheadMatch[6];
			if (src) { // external script library
				var script = document.createElement(&quot;script&quot;); script.src = src;
				document.body.appendChild(script); document.body.removeChild(script);
			}
			if (code) { // inline code
				if (show) // display source in tiddler
					wikify(&quot;{{{\n&quot;+lookaheadMatch[0]+&quot;\n}}}\n&quot;,w.output);
				if (label) { // create 'onclick' command link
					var link=createTiddlyElement(w.output,&quot;a&quot;,null,&quot;tiddlyLinkExisting&quot;,wikifyPlainText(label));
					var fixup=code.replace(/document.write\s*\(/gi,'place.bufferedHTML+=(');
					link.code=&quot;function _out(place,tiddler){&quot;+fixup+&quot;\n};_out(this,this.tiddler);&quot;
					link.tiddler=w.tiddler;
					link.onclick=function(){
						this.bufferedHTML=&quot;&quot;;
						try{ var r=eval(this.code);
							if(this.bufferedHTML.length || (typeof(r)===&quot;string&quot;)&amp;&amp;r.length)
								var s=this.parentNode.insertBefore(document.createElement(&quot;span&quot;),this.nextSibling);
							if(this.bufferedHTML.length)
								s.innerHTML=this.bufferedHTML;
							if((typeof(r)===&quot;string&quot;)&amp;&amp;r.length) {
								wikify(r,s,null,this.tiddler);
								return false;
							} else return r!==undefined?r:false;
						} catch(e){alert(e.description||e.toString());return false;}
					};
					link.setAttribute(&quot;title&quot;,tip||&quot;&quot;);
					var URIcode='javascript:void(eval(decodeURIComponent(%22(function(){try{';
					URIcode+=encodeURIComponent(encodeURIComponent(code.replace(/\n/g,' ')));
					URIcode+='}catch(e){alert(e.description||e.toString())}})()%22)))';
					link.setAttribute(&quot;href&quot;,URIcode);
					link.style.cursor=&quot;pointer&quot;;
					if (key) link.accessKey=key.substr(0,1); // single character only
				}
				else { // run script immediately
					var fixup=code.replace(/document.write\s*\(/gi,'place.innerHTML+=(');
					var c=&quot;function _out(place,tiddler){&quot;+fixup+&quot;\n};_out(w.output,w.tiddler);&quot;;
					try	 { var out=eval(c); }
					catch(e) { out=e.description?e.description:e.toString(); }
					if (out &amp;&amp; out.length) wikify(out,w.output,w.highlightRegExp,w.tiddler);
				}
			}
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	}
} )
//}}}

// // Backward-compatibility for TW2.1.x and earlier
//{{{
if (typeof(wikifyPlainText)==&quot;undefined&quot;) window.wikifyPlainText=function(text,limit,tiddler) {
	if(limit &gt; 0) text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}
//}}}

// // GLOBAL FUNCTION: $(...) -- 'shorthand' convenience syntax for document.getElementById()
//{{{
if (typeof($)=='undefined') { function $(id) { return document.getElementById(id.replace(/^#/,'')); } }
//}}}</pre>
</div>
<div title="Interactive Console" creator="John Hind" modifier="John Hind" created="201005292219" modified="201406071101" changecount="28">
<pre>The interactive console shows if one of the [[Winsh Executables]] with the ''Windows Subsystem Flag'' is run without finding a script. It also appears when necessary to show script errors (by default) and to show the output of the {{{print}}} script function if the {{{winsh.outputmode('gui')}}} option has been selected. Finally, there is a [[command-line]] switch which can be used to show it unconditionally.

The interactive console has two panes. The upper green-on-black pane allows entry of single-line script commands and displays script output and error messages. Lines commencing with the {{{&gt;}}} prompt are executed by pressing '''enter''' with the cursor anwhere in the line. The lower black-on-white pane is a simple text editor for multi-line scripts. The script in the lower pane is executed prior to any command from the upper pane, but only if it has changed since last executed or since the scripting environment was reset.

The console uses a special Lua environment which has read-access to the normal environment used by the scripting, but which does not change that environment (unless the scripting environment table is explicitly referenced). This special environment provides a number of additional features to assist with debugging. Most of these features are defined in the '''&quot;&quot;&quot;INIT-CMD&quot;&quot;&quot;''' resource and can be added to or customised by editing this resource (see [[LUA Script Resources]]). This section assumes the default '''&quot;&quot;&quot;INIT-CMD&quot;&quot;&quot;''' resource shipped in the Winsh.lua executable files has not been changed.

The ''Help'' menu contains commands to show various pieces of information including an inventory of resources available in the executable file or the local filesystem. This information is supplied by functions defined in the '''&quot;&quot;&quot;INIT-CMD&quot;&quot;&quot;''' resource, which may be customised as required.

An evaluation function ({{{onevaluate}}} in '''&quot;&quot;&quot;INIT-CMD&quot;&quot;&quot;''') is invoked when the enter key is pressed in the upper pane, when a double-click is made in either pane, or when the ''Evaluate Selected'' menu item is invoked on a selection in either pane. The supplied handler provides a number of features:
# On a line in the upper pane with a command prompt, the line is copied as a new command (unless it is already the last line) and executed as described above. If there is an {{{=}}} character between the command prompt and the command, the Lua code is pre-processed to display the value of the expression, including enumerating the contents of tables.
# On a line in the upper pane which is an error message, attempts to find the source of the error and highlight it in the upper or lower pane.
# On a line in the inventory or help text, attempts to open any file name, resource name or URL in the lower pane or in a browser.
# On a selection, attempts to open the text as a file name, a resource name or a URL and failing that, to execute the text as a Lua expression using the processor described in 1 above. This is useful for displaying the values of variables and drilling down into nested tables.
There are no file selection dialogs, however files may be explicitly loaded by dragging them from an explorer window onto the interactive console. Modifications to scripts loaded from files can be saved back to the same file. Contents of the editor pane can also be saved by dragging an empty file onto the window. There are menu options to load side-by-side files or folders (creating them if they do not already exist). Finally, files or script resources may be loaded by placing the cursor anywhere in an error message and pressing {{{enter}}}. It is necessary to save changed resource scripts to a file and then replace them in the executable file using a [[Resource Editor]].
</pre>
</div>
<div title="Introduction" creator="John Hind" modifier="John Hind" created="201005272040" modified="201403240925" tags="startup" changecount="11">
<pre>Winsh.lua is an advanced runtime for the [[Lua]] language on Windows. With the supplied libraries it is ideal for writing small, self-contained utilities with simple command line or graphical interfaces such as backup automation scripts, installers and portable application menus.

Winsh.lua is compatible with all versions of Windows starting with Windows XP. However a few library features are only supported in later Windows versions. These are noted in this documentation and are designed to degrade as gracefully as possible.

The starting point for Winsh.lua is a runtime with all the facilities of the standard {{{lua.exe}}} supplied with the Lua distribution. Although Winsh.lua can be run on the command line like {{{lua.exe}}}, it is natively a GUI application with its own console window and other GUI interface elements. Winsh.lua also extends {{{lua.exe}}} with a range of additional ways of running scripts and packaging libraries. Furthermore, Winsh.lua provides a mechanism for hooking Lua functions to Windows and Winsh messages. Libraries supplied with the distribution extend this base to implement a fully functional scripting system for Windows.

Winsh.lua supports four alternative models for locating scripts:
#[[Interactive Console]] - Scripts entered and executed in a simple IDE.
#[[Command-line Execution]] - Scripts specified on the executable command line.
#[[Side-by-side Execution]] - Scripts in a file or folder alongside the executable.
#[[Embedded Execution]] - Scripts in resources of a self-contained executable file.
Winsh.lua supports three alternative application models:
#[[Procedural Applications]] - Utilities and wizards for simple operations.
#[[Resident Applications]] - Menu and event driven applications.
#[[Console Applications]] - Simple utilities run from a text-mode console.
The [[Interactive Console]] and [[Lua]] topics are good starting points for new users.

----
This document was created using the superb and innovative &quot;&quot;&quot;TiddlyWiKi&quot;&quot;&quot;: http://classic.tiddlywiki.com/.</pre>
</div>
<div title="JHBackstagePlugin" creator="John Hind" modifier="John Hind" created="201102041649" modified="201102152102" tags="systemConfig excludeLists excludePublished excludeSearch excludeMissing" changecount="9">
<pre>/***
|Name|JHBackstagePlugin|
|Version|1.0.0|
|Author|John Hind|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Add contents of [[GettingStarted]] shadow tiddler as Backstage 'setup' tab|
!!!!!Revisions
&lt;&lt;&lt;
2011.02.14 [1.0.0] initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.JHBackstagePlugin= {major: 1, minor: 0, revision: 0, date: new Date(2011,02,14)};

config.tasks.myTab = {
	text: &quot;setup&quot;,
	tooltip: &quot;Instructions and tools for setting up the document&quot;,
	content: &quot;&lt;&lt;tiddler GettingStarted&gt;&gt;&quot;
};
config.backstageTasks.push(&quot;myTab&quot;);
//}}}</pre>
</div>
<div title="JHCommandsPlugin" modifier="John Hind" created="201103021007" modified="201103091100" tags="systemConfig excludeLists excludeMissing excludeSearch">
<pre>/***
|Name|JHCommandsPlugin|
|Version|1.0.0|
|Author|John Hind|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Extra commands for tiddler toolbar|
!!!!!Usage
These are additional commands which may be specified in [[ToolbarCommands]].
;refreshTiddler
:Re-renders the tiddler.
;closeAbove
:Closes all tiddlers above this one in the story.
;closeBelow
:Closes all tiddlers below this one in the story.
;tags
:Displays tags attached to the tiddler on a drop-down list.
;forms
:Displays list of forms defined in NewTiddlersMenu. When one is clicked applies that form to the tiddler.
!!!!!Code
***/
//{{{
version.extensions.JHCommandsPlugin= {major: 1, minor: 0, revision: 0, date: new Date(2011,03,02)};

config.commands.refreshTiddler = {
    text: &quot;refresh&quot;,
    tooltip: &quot;Re-render this tiddler&quot;,
    handler: function(event,src,title) {
	var e = story.findContainingTiddler(src); if (!e) return false;
        story.refreshTiddler(e.getAttribute(&quot;tiddler&quot;),null,true);
	return false;
    }
}

config.commands.closeAbove = {
    text: &quot;top&quot;,
    tooltip: &quot;Make this the top by closing all above&quot;,
    handler: function(event,src,title) {
        var results=[];
        var me = title;
        var f = true;
        story.forEachTiddler(function(title,element){
            if (title == me) f = false;
            if (f) results.push(title);
        });
        for (var i = 0; i &lt; results.length; i++) story.closeTiddler(results[i]);
    }
}

config.commands.closeBelow = {
    text: &quot;base&quot;,
    tooltip: &quot;Make this the last by closing all below&quot;,
    handler: function(event,src,title) {
        var results=[];
        var me = title;
        var f = false;
        story.forEachTiddler(function(title,element){
            if (f) results.push(title);
            if (title == me) f = true;
        });
        for (var i = 0; i &lt; results.length; i++) story.closeTiddler(results[i]);
    }
}

config.commands.tags = {
    text: &quot;tags&quot;,
    tooltip: &quot;Show the tags assigned to this tiddler&quot;,
    type: &quot;popup&quot;,
    popupNone: &quot;No tags&quot;,
    handlePopup: function(popup,title){
	var tags = store.getTiddler(title).tags;
	var c = false;
	for(var r=0; r&lt;tags.length; r++) {
	    createTiddlyElement(popup,&quot;li&quot;,null,&quot;&quot;,tags[r]);
	    c = true;
	}
	if(!c) createTiddlyElement(popup,&quot;li&quot;,null,&quot;disabled&quot;,this.popupNone);
    }
}

config.commands.selectForm = {
    text: &quot;form&quot;,
    tooltip: &quot;Base this tiddler on a selected form&quot;,
    type: &quot;popup&quot;,
    popupNone: &quot;No forms available&quot;,
    usePfx: &quot;Use: &quot;,
    changePfx: &quot;Change to: &quot;,
    detachPfx: &quot;Detach form: &quot;,
    noform: &quot;Current form: none&quot;,
    warning: &quot;Replace current contents with the blank form?&quot;,
    source: &quot;NewTiddlerMenu&quot;,
    handlePopup: function(popup,title){
        var form = '';
        var cust = story.getTiddlerField(title,'form');
        if (cust.getAttribute('edit')!=&quot;form&quot;) cust = null;
        if (cust) form = cust.value; 
        if (!form.length){
            var tid = store.getTiddler(title);
            if (tid) form = tid.fields['form']||'';
        }
        var pref = this.usePfx;
        if (form.length){
            var btn = createTiddlyButton(createTiddlyElement(popup,&quot;li&quot;),this.detachPfx+form,'',this.itemClick);
            btn.setAttribute(&quot;title&quot;,title);
            pref = this.changePfx;
        }else{
            createTiddlyElement(popup,&quot;li&quot;,null,&quot;disabled&quot;,this.noform);
        }
        var text = store.getTiddlerText(this.source);
        var forms = [];
        var re = new RegExp(&quot;^!{1,6}.*$&quot;,&quot;mg&quot;);
        if (text) forms = text.match(re);
        var frms = 0;
        for (var i=0; i&lt;forms.length; i++){
            var frm = forms[i].replace(/^[\s!]*|\s*$/g,&quot;&quot;);
            if ((frm.length)&amp;&amp;(frm != form)){
                var btn = createTiddlyButton(createTiddlyElement(popup,&quot;li&quot;),pref+frm,'',this.itemClick);
                btn.setAttribute(&quot;form&quot;,frm);
                btn.setAttribute(&quot;title&quot;,title);
                btn.setAttribute(&quot;source&quot;,this.source);
                frms++;
            }
        }
        if (frms&lt;1) createTiddlyElement(popup,&quot;li&quot;,null,&quot;disabled&quot;,this.popupNone);
    },
    itemClick: function(){
        var frm = this.getAttribute(&quot;form&quot;);
        var tit = this.getAttribute(&quot;title&quot;);
        var src = this.getAttribute(&quot;source&quot;);
        var tid = story.getTiddler(tit);
        if (frm){
            if (story.getTiddlerField(tit,&quot;text&quot;).value != &quot;&quot;)
                if (!confirm(config.commands.selectForm.warning)) return;
            story.getTiddlerField(tit,&quot;text&quot;).value = transclude(src+&quot;##&quot;+frm);
            var tag = store.getTiddlerTextEx(src+&quot;::&quot;+frm+&quot;Tags&quot;,&quot;&quot;);
            story.getTiddlerField(tit,&quot;tags&quot;).value = tag;
        }
        frm = frm||'';
        var cust = story.getTiddlerField(tit,'form');
        if (cust.getAttribute('edit')!=&quot;form&quot;) cust = null;
        if (cust){
            cust.value = frm;
        }else{
            story.addCustomFields(tid,&quot;form:&quot;+frm);
        }
    },
}

//}}}</pre>
</div>
<div title="JHPublishPlugin" creator="John Hind" modifier="John Hind" created="201102091008" modified="201102211552" tags="systemConfig excludeLists excludeSearch excludeMissing" changecount="74">
<pre>/***
|Name|JHPublishPlugin|
|Version|1.0.0|
|Author|John Hind|
|~CoreVersion|2.6|
|Type|plugin|
|Requires|SaveAsPlugin, MatchTagsPlugin (www.tiddlytools.com)|
|Description|Save readonly copy of file to another location|
Provides the following macros:
{{{&lt;&lt;publish [label:] [prompt:] [filename:]&gt;&gt;}}} Adds a button to a version control tiddler which when pressed marks that tiddler as the current imprint (release note) and prompts the user to save a read-only copy of the tiddlywiki under the filename specified by the filename: parameter.
{{{&lt;&lt;published [ifnot:]&gt;&gt;}}} Produces a wikiword for the release note if released or the content supplied by the ifnot: parameter.
{{{&lt;&lt;pubinfo [slice:] [prefix:] [suffix:]&gt;&gt;}}} If released recovers the specified slice from the release note and wikifies it, prefixed and suffixed with any prefix: and suffix: parameter. If not released, or the slice does not exist, produces nothing.
!!!!!Revisions
&lt;&lt;&lt;
2011.02.09 [1.0.0] Created
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.JHPublishPlugin= {major: 1, minor: 0, revision: 0, date: new Date(2011,2,9)};

config.macros.publish = {
    pubtag: '$$!published!',
    label: 'publish as...',
    labelparam: 'label:',
    prompt: 'Save read-only published version of current document to a different path/file',
    promptparam: 'prompt:',
    filename: 'published.html',
    filenameparam: 'filename:',
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
        if (tiddler.isTagged(this.pubtag)) return;
	if ((params[0]||'').startsWith(this.labelparam))
	    var label=params.shift().substr(this.labelparam.length);
	if ((params[0]||'').startsWith(this.promptparam))
	    var prompt=params.shift().substr(this.promptparam.length);
	if ((params[0]||'').startsWith(this.filenameparam))
	    var filename=params.shift().substr(this.filenameparam.length);
        var btn=createTiddlyButton(place,label||this.label,prompt||this.prompt,
            function(){
                config.macros.publish.go(this.getAttribute('filename'),this.getAttribute('tiddler'));
                return false;
            }
        );
        btn.setAttribute('filename',filename||this.filename);
        btn.setAttribute('tiddler',tiddler.title);
     },
    go: function(filename,tiddler)
    {
        config.macros.publish.clearpub();
        store.setTiddlerTag(tiddler,true,config.macros.publish.pubtag);
        config.macros.saveAs.go(this.none,filename,'tw',&quot;not excludePublished&quot;, 0,false,false,false,false);
        store.setTiddlerTag(tiddler,false,config.macros.publish.pubtag);
        displayMessage(&quot;Document Published: &quot;+tiddler);
    },
    clearpub: function()
    {
        var tid = store.getTaggedTiddlers(config.macros.publish.pubtag);
        for(var t=0; t&lt;tid.length; t++) {
            store.setTiddlerTag(t.title,false,config.macros.publish.pubtag);
        };
    },
    ispublished: function()
    {
        var tid = store.getTaggedTiddlers(config.macros.publish.pubtag);
        return tid.length&gt;0;
    }
}
config.macros.published = {
    ifnot: 'not published',
    ifnotparam: 'ifnot:',
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
	if ((params[0]||'').startsWith(this.ifnotparam))
	    var ifnot=params.shift().substr(this.ifnotparam.length);
        var tid = store.getTaggedTiddlers(config.macros.publish.pubtag);
        if (tid.length&gt;0)
            wikify('[['+tid[0].title+']]',place);
        else
            wikify(ifnot||this.ifnot,place);
    }
}
config.macros.pubinfo = {
    slice: 'Copyright',
    sliceparam: 'slice:',
    prefixparam: 'prefix:',
    suffixparam: 'suffix:',
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
        if ((params[0]||'').startsWith(this.sliceparam))
            var slice = params.shift().substr(this.sliceparam.length);
        if ((params[0]||'').startsWith(this.prefixparam))
            var prefix = params.shift().substr(this.prefixparam.length);
        if ((params[0]||'').startsWith(this.suffixparam))
            var suffix = params.shift().substr(this.suffixparam.length);
        var tid = store.getTaggedTiddlers(config.macros.publish.pubtag);
        if (tid.length&gt;0) wikify((prefix||'')+store.getTiddlerSlice(tid[0].title,slice||this.slice)+(suffix||''),place);
    }
}
//}}}
</pre>
</div>
<div title="JHScriptPlugin" creator="John Hind" modifier="John Hind" created="201102141259" modified="201103091449" tags="excludeLists systemConfig excludeSearch excludeMissing">
<pre>/***
|Name|JHScriptPlugin|
|Version|1.0.0|
|Author|John Hind|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Macro helper functions and extra macros|
These helper functions are useful in evaluated macro parameters, the conditional ''if:'' parameter of the extended {{{&lt;&lt;tiddler&gt;&gt;}}} transclusion macro, and provides some simple extra macros.
!!!!!Usage
;{{{today(format);}}}
:(JavaScript) Returns the current date formated using the JavaScript format string.
;{{{author();}}}
:(JavaScript) Returns the current author name.
;{{{transclude(ref, ... );}}}
:(JavaScript) Returns the text from the specified tiddler, slice or section ''ref''. Supports tiddler name defaulting ('::slicename' or '##sectionname')(most of the time) as well as the full form ('tiddlername', 'tiddlername::slicename' or 'tiddlername##sectionname'). Any further parameters are substituted for '$1', '$2' etc. in the transcluded text. Additional substitution parameters in the transcluded text are also expanded. '$A' substitutes the current author name, '$T[format]' substitutes the current date/time using the specified format and '$N[name]' performs a nested transclusion. Implementation depends on the included replacement for core 'invokeMacro' - see: http://trac.tiddlywiki.org/ticket/444. As well as this patch, the wikify() call that calls invokeMacro() must pass the tiddler source of the text being wikified. 'core' mostly does, but some plugins do not.
;{{{exists(title);}}}
:(JavaScript) Returns logical 'true' if tiddler title (full tiddler, slice or section) exists. This provides and uses a fix for a bug in the core ''store.getTiddlerText'' function which is published as ''store.getTiddlerTextEx'' for possible use elsewhere. See http://trac.tiddlywiki.org/ticket/1134.
;{{{&lt;&lt;author&gt;&gt;}}}
:(macro) Substitutes the current author name.
;{{{&lt;&lt;editTiddler ... &gt;&gt;}}}
:(macro) Takes the same parameters as {{{&lt;&lt;newTiddler&gt;&gt;}}} and is the same provided the tiddler does not already exist. If the tiddler does exist, inserts a pretty link to the existing tiddler labeled with the label supplied as the parameter for this macro.
;{{{&lt;&lt;tiddlerSubtitle [fg] [fd] [fy]&gt;&gt;}}}
:(macro) Intended for use from View Templates, this is a &quot;pretty&quot; text comprising creation and modification dates and authors. Creation information is only shown if different from modification information. Up to three optional date/time formatting strings may be provided. If none are provided, the tiddlywiki default (date only) format is used. If one is provided, it overrides the default format. If two are provided the second is used when the date is today. If three are provided, the third is used for dates which are not today, but are in the current year. For example, {{{&lt;&lt;tiddlerSubtitle 'DDth mmm YYYY' '0hh:mm' 'DDth mmm'&gt;&gt;}}} shows the time for today, the date and month only for the current year and the full date for other years.
;{{{&lt;&lt;anchor name&gt;&gt;}}}
:(macro) This inserts an invisible anchor element with the given name. This is designed to operate with the extended link syntax of the SectionLinksPlugin.
;{{{&lt;&lt;list story&gt;&gt;}}}
:(macro extension) Extends the {{{&lt;&lt;list&gt;&gt;}}} macro with a new parameter to return the tiddlers in the story (displayed on screen).
;{{{&lt;&lt;tiddler title if:{{javascript}}&gt;&gt;}}}
:(macro extension) Extends the {{{&lt;&lt;tiddler&gt;&gt;}}} macro with the ability to apply a javascript conditional. The transclusion is only done if the conditional is true. This code is taken from Eric Shulman's CoreTweaks: http://trac.tiddlywiki.org/ticket/890. The ''title'' parameter is also pre-processed to default to the current tiddler for references starting ''::'' or ''##'' to allow references to sections or slices within the tiddler without hard-coding the name.
!!!!!Code
***/
//{{{
version.extensions.JHScriptPlugin= {major: 1, minor: 0, revision: 0, date: new Date(2011,02,14)};

today=function(fmt){var n=new Date(); return fmt?n.formatString(fmt):n.toLocaleString();}

author=function(){return config.options.txtUserName;}

function invokeMacro(place,macro,params,wikifier,tiddler)
{
    try {
	var m = config.macros[macro];
	if(m &amp;&amp; m.handler) {
	    //var tiddlerElem = story.findContainingTiddler(place);
	    //window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute(&quot;tiddler&quot;)) : null;
	    window.tiddler = tiddler; //JH: Add this, delete two lines above
	    window.place = place;
	    var allowEval = true;
	    if(config.evaluateMacroParameters==&quot;system&quot;) {
	        if(!tiddler || tiddler.tags.indexOf(&quot;systemAllowEval&quot;) == -1) {
		    allowEval = false;
		}
	    }
	    m.handler(place,macro,m.noPreParse?null:params.readMacroParams(!allowEval),wikifier,params,tiddler);
	} else {
            createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
	}
    } catch(ex) {
	createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
    }
}

preprocessTiddlerReference=function(nm){
    var nam = nm;
    var t = '';
    if (window.tiddler) t = window.tiddler.title;
    var parts = nam.split(config.textPrimitives.sectionSeparator);
    if (parts[1]){
        parts[1].trim(); parts[0].trim();
        if (!parts[0].length) nam = t + &quot;##&quot; + parts[1];
    }else{
        parts = nam.split(config.textPrimitives.sliceSeparator);
        if (parts[1]){
            parts[1].trim(); parts[0].trim();
            if (!parts[0].length) nam = t + &quot;::&quot; + parts[1];
        }
    }
    return nam;
}

transclude=function(nm){
    nm = preprocessTiddlerReference(nm);
    var t = store.getTiddlerText(nm,&quot;&quot;);
    var re;
    if ((arguments.length &gt; 1) &amp;&amp; (arguments.length &lt; 11) &amp;&amp; (t.length &gt; 1))
        for (var i=1; i &lt; arguments.length; i++) {
            re = new RegExp(&quot;\\$&quot; + i,&quot;mg&quot;);
            t = t.replace(re,arguments[i]);
        }
    re = new RegExp(&quot;\\$A&quot;,&quot;mg&quot;);
    t = t.replace(re,config.options.txtUserName);
    re = new RegExp(&quot;\\$T\\[[^\\]]*\\]&quot;,&quot;mg&quot;);
    var tl = t.match(re);
    if ((tl)&amp;&amp;(tl.length)){
        var dt = new Date();
        for (var i = 0; (i &lt; tl.length); i++){
            var ft = tl[i].substring(3,tl[i].length-1);
            re = new RegExp(&quot;\\$T\\[&quot;+ft+&quot;\\]&quot;,&quot;mg&quot;);
            if ((!ft)||(!ft.length)) ft = config.views.wikified.dateFormat;
            ft = dt.formatString(ft);
            t = t.replace(re,ft);
        }
    }
    re = new RegExp(&quot;\\$N\\[[^\\]]*\\]&quot;,&quot;mg&quot;);
    var tl = t.match(re);
    if ((tl)&amp;&amp;(tl.length)){
        for (var i = 0; (i &lt; tl.length); i++){
            var rf = tl[i].substring(3,tl[i].length-1);
            re = new RegExp(&quot;\\$N\\[&quot;+rf+&quot;\\]&quot;,&quot;mg&quot;);
            tx = transclude(rf);
            t = t.replace(re,tx);
        }
    }
    return t;
}

TiddlyWiki.prototype.getTiddlerTextEx = function(title,defaultText){
    if (title){
        pos = title.indexOf(config.textPrimitives.sliceSeparator);
        if (pos!=-1){
	    var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos +
                        config.textPrimitives.sliceSeparator.length));
	    if(slice) return slice;
            return defaultText||null;
        }
    }
    return store.getTiddlerText(title,defaultText);
}

exists=function(nm){return (typeof(store.getTiddlerTextEx(nm)) == 'string');}

config.macros.author = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
        wikify(config.options.txtUserName,place);
    }
}

config.macros.editTiddler = {
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
	params = paramString.parseParams(&quot;anon&quot;,null,true,false,false);
	var title = params[1] &amp;&amp; params[1].name == &quot;anon&quot; ? params[1].value : this.title;
	title = getParam(params,&quot;title&quot;,title);
        var label = getParam(params,&quot;label&quot;,title);
	if ((!readOnly)&amp;&amp;((!title)||(typeof(store.getTiddlerText(title)) != 'string')))
        {
            config.macros.newTiddler.handler(place, macroName, params, wikifier, paramString, tiddler);
        }
        else
        {
            wikify(&quot;[[&quot;+label+&quot;|&quot;+title+&quot;]]&quot;,place);
        }
    }
}

config.macros.tiddlerSubtitle = {
    txtCreated: &quot;created &quot;,
    txtBy: &quot; by &quot;,
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
        var fg = params[0]||config.views.wikified.dateFormat;
        var fd = params[1]||fg;
        var fy = params[2]||fg;
        var nw = new Date();
        var cd = store.getValue(tiddler,'created');
        cd = Date.convertFromYYYYMMDDHHMM(cd);
        var fc = fg;
        if (cd.formatString(&quot;YYYYMMDD&quot;)==nw.formatString(&quot;YYYYMMDD&quot;))
            fc = fd;
        else if (cd.formatString(&quot;YYYY&quot;)==nw.formatString(&quot;YYYY&quot;))
            fc = fy;
        var md = store.getValue(tiddler,'modified');
        if (md&amp;&amp;(md.length&gt;11)) md = Date.convertFromYYYYMMDDHHMM(md);
        if (!md) md = cd;
        var fm = fg
        if (md.formatString(&quot;YYYYMMDD&quot;)==nw.formatString(&quot;YYYYMMDD&quot;))
            fm = fd;
        else if (md.formatString(&quot;YYYY&quot;)==nw.formatString(&quot;YYYY&quot;))
            fm = fy;
        var dd = (md.formatString(&quot;YYYYMMDD&quot;)!=cd.formatString(&quot;YYYYMMDD&quot;));
        cd = cd.formatString(fc);
        md = md.formatString(fm);
        var mn = store.getValue(tiddler,'modifier');
        if (mn&amp;&amp;(mn.length&lt;1)) mn = null;
        var cn = store.getValue(tiddler,'creator');
        if (cn&amp;&amp;(cn.length&lt;1)) cn = null;
        if (!cn) cn = mn;
        var tx = &quot;[[&quot;+mn+&quot;]], &quot;+md;
        if (dd||(mn!=cn)){
           tx += &quot; (&quot; + this.txtCreated + cd;
           if (mn!=cn) tx += this.txtBy + &quot;[[&quot; + cn + &quot;]]&quot;;
           tx += &quot;)&quot;;
        }
        wikify(tx,place);
    }
}

config.macros.anchor={
    handler: function(place, macroName, params, wikifier, paramString, tiddler)
    {
        var name=params[0]||'target';
        createTiddlyElement(place,&quot;a&quot;,null,null,null,{name:name});
    }
}

config.macros.list.story= { };
config.macros.list.story.prompt=&quot;Tiddlers in the story&quot;;
config.macros.list.story.handler=function(params){
    var results=[];
    story.forEachTiddler(function(title,element){results.push(store.getTiddler(title));});
    return results;
};

config.macros.tiddler.if_handler = config.macros.tiddler.handler;
config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
    if (!params[0]) return;
    var p = paramString.parseParams('name',null,true,false,true);
    if (!getParam(p,'if',true)) return;
    var nm = params[0];
    var n = preprocessTiddlerReference(nm);
    if (n != nm){
        arguments[2][0]=n;
        arguments[4]=paramString.replace(new RegExp(nm),n);
    }
    this.if_handler.apply(this,arguments);
};
//}}}</pre>
</div>
<div title="John Hind" creator="John Hind" modifier="John Hind" created="201102231947" modified="201402181755" tags="author" changecount="2">
<pre>|Name|John Hind|
|Initials|JH|
|Email|john.hind@zen.co.uk|
{{H3{Biographical Details}}}
Based in London, England, I have more than 10 years experience with Lua, C, C++ and C# programming on Windows and micro-controllers as well as some Javascript. I am also an experienced electronics engineer and product designer.</pre>
</div>
<div title="LUA Script Resources" creator="John Hind" modifier="John Hind" created="201005292254" modified="201402211519" changecount="20">
<pre>These are User Resources with the type '''LUA''' (by default). You can edit the standard '''INIT''' scripts and you can add a start script and library scripts. You can also add scripts with other names for execution from the command-line. Resource names are not case sensitive.
;'''INIT'''
:If present, this script resource is run before any other script. The supplied default contains {{{require}}} statements for a standard set of libraries which may be reduced or expanded as required.
;'''&quot;&quot;&quot;INIT-CMD&quot;&quot;&quot;'''
:If present, this script resource is run to initialise the command interpreter environment. The supplied default defines the help functions and some debug helper features.
;'''START'''
:If present, this script becomes the ''start'' script which defines the application. If this is present, Winsh will not look for external script files, however a different resource script may be specified on the command line.
;'''LIB//xxxx//'''
:'C' libraries compiled into the Winsh Executable may have parts defined in Lua and these may allow customisation. See comments in the scripts.
;'''.//xxxx//''' or '''.//xxxx//.//yyyy//'''
:Lua libraries may be defined in resources with names beginning with a period. These can be loaded using {{{require}}} statements. The Lua hierarchical module system is supported using periods as level separators. The leading period is dropped from the {{{require}}} statement ({{{require(&quot;xxxx&quot;)}}} or {{{require(&quot;xxxx.yyyy&quot;)}}}). 
;'''//zzzz//'''
:Arbitrarily named resources (the name must not contain any period characters) can be loaded from the command-line or by [[winsh.loadscript]].
</pre>
</div>
<div title="List Class" creator="John Hind" modifier="John Hind" created="201005312016" modified="201402100959" changecount="13">
<pre>!lst = List( ... )
Create a new object of List Class or convert a Lua table to a List object. With no parameter, creates an empty List. With a single table parameter with no metatable, that table is converted in place into a List object. Anything else results in a new List with each of the parameters becoming entries in the list, in parameter order. All the following forms are permissible:
{{{
local x = List() -- Empty list
local x = List(&quot;one&quot;,&quot;two&quot;,&quot;three&quot;)
local x = List{&quot;one&quot;,&quot;two&quot;,&quot;three&quot;}
local x = List({&quot;one&quot;,&quot;two&quot;,&quot;three&quot;})
}}}
The List object is a wrapper on a Lua table in which keys must be integers (number type) contiguous from {{{1}}} up to the number of entries. Values may be any type and may be mixed. The standard Lua {{{#}}} operator gives the number of entries. An error is raised if a new entry would break these restrictions, but you can break a list by setting an entry to {{{nil}}}. You should not set any key other than {{{#}}} to {{{nil}}}.

Note that the List constructor can substitute for the {{{table.pack}}} function, except that embedded {{{nil}}} values are not allowed in List objects and the {{{n}}} field is not used. The List Class is intended to completely replace the standard Lua table library.
!!Methods
[[list:add]] - Add entries to end of the list.
[[list:insert]] - Insert entries anywhere in the list.
[[list:remove]] - Remove entries from the list.
[[list:unpack]] - Return contiguous entries from the list.
[[list:reverse]] - Reverse the order of the entries in the list.
[[list:sort]] - Sort the entries in a defined order.
[[list:concat]] - Concatenate the entries and return a string.
!!Metamethods
[[List Iteration]] - Self-iteration produces elements in order.
</pre>
</div>
<div title="List Iteration" creator="John Hind" modifier="John Hind" created="201312051238" modified="201401081529" changecount="4">
<pre>The List Class assigns a custom self-iterator which produces the values in order without having to track the key. So for example:
{{{
local list = List{&quot;one&quot;,&quot;two&quot;,&quot;three&quot;}
for item in list do print(item) end
}}}</pre>
</div>
<div title="Lua" creator="John Hind" modifier="John Hind" created="201005292145" modified="201406071039" changecount="31">
<pre>Lua is an open-source procedural scripting language with a fairly standard syntax and a number of interesting non-standard features such as multiple return values from functions and the use of a single, highly flexible and efficient associative array type as the sole data structuring mechanism. The language is fully defined in ''Lua Reference Manual 5.2'' available online at http://www.lua.org/manual/ or in print from Amazon.com. For a more discursive treatment ''Programming in Lua, 2nd Edition'' and ''Lua Programming Gems'' are both warmly recommended (both are available in print from Amazon.com and revenue from sales helps to support Lua language development).

The version of Lua implemented in Winsh.lua is Lua 5.2 as described in the above references, but a number of minor additions and modifications have been made. The term ''Winsh Lua'' refers to Lua 5.2 with these changes and with the additional libraries shipped in the [[Winsh Executables]]. The bracketed references below are to sections in ''Lua Reference Manual 5.2''.
! Set Construction Syntax Extension
The Table Constructors (3.4.8) syntax has been extended to allow explicit specification of a key with an implicit value of Boolean {{{true}}}. This facilitates construction of tables designed to represent sets. Example:
{{{
-- In Winsh Lua this:
local s = {[&quot;sat&quot;], [&quot;sun&quot;]}
-- Is is a shortcut for this standard Lua:
local s = {[&quot;sat&quot;]=true, [&quot;sun&quot;]=true}
}}}
! &quot;&quot;&quot;Self-Interating&quot;&quot;&quot; Objects Syntax Extension
The {{{for}}} statement (3.3.5) in its generic form has been extended to allow the object being iterated to be specified directly after the {{{in}}} keyword. This implicitly uses the {{{pairs}}} iteration method unless the object has a metamethod {{{__iter}}}. Example:
{{{
local t = {&quot;one&quot;,&quot;two&quot;,&quot;three&quot;}
-- In Winsh Lua this:
for k,v in t do print(v) end
-- Is a shortcut for this standard Lua:
for k,v in pairs(t) do print(v) end
}}}
If provided, the {{{__iter}}} metamethod must have a function value and that function must follow the interface pattern for {{{pairs}}} and {{{ipairs}}}.
! Object Orientation
A generic [[Class Library]] supplies object orientation extension types (classes). The Table Manipulation standard library (6.5) is deprecated and largely replaced by the [[List Class]]. Most of the table related functions are removed from the Basic Functions standard library (6.1) and are so no longer global. They are provided in the [[Table Class]] and/or the [[Class Library]]. The following code documents this and provides compatibility if required:
{{{
local getmetatable = class.getmetatable -- also method of Table
local ipairs = class.ipairs
local next = class.next
local pairs = class.pairs -- also method of Table
local rawequal = class.rawequal
local rawget = class.rawget -- also method of Table
local rawlen = class.rawlen -- also method of Table and of string
local rawset = class.rawset -- also method of Table
local setmetatable = class.setmetatable
}}}
! Enhanced 'tonumber'
The {{{tonumber}}} function is replaced by one that behaves the same except that for values other than string or number type, any {{{__tonumber}}} metamethod is honored. This makes {{{tonumber}}} behave in a similar way to {{{tostring}}}.
! Relocation of Specialised Basic Functions
The more rarely used and specialised global functions provided by the Basic Functions standard library have been relocated to a new {{{lua}}} table.  The following code documents this and provides compatibility if required:
{{{
local collectgarbage = lua.collectgarbage
local dofile = lua.dofile -- winsh.loadscript recommended
local load = lua.load
local loadfile = lua.loadfile -- winsh.loadscript recommended
local pcall = lua.pcall
local _VERSION = lua._VERSION
local xpcall = lua.xpcall
}}}
The functions remaining in the global table therefore comprise: {{{assert; error; print; select; tonumber; tostring; type}}}.
! Replacement of the Bitwise Operations Library
The bitwise operations library (6.7) is deprecated in Winsh Lua. The [[Bitfield Class]] is recommended instead.
! Deprecated OS and IO libraries
The Input and Output Facilities (6.8) and the Operating System Facilities (6.9) libraries are deprecated in Winsh Lua. Use the features of the [[Winsh Library]] and the [[Time Class]] instead.
! Debug Library
The Debug Library (6.10) is available, but is loaded by default only in the Interactive Console environment. You can load it using {{{local debug = require(&quot;debug&quot;)}}} if required in the main scripting environment.
</pre>
</div>
<div title="Macros" creator="John Hind" modifier="John Hind" created="201102062139" modified="201103022203" tags="excludeLists excludePublished excludeSearch excludeMissing">
<pre>The general form for macros is two open angle braces, a name and a number of parameter values separated by spaces, terminated by two closing angle braces. Parameter values with embedded spaces should be enclosed in single or double quotes or doubled square braces. Parameter values may also be ~JavaScript expressions enclosed in doubled curly braces, which are evaluated to provide the value.
!!today
{{{
&lt;&lt;today [dateFormat]&gt;&gt;
}}}
Display the current date and time. Uses the JavaScript default format unless ''dateFormat'' is specified, in which case use codes from [[Date Formats]].
There is also a ~JavaScript version, ''today()'' for use in evaluated macro parameters and this can also take an optional ''dateFormat'' parameter. See the ''tiddler'' section below for an example.
!!author
{{{
&lt;&lt;author&gt;&gt;
}}}
Displays the current author name set for this file (as opposed to the author of this tiddler).
There is also a ~JavaScript version, ''author()'' for use in evaluated macro parameters. See the ''tiddler'' section below for an example.
!!view
{{{
&lt;&lt;view title&gt;&gt;
&lt;&lt;view modified date&gt;&gt;
&lt;&lt;view creator link&gt;&gt;
}}}
Inserts metadata items from the containing tiddler with various formatting options. The metadata items are ''title'', ''creator'', ''modifier'', ''created'', ''modified'', ''tags''. The formatting options include ''link'' (format as a tiddlylink), ''wikified'' (decode markup), ''date'' (format as a date using the tiddlywiki default format or provide an additional ''dateFormat'' parameter per [[Date Formats]]).
!!newTiddler, editTiddler
{{{
&lt;&lt;newTiddler name:&quot;buttonlabel&quot; prompt:&quot;button prompt&quot; title:&quot;tiddler name&quot;&gt;&gt;
&lt;&lt;editTiddler name:&quot;button&quot; title:&quot;my tiddler&quot; text:&quot;contents of tiddler&quot;&gt;&gt;
}}}
These macros create a button which, when pressed, creates a tiddler. Both macros take the same named parameters. The difference is that ''newTiddler'' will overwrite any existing tiddler with the given title, but ''editTiddler'' will show a pretty link to the existing tiddler instead of the button. The full set of available parameters is as follows:
| Parameter | Description |h
|label|button label|
|prompt|button tooltip|
|title|title for the new tiddler (defaults to &quot;New Tiddler&quot;)|
|text|contents for the new tiddler|
|tag|tag to be applied to the new tiddler (parameter can be used repeatedly to specify multiple tags)|
|accessKey|single letter to use as access key to trigger the button|
|focus|which of the editable fields to default the focus to (e.g. &quot;title&quot;, &quot;text&quot;, &quot;tags&quot;)|
|template|name of the HTML template used to display the new tiddler (defaults to EditTemplate)|
|fields|custom fields to be assigned to the new tiddler (space-separated list of key:value pairs; e.g. fields:&quot;k1:v1 k2:v2&quot;)|
!!tiddler (tranclusion)
{{{
&lt;&lt;tiddler TiddlerName&gt;&gt;
&lt;&lt;tiddler TiddlerName with:value1 value2 ...&gt;&gt;
&lt;&lt;tiddler TiddlerName##heading&gt;&gt;
&lt;&lt;tiddler TiddlerName::label&gt;&gt;
&lt;&lt;tiddler TiddlerName if:{{exists('AnotherTiddlerName')}}&gt;&gt;
}}}
Inserts the contents of ~TiddlerName. Values passed are inserted into tokens $1, $2 etc. in the transcluded tiddler contents. Parts (slices or sections) of the transcluded tiddler can be selected either using the section heading or a slice label (a section is potentially multi-line while a slice must be on the same line as its label and terminates at the end of that line). In most cases, the tiddler name can be omitted from a section reference if the section is in the same tiddler. The optional ''if:'' parameter evaluates a ~JavaScript expression and only performs the transclusion if the result is ''true''.
{{{
Slice labels
label1: lorem
|label2|sit|
}}}
A transclusion can also be used to generate a macro parameter using the evaluated parameter syntax and the ~JavaScript ''transclude'' function as follows:
{{{
&lt;&lt;newTiddler title:{{author()+today()}} text:{{transclude('TiddlerName')}}&gt;&gt;
}}}
The ''transclude'' function can also take up to nine additional string parameters which get substituted into tokens $1, $2 etc. as described above.
!!SectionTOC
{{{
{{sectionTOC{}}}
!Heading 1
!!Heading 1.1
!!Heading 1.2
!Heading 2
&lt;&lt;sectionTOC&gt;&gt;
}}}
This automatically creates a linked table of contents from the headings in a single tiddler. The result is placed in a container having the CSS class ''sectionTOC'' (created using standard markup) and the actual macro must be placed after all the headings (usually right at the end of the tiddler. A different class name can be used if desired by passing it as the parameter to the ''sectionTOC'' macro.
</pre>
</div>
<div title="MainMenu" creator="John Hind" modifier="John Hind" created="201008311427" modified="201102211152" tags="menu excludeLists excludeSearch excludeMissing" changecount="64">
<pre>&lt;&lt;gotoTiddler inputstyle:{{&quot;width:98%;font-size:100%;border:1px;border-style:solid;border-color:&quot;+transclude('ColorPalette::TertiaryLight')+&quot;;&quot;;}} liststyle:&quot;width:94%;font-size:100%;&quot; search&gt;&gt;&lt;script&gt;config.options.txtMainTab=(exists(&quot;TabContents&quot;))?&quot;contents&quot;:&quot;index&quot;;&lt;/script&gt;&lt;&lt;tiddler MainMenu##rwtoc if:{{(exists(&quot;TabContents&quot;)&amp;&amp;(!readOnly));}}&gt;&gt;&lt;&lt;tiddler MainMenu##rw if:{{(!exists(&quot;TabContents&quot;)&amp;&amp;(!readOnly));}}&gt;&gt;&lt;&lt;tiddler MainMenu##rotoc if:{{(exists(&quot;TabContents&quot;)&amp;&amp;(readOnly));}}&gt;&gt;&lt;&lt;tiddler MainMenu##ro if:{{(!exists(&quot;TabContents&quot;)&amp;&amp;(readOnly));}}&gt;&gt;/%
%/{{fineblock{{{center{{{gray{Imprint: &lt;&lt;published&gt;&gt;&lt;&lt;pubinfo slice:Copyright &quot;prefix:&lt;br&gt;&quot;&gt;&gt;}}}}}}}}}/%
!rwtoc
&lt;&lt;tabs txtMainTab &quot;Contents&quot; &quot;Table of contents&quot; TabContents &quot;Index&quot; &quot;Alphabetical list&quot; TabAll &quot;Timeline&quot; &quot;List in order of last edit&quot; TabTimeline&gt;&gt;
!rw
&lt;&lt;tabs txtMainTab &quot;Index&quot; &quot;Alphabetical list&quot; TabAll &quot;Timeline&quot; &quot;List in order of last edit&quot; TabTimeline&gt;&gt;
!rotoc
&lt;&lt;tabs txtMainTab &quot;Contents&quot; &quot;Table of contents&quot; TabContents &quot;Index&quot; &quot;Alphabetical list&quot; TabAll&gt;&gt;
!ro
&lt;&lt;tabs txtMainTab &quot;Index&quot; &quot;Alphabetical list&quot; TabAll&gt;&gt;
!end
%/</pre>
</div>
<div title="Markup" creator="John Hind" modifier="John Hind" created="201008311441" modified="201103070940" tags="excludeLists excludePublished excludeSearch excludeMissing">
<pre>!Inline Formatting
|!Option|!Syntax|!Output|
|bold font|{{{''bold''}}}|''bold''|
|italic type|{{{//italic//}}}|//italic//|
|underlined text|{{{__underlined__}}}|__underlined__|
|strikethrough text|{{{--strikethrough--}}}|--strikethrough--|
|superscript text|{{{^^super^^script}}}|^^super^^script|
|subscript text|{{{~~sub~~script}}}|~~sub~~script|
|highlighted text|{{{@@highlighted@@}}}|@@highlighted@@|
|preformatted text|&quot;&quot;&quot;{{{preformatted}}}&quot;&quot;&quot;|{{{preformatted}}}|
!Block Elements
!!Headings
{{{
!Heading 1
!!Heading 2
!!!Heading 3
!!!!Heading 4
!!!!!Heading 5
}}}
&lt;&lt;&lt;
!Heading 1
!!Heading 2
!!!Heading 3
!!!!Heading 4
!!!!!Heading 5
&lt;&lt;&lt;
!!Lists
{{{
* unordered list, level 1
** unordered list, level 2
*** unordered list, level 3

# ordered list, level 1
## ordered list, level 2
### ordered list, level 3

; definition list, term
: definition list, description
}}}
&lt;&lt;&lt;
* unordered list, level 1
** unordered list, level 2
*** unordered list, level 3

# ordered list, level 1
## ordered list, level 2
### ordered list, level 3

; definition list, term
: definition list, description
&lt;&lt;&lt;
!!Blockquotes
{{{
&gt; blockquote, level 1
&gt;&gt; blockquote, level 2
&gt;&gt;&gt; blockquote, level 3

&lt;&lt;&lt;
blockquote
&lt;&lt;&lt;
}}}
&lt;&lt;&lt;
&gt; blockquote, level 1
&gt;&gt; blockquote, level 2
&gt;&gt;&gt; blockquote, level 3

&gt; blockquote
&lt;&lt;&lt;
!!Tables
{{{
|class|k
|!heading column 1|!heading column 2|h
|default aligned|left aligned |
| center aligned | right aligned|
|&gt;|column span|
|row span|  |
|~|  |
|color:red;font-weight:bold;bold red text|  |
|!footer|!footer|f
|caption|c
}}}
''Annotation:''
* A single cell with a ''k'' suffix assigns the CSS class identified in the cell to the table element. Classes ''oddRow'' and ''evenRow'' are also automatically assigned to alternate table row elements. These elements may therefore be styled with CSS rules in [[StyleSheet]].
* A row with a ''h'' suffix becomes a table header row.
* Content of a cell are aligned right if there is leading whitespace, left if there is trailing whitespace or centered if there is both leading and trailing whitespace. With neither, alignment comes from the CSS style.
* The {{{&gt;}}} marker creates a &quot;colspan&quot;, causing the cell to merge with the one to the right.
* The {{{~}}} marker creates a &quot;rowspan&quot;, causing the cell to merge with the one above.
* CSS property:value; pairs may be inserted before the contents of a cell.
* A row with a ''f'' suffix becomes a table footer row.
* A single cell with a ''c'' suffix makes the cell contents the caption for the table.
''The example above renders as follows:''
&lt;&lt;&lt;
|!heading column 1|!heading column 2|h
|default aligned|left aligned |
| center aligned | right aligned|
|&gt;|column span|
|row span|  |
|~|  |
|color:red;font-weight:bold;bold red text|  |
|!footer|!footer|f
|caption|c
&lt;&lt;&lt;
!Hyperlinks
* ~WikiWords are automatically transformed to hyperlinks to the respective tiddler.
* The automatic transformation can be suppressed by preceding the respective ~WikiWord with a tilde ({{{~}}}): {{{~WikiWord}}}.
* ~PrettyLinks are enclosed in square brackets and contain the desired tiddler name: {{{[[tiddler name]]}}}
* Optionally, a custom title or description can be added, separated by a pipe character ({{{|}}}): {{{[[title|target]]}}}&lt;br&gt;''N.B.:'' In this case, the target can also be any website (i.e. URL).
* Links can also reference sections (headings) within a tiddler: {{{[[tiddler##heading]]}}}. Within the same tiddler, the tiddler name may be omitted: {{{[[##heading]]}}}.
* The macro {{{&lt;&lt;anchor targetname&gt;&gt;}}} can be used to establish an invisible target for links in the form {{{[[displaytext|tiddler##targetname]]}}}.
!Custom Styling
* {{{@@CssProperty:value;CssProperty:value;@@}}} ''N.B.:'' CSS color definitions should use lowercase letters to prevent the inadvertent creation of ~WikiWords.
* &quot;&quot;&quot;{{customCssClass{}}}&quot;&quot;&quot; Style the content between the inner brackets using the named CSS class. For available classes see (or add to) [[StyleSheetShortcuts]].
* raw HTML can be inserted by enclosing the respective code in HTML tags: {{{&lt;html&gt;  &lt;/html&gt;}}}
!Special Markers
* {{{&lt;br&gt;}}} forces a manual line break.
* {{{----}}} creates a horizontal ruler.
* [[HTML entities|http://www.tiddlywiki.com/#HtmlEntities]].
* {{{&lt;&lt;macroName&gt;&gt;}}} calls the respective [[macro|Macros]].
* To hide text within a tiddler so that it is not displayed, it can be wrapped in {{{/%}}} and {{{%/}}}. This is useful for sections or slices for internal transclusion or for comments or scripting.
* To prevent wiki markup from taking effect for a particular section, that section can be enclosed in three double quotes: e.g. {{{&quot;&quot;&quot;WikiWord&quot;&quot;&quot;}}}.
!See Also
[[Nested Sliders]], [[Macros]], [[Date Formats]]</pre>
</div>
<div title="MatchTagsPlugin" creator="ELSDesignStudios" modifier="John Hind" created="200802290709" modified="201102131622" tags="systemConfig excludeLists excludeSearch excludeMissing" changecount="2">
<pre>/***
|Name|MatchTagsPlugin|
|Source|http://www.TiddlyTools.com/#MatchTagsPlugin|
|Documentation|http://www.TiddlyTools.com/#MatchTagsPluginInfo|
|Version|2.0.5|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|'tag matching' with full boolean expressions (AND, OR, NOT, and nested parentheses)|
!!!!!Documentation
&gt; see [[MatchTagsPluginInfo]]
!!!!!Revisions
&lt;&lt;&lt;
2011.01.23 2.0.5 fix core tweak for TW262+: adjust code in config.filters['tag'] instead of filterTiddlers()
2010.08.11 2.0.4 in getMatchingTiddlers(), fixed sorting for descending order (e.g, &quot;-created&quot;)
| please see [[MatchTagsPluginInfo]] for additional revision details |
2008.02.28 1.0.0 initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.MatchTagsPlugin= {major: 2, minor: 0, revision: 5, date: new Date(2011,23,11)};

// store.getMatchingTiddlers() processes boolean expressions for tag matching
//    sortfield (optional) sets sort order for tiddlers - default=title
//    tiddlers (optional) use alternative set of tiddlers (instead of current store)
TiddlyWiki.prototype.getMatchingTiddlers = function(tagexpr,sortfield,tiddlers) {

	var debug=config.options.chkDebug; // abbreviation
	var cmm=config.macros.matchTags; // abbreviation
	var r=[]; // results are an array of tiddlers
	var tids=tiddlers||store.getTiddlers();
	if (tids &amp;&amp; sortfield) tids=store.sortTiddlers(tids,sortfield);
	if (debug) displayMessage(cmm.msg1.format([tids.length]));

	// try simple lookup to quickly find single tags or tags that
	// contain boolean operators as literals, e.g. &quot;foo and bar&quot;
	for (var t=0; t&lt;tids.length; t++)
		if (tids[t].isTagged(tagexpr)) r.pushUnique(tids[t]);
	if (r.length) {
		if (debug) displayMessage(cmm.msg4.format([r.length,tagexpr]));
		return r;
	}

	// convert expression into javascript code with regexp tests,
	// so that &quot;tag1 AND ( tag2 OR NOT tag3 )&quot; becomes
	// &quot;/\~tag1\~/.test(...) &amp;&amp; ( /\~tag2\~/.test(...) || ! /\~tag3\~/.test(...) )&quot;

	// normalize whitespace, tokenize operators, delimit with &quot;~&quot;
	var c=tagexpr.trim(); // remove leading/trailing spaces
	c = c.replace(/\s+/ig,&quot; &quot;); // reduce multiple spaces to single spaces
	c = c.replace(/\(\s?/ig,&quot;~(~&quot;); // open parens
	c = c.replace(/\s?\)/ig,&quot;~)~&quot;); // close parens
	c = c.replace(/(\s|~)?&amp;&amp;(\s|~)?/ig,&quot;~&amp;&amp;~&quot;); // &amp;&amp;
	c = c.replace(/(\s|~)AND(\s|~)/ig,&quot;~&amp;&amp;~&quot;); // AND
	c = c.replace(/(\s|~)?\|\|(\s|~)?/ig,&quot;~||~&quot;); // ||
	c = c.replace(/(\s|~)OR(\s|~)/ig,&quot;~||~&quot;); // OR
	c = c.replace(/(\s|~)?!(\s|~)?/ig,&quot;~!~&quot;); // !
	c = c.replace(/(^|~|\s)NOT(\s|~)/ig,&quot;~!~&quot;); // NOT
	c = c.replace(/(^|~|\s)NOT~\(/ig,&quot;~!~(&quot;); // NOT(
	// change tag terms to regexp tests
	var terms=c.split(&quot;~&quot;); for (var i=0; i&lt;terms.length; i++) { var t=terms[i];
		if (/(&amp;&amp;)|(\|\|)|[!\(\)]/.test(t) || t==&quot;&quot;) continue; // skip operators/parens/spaces
		if (t==config.macros.matchTags.untaggedKeyword)
			terms[i]=&quot;tiddlertags=='~~'&quot;; // 'untagged' tiddlers
		else
			terms[i]=&quot;/\\~&quot;+t+&quot;\\~/.test(tiddlertags)&quot;;
	}
	c=terms.join(&quot; &quot;);
	if (debug) { displayMessage(cmm.msg2.format([tagexpr])); displayMessage(cmm.msg3.format([c])); }

	// scan tiddlers for matches
	for (var t=0; t&lt;tids.length; t++) {
	 	// assemble tags from tiddler into string &quot;~tag1~tag2~tag3~&quot;
		var tiddlertags = &quot;~&quot;+tids[t].tags.join(&quot;~&quot;)+&quot;~&quot;;
		try { if(eval(c)) r.push(tids[t]); } // test tags
		catch(e) { // error in test
			displayMessage(cmm.msg2.format([tagexpr]));
			displayMessage(cmm.msg3.format([c]));
			displayMessage(e.toString());
			break; // skip remaining tiddlers
		}
	}
	if (debug) displayMessage(cmm.msg4.format([r.length,tagexpr]));
	return r;
}
//}}}
//{{{
config.macros.matchTags = {
	msg1: &quot;scanning %0 input tiddlers&quot;,
	msg2: &quot;looking for '%0'&quot;,
	msg3: &quot;using expression: '%0'&quot;,
	msg4: &quot;found %0 tiddlers matching '%1'&quot;,
	noMatch: &quot;no matching tiddlers&quot;,
	untaggedKeyword: &quot;-&quot;,
	untaggedLabel: &quot;no tags&quot;,
	untaggedPrompt: &quot;show tiddlers with no tags&quot;,
	defTiddler: &quot;MatchingTiddlers&quot;,
	defTags: &quot;&quot;,
	defFormat: &quot;[[%0]]&quot;,
	defSeparator: &quot;\n&quot;,
	reportHeading: &quot;Found %0 tiddlers tagged with: '{{{%1}}}'\n----\n&quot;,
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var mode=params[0]?params[0].toLowerCase():'';
		if (mode==&quot;inline&quot;)
			params.shift();
		if (mode==&quot;report&quot; || mode==&quot;panel&quot;) {
			params.shift();
			var target=params.shift()||this.defTiddler;
		}
		if (mode==&quot;popup&quot;) {
			params.shift();
			if (params[0]&amp;&amp;params[0].substr(0,6)==&quot;label:&quot;) var label=params.shift().substr(6);
			if (params[0]&amp;&amp;params[0].substr(0,7)==&quot;prompt:&quot;) var prompt=params.shift().substr(7);
		} else {
			var fmt=(params.shift()||this.defFormat).unescapeLineBreaks();
			var sep=(params.shift()||this.defSeparator).unescapeLineBreaks();
		}
		var sortBy=&quot;+title&quot;;
		if (params[0]&amp;&amp;params[0].substr(0,5)==&quot;sort:&quot;) sortBy=params.shift().substr(5);
		var expr = params.join(&quot; &quot;);
		if (mode!=&quot;panel&quot; &amp;&amp; (!expr||!expr.trim().length)) return;
		if (expr==this.untaggedKeyword)
			{ var label=this.untaggedLabel; var prompt=this.untaggedPrompt };
		switch (mode) {
			case &quot;popup&quot;: this.createPopup(place,label,expr,prompt,sortBy); break;
			case &quot;panel&quot;: this.createPanel(place,expr,fmt,sep,sortBy,target); break;
			case &quot;report&quot;: this.createReport(target,this.defTags,expr,fmt,sep,sortBy); break;
			case &quot;inline&quot;: default: this.createInline(place,expr,fmt,sep,sortBy); break;
		}
	},
	formatList: function(tids,fmt,sep) {
		var out=[];
		for (var i=0; i&lt;tids.length; i++) { var t=tids[i];
			var title=t.title;
			var who=t.modifier;
			var when=t.modified.toLocaleString();
			var text=t.text;
			var first=t.text.split(&quot;\n&quot;)[0];
			var desc=store.getTiddlerSlice(t.title,&quot;description&quot;);
			desc=desc||store.getTiddlerSlice(t.title,&quot;Description&quot;);
			desc=desc||store.getTiddlerText(t.title+&quot;##description&quot;);
			desc=desc||store.getTiddlerText(t.title+&quot;##Description&quot;);
			var tags=t.tags.length?'[['+t.tags.join(']] [[')+']]':'';
			out.push(fmt.format([title,who,when,text,first,desc,tags]));
		}
		return out.join(sep);
	},
	createInline: function(place,expr,fmt,sep,sortBy) {
		wikify(this.formatList(store.sortTiddlers(store.getMatchingTiddlers(expr),sortBy),fmt,sep),place);
	},
	createPopup: function(place,label,expr,prompt,sortBy) {
		var btn=createTiddlyButton(place,
			(label||expr).format([expr]),
			(prompt||config.views.wikified.tag.tooltip).format([expr]),
			function(ev){ return config.macros.matchTags.showPopup(this,ev||window.event); });
		btn.setAttribute(&quot;sortBy&quot;,sortBy);
		btn.setAttribute(&quot;expr&quot;,expr);
	},
	showPopup: function(here,ev) {
		var p=Popup.create(here); if (!p) return false;
		var tids=store.getMatchingTiddlers(here.getAttribute(&quot;expr&quot;));
		store.sortTiddlers(tids,here.getAttribute(&quot;sortBy&quot;));
		var list=[]; for (var t=0; t&lt;tids.length; t++) list.push(tids[t].title);
		if (!list.length) createTiddlyText(p,this.noMatch);
		else {
			var b=createTiddlyButton(createTiddlyElement(p,&quot;li&quot;),
				config.views.wikified.tag.openAllText,
				config.views.wikified.tag.openAllTooltip,
				function() {
					var list=this.getAttribute(&quot;list&quot;).readBracketedList();
					story.displayTiddlers(null,tids);
				});
			b.setAttribute(&quot;list&quot;,&quot;[[&quot;+list.join(&quot;]] [[&quot;)+&quot;]]&quot;);
			createTiddlyElement(p,&quot;hr&quot;);
		}
		var out=this.formatList(tids,&quot; &amp;nbsp;[[%0]]&amp;nbsp; &quot;,&quot;\n&quot;); wikify(out,p);
		Popup.show();
		ev.cancelBubble=true;
		if(ev.stopPropagation) ev.stopPropagation();
		return false;
	},
	createReport: function(target,tags,expr,fmt,sep,sortBy) {
		var tids=store.sortTiddlers(store.getMatchingTiddlers(expr),sortBy);
		if (!tids.length) { displayMessage('no matches for: '+expr); return false; }
		var msg=config.messages.overwriteWarning.format([target]);
		if (store.tiddlerExists(target) &amp;&amp; !confirm(msg)) return false;
		var out=this.reportHeading.format([tids.length,expr])
		out+=this.formatList(tids,fmt,sep);
		store.saveTiddler(target,target,out,config.options.txtUserName,new Date(),tags,{});
		story.closeTiddler(target); story.displayTiddler(null,target);
	},
	createPanel: function(place,expr,fmt,sep,sortBy,tid) {
		var s=createTiddlyElement(place,&quot;span&quot;); s.innerHTML=store.getTiddlerText(&quot;MatchTagsPlugin##html&quot;);
		var f=s.getElementsByTagName(&quot;form&quot;)[0];
		f.expr.value=expr; f.fmt.value=fmt; f.sep.value=sep.escapeLineBreaks();
		f.tid.value=tid; f.tags.value=this.defTags;
	}
};
//}}}
/***
//{{{
!html
&lt;form style='display:inline;white-space:nowrap'&gt;
&lt;input type='text'    name='expr' style='width:50%' title='tag expression'&gt;&lt;!--
--&gt;&lt;input type='text'    name='fmt'  style='width:10%' title='list item format'&gt;&lt;!--
--&gt;&lt;input type='text'    name='sep'  style='width:5%'  title='list item separator'&gt;&lt;!--
--&gt;&lt;input type='text'    name='tid'  style='width:12%' title='target tiddler title'&gt;&lt;!--
--&gt;&lt;input type='text'    name='tags' style='width:10%' title='target tiddler tags'&gt;&lt;!--
--&gt;&lt;input type='button'  name='go'   style='width:8%'  value='go' onclick=&quot;
	var expr=this.form.expr.value;
	if (!expr.length) { alert('Enter a boolean tag expression'); return false; }
	var fmt=this.form.fmt.value;
	if (!fmt.length) { alert('Enter the list item output format'); return false; }
	var sep=this.form.sep.value.unescapeLineBreaks();
	var tid=this.form.tid.value;
	if (!tid.length) { alert('Enter a target tiddler title'); return false; }
	var tags=this.form.tags.value;
	config.macros.matchTags.createReport(tid,tags,expr,fmt,sep,'title');
	return false;&quot;&gt;
&lt;/form&gt;
!end
//}}}
***/
//{{{
// SHADOW TIDDLER for displaying default panel input form
config.shadowTiddlers.MatchTags=&quot;&lt;&lt;matchTags panel&gt;&gt;&quot;;
//}}}
//{{{
// TWEAK core filterTiddlers() or config.filters['tag'] (in TW262+)
// to use getMatchingTiddlers instead getTaggedTiddlers
// for enhanced boolean matching in [tag[...]] syntax
var TW262=config.filters &amp;&amp; config.filters['tag']; // detect TW262+
var fname=TW262?&quot;config.filters['tag']&quot;:&quot;TiddlyWiki.prototype.filterTiddlers&quot;;
var code=eval(fname).toString().replace(/getTaggedTiddlers/g,'getMatchingTiddlers');
eval(fname+'='+code);
//}}}
//{{{
// REDEFINE core handler for enhanced boolean matching in tag:&quot;...&quot; paramifier
// use filterTiddlers() instead of getTaggedTiddlers() to get list of tiddlers.
config.paramifiers.tag = {
	onstart: function(v) {
		var tagged = store.filterTiddlers(&quot;[tag[&quot;+v+&quot;]]&quot;);
		story.displayTiddlers(null,tagged,null,false,null);
	}
};
//}}}</pre>
</div>
<div title="Menu Class" creator="John Hind" modifier="John Hind" created="201311231135" modified="201403241042" changecount="29">
<pre>!menu = winsh.Menu([title] [, onshow] [, gutter])
The Menu Class generates objects which represent menus of actions. Menu inherits the methods of [[List Class]] and all List methods may be used to create and modify the menu list. However [[list:insert]] inserts Menu class objects as objects rather than as lists allowing sub-menus to be created. The optional parameters initialise some of the pre-defined fields (see below). A string parameter initialises '''title''', a callable parameter initialises '''onshow''' and a boolean parameter '''gutter'''.

Each list item must have a value comprising one of the following:
* A [[Command Class]] object representing a command which may be executed from the menu.
* A [[Menu Class]] object representing a sub-menu which may be opened from the menu.
* A string &quot;-&quot; which causes a horizontal separator line to be drawn.
* A string &quot;|&quot; which specifies a column split dividing the menu into two columns.
* A string (not one of the above) which becomes a non-selectable menu item (heading) unless it exists in a column on its own, in which case it becomes a vertical side-bar label.
The pre-defined fields are as follows:
;'''title'''
:This string value is the menu text shown for a sub-menu. If a menu object is used to define a sub-menu and this field is missing the default text &quot;sub menu&quot; is used.
;'''onshow'''
:This is an optional field and if present the value can be any callable Lua object (usually a function) which is called immediately prior to showing the menu and passed a single parameter, the Menu object. It can be used to modify the Menu or Command objects to vary the appearance and function of the menu that is shown to the user.
;'''gutter'''
:If present this overrides the default handling which shows a gutter if any Command objects in the menu or any sub-menus have '''icon''' or boolean '''value''' fields and not otherwise. Set to boolean {{{true}}} to show the gutter always, or boolean {{{false}}} to hide it always (in which case icons will be ignored and boolean '''value''' will be rendered using text colour rather than checkmarks). The setting applies globally to the menu and all of its sub-menus, and the '''gutter''' key should be applied in the main Menu table (however '''gutter''' {{{true}}} in a sub-menu will have effect as long as there is no '''gutter''' {{{false}}} in a parent menu or a subsequent sub-menu).
;'''disabled'''
:This field is initialised {{{false}}}. It may be changed (usually in an '''onshow''' function). It only has effect for a menu used as a submenu within another menu. If it is true when the menu is shown, the title entry for the sub-menu is shown disabled and the menu itself is not shown.
</pre>
</div>
<div title="Nested Sliders" creator="John Hind" modifier="John Hind" created="201102061601" modified="201105211433" tags="excludeLists excludePublished excludeSearch excludeMissing">
<pre>!Simple Use
The Nested Sliders syntax is added by the ~NestedSlidersPlugin. It provides an expandable outline list suitable for Table of Contents or similar uses.
{{{
+++
line 1
[[Tiddler]]
===
}}}
A simple expander which shows '&gt;' to expand and '&lt;' to collapse with a fixed line and a tiddler link in the expansion.
{{{
+++[label|tooltip]
[[Tidler1]]
[[Tidler2]]
===
}}}
Expanding list showing 'label' in a button with hover-over 'tooltip'. When expanded, shows two tiddler links.
{{{
+++[Title1&lt;br&gt;]&gt;
[[Tiddler1.1]]
[[Tiddler2.2]]
===
+++[Title2&lt;br&gt;]&gt;
[[Tiddler2.1]]
[[Tiddler2.2]]
===
}}}
Vertical table of contents style presentation. When clicked, the titles expand or collapse the links within. The {{{&lt;br&gt;}}} tags at the end of the titles cause the list to be arranged vertically. The &quot;&gt;&quot; marker causes the content of the section to be displayed with block quote formatting.
!Full Syntax
{{{
++++(cookiename)!!!!!^width^*@{{class{[label=key|tooltip][altlabel|alttooltip]}}}#panelID:&gt;...
content goes here
===
}}}
* ''&quot;&quot;&quot;+++&quot;&quot;&quot; (or &quot;&quot;&quot;++++&quot;&quot;&quot;) and &quot;&quot;&quot;===&quot;&quot;&quot;''&lt;br&gt;marks the start and end of the slider definition, respectively.  When the extra {{{+}}} is used, the slider will be open when initially displayed.
* ''&quot;&quot;&quot;(cookiename)&quot;&quot;&quot;''&lt;br&gt;saves the slider opened/closed state, and restores this state whenever the slider is re-rendered.
* ''&quot;&quot;&quot;! through !!!!!&quot;&quot;&quot;''&lt;br&gt;displays the slider label using a formatted headline (Hn) style instead of a button/link style
* ''&quot;&quot;&quot;^width^ (or just ^)&quot;&quot;&quot;''&lt;br&gt;makes the slider 'float' on top of other content rather than shifting that content downward.  'width' must be a valid CSS value (e.g., &quot;30em&quot;, &quot;180px&quot;, &quot;50%&quot;, etc.).  If omitted, the default width is &quot;auto&quot; (i.e., fit to content)
* ''&quot;&quot;&quot;*&quot;&quot;&quot;''&lt;br&gt;denotes &quot;transient display&quot;: when a click occurs elsewhere in the document, the slider/floating panel will be automatically closed.  This is useful for creating 'pulldown menus' that automatically go away after they are used.  //Note: using ~SHIFT-click on a slider label will open/close that slider without triggering the automatic closing of any transient slider panels that are currently displayed, permitting ''temporary'' display of several transient panels at once.//
* ''&quot;&quot;&quot;@&quot;&quot;&quot;''&lt;br&gt;denotes &quot;open on hover&quot;: the slider/floating panel will be automatically opened as soon as the mouse moves over the slider label, without requiring a click.
* ''&quot;&quot;&quot;{{class{[label=key|tooltip][altlabel|alttooltip]}}}&quot;&quot;&quot;''&lt;br&gt;uses label/tooltip/accesskey.  &quot;&quot;&quot;{{class{...}}}&quot;&quot;&quot;, &quot;&quot;&quot;=key&quot;&quot;&quot;, &quot;&quot;&quot;|tooltip&quot;&quot;&quot; and &quot;&quot;&quot;[altlabel|alttooltip]&quot;&quot;&quot; are optional.  'class' is any valid CSS class name, used to style the slider label text.  'key' must be a ''single letter only''.  altlabel/alttooltip specify alternative label/tooltip for use when slider/floating panel is displayed.  //Note: you can use HTML syntax within the label text to include HTML entities (e.g., {{{&amp;raquo;}}} (&amp;raquo;) or {{{&amp;#x25ba;}}} (&amp;#x25ba;), or even embedded images (e.g., {{{&lt;img src=&quot;images/eric3.gif&quot;&gt;}}}).//
* ''&quot;&quot;&quot;#panelID:&quot;&quot;&quot;''&lt;br&gt;defines a unique DOM element ID that is assigned to the panel element used to display the slider content.
* ''&quot;&quot;&quot;&gt;&quot;&quot;&quot;''&lt;br&gt;automatically adds blockquote formatting to slider content
* ''&quot;&quot;&quot;...&quot;&quot;&quot;''&lt;br&gt;defers rendering of closed sliders until the first time they are opened.
!!!Notes:
*You can 'nest' sliders as deep as you like, so that expandable 'tree-like' hierarchical displays can be created.
*Deferred rendering (...) can be used to offset processing overhead until actually needed. However, this may produce unexpected results in some cases.  Use with care.
* To make slider definitions easier to read and recognize when editing a tiddler, newlines immediately following the 'start slider' or preceding the 'end slider' sequences are automatically suppressed so that excess whitespace is eliminated from the output.
</pre>
</div>
<div title="NestedSlidersPlugin" creator="ELSDesignStudios" modifier="ELSDesignStudios" created="200512161202" modified="200811160623" tags="systemConfig BasicsPackage excludeSearch excludeLists excludeMissing" changecount="5">
<pre>/***
|Name|NestedSlidersPlugin|
|Source|http://www.TiddlyTools.com/#NestedSlidersPlugin|
|Documentation|http://www.TiddlyTools.com/#NestedSlidersPluginInfo|
|Version|2.4.9|
|Author|Eric Shulman - ELS Design Studios|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;br&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides||
|Options|##Configuration|
|Description|show content in nest-able sliding/floating panels, without creating separate tiddlers for each panel's content|
!!!!!Documentation
&gt;see [[NestedSlidersPluginInfo]]
!!!!!Configuration
&lt;&lt;&lt;
&lt;&lt;option chkFloatingSlidersAnimate&gt;&gt; allow floating sliders to animate when opening/closing
&gt;Note: This setting can cause 'clipping' problems in some versions of InternetExplorer.
&gt;In addition, for floating slider animation to occur you must also allow animation in general (see [[AdvancedOptions]]).
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2008.11.15 - 2.4.9 in adjustNestedSlider(), don't make adjustments if panel is marked as 'undocked' (CSS class).  In onClickNestedSlider(), SHIFT-CLICK docks panel (see [[MoveablePanelPlugin]])
|please see [[NestedSlidersPluginInfo]] for additional revision details|
2005.11.03 - 1.0.0 initial public release.  Thanks to RodneyGomes, GeoffSlocock, and PaulPetterson for suggestions and experiments.
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.NestedSlidersPlugin= {major: 2, minor: 4, revision: 9, date: new Date(2008,11,15)};

// options for deferred rendering of sliders that are not initially displayed
if (config.options.chkFloatingSlidersAnimate===undefined)
	config.options.chkFloatingSlidersAnimate=false; // avoid clipping problems in IE

// default styles for 'floating' class
setStylesheet(&quot;.floatingPanel { position:absolute; z-index:10; padding:0.5em; margin:0em; \
	background-color:#eee; color:#000; border:1px solid #000; text-align:left; }&quot;,&quot;floatingPanelStylesheet&quot;);

// if removeCookie() function is not defined by TW core, define it here.
if (window.removeCookie===undefined) {
	window.removeCookie=function(name) {
		document.cookie = name+'=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
	}
}

config.formatters.push( {
	name: &quot;nestedSliders&quot;,
	match: &quot;\\n?\\+{3}&quot;,
	terminator: &quot;\\s*\\={3}\\n?&quot;,
	lookahead: &quot;\\n?\\+{3}(\\+)?(\\([^\\)]*\\))?(\\!*)?(\\^(?:[^\\^\\*\\@\\[\\&gt;]*\\^)?)?(\\*)?(\\@)?(?:\\{\\{([\\w]+[\\s\\w]*)\\{)?(\\[[^\\]]*\\])?(\\[[^\\]]*\\])?(?:\\}{3})?(\\#[^:]*\\:)?(\\&gt;)?(\\.\\.\\.)?\\s*&quot;,
	handler: function(w)
		{
			lookaheadRegExp = new RegExp(this.lookahead,&quot;mg&quot;);
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source)
			if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart)
			{
				var defopen=lookaheadMatch[1];
				var cookiename=lookaheadMatch[2];
				var header=lookaheadMatch[3];
				var panelwidth=lookaheadMatch[4];
				var transient=lookaheadMatch[5];
				var hover=lookaheadMatch[6];
				var buttonClass=lookaheadMatch[7];
				var label=lookaheadMatch[8];
				var openlabel=lookaheadMatch[9];
				var panelID=lookaheadMatch[10];
				var blockquote=lookaheadMatch[11];
				var deferred=lookaheadMatch[12];

				// location for rendering button and panel
				var place=w.output;

				// default to closed, no cookie, no accesskey, no alternate text/tip
				var show=&quot;none&quot;; var cookie=&quot;&quot;; var key=&quot;&quot;;
				var closedtext=&quot;&gt;&quot;; var closedtip=&quot;&quot;;
				var openedtext=&quot;&lt;&quot;; var openedtip=&quot;&quot;;

				// extra &quot;+&quot;, default to open
				if (defopen) show=&quot;block&quot;;

				// cookie, use saved open/closed state
				if (cookiename) {
					cookie=cookiename.trim().slice(1,-1);
					cookie=&quot;chkSlider&quot;+cookie;
					if (config.options[cookie]==undefined)
						{ config.options[cookie] = (show==&quot;block&quot;) }
					show=config.options[cookie]?&quot;block&quot;:&quot;none&quot;;
				}

				// parse label/tooltip/accesskey: [label=X|tooltip]
				if (label) {
					var parts=label.trim().slice(1,-1).split(&quot;|&quot;);
					closedtext=parts.shift();
					if (closedtext.substr(closedtext.length-2,1)==&quot;=&quot;)
						{ key=closedtext.substr(closedtext.length-1,1); closedtext=closedtext.slice(0,-2); }
					openedtext=closedtext;
					if (parts.length) closedtip=openedtip=parts.join(&quot;|&quot;);
					else { closedtip=&quot;show &quot;+closedtext; openedtip=&quot;hide &quot;+closedtext; }
				}

				// parse alternate label/tooltip: [label|tooltip]
				if (openlabel) {
					var parts=openlabel.trim().slice(1,-1).split(&quot;|&quot;);
					openedtext=parts.shift();
					if (parts.length) openedtip=parts.join(&quot;|&quot;);
					else openedtip=&quot;hide &quot;+openedtext;
				}

				var title=show=='block'?openedtext:closedtext;
				var tooltip=show=='block'?openedtip:closedtip;

				// create the button
				if (header) { // use &quot;Hn&quot; header format instead of button/link
					var lvl=(header.length&gt;5)?5:header.length;
					var btn = createTiddlyElement(createTiddlyElement(place,&quot;h&quot;+lvl,null,null,null),&quot;a&quot;,null,buttonClass,title);
					btn.onclick=onClickNestedSlider;
					btn.setAttribute(&quot;href&quot;,&quot;javascript:;&quot;);
					btn.setAttribute(&quot;title&quot;,tooltip);
				}
				else
					var btn = createTiddlyButton(place,title,tooltip,onClickNestedSlider,buttonClass);
				btn.innerHTML=title; // enables use of HTML entities in label

				// set extra button attributes
				btn.setAttribute(&quot;closedtext&quot;,closedtext);
				btn.setAttribute(&quot;closedtip&quot;,closedtip);
				btn.setAttribute(&quot;openedtext&quot;,openedtext);
				btn.setAttribute(&quot;openedtip&quot;,openedtip);
				btn.sliderCookie = cookie; // save the cookiename (if any) in the button object
				btn.defOpen=defopen!=null; // save default open/closed state (boolean)
				btn.keyparam=key; // save the access key letter (&quot;&quot; if none)
				if (key.length) {
					btn.setAttribute(&quot;accessKey&quot;,key); // init access key
					btn.onfocus=function(){this.setAttribute(&quot;accessKey&quot;,this.keyparam);}; // **reclaim** access key on focus
				}
				btn.setAttribute(&quot;hover&quot;,hover?&quot;true&quot;:&quot;false&quot;);
				btn.onmouseover=function(ev) {
					// optional 'open on hover' handling
					if (this.getAttribute(&quot;hover&quot;)==&quot;true&quot; &amp;&amp; this.sliderPanel.style.display=='none') {
						document.onclick.call(document,ev); // close transients
						onClickNestedSlider(ev); // open this slider
					}
					// mouseover on button aligns floater position with button
					if (window.adjustSliderPos) window.adjustSliderPos(this.parentNode,this,this.sliderPanel);
				}

				// create slider panel
				var panelClass=panelwidth?&quot;floatingPanel&quot;:&quot;sliderPanel&quot;;
				if (panelID) panelID=panelID.slice(1,-1); // trim off delimiters
				var panel=createTiddlyElement(place,&quot;div&quot;,panelID,panelClass,null);
				panel.button = btn; // so the slider panel know which button it belongs to
				btn.sliderPanel=panel; // so the button knows which slider panel it belongs to
				panel.defaultPanelWidth=(panelwidth &amp;&amp; panelwidth.length&gt;2)?panelwidth.slice(1,-1):&quot;&quot;;
				panel.setAttribute(&quot;transient&quot;,transient==&quot;*&quot;?&quot;true&quot;:&quot;false&quot;);
				panel.style.display = show;
				panel.style.width=panel.defaultPanelWidth;
				panel.onmouseover=function(event) // mouseover on panel aligns floater position with button
					{ if (window.adjustSliderPos) window.adjustSliderPos(this.parentNode,this.button,this); }

				// render slider (or defer until shown)
				w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
				if ((show==&quot;block&quot;)||!deferred) {
					// render now if panel is supposed to be shown or NOT deferred rendering
					w.subWikify(blockquote?createTiddlyElement(panel,&quot;blockquote&quot;):panel,this.terminator);
					// align floater position with button
					if (window.adjustSliderPos) window.adjustSliderPos(place,btn,panel);
				}
				else {
					var src = w.source.substr(w.nextMatch);
					var endpos=findMatchingDelimiter(src,&quot;+++&quot;,&quot;===&quot;);
					panel.setAttribute(&quot;raw&quot;,src.substr(0,endpos));
					panel.setAttribute(&quot;blockquote&quot;,blockquote?&quot;true&quot;:&quot;false&quot;);
					panel.setAttribute(&quot;rendered&quot;,&quot;false&quot;);
					w.nextMatch += endpos+3;
					if (w.source.substr(w.nextMatch,1)==&quot;\n&quot;) w.nextMatch++;
				}
			}
		}
	}
)

function findMatchingDelimiter(src,starttext,endtext) {
	var startpos = 0;
	var endpos = src.indexOf(endtext);
	// check for nested delimiters
	while (src.substring(startpos,endpos-1).indexOf(starttext)!=-1) {
		// count number of nested 'starts'
		var startcount=0;
		var temp = src.substring(startpos,endpos-1);
		var pos=temp.indexOf(starttext);
		while (pos!=-1)  { startcount++; pos=temp.indexOf(starttext,pos+starttext.length); }
		// set up to check for additional 'starts' after adjusting endpos
		startpos=endpos+endtext.length;
		// find endpos for corresponding number of matching 'ends'
		while (startcount &amp;&amp; endpos!=-1) {
			endpos = src.indexOf(endtext,endpos+endtext.length);
			startcount--;
		}
	}
	return (endpos==-1)?src.length:endpos;
}
//}}}
//{{{
window.onClickNestedSlider=function(e)
{
	if (!e) var e = window.event;
	var theTarget = resolveTarget(e);
	while (theTarget &amp;&amp; theTarget.sliderPanel==undefined) theTarget=theTarget.parentNode;
	if (!theTarget) return false;
	var theSlider = theTarget.sliderPanel;
	var isOpen = theSlider.style.display!=&quot;none&quot;;

	// if SHIFT-CLICK, dock panel first (see [[MoveablePanelPlugin]])
	if (e.shiftKey &amp;&amp; config.macros.moveablePanel) config.macros.moveablePanel.dock(theSlider,e);

	// toggle label
	theTarget.innerHTML=isOpen?theTarget.getAttribute(&quot;closedText&quot;):theTarget.getAttribute(&quot;openedText&quot;);
	// toggle tooltip
	theTarget.setAttribute(&quot;title&quot;,isOpen?theTarget.getAttribute(&quot;closedTip&quot;):theTarget.getAttribute(&quot;openedTip&quot;));

	// deferred rendering (if needed)
	if (theSlider.getAttribute(&quot;rendered&quot;)==&quot;false&quot;) {
		var place=theSlider;
		if (theSlider.getAttribute(&quot;blockquote&quot;)==&quot;true&quot;)
			place=createTiddlyElement(place,&quot;blockquote&quot;);
		wikify(theSlider.getAttribute(&quot;raw&quot;),place);
		theSlider.setAttribute(&quot;rendered&quot;,&quot;true&quot;);
	}

	// show/hide the slider
	if(config.options.chkAnimate &amp;&amp; (!hasClass(theSlider,'floatingPanel') || config.options.chkFloatingSlidersAnimate))
		anim.startAnimating(new Slider(theSlider,!isOpen,e.shiftKey || e.altKey,&quot;none&quot;));
	else
		theSlider.style.display = isOpen ? &quot;none&quot; : &quot;block&quot;;

	// reset to default width (might have been changed via plugin code)
	theSlider.style.width=theSlider.defaultPanelWidth;

	// align floater panel position with target button
	if (!isOpen &amp;&amp; window.adjustSliderPos) window.adjustSliderPos(theSlider.parentNode,theTarget,theSlider);

	// if showing panel, set focus to first 'focus-able' element in panel
	if (theSlider.style.display!=&quot;none&quot;) {
		var ctrls=theSlider.getElementsByTagName(&quot;*&quot;);
		for (var c=0; c&lt;ctrls.length; c++) {
			var t=ctrls[c].tagName.toLowerCase();
			if ((t==&quot;input&quot; &amp;&amp; ctrls[c].type!=&quot;hidden&quot;) || t==&quot;textarea&quot; || t==&quot;select&quot;)
				{ try{ ctrls[c].focus(); } catch(err){;} break; }
		}
	}
	var cookie=theTarget.sliderCookie;
	if (cookie &amp;&amp; cookie.length) {
		config.options[cookie]=!isOpen;
		if (config.options[cookie]!=theTarget.defOpen) window.saveOptionCookie(cookie);
		else window.removeCookie(cookie); // remove cookie if slider is in default display state
	}

	// prevent SHIFT-CLICK from being processed by browser (opens blank window... yuck!)
	// prevent clicks *within* a slider button from being processed by browser
	// but allow plain click to bubble up to page background (to close transients, if any)
	if (e.shiftKey || theTarget!=resolveTarget(e))
		{ e.cancelBubble=true; if (e.stopPropagation) e.stopPropagation(); }
	Popup.remove(); // close open popup (if any)
	return false;
}
//}}}
//{{{
// click in document background closes transient panels
document.nestedSliders_savedOnClick=document.onclick;
document.onclick=function(ev) { if (!ev) var ev=window.event; var target=resolveTarget(ev);

	if (document.nestedSliders_savedOnClick)
		var retval=document.nestedSliders_savedOnClick.apply(this,arguments);
	// if click was inside a popup... leave transient panels alone
	var p=target; while (p) if (hasClass(p,&quot;popup&quot;)) break; else p=p.parentNode;
	if (p) return retval;
	// if click was inside transient panel (or something contained by a transient panel), leave it alone
	var p=target; while (p) {
		if ((hasClass(p,&quot;floatingPanel&quot;)||hasClass(p,&quot;sliderPanel&quot;))&amp;&amp;p.getAttribute(&quot;transient&quot;)==&quot;true&quot;) break;
		p=p.parentNode;
	}
	if (p) return retval;
	// otherwise, find and close all transient panels...
	var all=document.all?document.all:document.getElementsByTagName(&quot;DIV&quot;);
	for (var i=0; i&lt;all.length; i++) {
		 // if it is not a transient panel, or the click was on the button that opened this panel, don't close it.
		if (all[i].getAttribute(&quot;transient&quot;)!=&quot;true&quot; || all[i].button==target) continue;
		// otherwise, if the panel is currently visible, close it by clicking it's button
		if (all[i].style.display!=&quot;none&quot;) window.onClickNestedSlider({target:all[i].button})
		if (!hasClass(all[i],&quot;floatingPanel&quot;)&amp;&amp;!hasClass(all[i],&quot;sliderPanel&quot;)) all[i].style.display=&quot;none&quot;;
	}
	return retval;
};
//}}}
//{{{
// adjust floating panel position based on button position
if (window.adjustSliderPos==undefined) window.adjustSliderPos=function(place,btn,panel) {
	if (hasClass(panel,&quot;floatingPanel&quot;) &amp;&amp; !hasClass(panel,&quot;undocked&quot;)) {
		// see [[MoveablePanelPlugin]] for use of 'undocked'
		var rightEdge=document.body.offsetWidth-1;
		var panelWidth=panel.offsetWidth;
		var left=0;
		var top=btn.offsetHeight;
		if (place.style.position==&quot;relative&quot; &amp;&amp; findPosX(btn)+panelWidth&gt;rightEdge) {
			left-=findPosX(btn)+panelWidth-rightEdge; // shift panel relative to button
			if (findPosX(btn)+left&lt;0) left=-findPosX(btn); // stay within left edge
		}
		if (place.style.position!=&quot;relative&quot;) {
			var left=findPosX(btn);
			var top=findPosY(btn)+btn.offsetHeight;
			var p=place; while (p &amp;&amp; !hasClass(p,'floatingPanel')) p=p.parentNode;
			if (p) { left-=findPosX(p); top-=findPosY(p); }
			if (left+panelWidth&gt;rightEdge) left=rightEdge-panelWidth;
			if (left&lt;0) left=0;
		}
		panel.style.left=left+&quot;px&quot;; panel.style.top=top+&quot;px&quot;;
	}
}
//}}}
//{{{
// TW2.1 and earlier:
// hijack Slider stop handler so overflow is visible after animation has completed
Slider.prototype.coreStop = Slider.prototype.stop;
Slider.prototype.stop = function()
	{ this.coreStop.apply(this,arguments); this.element.style.overflow = &quot;visible&quot;; }

// TW2.2+
// hijack Morpher stop handler so sliderPanel/floatingPanel overflow is visible after animation has completed
if (version.major+.1*version.minor+.01*version.revision&gt;=2.2) {
	Morpher.prototype.coreStop = Morpher.prototype.stop;
	Morpher.prototype.stop = function() {
		this.coreStop.apply(this,arguments);
		var e=this.element;
		if (hasClass(e,&quot;sliderPanel&quot;)||hasClass(e,&quot;floatingPanel&quot;)) {
			// adjust panel overflow and position after animation
			e.style.overflow = &quot;visible&quot;;
			if (window.adjustSliderPos) window.adjustSliderPos(e.parentNode,e.button,e);
		}
	};
}
//}}}</pre>
</div>
<div title="NewTiddlerMenu" creator="John Hind" modifier="John Hind" created="201102081654" modified="201103091457" tags="menu excludeLists excludeSearch excludeMissing">
<pre>&lt;&lt;newTiddler label:empty prompt:&quot;create a new blank tiddler&quot; focus:title
    title:&quot;new&quot;
    text:&quot;&quot;
&gt;&gt;
&lt;&lt;newTiddler label:journal prompt:&quot;create a new journal entry&quot; focus:text
    title:{{today(&quot;LOG:YYYY/0MM/0DD-0hh:0mm:0ss&quot;)}}
    text:{{transclude('##journal')}}
    tag:{{transclude('::journaltags')}}
    fields:&quot;form:journal&quot;
&gt;&gt;
/%
!journal
{{H1{$A on $T[DDD DDth MMM YYYY at 0hh:0mm]}}}

!author
|Name|$A|
|Initials||
|Email||
{{H3{Biographical Details}}}

!imprint
|Name|$N[SiteTitle]|
|Author|[[$A]]|
|Version|1.0|
|Copyright|&amp;copy;$T[YYYY] [[$A]]|
|Release Date|$T[DDth MMM YYYY]|
{{H3{Release Notes}}}
&gt;
''&lt;&lt;publish&gt;&gt;''
!
journalTags:journal
authorTags:author
imprintTags:imprint excludeLists
%/</pre>
</div>
<div title="PageTemplate" modifier="John Hind" created="200903121719" modified="201102261547" tags="setup template excludeSearch excludeLists excludeMissing">
<pre>&lt;!--{{{--&gt;
&lt;div class='header'  macro='gradient vert [[ColorPalette::PrimaryLight]] [[ColorPalette::PrimaryMid]]'&gt;
&lt;span class='siteTitle' refresh='content' tiddler='SiteTitle'&gt;&lt;/span&gt;
&lt;span class='siteSubtitle' refresh='content' tiddler='SiteSubtitle'&gt;&lt;/span&gt;
&lt;span class='siteCredit' refresh='content' tiddler='SiteCredit'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div id='mainMenu' refresh='content' force='true' tiddler='MainMenu'&gt;&lt;/div&gt;
&lt;div id='displayArea'&gt;
&lt;div id='storyMenu' refresh='content' force='true' tiddler='StoryMenu'&gt;&lt;/div&gt;
&lt;div id='messageArea' ondblclick='clearMessage()'&gt;&lt;/div&gt;
&lt;div id='tiddlerDisplay'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div id=&quot;thumb&quot; refresh='content' force='true' tiddler='SiteThumb'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="Procedural Applications" creator="John Hind" modifier="John Hind" created="201005292135" modified="201402171151" changecount="5">
<pre>A procedural application is expressed entirely in the start script. When this completes, the application terminates. Graphical UI elements such as the report window, a file selector or a message box may be shown but they block execution until the user makes a selection, or the report window is dismissed at a later stage by the start script.
</pre>
</div>
<div title="RearrangeTiddlersPlugin" modifier="ELSDesignStudios" created="200607012228" modified="200810191439" tags="systemConfig BasicsPackage excludeSearch excludeLists excludeMissing" changecount="8">
<pre>/***
|Name|RearrangeTiddlersPlugin|
|Source|http://www.TiddlyTools.com/#RearrangeTiddlersPlugin|
|Version|2.0.0|
|Author|Eric Shulman|
|OriginalAuthor|Joe Raii|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;br&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides|Story.prototype.refreshTiddler|
|Description|drag tiddlers by title to re-order story column display|

adapted from: http://www.cs.utexas.edu/~joeraii/dragn/#Draggable
changes by ELS:
* hijack refreshTiddler() instead of overridding createTiddler()
* find title element by className instead of elementID
* set cursor style via code instead of stylesheet
* set tooltip help text
* set tiddler &quot;position:relative&quot; when starting drag event, restore saved value when drag ends
* update 2006.08.07: use getElementsByTagName(&quot;*&quot;) to find title element, even when it is 'buried' deep in tiddler DOM elements (due to custom template usage)
* update 2007.03.01: use apply() to invoke hijacked core function
* update 2008.01.13: only hijack core function once.  (allows for dynamic loading of plugin via bookmarklet)
* update 2008.10.19: added onclick popup menu with 'move to top' and 'move to bottom' commands

***/
//{{{

if (Story.prototype.rearrangeTiddlersHijack_refreshTiddler===undefined) {
Story.prototype.rearrangeTiddlersHijack_refreshTiddler = Story.prototype.refreshTiddler;
Story.prototype.refreshTiddler = function(title,template)
{
	this.rearrangeTiddlersHijack_refreshTiddler.apply(this,arguments);
	var theTiddler = document.getElementById(this.idPrefix + title); if (!theTiddler) return;
	var theHandle;
	var children=theTiddler.getElementsByTagName(&quot;*&quot;);
	for (var i=0; i&lt;children.length; i++) if (hasClass(children[i],&quot;title&quot;)) { theHandle=children[i]; break; }
	if (!theHandle) return theTiddler;

	Drag.init(theHandle, theTiddler, 0, 0, null, null);
	theHandle.style.cursor=&quot;move&quot;;
	theHandle.title=&quot;drag title to re-arrange tiddlers, click for more options...&quot;
	theTiddler.onDrag = function(x,y,myElem) {
		if (this.style.position!=&quot;relative&quot;)
			{ this.savedstyle=this.style.position; this.style.position=&quot;relative&quot;; }
		y = myElem.offsetTop;
		var next = myElem.nextSibling;
		var prev = myElem.previousSibling;
		if (next &amp;&amp; y + myElem.offsetHeight &gt; next.offsetTop + next.offsetHeight/2) {
			myElem.parentNode.removeChild(myElem);
			next.parentNode.insertBefore(myElem, next.nextSibling);//elems[pos+1]);
			myElem.style[&quot;top&quot;] = -next.offsetHeight/2+&quot;px&quot;;
		}
		if (prev &amp;&amp; y &lt; prev.offsetTop + prev.offsetHeight/2) {
			myElem.parentNode.removeChild(myElem);
			prev.parentNode.insertBefore(myElem, prev);
			myElem.style[&quot;top&quot;] = prev.offsetHeight/2+&quot;px&quot;;
		}
	};
	theTiddler.onDragEnd = function(x,y,myElem) {
		myElem.style[&quot;top&quot;] = &quot;0px&quot;;
		if (this.savedstyle!=undefined)
			this.style.position=this.savedstyle;
	};
	theHandle.onclick=function(ev) {
		ev=ev||window.event;
		var p=Popup.create(this); if (!p) return;
		var b=createTiddlyButton(createTiddlyElement(p,&quot;li&quot;),
			&quot;\u25B2 move to top of column &quot;,&quot;move this tiddler to the top of the story column&quot;,
			function() {
				var t=story.getTiddler(this.getAttribute(&quot;tid&quot;));
				t.parentNode.insertBefore(t,t.parentNode.firstChild); // move to top of column
				window.scrollTo(0,ensureVisible(t));
				return false;
			});
		b.setAttribute(&quot;tid&quot;,title);
		var b=createTiddlyButton(createTiddlyElement(p,&quot;li&quot;),
			&quot;\u25BC move to bottom of column &quot;,&quot;move this tiddler to the bottom of the story column&quot;,
			function() {
				var t=story.getTiddler(this.getAttribute(&quot;tid&quot;));
				t.parentNode.insertBefore(t,null); // move to bottom of column
				window.scrollTo(0,ensureVisible(t));
				return false;
			});
		b.setAttribute(&quot;tid&quot;,title);
		Popup.show(p,false);
		ev.cancelBubble=true; if (ev.stopPropagation) ev.stopPropagation(); return(false);
	};
	return theTiddler;
}
}

/**************************************************
 * dom-drag.js
 * 09.25.2001
 * www.youngpup.net
 **************************************************
 * 10.28.2001 - fixed minor bug where events
 * sometimes fired off the handle, not the root.
 **************************************************/

var Drag = {
	obj:null,

	init:
	function(o, oRoot, minX, maxX, minY, maxY) {
		o.onmousedown = Drag.start;
		o.root = oRoot &amp;&amp; oRoot != null ? oRoot : o ;
		if (isNaN(parseInt(o.root.style.left))) o.root.style.left=&quot;0px&quot;;
		if (isNaN(parseInt(o.root.style.top))) o.root.style.top=&quot;0px&quot;;
		o.minX = typeof minX != 'undefined' ? minX : null;
		o.minY = typeof minY != 'undefined' ? minY : null;
		o.maxX = typeof maxX != 'undefined' ? maxX : null;
		o.maxY = typeof maxY != 'undefined' ? maxY : null;
		o.root.onDragStart = new Function();
		o.root.onDragEnd = new Function();
		o.root.onDrag = new Function();
	},

	start:
	function(e) {
		var o = Drag.obj = this;
		e = Drag.fixE(e);
		var y = parseInt(o.root.style.top);
		var x = parseInt(o.root.style.left);
		o.root.onDragStart(x, y, Drag.obj.root);
		o.lastMouseX = e.clientX;
		o.lastMouseY = e.clientY;
		if (o.minX != null) o.minMouseX = e.clientX - x + o.minX;
		if (o.maxX != null) o.maxMouseX = o.minMouseX + o.maxX - o.minX;
		if (o.minY != null) o.minMouseY = e.clientY - y + o.minY;
		if (o.maxY != null) o.maxMouseY = o.minMouseY + o.maxY - o.minY;
		document.onmousemove = Drag.drag;
		document.onmouseup = Drag.end;
		Drag.obj.root.style[&quot;z-index&quot;] = &quot;10&quot;;
		return false;
	},

	drag:
	function(e) {
		e = Drag.fixE(e);
		var o = Drag.obj;
		var ey = e.clientY;
		var ex = e.clientX;
		var y = parseInt(o.root.style.top);
		var x = parseInt(o.root.style.left);
		var nx, ny;
		if (o.minX != null) ex = Math.max(ex, o.minMouseX);
		if (o.maxX != null) ex = Math.min(ex, o.maxMouseX);
		if (o.minY != null) ey = Math.max(ey, o.minMouseY);
		if (o.maxY != null) ey = Math.min(ey, o.maxMouseY);
		nx = x + (ex - o.lastMouseX);
		ny = y + (ey - o.lastMouseY);
		Drag.obj.root.style[&quot;left&quot;] = nx + &quot;px&quot;;
		Drag.obj.root.style[&quot;top&quot;] = ny + &quot;px&quot;;
		Drag.obj.lastMouseX = ex;
		Drag.obj.lastMouseY = ey;
		Drag.obj.root.onDrag(nx, ny, Drag.obj.root);
		return false;
	},

	end:
	function() {
		document.onmousemove = null;
		document.onmouseup = null;
		Drag.obj.root.style[&quot;z-index&quot;] = &quot;0&quot;;
		Drag.obj.root.onDragEnd(parseInt(Drag.obj.root.style[&quot;left&quot;]), parseInt(Drag.obj.root.style[&quot;top&quot;]), Drag.obj.root);
		Drag.obj = null;
	},

	fixE:
	function(e) {
		if (typeof e == 'undefined') e = window.event;
		if (typeof e.layerX == 'undefined') e.layerX = e.offsetX;
		if (typeof e.layerY == 'undefined') e.layerY = e.offsetY;
		return e;
	}
};
//}}}</pre>
</div>
<div title="RecentChanges" creator="ELSDesignStudios" modifier="ELSDesignStudios" created="200903231248" modified="200903231515" tags="BasicsPackage excludeSearch excludeLists excludeMissing" changecount="5">
<pre>&lt;&lt;tiddler HideTiddlerBackground&gt;&gt;&lt;&lt;tiddler HideTiddlerTags&gt;&gt;{{transparent smallform{&lt;&lt;recentChanges 30&gt;&gt;}}}</pre>
</div>
<div title="RecentChangesPlugin" modifier="John Hind" created="200707270332" modified="201103012048" tags="DiscoveryPackage systemConfig excludeLists excludeSearch excludeMissing">
<pre>/***
|Name|RecentChangesPlugin|
|Source|http://www.TiddlyTools.com/#RecentChangesPlugin|
|Version|2.2.99|
|Author|Eric Shulman (mod John Hind)|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Options|##Configuration|
|Description|display droplist of recently changed tiddlers with goto, edit, and preview buttons|
!!!!!Configuration
&lt;&lt;&lt;
&lt;&lt;option txtChangeHorizon&gt;&gt; Date in form 'Feb 20, 2011 10:10', or tiddler title, or blank. Only tiddlers modified after specified tiddler or date will be shown.
&lt;&lt;&lt;
!!!!!Usage
&lt;&lt;&lt;
The {{{&lt;&lt;recentChanges&gt;&gt;}}} macro displays a droplist of all tiddlers that have been changed within the last N days (default=10 days).
{{{
&lt;&lt;recentChanges&gt;&gt;
&lt;&lt;recentChanges #ofdays summary noEdit noExclude previewheight previewclass&gt;&gt;
}}}
where:
* #ofdays specifies the time limit for listing changed tiddlers.  Use 0 (zero) to list all tiddlers in the document.
* ''summary'' is an optional keyword that outputs only the summary text (without the droplist or buttons)
* ''noEdit'' is an optional keyword that hides the 'edit' button
* ''noExclude'' is an optional keyword that causes ''excludeLists'' tag to be ignored
* previewheight is a CSS height measurement and sets the FIXED height of the tiddler preview area (default is 15em)
* previewclass is any CSS classname, and can be used to apply custom styles to the preview area (default is to use the standard 'viewer' class)
&lt;&lt;&lt;
!!!!!Examples
&lt;&lt;&lt;
{{smallform{
{{{&lt;&lt;recentChanges&gt;&gt;}}}
&lt;&lt;recentChanges&gt;&gt;
{{{&lt;&lt;recentChanges 30 summary&gt;&gt;}}}
&lt;&lt;recentChanges 30 summary&gt;&gt;

{{{&lt;&lt;recentChanges 30 noedit 10em groupbox&gt;&gt;}}}
&lt;&lt;recentChanges 30 noedit 10em groupbox&gt;&gt;
}}}
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2011.02.24 [2.2.1jh] added optional 'noExclude' keyword and txtChangeHorizon config
2009.09.07 [2.2.1] fixed typo in shadow definition
2009.07.02 [2.2.0] added optional 'noedit' keyword to hide 'edit' button
2008.07.01 [2.1.0] added optional 'summary' keyword for simple text output
2008.05.01 [2.0.1] fixup for titles with double-quotes
2007.07.26 [2.0.0] re-written as plugin
2006.10.02 [1.0.0] initial release (as inline script ShowRecentChanges)
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.RecentChangesPlugin= {major: 2, minor: 2, revision: 99, date: new Date(2011,2,24)};

if (config.options.txtChangeHorizon===undefined) config.options.txtChangeHorizon=''; //JH

config.shadowTiddlers.RecentChanges='&lt;&lt;recentChanges&gt;&gt;';

config.macros.recentChanges = {
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var days=10; if (!isNaN(params[0])) days=parseInt(params[0]); // time limit in days (use 0 for all tiddlers)
		var summary=params[1]&amp;&amp;params[1].toLowerCase()=='summary'; if (summary) params.shift();
		var noedit=params[1]&amp;&amp;params[1].toLowerCase()=='noedit'; if (noedit) params.shift();
                var noexclude=params[1]&amp;&amp;params[1].toLowerCase()=='noexclude'; if (noexclude) params.shift();
		var height='15em'; if (params[1]) height=params[1]; // preview area fixed height
		var previewclass='viewer'; if (params[2]) previewclass=params[2]; // preview area CSS class
                var horizon=store.getTiddler(config.options.txtChangeHorizon); //JH
                if (horizon)                                                   //JH
                        horizon=horizon.modified;                              //JH
                else                                                           //JH
                        horizon=Date.parse(config.options.txtChangeHorizon);   //JH
                var timelimit=(new Date()).getTime()-86400000*days;
                if ((horizon)&amp;&amp;((days&lt;1)||(horizon&gt;timelimit))) timelimit=horizon; //JH
		var tiddlers=store.getTiddlers('modified',noexclude?'':'excludeLists').reverse();
		var count=tiddlers.length;
		if ((days&gt;0)||(horizon)) for (var count=0; count&lt;tiddlers.length &amp;&amp; tiddlers[count].modified&gt;timelimit; count++);
		var s=count+' tiddlers';
		if ((days&gt;0)||(horizon)) s+=' have changed since '+new Date(timelimit).formatString('DDD, MMM DDth YYYY 0hh:0mm');
                //JH: Deleted report of number of days, could fix with date arithmetic but did not think important.
		if (summary)
			{ wikify(s,place); return; }
		var opts='&lt;option value=&quot;&quot;&gt;'+s+'&lt;/option&gt;';
		for (var i=0; i&lt;count; i++) { var t=tiddlers[i];
			opts+='&lt;option value=&quot;'+t.title.replace(/&quot;/g,&quot;&amp;#x22;&quot;)+'&quot;&gt;';
			opts+=t.modified.formatString('YYYY.0MM.0DD 0hh:0mm')+' - '+t.title;
			opts+='&lt;/option&gt;';
		}
		var h=store.getTiddlerText('RecentChangesPlugin##html')
		h=h.replace(/%options%/,opts);
		h=h.replace(/%listwidth%/,noedit?79.5:69.5);
		h=h.replace(/%noedit%/,noedit?'none':'inline');
		createTiddlyElement(place,'div').innerHTML=h;
		var preview=createTiddlyElement(place,'div',null,previewclass);
		preview.style.display='none';
		preview.style.whiteSpace='normal';
		preview.style.overflow='auto';
		preview.style.height=height;
	}
}
//}}}
/***
//{{{
!html
&lt;form&gt;&lt;select size=1 name=&quot;list&quot; style=&quot;width:%listwidth%%&quot;
	onchange=&quot;this.form.goto.disabled=this.form.edit.disabled=this.form.preview.disabled=!this.value.length;
		var target=this.parentNode.parentNode.nextSibling; removeChildren(target);
		if (!this.value.length)
			{ target.style.display='none'; this.form.preview.value='preview'; }
		else if (target.style.display=='block') {
			wikify('&lt;'+'&lt;tiddler [['+this.value+']]&gt;'+'&gt;',target);
			target.style.display='block';
			this.form.preview.value='done';
		}
&quot;&gt;%options%&lt;/select&gt;&lt;!--
--&gt;&lt;input type=&quot;button&quot; name=&quot;goto&quot; value=&quot;goto&quot; disabled title=&quot;view selected tiddler&quot; style=&quot;width:10%&quot;
	onclick=&quot;var target=this.parentNode.parentNode.nextSibling; removeChildren(target);
		target.style.display='none'; this.form.preview.value='preview';
		story.displayTiddler(story.findContainingTiddler(this),this.form.list.value);
&quot;&gt;&lt;input type=&quot;button&quot; name=&quot;edit&quot; value=&quot;edit&quot; disabled title=&quot;edit selected tiddler&quot; style=&quot;width:10%;display:%noedit%&quot;
	onclick=&quot;var target=this.parentNode.parentNode.nextSibling; removeChildren(target);
		target.style.display='none'; this.form.preview.value='preview';
		story.displayTiddler(story.findContainingTiddler(this),this.form.list.value,DEFAULT_EDIT_TEMPLATE);
&quot;&gt;&lt;input type=&quot;button&quot; name=&quot;preview&quot; value=&quot;preview&quot; disabled title=&quot;show/hide tiddler preview&quot; style=&quot;width:10%&quot;
	onclick=&quot;var target=this.parentNode.parentNode.nextSibling;
		if (this.value=='preview') {
			removeChildren(target);
			wikify('&lt;'+'&lt;tiddler [['+this.form.list.value+']]&gt;'+'&gt;',target);
			target.style.display=this.form.list.value.length?'block':'none'; this.value='done';
		} else {
			removeChildren(target);
			target.style.display='none'; this.value='preview';
		}
&quot;&gt;&lt;/form&gt;
!end
//}}}
***/
 </pre>
</div>
<div title="RefreshCommand" modifier="ELSDesignStudios" created="200903220126" modified="200903221400" tags="script BasicsPackage excludeSearch excludeLists excludeMissing" changecount="17">
<pre>&lt;script label=&quot;refresh&quot; title=&quot;re-render this tiddler&quot;&gt;
		var here=story.findContainingTiddler(place); if (!here) return false;
		story.refreshTiddler(here.getAttribute(&quot;tiddler&quot;),null,true);
&lt;/script&gt;&lt;script&gt;place.lastChild.className='button';&lt;/script&gt;</pre>
</div>
<div title="RegistryKey Class" creator="John Hind" modifier="John Hind" created="201010121114" modified="201402212021" changecount="8">
<pre>!key = ~RegistryKey(root)
Creates an object representing a root registry key. Parameter ''root'' is a number which should be one of the '''HKEY''' constants defined in the Lua annex for this library:
{{{
RegistryKey = require(&quot;registry&quot;)
rk = RegistryKey(HKEY.CURRENT_USER)
for sk in rk:subkeys() do print(sk) end
}}}
!!Methods
[[key:open]] - Open a sub-key of the current key.
[[key:create]] - Create a new sub-key of the current key.
[[key:get]] - Get a named or the default value of the current key.
[[key:set]] - Change or create a named or the default value of the current key.
[[key:subkeys]] - Generic for iterator to produce the subkey names.
[[key:values]] - Generic for iterator to produce the value names.
[[key:deletetree]] - Delete all subkeys and values of the current key.
[[key:deletevalue]] - Delete a named value of the current key.
</pre>
</div>
<div title="Release 2.0" creator="John Hind" modifier="John Hind" created="201102271549" modified="201403251041" tags="imprint excludeLists" changecount="26">
<pre>|Name|Winsh|
|Author|[[John Hind]]|
|Version|2.0.1|
|Copyright|&amp;copy;2014 [[John Hind]]|
|Release Date|25th March 2014|
{{H3{Release Notes}}}
&gt;2.0.1 - Added {{{__whole}}} metafield for [[List Class]]. Used this to fix sub-menu insertion. Added {{{disabled}}} field to [[Menu Class]] (for sub-menus).
&gt;2.0 - Changed object model and added clipboard support. Updated Lua core to 5.2.2. Changed name from Grunt to Winsh.
&gt;1.2 - Updated the &quot;&quot;&quot;Self-Iterating&quot;&quot;&quot; Objects Lua patch, changed [[winsh.taskicon]].
&gt;1.1 - Upgraded Lua core to 5.2.1.
''&lt;&lt;publish&gt;&gt;''</pre>
</div>
<div title="Resident Applications" creator="John Hind" modifier="John Hind" created="201005292137" modified="201402211522" changecount="8">
<pre>Resident applications continue to run when the start script has completed. The start script will hook functions to Windows events such as user interaction or timers. Winsh.lua continues to run whilst there is a graphical UI element active (see [[winsh.outputmode]] and [[winsh.taskicon]]).

It is important to recognise that although Winsh.lua can be event-driven, it is single-threaded. A script or event action must run to completion before another is allowed to run. Winsh.lua scripts in resident applications should never contain infinite loops or any processing that will take longer than a few seconds. Support for simple process-level multitasking is provided by the [[winsh.spawn]] function.

Resident Applications will almost always be implemented on one of the [[Winsh Executables]] with the Windows Subsystem flag.
</pre>
</div>
<div title="Resource Editor" creator="John Hind" modifier="John Hind" created="201005292249" modified="201410031012" changecount="10">
<pre>A resource editing application may be used to change the resources stored in a copy of one of the [[Winsh Executables]] to produce a customised version or a complete application. I use the excellent freeware ''XN Resource Editor'' by Colin Wilson. Colin is no longer developing this, but it continues to be available from:

http://portableapps.com/apps/utilities/xn_resource_editor_portable.

To embed [[LUA Script Resources]] using ''XN Resource Editor'', first create the script in a file which should be named with the resource name in block capitals and the extension ''.LUA'' (for example, a file named ''START.LUA'' becomes a resource named ''START''). Next start XN Resource Editor and open a copy of one of the Winsh executables. On the ''Resource'' menu, take the option ''Import User Resource'' and navigate to the script file prepared earlier. Save the executable file and exit. Note that when replacing an edited script resource, it is important to delete the old version before importing the new version.

''XN Resource Editor'' can also be used to customise the Winsh.lua executable by editing [[String Table Resources]] and to add icon graphics by editing [[Icon Resources]].

</pre>
</div>
<div title="SaveAsPlugin" modifier="John Hind" created="200602030909" modified="201210142022" tags="systemConfig ImportExportPackage excludeLists excludeSearch excludeMissing" changecount="7">
<pre>/***
|Name|SaveAsPlugin|
|Source|http://www.TiddlyTools.com/#SaveAsPlugin|
|Documentation|http://www.TiddlyTools.com/#SaveAsPluginInfo|
|Version|2.7.0|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Save current document to another path/filename|
!!!!!Documentation
&lt;&lt;&lt;
see [[SaveAsPluginInfo]]
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2009.10.13 2.7.0 added 'here' param (saves current tiddler)
2009.08.16 2.6.2 fixed handling for backstage
| Please see [[SaveAsPluginInfo]] for additional revision details |
2006.02.03 1.0.0 Created
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.SaveAsPlugin= {major: 2, minor: 7, revision: 0, date: new Date(2009,10,13)};

config.macros.saveAs = {
	label: 'save as...',
	labelparam: 'label:',
	prompt: 'Save current document to a different path/file',
	promptparam: 'prompt:',
	filePrompt: 'Please select or enter a target path/filename',
	targetparam: 'target:',
	defaultFilename: 'new.html',
	filenameparam: 'filename:',
	currfilekeyword: 'here',
	typeparam: 'type:',
	type_TW: 'tw', type_PS: 'ps', type_TX: 'tx', type_CS: 'cs', type_NF: 'nf', // file type tokens
	type_map: {
		tiddlywiki:'tw', tw:'tw', wiki: 'tw',
		purestore: 'ps', ps:'ps', store:'ps',
		plaintext: 'tx', tx:'tx', text: 'tx',
		comma:     'cs', cs:'cs', csv:  'cs',
		newsfeed:  'nf', nf:'nf', xml:  'nf', rss:'nf'
	},
	limitparam: 'limit:',
	replaceparam: 'replace',
	mergeparam: 'merge',
	quietparam: 'quiet',
	openparam: 'open',
	askParam: 'ask',
	hereParam: 'here',
	askMsg: &quot;Enter a tag filter (use * for all tiddlers, 'none' for blank document)&quot;,
	hereMsg: 'Enter a tiddler title',
	emptyParam: 'none',
	confirmmsg: &quot;Found %0 tiddlers matching\n\n'%1'\n\nPress OK to proceed&quot;,
	mergeprompt: '%0\nalready contains tiddler definitions.\n'
		+'\nPress OK to add new/revised tiddlers to current file contents.'
		+'\nPress Cancel to completely replace file contents',
	mergestatus: 'Merged %0 new/revised tiddlers and %1 existing tiddlers',
	okmsg: '%0 tiddlers written to %1',
	failmsg: 'An error occurred while creating %1',
	filter: '',
	handler: function(place,macroName,params) {
		if ((params[0]||'').startsWith(this.labelparam))
			var label=params.shift().substr(this.labelparam.length);
		if ((params[0]||'').startsWith(this.promptparam))
			var prompt=params.shift().substr(this.promptparam.length);
		if ((params[0]||'').startsWith(this.targetparam))
			var target=params.shift().substr(this.targetparam.length);
		if ((params[0]||'').startsWith(this.filenameparam))
			var filename=params.shift().substr(this.filenameparam.length);
		if ((params[0]||'').startsWith(this.typeparam))
			var filetype=this.type_map[params.shift().substr(this.typeparam.length).toLowerCase()];
		if ((params[0]||'').startsWith(this.limitparam))
			var limit=params.shift().substr(this.limitparam.length);
		var q=((params[0]||'')==this.quietparam);   if (q) params.shift();
		var o=((params[0]||'')==this.replaceparam); if (o) params.shift();
		var m=((params[0]||'')==this.mergeparam);   if (m) params.shift();
		var a=((params[0]||'')==this.openparam);    if (a) params.shift();
		var btn=createTiddlyButton(place,label||this.label,prompt||this.prompt,
			function(){ config.macros.saveAs.go( this.getAttribute('target'),
				this.getAttribute('filename'), this.getAttribute('filetype'),
				this.getAttribute('filter'), this.getAttribute('limit'),
				this.getAttribute('quiet')=='true',
				this.getAttribute('overwrite')=='true',
				this.getAttribute('merge')=='true',
				this.getAttribute('autoopen')=='true',
				this);
				return false;
			});
		if (target) btn.setAttribute('target',target);
		if (filename) btn.setAttribute('filename',filename);
		btn.setAttribute('filetype',filetype||this.type_TW);
		btn.setAttribute('filter',params.join(' '));
		btn.setAttribute('limit',limit||0);
		btn.setAttribute('quiet',q?'true':'false');
		btn.setAttribute('overwrite',o?'true':'false');
		btn.setAttribute('merge',m?'true':'false');
		btn.setAttribute('autoopen',a?'true':'false');
	},
	go: function(target,filename,filetype,filter,limit,quiet,overwrite,merge,autoopen,here) {
		var cm=config.messages; // abbreviation
		var cms=config.macros.saveAs; // abbreviation
		if (window.location.protocol!='file:') // make sure we are local
			{ displayMessage(cm.notFileUrlError); return; }

		// get tidders, confirm filtered results
		var tids=cms.selectTiddlers(filter,here);
		if (tids===false) return; // cancelled by user
		if (cms.filter!=cms.emptyParam &amp;&amp; cms.filter.length &amp;&amp; !quiet)
			if (!confirm(cms.confirmmsg.format([tids.length,cms.filter]))) return;
		// get target path/filename
		if (!filetype) filetype=this.type_TW;
		target=target||cms.getTarget(filename,filetype==this.type_TX?'txt':filetype==this.type_CS?'csv':'html');
		if (!target) return; // cancelled by user
		var link='file:///'+target.replace(/\\/g,'/');
		var samefile=link==decodeURIComponent(window.location.href);
		var p=getLocalPath(document.location.href);
		if (samefile) {
			if (config.options.chkSaveBackups)
				{ var t=loadOriginal(p);if(t)saveBackup(p,t); }
			if (config.options.chkGenerateAnRssFeed &amp;&amp; saveRss instanceof Function)
				saveRss(p);
		}
		var notes='';
		var total={val:0};
		var out=this.assembleFile(target,filetype,tids,limit||0,notes,quiet,overwrite,merge,total);
		var ok=saveFile(target,out);
		if (ok &amp;&amp; autoopen) {
			if (!samefile) window.open(link).focus();
			else { store.setDirty(false); window.location.reload(); }
		}
		if (!quiet || !(ok &amp;&amp; autoopen))
			displayMessage((ok?this.okmsg:this.failmsg).format([total.val,target]),link);
	},
	selectTiddlers: function(filter,here) {
		var cms=config.macros.saveAs; // abbreviation
		var tids=[]; cms.filter=filter||'';
		if (filter==cms.emptyParam)
			return tids;
		if (filter==config.macros.saveAs.hereParam) {
			var here=story.findContainingTiddler(here);
			if (here) var tid=here.getAttribute('tiddler');
			else var tid=prompt(config.macros.saveAs.hereMsg,'');
			while (tid &amp;&amp; !store.tiddlerExists(tid)) {
				var err='&quot;'+tid+'&quot; not found.\nPlease try again.\n\n';
				var tid=prompt(err+config.macros.saveAs.hereMsg,tid);
			}
			if (!tid) return false;  // cancelled by user
			return [store.getTiddler(tid)];
		}
		if (filter==config.macros.saveAs.askParam) {
			filter=prompt(config.macros.saveAs.askMsg,'');
			if (!filter) return false;  // cancelled by user
			cms.filter=filter=='*'?'':filter;
		}
		if (!filter||!filter.length||filter=='*') tids=store.getTiddlers('title');
		else tids=store.filterTiddlers('[tag['+filter+']]');
		return tids;
	},
	getTarget: function(defName,defExt) {
		var cms=config.macros.saveAs; // abbreviation
		// get new target path/filename
		var newPath=getLocalPath(window.location.href);
		var slashpos=newPath.lastIndexOf('/'); if (slashpos==-1) slashpos=newPath.lastIndexOf('\\');
		if (slashpos!=-1) newPath=newPath.substr(0,slashpos+1); // trim filename
		if (!defName||!defName.length) { // use current filename as default
			var p=getLocalPath(window.location.href);
			var s=p.lastIndexOf('/'); if (s==-1) s=p.lastIndexOf('\\');
			if (s!=-1) defName=p.substr(s+1);
		}
		var defFilename=(defName||cms.defaultFilename).replace(/.html$/,'.'+defExt);
		var target=cms.askForFilename(cms.filePrompt,newPath,defFilename,defExt);
		if (!target) return; // cancelled by user
		// if specified file does not include a path, assemble fully qualified path and filename
		var slashpos=target.lastIndexOf('/'); if (slashpos==-1) slashpos=target.lastIndexOf('\\');
		if (slashpos==-1) target=target+(defName||cms.defaultFilename).replace(/.html$/,'.'+defExt);
		return target;
	},
	askForFilename: function(msg,path,file,defExt) {
		if(window.Components) { // moz
			try {
				netscape.security.PrivilegeManager.enablePrivilege('UniversalXPConnect');
				var nsIFilePicker = window.Components.interfaces.nsIFilePicker;
				var picker = Components.classes['@mozilla.org/filepicker;1'].createInstance(nsIFilePicker);
				picker.init(window, msg, nsIFilePicker.modeSave);
				var thispath = Components.classes['@mozilla.org/file/local;1'].createInstance(Components.interfaces.nsILocalFile);
				thispath.initWithPath(path);
				picker.displayDirectory=thispath;
				picker.defaultExtension=defExt||'html';
				picker.defaultString=file;
				picker.appendFilters(nsIFilePicker.filterAll|nsIFilePicker.filterText|nsIFilePicker.filterHTML);
				if (picker.show()!=nsIFilePicker.returnCancel) var result=picker.file.persistentDescriptor;
			}
			catch(e) { alert('error during local file access: '+e.toString()) }
		}
		else { // IE
			try { // XP/Vista only
				var s = new ActiveXObject('UserAccounts.CommonDialog');
				s.Filter='All files|*.*|Text files|*.txt|HTML files|*.htm;*.html|';
				s.FilterIndex=(defExt=='txt')?2:3; // default to HTML files;
				s.InitialDir=path;
				s.FileName=file;
				if (s.showOpen()) var result=s.FileName;
			}
			catch(e) { var result=prompt(msg,path+file); } // fallback for non-XP IE
		}
		return result;
	},
	plainTextHeader:
		 'Source:\n\t%0\n'
		+'Title:\n\t%1\n'
		+'Subtitle:\n\t%2\n'
		+'Created:\n\t%3 by %4\n'
		+'Application:\n\tTiddlyWiki %5 / %6 %7\n\n',
	plainTextTiddler:
		'- - - - - - - - - - - - - - -\n'
		+'|     title: %0\n'
		+'|   created: %1\n'
		+'|  modified: %2\n'
		+'| edited by: %3\n'
		+'|      tags: %4\n'
		+'- - - - - - - - - - - - - - -\n'
		+'%5\n',
	plainTextFooter:
		'',
	newsFeedHeader:
		 '&lt;'+'?xml version=&quot;1.0&quot;?'+'&gt;\n'
		+'&lt;rss version=&quot;2.0&quot;&gt;\n'
		+'&lt;channel&gt;\n'
		+'&lt;title&gt;%1&lt;/title&gt;\n'
		+'&lt;link&gt;%0&lt;/link&gt;\n'
		+'&lt;description&gt;%2&lt;/description&gt;\n'
		+'&lt;language&gt;en-us&lt;/language&gt;\n'
		+'&lt;copyright&gt;Copyright '+(new Date().getFullYear())+' %4&lt;/copyright&gt;\n'
		+'&lt;pubDate&gt;%3&lt;/pubDate&gt;\n'
		+'&lt;lastBuildDate&gt;%3&lt;/lastBuildDate&gt;\n'
		+'&lt;docs&gt;http://blogs.law.harvard.edu/tech/rss&lt;/docs&gt;\n'
		+'&lt;generator&gt;TiddlyWiki %5 / %6 %7&lt;/generator&gt;\n',
	newsFeedTiddler:
		'\n%0\n',
	newsFeedFooter:
		'&lt;/channel&gt;&lt;/rss&gt;',
	pureStoreHeader:
		 '&lt;html&gt;&lt;body&gt;'
		+'&lt;style type=&quot;text/css&quot;&gt;'
		+'	#storeArea {display:block;margin:1em;}'
		+'	#storeArea div {padding:0.5em;margin:1em;border:2px solid black;height:10em;overflow:auto;}'
		+'	#pureStoreHeading {width:100%;text-align:left;background-color:#eeeeee;padding:1em;}'
		+'&lt;/style&gt;'
		+'&lt;div id=&quot;pureStoreHeading&quot;&gt;'
		+'	TiddlyWiki &quot;PureStore&quot; export file&lt;br&gt;'
		+'	Source'+': &lt;b&gt;%0&lt;/b&gt;&lt;br&gt;'
		+'	Title: &lt;b&gt;%1&lt;/b&gt;&lt;br&gt;'
		+'	Subtitle: &lt;b&gt;%2&lt;/b&gt;&lt;br&gt;'
		+'	Created: &lt;b&gt;%3&lt;/b&gt; by &lt;b&gt;%4&lt;/b&gt;&lt;br&gt;'
		+'	TiddlyWiki %5 / %6 %7&lt;br&gt;'
		+'	Notes:&lt;hr&gt;&lt;pre&gt;%8&lt;/pre&gt;'
		+'&lt;/div&gt;'
		+'&lt;div id=&quot;storeArea&quot;&gt;',
	pureStoreTiddler:
		'%0\n%1',
	pureStoreFooter:
		'&lt;/div&gt;&lt;!--POST-BODY-START--&gt;\n&lt;!--POST-BODY-END--&gt;&lt;/body&gt;&lt;/html&gt;',
	assembleFile: function(target,filetype,tids,limit,notes,quiet,overwrite,merge,total) {
		var revised='';
		var now = new Date().toLocaleString();
		var src=convertUnicodeToUTF8(document.location.href);
		var title = convertUnicodeToUTF8(wikifyPlain('SiteTitle').htmlEncode());
		var subtitle = convertUnicodeToUTF8(wikifyPlain('SiteSubtitle').htmlEncode());
		var user = convertUnicodeToUTF8(config.options.txtUserName.htmlEncode());
		var twver = version.major+'.'+version.minor+'.'+version.revision;
		var v=version.extensions.SaveAsPlugin; var pver = v.major+'.'+v.minor+'.'+v.revision;
		var headerargs=[src,title,subtitle,now,user,twver,'SaveAsPlugin',pver,notes];
		switch (filetype) {
			case this.type_TX: // plain text
				var header=this.plainTextHeader.format(headerargs);
				var footer=this.plainTextFooter;
				break;
			case this.type_CS: // comma-separated
				var fields={};
				for (var i=0; i&lt;tids.length; i++) for (var f in tids[i].fields) fields[f]=f;
				var names=['title','created','modified','modifier','tags','text'];
				for (var f in fields) names.push(f);
				var header=names.join(',')+'\n';
				var footer='';
				break;
			case this.type_NF: // news feed (XML)
				headerargs[0]=store.getTiddlerText('SiteUrl','');
				var header=this.newsFeedHeader.format(headerargs);
				var footer=this.newsFeedFooter;
				tids=store.sortTiddlers(tids,'-modified');
				break;
			case this.type_PS: // PureStore (no code)
				var header=this.pureStoreHeader.format(headerargs);
				var footer=this.pureStoreFooter;
				break;
			case this.type_TW: // full TiddlyWiki
			default:
				var currPath=getLocalPath(window.location.href);
				var original=loadFile(currPath);
				if (!original) { alert(config.messages.cantSaveError); return; }
				var posDiv = locateStoreArea(original);
				if (!posDiv) { alert(config.messages.invalidFileError.format([currPath])); return; }
				var header = original.substr(0,posDiv[0]+startSaveArea.length)+'\n';
				var footer = '\n'+original.substr(posDiv[1]);
				break;
		}
		if (parseInt(limit)!=0) tids=tids.slice(0,limit);
		var out=this.getData(target,filetype,tids,quiet,overwrite,merge,fields);
		var revised = header+convertUnicodeToUTF8(out.join('\n'))+footer;
		// if full TW, insert page title and language attr, and reset MARKUP blocks as needed...
		if (filetype==this.type_TW) {
			var newSiteTitle=convertUnicodeToUTF8(getPageTitle()).htmlEncode();
			revised=revised.replaceChunk('&lt;title'+'&gt;','&lt;/title'+'&gt;',' ' + newSiteTitle + ' ');
			revised=updateLanguageAttribute(revised);
			var titles=[]; for (var i=0; i&lt;tids.length; i++) titles.push(tids[i].title);
			revised=updateMarkupBlock(revised,'PRE-HEAD',
				titles.contains('MarkupPreHead')? 'MarkupPreHead' :null);
			revised=updateMarkupBlock(revised,'POST-HEAD',
				titles.contains('MarkupPostHead')?'MarkupPostHead':null);
			revised=updateMarkupBlock(revised,'PRE-BODY',
				titles.contains('MarkupPreBody')? 'MarkupPreBody' :null);
			revised=updateMarkupBlock(revised,'POST-SCRIPT',
				titles.contains('MarkupPostBody')?'MarkupPostBody':null);
		}
		total.val=out.length;
		return revised;
	},
	getData: function(target,filetype,tids,quiet,overwrite,merge,fields) {
		// output selected tiddlers and gather list of titles (for use with merge)
		var out=[]; var titles=[];
		var url=store.getTiddlerText('SiteUrl','');
		for (var i=0; i&lt;tids.length; i++) {
			out.push(this.formatItem(store,filetype,tids[i],url,fields));
			titles.push(tids[i].title);
		}
		// if TW or PureStore format, ask to merge with existing tiddlers (if any)
		if (filetype==this.type_TW || filetype==this.type_PS) {
			if (overwrite) return out; // skip merge... forced overwrite
			var txt=loadFile(target);
			if (txt &amp;&amp; txt.length) {
				var remoteStore=new TiddlyWiki();
				if (version.major+version.minor*.1+version.revision*.01&lt;2.52) txt=convertUTF8ToUnicode(txt);
				if (remoteStore.importTiddlyWiki(txt) &amp;&amp; (merge||confirm(this.mergeprompt.format([target])))) {
					var existing=remoteStore.getTiddlers('title');
					for (var i=0; i&lt;existing.length; i++)
						if (!titles.contains(existing[i].title))
							out.push(this.formatItem(remoteStore,filetype,existing[i],url));
					if (!quiet) displayMessage(this.mergestatus.format([tids.length,out.length-tids.length]));
				}
			}
		}
		return out;
	},
	formatItem: function(s,f,t,u,fields) {
		if (f==this.type_TW)
			var r=s.getSaver().externalizeTiddler(s,t);
		if (f==this.type_PS)
			var r=this.pureStoreTiddler.format([t.title,s.getSaver().externalizeTiddler(s,t)]);
		if (f==this.type_NF)
			var r=this.newsFeedTiddler.format([t.saveToRss(u)]);
		if (f==this.type_TX)
			var r=this.plainTextTiddler.format([t.title, t.created.toLocaleString(), t.modified.toLocaleString(),
				t.modifier, String.encodeTiddlyLinkList(t.tags), t.text]);
		if (f==this.type_CS) {
			function toCSV(t) { return '&quot;'+t.replace(/&quot;/g,'&quot;&quot;')+'&quot;'; } // always encode CSV
			var out=[ toCSV(t.title), toCSV(t.created.toLocaleString()), toCSV(t.modified.toLocaleString()),
				toCSV(t.modifier), toCSV(String.encodeTiddlyLinkList(t.tags)), toCSV(t.text) ];
			for (var f in fields) out.push(toCSV(t.fields[f]||''));
			var r=out.join(',');
		}
		return r||'';
	}
};
//}}}
//{{{
// automatically add saveAs to backstage
config.tasks.saveAs = {
	text: 'saveAs',
	tooltip: config.macros.saveAs.prompt,
	action: function(){ clearMessage(); config.macros.saveAs.go(); }
}
config.backstageTasks.splice(config.backstageTasks.indexOf('save')+1,0,'saveAs');
//}}}</pre>
</div>
<div title="SearchOptionsPlugin" modifier="John Hind" created="200510181742" modified="201102131623" tags="DiscoveryPackage NavigationPackage systemConfig excludeLists excludeSearch excludeMissing" changecount="2">
<pre>/***
|Name|SearchOptionsPlugin|
|Source|http://www.TiddlyTools.com/#SearchOptionsPlugin|
|Documentation|http://www.TiddlyTools.com/#SearchOptionsPluginInfo|
|Version|3.0.7|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|extend core search function with additional user-configurable options|
Adds extra options to core search function including selecting which data items to search, enabling/disabling incremental key-by-key searches, and generating a ''list of matching tiddlers'' instead of immediately displaying all matches.  This plugin also adds syntax for rendering 'search links' within tiddler content to embed one-click searches using pre-defined 'hard-coded' search terms.
!!!!!Documentation
&gt;see [[SearchOptionsPluginInfo]]
!!!!!Configuration
&lt;&lt;&lt;
Search in:
&lt;&lt;option chkSearchTitles&gt;&gt; titles &lt;&lt;option chkSearchText&gt;&gt; text &lt;&lt;option chkSearchTags&gt;&gt; tags &lt;&lt;option chkSearchFields&gt;&gt; fields &lt;&lt;option chkSearchShadows&gt;&gt; shadows
&lt;&lt;option chkSearchHighlight&gt;&gt; Highlight matching text in displayed tiddlers
&lt;&lt;option chkSearchList&gt;&gt; Show list of matches
&lt;&lt;option chkSearchListTiddler&gt;&gt; Write list to [[SearchResults]] tiddler
&lt;&lt;option chkSearchTitlesFirst&gt;&gt; Show title matches first
&lt;&lt;option chkSearchByDate&gt;&gt; Sort matching tiddlers by modification date (most recent first)
&lt;&lt;option chkSearchResultsOptions&gt;&gt; Include {{{options...}}} slider in &quot;search again&quot; form
&lt;&lt;option chkIncrementalSearch&gt;&gt; Incremental key-by-key search: {{twochar{&lt;&lt;option txtIncrementalSearchMin&gt;&gt;}}} or more characters,  {{threechar{&lt;&lt;option txtIncrementalSearchDelay&gt;&gt;}}} msec delay
&lt;&lt;option chkSearchOpenTiddlers&gt;&gt; Search only in tiddlers that are currently displayed
&lt;&lt;option chkSearchExcludeTags&gt;&gt; Exclude tiddlers tagged with: &lt;&lt;option txtSearchExcludeTags&gt;&gt;
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2010.05.03 3.0.8 added chkSearchResultsOptions to allow/omit the &quot;options...&quot; slider from the &quot;search again&quot; form
|please see [[SearchOptionsPluginInfo]] for additional revision details|
2005.10.18 1.0.0 Initial Release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.SearchOptionsPlugin= {major: 3, minor: 0, revision: 8, date: new Date(2010,5,3)};

var defaults={
	chkSearchTitles:	true,
	chkSearchText:		true,
	chkSearchTags:		true,
	chkSearchFields:	true,
	chkSearchTitlesFirst:	true,
	chkSearchList:		true,
	chkSearchHighlight:	true,
	chkSearchListTiddler:	false,
	chkSearchByDate:	false,
	chkIncrementalSearch:	true,
	chkSearchShadows:	true,
	chkSearchOpenTiddlers:	false,
	chkSearchResultsOptions:true,
	chkSearchExcludeTags:	true,
	txtSearchExcludeTags:	'excludeSearch',
	txtIncrementalSearchDelay:	500,
	txtIncrementalSearchMin:	3
}; for (var id in defaults) if (config.options[id]===undefined)
	config.options[id]=defaults[id];

if (config.macros.search.reportTitle==undefined)
	config.macros.search.reportTitle=&quot;SearchResults&quot;; // note: not a cookie!
config.macros.search.label+=&quot;\xa0&quot;; // a little bit of space just because it looks better
//}}}
// // searchLink: {{{[search[text to find]] OR [search[text to display|text to find]]}}}
//{{{
config.formatters.push( {
	name: &quot;searchLink&quot;,
	match: &quot;\\[search\\[&quot;,
	lookaheadRegExp: /\[search\[(.*?)(?:\|(.*?))?\]\]/mg,
	prompt: &quot;search for: '%0'&quot;,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch &amp;&amp; lookaheadMatch.index == w.matchStart) {
			var label=lookaheadMatch[1];
			var text=lookaheadMatch[2]||label;
			var prompt=this.prompt.format([text]);
			var btn=createTiddlyButton(w.output,label,prompt,
				function(){story.search(this.getAttribute(&quot;searchText&quot;))},&quot;searchLink&quot;);
			btn.setAttribute(&quot;searchText&quot;,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
});
//}}}
// // incremental search uses option settings instead of hard-coded delay and minimum input values
//{{{
var fn=config.macros.search.onKeyPress;
fn=fn.toString().replace(/500/g, &quot;config.options.txtIncrementalSearchDelay||500&quot;);
fn=fn.toString().replace(/&gt; 2/g, &quot;&gt;=(config.options.txtIncrementalSearchMin||3)&quot;);
eval(&quot;config.macros.search.onKeyPress=&quot;+fn);
//}}}
// // REPLACE story.search() for option to &quot;show search results in a list&quot;
//{{{
Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	var co=config.options; // abbrev
	var re=new RegExp(useRegExp ? text : text.escapeRegExp(),useCaseSensitive ? &quot;mg&quot; : &quot;img&quot;);
	if (config.options.chkSearchHighlight) highlightHack=re;
	var matches = store.search(re,co.chkSearchByDate?&quot;modified&quot;:&quot;title&quot;,&quot;&quot;);
	if (co.chkSearchByDate) matches=matches.reverse(); // most recent first
	var q = useRegExp ? &quot;/&quot; : &quot;'&quot;;
	clearMessage();
	if (!matches.length) {
		if (co.chkSearchListTiddler) discardSearchResults();
		displayMessage(config.macros.search.failureMsg.format([q+text+q]));
	} else {
		if (co.chkSearchList||co.chkSearchListTiddler)
			reportSearchResults(text,matches);
		else {
			var titles = []; for(var t=0; t&lt;matches.length; t++) titles.push(matches[t].title);
			this.closeAllTiddlers(); story.displayTiddlers(null,titles);
			displayMessage(config.macros.search.successMsg.format([matches.length, q+text+q]));
		}
	}
	highlightHack = null;
}
//}}}
// // REPLACE store.search() for enhanced searching/sorting options
//{{{
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag,match)
{
	var co=config.options; // abbrev
	var tids = this.reverseLookup(&quot;tags&quot;,excludeTag,!!match,sortField);
	var opened=[]; story.forEachTiddler(function(tid,elem){opened.push(tid);});

	// eliminate tiddlers tagged with excluded tags
	if (co.chkSearchExcludeTags&amp;&amp;co.txtSearchExcludeTags.length) {
		var ex=co.txtSearchExcludeTags.readBracketedList();
		var temp=[]; for(var t=tids.length-1; t&gt;=0; t--)
			if (!tids[t].tags.containsAny(ex)) temp.push(tids[t]);
		tids=temp;
	}

	// scan for matching titles first...
	var results = [];
	if (co.chkSearchTitles) {
		for(var t=0; t&lt;tids.length; t++) {
			if (co.chkSearchOpenTiddlers &amp;&amp; !opened.contains(tids[t].title)) continue;
			if(tids[t].title.search(searchRegExp)!=-1) results.push(tids[t]);
		}
		if (co.chkSearchShadows)
			for (var t in config.shadowTiddlers) {
				if (co.chkSearchOpenTiddlers &amp;&amp; !opened.contains(t)) continue;
				if ((t.search(searchRegExp)!=-1) &amp;&amp; !store.tiddlerExists(t))
					results.push((new Tiddler()).assign(t,config.shadowTiddlers[t]));
			}
	}
	// then scan for matching text, tags, or field data
	for(var t=0; t&lt;tids.length; t++) {
		if (co.chkSearchOpenTiddlers &amp;&amp; !opened.contains(tids[t].title)) continue;
		if (co.chkSearchText &amp;&amp; tids[t].text.search(searchRegExp)!=-1)
			results.pushUnique(tids[t]);
		if (co.chkSearchTags &amp;&amp; tids[t].tags.join(&quot; &quot;).search(searchRegExp)!=-1)
			results.pushUnique(tids[t]);
		if (co.chkSearchFields &amp;&amp; store.forEachField!=undefined)
			store.forEachField(tids[t],
				function(tid,field,val) {
					if (val.search(searchRegExp)!=-1) results.pushUnique(tids[t]);
				},
				true); // extended fields only
	}
	// then check for matching text in shadows
	if (co.chkSearchShadows)
		for (var t in config.shadowTiddlers) {
			if (co.chkSearchOpenTiddlers &amp;&amp; !opened.contains(t)) continue;
			if ((config.shadowTiddlers[t].search(searchRegExp)!=-1) &amp;&amp; !store.tiddlerExists(t))
				results.pushUnique((new Tiddler()).assign(t,config.shadowTiddlers[t]));
		}

	// if not 'titles first', or sorting by modification date,
	// re-sort results to so titles, text, tag and field matches are mixed together
	if(!sortField) sortField = &quot;title&quot;;
	var bySortField=function(a,b){
		if(a[sortField]==b[sortField])return(0);else return(a[sortField]&lt;b[sortField])?-1:+1;
	}
	if (!co.chkSearchTitlesFirst || co.chkSearchByDate) results.sort(bySortField);

	return results;
}
//}}}
// // HIJACK core {{{&lt;&lt;search&gt;&gt;}}} macro to add &quot;report&quot; and &quot;simple inline&quot; output
//{{{
config.macros.search.SOP_handler=config.macros.search.handler;
config.macros.search.handler = function(place,macroName,params)
{
	// if &quot;report&quot;, use SearchOptionsPlugin report generator for inline output
	if (params[1]&amp;&amp;params[1].substr(0,6)==&quot;report&quot;) {
		var keyword=params[0];
		var options=params[1].split(&quot;=&quot;)[1]; // split &quot;report=option+option+...&quot;
		var heading=params[2]?params[2].unescapeLineBreaks():&quot;&quot;;
		var matches=store.search(new RegExp(keyword.escapeRegExp(),&quot;img&quot;),&quot;title&quot;,&quot;excludeSearch&quot;);
		if (matches.length) wikify(heading+window.formatSearchResults(keyword,matches,options),place);
	} else if (params[1]) {
		var keyword=params[0];
		var heading=params[1]?params[1].unescapeLineBreaks():&quot;&quot;;
		var seperator=params[2]?params[2].unescapeLineBreaks():&quot;, &quot;;
		var matches=store.search(new RegExp(keyword.escapeRegExp(),&quot;img&quot;),&quot;title&quot;,&quot;excludeSearch&quot;);
		if (matches.length) {
			var out=[];
			for (var m=0; m&lt;matches.length; m++) out.push(&quot;[[&quot;+matches[m].title+&quot;]]&quot;);
			wikify(heading+out.join(seperator),place);
		}
	} else
		config.macros.search.SOP_handler.apply(this,arguments);
};
//}}}
// // SearchResults panel handling
//{{{
setStylesheet(&quot;.searchResults { padding:1em 1em 0 1em; }&quot;,&quot;searchResults&quot;); // matches std tiddler padding

config.macros.search.createPanel=function(text,matches,body) {

	function getByClass(e,c) { var d=e.getElementsByTagName(&quot;div&quot;);
		for (var i=0;i&lt;d.length;i++) if (hasClass(d[i],c)) return d[i]; }
	var panel=createTiddlyElement(null,&quot;div&quot;,&quot;searchPanel&quot;,&quot;searchPanel&quot;);
	this.renderPanel(panel,text,matches,body);
	var oldpanel=document.getElementById(&quot;searchPanel&quot;);
	if (!oldpanel) { // insert new panel just above tiddlers
		var da=document.getElementById(&quot;displayArea&quot;);
		da.insertBefore(panel,da.firstChild);
	} else { // if panel exists
		var oldwrap=getByClass(oldpanel,&quot;searchResults&quot;);
		var newwrap=getByClass(panel,&quot;searchResults&quot;);
		// if no prior content, just insert new content
		if (!oldwrap) oldpanel.insertBefore(newwrap,null);
		else {	// swap search results content but leave containing panel intact
			oldwrap.style.display='block'; // unfold wrapper if needed
			var i=oldwrap.getElementsByTagName(&quot;input&quot;)[0]; // get input field
			if (i) { var pos=this.getCursorPos(i); i.onblur=null; } // get cursor pos, ignore blur
			oldpanel.replaceChild(newwrap,oldwrap);
			panel=oldpanel; // use existing panel
		}
	}
	this.showPanel(true,pos);
	return panel;
}

config.macros.search.renderPanel=function(panel,text,matches,body) {

	var wrap=createTiddlyElement(panel,&quot;div&quot;,null,&quot;searchResults&quot;);
	wrap.onmouseover = function(e){ addClass(this,&quot;selected&quot;); }
	wrap.onmouseout = function(e){ removeClass(this,&quot;selected&quot;); }
	// create toolbar: &quot;open all&quot;, &quot;fold/unfold&quot;, &quot;close&quot;
	var tb=createTiddlyElement(wrap,&quot;div&quot;,null,&quot;toolbar&quot;);
	var b=createTiddlyButton(tb, &quot;open all&quot;, &quot;open all matching tiddlers&quot;, function() {
		story.displayTiddlers(null,this.getAttribute(&quot;list&quot;).readBracketedList()); return false; },&quot;button&quot;);
	var list=&quot;&quot;; for(var t=0;t&lt;matches.length;t++) list+='[['+matches[t].title+']] ';
	b.setAttribute(&quot;list&quot;,list);
	var b=createTiddlyButton(tb, &quot;fold&quot;, &quot;toggle display of search results&quot;, function() {
		config.macros.search.foldPanel(this); return false; },&quot;button&quot;);
	var b=createTiddlyButton(tb, &quot;close&quot;, &quot;dismiss search results&quot;,	function() {
		config.macros.search.showPanel(false); return false; },&quot;button&quot;);
	createTiddlyText(createTiddlyElement(wrap,&quot;div&quot;,null,&quot;title&quot;),&quot;Search for: &quot;+text); // title
	wikify(body,createTiddlyElement(wrap,&quot;div&quot;,null,&quot;viewer&quot;)); // report
	return panel;
}

config.macros.search.showPanel=function(show,pos) {
	var panel=document.getElementById(&quot;searchPanel&quot;);
	var i=panel.getElementsByTagName(&quot;input&quot;)[0];
	i.onfocus=show?function(){config.macros.search.stayFocused(true);}:null;
	i.onblur=show?function(){config.macros.search.stayFocused(false);}:null;
	if (show &amp;&amp; panel.style.display==&quot;block&quot;) { // if shown, grab focus, restore cursor
		if (i&amp;&amp;this.stayFocused()) { i.focus(); this.setCursorPos(i,pos); }
		return;
	}
	if(!config.options.chkAnimate) {
		panel.style.display=show?&quot;block&quot;:&quot;none&quot;;
		if (!show) { removeChildren(panel); config.macros.search.stayFocused(false); }
	} else {
		var s=new Slider(panel,show,false,show?&quot;none&quot;:&quot;children&quot;);
		s.callback=function(e,p){e.style.overflow=&quot;visible&quot;;}
		anim.startAnimating(s);
	}
	return panel;
}

config.macros.search.foldPanel=function(button) {
	var d=document.getElementById(&quot;searchPanel&quot;).getElementsByTagName(&quot;div&quot;);
	for (var i=0;i&lt;d.length;i++) if (hasClass(d[i],&quot;viewer&quot;)) var v=d[i]; if (!v) return;
	var show=v.style.display==&quot;none&quot;;
	if(!config.options.chkAnimate)
		v.style.display=show?&quot;block&quot;:&quot;none&quot;;
	else {
		var s=new Slider(v,show,false,&quot;none&quot;);
		s.callback=function(e,p){e.style.overflow=&quot;visible&quot;;}
		anim.startAnimating(s);
	}
	button.innerHTML=show?&quot;fold&quot;:&quot;unfold&quot;;
	return false;
}

config.macros.search.stayFocused=function(keep) { // TRUE/FALSE=set value, no args=get value
	if (keep===undefined) return this.keepReportInFocus;
	this.keepReportInFocus=keep;
	return keep
}

config.macros.search.getCursorPos=function(i) {
	var s=0; var e=0; if (!i) return { start:s, end:e };
	try {
		if (i.setSelectionRange) // FF
			{ s=i.selectionStart; e=i.selectionEnd; }
		if (document.selection &amp;&amp; document.selection.createRange) { // IE
			var r=document.selection.createRange().duplicate();
			var len=r.text.length; s=0-r.moveStart('character',-100000); e=s+len;
		}
	}catch(e){};
	return { start:s, end:e };
}
config.macros.search.setCursorPos=function(i,pos) {
	if (!i||!pos) return; var s=pos.start; var e=pos.end;
	if (i.setSelectionRange) //FF
		i.setSelectionRange(s,e);
	if (i.createTextRange) // IE
		{ var r=i.createTextRange(); r.collapse(true); r.moveStart(&quot;character&quot;,s); r.select(); }
}
//}}}
// // SearchResults report generation
// note: these functions are defined globally, so they can be more easily redefined to customize report formats//
//{{{
if (!window.reportSearchResults) window.reportSearchResults=function(text,matches)
{
	var cms=config.macros.search; // abbrev
	var body=window.formatSearchResults(text,matches);
	if (!config.options.chkSearchListTiddler) // show #searchResults panel
		window.scrollTo(0,ensureVisible(cms.createPanel(text,matches,body)));
	else { // write [[SearchResults]] tiddler
		var title=cms.reportTitle;
		var who=config.options.txtUserName;
		var when=new Date();
		var tags=&quot;excludeLists excludeSearch temporary&quot;;
		var tid=store.getTiddler(title); if (!tid) tid=new Tiddler();
		tid.set(title,body,who,when,tags);
		store.addTiddler(tid);
		story.closeTiddler(title);
		story.displayTiddler(null,title);
	}
}

if (!window.formatSearchResults) window.formatSearchResults=function(text,matches,opt)
{
	var body='';
	var title=config.macros.search.reportTitle
	var q = config.options.chkRegExpSearch ? &quot;/&quot; : &quot;'&quot;;
	if (!opt) var opt=&quot;all&quot;;
	var parts=opt.split(&quot;+&quot;);
	for (var i=0; i&lt;parts.length; i++) { var p=parts[i].toLowerCase();
		if (p==&quot;again&quot;||p==&quot;all&quot;)   body+=window.formatSearchResults_again(text,matches);
		if (p==&quot;summary&quot;||p==&quot;all&quot;) body+=window.formatSearchResults_summary(text,matches);
		if (p==&quot;list&quot;||p==&quot;all&quot;)    body+=window.formatSearchResults_list(text,matches);
		if (p==&quot;buttons&quot;||p==&quot;all&quot;) body+=window.formatSearchResults_buttons(text,matches);
	}
	return body;
}

if (!window.formatSearchResults_again) window.formatSearchResults_again=function(text,matches)
{
	var title=config.macros.search.reportTitle
	var body='';
	// search again
	body+='{{span{&lt;&lt;search &quot;'+text.replace(/&quot;/g,'&amp;#x22;')+'&quot;&gt;&gt; /%\n';
	body+='%/&lt;html&gt;&lt;input type=&quot;button&quot; value=&quot;search again&quot;';
	body+=' onclick=&quot;var t=this.parentNode.parentNode.getElementsByTagName(\'input\')[0];';
	body+=' config.macros.search.doSearch(t); return false;&quot;&gt;';
	if (!config.options.chkSearchResultsOptions) { // omit &quot;options...&quot;
		body+='&lt;/html&gt;}}}\n\n';
		return body;
	}
	body+=' &lt;a href=&quot;javascript:;&quot; onclick=&quot;';
	body+=' var e=this.parentNode.nextSibling;';
	body+=' var show=e.style.display!=\'block\';';
	body+=' if(!config.options.chkAnimate) e.style.display=show?\'block\':\'none\';';
	body+=' else anim.startAnimating(new Slider(e,show,false,\'none\'));';
	body+=' return false;&quot;&gt;options...&lt;/a&gt;';
	body+='&lt;/html&gt;@@display:none;border-left:1px dotted;margin-left:1em;padding:0;padding-left:.5em;font-size:90%;/%\n';
	body+='	%/&lt;&lt;option chkSearchTitles&gt;&gt;titles /%\n';
	body+='	%/&lt;&lt;option chkSearchText&gt;&gt;text /%\n';
	body+='	%/&lt;&lt;option chkSearchTags&gt;&gt;tags /%\n';
	body+='	%/&lt;&lt;option chkSearchFields&gt;&gt;fields /%\n';
	body+='	%/&lt;&lt;option chkSearchShadows&gt;&gt;shadows\n';
	body+='	&lt;&lt;option chkCaseSensitiveSearch&gt;&gt;case-sensitive /%\n';
	body+='	%/&lt;&lt;option chkRegExpSearch&gt;&gt;text patterns /%\n';
	body+='	%/&lt;&lt;option chkSearchByDate&gt;&gt;sorted by date\n';
	body+='	&lt;&lt;option chkSearchHighlight&gt;&gt; highlight matching text in displayed tiddlers\n';
	body+='	&lt;&lt;option chkIncrementalSearch&gt;&gt;incremental key-by-key search: /%\n';
	body+='	%/{{twochar{&lt;&lt;option txtIncrementalSearchMin&gt;&gt;}}} or more characters, /%\n';
	body+='	%/{{threechar{&lt;&lt;option txtIncrementalSearchDelay&gt;&gt;}}} msec delay\n';
	body+='	&lt;&lt;option chkSearchOpenTiddlers&gt;&gt; search only in tiddlers that are currently displayed\n';
	body+='	&lt;&lt;option chkSearchExcludeTags&gt;&gt;exclude tiddlers tagged with:\n';
	body+='	{{editor{&lt;&lt;option txtSearchExcludeTags&gt;&gt;}}}/%\n';
	body+='%/@@}}}\n\n';
	return body;
}

if (!window.formatSearchResults_summary) window.formatSearchResults_summary=function(text,matches)
{
	// summary: nn tiddlers found matching '...', options used
	var body='';
	var co=config.options; // abbrev
	var title=config.macros.search.reportTitle
	var q = co.chkRegExpSearch ? &quot;/&quot; : &quot;'&quot;;
	body+=&quot;''&quot;+config.macros.search.successMsg.format([matches.length,q+&quot;{{{&quot;+text+&quot;}}}&quot;+q])+&quot;''\n&quot;;
	var opts=[];
	if (co.chkSearchTitles) opts.push(&quot;titles&quot;);
	if (co.chkSearchText) opts.push(&quot;text&quot;);
	if (co.chkSearchTags) opts.push(&quot;tags&quot;);
	if (co.chkSearchFields) opts.push(&quot;fields&quot;);
	if (co.chkSearchShadows) opts.push(&quot;shadows&quot;);
	if (co.chkSearchOpenTiddlers) body+=&quot;^^//search limited to displayed tiddlers only//^^\n&quot;;
	body+=&quot;~~&amp;nbsp; searched in &quot;+opts.join(&quot; + &quot;)+&quot;~~\n&quot;;
	body+=(co.chkCaseSensitiveSearch||co.chkRegExpSearch?&quot;^^&amp;nbsp; using &quot;:&quot;&quot;)
		+(co.chkCaseSensitiveSearch?&quot;case-sensitive &quot;:&quot;&quot;)
		+(co.chkRegExpSearch?&quot;pattern &quot;:&quot;&quot;)
		+(co.chkCaseSensitiveSearch||co.chkRegExpSearch?&quot;matching^^\n&quot;:&quot;&quot;);
	return body;
}

if (!window.formatSearchResults_list) window.formatSearchResults_list=function(text,matches)
{
	// bullet list of links to matching tiddlers
	var body='';
	var co=config.options; // abbrev
	var pattern=co.chkRegExpSearch?text:text.escapeRegExp();
	var sensitive=co.chkCaseSensitiveSearch?&quot;mg&quot;:&quot;img&quot;;
	var link='{{tiddlyLinkExisting{&lt;html&gt;&lt;nowiki&gt;&lt;a href=&quot;javascript:;&quot; onclick=&quot;'
		+'if(config.options.chkSearchHighlight)'
		+'	highlightHack=new RegExp(\x27'+pattern+'\x27.escapeRegExp(),\x27'+sensitive+'\x27);'
		+'story.displayTiddler(null,\x27%0\x27);'
		+'highlightHack = null; return false;'
		+'&quot; title=&quot;%2&quot;&gt;%1&lt;/a&gt;&lt;/html&gt;}}}';
	for(var t=0;t&lt;matches.length;t++) {
		body+=&quot;* &quot;;
		if (co.chkSearchByDate)
			body+=matches[t].modified.formatString('YYYY.0MM.0DD 0hh:0mm')+&quot; &quot;;
		var title=matches[t].title;
		var fixup=title.replace(/'/g,&quot;\\x27&quot;).replace(/&quot;/g,&quot;\\x22&quot;);
		var tid=store.getTiddler(title);
		var tip=tid?tid.getSubtitle():''; tip=tip.replace(/&quot;/g,&quot;&amp;quot;&quot;);
		body+=link.format([fixup,title,tip])+'\n';
	}
	return body;
}

if (!window.formatSearchResults_buttons) window.formatSearchResults_buttons=function(text,matches)
{
	// embed buttons only if writing SearchResults to tiddler
	if (!config.options.chkSearchListTiddler) return &quot;&quot;;
	// &quot;open all&quot; button
	var title=config.macros.search.reportTitle;
	var body=&quot;&quot;;
	body+=&quot;@@diplay:block;&lt;html&gt;&lt;input type=\&quot;button\&quot; href=\&quot;javascript:;\&quot; &quot;
		+&quot;onclick=\&quot;story.displayTiddlers(null,[&quot;;
	for(var t=0;t&lt;matches.length;t++)
		body+=&quot;'&quot;+matches[t].title.replace(/\'/mg,&quot;\\'&quot;)+&quot;'&quot;+((t&lt;matches.length-1)?&quot;, &quot;:&quot;&quot;);
	body+=&quot;],1);\&quot; accesskey=\&quot;O\&quot; value=\&quot;open all matching tiddlers\&quot;&gt;&lt;/html&gt; &quot;;
	// &quot;discard SearchResults&quot; button
	body+=&quot;&lt;html&gt;&lt;input type=\&quot;button\&quot; href=\&quot;javascript:;\&quot; &quot;
		+&quot;onclick=\&quot;discardSearchResults()\&quot; value=\&quot;discard &quot;+title+&quot;\&quot;&gt;&lt;/html&gt;&quot;;
	body+=&quot;@@\n&quot;;
	return body;
}

if (!window.discardSearchResults) window.discardSearchResults=function()
{
	// remove the tiddler
	story.closeTiddler(config.macros.search.reportTitle);
	store.deleteTiddler(config.macros.search.reportTitle);
	store.notify(config.macros.search.reportTitle,true);
}
//}}}</pre>
</div>
<div title="SectionLinksPlugin" creator="John Hind" modifier="John Hind" created="200901061840" modified="201103041503" tags="systemConfig excludeLists excludeMissing excludeSearch">
<pre>/***
|Name|SectionLinksPlugin|
|Source|http://www.TiddlyTools.com/#SectionLinksPlugin|
|Documentation|http://www.TiddlyTools.com/#SectionLinksPlugin|
|Version|1.4.99|
|Author|Eric Shulman Mod JH|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|allow tiddler sections in TiddlyLinks to be used as anchor points|
This plugin enhances the processing of section references so they can be used in links to auto-scroll to the indicated heading within a tiddler (i.e., similar to the 'anchor' behavior provided in HTML by {{{&lt;a name=&quot;foo&quot;&gt;}}} and {{{&lt;a href=&quot;#foo&quot;&gt;...&lt;/a&gt;}}})
!!!Usage
&lt;&lt;&lt;
!!!!~TiddlyLink syntax
&gt;The standard link syntax has been extended so that a section name can included in a tiddler link (e.g., {{{[[SomeTiddler##SomeSection]]}}}).  When clicked, the tiddler is displayed and the specified section heading will be automatically scrolled into view. If the tiddler title is omitted or the 'here' keyword is used (e.g., {{{[[##SomeSection]]}}} or {{{[[here##SomeSection]]&gt;&gt;}}}), then the current containing tiddler is implied by default.
&gt;
&gt;//Note: the enhanced &quot;section&quot;&quot; link syntax can also be used with ''anchor'' elements defined by HTML syntax://
&gt;&gt;{{{&lt;html&gt;&lt;a name=&quot;sectionname&quot; /&gt;&lt;/html&gt;}}}
&gt;//This provides an alternative syntax can automatically scroll to content without requiring use of the standard TW section ''heading'' syntax.//
!!!!{{{&lt;&lt;tiddler&gt;&gt;}}} macro
JH: This functionality moved to JHScriptPlugin. ''here'' version removed. Functionality extended to slices as well as sections and implemented more robustly.
&gt;The {{{&lt;&lt;tiddler SomeTiddler##SomeSection&gt;&gt;}}} syntax has been extended so that when the tiddler title is omitted or the 'here' keyword is used (e.g., {{{&lt;&lt;tiddler ##SomeSection&gt;&gt;}}} or {{{&lt;&lt;tiddler here##SomeSection&gt;&gt;}}}), then the current containing tiddler is implied by default.
!!!!&quot;&quot;&quot;&lt;&lt;sectionTOC&gt;&gt;&quot;&quot;&quot; macro
&gt;This macro generates a 'Table of Contents'-style numbered-bullet list with links to all sections within the current tiddler.  Simply place the following macro at the //end of the tiddler content// (i.e., following all section headings):
{{{
&lt;&lt;sectionTOC&gt;&gt; or &lt;&lt;sectionTOC className&gt;&gt;
}}}
&gt;Note: The macro must occur at the end of the tiddler in order to locate the rendered section headings that precede it. In addition, to position the macro's //output// within the tiddler, you must create a special 'target element' that uses a specified classname (default='sectionTOC'), like this:
{{{
{{sectionTOC{}}}
}}}
&gt;When the {{{&lt;&lt;sectionTOC&gt;&gt;}}} macro is rendered, it will find the matching 'sectionTOC'-classed element and writes it's output there.  You can also add the macro and/or target elements directly to the [[ViewTemplate]] definition, so that every tiddler can automatically display the table of contents:
{{{
&lt;span class='sectionTOC'&gt;&lt;/span&gt; &lt;!-- target element --&gt;
...
&lt;span macro='sectionTOC'&gt;&lt;/span&gt; &lt;!-- must be at end of tiddler --&gt;
}}}
&lt;&lt;&lt;
!!!Examples
&lt;&lt;&lt;
links to sections defined by ''TW heading syntax'' (e.g, {{{!!!sectionname}}}):{{indent{
[[SectionLinksPlugin##onClickTiddlerLink]]
[[##onClickTiddlerLink]] //(current tiddler implied)//}}}
links to anchors defined by ''HTML syntax'' (e.g., {{{&lt;html&gt;&lt;a href=&quot;anchorname&quot;&gt;&lt;/html&gt;}}}):{{indent{
[[SectionLinksPlugin##sampleanchorlink]]
[[##sampleanchorlink]] //(current tiddler implied)//}}}
&lt;&lt;&lt;
!!!Revisions
&lt;&lt;&lt;
2011.03.04 1.4.99 JH: Removed the tiddler macro hijack - functionality relocated to JHScriptPlugin
2011.02.08 1.4.1 in isExternalLink() hijack, strip section references before testing for external link
2010.08.09 1.4.0 in scrollToSection(), added support for using HTML &lt;a name=&quot;...&quot;&gt; anchor elements
2009.08.21 1.3.4 added handling to ignore leading/trailing whitespace in section references
2009.08.21 1.3.3 in createTiddlyLink(), add tiddlyLinkNonExistingSection class if matching section is not found
2009.08.14 1.3.2 in createTiddlyLink(), don't override core value for ~TiddlyLink attribute
2009.08.02 1.3.1 in sectionTOC.handler(), trim leading/trailing whitespace from generated section links
2009.08.01 1.3.0 in scrollToSection(), apply 3-tier section matching (exact, startsWith, contains)
2009.07.06 1.2.2 fixed displayTiddler() hijack
2009.07.03 1.2.1 in {{{&lt;&lt;sectionTOC&gt;&gt;}}}, suppress output if target is not found
2009.06.02 1.2.0 added support for 'here' keyword in {{{[[here##section]]}}} links and {{{&lt;&lt;tiddler here##section&gt;&gt;}}} macro
2009.04.09 1.1.1 in sectionTOC macro, make target visible when TOC is rendered.
2009.01.18 1.1.0 added {{{&lt;&lt;sectionTOC&gt;&gt;}}} macro to generate numbered-bullet links to sections of current tiddler
2009.01.06 1.0.0 converted to stand-alone plugin
2008.10.14 0.0.0 initial release (as [[CoreTweaks]] #784 - http://trac.tiddlywiki.org/ticket/784)
&lt;&lt;&lt;
!!!Code
***/
//{{{
version.extensions.SectionLinksPlugin= {major: 1, minor: 4, revision: 1, date: new Date(2011,2,8)};

Story.prototype.scrollToSection = function(title,section) {
	if (!title||!section) return; var t=this.getTiddler(title); if (!t) return null;
	var elems=t.getElementsByTagName('*');
	var heads=[]; var anchors=[];
	for (var i=0; i&lt;elems.length; i++)
		if (['H1','H2','H3','H4','H5'].contains(elems[i].nodeName)) heads.push(elems[i]);
	for (var i=0; i&lt;elems.length; i++)
		if (elems[i].nodeName=='A' &amp;&amp; (elems[i].getAttribute('name')||'').length) anchors.push(elems[i]);
	var found=null;
	for (var i=0; i&lt;heads.length; i++)
		if (getPlainText(heads[i]).trim()==section) { found=heads[i]; break; }
	if (!found) for (var i=0; i&lt;heads.length; i++)
		if (getPlainText(heads[i]).trim().startsWith(section)) { found=heads[i]; break; }
	if (!found) for (var i=0; i&lt;heads.length; i++)
		if (getPlainText(heads[i]).trim().indexOf(section)!=-1) { found=heads[i]; break; }
	if (!found) for (var i=0; i&lt;anchors.length; i++)
		if (anchors[i].getAttribute('name')==section) { found=anchors[i]; break; }
	if (!found) for (var i=0; i&lt;anchors.length; i++)
		if (anchors[i].getAttribute('name').startsWith(section)) { found=anchors[i]; break; }
	if (!found) for (var i=0; i&lt;anchors.length; i++)
		if (anchors[i].getAttribute('name').indexOf(section)!=-1) { found=anchors[i]; break; }
	if (found) {
		// if section heading is collapsed, click to expand it - see [[FoldHeadingsPlugin]]
		if (hasClass(found,'foldable') &amp;&amp; found.nextSibling.style.display=='none') found.onclick();
		// scroll *after* tiddler animation
		var delay=config.options.chkAnimate?config.animDuration+100:0;
		setTimeout('window.scrollTo('+findPosX(found)+','+findPosY(found)+')',delay);
		return found;
	}
}
//}}}
/***
!!!!core hijacks
***/
/***
!!!!!createTiddlyLink
***/
//{{{
// [[tiddlername##section]] and [[##section]]
if (!window.createTiddlyLink_section)
	window.createTiddlyLink_section=window.createTiddlyLink;
window.createTiddlyLink=function(place,title) {
	var t=story.findContainingTiddler(place); var tid=t?t.getAttribute('tiddler'):'';
	var parts=title.split(config.textPrimitives.sectionSeparator);
	var title=parts[0]; var section=parts[1]; if (section) section=section.trim();
	if (!title.length || title.toLowerCase()=='here') title=tid;  // default=current tiddler
	arguments[1]=title;
	var btn=createTiddlyLink_section.apply(this,arguments);
	if (section) {
		btn.setAttribute('section',section);
		if (store.getTiddlerText(title+config.textPrimitives.sectionSeparator+section)===null)
			addClass(btn,'tiddlyLinkNonExistingSection');
	}
	return btn;
}
//}}}
/***
!!!!!onClickTiddlerLink
***/
//{{{
if (!window.onClickTiddlerLink_section)
	window.onClickTiddlerLink_section=window.onClickTiddlerLink;
window.onClickTiddlerLink=function(ev) {
	var e=ev||window.event;	var target=resolveTarget(e); var title=null;
	while (target!=null &amp;&amp; title==null) {
		title=target.getAttribute('tiddlyLink');
		section=target.getAttribute('section');
		target=target.parentNode;
	}
	var t=story.findContainingTiddler(target); var tid=t?t.getAttribute('tiddler'):'';
	if (title!=tid||!section) // avoid excess scrolling for intra-tiddler links
		onClickTiddlerLink_section.apply(this,arguments);
	story.scrollToSection(title,section);
	return false;
}
//}}}
/***
!!!!! displayTiddler
***/
//{{{
if (!Story.prototype.displayTiddler_section)
	Story.prototype.displayTiddler_section=Story.prototype.displayTiddler;
Story.prototype.displayTiddler = function(srcElement,tiddler)
{
	var title=(tiddler instanceof Tiddler)?tiddler.title:tiddler;
	var parts=title.split(config.textPrimitives.sectionSeparator);
	var title=parts[0]; var section=parts[1]; if (section) section=section.trim();
	if (!title.length || title.toLowerCase()=='here') {
		var t=story.findContainingTiddler(place);
		title=t?t.getAttribute('tiddler'):'';
	}
	arguments[1]=title;  // default=current tiddler
	this.displayTiddler_section.apply(this,arguments);
	story.scrollToSection(title,section);
}
//}}}
/***
&lt;html&gt;&lt;a name=&quot;sampleanchorlink&quot; /&gt;&lt;/html&gt;This is a sample ''anchor link'': {{{&lt;html&gt;&lt;a name=&quot;sampleanchorlink&quot; /&gt;&lt;/html&gt;}}}
!!!!!isExternalLink
***/
//{{{
if (!config.formatterHelpers.isExternalLink_section)
	config.formatterHelpers.isExternalLink_section=config.formatterHelpers.isExternalLink;
config.formatterHelpers.isExternalLink=function(link) {  // remove section references before testing
	var l=link.split(config.textPrimitives.sectionSeparator)[0];
	return config.formatterHelpers.isExternalLink_section(l);
}
//}}}
/***
!!!!!tiddler.handler
***/
//{{{
//if (!config.macros.tiddler.handler_section)
//	config.macros.tiddler.handler_section=config.macros.tiddler.handler;
//config.macros.tiddler.handler=function(place,macroName,params,wikifier,paramString,tiddler)
//{
//	if (!params[0]) return;
//	var sep=config.textPrimitives.sectionSeparator;
//	var parts=params[0].split(sep); var tid=parts[0]; var sec=parts[1]; if (sec) sec=sec.trim();
//	if ((tid.toLowerCase()=='here'||!tid.length) &amp;&amp; sec) { // fixup for 'here##section' and '##section'
//		var here=story.findContainingTiddler(place)
//		var tid=here?here.getAttribute('tiddler'):tiddler?tiddler.title:'';
//		arguments[2][0]=tid+sep+sec;
//		arguments[4]=paramString.replace(new RegExp('(here)?'+sep+sec),tid+sep+sec);
//	}
//	config.macros.tiddler.handler_section.apply(this,arguments);
//}
//}}}
/***
!!!!sectionTOC macro
***/
//{{{
config.macros.sectionTOC = {
	targetClass: 'sectionTOC',
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var out=[];
		var targetClass=params[0]||this.targetClass;
		var t=story.findContainingTiddler(place); if (!t) return;
		var elems=t.getElementsByTagName('*');
		var level=5; // topmost heading level
		for (var i=0; i&lt;elems.length; i++) {
			var txt=getPlainText(elems[i]).trim();
			var link='[['+txt+'|##'+txt+']]';
			switch(elems[i].nodeName) {
				case 'H1': out.push('#'+link);		level=1; break;
				case 'H2': out.push('##'+link);		level=level&lt;2?level:2; break;
				case 'H3': out.push('###'+link);	level=level&lt;3?level:3; break;
				case 'H4': out.push('####'+link);	level=level&lt;4?level:4; break;
				case 'H5': out.push('#####'+link);	level=level&lt;5?level:5; break;
				default: if (hasClass(elems[i],targetClass)) var target=elems[i];
			}
		}
		// trim excess bullet levels
		if (level&gt;1) for (var i=0; i&lt;out.length; i++) out[i]=out[i].substr(level-1);
		// show numbered list
		if (out.length &amp;&amp; target) {
			if (target.style.display=='none') target.style.display='block';
			wikify(out.join('\n'),target);
		}
	}
}
//}}}
/***
!!!Invoke macro
{{{
&lt;&lt;sectionTOC&gt;&gt;
}}}
***/
// //&lt;&lt;sectionTOC&gt;&gt;</pre>
</div>
<div title="Set Class" creator="John Hind" modifier="John Hind" created="201005312033" modified="201312131744" changecount="8">
<pre>!set = Set( ... )
Returns an object of Set Class. With no parameter this will be an empty set. With a single Lua table parameter having no metatable, the table is converted in place to a set. The values in the table are all set to boolean ''true''. Other parameters result in a new table with the parameters inserted as keys, each with the value boolean ''true''.

A set is a wrapper for a Lua table in which the keys may be of any type and the values may only be boolean ''true''. An error will be raised if a new entry is created with a value other than Boolean ''true'', but it is possible to break a set by setting an existing entry to a value other than ''nil'' or Boolean ''true''.

To add an element to the set, assign {{{true}}} to the element key. To remove an element, assign {{{nil}}} to the element key. To test an element for membership of a set, just use a boolean test on the element key.
{{{
local set = Set()
set.Monday = true
if set.Monday then print(&quot;Monday is in set&quot;) end
set[&quot;Monday&quot;] = nil
if not set[&quot;Monday&quot;] then print(&quot;Monday is not in set&quot;) end
}}}
!!Methods
[[set:concat]]
!!Metamethods
[[Set Class Relationships]]
[[Set Class Operators]]
[[Set Iteration]]
</pre>
</div>
<div title="Set Class Operators" creator="John Hind" modifier="John Hind" created="201312041633" modified="201312051737" changecount="3">
<pre>The addition and subtraction operators are overridden for Set Class objects.

Addition results in a new set which is the superset of the two sets added (contains all of the objects which are in either or both sets).

Subtraction results in a new set which contains the elements in the first set which are not also in the second set.
{{{
local printset = function(s) local t = &quot;&quot; for e in s do t = t..&quot;;&quot;.. e end print(t) end
local a = Set{['A'],['B']}
local b = Set{['B'],['C']}
printset(a + b)
printset(a - b)
}}}
</pre>
</div>
<div title="Set Class Relationships" creator="John Hind" modifier="John Hind" created="201005312106" modified="201402101003" changecount="3">
<pre>The relational operators ({{{==}}}, {{{~=}}}, {{{&gt;}}}, {{{&lt;}}}, {{{&gt;=}}}, {{{&lt;=}}}) are overloaded to express the subset relationship between objects of the [[Set Class]].
{{{
set1 = Set{[&quot;cat&quot;],[&quot;dog&quot;],[&quot;bear&quot;],[&quot;toad&quot;]}
set2 = Set{[&quot;cat&quot;],[&quot;bear&quot;]}
set3 = Set{[&quot;cat&quot;],[&quot;pig&quot;]}
print(tostring(set1 == set2)) -- false
print(tostring(set1 ~= set2)) -- true
print(tostring(set1 &gt; set2))  -- true (all elements of set2 are in set1)
print(tostring(set1 &gt; set3))  -- false (set3 has an element which is not in set1)
print(tostring(set2 &gt; set2))  -- false (a set is not a superset of itself)
print(tostring(set2 &gt;= set2)) -- true (a set is equal to itself)
}}}
</pre>
</div>
<div title="Set Iteration" creator="John Hind" modifier="John Hind" created="201312051257" modified="201402101000" changecount="2">
<pre>The Set Class assigns a custom self-iterator which produces the elements of the set in arbitrary order. For example:
{{{
local set = Set{[&quot;one&quot;],[&quot;two&quot;],[&quot;three&quot;]}
for elem in set do print(tostring(elem)) end
}}}
</pre>
</div>
<div title="Shell Library" creator="John Hind" modifier="John Hind" created="201006021947" modified="201404011356" changecount="5">
<pre>The Shell Library gives Lua scripting access broadly to the facilities exposed by the Windows Explorer. This includes full access to the shell namespace (including the file folder hierarchy) and to drive letters.
!!Functions
[[shell.powerstatus]]
[[shell.platform]]
[[shell.scandevices]]
[[shell.shutdown]]
!!Classes
[[Drive Class]]
[[Icon Class]]
[[ShellObject Class]]
</pre>
</div>
<div title="ShellObject Class" creator="John Hind" modifier="John Hind" created="201006051959" modified="201402061313" changecount="3">
<pre>!obj = shell.~ShellObject([spec])
Return a new ~ShellObject. Objects of the ~ShellObject Class represent a Windows Shell Namespace Object. The Shell Namespace is the hierarchy displayed in Windows Explorer and it comprises both the file system and also virtual objects such as printers and network locations.Creating a new ~ShellObject gets an entry point into the hierarchy and you can use this object to create parents and children from this point.

With no parameters, the ~ShellObject represents the Desktop. A string ''spec'' parameter is interpreted as a directory path. An object of [[Drive Class]] may be passed as ''spec'' in which case the object will represent the root directory for that drive. A numeric ''spec'' parameter is interpreted as a CSIDL code. These codes may be looked up in the CSIDL table. For example, to get a ~ShellObject for My Documents use:
{{{
obj = shell.ShellObject(CSIDL.PERSONAL)
print(obj:name('display'))
}}}
This function may return a ''nil'' object if a directory does not parse or an invalid CSIDL code is specified.
!!Methods
[[shellobject:name]] - Return the name of the object in several formats.
[[shellobject:icon]] - Return the icon of the object in several formats.
[[shellobject:attributes]] - Returns a Set characterising the object.
[[shellobject:browse]] - Present UI to select a child object.
[[shellobject:new]] - Create a new folder or shortcut or a new object based on a template.
[[shellobject:execute]] - Execute a shell verb against the object.
[[shellobject:fileoperation]] - Execute bulk move, copy or delete operations.
[[shellobject:parent]] - Move one or more levels up the object hierarchy.
[[shellobject:children]] - Iterates the children of the object.
[[shellobject:touch]] - Changes date stamps on the object.
!!Examples
[[ShellObject Examples]]
</pre>
</div>
<div title="ShellObject Examples" creator="John Hind" modifier="John Hind" created="201402061312" modified="201402091449" changecount="6">
<pre>!!Browse and Show Information
{{{
sh1 = shell.ShellObject(CSIDL.PERSONAL)
sh2 = sh1:browse(&quot;View Information&quot;, 'files', 'nocreatefolder')
if sh2 then
  as, nd, cr, ac, sz = sh2:attributes()
  print(sh2:name('display'))
  print(&quot;| Attributes: &quot; .. as:concat(&quot;+&quot;))
  if as.filesystem then
    print(&quot;|   Modified: &quot;, nd)
    print(&quot;|    Created: &quot;, cr)
    print(&quot;|   Accessed: &quot;, ac)
    if not as.folder then
      print(&quot;|  Size(kB): &quot;, sz)
    end
  end
  print(&quot;|     fullparsing: &quot;, sh2:name('fullparsing'))
  print(&quot;|       compacted: &quot;, sh2:name('compacted'))
  print(&quot;| relativeparsing: &quot;, sh2:name('relativeparsing'))
  print(&quot;|         editing: &quot;, sh2:name('editing'))
  print(&quot;|         display: &quot;, sh2:name('display'))
  print(&quot;|          normal: &quot;, sh2:name('normal'))
  print(&quot;|        filename: &quot;, sh2:name('filename'))
  print(&quot;|            type: &quot;, sh2:name('type'))
  print(&quot;|           drive: &quot;, sh2:name('drive'))
  print(&quot;|             url: &quot;, sh2:name('url'))
  print(&quot;|        typename: &quot;, sh2:name('typename'))
  print(&quot;| Icon: &quot;, sh2:icon() ~= nil)
 end
}}}
!!Parents and Children
{{{
sh1 = shell.ShellObject(CSIDL.PERSONAL)
sh2 = sh1:browse(&quot;View Information&quot;, 'nocreatefolder')
for sh1 in sh2:children() do
  print(&quot;Child: &quot;, sh1:name('display'))
end
while sh2 do
  sh2 = sh2:parent()
  if sh2 then
    print(&quot;Parent: &quot;, sh2:name('display'))
  else
    print(&quot;At Root&quot;)
  end
end
}}}
!!Shell Execute Properties Dialog
{{{
sh1 = shell.ShellObject(CSIDL.PERSONAL)
sh2 = sh1:browse(&quot;View Information&quot;, 'files', 'nocreatefolder')
sh2:execute(&quot;properties&quot;)
}}}
!!Create and Delete
{{{
sh1 = shell.ShellObject(CSIDL.PERSONAL)
sh2 = sh1:new('folder', &quot;Created By Winsh&quot;, 'noui')
if sh2 then
  print(&quot;Created new folder: &quot;, sh2:name('display'))
  sh2:touch(Time{hours=1}, 'created')
  print(sh2:attributes())
  print(sh2:fileoperation('delete'))
else
  print(&quot;The folder was not created&quot;)
end
}}}
</pre>
</div>
<div title="ShowPopup" modifier="John Hind" created="200609091431" modified="201103031616" tags="html BasicsPackage excludeSearch excludeLists excludeMissing">
<pre>/%
!info
|Name|ShowPopup|
|Source|http://www.TiddlyTools.com/#ShowPopup|
|Version|1.1.99|
|Author|Eric Shulman mod JH|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|transcluded html|
|Requires||
|Overrides||
|Description|display tiddler content in a TiddlyWiki popup panel|
Mod (JH):
&lt;&lt;&lt;
Pass the content tiddler to wikify() so context is available to macros within the content tiddler.
&lt;&lt;&lt;
Usage:
&lt;&lt;&lt;
{{{
&lt;&lt;tiddler ShowPopup with: TiddlerName label tooltip buttonClass width popupClass&gt;&gt;
}}}
*{{{TiddlerName}}} is the title of the tiddler whose content is to be displayed
*{{{label}}} is the text of the popup command
*{{{tooltip}}} is the mouseover help text for the command
*{{{buttonClass}}} is a CSS classname applied to the command text (default=button)
*{{{width}}} is the width of the popup (using CSS measurements, default=auto)
*{{{popupClass}}} is a CSS classname applied to the popup panel (default=none).  Use 'sticky' for persistent popups (requires  StickyPopupPlugin)
&lt;&lt;&lt;
Example:
&lt;&lt;&lt;
{{{
&lt;&lt;tiddler ShowPopup with: ShowPopup [[Try this]] [[show this tiddler in a popup]]&gt;&gt;
}}}
&lt;&lt;tiddler ShowPopup with: ShowPopup [[Try this]] [[show this tiddler in a popup]]&gt;&gt;
&lt;&lt;&lt;
!end

!show
&lt;html&gt;&lt;hide linebreaks&gt;
&lt;a href=&quot;javascript:;&quot; class=&quot;$4&quot; title=&quot;$3&quot; onclick=&quot;
	var p=Popup.create(this);if(!p)return;p.className+=' $6';var t=store.getTiddlerText('$1','');
	var d=createTiddlyElement(p,'div');var s=d.style;s.whiteSpace='normal';s.width='$5';s.padding='2px';wikify(t,d,null,store.getTiddler('$1'));
	Popup.show();event.cancelBubble=true;if(event.stopPropagation)event.stopPropagation();return(false);
&quot;&gt;$2&lt;/a&gt;&lt;/html&gt;
!end

%/&lt;&lt;tiddler {{'ShowPopup##'+('$1'=='$'+'1'?'info':'show')}} with: [[$1]] [[$2]] [[$3]] [[$4]] [[$5]] [[$6]]&gt;&gt;</pre>
</div>
<div title="Side-by-side Execution" creator="John Hind" modifier="John Hind" created="201005292130" modified="201410031002" changecount="8">
<pre>This is like [[Command-line Execution]] except that no command-line is required. Winsh will look for a folder or file with the same name as its own executable and in the same folder, but with the extension {{{.lua}}} rather than {{{.exe}}}. Note that the Winsh executable may be renamed to reflect the application, allowing more than one script application to exist in the same folder.

For example, assuming the following folder layout ({{{myapp.exe}}} being one of the [[Winsh Executables]] renamed):
{{{
C:\test\myapp.exe
C:\test\myapp.lua
}}}
Executing {{{myapp.exe}}} will load and run {{{myapp.lua}}}. Alternatively, with the following layout:
{{{
C:\test\myapp.exe
C:\test\myapp.lua\WinshLua.dll
C:\test\myapp.lua\start.lua
C:\test\myapp.lua\library1.dll
C:\test\myapp.lua\lib\library2.lua
}}}
Then executing {{{myapp.exe}}} will load and run {{{myapp.lua\start.lua}}} and that script may contain the following Lua statements:
{{{
lib1 = require(&quot;library1&quot;)
lib2 = require(&quot;lib.library2&quot;)
}}}
If a DLL library is used, as in this example, then {{{myapp.exe}}} must be copied from an executable that uses a Lua DLL, and {{{WinshLua.dll}}} must be present in the side-by-side folder (or it may be in the same folder as the executable file).
</pre>
</div>
<div title="SinglePageModePlugin" creator="ELSDesignStudios" modifier="John Hind" created="200508151715" modified="201102131623" tags="NavigationPackage systemConfig excludeLists excludeSearch excludeMissing" changecount="2">
<pre>/***
|Name|SinglePageModePlugin|
|Source|http://www.TiddlyTools.com/#SinglePageModePlugin|
|Documentation|http://www.TiddlyTools.com/#SinglePageModePluginInfo|
|Version|2.9.7|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Show tiddlers one at a time with automatic permalink, or always open tiddlers at top/bottom of page.|
This plugin allows you to configure TiddlyWiki to navigate more like a traditional multipage web site with only one tiddler displayed at a time.
!!!!!Documentation
&gt;see [[SinglePageModePluginInfo]]
!!!!!Configuration
&lt;&lt;&lt;
&lt;&lt;option chkSinglePageMode&gt;&gt; Display one tiddler at a time
&gt;&lt;&lt;option chkSinglePagePermalink&gt;&gt; Automatically permalink current tiddler
&gt;&lt;&lt;option chkSinglePageKeepFoldedTiddlers&gt;&gt; Don't close tiddlers that are folded
&gt;&lt;&lt;option chkSinglePageKeepEditedTiddlers&gt;&gt; Don't close tiddlers that are being edited
&lt;&lt;option chkTopOfPageMode&gt;&gt; Open tiddlers at the top of the page
&lt;&lt;option chkBottomOfPageMode&gt;&gt; Open tiddlers at the bottom of the page
&lt;&lt;option chkSinglePageAutoScroll&gt;&gt; Automatically scroll tiddler into view (if needed)

Notes:
* The &quot;display one tiddler at a time&quot; option can also be //temporarily// set/reset by including a 'paramifier' in the document URL: {{{#SPM:true}}} or {{{#SPM:false}}}.
* If more than one display mode is selected, 'one at a time' display takes precedence over both 'top' and 'bottom' settings, and if 'one at a time' setting is not used, 'top of page' takes precedence over 'bottom of page'.
* When using Apple's Safari browser, automatically setting the permalink causes an error and is disabled.
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2010.11.30 2.9.7 use story.getTiddler()
2008.10.17 2.9.6 changed chkSinglePageAutoScroll default to false
| Please see [[SinglePageModePluginInfo]] for previous revision details |
2005.08.15 1.0.0 Initial Release.  Support for BACK/FORWARD buttons adapted from code developed by Clint Checketts.
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.SinglePageModePlugin= {major: 2, minor: 9, revision: 7, date: new Date(2010,11,30)};
//}}}
//{{{
config.paramifiers.SPM = { onstart: function(v) {
	config.options.chkSinglePageMode=eval(v);
	if (config.options.chkSinglePageMode &amp;&amp; config.options.chkSinglePagePermalink &amp;&amp; !config.browser.isSafari) {
		config.lastURL = window.location.hash;
		if (!config.SPMTimer) config.SPMTimer=window.setInterval(function() {checkLastURL();},1000);
	}
} };
//}}}
//{{{
if (config.options.chkSinglePageMode==undefined)
	config.options.chkSinglePageMode=false;
if (config.options.chkSinglePagePermalink==undefined)
	config.options.chkSinglePagePermalink=true;
if (config.options.chkSinglePageKeepFoldedTiddlers==undefined)
	config.options.chkSinglePageKeepFoldedTiddlers=false;
if (config.options.chkSinglePageKeepEditedTiddlers==undefined)
	config.options.chkSinglePageKeepEditedTiddlers=false;
if (config.options.chkTopOfPageMode==undefined)
	config.options.chkTopOfPageMode=false;
if (config.options.chkBottomOfPageMode==undefined)
	config.options.chkBottomOfPageMode=false;
if (config.options.chkSinglePageAutoScroll==undefined)
	config.options.chkSinglePageAutoScroll=false;
//}}}
//{{{
config.SPMTimer = 0;
config.lastURL = window.location.hash;
function checkLastURL()
{
	if (!config.options.chkSinglePageMode)
		{ window.clearInterval(config.SPMTimer); config.SPMTimer=0; return; }
	if (config.lastURL == window.location.hash) return; // no change in hash
	var tids=decodeURIComponent(window.location.hash.substr(1)).readBracketedList();
	if (tids.length==1) // permalink (single tiddler in URL)
		story.displayTiddler(null,tids[0]);
	else { // restore permaview or default view
		config.lastURL = window.location.hash;
		if (!tids.length) tids=store.getTiddlerText(&quot;DefaultTiddlers&quot;).readBracketedList();
		story.closeAllTiddlers();
		story.displayTiddlers(null,tids);
	}
}


if (Story.prototype.SPM_coreDisplayTiddler==undefined)
	Story.prototype.SPM_coreDisplayTiddler=Story.prototype.displayTiddler;
Story.prototype.displayTiddler = function(srcElement,tiddler,template,animate,slowly)
{
	var title=(tiddler instanceof Tiddler)?tiddler.title:tiddler;
	var tiddlerElem=story.getTiddler(title); // ==null unless tiddler is already displayed
	var opt=config.options;
	var single=opt.chkSinglePageMode &amp;&amp; !startingUp;
	var top=opt.chkTopOfPageMode &amp;&amp; !startingUp;
	var bottom=opt.chkBottomOfPageMode &amp;&amp; !startingUp;
	if (single) {
		story.forEachTiddler(function(tid,elem) {
			// skip current tiddler and, optionally, tiddlers that are folded.
			if (	tid==title
				|| (opt.chkSinglePageKeepFoldedTiddlers &amp;&amp; elem.getAttribute(&quot;folded&quot;)==&quot;true&quot;))
				return;
			// if a tiddler is being edited, ask before closing
			if (elem.getAttribute(&quot;dirty&quot;)==&quot;true&quot;) {
				if (opt.chkSinglePageKeepEditedTiddlers) return;
				// if tiddler to be displayed is already shown, then leave active tiddler editor as is
				// (occurs when switching between view and edit modes)
				if (tiddlerElem) return;
				// otherwise, ask for permission
				var msg=&quot;'&quot;+tid+&quot;' is currently being edited.\n\n&quot;;
				msg+=&quot;Press OK to save and close this tiddler\nor press Cancel to leave it opened&quot;;
				if (!confirm(msg)) return; else story.saveTiddler(tid);
			}
			story.closeTiddler(tid);
		});
	}
	else if (top)
		arguments[0]=null;
	else if (bottom)
		arguments[0]=&quot;bottom&quot;;
	if (single &amp;&amp; opt.chkSinglePagePermalink &amp;&amp; !config.browser.isSafari) {
		window.location.hash = encodeURIComponent(String.encodeTiddlyLink(title));
		config.lastURL = window.location.hash;
		document.title = wikifyPlain(&quot;SiteTitle&quot;) + &quot; - &quot; + title;
		if (!config.SPMTimer) config.SPMTimer=window.setInterval(function() {checkLastURL();},1000);
	}
	if (tiddlerElem &amp;&amp; tiddlerElem.getAttribute(&quot;dirty&quot;)==&quot;true&quot;) { // editing... move tiddler without re-rendering
		var isTopTiddler=(tiddlerElem.previousSibling==null);
		if (!isTopTiddler &amp;&amp; (single || top))
			tiddlerElem.parentNode.insertBefore(tiddlerElem,tiddlerElem.parentNode.firstChild);
		else if (bottom)
			tiddlerElem.parentNode.insertBefore(tiddlerElem,null);
		else this.SPM_coreDisplayTiddler.apply(this,arguments); // let CORE render tiddler
	} else
		this.SPM_coreDisplayTiddler.apply(this,arguments); // let CORE render tiddler
	var tiddlerElem=story.getTiddler(title);
	if (tiddlerElem&amp;&amp;opt.chkSinglePageAutoScroll) {
		// scroll to top of page or top of tiddler
		var isTopTiddler=(tiddlerElem.previousSibling==null);
		var yPos=isTopTiddler?0:ensureVisible(tiddlerElem);
		// if animating, defer scroll until after animation completes
		var delay=opt.chkAnimate?config.animDuration+10:0;
		setTimeout(&quot;window.scrollTo(0,&quot;+yPos+&quot;)&quot;,delay);
	}
}

if (Story.prototype.SPM_coreDisplayTiddlers==undefined)
	Story.prototype.SPM_coreDisplayTiddlers=Story.prototype.displayTiddlers;
Story.prototype.displayTiddlers = function() {
	// suspend single/top/bottom modes when showing multiple tiddlers
	var opt=config.options;
	var saveSPM=opt.chkSinglePageMode; opt.chkSinglePageMode=false;
	var saveTPM=opt.chkTopOfPageMode; opt.chkTopOfPageMode=false;
	var saveBPM=opt.chkBottomOfPageMode; opt.chkBottomOfPageMode=false;
	this.SPM_coreDisplayTiddlers.apply(this,arguments);
	opt.chkBottomOfPageMode=saveBPM;
	opt.chkTopOfPageMode=saveTPM;
	opt.chkSinglePageMode=saveSPM;
}
//}}}</pre>
</div>
<div title="SiteCredit" creator="John Hind" modifier="John Hind" created="201211152206" modified="201211152206" changecount="2">
<pre>//by John Hind//</pre>
</div>
<div title="SiteSubtitle" creator="John Hind" modifier="John Hind" created="201211152204" modified="201402211436" changecount="4">
<pre>//Windows shell scripting with the Lua language//</pre>
</div>
<div title="SiteThumb" creator="John Hind" modifier="John Hind" created="201102201132" modified="201103011128" tags="excludeLists excludeMissing excludeSearch">
<pre>&lt;script&gt;
  togglesb=function(tog){
    var co=config.options;
    if (co.chkShowLeftSidebar=='undefined') co.chkShowLeftSidebar=true;
    if (tog) co.chkShowLeftSidebar=!co.chkShowLeftSidebar;
    var mm=document.getElementById('mainMenu');
    if (!mm) return;
    mm.style.display=co.chkShowLeftSidebar?'block':'none';
    document.getElementById('displayArea').style.marginLeft =
      co.chkShowLeftSidebar?'':'0.6em';
    document.getElementById('thumb').style.left=co.chkShowLeftSidebar?'':'0.2em';
    var place=document.getElementById('sitethumbsb');
    place.innerHTML=co.chkShowLeftSidebar?&quot;&amp;#x25C4;&quot;:&quot;&amp;#x25BA;&quot;;
  }
  tiddlertop=function(){
    var wb = window.pageYOffset;
    var foc;
    story.forEachTiddler(function(title,element){
      if (element.offsetTop&lt;wb)foc=element;
    });
    if (foc) window.scrollTo(0,foc.offsetTop);
  }
&lt;/script&gt;/%
%/&lt;html&gt;&lt;a href=&quot;javascript:window.scrollTo(0,0)&quot; title=&quot;scroll to top of page&quot;&gt;&amp;#x25b2;&lt;/a&gt;&lt;br&gt;&lt;a href=&quot;javascript:tiddlertop()&quot; title=&quot;scroll to tiddler heading&quot;&gt;&amp;#x25ed;&lt;/a&gt;&lt;br&gt;&lt;a id=&quot;sitethumbsb&quot; href=&quot;javascript:togglesb(true)&quot; title=&quot;show/hide document index&quot;&gt;&amp;#x25C4;&lt;/a&gt;&lt;/html&gt;&lt;script&gt;togglesb(false);&lt;/script&gt;</pre>
</div>
<div title="SiteTitle" creator="John Hind" modifier="John Hind" created="201211152203" modified="201402211436" changecount="2">
<pre>Winsh.lua</pre>
</div>
<div title="StoryMenu" modifier="John Hind" created="200607201633" modified="201103011105" tags="BasicsPackage menu excludeSearch excludeLists excludeMissing">
<pre>&lt;&lt;alias author &quot;&lt;script&gt;return author();&lt;/script&gt;&quot;&gt;&gt;/%
%/{{hidden{&lt;&lt;tiddler AliasList&gt;&gt;}}}/%
%/{{center{&lt;&lt;tiddler StoryMenu##readonly if:{{readOnly}}&gt;&gt;&lt;&lt;tiddler StoryMenu##readwrite if:{{!readOnly}}&gt;&gt;}}}/%
!readonly
{{menubar{&lt;&lt;tiddler ShowPopup with:[[StoryMenu##story]] &quot;story&quot; &quot;list tiddlers in story&quot; &quot;button&quot;&gt;&gt;&lt;&lt;closeAll&gt;&gt;&lt;&lt;permaview&gt;&gt;}}}
!readwrite
{{menubar{&lt;&lt;tiddler ShowPopup with:[[StoryMenu##story]] &quot;story&quot; &quot;list tiddlers in story&quot; &quot;button&quot;&gt;&gt;&lt;&lt;tiddler ShowPopup with:[[NewTiddlerMenu]] &quot;new&quot; &quot;create a new tiddler&quot; &quot;button&quot;&gt;&gt;&lt;&lt;tiddler ShowPopup with:[[StoryMenu##changes]] &quot;changes&quot; &quot;show recent changes&quot; &quot;button&quot; 60em sticky&gt;&gt;&lt;&lt;saveChanges &quot;save&quot; &quot;Save all unsaved changes to the file&quot;&gt;&gt;&lt;&lt;closeAll&gt;&gt;&lt;&lt;expandAll&gt;&gt;&lt;&lt;permaview&gt;&gt;}}}
{{warningbar{&lt;&lt;unsavedChanges panel&gt;&gt;}}}
!changes
{{smallform{&lt;&lt;recentChanges 30 noExclude&gt;&gt;}}}
!story
&lt;&lt;list story&gt;&gt;
!end
%/</pre>
</div>
<div title="String Table Resources" creator="John Hind" modifier="John Hind" created="201005292303" modified="201402211518" changecount="7">
<pre>You can edit certain string resources to customise Winsh or to lock down certain actions like processing command lines or loading external script files. For example you can change the default extension used for script files from ''.lua'' to something else.
;9-128
:Short-form application name (default '''WINSH.LUA''').
;9-129
:Default command-mode prompt (default '''&gt;''') may be overridden in scripting by setting a global string variable {{{_PROMPT}}}.
;9-130
:Extension for external Lua script files (default '''lua''').
;9-131
:Name for the start script resource or side-by-side folder start file (default '''START''')
;9-132
:Type name for script resources (default '''LUA''').
;9-133
:A GUID string used to define application uniqueness for some features (notably [[winsh.mutex]]). It is not normally necessary to change this as long as you give your application a unique executable file name, but it may be useful in some exotic cases.
;9-134
:Default name to appear in window titlebars. This may be overwritten using [[winsh.setidentity]]. (default '''Winsh.lua scripting system for Windows''').
;9-135
:Setting this to '''True''' stops Winsh from loading script files or resources specified on the command line so the start script must either be in a resource or in a side-by-side file.
;9-136
:Setting this to '''True''' stops Winsh from loading scripts from external files so the start script must be in a resource.
;9-137
:Setting this to '''True''' stops Winsh from loading side-by-side scripts so the start script must either be specified on the command line or in a resource.
</pre>
</div>
<div title="StyleSheet" modifier="John Hind" created="200903111603" modified="201103031139" tags="setup stylesheet excludeSearch excludeLists excludeMissing">
<pre>/*{{{*/
/* SHORTCUTS */
[[StyleSheetShortcuts]]

/* CUSTOM SHORTCUTS */
.scroll	{ display:block; overflow:auto; width:auto; max-height:8em; padding-bottom:.5em; }
.scroll ul	{ margin:0; }
.scroll li	{ white-space:nowrap; }
*[id=&quot;mainMenu&quot;] .scroll li  /* MOZ ONLY */	{ margin-left:-2em; }

/* ADJUSTMENTS TO STANDARD ELEMENTS */
.viewer hr
        { border:0;border-top:1px solid [[ColorPalette::TertiaryLight]];color:[[ColorPalette::TertiaryLight]] }
.header
	{ padding-top:0.5em;padding-bottom:0.5em;white-space:nowrap;color:[[ColorPalette::Background]] }
.siteTitle
        { padding-left:0.5em;padding-right:0.2em;font-size:28pt; }
.siteSubtitle
        { vertical-align:100%; }
.title
        { font-size:18pt; }
#mainMenu
	{ text-align:left; width:14em; padding:0.5em; }
#mainMenu table, #mainMenu table td
	{ border:1px solid [[ColorPalette::TertiaryMid]]; border-collapse:collapse; padding:.3em; }
#displayArea
	{ margin-left:16.4em; margin-right:0em; }
#messageArea
        { position:fixed; top:1em; right:1em; _position:absolute;}

.popup
	{ max-height:40em; overflow:auto; -moz-border-radius:.5em; -webkit-border-radius:.5em; padding:.5em; }
.popup ul
        { list-style-type:none;padding:0px;margin:0px; }
.popup li
	{ white-space:nowrap;line-height:100%;padding-left:0px; }
.toolbar
	{ float:right;white-space:nowrap;position:relative;background-color:[[ColorPalette::Background]]; }
.viewer
	{ border:1px solid [[ColorPalette::TertiaryLight]]; -moz-border-radius:.5em; -webkit-border-radius:.5em; padding:.5em; }
.tiddler .subtitle
	{ display:inline; }
.tagged
	{ border:1px solid [[ColorPalette::TertiaryMid]]; -moz-border-radius:3px; -webkit-border-radius:3px; }
.tagged
	{ opacity:.7; }
.selected .tagged
	{ opacity:1; }
.button, .tiddler .button, #sidebarTabs .button
	{ margin:0px; padding: 0px .3em; border:1px solid transparent;
		-moz-border-radius:3px; -webkit-border-radius:3px; }
.button:hover
	{ border:1px solid [[ColorPalette::TertiaryMid]]; }
#sidebarTabs .button
	{ margin:0px 0.2em; padding:0.2em 0.3em; border:1px solid transparent;
		-moz-border-radius:3px; -webkit-border-radius:3px; display:block; }
#sidebarTabs .button:hover
	{ border:1px solid [[ColorPalette::TertiaryMid]]; }
.editor textarea
	{ font-family:monospace; }
.tab
	{	padding-bottom:1px;
		-moz-border-radius-topleft:.5em;
		-moz-border-radius-topright:.5em;
		-webkit-border-top-left-radius:.5em;
		-webkit-border-top-right-radius:.5em;
	}
.tabContents
	{ -moz-border-radius:.5em; -webkit-border-radius:.5em; }
.tabContents, .tabSelected
	{ background-color:[[ColorPalette::TertiaryPale]]; }
.tabContents blockquote
        { margin:0;margin-left:0.1em;padding-left:0.2em;border-left:solid [[ColorPalette::PrimaryPale]]; }
.tabContents .button
        { padding:0; }
.tabUnselected
	{ background-color:[[ColorPalette::TertiaryDark]]; }
ol, ol ol, ol ol ol, ol ol ol ol, ol ol ol ol ol, ol ol ol ol ol ol
        { list-style-type:decimal; }

/* CUSTOM ELEMENTS */
.siteCredit
  { position:absolute;right:1.4em;bottom:0.7em;width:auto;font-size:120%;text-align:right;color:[[ColorPalette::Background]]; }
.menubar { }
.menubar .button, .menubar .tiddlyLinkExisting, .menubar .tiddlyLinkNonExisting
  { color:[[ColorPalette::TertiaryMid]]; font-weight:bold}
.warningbar { }
.warningbar .button, .warningbar .tiddlyLinkExisting, .warningbar .tiddlyLinkNonExisting
  { color:[[ColorPalette::Error]]; font-weight:bold}
.viewHeading ,.viewHeadingC
        { height:2.5em;vertical-align:center;white-space:nowrap; }
.viewHeadingC
        { border-bottom-style:solid;border-width:1px;border-color:[[ColorPalette::TertiaryLight]]; }
#thumb
        { position:fixed;top:6.5em;left:16.1em;cursor:pointer;font-size:9pt;border-style:solid;border-left-width:1px;border-right-width:1px;border-top-width:4px;border-bottom-width:4px;border-color:[[ColorPalette::TertiaryLight]]; }

.groupbox
	{ display:block; padding:1em; -moz-border-radius:1em;-webkit-border-radius:1em; border:1px solid; background:[[ColorPalette::Background]]; color:[[ColorPalette::Foreground]]; }
.groupbox
        { padding:.5em; border:1px solid [[ColorPalette::TertiaryMid]]; -moz-border-radius:.5em; -webkit-border-radius:.5em; }

/* JH - Not sure what this is for or why it is marked !important, but it wrecks tab text contrast on options tab.
.groupbox a, .groupbox .button, .groupbox .tiddlyLinkExisting, .groupbox .tiddlyLinkNonExisting
	{ color:#009 !important; }
.groupbox code
	{ color:#333 !important; }
*/
.groupbox .button
	{ color:[[ColorPalette::PrimaryMid]];font-weight:bold; }

*/============*/

/* rollover highlighting */
.mouseover
	{color:[[ColorPalette::TertiaryLight]] !important;}
.mouseover a
	{color:[[ColorPalette::TertiaryLight]] !important;}
.selected .mouseover
	{color:[[ColorPalette::Background]] !important;}
.selected .mouseover .button, .selected .mouseover a
	{color:[[ColorPalette::Background]] !important;}

/*}}}*/</pre>
</div>
<div title="StyleSheetShortcuts" modifier="John Hind" created="200611070646" modified="201102242121" tags="BasicsPackage stylesheet excludeSearch excludeLists excludeMissing">
<pre>/***
|Name|StyleSheetShortcuts|
|Source|http://www.TiddlyTools.com/#StyleSheetShortcuts|
|Author|Eric Shulman - ELS Design Studios (modified by John Hind)|
|License|http://www.TiddlyTools.com/#LegalStatements &lt;br&gt;and [[Creative Commons Attribution-ShareAlike 2.5 License|http://creativecommons.org/licenses/by-sa/2.5/]]|
|~CoreVersion|2.1|
|Type|CSS|
|Description|'convenience' classes for common formatting, alignment, boxes, tables, etc.|

These 'style tweaks' can be easily included in other stylesheet tiddler so they can share a baseline look-and-feel that can then be customized to create a wide variety of 'flavors'.
***/
/*{{{*/

/* Colors from the ColorPalette shadow tiddler should be used for most element colors as this tiddler
   can be shadowed to change the overall look. The comments below describe the colors provided by the
   built-in default ColorPalette tiddler.
*/

/* [[ColorPalette]] text colors */
.Background	{ color:[[ColorPalette::Background]];	 } /* #fff White */
.Foreground	{ color:[[ColorPalette::Foreground]];	 } /* #000 Black*/
.PrimaryPale	{ color:[[ColorPalette::PrimaryPale]];	 } /* #8cf Pale Blue */
.PrimaryLight	{ color:[[ColorPalette::PrimaryLight]];	 } /* #18f Light Blue */
.PrimaryMid	{ color:[[ColorPalette::PrimaryMid]];	 } /* #04b Mid Blue */
.PrimaryDark	{ color:[[ColorPalette::PrimaryDark]];	 } /* #014 Dark Blue */
.SecondaryPale	{ color:[[ColorPalette::SecondaryPale]]; } /* #ffc Pale Yellow */
.SecondaryLight	{ color:[[ColorPalette::SecondaryLight]];} /* #fe8 Light Gold */
.SecondaryMid	{ color:[[ColorPalette::SecondaryMid]];	 } /* #db4 Dark Gold */
.SecondaryDark	{ color:[[ColorPalette::SecondaryDark]]; } /* #841 Brown */
.TertiaryPale	{ color:[[ColorPalette::TertiaryPale]];	 } /* #eee Pale Grey */
.TertiaryLight	{ color:[[ColorPalette::TertiaryLight]]; } /* #ccc Light Grey */
.TertiaryMid	{ color:[[ColorPalette::TertiaryMid]];	 } /* #999 Mid Grey */
.TertiaryDark	{ color:[[ColorPalette::TertiaryDark]];	 } /* #666 Dark Grey */
.Error		{ color:[[ColorPalette::Error]];	 } /* #f88 Pink */

/* [[ColorPalette]] background colors */
.BGBackground	  { background-color:[[ColorPalette::Background]];	}
.BGForeground	  { background-color:[[ColorPalette::Foreground]];	}
.BGPrimaryPale	  { background-color:[[ColorPalette::PrimaryPale]];	}
.BGPrimaryLight	  { background-color:[[ColorPalette::PrimaryLight]];	}
.BGPrimaryMid	  { background-color:[[ColorPalette::PrimaryMid]];	}
.BGPrimaryDark	  { background-color:[[ColorPalette::PrimaryDark]];	}
.BGSecondaryPale  { background-color:[[ColorPalette::SecondaryPale]]; 	}
.BGSecondaryLight { background-color:[[ColorPalette::SecondaryLight]];	}
.BGSecondaryMid	  { background-color:[[ColorPalette::SecondaryMid]];	}
.BGSecondaryDark  { background-color:[[ColorPalette::SecondaryDark]]; 	}
.BGTertiaryPale	  { background-color:[[ColorPalette::TertiaryPale]];	}
.BGTertiaryLight  { background-color:[[ColorPalette::TertiaryLight]]; 	}
.BGTertiaryMid	  { background-color:[[ColorPalette::TertiaryMid]];	}
.BGTertiaryDark	  { background-color:[[ColorPalette::TertiaryDark]];	}
.BGError	  { background-color:[[ColorPalette::Error]];	 	}

/* Fixed text colors */
.white { color:#fff !important }
.gray  { color:#999 !important }
.black { color:#000 !important }
.red   { color:#f66 !important }
.green { color:#0c0 !important }
.blue  { color:#99f !important }

/* Heading Styles in CSS Class form */
.H1 {font-size:1.35em;}
.H2 {font-size:1.25em;}
.H3 {font-size:1.1em;}
.H4 {font-size:1em;}
.H5 {font-size:0.9em;}
.H6 {font-size:0.7em;}
.H1,.H2,.H3,.H4,.H5,.H6 {color:[[ColorPalette::SecondaryDark]]; background:transparent; font-weight:bolder; text-decoration:none; display:block; page-break-after:avoid;}
.H1,.H2,.H3 {padding-bottom:1px; margin-top:1.2em; margin-bottom:-0.7em;}
.H4,.H5,.H6 {margin-top:1em;}
.H1 {border-bottom:2px solid [[ColorPalette::TertiaryLight]]; page-break-before:always;}
.H2,.H3 {border-bottom:1px solid [[ColorPalette::TertiaryLight]];}

/* text alignments */
.left
	{ display:block;text-align:left; }
.center
	{ display:block;text-align:center; }
.center table
	{ margin:auto !important; }
.right
	{ display:block;text-align:right; }
.justify
	{ display:block;text-align:justify; }
.indent
	{ display:block;margin:0;padding:0;border:0;margin-left:2em; }
.floatleft
	{ float:left; }
.floatright
	{ float:right; }
.valignTop, .valignTop table, .valignTop tbody, .valignTop th, .valignTop tr, .valignTop td
	{ vertical-align:top; }
.valignBottom, .valignBottom table, .valignBottom tbody, .valignBottom th, .valignBottom tr, .valignBottom td
	{ vertical-align:bottom; }
.clear
	{ clear:both; }
.wrap
	{ white-space:normal; }
.nowrap
	{ white-space:nowrap; }
.hidden
	{ display:none; }
.show
	{ display:inline !important; }
.span
	{ display:span; }
.block
	{ display:block; }
.relative
	{ position:relative; }
.absolute
	{ position:absolute; }

/* font sizes */
.big
	{ font-size:14pt;line-height:120% }
.medium
	{ font-size:12pt;line-height:120% }
.normal
	{ font-size:9pt;line-height:120% }
.small
	{ font-size:8pt;line-height:120% }
.fine
	{ font-size:7pt;line-height:120%; }
.tiny
	{ font-size:6pt;line-height:120%; }
.larger
	{ font-size:120%; }
.smaller
	{ font-size:80%; }

/* blocks */
.fineblock
        { display:block;font-size:7pt;line-height:120%;margin-top:2px; }

/* font styles */
.bold
	{ font-weight:bold; }
.italic
	{ font-style:italic; }
.underline
	{ text-decoration:underline; }

/* plain list items (no bullets or indent) */
.nobullets li { list-style-type: none; margin-left:-2em; }

/* multi-column tiddler content (not supported in Internet Explorer) */
.twocolumns { display:block;
	-moz-column-count:2; -moz-column-gap:1em; -moz-column-width:50%; /* FireFox */
	-webkit-column-count:2; -webkit-column-gap:1em; -webkit-column-width:50%; /* Safari */
	column-count:2; column-gap:1em; column-width:50%; /* Opera */
}
.threecolumns { display:block;
	-moz-column-count:3; -moz-column-gap:1em; -moz-column-width:33%; /* FireFox */
	-webkit-column-count:3; -webkit-column-gap:1em; -webkit-column-width:33%; /* Safari */
	column-count:3; column-gap:1em; column-width:33%; /* Opera */
}
.fourcolumns { display:block;
	-moz-column-count:4; -moz-column-gap:1em; -moz-column-width:25%; /* FireFox */
	-webkit-column-count:4; -webkit-column-gap:1em; -webkit-column-width:25%; /* Safari */
	column-count:4; column-gap:1em; column-width:25%; /* Opera */
}

/* show/hide browser-specific content for InternetExplorer vs. non-IE (&quot;moz&quot;) browsers */
*[class=&quot;ieOnly&quot;]
	{ display:none; } /* hide in moz (uses CSS selector) */
* html .mozOnly, *:first-child+html .mozOnly
	{ display: none; } /* hide in IE (uses IE6/IE7 CSS hacks) */

/* borderless tables */
.borderless, .borderless table, .borderless td, .borderless tr, .borderless th, .borderless tbody
	{ border:0 !important; margin:0 !important; padding:0 !important; }
.widetable, .widetable table
	{ width:100%; }

/* thumbnail images (fixed-sized scaled images) */
.thumbnail img { height:5em !important; }

/* stretchable images (auto-size to fit tiddler) */
.stretch img { width:95%; }

/* grouped content */
.outline
	{ display:block; padding:1em; -moz-border-radius:1em;-webkit-border-radius:1em; border:1px solid; }
.menubox
	{ display:block; padding:1em; -moz-border-radius:1em;-webkit-border-radius:1em; border:1px solid; background:#fff; color:#000; }
.menubox .button, .menubox .tiddlyLinkExisting, .menubox .tiddlyLinkNonExisting
	{ color:#009 !important; }

.borderleft
	{ margin:0;padding:0;border:0;margin-left:1em; border-left:1px dotted; padding-left:.5em; }
.borderright
	{ margin:0;padding:0;border:0;margin-right:1em; border-right:1px dotted; padding-right:.5em; }
.borderbottom
	{ margin:0;padding:1px 0;border:0;border-bottom:1px dotted; margin-bottom:1px; padding-bottom:1px; }
.bordertop
	{ margin:0;padding:0;border:0;border-top:1px dotted; margin-top:1px; padding-top:1px; }

/* scrolled content */
.scrollbars { overflow:auto; }
.height10em { height:10em; }
.height15em { height:15em; }
.height20em { height:20em; }
.height25em { height:25em; }
.height30em { height:30em; }
.height35em { height:35em; }
.height40em { height:40em; }

/* compact form */
.smallform
	{ white-space:nowrap; }
.smallform input, .smallform textarea, .smallform button, .smallform checkbox, .smallform radio, .smallform select
	{ font-size:8pt; }

/* stretchable edit fields and textareas (auto-size to fit tiddler) */
.stretch input { width:99%; }
.stretch textarea { width:99%; }

/* compact input fields (limited to a few characters for entering percentages and other small values) */
.onechar input   { width:1em; }
.twochar input   { width:2em; }
.threechar input { width:3em; }
.fourchar input  { width:4em; }
.fivechar input  { width:5em; }

/* rollover zoom text */
.zoomover
	{ font-size:80% !important; }
.selected .zoomover
	{ font-size:100% !important; }

/*}}}*/</pre>
</div>
<div title="SystemSettings" creator="John Hind" modifier="John Hind" created="201102031653" modified="201102242128" tags="settings excludeLists excludeSearch excludeMissing">
<pre>chkAutoSave: false
chkBottomOfPageMode: false
chkSaveBackups: true
chkSinglePageAutoScroll: true
chkSinglePageKeepEditedTiddlers: true
chkSinglePageKeepFoldedTiddlers: false
chkSinglePageMode: false
chkSinglePagePermalink: true
chkTopOfPageMode: true
txtChangeHorizon:
txtBackupFolder: backups
txtUserName: John%20Hind
</pre>
</div>
<div title="TabContents" creator="John Hind" modifier="John Hind" created="201102221506" modified="201410112057" changecount="48">
<pre>[[Introduction]]
[[Lua]]
+++[Programming&lt;br&gt;]&gt;
[[Interactive Console]]
[[Command-line Execution]]
[[Side-by-side Execution]]
[[Embedded Execution]]
[[Procedural Applications]]
[[Resident Applications]]
===
+++[Class Library&lt;br&gt;]&gt;
[[Class Library]]
[[Table Class]]
[[List Class]]
[[Set Class]]
[[DelegateList Class]]
[[Creating Classes]]
===
+++[Bitfield Library&lt;br&gt;]&gt;
[[Bitfield Library]]
[[Bitfield Class]]
[[bitrange function]]
===
+++[Winsh Library&lt;br&gt;]&gt;
[[Winsh Library]]
[[Command Class]]
[[Menu Class]]
===
+++[Time Library&lt;br&gt;]&gt;
[[Time Class]]
===
+++[Timer Library&lt;br&gt;]&gt;
[[Timer Class]]
===
+++[Task Library&lt;br&gt;]&gt;
[[Task Library]]
[[Frame Class]]
[[Application Class]]
===
+++[Shell Library&lt;br&gt;]&gt;
[[Shell Library]]
[[Drive Class]]
[[Icon Class]]
[[ShellObject Class]]
===
+++[ComLink Library&lt;br&gt;]&gt;
[[ComLink Library]]
[[com.Port Class]]
===
+++[Registry Library&lt;br&gt;]&gt;
[[RegistryKey Class]]
===
+++[+FtdiLink Library&lt;br&gt;]&gt;
[[FtdiLink Library]]
[[ftdi.Port Class]]
===
</pre>
</div>
<div title="Table Class" creator="John Hind" modifier="John Hind" created="201005312023" modified="201401301210" changecount="11">
<pre>!table = Table([table])
Create a new object of Table class or convert a Lua table to a Table object. With no parameter, a new, empty Table object is created. With a table parameter having no metatable, that Lua table is converted in place to a Table object. Lua syntax allows this constructor-like statement to create and initialise a new Table object:
{{{
local t = Table{family=&quot;Smith&quot;; given=&quot;John&quot;}
for k,v in t do print(k .. &quot; = &quot; .. v) end
}}}
!!Methods
[[table:count]] - Count the number of entries in the table.
[[table:invert]] - Create a new table with keys and values transposed.
[[table:merge]] - Merge the contents of a second table.

The following Lua basic functions are also exposed as methods of the Table object: ''pairs'', ''rawget'', ''rawset''.
!!Metamethods
''Table Iteration'' - Self-iteration uses {{{pairs}}} (example above).
</pre>
</div>
<div title="Task Library" creator="John Hind" modifier="John Hind" created="201006021852" modified="201402211730" changecount="7">
<pre>The Task Library gives Lua scripting access broadly to the facilities exposed by the Windows Task Manager. It allows you to start and control other applications including arranging their windows on the desktop, to list applications and tasks already running and to stop them.
!!Functions
[[task.applications]]
[[task.application]]
[[task.monitors]]
[[task.virtualscreen]]
[[task.getclipboard]]
[[task.setclipboard]]
!!Classes
[[Frame Class]]
[[Application Class]]
!!Events
[[WM.CLIPBOARDUPDATE Event]]
</pre>
</div>
<div title="TextAreaPlugin" modifier="ELSDesignStudios" created="200512242341" modified="200904082149" tags="systemConfig TidIDEPackage InputPackage BasicsPackage excludeSearch excludeLists excludeMissing" changecount="2">
<pre>/***
|Name|TextAreaPlugin|
|Source|http://www.TiddlyTools.com/#TextAreaPlugin|
|Documentation|http://www.TiddlyTools.com/#TextAreaPluginInfo|
|Version|2.2.1|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Requires||
|Overrides|Story.prototype.focusTiddler|
|Options|##Configuration|
|Description|Adds Find/Again keyboard search, autosize, and 'stretch bar' resize for textarea controls|
!!!!!Documentation
&gt;see [[TextAreaPluginInfo]]
!!!!!Configuration
&lt;&lt;&lt;
&lt;&lt;option chkTextAreaExtensions&gt;&gt; use control-f (find), control-g (find again) inside text area
&lt;&lt;option chkDisableAutoSelect&gt;&gt; place cursor at start of textarea instead of pre-selecting content
&lt;&lt;option chkResizeEditor&gt;&gt; modify shadow EditTemplate to add resizeable text area (and autosize command)
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2009.04.08 [2.2.1] added autosizeEditor macro to enable automatic autosizing without using toolbar command
2009.04.06 [2.2.0] added resizeListbox macro definition and adjusted dragbar width calculation.
|please see [[TextAreaPluginInfo]] for additional revision details|
2006.01.22 [1.0.0] Moved from temporary &quot;System Tweaks&quot; tiddler into 'real' TextAreaPlugin tiddler.
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.TextAreaPlugin= {major: 2, minor: 2, revision: 1, date: new Date(2009,4,8)};

if (config.options.chkTextAreaExtensions===undefined) config.options.chkTextAreaExtensions=true;
if (config.options.chkDisableAutoSelect===undefined) config.options.chkDisableAutoSelect=true;
if (config.options.chkResizeEditor===undefined) config.options.chkResizeEditor=true;

// automatically tweak shadow EditTemplate to add &quot;autosizeEditor&quot; toolbar command
if (config.options.chkResizeEditor)
	config.shadowTiddlers.EditTemplate=config.shadowTiddlers.EditTemplate.replace(/deleteTiddler/,&quot;deleteTiddler autosizeEditor&quot;);
// automatically tweak shadow EditTemplate to add &quot;resizeEditor&quot; macro
if (config.options.chkResizeEditor)
	config.shadowTiddlers.EditTemplate+=&quot;&lt;span macro='resizeEditor'&gt;&lt;/span&gt;&quot;;

// Put focus in a specified tiddler field
Story.prototype.TextAreaExtensions_focusTiddler=Story.prototype.focusTiddler;
Story.prototype.focusTiddler = function(title,field)
{
	this.TextAreaExtensions_focusTiddler.apply(this,arguments); // first call core
	var e = this.getTiddlerField(title,field);
	if (e &amp;&amp; config.options.chkDisableAutoSelect) {
		if (e.setSelectionRange) // FF
			e.setSelectionRange(0,0);
		else if (e.createTextRange) // IE
			{ var r=e.createTextRange(); r.collapse(true); r.select(); }
	}
	if (e &amp;&amp; config.options.chkTextAreaExtensions) addKeyDownHandlers(e);
}
//}}}

//{{{
function addKeyDownHandlers(e)
{
	// exit if not textarea or element doesn't allow selections
	if (e.tagName.toLowerCase()!=&quot;textarea&quot;||!e.setSelectionRange||e.initialized) return;

	// utility function: exits keydown handler and prevents browser from processing the keystroke
	var processed=function(ev) {
		ev.cancelBubble=true; // IE4+
		try{event.keyCode=0;}catch(e){}; // IE5
		if (window.event) ev.returnValue=false; // IE6
		if (ev.preventDefault) ev.preventDefault(); // moz/opera/konqueror
		if (ev.stopPropagation) ev.stopPropagation(); // all
		return false;
	}
	// capture keydown in edit field
	e.saved_onkeydown=e.onkeydown; // save current keydown handler (if any)
	e.onkeydown=function(ev) { if (!ev) var ev=window.event;
		var key=ev.keyCode;
		if (!key) {
			var char=event.which?event.which:event.charCode;
			if (char==102) key=70;
			if (char==103) key=71;
		}
		// process CTRL-F (find matching text) or CTRL-G (find next match)
		if (ev.ctrlKey &amp;&amp; (key==70||key==71)) {

			// prompt for text to find
			var defFind=e.findText?e.findText:e.value.substring(e.selectionStart,e.selectionEnd);
			if (key==70||!e.findText||!e.findText.length) // ctrl-f or no saved search text
				{ var f=prompt(&quot;find:&quot;, defFind); e.focus(); if (f) e.findText=f; }
			if (!e.findText||!e.findText.length) return processed(ev); //  if no search text, exit

			// do case-insensitive match with 'wraparound'...  if not found, alert and exit
			var newstart=e.value.toLowerCase().indexOf(e.findText.toLowerCase(),e.selectionStart+1);
			if (newstart==-1) newstart=e.value.toLowerCase().indexOf(e.findText.toLowerCase());
			if (newstart==-1) { alert(&quot;'&quot;+e.findText+&quot;' not found&quot;); e.focus(); return processed(ev); }

			// set new selection, scroll it into view, and report line position in status bar
			e.setSelectionRange(newstart,newstart+e.findText.length);
			var linecount=e.value.split('\n').length;
			var thisline=e.value.substr(0,e.selectionStart).split('\n').length;
			e.scrollTop=Math.floor((thisline-1-e.rows/2)*e.scrollHeight/linecount);
			window.status=&quot;line: &quot;+thisline+&quot;/&quot;+linecount;
			return processed(ev);
		}
		if (e.saved_onkeydown) // call previous keydown handler (if any)
			e.saved_onkeydown(ev);
	}
	e.initialized=true;
}
//}}}

// // 'autosize' toolbar command
//{{{
config.commands.autosizeEditor = {
	text: 'autosize',
	tooltip: 'automatically adjust the editor height to fit the contents',
	text_alt: '\u221Aautosize',
	hideReadOnly: false,
	handler: function(event,src,title) {
		var here=story.findContainingTiddler(src); if (!here) return;
		var ta=here.getElementsByTagName('textarea'); if (!ta) return;
		for (i=0;i&lt;ta.length;i++) {
			// only autosize textareas actually used to edit tiddler fields
			if (ta[i].getAttribute(&quot;edit&quot;)==undefined) continue;
			ta[i].button=src;
			if (!ta[i].maxed)
				config.commands.autosizeEditor.on(ta[i]);
			else
				config.commands.autosizeEditor.off(ta[i],true);
		}
		return false;
	},
	on: function(e) {
		if (e.maxed) return; // already autosizing!
		if (e.savedheight==undefined)
			e.savedheight=e.style.height;
		if (e.savedkeyup==undefined) {
			e.savedkeyup=e.onkeyup;
			e.onkeyup=function(ev) {
				if (!ev) var ev=window.event; var e=resolveTarget(ev);
				e.style.height=e.scrollHeight+'px';
				if (e.savedkeyup) e.savedkeyup();
			}
		}
		// IE reports error: &quot;not implemented&quot; for onkeypress
		if (!config.browser.isIE &amp;&amp; e.savedkeypress==undefined) {
			e.savedkeypress=e.onkeypress;
			e.onkeypress=function(ev) {
				if (!ev) var ev=window.event; var e=resolveTarget(ev);
				if (ev.keyCode==33) { // PGUP
					if (window.scrollByPages) window.scrollByPages(-1);
					return false;
				}
				if (ev.keyCode==34) { // PGDN
					if (window.scrollByPages) window.scrollByPages(1);
					return false;
				}
				if (e.savedkeypress) e.savedkeypress();
			}
		}
		e.style.height=e.scrollHeight+'px';
		if (e.button) e.button.innerHTML=config.commands.autosizeEditor.text_alt;
		e.maxed=true;
	},
	off: function(e,resetHeight) {
		if (resetHeight) e.style.height=e.savedheight;
		e.onkeyup=e.savedkeyup;
		// IE reports error: &quot;not implemented&quot; for onkeypress
		if (!config.browser.isIE) e.onkeypress=e.savedkeypress;
		if (e.button) e.button.innerHTML=config.commands.autosizeEditor.text;
		e.maxed=false;
	}
};

config.macros.autosizeEditor={
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var here=story.findContainingTiddler(place); if (!here) return;
		var ta=here.getElementsByTagName('textarea'); if (!ta) return;
		for (i=0;i&lt;ta.length;i++) {
			// only autosize textareas actually used to edit tiddler fields
			if (ta[i].getAttribute(&quot;edit&quot;)==undefined) continue;
			config.commands.autosizeEditor.on(ta[i]);
		}
		return false;
	}
}
//}}}

// // grab-and-stretch handle
//{{{
config.macros.resizeEditor = { // add stretch bar to editor textarea
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var here=story.findContainingTiddler(place); if (!here) return;
		var ta=here.getElementsByTagName('textarea');
		if (ta) for (i=0;i&lt;ta.length;i++) {
			// only resize tiddler editor textareas
			if (ta[i].getAttribute(&quot;edit&quot;)==undefined) continue;
			new window.TextAreaResizer(ta[i]);
		}
	}
}

config.macros.resizeTiddler = { // add stretch bar to tiddler viewer element
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var here=story.findContainingTiddler(place); if (!here) return;
		var elems=here.getElementsByTagName('div');
		if (elems) for (i=0;i&lt;elems.length;i++) if (hasClass(elems[i],'viewer')) break;
		if (i&lt;elems.length) new window.TextAreaResizer(elems[i]);
	}
}

config.macros.resizeFrame = { // add stretch bar to iframes
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var here=story.findContainingTiddler(place); if (!here) return;
		var fr=here.getElementsByTagName('iframe');
		if (fr) for (i=0;i&lt;fr.length;i++) new window.TextAreaResizer(fr[i]);
	}
}

config.macros.resizeListbox = { // add stretch bar to listbox controls
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var here=story.findContainingTiddler(place); if (!here) here=place;
		var fr=here.getElementsByTagName('select');
		if (fr) for (i=0;i&lt;fr.length;i++) new window.TextAreaResizer(fr[i]);
	}
}

// TextAreaResizer script by Jason Johnston (jj@lojjic.net)
// Created August 2003.  Use freely, but give me credit.
// adds a handle below textareas that the user can drag with the mouse to resize the textarea.
// MODIFIED by ELS for cross-browser (IE) compatibility, including:

window.TextAreaResizer = function(elt) {
	this.element = elt;
	this.create();
}
window.TextAreaResizer.prototype = {
	create : function() {
		var elt = this.element;
		var thisRef = this;
		var h = this.handle = document.createElement(&quot;div&quot;);
		h.style.height = &quot;2px&quot;; // was 4px... looked too fat!
		h.style.overflow = &quot;hidden&quot;; // ELS: force IE to trim height to &lt; 1em
		var adjust=elt.nodeName=='textarea'?4:0;  // 4 pixels for textarea border edge
//		h.style.width=(elt.offsetWidth-adjust)+&quot;px&quot;;
		h.style.width=&quot;auto&quot;;
		h.style.backgroundColor = &quot;#999&quot;; // ELS: standard mid-tone (dark) gray
		h.style.cursor = &quot;s-resize&quot;;
		h.title = &quot;Drag to resize text box&quot;;
		h.onmousedown=function(evt){thisRef.dragStart(evt)};
		elt.parentNode.insertBefore(h, elt.nextSibling);
	},
	dragStart : function(evt) {
		if (!evt) var evt=window.event;
		this.dragStop(evt); // ELS: stop any current drag processing first
		var thisRef = this;
		this.dragStartY = evt.clientY;
		this.dragStartH = this.element.offsetHeight;
		document.savedmousemove=document.onmousemove;
		document.onmousemove=this.dragMoveHdlr=function(evt){thisRef.dragMove(evt)};
		document.savedmouseup=document.onmouseup;
		document.onmouseup=this.dragStopHdlr=function(evt){thisRef.dragStop(evt)};
	},
	dragMove : function(evt) {
		if (!evt) var evt=window.event;
		// ELS: make sure height is at least 10px
		var h=this.dragStartH+evt.clientY-this.dragStartY;
		if (h&lt;10) h=10; this.element.style.height=h+&quot;px&quot;;
		// ELS: match handle to textarea width (which may have changed due to document scrollbars)
//		var adjust=this.element.nodeName.toLowerCase()=='textarea'?4:0; // 4 pixels for textarea
//		this.handle.style.width=(this.element.offsetWidth-adjust)+&quot;px&quot;;
		// ELS: when manually resizing, disable autoresizing (without restoring saved height)
		if (this.element.maxed!=undefined &amp;&amp; this.element.maxed)
			config.commands.autosizeEditor.off(this.element,false);
	},
	dragStop : function(evt) {
		if (!evt) var evt=window.event;
		document.onmousemove=(document.savedmousemove!=undefined)?document.savedmousemove:null;
		document.onmousemove=(document.savedmouseup!=undefined)?document.savedmouseup:null;
	},
	destroy : function() {
		var elt = this.element;
		elt.parentNode.removeChild(this.handle);
		elt.style.height = &quot;&quot;;
	}
};
//}}}</pre>
</div>
<div title="TiddlerTweakerPlugin" modifier="John Hind" created="200708032311" modified="201102131624" tags="TidIDEPackage systemConfig excludeLists excludePublished excludeSearch excludeMissing" changecount="2">
<pre>/***
|Name|TiddlerTweakerPlugin|
|Source|http://www.TiddlyTools.com/#TiddlerTweakerPlugin|
|Version|2.4.5|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|select multiple tiddlers and modify author, created, modified and/or tag values|
~TiddlerTweaker is a 'power tool' for TiddlyWiki authors.  Select multiple tiddlers from a listbox and 'bulk modify' the creator, author, created, modified and/or tag values of those tiddlers using a compact set of form fields.  The values you enter into the fields simultaneously overwrite the existing values in all tiddlers you have selected.
!!!!!Usage
&lt;&lt;&lt;
{{{&lt;&lt;tiddlerTweaker&gt;&gt;}}}
{{smallform{&lt;&lt;tiddlerTweaker&gt;&gt;}}}
By default, any tags you enter into the TiddlerTweaker will //replace// the existing tags in all the tiddlers you have selected.  However, you can also use TiddlerTweaker to quickly filter specified tags from the selected tiddlers, while leaving any other tags assigned to those tiddlers unchanged:
&gt;Any tag preceded by a '+' (plus) or '-' (minus), will be added or removed from the existing tags //instead of replacing the entire tag definition// of each tiddler (e.g., enter '-excludeLists' to remove that tag from all selected tiddlers.  When using this syntax, care should be taken to ensure that //every// tag is preceded by '+' or '-', to avoid inadvertently overwriting any other existing tags on the selected tiddlers.  (note: the '+' or '-' prefix on each tag value is NOT part of the tag value, and is only used by TiddlerTweaker to control how that tag value is processed)
Important Notes:
* TiddlerTweaker is a 'power user' tool that can make changes to many tiddlers at once.  ''You should always have a recent backup of your document (or 'save changes' just *before* tweaking the tiddlers), just in case you accidentally 'shoot yourself in the foot'.''
* The date and author information on any tiddlers you tweak will ONLY be updated if the corresponding checkboxes have been selected.  As a general rule, after using TiddlerTweaker, always ''//remember to save your document//'' when you are done, even though the tiddler timeline tab may not show any recently modified tiddlers.
* Selecting and updating all tiddlers in a document can take a while.  Your browser may warn about an 'unresponsive script'.  Usually, if you allow it to continue, it should complete the processing... eventually.  Nonetheless, be sure to save your work before you begin tweaking lots of tiddlers, just in case something does get stuck.
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2011.01.21 2.4.5 auto-selection: use &quot;-&quot; for untagged tiddlers.  Also, added 'opened', 'invert'
2009.09.15 2.4.4 added 'edit' button. moved html definition to separate section
2009.09.13 2.4.3 in settiddlers(), convert backslashed chars (\n\b\s\t) in replacement text
2009.06.26 2.4.2 only add brackets around tags containing spaces
2009.06.22 2.4.1 in setFields(), add brackets around all tags shown tweaker edit field
2009.03.30 2.4.0 added 'sort by modifier'
2009.01.22 2.3.0 added support for text pattern find/replace
2008.10.27 2.2.3 in setTiddlers(), fixed Safari bug by replacing static Array.concat(...) with new Array().concat(...)
2008.09.07 2.2.2 added removeCookie() function for compatibility with [[CookieManagerPlugin]]
2008.05.12 2.2.1 replace built-in backstage tweak task with tiddler tweaker control panel (moved from BackstageTweaks)
2008.01.13 2.2.0 added 'auto-selection' links: all, changed, tags, title, text
2007.12.26 2.1.0 added support for managing 'creator' custom field (see [[CoreTweaks]])
2007.11.01 2.0.3 added config.options.txtTweakerSortBy for cookie-based persistence of list display order preference setting.
2007.09.28 2.0.2 in settiddlers() and deltiddlers(), added suspend/resume notification handling (improves performance when operating on multiple tiddlers)
2007.08.03 2.0.1 added shadow definition for [[TiddlerTweaker]] tiddler for use as parameter references with {{{&lt;&lt;tiddler&gt;&gt;, &lt;&lt;slider&gt;&gt; or &lt;&lt;tabs&gt;&gt;}}} macros.
2007.08.03 2.0.0 converted from inline script
2006.01.01 1.0.0 initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.TiddlerTweakerPlugin= {major: 2, minor: 4, revision: 5, date: new Date(2011,1,21)};

// shadow tiddler
config.shadowTiddlers.TiddlerTweaker='&lt;&lt;tiddlerTweaker&gt;&gt;';

// defaults
if (config.options.txtTweakerSortBy==undefined) config.options.txtTweakerSortBy='modified';

// backstage task
if (config.tasks) { // for TW2.2b3 or above
	config.tasks.tweak.tooltip='review/modify tiddler internals: dates, authors, tags, etc.';
	config.tasks.tweak.content='{{smallform small groupbox{&lt;&lt;tiddlerTweaker&gt;&gt;}}}';
}

// if removeCookie() function is not defined by TW core, define it here.
if (window.removeCookie===undefined) {
	window.removeCookie=function(name) {
		document.cookie = name+'=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
	}
}

config.macros.tiddlerTweaker = {
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var span=createTiddlyElement(place,'span');
		span.innerHTML=store.getTiddlerText('TiddlerTweakerPlugin##html');
		this.init(span.getElementsByTagName('form')[0],config.options.txtTweakerSortBy);
	},
	init: function(f,sortby) { // set form controls
		if (!f) return; // form might not be rendered yet...
		while (f.list.options[0]) f.list.options[0]=null; // empty the list
		var tids=store.getTiddlers(sortby);
		if (sortby=='size') // descending order
			tids.sort(function(a,b) {return a.text.length &gt; b.text.length ? -1 : (a.text.length == b.text.length ? 0 : +1);});
		var who='';
		for (i=0; i&lt;tids.length; i++) { var t=tids[i];
			var label=t.title; var value=t.title;
			switch (sortby) {
				case 'modified':
				case 'created':
					var t=tids[tids.length-i-1]; // reverse order
					var when=t[sortby].formatString('YY.0MM.0DD 0hh:0mm ');
					label=when+t.title;
					value=t.title;
					break;
				case 'size':
					label='['+t.text.length+'] '+label;
					break;
				case 'modifier':
				case 'creator':
					if (who!=t[sortby]) {
						who=t[sortby];
						f.list.options[f.list.length]=new Option('by '+who+':','',false,false);
					}
					label='\xa0\xa0\xa0'+label; // indent
					break;
			}
			f.list.options[f.list.length]=new Option(label,value,false,false);
		}
		f.title.value=f.who.value=f.creator.value=f.tags.value='';
		f.cm.value=f.cd.value=f.cy.value=f.ch.value=f.cn.value='';
		f.mm.value=f.md.value=f.my.value=f.mh.value=f.mn.value='';
		f.stats.disabled=f.set.disabled=f.del.disabled=f.edit.disabled=f.display.disabled=true;
		f.settitle.disabled=false;
		config.options.txtTweakerSortBy=sortby;
		f.sortby.value=sortby; // sync droplist
		if (sortby!='modified') saveOptionCookie('txtTweakerSortBy');
		else removeCookie('txtTweakerSortBy');
	},
	enablefields: function(here) { // enables/disables inputs based on #items selected
		var f=here.form; var list=f.list;
		var c=0; for (i=0;i&lt;list.length;i++) if (list.options[i].selected) c++;
		if (c&gt;1) f.title.disabled=true;
		if (c&gt;1) f.settitle.checked=false;
		f.set.disabled=(c==0);
		f.del.disabled=(c==0);
		f.edit.disabled=(c==0);
		f.display.disabled=(c==0);
		f.settitle.disabled=(c&gt;1);
		f.stats.disabled=(c==0);
		var msg=(c==0)?'select tiddlers':(c+' tiddler'+(c!=1?'s':'')+' selected');
		here.previousSibling.firstChild.firstChild.nextSibling.innerHTML=msg;
		if (c) clearMessage(); else displayMessage('no tiddlers selected');
	},
	setfields: function(here) { // set fields from first selected tiddler
		var f=here.form;
		if (!here.value.length) {
			f.title.value=f.who.value=f.creator.value=f.tags.value='';
			f.cm.value=f.cd.value=f.cy.value=f.ch.value=f.cn.value='';
			f.mm.value=f.md.value=f.my.value=f.mh.value=f.mn.value='';
			return;
		}
		var tid=store.getTiddler(here.value); if (!tid) return;
		f.title.value=tid.title;
		f.who.value=tid.modifier;
		f.creator.value=tid.fields['creator']||''; // custom field - might not exist
		f.tags.value=tid.tags.map(function(t){return String.encodeTiddlyLink(t)}).join(' ');
		var c=tid.created; var m=tid.modified;
		f.cm.value=c.getMonth()+1;
		f.cd.value=c.getDate();
		f.cy.value=c.getFullYear();
		f.ch.value=c.getHours();
		f.cn.value=c.getMinutes();
		f.mm.value=m.getMonth()+1;
		f.md.value=m.getDate();
		f.my.value=m.getFullYear();
		f.mh.value=m.getHours();
		f.mn.value=m.getMinutes();
	},
	selecttiddlers: function(here,callback) {
		var f=here; while (f&amp;&amp;f.nodeName.toLowerCase()!='form')f=f.parentNode;
		for (var t=f.list.options.length-1; t&gt;=0; t--)
			f.list.options[t].selected=callback(f.list.options[t]);
		config.macros.tiddlerTweaker.enablefields(f.list);
		return false;
	},
	settiddlers: function(here) {
		var f=here.form; var list=f.list;
		var tids=[];
		for (i=0;i&lt;list.length;i++) if (list.options[i].selected) tids.push(list.options[i].value);
		if (!tids.length) { alert('please select at least one tiddler'); return; }
		var cdate=new Date(f.cy.value,f.cm.value-1,f.cd.value,f.ch.value,f.cn.value);
		var mdate=new Date(f.my.value,f.mm.value-1,f.md.value,f.mh.value,f.mn.value);
		if (tids.length&gt;1 &amp;&amp; !confirm('Are you sure you want to update these tiddlers:\n\n'+tids.join(', '))) return;
		store.suspendNotifications();
		for (t=0;t&lt;tids.length;t++) {
			var tid=store.getTiddler(tids[t]); if (!tid) continue;
			var title=!f.settitle.checked?tid.title:f.title.value;
			var who=!f.setwho.checked?tid.modifier:f.who.value;
			var text=tid.text;
			if (f.replacetext.checked) {
				var r=f.replacement.value.replace(/\\t/mg,'\t').unescapeLineBreaks();
				text=text.replace(new RegExp(f.pattern.value,'mg'),r);
			}
			var tags=tid.tags;
			if (f.settags.checked) {
				var intags=f.tags.value.readBracketedList();
				var addtags=[]; var deltags=[]; var reptags=[];
				for (i=0;i&lt;intags.length;i++) {
					if (intags[i].substr(0,1)=='+')
						addtags.push(intags[i].substr(1));
					else if (intags[i].substr(0,1)=='-')
						deltags.push(intags[i].substr(1));
					else
						reptags.push(intags[i]);
				}
				if (reptags.length)
					tags=reptags;
				if (addtags.length)
					tags=new Array().concat(tags,addtags);
				if (deltags.length)
					for (i=0;i&lt;deltags.length;i++)
						{ var pos=tags.indexOf(deltags[i]); if (pos!=-1) tags.splice(pos,1); }
			}
			if (!f.setcdate.checked) cdate=tid.created;
			if (!f.setmdate.checked) mdate=tid.modified;
			store.saveTiddler(tid.title,title,text,who,mdate,tags,tid.fields);
			if (f.setcreator.checked) store.setValue(tid.title,'creator',f.creator.value); // set creator
			if (f.setcdate.checked) tid.assign(null,null,null,null,null,cdate); // set create date
		}
		store.resumeNotifications();
		this.init(f,f.sortby.value);
	},
	displaytiddlers: function(here,edit) {
		var f=here.form; var list=f.list;
		var tids=[];
		for (i=0; i&lt;list.length;i++) if (list.options[i].selected) tids.push(list.options[i].value);
		if (!tids.length) { alert('please select at least one tiddler'); return; }
		story.displayTiddlers(story.findContainingTiddler(f),tids,edit?DEFAULT_EDIT_TEMPLATE:null);
	},
	deltiddlers: function(here) {
		var f=here.form; var list=f.list;
		var tids=[];
		for (i=0;i&lt;list.length;i++) if (list.options[i].selected) tids.push(list.options[i].value);
		if (!tids.length) { alert('please select at least one tiddler'); return; }
		if (!confirm('Are you sure you want to delete these tiddlers:\n\n'+tids.join(', '))) return;
		store.suspendNotifications();
		for (t=0;t&lt;tids.length;t++) {
			var tid=store.getTiddler(tids[t]); if (!tid) continue;
			if (tid.tags.contains('systemConfig')) {
				var msg=tid.title+' is tagged with systemConfig.'
					+'\n\nRemoving this tiddler may cause unexpected results.  Are you sure?';
				if (!confirm(msg)) continue;
			}
			store.removeTiddler(tid.title);
			story.closeTiddler(tid.title);
		}
		store.resumeNotifications();
		this.init(f,f.sortby.value);
	},
	stats: function(here) {
		var f=here.form; var list=f.list; var tids=[]; var out=''; var tot=0;
		var target=f.nextSibling;
		for (i=0;i&lt;list.length;i++) if (list.options[i].selected) tids.push(list.options[i].value);
		if (!tids.length) { alert('please select at least one tiddler'); return; }
		for (t=0;t&lt;tids.length;t++) {
			var tid=store.getTiddler(tids[t]); if (!tid) continue;
			out+='[['+tid.title+']] '+tid.text.length+'\n'; tot+=tid.text.length;
		}
		var avg=tot/tids.length;
		out=tot+' bytes in '+tids.length+' selected tiddlers ('+avg+' bytes/tiddler)\n&lt;&lt;&lt;\n'+out+'&lt;&lt;&lt;\n';
		removeChildren(target);
		target.innerHTML=&quot;&lt;hr&gt;&lt;font size=-2&gt;&lt;a href='javascript:;' style='float:right' &quot;
			+&quot;onclick='this.parentNode.parentNode.style.display=\&quot;none\&quot;'&gt;close&lt;/a&gt;&lt;/font&gt;&quot;;
		wikify(out,target);
		target.style.display='block';
	}
};
//}}}
/***
//{{{
!html
&lt;style&gt;
.tiddlerTweaker table,
.tiddlerTweaker table tr,
.tiddlerTweaker table td
	{ padding:0;margin:0;border:0;white-space:nowrap; }
&lt;/style&gt;&lt;form class='tiddlerTweaker'&gt;&lt;!--
--&gt;&lt;table style=&quot;width:100%&quot;&gt;&lt;tr valign=&quot;top&quot;&gt;&lt;!--
--&gt;&lt;td style=&quot;text-align:center;width:99%;&quot;&gt;&lt;!--
	--&gt;&lt;font size=-2&gt;&lt;div style=&quot;text-align:left;&quot;&gt;&lt;span style=&quot;float:right&quot;&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;select all tiddlers&quot;
		onclick=&quot;return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
			return opt.value.length;
		});&quot;&gt;all&lt;/a&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;select tiddlers currently displayed in the story column&quot;
		onclick=&quot;return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
			return story.getTiddler(opt.value);
		});&quot;&gt;opened&lt;/a&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;select tiddlers that are new/changed since the last file save&quot;
		onclick=&quot;var lastmod=new Date(document.lastModified);
			return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
				var tid=store.getTiddler(opt.value);
				return tid&amp;&amp;tid.modified&gt;lastmod;
			});
		&quot;&gt;changed&lt;/a&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;select tiddlers with at least one matching tag&quot;
		onclick=&quot;var t=prompt('Enter space-separated tags (match one or more).  Use \x22-\x22 to match untagged tiddlers');
			if (!t||!t.length) return false;
			var tags=t.readBracketedList();
			return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
				var tid=store.getTiddler(opt.value);
				return tid&amp;&amp;tags[0]=='-'?!tid.tags.length:tid.tags.containsAny(tags);
			});
		&quot;&gt;tags&lt;/a&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;select tiddlers whose titles include matching text&quot;
		onclick=&quot;var t=prompt('Enter a title (or portion of a title) to match');
			if (!t||!t.length) return false;
			return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
				return opt.value.indexOf(t)!=-1;
			});
		&quot;&gt;titles&lt;/a&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;select tiddlers containing matching text&quot;
		onclick=&quot;var t=prompt('Enter tiddler text (content) to match');
			if (!t||!t.length) return false;
			return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
				var tt=store.getTiddlerText(opt.value,'');
				return tt.indexOf(t)!=-1;
			});
		&quot;&gt;text&lt;/a&gt;&lt;!--
	--&gt;&amp;nbsp; &lt;a href=&quot;javascript:;&quot;
		title=&quot;reverse selection of all list items&quot;
		onclick=&quot;return config.macros.tiddlerTweaker.selecttiddlers(this,function(opt){
			return !opt.selected;
		});&quot;&gt;invert&lt;/a&gt;&lt;!--
	--&gt;&lt;/span&gt;&lt;span&gt;select tiddlers&lt;/span&gt;&lt;!--
	--&gt;&lt;/div&gt;&lt;!--
	--&gt;&lt;/font&gt;&lt;select multiple name=list size=&quot;11&quot; style=&quot;width:99.99%&quot;
		title=&quot;use click, shift-click and/or ctrl-click to select multiple tiddler titles&quot;
		onclick=&quot;config.macros.tiddlerTweaker.enablefields(this)&quot;
		onchange=&quot;config.macros.tiddlerTweaker.setfields(this)&quot;&gt;&lt;!--
	--&gt;&lt;/select&gt;&lt;br&gt;&lt;!--
	--&gt;show&lt;input type=text size=1 value=&quot;11&quot;
		onchange=&quot;this.form.list.size=this.value; this.form.list.multiple=(this.value&gt;1);&quot;&gt;&lt;!--
	--&gt;by&lt;!--
	--&gt;&lt;select name=sortby size=1
		onchange=&quot;config.macros.tiddlerTweaker.init(this.form,this.value)&quot;&gt;&lt;!--
	--&gt;&lt;option value=&quot;title&quot;&gt;title&lt;/option&gt;&lt;!--
	--&gt;&lt;option value=&quot;size&quot;&gt;size&lt;/option&gt;&lt;!--
	--&gt;&lt;option value=&quot;modified&quot;&gt;modified&lt;/option&gt;&lt;!--
	--&gt;&lt;option value=&quot;created&quot;&gt;created&lt;/option&gt;&lt;!--
	--&gt;&lt;option value=&quot;modifier&quot;&gt;modifier&lt;/option&gt;&lt;!--
	--&gt;&lt;/select&gt;&lt;!--
	--&gt;&lt;input type=&quot;button&quot; value=&quot;refresh&quot;
		onclick=&quot;config.macros.tiddlerTweaker.init(this.form,this.form.sortby.value)&quot;&lt;!--
	--&gt; &lt;input type=&quot;button&quot; name=&quot;stats&quot; disabled value=&quot;totals...&quot;
		onclick=&quot;config.macros.tiddlerTweaker.stats(this)&quot;&gt;&lt;!--
--&gt;&lt;/td&gt;&lt;td style=&quot;width:1%&quot;&gt;&lt;!--
	--&gt;&lt;div style=&quot;text-align:left&quot;&gt;&lt;font size=-2&gt;&amp;nbsp;modify values&lt;/font&gt;&lt;/div&gt;&lt;!--
	--&gt;&lt;table style=&quot;width:100%;&quot;&gt;&lt;tr&gt;&lt;!--
	--&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=settitle unchecked
			title=&quot;allow changes to tiddler title (rename tiddler)&quot;
			onclick=&quot;this.form.title.disabled=!this.checked&quot;&gt;title&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=title size=35 style=&quot;width:98%&quot; disabled&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=setcreator unchecked
			title=&quot;allow changes to tiddler creator&quot;
			onclick=&quot;this.form.creator.disabled=!this.checked&quot;&gt;created by&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px;&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=creator size=35 style=&quot;width:98%&quot; disabled&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=setwho unchecked
			title=&quot;allow changes to tiddler author&quot;
			onclick=&quot;this.form.who.disabled=!this.checked&quot;&gt;modified by&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=who size=35 style=&quot;width:98%&quot; disabled&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=setcdate unchecked
			title=&quot;allow changes to created date&quot;
			onclick=&quot;var f=this.form;
				f.cm.disabled=f.cd.disabled=f.cy.disabled=f.ch.disabled=f.cn.disabled=!this.checked&quot;&gt;&lt;!--
		--&gt;created on&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=cm size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; / &lt;input type=text name=cd size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; / &lt;input type=text name=cy size=4 style=&quot;width:3em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; at &lt;input type=text name=ch size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; : &lt;input type=text name=cn size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=setmdate unchecked
			title=&quot;allow changes to modified date&quot;
			onclick=&quot;var f=this.form;
				f.mm.disabled=f.md.disabled=f.my.disabled=f.mh.disabled=f.mn.disabled=!this.checked&quot;&gt;&lt;!--
		--&gt;modified on&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=mm size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; / &lt;input type=text name=md size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; / &lt;input type=text name=my size=4 style=&quot;width:3em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; at &lt;input type=text name=mh size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
		--&gt; : &lt;input type=text name=mn size=2 style=&quot;width:2em;padding:0;text-align:center&quot; disabled&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=replacetext unchecked
			title=&quot;find/replace matching text&quot;
			onclick=&quot;this.form.pattern.disabled=this.form.replacement.disabled=!this.checked&quot;&gt;replace text&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=pattern size=15 value=&quot;&quot; style=&quot;width:40%&quot; disabled
			title=&quot;enter TEXT PATTERN (regular expression)&quot;&gt; with&lt;!--
		--&gt;&lt;input type=text name=replacement size=15 value=&quot;&quot; style=&quot;width:40%&quot; disabled
			title=&quot;enter REPLACEMENT TEXT&quot;&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=checkbox name=settags checked
			title=&quot;allow changes to tiddler tags&quot;
			onclick=&quot;this.form.tags.disabled=!this.checked&quot;&gt;tags&lt;!--
	--&gt;&lt;/td&gt;&lt;td style=&quot;padding:1px&quot;&gt;&lt;!--
		--&gt;&lt;input type=text name=tags size=35 value=&quot;&quot; style=&quot;width:98%&quot;
			title=&quot;enter new tags or use '+tag' and '-tag' to add/remove tags from existing tags&quot;&gt;&lt;!--
	--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;!--
	--&gt;&lt;div style=&quot;text-align:center&quot;&gt;&lt;!--
	--&gt;&lt;nobr&gt;&lt;input type=button name=display disabled style=&quot;width:24%&quot; value=&quot;display&quot;
		title=&quot;show selected tiddlers&quot;
		onclick=&quot;config.macros.tiddlerTweaker.displaytiddlers(this,false)&quot;&gt;&lt;!--
	--&gt; &lt;input type=button name=edit disabled style=&quot;width:23%&quot; value=&quot;edit&quot;
		title=&quot;edit selected tiddlers&quot;
		onclick=&quot;config.macros.tiddlerTweaker.displaytiddlers(this,true)&quot;&gt;&lt;!--
	--&gt; &lt;input type=button name=del disabled style=&quot;width:24%&quot; value=&quot;delete&quot;
		title=&quot;remove selected tiddlers&quot;
		onclick=&quot;config.macros.tiddlerTweaker.deltiddlers(this)&quot;&gt;&lt;!--
	--&gt; &lt;input type=button name=set disabled style=&quot;width:24%&quot; value=&quot;update&quot;
		title=&quot;update selected tiddlers&quot;
		onclick=&quot;config.macros.tiddlerTweaker.settiddlers(this)&quot;&gt;&lt;/nobr&gt;&lt;!--
	--&gt;&lt;/div&gt;&lt;!--
--&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;!--
--&gt;&lt;/form&gt;&lt;span style=&quot;display:none&quot;&gt;&lt;!--content replaced by tiddler &quot;stats&quot;--&gt;&lt;/span&gt;
!end
//}}}
***/
 </pre>
</div>
<div title="Time Arithmetic" creator="John Hind" modifier="John Hind" created="201006021836" modified="201402050923" changecount="3">
<pre>The mathematical operators are overloaded to implement correct time calculations:
{{{
a = Time{year=2010,month=5,day=20,hour=11,minute=13}
d = Time{hours=2.5}
t = Time{hour=14,minute=3,second=30}
print(a:type(), &quot;absolute&quot;, a)
print(d:type(), &quot;duration&quot;, d)
print(t:type(), &quot;day&quot;, t)
x = a + d; print(x:type(), &quot;absolute&quot;, x)
x = d + a; print(x:type(), &quot;absolute&quot;, x)
x = d + d; print(x:type(), &quot;duration&quot;, x)
x = t + d; print(x:type(), &quot;day&quot;, x)
x = d + t; print(x:type(), &quot;day&quot;, x)
x = a - d; print(x:type(), &quot;absolute&quot;, x)
x = d - d; print(x:type(), &quot;duration&quot;, x)
x = a - a; print(x:type(), &quot;duration&quot;, x)
x = t - d; print(x:type(), &quot;day&quot;, x)
x = -d   ; print(x:type(), &quot;duration&quot;, x)
x = d * 2; print(x:type(), &quot;duration&quot;, x)
x = d / 2; print(x:type(), &quot;duration&quot;, x)
x = d / d; print(type(x), &quot;number&quot;, x)
}}}</pre>
</div>
<div title="Time Class" creator="John Hind" modifier="John Hind" created="201006021630" modified="201402211713" changecount="6">
<pre>The Time Library provides the Time Class objects of which represent times and dates, time intervals, time zones and alarms.
!time = Time()
Creates a new Time object representing the current time and date.
!time = Time(time1)
Copies an existing Time object.
!time = Time{...}
Creates an absolute time-and-date Time object, a duration Time object representing an interval from milliseconds up to years, or a time-of-day Time object, using one or more named [[Time Creation Parameters]].
!!Methods
[[time:alarm]] - Schedule a function to run in the future.
[[time:date]] - Return the date components.
[[time:day]] - Return the day of the week.
[[time:format]] - Format the date and time as a string.
[[time:time]] - Return the time components.
[[time:type]] - Identify the type of the object.
[[time:value]] - Return the time and date as a real number.
[[time:zone]] - Return information about the time zone.
!!Metamethods
[[Time Arithmetic]]
[[Time Comparisons]]
</pre>
</div>
<div title="Time Comparisons" creator="John Hind" modifier="John Hind" created="201006021839" modified="201402091951" changecount="3">
<pre>The relational operators are overloaded to give the expected comparisons between Time objects of the same type. Different types compare {{{false}}} in all cases except {{{~=}}} which gives {{{true}}}.

For limited resolution absolute Time objects, comparisons take account of resolution. For example, if {{{A1}}} has a resolution of Day and {{{A2}}} has full resolution, {{{A1 == A2}}} and {{{A2 == A1}}} are both {{{true}}} if {{{A2}}} represents any time during the day represented by {{{A1}}}. In general, absolute objects are equal if the shorter resolution object is contained within (or is identical to) the longer.

Similarly, for limited resolution absolute Time objects, {{{A1 &gt; A2}}} is {{{true}}} only if {{{A1}}} represents a time starting after the end of {{{A2}}}. {{{A1 &gt;= A2}}} is {{{true}}} if the start of {{{A1}}} is after or the same as the start of {{{A2}}}. {{{A1 &lt; A2}}} is {{{true}}} if the end of {{{A1}}} occurs before the start of {{{A2}}} while {{{A1 &lt;= A2}}} it {{{true}}} if the end of {{{A1}}} occurs before or on the end of {{{A2}}}.
{{{
print(&quot;--Absolute, same resolution&quot;)
a1 = Time{year=2010,month=5,day=20,hour=11,minute=13}
a2 = Time{year=2010,month=5,day=20,hour=11,minute=14}
print(a1==a2, &quot;false&quot;)
print(a1==a1, &quot;true&quot;)
print(a1&gt;a2, &quot;false&quot;)
print(a2&gt;a1, &quot;true&quot;)
print(a1~=a2, &quot;true&quot;)
print(a1&lt;=a2, &quot;true&quot;)
print(&quot;--Absolute, different resolution&quot;)
a3 = Time{year=2010}
print(a1==a3, &quot;true&quot;)
print(a3==a1, &quot;true&quot;)
print(a1&gt;a3, &quot;true&quot;)
print(a1&lt;a3, &quot;false&quot;)
print(a3&gt;a1, &quot;false&quot;)
print(a3&lt;a1, &quot;true&quot;)
print(&quot;--Duration&quot;)
d1 = Time{hours=2}
d2 = Time{hours=1.9}
print(d1==d2, &quot;false&quot;)
print(d1~=d2, &quot;true&quot;)
print(d1==d1, &quot;true&quot;)
print(a1==d1, &quot;false&quot;)
print(d1&lt;d2, &quot;false&quot;)
print(d1&gt;=d2, &quot;true&quot;)
print(&quot;--Time of day&quot;)
t1 = Time{hour=12}
t2 = Time{hour=12, minute=1}
print(t1&lt;=t2, &quot;true&quot;)
print(t1==t2, &quot;false&quot;)
}}}</pre>
</div>
<div title="Time Creation Parameters" creator="John Hind" modifier="John Hind" created="201006021645" modified="201402091941" changecount="5">
<pre>!time = Time{...}
The named parameter form is used (note the curly braces used in place of normal brackets). The parameters are a variable number of {{{name=value}}} pairs separated by commas or semi-colons. The available keys are as follows:
|Key|Specifies|Example|Type|h
|year|Four-digit year|year=2010|absolute|
|month|Month as a number, 1 .. 12|month=5|absolute|
|day|Day of month as a number, 1 .. 31|day=23|absolute|
|hour|Hour of day, 0 .. 23|hour=12|time-of-day/absolute|
|minute|Minute of hour, 0 .. 59|minute=40|time-of-day/absolute|
|second|Second, may include fraction|second=5.6|time-of-day/absolute|
|zoneoffset|Hours to be added to give UTC|zoneoffset=-1.0|time-of-day/absolute|
|weeks|Number of weeks|weeks=1.0|duration|
|days|Number of days|days=3.4|duration|
|hours|Number of hours|hours=2.8|duration|
|minutes|Number of minutes|minutes=59.9|duration|
|seconds|Number of seconds|seconds=34.78|duration|
|time|''true'' to force time-of-day|time=true|time-of-day|
|date|''true'' to force day resolution|date=true|absolute|
Each of the time-of-day/absolute fields is initialised to the current time and date before being overwritten by any supplied fields. If ''hour'' is the highest supplied field, or ''time'' is true, a time-of-day is created, otherwise an absolute. Missing fields lower than the highest supplied field are zeroed and the resolution marker for absolute objects is set to the lowest supplied field, or ''day'' if the ''date'' field is ''true''. If the ''zoneoffset'' field is missing, the offset for the current time zone is used. If you want to supply time in UTC include ''zoneoffset=0.0''. If none of the time-of-day or absolute parameters are provided, a duration object is created. The duration fields are multiplied by the appropriate scale factor and added together to specify the duration.

Objects of Time class fall into three distinct variations, representing an absolute time-and-date, a duration (from milliseconds up to years) or a time-of-day. The internal representation is a 64-bit floating point number which encodes days and fractions of a day. Time objects can also be used to schedule Lua callable objects for execution in the future.

The absolute form represents a positive or negative offset from a datum and is stored in UTC form (GMT time zone), but the access methods convert the number to the local time zone and daylight savings offset. A resolution marker is also stored allowing the object to represent a full minute, hour, day, month or year (without the marker, millisecond resolution is stored). Most frequently, this will be used to store a date without time (day resolution).

The duration form represents a time interval, for example the difference between two absolute Time objects.

The time-of-day form is very similar to the duration form but is limited to just under one day. It is used to represent a time without a date. Mathematical operations use //clock arithmetic// so, for example, adding a duration of two hours to 23:00 gives 01:00.
</pre>
</div>
<div title="Timer Class" creator="John Hind" modifier="John Hind" created="201401071420" modified="201402211729" changecount="18">
<pre>The Timer Library provides the Timer Class objects of which represent precision performance timers. The resolution of the timer is machine and operating system dependent but should always be better than one microsecond, in contrast to the Time object which has millisecond resolution.
!timer = Timer()
Creates a new Timer object and resets it.
!et = timer()
Called with no parameter, returns a number being the elapsed seconds since the timer was created or reset.
!timer(ofs)
Called with a number parameter, resets the timer and applies an offset. Call with zero to achieve a simple reset. Offset should be a number of seconds, positive to subtract from the elapsed time.
!rs = timer('tick')
Called with the string key '''tick''' returns a number being the resolution of the timer in seconds.
!!Example
{{{
local Timer = require(&quot;timer&quot;)
local t1 = Timer()
print(&quot;Timer resolution is &quot; .. t1('tick') * 1000000 .. &quot; microseconds.&quot;)
t1(0)
print(&quot;Baseline correction is &quot; .. t1() .. &quot; seconds&quot;)
t1(0); t1(t1())
local tb = {}
local e = t1()
print(&quot;Table creation took &quot;.. e ..&quot; seconds&quot;)
t1(0); t1(t1)
for i=1, 10000 do tb[i] = tostring(i) end
e = t1()
print(&quot;Table filling took &quot;.. e ..&quot; seconds&quot;)
List(tb)
t1(0); t1(t1)
tb:sort()
e = t1()
print(&quot;Table sorting took &quot;.. e ..&quot; seconds&quot;)
}}}
</pre>
</div>
<div title="ToolbarCommands" modifier="John Hind" created="200903121707" modified="201103081654" tags="BasicsPackage excludeSearch excludeLists excludeMissing template">
<pre>|~ViewToolbar|collapseTiddler collapseOthers closeTiddler closeOthers closeAbove closeBelow +editTiddler &gt; &lt; *  refreshTiddler fields tags references permalink|
|~ViewToolbarReadOnly|collapseTiddler collapseOthers closeTiddler closeOthers closeAbove closeBelow &gt; &lt; * refreshTiddler references permalink|
|~CollapsedToolbar|expandTiddler collapseOthers closeTiddler closeOthers closeAbove closeBelow +editTiddler &gt; &lt; * refreshTiddler fields tags references permalink|
|~CollapsedToolbarReadOnly|expandTiddler collapseOthers closeTiddler closeOthers closeAbove closeBelow &gt; &lt; * refreshTiddler references permalink|
|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler selectForm autosizeEditor|</pre>
</div>
<div title="UnsavedChangesPlugin" modifier="John Hind" created="200708030219" modified="201102131625" tags="systemConfig excludeLists excludePublished excludeSearch excludeMissing" changecount="2">
<pre>/***
|Name|UnsavedChangesPlugin|
|Source|http://www.TiddlyTools.com/#UnsavedChangesPlugin|
|Version|3.3.4|
|Author|Eric Shulman|
|License|http://www.TiddlyTools.com/#LegalStatements|
|~CoreVersion|2.1|
|Type|plugin|
|Description|show droplist of tiddlers that have changed since the last time the document was saved|
Display a list of tiddlers that have been changed since the last time the document was saved.  The list includes all new/modified tiddlers as well as those changed with &quot;minor edits&quot; enabled and any tiddlers that you import during the session, regardless of their modification date.
!!!!!Usage
&lt;&lt;&lt;
{{{
&lt;&lt;unsavedChanges panel&gt;&gt; or &lt;&lt;unsavedChanges&gt;&gt;
}}}
{{indent{
the ''panel'' keyword displays a 'control panel' interface containing a droplist of unsaved tiddlers and a 'goto' button, along with a command link to 'save changes'.  Depending upon what other plugins are installed, several additional elements will also be displayed: When [[NestedSlidersPlugin]] is installed, the entire control panel is contained within a ''SLIDER''.  When [[LoadTiddlersPlugin]] is installed, a ''REVERT'' button is added.  When [[SaveAsPlugin]] is installed, a ''SAVE AS'' link is added.  When [[UploadPlugin]] is installed, an ''UPLOAD'' (or ''save to web'') link is added.  When [[TrashPlugin]] is installed and there are tiddlers tagged with&lt;&lt;tag Trash&gt;&gt;, an ''EMPTY TRASH'' link is added.
}}}
{{{
&lt;&lt;unsavedChanges list separator&gt;&gt;
}}}
{{indent{
the ''list'' keyword displays a simple space-separated list of unsaved tiddlers without any other command links.  You can specify an optional ''separator'' value that can be used in place of the default space character.  For example, you can specify {{{&quot;&lt;br&gt;&quot;}}} as the separator in order to display each link, one per line.
}}}
{{{
&lt;&lt;unsavedChanges command label tip&gt;&gt;
}}}
{{indent{
the ''command'' keyword displays a single 'command link' that, when clicked, displays a ~TiddlyWiki popup containing the list of unsaved tiddlers, the 'save changes' command and, depending upon what other plugins are installed, additional commands for 'save as', 'upload', and 'empty trash' (similar to the panel display described above).

You can specify optional ''label'' and ''tip'' parameters in the macro to customize the command link text and tooltip.  The default label for the command link is: &quot;There %1 %0 unsaved tiddler%2...&quot;, where:
* %0 is automatically replaced with the number of unsaved changes
* %1 is either &quot;is&quot; (if changes=1) or &quot;are&quot; (if changes&gt;1)
* %2 is either blank (if changes=1) or &quot;s&quot; (if changes&gt;1)
resulting in the text: //&quot;There is 1 unsaved tiddler...&quot;, &quot;There are 2 unsaved tiddlers...&quot;, etc.//
}}}
&lt;&lt;&lt;
!!!!!Examples
&lt;&lt;&lt;
^^//note: the following examples will not display any output unless you have already created/modified tiddlers in the current document.//^^
{{{&lt;&lt;unsavedChanges&gt;&gt;}}}
&lt;&lt;unsavedChanges&gt;&gt;
----
{{{&lt;&lt;unsavedChanges command&gt;&gt;}}}
&lt;&lt;unsavedChanges command&gt;&gt;
----
{{{&lt;&lt;unsavedChanges list&gt;&gt;}}}
&lt;&lt;unsavedChanges list&gt;&gt;
----
{{{&lt;&lt;unsavedChanges list &quot;&lt;br&gt;&quot;&gt;&gt;}}}
&lt;&lt;unsavedChanges list &quot;&lt;br&gt;&quot;&gt;&gt;
&lt;&lt;&lt;
!!!!!Revisions
&lt;&lt;&lt;
2010.12.05 3.3.4 display 'save as...' command even if readOnly
2009.03.02 3.3.3 fix handling for titles that contain HTML special chars (lt,gt,quot,amp)
2008.09.02 3.3.2 cleanup popup list output generation and added timestamps/sizes to popup display
2008.08.23 3.3.1 added optional custom 'label' and 'tip' params to 'command' mode and defined default values for mode, label, tip, and separator as object properties for I18N/L10N-readiness.
2008.08.21 3.3.0 complete re-write of rendering and refresh processing to support multiple instances and automatic self-refresh (no longer depends upon core refresh notifications)
2008.08.21 3.2.0 added 'command' option for link+popup as alternative to 'control panel' interface
2008.04.22 3.1.2 use SaveAsPlugin instead of obsolete NewDocumentPlugin to add &quot;save as&quot; link
2007.12.22 3.1.1 hijack removeTiddler() instead of low-level deleteTiddler() to correct tracking and refresh handling issues.  in saveTiddler(), check for 'tiddler rename' (title!=newtitle) and adjust list accordingly.
2007.12.21 3.1.0 added support for {{{&lt;&lt;unsavedChanges list separator&gt;&gt;}}} usage to unsaved tiddlers as a simple list of links, embedded in tiddler content (e.g., [[MainMenu]])
2007.12.20 3.0.0 rewrite to track ALL changed tiddlers, including imports and minor edits, regardless of saved modification dates.  Also, rewrote display logic to directly refresh macro output instead of triggering a page refresh.  The entire process is MUCH more efficient now.
2007.08.02 2.0.0 converted from inline script
2007.01.01 1.0.0 initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.UnsavedChangesPlugin= {major: 3, minor: 3, revision: 4, date: new Date(2010,12,5)};

config.macros.unsavedChanges = {
	changed: [], // list of currently unsaved tiddler titles
	defMode: &quot;panel&quot;,
	defSep: &quot; &quot;,
	defLabel: &quot;There %1 %0 unsaved tiddler%2&quot;,
	defTip: &quot;view a list of unsaved tiddler changes&quot;,
	handler: function(place,macroName,params,wikifier,paramString,tiddler) {
		var wrapper=createTiddlyElement(place,&quot;span&quot;,null,&quot;unsavedChanges&quot;);
		wrapper.setAttribute(&quot;mode&quot;,params[0]||this.defMode);
		wrapper.setAttribute(&quot;sep&quot;,params[1]||this.defSep); // for 'list' mode
		wrapper.setAttribute(&quot;label&quot;,params[1]||this.defLabel); // for 'command' mode
		wrapper.setAttribute(&quot;tip&quot;,params[2]||this.defTip); // for 'command' mode
		this.render(wrapper);
	},
	render: function(wrapper) {
		removeChildren(wrapper); // make sure its empty
		if (!this.changed.length) return; // no changes = no output
		switch (wrapper.getAttribute(&quot;mode&quot;)) {
			case &quot;command&quot;: this.command(wrapper); break;
			case &quot;list&quot;: this.list(wrapper); break;
			case &quot;panel&quot;: default: this.panel(wrapper); break;
		}
	},
	refresh: function() {
		var wrappers=document.getElementsByTagName(&quot;span&quot;);
		for (var w=0; w&lt;wrappers.length; w++)
			if (hasClass(wrappers[w],&quot;unsavedChanges&quot;))
				this.render(wrappers[w]);
	},
	list: function(place) { // show simple list of unsaved tiddlers
		wikify(&quot;[[&quot;+this.changed.join(&quot;]]&quot;+place.getAttribute(&quot;sep&quot;)+&quot;[[&quot;)+&quot;]]&quot;,place);
	},
	command: function(place) { // show command link with popup list
		var c=this.changed.length;
		var txt=place.getAttribute(&quot;label&quot;).format([c,c==1?'is':'are',c==1?'':'s']);
		var tip=place.getAttribute(&quot;tip&quot;);
		var action=function(ev) { if (!ev) var ev=window.event;
			var p=Popup.create(this); if (!p) return false;
			var d=createTiddlyElement(p,&quot;div&quot;);
			d.style.whiteSpace=&quot;normal&quot;; d.style.width=&quot;auto&quot;; d.style.padding=&quot;2px&quot;;
			// gather pretty links for changed tiddlers
			var list=[]; var item=&quot; &amp;nbsp;[[%1 - %0 (%2 bytes)|%0]]&amp;nbsp; &quot;;
			for (var i=config.macros.unsavedChanges.changed.length-1; i&gt;=0; i--) {
				var tid=store.getTiddler(config.macros.unsavedChanges.changed[i]);
				if (!tid) continue;
				var when=tid.modified.formatString('YYYY.0MM.0DD 0hh:0mm:0ss');
				list.push(item.format([tid.title,when,tid.text.length]));
			}
			wikify(&quot;@@white-space:nowrap;&quot;+list.join(&quot;&lt;br&gt;&quot;)+&quot;@@&quot;,d);
			var t=&quot;\n----\n&quot;;
			t+=&quot;@@white-space:nowrap;display:block;text-align:center; &amp;nbsp;&quot;;
			if (!readOnly) {
				t+=&quot;&lt;&lt;saveChanges&gt;&gt;&quot;;
				t+=config.macros.saveAs?&quot; | &lt;&lt;saveAs&gt;&gt;&quot;:&quot;&quot;;
				t+=config.macros.upload?&quot; | &lt;&lt;upload&gt;&gt;&quot;:&quot;&quot;;
				t+=(config.macros.emptyTrash&amp;&amp;store.getTaggedTiddlers(&quot;Trash&quot;).length)?&quot; | &lt;&lt;emptyTrash&gt;&gt;&quot;:&quot;&quot;;
			} else {
				t+=config.macros.saveAs?&quot;&lt;&lt;saveAs&gt;&gt;&quot;:&quot;&quot;;
			}
			t+=&quot;&amp;nbsp; @@&quot;;
			wikify(t,d);
			Popup.show();
			ev.cancelBubble=true; if(ev.stopPropagation)ev.stopPropagation();
			return(false);
		}
		createTiddlyButton(place,txt,tip,action,&quot;button&quot;);
	},
	panel: function(place) { // show composite droplist+buttons+commands
		// gather changed tiddlers (in reverse order by date - most recent first)
		var tids=[]; for (var i=this.changed.length-1; i&gt;=0; i--)
			{ var t=store.getTiddler(this.changed[i]); if (t) tids.push(t); }
		tids.sort(function(a,b){return a.modified&lt;b.modified?-1:(a.modified==b.modified?0:1);});
		// generate droplist items
 		var list=[]; var item='&lt;option value=&quot;%0&quot;&gt;%1 - %0 (%2 bytes)&lt;/option&gt;';
		for (var i=tids.length-1; i&gt;=0; i--) {
			var when=tids[i].modified.formatString('YYYY.0MM.0DD 0hh:0mm:0ss');
			list.push(item.format([tids[i].title.htmlEncode(),when,tids[i].text.length]));
		}
		// display droplist, buttons, and command links
		var out=''; var c=this.changed.length;
		var NSP=config.formatters.findByField(&quot;name&quot;,&quot;nestedSliders&quot;);
		var summary=this.defLabel.format([c,c==1?'is':'are',c==1?'':'s'])
		out+=NSP?'+++(unsaved)['+summary+'|'+this.defTip+']...':(summary+&quot;\n&quot;);
		out+='&lt;html&gt;&lt;form style=&quot;display:inline&quot;&gt;&lt;!--\
			--&gt;&lt;select size=&quot;1&quot; name=&quot;list&quot; \
				title=&quot;select a tiddler to view&quot; \
				onchange=&quot;var v=this.value; if (v.length) story.displayTiddler(null,v);&quot;&gt;&lt;!--\
			--&gt;'+list.join('')+'&lt;!--\
			--&gt;&lt;/select&gt;&lt;!--\
			--&gt;&lt;input type=&quot;button&quot; value=&quot;goto&quot; onclick=&quot;this.form.list.onchange();&quot;&gt;';
		if (config.macros.loadTiddlers)  {
			out+='&lt;input type=&quot;button&quot; value=&quot;revert&quot; \
				title=&quot;import the last saved version of this tiddler&quot; \
				onclick=&quot;var v=this.form.list.value; if (!v.length) return; \
					var t=\'&lt;\'+\'&lt;loadTiddlers [[tiddler:\'+v+\']] \'; \
					t+=document.location.href; \
					t+=\' confirm force noreport&gt;\'+\'&gt;\'; \
					var e=document.getElementById(\'executeRevert\'); \
					if (e) e.parentNode.removeChild(e); \
					e=document.createElement(\'span\'); \
					e.id=\'executeRevert\'; \
					wikify(t,e);&quot;&gt;';
		}
		out+='&lt;/form&gt;&lt;/html&gt;';
		out+='\n{{small nowrap{';
		if (!readOnly) {
			out+=&quot;&lt;&lt;saveChanges&gt;&gt;&quot;;
			out+=config.macros.saveAs?&quot; | &lt;&lt;saveAs&gt;&gt;&quot;:&quot;&quot;;
			out+=config.macros.upload?&quot; | &lt;&lt;upload&gt;&gt;&quot;:&quot;&quot;;
			out+=(config.macros.emptyTrash&amp;&amp;store.getTaggedTiddlers(&quot;Trash&quot;).length)?&quot; | &lt;&lt;emptyTrash&gt;&gt;&quot;:&quot;&quot;;
		} else {
			out+=config.macros.saveAs?&quot;&lt;&lt;saveAs&gt;&gt;&quot;:&quot;&quot;;
		}
		out+='}}}';
		out+=NSP?'===':'';
		wikify(out,place);
	}
};

// hijack store.saveTiddler() to track changes to tiddlers
if (store.showUnsaved_saveTiddler==undefined) {
	store.showUnsaved_saveTiddler=store.saveTiddler;
	store.saveTiddler=function(title,newtitle) {
		if (title!=newtitle) {
			var i=config.macros.unsavedChanges.changed.indexOf(title);
			if (i!=-1) config.macros.unsavedChanges.changed.splice(i,1); // remove old from list
		}
		var i=config.macros.unsavedChanges.changed.indexOf(newtitle);
		if (i!=-1) config.macros.unsavedChanges.changed.splice(i,1); // remove new title from list
		config.macros.unsavedChanges.changed.push(newtitle); // add new title to END of list
		var t=this.showUnsaved_saveTiddler.apply(this,arguments);
		if (!this.notificationLevel) config.macros.unsavedChanges.refresh();
		return t;
	}
}

// hijack store.removeTiddler() to track changes to tiddlers
if (store.showUnsaved_removeTiddler==undefined) {
	store.showUnsaved_removeTiddler=store.removeTiddler;
	store.removeTiddler=function(title) {
		var i=config.macros.unsavedChanges.changed.indexOf(title);
		if (i!=-1) config.macros.unsavedChanges.changed.splice(i,1); // remove from list
		this.showUnsaved_removeTiddler.apply(this,arguments);
		if (!this.notificationLevel) config.macros.unsavedChanges.refresh();
	}
}

// hijack store.setDirty() function to reset change list after file save
// note: do NOT hijack the prototype function.  This hijack should only be applied to
// the main 'store' instance only (i.e., don't refresh when loading temporary store
// as part of ImportTiddlers processing)
if (store.showUnsaved_setDirty==undefined) {
	store.showUnsaved_setDirty=store.setDirty;
	store.setDirty = function(flag) {
		var refresh=this.isDirty() &amp;&amp; !flag; // 'dirty' to 'clean', force a refresh...
		this.showUnsaved_setDirty.apply(this,arguments); // but change the flag first.
		if (refresh) {
			config.macros.unsavedChanges.changed=[]; // clear changed list
			config.macros.unsavedChanges.refresh();
		}
	}
}
//}}}</pre>
</div>
<div title="ViewTemplate" modifier="John Hind" created="200903111549" modified="201103021328" tags="setup template excludeSearch excludeLists excludeMissing">
<pre>&lt;!--{{{--&gt;
&lt;div class='viewHeading'&gt;
&lt;div class='toolbar' style='' macro='toolbar [[ToolbarCommands::ViewToolbar]]'&gt;&lt;/div&gt;
&lt;span class='title' macro='view title'&gt;&lt;/span&gt;
&lt;div class='subtitle fine'&gt;&lt;span macro=&quot;tiddlerSubtitle 'DDth mmm YYYY' '0hh:0mm' 'DDth mmm'&quot;&gt;&lt;/span&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;div class='tagging' macro='tagging'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="ViewTemplateReadOnly" creator="John Hind" modifier="John Hind" created="201102171110" modified="201102192102" tags="setup template excludeSearch excludeLists excludeMissing" changecount="5">
<pre>&lt;!--{{{--&gt;
&lt;div class='viewHeading'&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::ViewToolbarReadOnly]]'&gt;&lt;/div&gt;
&lt;span class='title' macro='view title'&gt;&lt;/span&gt;
&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;div class='viewer' macro='view text wikified'&gt;&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;div class='toolbar' style='line-height:100%;margin-top:.5em;'&gt;&lt;a href=&quot;javascript:;&quot;
	onclick=&quot;window.scrollTo(0,ensureVisible(story.findContainingTiddler(this)));return false;&quot;
	onmouseover=&quot;this.title='scroll to top of '+story.findContainingTiddler(this).getAttribute('tiddler')&quot;&gt;&amp;#x25b2;&lt;/a&gt;
&lt;/div&gt;
&lt;div class='tagClear'&gt;&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="WM table" creator="John Hind" modifier="John Hind" created="201005302013" modified="201311231450" changecount="1">
<pre>The WM table is installed by a standard Lua script stored in a resource and loaded when the ''winsh'' library is loaded. It contains constant definitions for a number of Windows messages which may be useful to use in [[winsh.onevent]].
;{{{WM.ENDSESSION}}}
:Occurs when the user is about to be logged off. If the lparam parameter is zero, the system is about to shut down.
;{{{WM.DEVICECHANGE}}}
:Occurs when there is a change to the hardware configuration of the computer. Use values from the DBT table as wpfilter to further refine the event:
|{{{DBT.CONFIGCHANGED}}}|Dock or undock operation.|
|{{{DBT.DEVICEARRIVAL}}}|New device or media mounted (e.g. USB drive or CD inserted)|
|{{{DBT.DEVICEPENDING}}}|Device or media about to be removed.|
|{{{DBT.DEVICEREMOVED}}}|Device or media dismounted (e.g. USB drive or CD removed)|
;{{{WM.POWERBROADCAST}}}
:Occurs when power status changes i.e. battery low or change from battery to mains. Use values from the PBT table as wpfilter to further refine the event:
|{{{PBT.BATTERYLOW}}}|Battery power is low|
|{{{PBT.POWERSTATUS}}}|Power status changed|
|{{{PBT.SUSPEND}}}|System is about to suspend|
|{{{PBT.RESUMEAUTO}}}|Resumed to handle an event|
|{{{PBT.RESUMECRITICAL}}}|Resumed from a critical suspension|
|{{{PBT.RESUMESUSPEND}}}|Resumed from a normal suspension|
;{{{WM.DISPLAYCHANGE}}}
:Occurs when a change to the display configuration (i.e. number of monitors or resolution) happens.
;{{{WM.TIMECHANGE}}}
:Occurs when there is a time discontinuity (i.e. a clock correction or a switch from or to daylight savings time).
;{{{WM.USERCHANGED}}}
:Occurs when a user logs on or off.
;{{{WM.SETTINGCHANGE}}}
:Occurs when there is a change to system parameters or policies.
;{{{WM.THEMECHANGED}}}
:Occurs when the visual theme is changed.
;{{{WM.SPOOLERSTATUS}}}
:Occurs when a job is added or removed from the print queue.
;{{{WM.FONTCHANGE}}}
:Occurs when there is a change to the fonts available on the system.
;{{{WM.DEVMODECHANGE}}}
:Occurs when the user changes the settings for a hardware device.
</pre>
</div>
<div title="WM.CLIPBOARDUPDATE Event" creator="John Hind" modifier="John Hind" created="201311231356" modified="201402151141" changecount="3">
<pre>Triggered when new data is written to the clipboard.
{{{
winsh.onevent(WM.CLIPBOARDUPDATE, function() print(&quot;Clipboard Updated&quot;) end)
}}}
See [[winsh.onevent]].

''NOTE:'' This event is not supported in Windows XP.</pre>
</div>
<div title="WebCollapsedTemplate" creator="John Hind" modifier="John Hind" created="201102181002" modified="201102192117" tags="BasicsPackage template excludeSearch excludeLists excludeMissing" changecount="6">
<pre>&lt;!--{{{--&gt;
&lt;div class='viewHeadingC'&gt;
&lt;div class='toolbar' macro='toolbar [[ToolbarCommands::CollapsedToolbarReadOnly]]'&gt;&lt;/div&gt;
&lt;div class='title' macro='view title'&gt;&lt;/div&gt;
&lt;/div&gt;
&lt;!--}}}--&gt;</pre>
</div>
<div title="Winsh Executables" creator="John Hind" modifier="John Hind" created="201005292232" modified="201410031000" changecount="10">
<pre>Winsh.lua is supplied with a number of different executable builds. For a given application, you should select the most appropriate build and copy and rename it to the required location. Winsh Executables are very compact and it is intended that you use one copy of the executable per application rather than using the same executable to run multiple applications as you might with other scripting systems. This has the advantage that no installation is required, and there is no danger of customisations for one application breaking another. A Winsh Executable has no dependencies apart from standard Windows (XP or above) and can easily be run from a Memory Stick, USB Hard Drive or DVD. Unless specifically scripted to do so, running a Winsh Executable leaves no permanent trace on the machine on which it is run.

The different template executable builds differ in the libraries compiled into them, whether Lua is compiled in or in a separate DLL file, the ''subsystem flag'' and certain default settings.

Versions with Lua compiled into the executable are able to produce stand-alone applications with the scripting stored as resources in the file. However these applications cannot use {{{require}}} to load non-Lua libraries (DLL Libraries). The versions that use a separate Lua DLL can work with such libraries, but require {{{WinshLua.dll}}} in addition to the exe file and any other library DLL files. It is recommended to use the [[Side-by-side Execution]] model for such applications and to place {{{WinshLua.dll}}} in the side-by-side folder along with the script files and any DLL libraries.

The ''subsystem flag'' is a feature of the Windows executable format with two alternative settings:
;Windows Subsystem
:This is the normal setting for [[Resident Applications]]. It specifies that the application should run asynchronously by default (meaning that, if started from a command console, the console will present a new prompt immediately rather than waiting for it to complete). However, you can run these versions synchronously using the DOS {{{start /wait}}} command prefix. The versions with this flag will not process file redirection or piping on the command-line. By default, errors are presented on the [[Interactive Console]].
;Console Subsystem
:This is the normal setting for [[Console Applications]]. Winsh versions with this flag run synchronously by default and will correctly handle file redirection and piping on the command line. By default, errors are reported on the text-mode command console. However these versions will do everything the Windows Subsystem versions do, the only real disadvantage being when they are started from the Windows GUI  they briefly flash a text-mode command console on the screen.
Once you have copied a template Winsh Executable, you can further customise using the [[Resource Editor]] to add scripts and icons and change various configuration options.

Pre-compiled Winsh.lua executables are supplied according to a naming convention. The root of the name reflects the set of libraries that are compiled into the executable and this is followed by a two-letter suffix. The first letter is either {{{W}}} or {{{C}}} for the Windows or Console subsystem flag and the second letter is either {{{S}}} or {{{D}}} for a stand-alone version or a version that requires the {{{WinshLua.dll}}} file (which is also supplied pre-compiled).
</pre>
</div>
<div title="Winsh Library" creator="John Hind" modifier="John Hind" created="201005302034" modified="201402211712" changecount="12">
<pre>The Winsh Library exposes the basic UI elements, message handling and operating system facilities of Winsh.lua.
!!Functions
[[winsh.setidentity]] - Set the name and icon.
[[winsh.outputmode]] - Set the error and output reporting.
[[winsh.setfile]] - Set a file for logging or reading.
[[winsh.file]] - Read a text file line-by-line.
[[winsh.setreport]] - Control the Report Window.
[[winsh.lasterror]] - Return the last error message.
[[winsh.onevent]] - Hook an action to a Windows or Winsh event.
[[winsh.spawn]] - Run a script in a new process.
[[winsh.mutex]] - Find another process and send it a message.
[[winsh.environment]] - Get or translate environment strings.
[[winsh.taskicon]] - Install or change a taskbar icon and context menus.
[[winsh.balloon]] - Show a balloon message on the taskbar icon.
[[winsh.messagebox]] - Show a message in a message box.
[[winsh.hotkey]] - Hook a Lua function to a Windows hotkey.
[[winsh.waitkey]] - Show a prompt and wait for a key in console mode.
[[winsh.kbhit]] - Test if a key is hit in console mode.
[[winsh.loadscript]] - Load a script from a file or resource.
[[winsh.ps]] - Prepare a parameter string for [[winsh.spawn]] or [[winsh.mutex]].
!!Classes
[[Command Class]] - Defines a command for menus, hotkeys or events.
[[Menu Class]] - Defines menus.
</pre>
</div>
<div title="application.BaseName" creator="John Hind" modifier="John Hind" created="201311061102" modified="201402151150" changecount="3">
<pre>String key which only exists while the process is running. This string is for information only and contains the base name of the process which may be useful for identification purposes. Often it will be the full or partial path of the executable file, but it is arbitrarily set by the process code and may be any string or empty.

''NOTE:'' This field may not be supported on Windows XP.</pre>
</div>
<div title="application.Command" creator="John Hind" modifier="John Hind" created="201311052218" modified="201402092043" changecount="7">
<pre>String field containing the command line used to start the application. This is usually set on creation of the Application object, but it may be modified as required. It is acted on in the [[application:open]] method. This string works in the same way as the 'Target' field in a Windows shortcut.

This field is created automatically when an Application object is created for an existing process. In this case it will contain the full path to the application executable. This enables the process represented by the Application object to be closed and subsequently re-opened. This works automatically in many cases, but in some cases it may be necessary to add command switches and to fill in the [[application.Directory]], [[application.Environment]] and [[application.WindowFrame]] fields to exactly duplicate the original process.

Tip: in Lua you can use paired square brackets to delimit a string literally without escape characters, including backslashes and quote marks without requiring special handling. For example:
{{{
[[&quot;C:\Program Files\appco\theapp.exe&quot; /c]]
}}}
Any environment tokens embedded in the command string are expanded using the environment of the Winsh process. It is advisable to use environment strings were possible rather than hard-coded directories since these may change from machine to machine and between 32-bit and 64-bit operating systems. For example, to start an application use something like:
{{{
[[&quot;%ProgramFiles%\appco\theapp.exe&quot; /c]] 
}}}
Rather than the earlier example which will only work on 32-Bit operating systems with default installation settings.
</pre>
</div>
<div title="application.Directory" creator="John Hind" modifier="John Hind" created="201311052246" modified="201402092041" changecount="5">
<pre>Optional string field specifying the directory in which the application is started. This is usually set on creation of the Application object, but it may be modified as required. It is acted on in the [[application:open]] method. Any environment variables in the string are resolved using the environment of the Winsh process prior to use. This string works in the same way as the 'Start in' field in a Windows shortcut.</pre>
</div>
<div title="application.Environment" creator="John Hind" modifier="John Hind" created="201311052254" modified="201402092040" changecount="3">
<pre>Optional Table field containing the environment names and strings. This is acted on in the [[application:open]] method. If it is missing the new process inherits the environment of the Winsh process. To supply a modified current environment, use [[winsh.environment]] to get the environment of the Winsh process and modify it as necessary referencing the modified table in this field.

The format of the table is string keys and string values each entry representing a name/value pair in the environment. The table may be a raw Lua table or an object of the [[Table Class]].</pre>
</div>
<div title="application.ExitCode" creator="John Hind" modifier="John Hind" created="201311011725" modified="201311022053" changecount="2">
<pre>!application.~ExitCode
This number field is only present after an application has been closed. It is set to the exitcode returned by the application process when it terminates. Usually this is only relevant for command-line applications and will be 0 for success or an application supplied error code.
</pre>
</div>
<div title="application.ImagePath" creator="John Hind" modifier="John Hind" created="201311061058" modified="201402151152" changecount="2">
<pre>String key which only exists while the process is running. This string is for information only and contains the complete path to the executable file of the process. Similar to [[application.Command]] except that any partial or relative path or any environment strings are fully resolved and the string does not contain any command switches. When an Application object is created for an existing process, [[application.Command]] will initially be identical to this string but will persist when the application is closed.

''NOTE:'' This field is not supported on Windows XP.</pre>
</div>
<div title="application.OnClose" creator="John Hind" modifier="John Hind" created="201006021939" modified="201311261738" changecount="5">
<pre>!application.~OnClose
A Lua callable object ([[Command Class]] object, object of [[DelegateList Class]] or a simple Lua function for example) assigned to this field will be called when the application is closed.
</pre>
</div>
<div title="application.WindowFrame" creator="John Hind" modifier="John Hind" created="201311060947" changecount="1">
<pre>Optional field containing an object of the [[Frame Class]]. If present this is used in the [[application:open]] method to request a particular window position and (optionally) size. Note that this is merely a request: the application may ignore it completely or adjust it. In particular, most applications impose a minimum size. The position and size of the window can be modified subsequently using the [[application:windowframe]] method. The advantage of the field, when the application responds to it, is that the moving and resizing is not visible to the user.</pre>
</div>
<div title="application:close" creator="John Hind" modifier="John Hind" created="201006021933" modified="201402211755" changecount="9">
<pre>!res = application:close([key])
Close the current window of an application or the entire application and returns {{{true}}} if successful. If supplied, ''key'' must be a string key, one of:
;'''app'''
:By default, only the current window is closed (but if there is just one window this should result in orderly shutdown of the entire application). If this key is specified all the windows of the application are closed which should result in orderly shutdown of the entire application.
;'''force'''
:If this is specified, an attempt is made to close all the windows of the application and if this does not result in application closure, the application is then forced closed (which may result in loss of un-saved data).
</pre>
</div>
<div title="application:open" creator="John Hind" modifier="John Hind" created="201006021930" modified="201402211747" changecount="22">
<pre>!res = application:open( ... )
Executes the command line in the [[application.Command]] field and stores the resulting process and window information.

Any number of string parameters may be supplied which form a set  any combination of the first three keys may be provided in any order optionally combined with one of the last three. The keys are:
;'''sync'''
:If this key is specified, this method does not return until the process started terminates and the method returns the process exit code (a number).
;'''noconsole'''
:Applies only to console (as opposed to UI) applications and it causes the console window to be hidden (so the command runs invisibly in the background). 
;'''comspec'''
:Runs the command line in the command interpreter specified by the '~ComSpec' environment variable (usually cmd.exe). This allows execution of batch files and commands such as Format in a console window. Depending on whether '''noconsole''' is also specified, /K or /C switch is prefixed to the command line so the console either remains or is automatically closed once the command completes.
;'''minimized'''
:Requests that the main window be started minimized.
;'''maximized'''
:Requests that the main window be started maximized.
;'''hidden'''
:Requests that the main window be started hidden.
This method also uses the following fields if present to control the creation of the application: [[application.Directory]], [[application.Environment]] and [[application.WindowFrame]]. The main window state keys and the [[application.WindowFrame]] field may or may not be acted upon depending on the application. The same effect can be obtained later by using the [[application:windowstate]] or [[application:windowframe]] methods on the initial window, but the window changes will then be visible to the user.

Unless the '''sync''' key is specified, this method returns immediately with a boolean return value {{{true}}} if the process was successfully started. The method always returns boolean {{{false}}} if the process could not be started. When the process subsequently terminates, any functions added to the [[application.OnClose]] field get called and the exit code may be accessed in the [[application.ExitCode]] field. When the '''sync''' key is specified, the return value is the process exit code.
</pre>
</div>
<div title="application:sendkeys" creator="John Hind" modifier="John Hind" created="201311011749" modified="201311071217" changecount="16">
<pre>!res = application:sendkeys([keylist])
Makes the current window of this application the active window (the one that responds to user input) and optionally sends some simulated mouse button presses or keyboard key strokes to it. ''keylist'' may be any number of string and number values which represent the operations to be simulated. Returns boolean {{{true}}} if the correct window was successfully activated.
;String Parameters
:Each individual character in the string is sent as key-down immediately followed by key-up.
;Number Parameters 0..255
:Virtual keycode from the VK table (defined in the Lua annex to the [[Winsh Library]]). The ASCII codes for '0'..'9' and 'A'..'Z' are also valid VK values for the like labeled keys (in Lua these codes can be generated by, for example, {{{string.byte(&quot;A&quot;)}}}). The first time a particular VK value occurs it is sent as a key-down and subsequent occurrences alternate between key-up and key-down. Key-up is sent for any VK values that are in the down state once all the parameters have been processed, in arbitrary order (this makes sure keys are not left in an anomalous state).
;Number Parameters outside the range 0..255
:Generate a quarter second delay in the key operations sequence (a constant {{{VK.DELAY}}} is added by the Lua annex to this library to represent this).
The method used to activate a window is best described as &quot;somewhat hairy&quot; and cannot be guaranteed to work in all cases or on all versions of Windows (Microsoft does its best to make it difficult to hijack the user's focus, for understandable reasons). However this method should always work when the target window is already active and should never send keystrokes to the wrong window.
</pre>
</div>
<div title="application:window" creator="John Hind" modifier="John Hind" created="201311011555" modified="201402211756" changecount="21">
<pre>!index = application:window([spec])
Returns an index to the 'current window' of the application after optionally changing it. Most applications have just one top-level window (or none for command-line applications). Other methods which operate on a window use the 'current window' which will be the only window in most cases, but can be changed using this function for multi-window applications. Note that 'current window' is used internally by other methods and is different from the 'active' window from the user's point of view.
|''spec''|Action|h
|'''current'''|(the default) No change|
|'''first'''|Select the lowest indexed window|
|'''next'''|Select the next higher indexed window or wraps from the highest to the lowest|
|'''previous'''|Select the next lower indexed window without wrapping|
|'''cbowner'''|Select the window that wrote the current clipboard data|
| //n// |(number) Select the window with the given index|
In all cases, returns the index of the (new) 'current window' if a window meeting the specification is available, otherwise returns {{{nil}}} and does not change the 'current window'. '''next''' will only return {{{nil}}} if there is fewer than 2 windows. '''first''' and '''current''' will only return {{{nil}}} if there are no windows.

Note that when an Application object is created for an existing application or opened for a new application, the top level windows are assigned contiguous indexes from 1 up, and the 'current window' is set to 1. However windows may subsequently be closed. When this is detected, that index is not reassigned leaving a hole in the sequence. If new windows are detected they are assigned new contiguous indexes above the pre-existing ones. This ensures that a given index always references the same window (or no window). '''next''' and '''previous''' skip over indexes that no longer refer to windows, so '''next''' will always cycle through all the windows available at that time. If the 'current window' is closed, the system automatically uses '''next''' to assign a new 'current window' (if there are no windows, there will be be no 'current window').
</pre>
</div>
<div title="application:windowframe" creator="John Hind" modifier="John Hind" created="201311011719" modified="201402051549" changecount="4">
<pre>!frame = obj:windowframe([newframe])
Optionally sets the frame of the current window and returns the (possibly changed) window frame. The frame is an object of the [[Frame Class]] which represents the size and position of the window. ''newframe'' may include the position and size or just the position (in which case the window is moved but the size is not changed). Note that an application may limit its minimum and/or maximum size so the size returned may not be the same as that requested.
</pre>
</div>
<div title="application:windowstate" creator="John Hind" modifier="John Hind" created="201006021938" modified="201402092025" changecount="3">
<pre>!state = obj:windowstate([newstate])
The window state is described by a string key '''normal''', '''minimized''', '''maximized''', or '''hidden'''. This method optionally sets the current window into a new state and returns the (possibly changed) window state.
</pre>
</div>
<div title="application:windowtitle" creator="John Hind" modifier="John Hind" created="201311011721" changecount="1">
<pre>!title = obj:windowstate()
Returns the title text of the current window (a string).</pre>
</div>
<div title="bitfield operations" creator="John Hind" modifier="John Hind" created="201312221540" modified="201402041058" changecount="4">
<pre>The width of a bitfield is returned by the length operator:
{{{
bf = Bitfield(7)
print(#bf, 7)
}}}
Individual bits may be indexed within a bitfield using an unsigned integer {{{1..256}}} (indexing a bit beyond the width of the bitfield reads {{{false}}} and causes a write operation to be ignored).
{{{
bf[4] = true
print(bf, &quot;0001000&quot;)
bf[1] = not bf[1]
print(bf, &quot;0001001&quot;)
for i=1, #bf do bf[i] = not bf[i] end
print(bf, &quot;1110110&quot;)
}}}
There are no multi-bit logical operations, instead operations of arbitrary complexity can be constructed using Lua boolean operations and {{{for}}} loops in combination with bitfield indexing as in the last line above.

Bitfields can also be indexed using range index strings produced by the [[bitrange function]] and [[range names]].

A {{{__tostring}}} metamethod is defined to convert the bitfield into a binary string format, enabling the standard Lua {{{tostring}}} and {{{print}}} functions.

Equality between two bitfields is defined as {{{true}}} only if the two are the same width and all the bits are the same.
{{{
print(Bitfield(&quot;10&quot;) == Bitfield(&quot;10&quot;), &quot;true&quot;)
print(Bitfield(&quot;10&quot;) == Bitfield(&quot;1&quot;), &quot;false&quot;)
print(Bitfield(&quot;10&quot;) == Bitfield(&quot;01&quot;), &quot;false&quot;)
}}}</pre>
</div>
<div title="bitrange function" creator="John Hind" modifier="John Hind" created="201312221434" modified="201402100929" changecount="6">
<pre>!ix = bitrange([format,][ first[, last]][, val])
Returns a range key (implemented as an opaque four character string) or a constant which is a range key followed by a value in packed format (concatenated into a single string). Use this function as the index to an object of [[Bitfield Class]] or to create the value for an entry in a Named Range Table of an object of this class.

If ''type'' is supplied it must be one of the string keys '''boolean''', '''bitfield''', '''binary''', '''unsigned''', '''packed''', '''const''' or '''uconst'''. If omitted, defaults to '''boolean''' for a single bit range, to '''unsigned''' for a multi-bit range that fits in the 'lua_Unsigned' type (32 bits or less in the standard Lua build), otherwise '''binary'''.

If ''first'' is omitted, the range covers the entire width of the bitfield. If supplied, ''first'' must be a number {{{1..256}}} specifying the starting index of the range. ''last'' must be {{{first..256}}} or omitted, in which case it defaults to ''first'' producing a single bit range.

''val'' is ignored unless ''type'' is '''const''' or '''uconst'''. It may be a boolean, a binary string or a number (unsigned). For '''const''', ''first'' must also be provided and ''last'' must be provided if ''val'' is a number. For '''uconst''', ''first'' is interpreted as the length in bits and need only be provided if ''val'' is a number. ''last'' must be omitted in this case.
{{{
bf = Bitfield(&quot;10011001&quot;)
print(tostring(bf[bitrange(3)]), &quot;false&quot;)
print(bf[bitrange(3,6)], 6)
print(bf[bitrange('bitfield',1,4)], &quot;1001&quot;)
print(bf[bitrange('binary',1,4)], &quot;1001&quot;)
print(bf[bitrange('unsigned',1)], 1)
bf[bitrange(1,4)] = 15
print(bf, &quot;10011111&quot;)
bf[bitrange('binary',1,4)] = &quot;1001&quot;
print(bf, &quot;10011001&quot;)
print(bf[bitrange('unsigned')], 153)
print(bf[bitrange('binary')] == tostring(bf), &quot;true&quot;)
}}}
</pre>
</div>
<div title="class.checkmethod" creator="John Hind" modifier="John Hind" created="201311231553" modified="201401091356" changecount="4">
<pre>!class.checkmethod(p1, p2)
When creating a new Class in Lua, this function should be used in the first statement of each method. It raises an error if the method is called incorrectly. The form of the call should always be as follows:
{{{
class.checkmethod(self, _TID)
}}}
This protocol also ensures that the ''_TID'' upvalue is present in each method.
</pre>
</div>
<div title="class.gettid" creator="John Hind" modifier="John Hind" created="201312141610" modified="201402100942" changecount="16">
<pre>!tid, typ = class.gettid(val)
Low-level support function which returns the TID (type ID) of a value. A second string key return classifies ''val'' as follows: '''class'''; '''object_mf''' - object with metamethod TID; '''object_mt''' - object with metatable TID; '''object_fn''' - object implemented as function closure; '''type''' - non-object Lua value. With the implementation used for the classes provided by this library, the TID of the Class is the metatable for objects of that class. The TID of the class has ''typ'' '''class''' and the TID of objects has ''typ'' '''object_mt'''.

The TID is determined by applying the following rules in order:
# If ''val'' has a metafield {{{__tid}}}, the value of this is the TID.
# If ''val'' is a table or userdata with a metatable, this is the TID.
# If ''val'' is a function with an upvalue whose name begins with the string  &quot;_TID&quot;, this is the TID.
# If ''val'' is a function having at least two upvalues, the first of which is unnamed and has a string value beginning &quot;_TID&quot;, the TID is the second upvalue.
# The TID is a string, the Lua type name of ''val''.
Note that the TID may be a value of any type. The TID of an object and that of a class should be Lua equal if and only if the object is an object of the class (except if the TID values are Lua equal functions, in which case the membership test is delegated to that function). The TID of a Class is determined from rule 3 or 4 and a function is not a class unless one of these rules applies and the marker is exactly &quot;_TID&quot;. Any suffix on the marker indicates that the function is an object, but not a class.
</pre>
</div>
<div title="class.istype" creator="John Hind" modifier="John Hind" created="201311231547" modified="201402131151" changecount="34">
<pre>!res = class.istype(val, type)
Returns boolean {{{true}}} if ''val'' is of ''type'', else Boolean {{{false}}}. This works for any Lua value and has special handling for the Class system supported by this library. If ''type'' is neither a string nor a class, the result is {{{true}}} if the two parameters are of the same class or type.

If ''type'' is a string, it is treated as a type classifier key. Type classifiers comprise the standard Lua type names ('''nil''', '''number''', '''boolean''', '''string''', '''table''', '''function''', '''userdata''' or '''thread''') or one of the following additional classifiers:
;'''class'''
:A function with the specific upvalue pattern for a class.
;'''object'''
:A table or userdata with a metatable, or a function with the TID upvalue pattern. Note that a class is also an object.
;'''rawtable'''
:A table without a metatable.
;'''callable'''
:A function, or any value with a {{{__call}}} metamethod.
If ''type'' is not a string, [[class.gettid]] is applied to both ''val'' and ''type'' and the resultant TID values compared using the following rules (in order):
# If the &quot;&quot;&quot;TIDs&quot;&quot;&quot; are both the same function, then the result of the comparison is the boolean interpretation of the first return value from calling that function passing it ''val'' and ''type''.
# If the TID of ''val'' is a table with an entry keyed {{{1}}}, the TID of ''type'' is compared to this entry and to all other values keyed with consecutive integers and any match returns {{{true}}}.
# If the TID of ''val'' is its metatable, the TID of ''type'' is compared to this, and then to the metatable of the metatable and so on until a match is found and the function returns {{{true}}} or there are no more metatables.
# Otherwise the result is a Lua comparison between the TID values (honoring any equality metamethods in the usual way).
Examples:
{{{
lst = List{}
dlt = DelegateList{}
print(istype(1.1, 'number'), &quot;true&quot;)
print(istype(1.1, 365), &quot;true&quot;) -- both 'number' type
print(istype(List, 'class'), &quot;true&quot;) -- List is a class
print(istype(List, 'object'), &quot;true&quot;) -- Class is also an object.
print(istype({}, 'object'), &quot;false&quot;) -- No metatable, so not an object.
print(istype(dlt, 'object'), &quot;true&quot;)
print(istype(List, 'function'), &quot;true&quot;) -- A class is also a function
print(istype(lst, List), &quot;true&quot;) -- List object is of List class
print(istype(lst, 'table'), &quot;true&quot;) -- List object is based on Lua 'table' type
print(istype(lst, {}), &quot;true&quot;) -- List object is based on the same type as a Lua table
print(istype(dlt, List), &quot;true&quot;) -- DelegateList inherits List
print(istype(lst, DelegateList), &quot;false&quot;) -- List does not inherit DelegateList
print(istype({}, 'rawtable'), &quot;true&quot;) -- Table constructor makes a raw table
print(istype(lst, 'rawtable'), &quot;false&quot;) -- List object is based on table, but is not raw
print(istype(function() end, 'callable'), &quot;true&quot;) -- function is callable
print(istype(dlt, 'callable'), &quot;true&quot;) -- DelegateList is callable
print(istype(lst, 'callable'), &quot;false&quot;) -- List is not callable
print(istype(123, 'callable'), &quot;false&quot;) -- number is not callable
}}}
</pre>
</div>
<div title="class.newmeta" creator="John Hind" modifier="John Hind" created="201402021123" modified="201402121547" changecount="2">
<pre>!_TID = class.newmeta()
!_TID, _PC = class.newmeta(parent)
Returns a new metatable for a class with the index metamethod already set. If supplied with a parent class, recovers the metatable from this and sets it as the metatable of the new metatable and passes the parent class through as a second return value.

This is a convenience helper for creating classes using [[Class Pattern: Metatable]].
</pre>
</div>
<div title="class.newproto" creator="John Hind" modifier="John Hind" created="201402121530" modified="201402121553" changecount="2">
<pre>!class, proto, meta = class.newproto(...)
Returns a newly created class (function closure), a reference to the prototype table and a reference to the metatable for the class. Also takes one or more prototype-based objects which are merged into the class prototype table.

This is used for creating classes using [[Class Pattern: Prototype]].

Input prototypes are merged left to right (so the same field in a prototype to the right overrides one to the left). Entries from both the object table and its metatable are merged into the new prototype and meta tables. The TID of the resultant class is the metatable. The metatables of input prototypes are stored in the new metatable as numerically keyed values in parameter order. This means that [[class.istype]] will return true if an object of the generated class is compared with the class of any of the objects aggregated to form it (or of its own class).

The classes generated by this function may be called with no parameters or with a single table parameter to generate a new object. This initialisation table must only contain keys which match existing keys in the prototype table and which do not begin with an underscore (which are assumed to be private fields). Typically, this should be used to override field values but not methods, although this is not prevented.
</pre>
</div>
<div title="com.Port Class" creator="John Hind" modifier="John Hind" created="201410112035" changecount="1">
<pre>!ftdiport = ftdi.Port{ ... }
Returns an open Port Object or Boolean {{{false}}} and a string error description. The named parameters must include ''index'' with a value being a number 1..255, an existing port which is not already open.

Other named parameters configure the port selected. They are all optional (if absent the given default value is used) and may include any combination of the following:

|KEY|VAL TYPE|VALUE|DEFAULT|h
|'''baudrate'''|Number|Baud rate for UART communications|{{{2400}}}|
|'''wordlength'''|Number|{{{7}}} or {{{8}}}|{{{8}}}|
|'''stopbits'''|Number|{{{1}}} or {{{2}}}|{{{1}}}|
|'''parity'''|String|'''none''', '''odd''', '''even''', '''mark''', '''space'''|'''none'''|
|'''flowcontrol'''|String|'''none''', '''rtscts''', '''dtrdsr''', '''xonxoff'''|'''none'''|
|'''xon'''|Number|Character code {{{0..255}}} used as xon in '''xonxoff''' flowcontrol|{{{0x11}}}|
|'''xoff'''|Number|Character code {{{0..255}}} use as xoff in '''xonxoff''' flowcontrol|{{{0x13}}}|

!!Methods
[[comport:write]] Write data to the port.
[[comport:read]] Read data from the port.
[[comport:status]] Obtain current status information about the port.
[[comport:info]] Obtain characterisation information about an open port.
[[comport:instancetable]] Returns a table which may be used to store per-instance data.
[[comport:close]] Closes the port.
</pre>
</div>
<div title="com.op" creator="John Hind" modifier="John Hind" created="201410111937" modified="201410112110" changecount="3">
<pre>!code = op(opname [, st] [, to])
Returns a number which is an opaque opcode for use in the [[comport:write]] method. Parameter ''opname'' is a string key. Parameter ''st'' is an optional Boolean representing signal state {{{true}}} asserted (the default) or {{{false}}} not asserted. Parameter ''to'' is a Number of milliseconds timeout {{{0..4095}}}, which defaults to 0.
</pre>
</div>
<div title="com.ports" creator="John Hind" modifier="John Hind" created="201410111933" modified="201410112355" changecount="3">
<pre>!!for num, info in ftdi.ports() do
Returns iteration values for iterating the available ports. ''num'' is a number between 1 and 255 and ''info'' is a table of characterising information (see below).

Specifically {{{com.ports}}} is a stateless iterator factory. It returns three values, a stateless iterator function, a nil placeholder(invariant state) and the number {{{0}}} (the initial value of the control variable).

The ''info'' value is a table which is normally empty but may contain the key ''open'' with Boolean value {{{true}}} if the port exists but is unavailable because it is already open to another application.

Example:
{{{
com = require(&quot;ComLink&quot;)
for n, v in com.ports() do
  if v.open then
    print(&quot;com&quot; .. n .. &quot; (open)&quot;)
  else
    print(&quot;com&quot; .. n .. &quot; (available)&quot;)
  end
end
}}}</pre>
</div>
<div title="com:getdata" creator="John Hind" modifier="John Hind" created="201006051949" modified="201404101441" changecount="1">
<pre>!dat = com:getdata()
Return a string comprising the characters in the reception buffer. The string length will be the number returned by the last [[com:sendcommand]], [[com:waitforinput]] or passed to the function registered using [[com:onmessage]] or [[com:oninput]].
</pre>
</div>
<div title="com:oninput" creator="John Hind" modifier="John Hind" created="201006051953">
<pre>!com:oninput(resp, func)
As [[com:onmessage]] except that it does not reset the input buffer. This would be called from a previous response function used in [[com:onmessage]] if it is necessary to receive more characters to complete the message.
</pre>
</div>
<div title="com:onmessage" creator="John Hind" modifier="John Hind" created="201006051951" modified="201402092235" changecount="1">
<pre>!com:onmessage(resp, func)
Clears the input buffer and sets the supplied ''func'' as the input response function under conditions specified by ''resp'' (as specified for [[com:sendcommand]]). Returns immediately and does not block the calling script. When the condition is met the function is called and passed a count of the number of characters in the buffer. The function is called once only and must be reset using onmessage or [[com:oninput]] if it should be called again.
</pre>
</div>
<div title="com:sendcommand" creator="John Hind" modifier="John Hind" created="201006051945" modified="201404101414" changecount="4">
<pre>!res = com:sendcommand(cmd, [resp [, tout]])
Clears the reception buffer, sends the string ''cmd'' to the connected device and optionally blocks until a response is received. It is also possible to wait for input without sending anything by passing an empty string as the first parameter.

If ''resp'' is omitted, returns immediately the ''cmd'' string has been sent. If ''resp'' is a number, waits until that number of characters has been received. If ''resp'' is a string, waits until a sequence of characters matching the string have been received. If present, ''tout'' must be a timeout value in milliseconds which defaults to {{{1000}}} (one second) if omitted.

Returns the number of characters in the buffer once the response condition has been met, or {{{nil}}} if the condition is not met (due to a timeout or buffer overflow). If no response condition is given, returns {{{true}}} immediately the data has been sent.

Once this method returns, the received data can be recovered using [[com:getdata]]. [[com:waitforinput]] can be used to wait for more data.
</pre>
</div>
<div title="com:waitforinput" creator="John Hind" modifier="John Hind" created="201006051947" modified="201402092238" changecount="1">
<pre>!res = com:waitforinput(resp [, tout])
As [[com:sendcommand]] except that the reception buffer is not cleared and nothing is sent. Used if ''sendcommand'' can only partly parse the response (for example if there is a message header with a message size count in it). A chain starting with [[com:sendcommand]] and followed by one or more [[com:waitforinput]] is used until the complete message has been accumulated in the buffer, which is then recovered using [[com:getdata]].
</pre>
</div>
<div title="command-line" creator="John Hind" modifier="John Hind" created="201005292209" modified="201402211454" changecount="14">
<pre>Winsh.lua processes the same command line parameters and switches as the standard Lua runtime.

Assuming the Winsh Executable file is named {{{winsh.exe}}}, the general command line structure is:
{{{
winsh [options] [script [arguments]]
}}}
The following options are supported:
;'''-e//text//'''
:Compiles and executes text as Lua code. Multiple '''e''' options may be supplied. The text in these options is collected in the order specified, separated by new line characters, and the collected text is compiled and executed as a single chunk after all other specified scripting.
;'''-l//library//'''
:Treats //library// as a library name and executes a Lua require statement with this name as the parameter. Multiple '''l''' options may be supplied.
;'''-i'''
:Enter interactive mode after running scripts. For [[Winsh Executables]] with the Console Subsystem flag, input will be accepted from ''stdin''. For executables with the Windows Subsystem flag, the [[Interactive Console]] will be displayed.
;'''-v'''
:Displays version information. This will be sent to ''stdout'' for [[Winsh Executables]] with the Console Subsystem flag. For executables with the Windows Subsystem flag, the [[Interactive Console]] will be displayed and the version information displayed on that.
;'''--'''
:Causes any options specified after this one to be ignored. May be useful for testing.
The first parameter which does not start with the '''-''' option prefix will be interpreted as a script name. This may be the name of a script resource in the {{{winsh.exe}}} file, the name of a script file in the same folder as the winsh executable, a full path to a script file, the name of a folder in the same folder as the winsh executable file or a full path to a folder. If the specified name is a folder, the file {{{start.lua}}} in that folder will be used and other files in that folder (both {{{.lua}}} files and {{{.dll}}} files) will be available for loading using {{{require}}} statements. Files must have the extension {{{.lua}}} and this will be added if it is not supplied on the command line. You can force loading of a file rather than a resource of the same name by providing the {{{.lua}}} extension explicitly.

Any parameters on the command line after the script name are passed into the script as ''vararg'' parameters. Each additional parameter is parsed to a Lua type as follows:
# If the parameter is enclosed in quote marks, the quotes are stripped and the result passed as a Lua string. This may be used to pass strings with special characters such as spaces, or to prevent parsing.
# If possible, the parameter is parsed to a Lua number.
# The parameters {{{true}}} or {{{false}}} are parsed to a Lua Boolean.
# The parameter {{{nil}}} is parsed to Lua nil.
# Otherwise the parameter is passed as a Lua string.
Within the Lua script, the parameters may be recovered using the ''vararg'' operator as in the following example:
{{{
-- Script is executed by the command line:
-- &gt; winsh thisfile.lua &quot;123&quot; 321 true excelsior
local s1, n1, b1, s2 = ...
print(s1, n1, b1, s2)
}}}
</pre>
</div>
<div title="comport:close" creator="John Hind" modifier="John Hind" created="201407191419" modified="201410112044" changecount="4">
<pre>!comport:close()
Closes the port. This operation is done automatically by the garbage collector, but it may be useful to call it explicitly to free the device resources immediately for reuse.
</pre>
</div>
<div title="comport:info" creator="John Hind" modifier="John Hind" created="201410112055" changecount="1">
<pre>!info = comport:info()
Returns a table of characterising information about an open port. This is the same table that is returned by the [[com.ports]] iterator for all available ports.
</pre>
</div>
<div title="comport:instancetable" creator="John Hind" modifier="John Hind" created="201407191417" modified="201410112043" changecount="3">
<pre>!tab = comport:instancetable()
Returns a table stored in the port object which may be used to store per-instance fields required by higher level protocol drivers based on this port. The table is created the first time this method is called.
</pre>
</div>
<div title="comport:read" creator="John Hind" modifier="John Hind" created="201407191413" modified="201410112254" changecount="33">
<pre>!result [, count] = comport:read([timeout|function [, bytes [, term]]])
Receives data from the port as a fixed length or terminated packet. Blocking, polling loop and asynchronous read models are supported. In the event of an error, the call returns Boolean {{{false}}} and a string error message.
!!!Blocking Read
A blocking read consists of a single call which blocks execution until a complete packet has been received or a ''timeout'' (in milliseconds) expires. ''bytes'' is either the length of an expected fixed-length packet or the maximum possible length of a variable length packet. ''term'' is required only for variable length packets and must be between one and four bytes long. This sequence of bytes (which is not included in the ''byte'' count) marks the end of the packet. If a complete packet is received before the timeout, ''result'' is a string containing the packet (less any terminator). Otherwise ''result'' is Boolean {{{false}}} and ''count'' is the number of bytes received.
{{{
packet = port:read(1000, 10, &quot;;&quot;)
if packet then print(packet) else print(&quot;TIMEOUT or ERROR&quot;) end
}}}
!!!Polling Loop Read
This starts with a similar ''initial call'' to the Blocking Read case, except that a zero timeout is passed. A polling loop, controled by another call to the read method with just a timeout value (which may be zero), is entered to await the packet. This is a ''polling call'' which returns the packet string if the packet has been received, or boolean false and a count of characters received so far. Once the polling loop exits a ''peek call'', which has no parameters, can be used to recover the packet string (this is the same string as returned by the final polling call, but this approach avoids the need to save it in a local variable). The advantage of this over a Blocking Read is that the polling loop may do other processing whilst awaiting the packet.
{{{
port:read(0, 10, &quot;;&quot;)
while port:read(0)
  -- Do some other processing
end
packet = port:read()
}}}
A timeout greater than zero in the loop control call will reduce the frequency of repeating the processing within the loop whilst still allowing the loop to terminate as soon as a full packet has been received.
!!!Asynchronous Read
This starts with an ''initial call'' having two or three parameters as in the Blocking Read case above. However instead of a timeout, the first parameter is an ''action function'' which will be called automatically once a full packet is available. This action function will be passed the port object and will normally use this to make a ''peek call'' to recover the packet for processing. Some further 'plumbing' is needed to make this happen however. The initial call always returns immediately and always returns a closure even if a full packet is already available. This closure is intended to be used in [[time:alarm]] of a periodic timer. When the closure is called, if the packet has been received it then calls the ''action function'' to process it and returns Boolean {{{false}}} to cancel the timer (otherwise it returns {{{true}}}).
{{{
tmr = Time{seconds=1}
tmr:alarm(port:read(function(port) print(port:read()) end, 10, &quot;;&quot;))
}}}
!!!Note
The system maintains a character buffer which, after an ''initial'' read call (two or three parameters) will be at least ''bytes'' plus four (for possible terminator characters) long. This buffer will be grown as necessary for subsequent ''initial'' reads, but is never shrunk. If it is necessary to recover this memory, [[comport:close]] the device object and create a new one.
</pre>
</div>
<div title="comport:status" creator="John Hind" modifier="John Hind" created="201410112052" modified="201410131249" changecount="4">
<pre>! ... = comport:status( ... )
The function is passed a list of status keys (strings) and it returns one status value for each key, in the same order. The following keys should be common to all com port drivers:
|KEY|TYPE|DESCRIPTION|h
|'''cts'''|Boolean|State of the CTS input signal|
|'''dsr'''|Boolean|State of the DSR input signal|
|'''ri'''|Boolean|State of the Ring Indicator input signal|
|'''dcd'''|Boolean|State of the DCD input signal|
|'''oe'''|Boolean|Presence of overrun error flag.|
|'''pe'''|Boolean|Presence of parity error flag.|
|'''fe'''|Boolean|Presence of framing error flag.|
|'''bi'''|Boolean|Flag for break condition interrupt.|
|'''rxq'''|Number|Bytes in the receive queue.|
|'''txq'''|Number|Bytes in the transmit queue.|
The following additional keys are specific to this port type:
|KEY|TYPE|DESCRIPTION|h
|'''ctsh'''|Boolean|Transmission held on CTS signal|
|'''dsrh'''|Boolean|Transmission held on DSR signal|
|'''dcdh'''|Boolean|Transmission held on DCD signal|
|'''xoffh'''|Boolean|Transmission held because XOFF received|
|'''xoffsh'''|Boolean|Transmission held because XOFF sent|
|'''eof'''|Boolean|End of file marker received|
|'''im'''|Boolean|Immediate character awaiting transmission|
</pre>
</div>
<div title="comport:write" creator="John Hind" modifier="John Hind" created="201407191410" modified="201410112104" changecount="14">
<pre>!result, step = comport:write( ... )
Carries out the transmission operations specified by the parameter list. Returns Boolean {{{true}}} if the operations are completed sucessfully, {{{false}}} if there is an error or if an operation aborts or times out. Note that a timeout always prevents execution of further operations (except for the '''dly''' op code). When the return is {{{false}}}, also returns the index of the parameter at which operations were aborted, 1 meaning the first parameter in the call and so on. This method may block execution for up to the total of timeout values in all its op codes.

The parameters may be strings or numbers and are actioned left to right in the parameter list. Each byte in a string is transmitted in order left to right. Numbers are interpreted as op codes which should be generated using the [[com.op]] function and the following table:
|opname|st|to||h
|'''dtr'''|Y||Sets or clears the DTR output.|
|'''rts'''|Y||Sets or clears the RTS output.|
|'''brk'''|Y||Sets or clears a break condition.|
|'''cts'''|Y|Y|Wait for CTS to be set or clear, abort on timeout.|
|'''dsr'''|Y|Y|Wait for DSR to be set or clear, abort on timeout.|
|'''ri'''|Y|Y|Wait for RI to be set or clear, abort on timeout.|
|'''dcd'''|Y|Y|Wait for DCD to be set or clear, abort on timeout.|
|'''rxd'''||Y|Wait for some data to be received, abort on timeout.|
|'''bi'''||Y|Wait for break interrupt, abort on timeout.|
|'''dly'''||Y|Delays unconditionally for timeout.|
|'''eab'''|||Abort if a line error has occured.|
|'''prx'''|||Purge the reception queue (discarding any received data).|
|'''ptx'''|||Purge the transmission queue (discarding any unsent data).|
Example:
{{{
e, s = port:write(ftdi.op('dly',10), ftdi.op('cts', true, 40), &quot;Test\n\r&quot;)
if not e then print(&quot;Write failed at step &quot;, s) end
}}}</pre>
</div>
<div title="drive:OnChange" creator="John Hind" modifier="John Hind" created="201006022017" modified="201311261739" changecount="3">
<pre>!drive.~OnChange
A Lua callable object ([[Command Class]] object, object of [[DelegateList Class]] or a simple Lua function for example) assigned to this field will be called when the drive changes (added or removed or a volume is mounted or dismounted).
</pre>
</div>
<div title="drive:ejectvolume" creator="John Hind" modifier="John Hind" created="201006022008" modified="201404011404" changecount="6">
<pre>!res = drive:ejectvolume([fixed] [, timeout])
Dismounts and, if supported, ejects the volume in the drive. ''Fixed'' is a Boolean parameter which, if {{{true}}}, allows an attempt to be made to dismount a drive even if it is fixed. This may be necessary for some e-sata and caddied drives. ''Timeout'' is the amount of time in milliseconds to wait for a volume lock (default is {{{10000}}}, ten seconds). The method returns a numeric result code. {{{0}}} means total success, negative means the volume was dismounted but could not be ejected, positive means that the volume could not be dismounted (usually because it is in use).

''Note:'' If this method fails on Windows Vista or later with ''res'' = {{{2}}}, the reason will usually be that administrator privileges are required. One way of achieving this uses the [[winsh.spawn]] function with the '''admin''' key. The other common failure code is {{{3}}} which means that some other process has a file open on the drive.</pre>
</div>
<div title="drive:emptybin" creator="John Hind" modifier="John Hind" created="201009041333" modified="201402092059" changecount="1">
<pre>!ok = drive:emptybin()
Empty the recycle bin for this drive. Returns Boolean {{{true}}} on success.
</pre>
</div>
<div title="drive:format" creator="John Hind" modifier="John Hind" created="201009141639" modified="201402092057" changecount="1">
<pre>!res = drive:format()
Brings up the OS formatting dialog for this drive. If the user goes ahead and successfully formats the drive, ''res'' will return Boolean {{{true}}}, otherwise {{{false}}}.
</pre>
</div>
<div title="drive:label" creator="John Hind" modifier="John Hind" created="201009141351" modified="201402092058" changecount="1">
<pre>!res = drive:label(label)
Sets the string parameter ''label'' as the new volume label for this drive. Returns ''res'' Boolean {{{true}}} on success, else {{{false}}}.
</pre>
</div>
<div title="drive:name" creator="John Hind" modifier="John Hind" created="201006022013" modified="201402211954" changecount="6">
<pre>!name = drive:name([format [,count]])
Returns the name of the drive (a string) in the selected ''format'' which must be one of the string keys listed below (defaults to '''letter'''). In the special case of a dynamic disk volume on more than one physical disk, returns a number which is the number of names rather than a string. In this case, call the method repeatedly with ''count'' values from {{{1}}} to the number of names to recover the names of all the physical disks.
;'''letter'''
:A single upper-case drive letter &quot;A&quot; .. &quot;Z&quot;.
;'''root'''
:The path to the volume filesystem root, for example &quot;C:\&quot;.
;'''volspec'''
:The volume path, for example &quot;\\.\C:&quot;.
;'''label'''
:The volume label or an empty string if not labeled.
;'''display'''
:The drive name as it would be displayed in Windows Explorer.
;'''volguid'''
:The volume GUID path for example &quot;\\?\Volume{54d30086-1cc5-11e0-a393-806e6f6e6963}\&quot;.
;'''logical'''
:The path to the logical drive, for example &quot;\\.\~HarddiskVolume1&quot;.
;'''physical'''
:The path to the physical drive, for example &quot;\\.\~PhysicalDrive1&quot;.
;'''partition'''
:The path to the physical partition, for example &quot;\\.\~Harddisk1Partition1&quot;.
;'''ntpart'''
:The path to the physical partition in NT format, for example &quot;\Device\Harddisk1\Partition1&quot;.
Note that for drive letters that do not reference hard disks, '''physical''' and '''partition''' return the same string as '''logical''', while '''ntpart''' returns the logical drive in NT format. For dynamic disks, '''partition''' returns the same as '''physical''' and '''ntpart''' returns the physical drive in NT format.
</pre>
</div>
<div title="drive:space" creator="John Hind" modifier="John Hind" created="201006022015" modified="201402051730" changecount="1">
<pre>!free, total, size = drive:space()
Returns information about the space available on a volume in the drive (returns ''nil'' if there is no volume):

''free'' The free space in kilobytes available for writing by the current user on the volume.

''total'' The total space in kilobytes, free and used, accessible to the current user on the volume.

''size'' The free space in kilobytes on the volume regardless of any user quotas.
</pre>
</div>
<div title="drive:type" creator="John Hind" modifier="John Hind" created="201006022011" modified="201402211955" changecount="4">
<pre>!type, fsname, serial = drive:type()
Return the type of drive and information about the volume (if any) in the drive. Returns {{{nil}}} if the drive is free or just the first parameter if the drive exists but does not have a volume (for example, a DVD drive with no DVD).

''type'' is a String key, the drive type: '''fixed''', '''removable''', '''network''', '''optical''' or '''ramdisk'''.

''fsname'' is a String, the file system name, for example &quot;FAT&quot;, &quot;NTFS&quot; or &quot;CDFS&quot;.

''serial'' is a Number, the volume serial number (a unique identifier fixed when a volume is formatted).
</pre>
</div>
<div title="frame:place" creator="John Hind" modifier="John Hind" created="201006021915" modified="201404122226" changecount="7">
<pre>!pframe = frame:place([placement [,wframe]])
Returns a new frame which places frame ''wframe'' within this frame. The ''placement'' parameter must be one of: '''center''' (the default); '''centertop'''; '''righttop''', '''rightcenter''', '''rightbottom''', '''centerbottom''', '''leftbottom''', '''leftcenter''' or '''lefttop'''. If ''wframe'' is missing or if it is a point, the return frame is a point. If ''wframe'' is larger than this frame, it is reduced in size to fit within this frame. The position of ''wframe'' has no effect on the returned frame.
{{{
window = task.Frame(0,0,200,100)
print(task.virtualscreen():place('center', window))
}}}
</pre>
</div>
<div title="frame:position" creator="John Hind" modifier="John Hind" created="201006021910" modified="201402141724" changecount="1">
<pre>!left, top = frame.position()
Returns the position as separate number values.
</pre>
</div>
<div title="frame:size" creator="John Hind" modifier="John Hind" created="201402141727" changecount="1">
<pre>!width, height = frame:size()
Returns the size as separate number values. Returns {{{nil}}} if the frame is a point.</pre>
</div>
<div title="ftdi.Port Class" creator="John Hind" modifier="John Hind" created="201407191408" modified="201410112107" changecount="27">
<pre>!ftdiport = ftdi.Port{ ... }
Returns an open Port Object or Boolean {{{false}}} and a string error description. The named parameters must include one of the following name and value pairs to identify the port. If more than one pair is provided the operative one is selected in the following priority (NOT in the order of the parameter list). If storing identifiers, pay attention to the stability of the different identifiers.

|KEY|VAL TYPE|VALUE|h
|'''index'''|Number|Index starting at {{{1}}} returned by [[ftdi.ports]]. (Unique on a given system, but unstable if devices are added or removed or the system is rebooted. Useful for giving the user a menu choice immediately after enumerating devices using [[ftdi.ports]].)|
|'''locid'''|Number|Positive integer as returned in [[ftdi.ports]] info table. (Unique and fairly stable on a given system. Assigned by the OS, not the device. May be useful as a saved selection, but '''serial''' is probably better if available.)|
|'''serial'''|String|Serial ID of device as returned in [[ftdi.ports]] info table. (Unique and stable for a specific device and port on any system. Good choice for saving the selection of a specific port.)|
|'''description'''|String|Describes the chip type and port, as returned in [[ftdi.ports]] info table.  (Stable on any system, but not unique as there may be more than one device of the same type.)|

Other named parameters configure the port selected. They are all optional (if absent the given default value is used) and may include all the values specified for [[com.Port Class]] plus any of the following:

|KEY|VAL TYPE|VALUE|DEFAULT|h
|'''mode'''|String|'''uart''', '''asyncbb''', '''mpsse''', '''syncbb''', '''mcu''', '''opto''', '''cbusbb''', '''fifo'''|'''uart'''|
|'''iomask'''|Number|Bitmask {{{0..255}}} for the mode, {{{0}}} sets pin to input, {{{1}}} output|{{{0}}}|
|'''eventmarker'''|Number|Character code {{{0..255}}} inserted when an event occurs, {{{0}}} means nothing is inserted.|{{{0}}}|
|'''errormarker'''|Number|Character code {{{0..255}}} inserted when an error occurs, {{{0}}} means nothing is inserted.|{{{0}}}|
|'''usbinsize'''|Number|Size of USB IN transfer size 64bytes to 64kb, 64 bit multiples|{{{4096}}}|
|'''latency'''|Number|Maximum wait in milliseconds {{{2..255}}} for rx data packet|{{{16}}}|
|'''pipretry'''|Number|Maximum number of times driver tries to reset pipe|{{{50}}}|
|'''deadman'''|Number|Maximum milliseconds to wait for USB request|{{{5000}}}|

!!Methods
{{{ftdiport:write}}} (see [[comport:write]]) Write data to the port.
{{{ftdiport:read}}} (see [[comport:read]]) Read data from the port.
[[ftdiport:status]] Obtain current status information about the port.
[[ftdiport:info]] Obtain characterisation information about an open port.
{{{ftdiport:instancetable}}} (see [[comport:instancetable]]) Returns a table which may be used to store per-instance data.
{{{ftdiport:close}}} (see [[comport:close]]) Closes the port.</pre>
</div>
<div title="ftdi.ports" creator="John Hind" modifier="John Hind" created="201410061058" modified="201410111936" changecount="8">
<pre>!!for index, info in ftdi.ports() do
Returns iteration values for iterating the available ports (FTDI devices and device channels). ''index'' is a number from 1 up to the number of available ports and ''info'' is a table of characterising information (see below).

Specifically {{{ftdi.ports}}} is a stateless iterator factory. It returns three values, a stateless iterator function, the number of available ports (invariant state) and the number {{{0}}} (the initial value of the control variable).

The ''info'' table will have one of the following Boolean keys to identify the chip type: {{{FT-BM; FT-AM; FT100AX; FT2232C; FT232R; FT2232H; FT4232H; FT232H; FT-X}}}

Any of the following key value pairs may also be available, depending on the chip type and state:
|KEY|VAL TYPE|VALUE MEANING|h
|'''hispeed'''|Boolean|Present if the device supports USB 2 at 480 Mbit/s.|
|'''open'''|Boolean|Present if the port is currently open.|
|'''type'''|String|One of the above chip type keys as a string for display.|
|'''description'''|String|Description of the device port.|
|'''serial'''|String|Serial code of the device.|
|'''pid'''|Number|USB Product ID of the device.|
|'''vid'''|Number|USB Vendor ID of the device.|
|'''locid'''|Number|USB Location ID of the device on the system.|
|'''driverversion'''|Number|Version of the FTDI device driver.|
|'''comport'''|String|Comport name of the VCP if present (e.g. '&quot;&quot;&quot;COM12&quot;&quot;&quot;').|
|'''latency'''|Number|Latency of the device.|
|'''eeusersize'''|Number|Size in bytes of the user EEPROM space on the device.|

Example:
{{{
ftdi = require(&quot;FtdiLink&quot;)
for i, v in ftdi.ports() do
  print(i)
  for k, x in v do
    print(k .. &quot;=&quot; .. tostring(x))
  end
end
}}}</pre>
</div>
<div title="ftdiport:info" creator="John Hind" modifier="John Hind" created="201407191358" modified="201410061432" changecount="11">
<pre>!info = ftdiport:info()
Returns a table of characterising information about an open port. This is the same table that is returned by the [[ftdi.ports]] iterator for all available ports.
</pre>
</div>
<div title="ftdiport:status" creator="John Hind" modifier="John Hind" created="201407191414" modified="201410131247" changecount="10">
<pre>! ... = ftdiport:status( ... )
The function is passed a list of status keys (strings) and it returns one status value for each key, in the same order. The available keys share the following with [[comport:status]]:
|KEY|TYPE|DESCRIPTION|h
|'''cts'''|Boolean|State of the CTS input signal|
|'''dsr'''|Boolean|State of the DSR input signal|
|'''ri'''|Boolean|State of the Ring Indicator input signal|
|'''dcd'''|Boolean|State of the DCD input signal|
|'''oe'''|Boolean|Presence of overrun error flag.|
|'''pe'''|Boolean|Presence of parity error flag.|
|'''fe'''|Boolean|Presence of framing error flag.|
|'''bi'''|Boolean|Flag for break condition interrupt.|
|'''rxq'''|Number|Bytes in the receive queue.|
|'''txq'''|Number|Bytes in the transmit queue.|
And add the following specific keys:
|KEY|TYPE|DESCRIPTION|h
|'''rxe'''|Boolean|Flag for received character interrupt.|
|'''mse'''|Boolean|Flag for modem status change interrupt.|
|'''lse'''|Boolean|Flag for line status change interrupt.|
|'''bm'''|Number|Bitmap of the current state of the bitbang bus (0..255).|
</pre>
</div>
<div title="key:create" creator="John Hind" modifier="John Hind" created="201010121919" modified="201402092248" changecount="2">
<pre>!key1 = key:create(name)
Creates a new sub-key of the current key and returns an object of [[RegistryKey Class]] representing it. Parameter ''name'' must be a registry path string with sections separated by backslashes. Returns {{{null}}} if the key cannot be created (perhaps because it already exists).
{{{
RegistryKey = require(&quot;registry&quot;)
rk = RegistryKey(HKEY.CURRENT_USER)
rk = rk:open([[Software]])
rk = rk:create([[Winsh Test Key]])
if rk then
  rk:set(&quot;&quot;, &quot;Test default value&quot;)
  rk:set(&quot;Another Value&quot;, 10)
  print(rk:get(&quot;&quot;))
  print(rk:get(&quot;Another Value&quot;))
  rk:deletevalue(&quot;&quot;)
  rk:deletetree()
else
  print(&quot;Could not create key&quot;)
end
}}}
</pre>
</div>
<div title="key:deletetree" creator="John Hind" modifier="John Hind" created="201010121954" modified="201402082323" changecount="1">
<pre>!key:deletetree()
Deletes all keys and values of the current key (use with care!).

See [[key:create]] for an example.
</pre>
</div>
<div title="key:deletevalue" creator="John Hind" modifier="John Hind" created="201010121956" modified="201402082323" changecount="1">
<pre>!key:deletevalue([name])
Deletes a value of the current key. If ''name'' is supplied and matches an existing named value, that value is deleted. If parameter ''name'' is missing or an empty string, the default value (if any) is deleted.

See [[key:create]] for an example.
</pre>
</div>
<div title="key:get" creator="John Hind" modifier="John Hind" created="201010121932" modified="201402092247" changecount="4">
<pre>!value, type = key:get([name])
Returns the value and type of a named or the default value. If the ''name'' parameter is missing or empty string, the default value (if there is one) is returned, otherwise ''name'' must be a string being the name of an existing value of the key.

Return ''type'' is a string key identifying the value type while ''value'' depends on the type as shown in the following table:
|!''type''|!Lua Type of ''value''|!Contents of ''value''|
|'''BINARY'''|string|Each character is a byte and may be 0..255|
|'''DWORD'''|number|32-bit signed integer|
|'''DWORDBE'''|number|32-bit signed integer (re-ordered)|
|'''QWORD'''|number|64-bit signed integer (some fidelity is lost)|
|'''SZ'''|string|The registry string is reduced to ASCII for Lua|
|'''ESZ'''|string|String may contain unexpanded environment variables|
|'''LINK'''|string|String is a registry link|
|'''MSZ'''|List|Each element in the List is a string from the multi-string|
|'''NONE'''|number|The number is the number of bytes in the data which should be 0|
{{{
RegistryKey = require(&quot;registry&quot;)
rk = RegistryKey(HKEY.CURRENT_USER)
rk = rk:open([[Control Panel\Desktop]])
for vn in rk:values() do
  vv, vt = rk:get(vn)
  print(vn .. &quot; = &quot; .. vv .. &quot; (&quot; .. vt .. &quot;)&quot;)
end
}}}</pre>
</div>
<div title="key:open" creator="John Hind" modifier="John Hind" created="201010121915" modified="201402092248" changecount="2">
<pre>!key1 = key:open(name)
Returns a new object of [[RegistryKey Class]] which is a sub-key of the current key. Parameter ''name'' must be a registry path string with sections separated by backslashes. Returns {{{null}}} if the specified registry key does not exist.
{{{
RegistryKey = require(&quot;registry&quot;)
rk = RegistryKey(HKEY.CURRENT_USER)
rk = rk:open(&quot;Software&quot;)
for sk in rk:subkeys() do print(sk) end
}}}
</pre>
</div>
<div title="key:set" creator="John Hind" modifier="John Hind" created="201010121944" modified="201402082321" changecount="1">
<pre>!key:set(name, value [,type])
Sets the value and type of a named or the default value, creating or overwriting as necessary. If the ''name'' parameter is an empty string, the default value is set. The ''type'' parameter can usually be omitted as the common ones are inferred from the Lua type of the ''value'' parameter: &quot;DWORD&quot; for a number; &quot;SZ&quot; for a string; &quot;MSZ&quot; for a List or table. Other types must be explicitly specified as string keys in the ''type'' parameter.

The string keys for ''type'' and the corresponding Lua type of the ''value'' parameter are as specified in the table for [[key:get]].

See [[key:create]] for an example.</pre>
</div>
<div title="key:subkeys" creator="John Hind" modifier="John Hind" created="201010121950" modified="201402092245" changecount="1">
<pre>!key:subkeys() (Iterator for Generic for)
Used in a generic {{{for}}} statement, produces the names of the subkeys of the current key. This is also the default iterator for the objects.

Example:
{{{
for subkey in key:subkeys() do print(subkey) end
for subkey in key do print(subkey) end
}}}</pre>
</div>
<div title="key:values" creator="John Hind" modifier="John Hind" created="201010121952" modified="201402212022" changecount="3">
<pre>!key:values()
Used in a generic {{{for}}} statement, produces the names of the named values of the current key.

Example:
{{{
for value in key:values() do print(value) end
}}}
</pre>
</div>
<div title="list:add" creator="John Hind" modifier="John Hind" created="201005152120" modified="201312131737" changecount="9">
<pre>!list:add(obj)

Adds ''obj'' at the end of the list.
{{{
local lst = List(&quot;one&quot;)
lst:add(&quot;two&quot;)
for v in lst do print(v) end
}}}</pre>
</div>
<div title="list:concat" creator="John Hind" modifier="John Hind" created="201005152128" modified="201312131744" changecount="6">
<pre>!string = list:concat([,sep [,from [, to]]])
Returns a string formed by converting the elements of the List to strings and concatenating them in list order separated by the string ''sep'' which defaults to a single space. ''from'' specifies the index to start from (defaults to the first item). ''to'' specifies the last index to use (defaults to the last item). Negative indexes are also supported, with {{{-1}}} specifying the last element in the list and so on.
{{{
lst = List(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)
print(lst:concat(&quot;,&quot;))
}}}
</pre>
</div>
<div title="list:insert" creator="John Hind" modifier="John Hind" created="201005152140" modified="201403261714" changecount="9">
<pre>!list:insert(index, item)

If ''item'' is a List object, the elements in this list are inserted into the list, otherwise, ''item'' is inserted as a single entry.

The elements are inserted into the list starting at the given ''index''. Negative indexes are also supported with {{{-1}}} being the last item in the current List, and {{{0}}} representing the index after the last item in the current List. The original item at the specified ''index'', and all the subsequent items, are shifted after the inserted items.

Expansion of inserted lists may be overridden for derived classes by providing a {{{__whole}}} metafield. If the object being inserted has this metafield and it tests {{{true}}}, then it is inserted as a single entry, the value being the object itself.
{{{
for i = -5, 6 do
  t1 = List{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;, &quot;4&quot;, &quot;5&quot;}
  t2 = List{&quot;A&quot;, &quot;B&quot;, &quot;C&quot;}
  t1:insert(i, t2)
  print(i, t1:concat(&quot;;&quot;))
end
for i = -3, 4 do
  t1 = List{&quot;1&quot;, &quot;2&quot;, &quot;3&quot;}
  t1:insert(i, &quot;A&quot;)
  print(i, t1:concat(&quot;;&quot;))
end
}}}
</pre>
</div>
<div title="list:remove" creator="John Hind" modifier="John Hind" created="201005152147" modified="201405201635" changecount="9">
<pre>!list:remove([from [, to]])

Removes the items starting at the ''from'' index and ending with the ''to'' index and shifts subsequent items down to fill the gap. ''from'' defaults to the last item and ''to'' defaults to the ''from'' item. Negative indexes are supported with {{{-1}}} meaning the last item and so forth. Note that unlike {{{table.remove}}}, {{{list:remove}}} does not return the removed values. If you want this, use [[list:unpack]] followed by {{{list:remove}}}.
{{{
lst = List(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)
lst:remove(2)
}}}</pre>
</div>
<div title="list:reverse" creator="John Hind" modifier="John Hind" created="201312041626" modified="201405201640" changecount="3">
<pre>!list:reverse()
Reverses the order of the elements in the List object in place (i.e. without creating a new object). The first object in the List becomes the last, the last the first and so on.
{{{
lst = List{&quot;one&quot;,&quot;two&quot;,&quot;three&quot;}
lst:reverse()
print(lst:concat())
}}}</pre>
</div>
<div title="list:sort" creator="John Hind" modifier="John Hind" created="201005152153" modified="201405201630" changecount="5">
<pre>!list:sort([compfunc])

Sorts the List in place, changing the index numbers to reflect the sort order of the values. By default the Lua {{{&lt;}}} operator is used to compare values, but optionally ''compfunc'' may be provided to give a different sort order. This function must take two values and return Boolean {{{true}}} if the first should be placed before the second.
{{{
lst = List(10.6, 3, 20.15, 3.6)
lst:sort()
print(lst:concat())
}}}

</pre>
</div>
<div title="list:unpack" creator="John Hind" modifier="John Hind" created="201312141439" modified="201312141443" changecount="3">
<pre>!... = list:unpack([from [, to]])
Returns elements from the list starting at the ''from'' index and ending at the ''to'' index. ''from'' defaults to {{{1}}} and ''to'' defaults to ''from''. Negative indexes are supported with {{{-1}}} representing the last index and so on.

The operation is equivalent to:
{{{
return self[from], self[from+1] ... self[to]
}}}</pre>
</div>
<div title="packed string" creator="John Hind" modifier="John Hind" created="201312221622" modified="201402100932" changecount="4">
<pre>The packed string format represents an object of the [[Bitfield Class]] as a non-printable string in which each character represents eight bits (with the left-most character having any unused bits set to zero). Index {{{1}}} in the Bitfield is the least significant bit in the first character, index {{{9}}} is the least significant bit in the second character and so on.
{{{
bf1 = Bitfield(&quot;101010101010101010101&quot;)
pl = #bf1
ps = bf1[bitrange('packed')]
-- later
bf2 = Bitfield(pl)
bf2[bitrange('packed')] = ps
print(bf1)
print(bf2)
}}}</pre>
</div>
<div title="range names" creator="John Hind" modifier="John Hind" created="201312221610" modified="201402100936" changecount="8">
<pre>An object of the [[Bitfield Class]] may optionally have a Named Range Table (NRT) assigned to it. This table uses string keys and values. The keys are names and must conform to the restrictions of Lua identifiers. The values are opaque strings returned by the [[bitrange function]]. Identifiers in the NRT may be used to index the bitfield or, in the case of constants, as values assigned to bitfields or used as initialisers.
{{{
bf = Bitfield{
  flag1 = bitrange(1),
  flag2 = bitrange(2),
  count = bitrange(3,6),
  payload = bitrange('bitfield',7,32) }
bf.flag1 = true
print(bf, &quot;..001&quot;)
bf.flag2 = bf.flag1
print(bf, &quot;..011&quot;)
bf.count = 8
print(bf, &quot;..00100011&quot;)
bf.payload = Bitfield(26,5436)
print(bf)
}}}
The width of the bitfield is determined from the maximum index found in the Named Range Table (32 bits wide in this example). If the ranges do not cover all the bits in the desired width, simply include a dummy range that spans the entire width. Ranges may overlap allowing constructs similar to unions in C.

A common Named Range Table may be referenced by multiple bitfields:
{{{
rt = {  _ = bitrange(1,32), flag1 = bitrange(1) }
b1 = Bitfield(rt) print(b1)
b2 = Bitfield(rt, &quot;1&quot;) print(b2)
b3 = Bitfield(rt, 23) print(b3)
b4 = Bitfield(b3) print(b4.flag1)
}}}
The Named Range Table may also include named constants. Constant names are resolved when a value is assigned to a range as follows:
{{{
nrt = {
  dir = bitrange(1);
  flag = bitrange(2);
  on = bitrange('uconst', true);
  off = bitrange('uconst', false);
  output = bitrange('const', 1, 1, &quot;1&quot;)
}
bf = Bitfield(nrt)
bf.dir = 'output'
bf.flag = 'on'
print(bf, &quot;11&quot;)
}}}
There are two types of constant: '''const''' are bound to a specific range and '''uconst''' may be assigned to any range provided it is the same width. In the example above 'output' may be used only to set bit {{{1}}} of the bitfield to {{{0}}} while 'on' may be used to set any single bit to {{{1}}}.

Constants may also be used in the creation of a bitfield. Using the Named Range Table from the example above:
{{{
print(Bitfield(nrt, 'output', 'on'), &quot;01&quot;)
}}}
The list of constants is read from right to left and an internal index keeps track of the current position, starting at index {{{1}}}. A bound constant sets its bound range and advances the cursor to the next index after that range. An unbound constant sets a range beginning at the cursor and advances the cursor by the width of the constant. The list may be mixed with other initialisers.
</pre>
</div>
<div title="set:concat" creator="John Hind" modifier="John Hind" created="201005312035" modified="201312131744" changecount="1">
<pre>!str = set:concat([sep])
Return a string formed by converting the members of the Set to strings and concatenating them separated by the string ''sep'' (which defaults to an empty string).
{{{
set = Set(&quot;one&quot;, &quot;two&quot;, &quot;three&quot;)
print(set:concat(&quot;,&quot;))
}}}
</pre>
</div>
<div title="shell.platform" creator="John Hind" modifier="John Hind" created="201006021954" modified="201402211941" changecount="8">
<pre>!table = shell.platform()
Returns an object of the [[Table Class]] containing information about the operating system and hardware on which Winsh is running. The table may contain any of the following keys (a key will be absent if the information is not available).
;''&quot;&quot;&quot;OsVersion&quot;&quot;&quot;''
:Floating point version number of the operating system. 5.0: Windows 2000; 5.1: Windows XP; 5.2: Windows XP x64, Windows Server 2003; 6.0: Vista; 6.1: Windows 7; Windows Server 2008; 6.2: Windows 8.
;''&quot;&quot;&quot;OsBuildNumber&quot;&quot;&quot;''
:Integer build code.
;''&quot;&quot;&quot;ServicePack&quot;&quot;&quot;''
:Floating-point version number of the Service Pack. The whole number is the headline SP number e.g. {{{2.0}}} for Service Pack 2. Value is zero if there is no service pack.
;''&quot;&quot;&quot;ServicePackId&quot;&quot;&quot;''
:String description of service pack. Empty string if there is no service pack.
;''&quot;&quot;&quot;WordWidth&quot;&quot;&quot;''
:Integer {{{32}}} or {{{64}}}. Bit width of the operating system version.
;''Processors''
:Integer number of processors.
;''&quot;&quot;&quot;FeatureSet&quot;&quot;&quot;''
:Object of the [[Set Class]] with members for various OS and Hardware features. Processor Architectures: '''X64'''; '''&quot;&quot;&quot;IA64&quot;&quot;&quot;''' (Intel Itanium); '''X86'''; Processor Features: '''MMX'''; '''SSE'''; '''&quot;&quot;&quot;SSE2&quot;&quot;&quot;'''; '''&quot;&quot;&quot;SSE3&quot;&quot;&quot;'''. OS Features: '''&quot;&quot;&quot;DomainController&quot;&quot;&quot;'''; '''Server'''; '''Workstation'''; '''&quot;&quot;&quot;BackOffice&quot;&quot;&quot;'''; '''&quot;&quot;&quot;BladeServer&quot;&quot;&quot;'''; '''&quot;&quot;&quot;ComputeServer&quot;&quot;&quot;'''; '''&quot;&quot;&quot;DataCenter&quot;&quot;&quot;'''; '''Enterprise'''; '''Embedded'''; '''Personal'''; '''&quot;&quot;&quot;StorageServer&quot;&quot;&quot;'''; '''&quot;&quot;&quot;HomeServer&quot;&quot;&quot;'''; '''Tablet'''; '''&quot;&quot;&quot;MediaCenter&quot;&quot;&quot;'''.
{{{
for k, v in shell.platform() do
    if k == &quot;FeatureSet&quot; then
        print(&quot;FeatureSet: &quot; .. v:concat(&quot;; &quot;))
    else
        print(k .. &quot;: &quot; .. v)
    end
end
}}}
</pre>
</div>
<div title="shell.powerstatus" creator="John Hind" modifier="John Hind" created="201006021950" modified="201402211939" changecount="4">
<pre>!onAC, charge, capacity = shell.powerstatus()
Returns the following three pieces of information about the computer power:
;''&quot;&quot;&quot;onAC&quot;&quot;&quot;''
:Boolean ''true'' if the computer is receiving AC power.
;''charge''
:Number or ''nil'', Battery charge status {{{0 .. 100}}} (percent) or ''nil'' if there is no battery.
;''capacity''
:Number or ''nil'', Estimated endurance of the computer in seconds from {{{100}}} percent charge, ''nil'' if there is no battery.
{{{
print(shell.powerstatus())
}}}</pre>
</div>
<div title="shell.scandevices" creator="John Hind" modifier="John Hind" created="201404010940" modified="201404011401" changecount="8">
<pre>!res = shell.scandevices()
This has the same effect as ''scan for hardware changes'' in Device Manager. It is included  primarily to support hot-swapping of hard disks when the chipset does not detect insertion automatically (this is the case with many early SATA implementations). Returns {{{0}}} on success, or a numeric error code.

Return code {{{51}}} is likely on Vista and above if the Winsh process does not have administrator privilege. One way of achieving this uses the [[winsh.spawn]] function with the ''admin'' key.
{{{
r = winsh.spawn([[&quot;-e return shell.scandevices()&quot;]], 'admin', 'sync')
}}}</pre>
</div>
<div title="shell.shutdown" creator="John Hind" modifier="John Hind" created="201008292009" modified="201402211944" changecount="6">
<pre>!res = shell.shutdown([mode], [force])
Allows the various shell shutdown modes to be invoked programatically. Returns {{{true}}} if the operation succeeds. ''mode'' is a string key: '''shutdown''', '''switchuser''', '''logoff''', '''lock''', '''restart''', '''sleep''' or '''hibernate'''. Defaults to '''shutdown'''. If ''force'' is present and {{{true}}}, the operation is forced through even if an application declines to close (which may result in loss of data).
</pre>
</div>
<div title="shellobject:attributes" creator="John Hind" modifier="John Hind" created="201006052011" modified="201402092215" changecount="3">
<pre>!attset, mod, create, access, size = obj:attributes()
Returns an object of the [[Set Class]] characterising the object. The possible keys in this set are ''cancopy'', ''candelete'', ''canmove'', ''canrename'', ''compressed'', ''encrypted'', ''filesystem'', ''folder'', ''hidden'', ''link'', ''readonly'', ''removable'', ''share'', ''storage'' and ''stream''. You can test for the presence of any of these attributes with a simple Boolean expression, for example:
{{{
if obj:attributes().folder then print(&quot;Folder&quot;) end
}}}
If the object represents a folder or a file, also returns the modification, creation and access dates. These are objects of the [[Time Class]]. For files, also returns the file size in kilobytes (floating point).
</pre>
</div>
<div title="shellobject:browse" creator="John Hind" modifier="John Hind" created="201006052014" modified="201402092210" changecount="5">
<pre>!sel = obj:browse([prompt [, options ...]])
Presents a shell browser dialog for the object. If the user selects a new object this is returned as a new object of [[ShellObject Class]], otherwise returns {{{nil}}}. ''Prompt'' is a string which is displayed to the user (defaults to &quot;Choose a folder&quot;). Up to two ''options'' may also be specified from the following set:
;'''files'''
:If present, shows and allows selection of files as well as folders.
;'''nocreatefolder'''
:If present, disables the &quot;new folder&quot; button on the dialog.
</pre>
</div>
<div title="shellobject:children" creator="John Hind" modifier="John Hind" created="201006052113" modified="201402091524" changecount="5">
<pre>!obj:children([filter ])
Iterates the children of the current object. This may be used in a generic {{{for}}} loop. This iterator, without a filter, is also the default self-iterator for the object. ''filter'' may be zero to three string keys from the following set:
;'''nofolder'''
:Filters out folders.
;'''nofile'''
:Filters out everything except folders (usually this means files, but also special objects).
;'''nohidden'''
:Filters out objects with the hidden attribute.
!!Example.
{{{
obj = shell.ShellObject(CSIDL.PERSONAL)
for child in obj:children(&quot;nofolder&quot;, &quot;nohidden&quot;) do print(child) end
for child in obj do print(child) end
}}}
</pre>
</div>
<div title="shellobject:execute" creator="John Hind" modifier="John Hind" created="201006052100" modified="201402092207" changecount="5">
<pre>!res = obj.execute([verb [, ...]])
Executes a shell verb against the object. Shell verbs are generally the first entries in the context menu for a object in Windows Explorer, although shell extensions may also provide verbs and place them anywhere on the context menu, or even not surface them to Windows Explorer. ''verb'' is a string and if absent or an empty string, the default verb (shown in bold in the Windows Explorer context menu and executed on double-click) is executed. ''verb'' is followed by an optional list of string flags from the set documented below.

Common verbs include &quot;edit&quot; and &quot;print&quot; for document files, &quot;open&quot; for executables, documents or folders, &quot;explore&quot; or &quot;find&quot; for folders, &quot;runas&quot; for executables (the &quot;Run as administrator&quot; operation in Windows Vista and later) and &quot;properties&quot; which launches the properties dialog for most object types.

The flags can comprise any set of the following string keys, specified in any order:
;'''noinvoke'''
:This flag uses an alternative method of executing the verb. Usually it is not necessary, however if a verb that is expected to work does not, it is worth trying again with this flag. Technically, this causes the verb to be recovered directly from the registry rather than using the {{{IContextMenu}}} interface of the item shortcut menu handler.
;'''nounicode'''
:Normally the application is assumed to be Unicode, but this flag removes that assumption and may be necessary particularly for older applications.
;'''noerrorui'''
:Specifies that no UI dialog should be displayed in the event of an error.
;'''ddewait'''
:Another flag to try if things do not work as expected. Technically this specifies that any DDE transaction should be completed before the method terminates which may slow things down but make them more robust.
;'''logusage'''
:Specifies that this operation should increment the usage count of the application.
;'''nozonechecks'''
:Bypasses {{{XP SP1}}} and later zone checks.
;'''newconsole'''
:Creates a new console for the process.
</pre>
</div>
<div title="shellobject:fileoperation" creator="John Hind" modifier="John Hind" created="201006052107" modified="201402092202" changecount="4">
<pre>!res = dest:fileoperation(op [, spec] [, source] [, conf])
Performs bulk file operations on the destination folder represented by ''dest'', or deletes, erases or renames the file or folder represented by dest. ''op'' must be a string, one of '''copy''', '''save''', '''move''', '''delete''', '''erase''' or '''rename'''. ''spec'' is optional and is either a string or a Table which specifies the relative paths to the files and folders to be operated on. ''source'' is required for '''copy''', '''save''' and '''move''' and must be an object of [[ShellObject Class]]. If ''spec'' is also supplied, ''source'' must be a folder.  ''conf'' is optional and specifies the level of user interaction as '''none''' (no interaction),  '''newfolder''' (confirm  folder creation), '''delete''' (confirm file or folder deletion), '''progress''' (give progress feedback only). The default is '''delete''' and each level includes the later ones.

NOTE: Folders are treated as files in all operations, so if a specification resolves to a folder, that folder and all contained files and sub-folders are operated on as a unit. Wildcards select folders as well as files.

The method returns Boolean {{{true}}} if the operation was completed successfully, {{{false}}} if the user canceled the operation from any displayed UI element or an OS determined error number if the operation could not be completed for some other reason.

''spec'' is either a string or a Table of strings representing relative paths to files or folders (all strings must start with a backslash and include at least one further character). The string form is simply a shortcut equivalent to a Table with one entry. For '''rename''' this entry has the path of ''dest'' relative to its parent as the key and the string as the value. For all other operations, this entry has the string as the key and Boolean {{{true}}} as the value. The key strings specify the files to be operated on and the corresponding values (if they are strings) specify new names or relative locations for each key string. If the value is not a string, the files and folders retain the same name and relative location after the operation. An entry in the table can be inhibited by setting its value to Boolean {{{false}}}. Provided NONE of the keys have string values, wildcards may be used in the file or folder name part of the key strings.
;'''copy'''
:If ''spec'' is absent, copies the ''source'' file or folder into the ''dest'' folder. If ''spec'' is provided, copies the specified files from the ''source'' folder into the ''dest'' folder. They will have the same relative path and name unless new ones are given in the ''spec'' table.
;'''save'''
:As '''copy''' except that in the event of a name collision, the copy is automatically given a new name (versioned).
;'''move'''
:If ''spec'' is absent, moves the ''source'' file or folder into the ''dest'' folder. If ''spec'' is provided, moves the specified files from the ''source'' folder to the ''dest'' folder. The relative path and name will be the same in the ''dest'' folder unless new ones are given in the ''spec'' table.
;'''rename'''
:''spec'' is required and ''source'' must be absent. As '''move''' except that the old and new names in the ''spec'' table are both relative to the ''dest'' folder. If ''spec'' is a string, this is taken as a new name for the file or folder represented by ''dest'' itself, relative to its parent (so the string must still start with a backslash).
;'''delete'''
:''source'' must be absent and ''spec'' is optional. If ''spec'' is provided, the files specified are removed from the ''dest'' folder and put in the recycle bin if possible. If ''spec'' is missing, the file or folder represented by ''dest'' is itself removed.
;'''erase'''
:As '''delete''' except that the recycle bin is not used and the files and folders are deleted permanently.
</pre>
</div>
<div title="shellobject:icon" creator="John Hind" modifier="John Hind" created="201009231032" modified="201402091537" changecount="4">
<pre>!icon = shellobject:icon([type])
Returns an object of [[Icon Class]] or {{{nil}}}. The object may be used to draw a visual representation of the shell object by passing it to [[winsh.taskicon]] or specifying it in a [[Command Class]] object used to create a menu. Parameter ''type'' is a string key from the following list (defaults to '''file'''):
;'''file'''
:The normal size icon for the file or object.
;'''large'''
:The large size icon for the file or object.
;'''small'''
:The small size icon for the file or object.
;'''shell'''
:The shell size icon for the file or object.
;'''open'''
:The open icon for a document file.
;'''link'''
:The normal size icon with a link overlay icon.
;'''selected'''
:The normal size icon with the selected highlighting for the shell.
;'''overlays'''
:The normal size icon with any overlays appropriate to the specific file.
</pre>
</div>
<div title="shellobject:name" creator="John Hind" modifier="John Hind" created="201006052015" modified="201402092225" changecount="4">
<pre>!name = obj:name([type [,width] ])
Returns the name, or part of the name, of the object as a string in one of several formats.

Parameter ''width'' is an optional number which is only used for the '''compacted''' type and which defaults to 40 if not specified.

Parameter ''type'' is a string key which specifies the format returned and defaults to '''fullparsing'''. It must be one of the following:
;'''fullparsing'''
:The full path of the object in the standard Windows format, for example &quot;C:\test\myfile.txt&quot;.
;'''compacted'''
:The full path of the object intelligently truncated to ''width'', for example &quot;C:\...\myfile.txt&quot;.
;'''relativeparsing'''
:The path of the object within its containing folder, for example &quot;myfile.txt&quot;.
;'''editing'''
:The name of the object in the folder as it may be edited by the user (as it would appear for in-place renaming in Explorer) for example &quot;myfile&quot;.
;'''display'''
:The name of the object in the folder as it is displayed in explorer when not being edited, for example &quot;myfile&quot;.
;'''normal'''
:A full display name used for certain object types outside of their context i.e. for network printers, for example &quot;myfile&quot;.
;'''filename'''
:For a file, returns the name without any type extension regardless of explorer settings. For other types, as '''relativeparsing''', for example &quot;myfile&quot;.
;'''type'''
:Returns any type extension without the period separator, for example &quot;txt&quot;.
;'''drive'''
:Returns any drive letter with colon suffix, for example &quot;C:&quot;.
;'''url'''
:Returns the full path in URL format, for example &quot;&quot;&quot;&quot;file:///C:/test/myfile.txt&quot;&quot;&quot;&quot;
;'''typename'''
:Returns the name of the registered type of a file.
</pre>
</div>
<div title="shellobject:new" creator="John Hind" modifier="John Hind" created="201009021629" modified="201402091539" changecount="1">
<pre>!newobj = folder:new(template [ [,name] [, ... ] ])
Creates a new object in the folder against which it is invoked (it is an error to invoke this method against an object which is not a folder).

The ''template'' parameter is either an object of [[ShellObject Class]] or the string key '''folder'''. The new object will either be a copy of this object, a shortcut to this object, or an empty folder. If ''template'' is an object, it may be either a file or a folder. A folder ''template'' will be deep copied to form the new object from the entire folder structure.

The ''name'' parameter is a string used to form the name of the new object. By default, a user interface dialog is presented enabling the user to edit this name. The name may be omitted or an empty string in which case the user must enter the name from scratch.

The third and subsequent parameters may be any of the following string keys in any order:
;'''shortcut'''
:Instead of being a copy of the ''template'' object, the new object will be a shortcut to it.
;'''noui'''
:No user interface is presented and the new object is created directly using the ''name'' parameter. If the name is missing, it is created automatically in the form &quot;New {type}&quot;.
;'''notypelock'''
:Normally the type of the new object is constrained to be the same as the type of the template (determined by the file extension). If this key is specified, the user may supply a new extension to change the type.
;'''overwrite'''
:Normally, if the name supplied clashes with an existing object in the folder, a suffix will be automatically added to the name to make it unique. If this key is specified, the user will be prompted for permission to overwrite the existing object.
The return value is an object of [[ShellObject Class]] representing the new object created, or {{{nil}}} in the event that creation fails or is aborted by the user.
</pre>
</div>
<div title="shellobject:parent" creator="John Hind" modifier="John Hind" created="201006052109" modified="201402092201" changecount="2">
<pre>!par = obj:parent([levels])
Returns an object of the [[ShellObject Class]] representing the parent of the current object. ''Levels'' is a number which defaults to {{{1}}} but may be incremented to specify the grandparent, great-grandparent etc. in a single call. If you attempt to go back too far, the return is {{{nil}}}.
</pre>
</div>
<div title="shellobject:touch" creator="John Hind" modifier="John Hind" created="201006052115" modified="201402091535" changecount="2">
<pre>!obj:touch([time][, types ...])
Changes one or more of the date/time records for an object which represents a file or folder. With no parameters, touch sets the modified date/time to the current time. If a time parameter is provided (object of the [[Time Class]]) the date/time it represents is used. All Time variants are supported with the relative variants being resolved relative to the current time. From zero to three ''types'' string keys may be provided:
;'''created'''
:Date and time object was created.
;'''modified'''
:Date and time object was last modified.
;'''accessed'''
:Date and time object was last accessed.
</pre>
</div>
<div title="table:count" creator="John Hind" modifier="John Hind" created="201005312025" modified="201401291753" changecount="2">
<pre>!n = tab:count([limit])
Returns the number of entries in the Table. One of the limitations of the Lua table model is that no running count of entries is kept, so the implementation of a count of entries in a large table requires a full traversal. The optional ''limit'' parameter stops the count when it reaches this number, improving efficiency if an exact count is not needed. For example, to test for empty:
{{{
local tab = Table{}
if tab:count(1) &lt; 1 then print(&quot;Empty&quot;) end
}}}
</pre>
</div>
<div title="table:invert" creator="John Hind" modifier="John Hind" created="201005312028" modified="201401301526" changecount="4">
<pre>!table2 = table:invert([dup])
Returns a new object of the [[Table Class]] which has the keys and values in the original table inverted (values become keys and keys values). If values are duplicated, all but one arbitrarily selected entry is discarded. If ''dup'' is supplied, it should be an empty table to which a list of duplicated values will be written.
{{{
local tab = Table{family=&quot;Smith&quot;; given=&quot;John&quot;; middle=&quot;Smith&quot;}
local dup = List{}
local inv = tab:invert(dup)
for k,v in inv do print(k..&quot; = &quot;..v) end
for k in dup do print(&quot;duplicate: &quot; .. k) end
}}}
</pre>
</div>
<div title="table:merge" creator="John Hind" modifier="John Hind" created="201005312029" modified="201401301518" changecount="8">
<pre>!table:merge(table2 [,ovr])
Copies all the entries in ''table2'' into ''table'' overwriting any entries with the same key in both tables. If the optional ''ovr'' value is supplied is should be an empty table. The original values of any overwritten entries will be written to this table.
{{{
local tab = Table{family=&quot;Smith&quot;; given=&quot;John&quot;}
local ovr = Table{}
tab:merge({middle=&quot;Arthur&quot;; family=&quot;Jones&quot;}, ovr)
for k,v in tab do print(k..&quot; = &quot;..v) end
for k,v in ovr do print(k..&quot; = &quot;..v..&quot; was overwritten&quot;) end
}}}
</pre>
</div>
<div title="task.application" creator="John Hind" modifier="John Hind" created="201311011127" modified="201402211740" changecount="21">
<pre>!handle = task.application([key [,parameter] ])
Return an abstract handle for a specified application (task) which is already running (or {{{nil}}}). This handle may be used in two ways: to test for equality (for example, if two windows are owned by the same application) or used to construct an object of [[Application Class]] for an already running application.

''key'' must be a string key, and ''parameter'' depends on ''key'' as follows:
|key|parameter type|notes|h
|'''prefix'''|string|Must match the start of the title of an existing window|
|'''suffix'''|string|Must match the end of the title of an existing window|
|'''title'''|string|Must match the entire title of an existing window|
|'''order'''|Number|Specifys the 'z-order': {{{1}}} means the top window, then {{{2}}} behind that etc.|
|'''active'''|None|The active window. Synonym for 'order' with parameter {{{1}}}|
|'''cbowner'''|None|The application which wrote the data currently on the clipboard|
!!Note:
When ''key'' specifies a window, the return value represents the task which owns that window.
</pre>
</div>
<div title="task.applications" creator="John Hind" modifier="John Hind" created="201006021855" modified="201402051140" changecount="4">
<pre>!tab = task.applications()
Return an object of the [[List Class]] listing the currently running application windows in z-order. This is the same as the Apps list in Task Manager and the {{{Alt-Tab}}} switcher list. Key {{{1}}} is the window at the top of the z-order, {{{2}}} the window immediately behind that and so on. The values in the table are the window titles (string type). You can use the keys or the values in [[task.application]] to create an Application object for any of these windows.
{{{
for app in task.applications() do print(app) end
}}}</pre>
</div>
<div title="task.getclipboard" creator="John Hind" modifier="John Hind" created="201311011005" modified="201402211743" changecount="14">
<pre>!data, type = task.getclipboard([typelist ...])
Return data from the clipboard. ''data'' depends on the type (see table below). ''type'' is a string type name. ''typelist'' is an optional list of type names (strings). The function will return the first available type from the list given. If ''typelist'' is omitted, it defaults to '''text''' type. If none of the types in '''typelist''' are available, returns {{{nil}}}.

The supported types are as follows:
|Name|Lua Type|CB Format|Notes|h
|'''text'''|string|{{{CF_TEXT}}}|ANSI plain text.|
|'''unicode'''|string|{{{CF_UNICODETEXT}}}|Unicode plain text (byte string).|
|'''filelist'''|table|{{{CF_HDROP}}}|The table is a List of fully qualified file name strings.|
|'''richtext'''|string|{{{CF_RTF}}}|ANSI text with RTF markup.|
|'''htmlurl'''|string|{{{CF_HTML}}}|The source URL of an HTML format clipboard entry.|
|'''htmlmax'''|string|{{{CF_HTML}}}|HTML fragment with context from HTML format clipboard entry.|
|'''htmlmin'''|string|{{{CF_HTML}}}|HTML fragment without context from HTML format clipboard entry.|
!!Notes:
The '''unicode''' type receives a string containing a unicode byte stream. This is not easily manipulated by Lua string functions, but it may be useful to save and restore unicode strings.

The three '''html''' formats are parts of the same format on the clipboard so there is no point in specifying more than one of them in the '''typelist''' parameter. However, '''htmlurl''' is optional in the clipboard format so that may return {{{nil}}}. Generally check for '''htmlmax''' or '''htmlmin''' first, perhaps with a fallback to '''text''', then recover '''htmlurl''' in a subsequent call only if the other '''html''' format was present.

Further details and an example of [[Clipboard Handling]] in Winsh.lua.</pre>
</div>
<div title="task.monitors" creator="John Hind" modifier="John Hind" created="201006021858" modified="201402051145" changecount="1">
<pre>!list = task.monitors()
Returns an object of the [[List Class]] containing objects of the [[Frame Class]] each of which identifies the size and virtual screen position of one of the video monitors making up the virtual desktop. The first item in the list is always the primary monitor.
{{{
for frame in task.monitors() do print(frame) end
}}}</pre>
</div>
<div title="task.setclipboard" creator="John Hind" modifier="John Hind" created="201311011046" modified="201402211743" changecount="21">
<pre>!task.setclipboard([ [ [type,] data] ...])
Clears the clipboard and optionally writes new data to it in one or more formats. With no parameters, the clipboard is cleared and no new data is written. With one string parameter, that string is written in 'text' format. Otherwise there must be an even number of parameters in pairs with a string type name followed by appropriate data and repeated as necessary to specify all the required formats.

The supported types are as follows:
|Name|Lua Type|CB Format|Notes|h
|'''text'''|string|{{{CF_TEXT}}}|ANSI plain text.|
|'''unicode'''|string|{{{CF_UNICODETEXT}}}|Unicode plain text (byte string).|
|'''filelist'''|table|{{{CF_HDROP}}}|The table must be a List of fully qualified file name strings.|
|'''richtext'''|string|{{{CF_RTF}}}|ANSI text with RTF markup.|
|'''html'''|string|{{{CF_HTML}}}|HTML fragment with context (see details below).|
|'''htmlurl'''|string|{{{CF_HTML}}}|The source URL for the HTML format.|
!!Notes:
The '''unicode''' type must receive a string containing a unicode byte stream. This is not easily manipulated by Lua string functions, but it may be useful to save and restore unicode strings.

The {{{CF_HTML}}} format is assembled from the '''html''' type and optionally also the '''htmlurl''' type (the '''htmlurl''' type is ignored unless the '''html''' type is also supplied). Typical content for the '''html''' type is as follows:
{{{
&lt;!DOCTYPE&gt;
&lt;HTML&gt;
&lt;HEAD&gt;
&lt;TITLE&gt;The HTML Clipboard&lt;/TITLE&gt;
&lt;BASE HREF=&quot;http://sample/specs&quot;&gt; 
&lt;/HEAD&gt;
&lt;BODY&gt;
&lt;!--StartFragment--&gt;
&lt;P&gt;The Fragment&lt;/P&gt;
&lt;!--EndFragment--&gt;
&lt;/BODY&gt;
&lt;/HTML&gt;
}}}
The {{{&lt;!--StartFragment--&gt;}}} and {{{&lt;!--EndFragment--&gt;}}} comment tags are important. When the format is recovered (i.e. by [[task.getclipboard]]), '''htmlmax''' reads all the content written by '''html''' while '''htmlmin''' returns only the content between the fragment tags. If the fragment tags are missing, '''htmlmin''' returns the same as '''htmlmax'''.

Further details and an example of [[Clipboard Handling]] in Winsh.lua.</pre>
</div>
<div title="task.virtualscreen" creator="John Hind" modifier="John Hind" created="201006021859" modified="201402211742" changecount="2">
<pre>!frame = task.virtualscreen()
Returns an object of the [[Frame Class]] representing the size and origin of the virtual screen (the display area encompassing all video monitors). The primary monitor is always at virtual screen coordinates ({{{0,0}}}) and a secondary monitor above or to the left of the primary will have negative coordinates.
{{{
print(task.virtualscreen())
}}}</pre>
</div>
<div title="time:alarm" creator="John Hind" modifier="John Hind" created="201006021814" modified="201407211208" changecount="9">
<pre>!time:alarm([action [ , repeat]])
Sets an alarm or if called with no parameters, cancels any existing alarm. ''action'' can be any Lua callable object (such as an object of [[Command Class]], a [[DelegateList Class]] or a simple Lua function).

If ''time'' is an absolute time, ''action'' is executed once at that time and then the alarm is automatically canceled. If ''time'' is a time-of-day, the action is executed at that time every day per the ''repeat'' parameter. If ''time'' is a duration, the action is executed after that amount of time has elapsed and then, per ''repeat'', repeatedly at that interval. 

The optional ''repeat'' count may be a Boolean or a Number. If ''repeat'' is missing or Boolean {{{false}}}, ''func'' is executed once and then automatically canceled. If it is Boolean {{{true}}}, the action is executed repeatedly at the given interval or time-of-day until explicitly canceled. If it is a number, the action is executed that number of times and then automatically canceled.

If the callable returns an explicit Boolean {{{false}}}, the timer is calcelled immediately regardless of the above repeat mechanism.
{{{
a = Time() + Time{seconds=30}
a:alarm(function() print(&quot;Absolute alarm&quot;) end)
d = Time{seconds=10}
d:alarm(function() print(&quot;Interval alarm&quot;) end, 4)
t = Time{time=true} + Time{seconds=20}
t:alarm(function() print(&quot;Time of day alarm&quot;) end, false)
}}}
</pre>
</div>
<div title="time:date" creator="John Hind" modifier="John Hind" created="201006021816" modified="201402091954" changecount="3">
<pre>!year, month, day = time:date([tzo])
Returns the ''year'', ''month'' and ''day'' components of an absolute Time. ''year'' is an integer (four digits), ''month'' is an integer 1 .. 12, ''day'' is an integer 1 .. 31.

If ''tzo'' is omitted, local time is returned, if it is 0.0, UTC is returned, otherwise it is the time zone offset in hours.
{{{
print(&quot;UTC: &quot;, Time():date(0))
print(&quot;Local: &quot;, Time():date())
}}}</pre>
</div>
<div title="time:day" creator="John Hind" modifier="John Hind" created="201006021818" modified="201402211718" changecount="4">
<pre>!day = time:day([tzo])
Returns the ''day'' (of week) represented by an absolute Time. The return is an integer {{{0..6}}} where {{{0}}} is Sunday.

If ''tzo'' is omitted, local time is returned, if it is {{{0.0}}}, UTC is returned, otherwise it is the time zone offset in hours.
{{{
print(Time():day())
}}}</pre>
</div>
<div title="time:format" creator="John Hind" modifier="John Hind" created="201006021832" modified="201402211721" changecount="6">
<pre>!tim:format([fmt] [,tzo])
Returns a string representing the Time. ''fmt'' is a string format template including substitution keys. If missing, a sensible default depending on type, resolution and magnitude is used.  ''tzo'' is the time zone offset in hours (ignored for Duration Time objects). This value is subtracted from the stored UTC value to generate local time (it must include any daylight savings offset). If it is not supplied, the current time zone and daylight savings information is used for the conversion. Pass a value of {{{0.0}}} to return the string in UTC (GMT).
|%a|Abbreviated weekday name.|
|%A|Full weekday name.|
|%b|Abbreviated month name.|
|%B|Full month name.|
|%c, %#c|Date and time representation appropriate for locale (short form, long form).|
|%d, %#d|Day of month as decimal number ({{{01  31, 1  31}}}).|
|%H, %#H|Hour in 24-hour format ({{{00  23, 0  23}}}).|
|%I, %#I|Hour in 12-hour format ({{{01  12, 1  12}}}).|
|%j, %#j|Day of year as decimal number ({{{001  366, 1  366}}}).|
|%m, %#m|Month as decimal number ({{{01  12, 1  12}}}).|
|%M, %#M|Minute as decimal number ({{{00  59, 0  59}}}).|
|%p|Current locale's A.M./P.M. indicator for 12-hour clock.|
|%S, %#S|Second as decimal number ({{{00  59, 0  59}}}).|
|%U, %#U|Week of year as decimal number, with Sunday as first day of week ({{{00  53, 0  53}}}).|
|%w|Weekday as decimal number with Sunday = {{{0}}} ({{{0  6}}}).|
|%W, %#W|Week of year as decimal number, with Monday as first day of week ({{{00  53, 0  53}}}).|
|%x, %#x|Date representation for current locale (short form, long form).|
|%X|Time representation for current locale.|
|%y, %#y|Year without century, as decimal number ({{{00  99, 0  99}}}).|
|%Y|Year with century, as decimal number.|
|%%|Percent sign.|
|%w, %W|Duration number of weeks (integer rounded down, floating point).|
|%d, %D|Duration number of days (integer rounded down, floating point).|
|%h, %H|Duration number of hours (integer rounded down, floating point).|
|%m, %M|Duration number of minutes (integer rounded down, floating point).|
|%s, %S|Duration number of seconds (integer rounded down, floating point).|
{{{
print(Time():format(&quot;%Y %B %#d %I:%M%p&quot;))
print(Time{hours=3.412}:format(&quot;%h hours %M minutes&quot;))
}}}</pre>
</div>
<div title="time:time" creator="John Hind" modifier="John Hind" created="201006021819" modified="201402211722" changecount="4">
<pre>!hour, minute, second = time:time([tzo])
Return the ''hour'', ''minute'' and ''second'' components of an absolute or time-of-day Time. ''hour'' and ''minute'' are integers {{{0 .. 23}}} or {{{0 .. 59}}}, ''second'' is a real number {{{0 .. 59.999}}}.

If ''tzo'' is omitted, local time is returned, if it is {{{0.0}}}, UTC is returned, otherwise it is the time zone offset in hours.
{{{
print(&quot;UTC: &quot;, Time():time(0))
print(&quot;Local: &quot;, Time():time())
}}}</pre>
</div>
<div title="time:type" creator="John Hind" modifier="John Hind" created="201006021821" modified="201402211725" changecount="7">
<pre>!type, res = time:type()
Return the type and resolution (if applicable) of a Time object. ''type'' is a String key, '''absolute''', '''day''' or '''duration'''. ''res'' is returned only if ''type'' is '''absolute''' and is a String key, '''year''', '''month''', '''day''', '''hour''' or '''minute''' (or empty string meaning full resolution).
{{{
a = Time{year=2010}
print(a:type())
}}}
</pre>
</div>
<div title="time:value" creator="John Hind" modifier="John Hind" created="201006021822" modified="201402051045" changecount="1">
<pre>!val = time:value()
Return the value of the Time object as a real number of days. This is most useful for Duration type objects, but it works for all types.
{{{
print(Time{weeks=3.412}:value())
}}}</pre>
</div>
<div title="time:zone" creator="John Hind" modifier="John Hind" created="201006021824" modified="201402091953" changecount="5">
<pre>!offset, name, dstoffset = time:zone()
Return time zone information for the current time zone of the machine. ''time'' must be an absolute Time object and the return values include DST information appropriate for this time and date. The object must have minute resolution or better to enable the exact DST switching time to be accounted for.

''offset'' is a Number representing the total offset from UTC in hours comprising the zone offset and the DST offset. ''name'' is a String name for the time zone. ''dstoffset'' is a Number representing the daylight savings time offset applicable (it will be {{{0.0}}} if DST is not in effect at the represented date and time).
{{{
print(Time{year=1985, month=5, day=23, hour=10, minute=3}:zone())
}}}
</pre>
</div>
<div title="winsh.balloon" creator="John Hind" modifier="John Hind" created="201005302244" modified="201402041706" changecount="2">
<pre>!winsh.balloon(title [,body [,icon [,timeout]]])
Show a message balloon on the taskbar notification icon (which must be showing having been installed using [[winsh.taskicon]]).

If ''title'' is a string it specifies the text to appear in the top line of the balloon. If it is Boolean ''false'', any existing balloon is removed.

''body'' must be a string if supplied and is a longer message than appears below the title on the balloon.

''icon'' is an optional  string key which specifies one of a fixed set of icon images to show (note that these are NOT resources as are used in [[winsh.taskicon]]). The ''icon'' keys are: ''none'', ''info'', ''exclamation'', ''stop'' or ''winsh'' (the last is a resource icon, but the one selected by [[winsh.setidentity]] not necessarily called ''winsh'').

''timeout'' is an optional number which specifies the time the balloon remains in place in milliseconds (the default 0 means remain until explicitly removed). 
{{{
winsh.taskicon(&quot;LOCK&quot;, false)
winsh.balloon(&quot;TITLE OF BALLOON&quot;, &quot;Some text to go in the balloon&quot;, 'info', 10000)
}}}</pre>
</div>
<div title="winsh.environment" creator="John Hind" modifier="John Hind" created="201005302240" modified="201402211655" changecount="5">
<pre>!res = winsh.environment([string])
This function has two distinct modes. With no parameter, it returns a table comprising all the environment variables of this Winsh process. This will include all those inherited from Windows plus a number of extra &quot;Winsh specials&quot; added on process initialisation (see below). With a string parameter, any embedded environment variable names are substituted with corresponding values and the resulting string is returned.

The following Winsh environment variables are supported in addition to any inherited from Windows:

''%~G_COMPUTERNAME%'' - The DNS Physical Hostname of the computer.
''%~G_USERNAME%'' - The username of the current user.
''%~G_EXEDEV%'' - The device on which this exe file is located in the form '''C:'''.
''%~G_EXEPATH%'' - The filepath to the exe without device or name but with leading and trailing punctuation e.g. '''\fred\joe\'''.
''%~G_EXENAME%'' - The filename of the exe without path or extension or separators e.g. '''winsh'''.
''%~G_LUAEXT%'' - The file extension used for Lua script files, with a leading period e.g. '''.lua'''.

For example, you could create a filename for a log file alongside the exe file as follows:
{{{
print(winsh.environment([[%G_EXEDEV%%G_EXEPATH%%G_EXENAME%.log]]))
for k, v in Table(winsh.environment()) do print(k .. &quot; = &quot; .. v) end
}}}
</pre>
</div>
<div title="winsh.file" creator="John Hind" modifier="John Hind" created="201005302215" modified="201402171227" changecount="3">
<pre>!winsh.file()
This returns an iterator for use in generic {{{for}}} which produces the lines in a file (as set using [[winsh.setfile]]). If no file is set, reads piped input from ''stdin'' (for [[Console Applications]]).

See [[winsh.setfile]] for an example.</pre>
</div>
<div title="winsh.hotkey" creator="John Hind" modifier="John Hind" created="201005302250" modified="201402211701" changecount="10">
<pre>!res = winsh.hotkey(action, key [,modifiers ...])
Link an action to a system-wide Windows hotkey. Return Boolean ''true'' on success, ''false'' if the key cannot be assigned, usually because it is already assigned to a different application.

''action'' may be any Lua callable object (such as a [[Command Class]] object, an object of [[DelegateList Class]] or a simple Lua function).

''key'' must be a number {{{0..255}}} which is either a virtual key code from the ''VK'' table or the ASCII code of an uppercase letter or number. The ASCII codes can be conveniently generated in Lua using, for example, {{{string.byte(&quot;A&quot;)}}}.

The remaining parameters are string keys from the set '''alt'''; '''ctrl'''; '''shift'''; '''win''' (zero to four additional parameters may be specified from this set). They represent keys which must be held down whilst the main key is pressed.
{{{
print(winsh.hotkey(function() print(&quot;HOTKEY&quot;) end, VK.SPACE, 'alt'))
}}}</pre>
</div>
<div title="winsh.kbhit" creator="John Hind" modifier="John Hind" created="201311301505" modified="201311301520" changecount="4">
<pre>!hit = winsh.kbhit()
This is for use in command-line utilities only (mode ''stdio'' in [[winsh.outputmode]]). It returns Boolean {{{true}}} if there is data waiting in the keyboard buffer. In contrast to [[winsh.waitkey]], it is a non-blocking function which always returns immediately.

If this function returns {{{true}}}, use the [[winsh.file]] iterator, or {{{k = winsh.waitkey(&quot;&quot;)}}} to read from the keyboard buffer.
</pre>
</div>
<div title="winsh.lasterror" creator="John Hind" modifier="John Hind" created="201005302209" modified="201402041631" changecount="2">
<pre>!error = winsh.lasterror()
Return a string being the last error message reported (or an empty string). This is primarily for use in functions linked to the ''{{{GT.ERROR}}}'' event. Use [[winsh.outputmode]] to suppress automatic display of error messages.
{{{
winsh.onevent(GT.ERROR, function() 
  print(&quot;Error Event: &quot; .. winsh.lasterror())
end)
error(&quot;My Test Error&quot;)
}}}</pre>
</div>
<div title="winsh.loadscript" creator="John Hind" modifier="John Hind" created="201005302254" modified="201402211705" changecount="2">
<pre>!func = winsh.loadscript(name)
!r,e  = winsh.loadscript(name)
Low-level function which loads a script from a file or resource returning it as a Lua function. The string parameter ''name'' can be a full file path and name, the name of a resource in the exe file or the name of a file in the same directory as the executable file.

If the file or resource cannot be found, returns two values, r = Boolean false and e = a string error message. If compiling the file or resource results in an error, returns two values, r = nil and e = a string error message.

Example:
{{{
s1,e = winsh.loadscript(&quot;test&quot;)
if s1 then s1() else print(e) end
s2,e = winsh.loadscript(&quot;test.gnt&quot;)
if s2 then s2() else print(e) end
}}}
</pre>
</div>
<div title="winsh.messagebox" creator="John Hind" modifier="John Hind" created="201005302249" modified="201402211658" changecount="5">
<pre>!button = winsh.messagebox(message [,icon [,buttons [,defbutton]]])
Present a message box and return a string according to the button the user presses.

''message'' is a string defining the text message that appears in the message box.

''icon'' is a string key specifying one of a fixed set of icons to appear on the message box. The default is '''none''' and the set is '''none'''; '''stop'''; '''question'''; '''exclamation'''; '''asterisk'''.

''buttons'' is a string key which specifies which buttons should appear with the default '''ok''' from the set '''ok'''; '''ok+cancel'''; '''abort+retry+ignore'''; '''yes+no+cancel'''; '''yes+no'''; '''retry+cancel'''; '''cancel+tryagain+continue'''.

''defbutton'' is a number which specifies which button is the default, counting from 1 being the first in the set.

The return value is a string which matches a component in the button set (for example '''tryagain'''), identifying which button the user pressed.
{{{
print(winsh.messagebox(&quot;Message&quot;, 'question', 'yes+no+cancel', 2))
}}}</pre>
</div>
<div title="winsh.mutex" creator="John Hind" modifier="John Hind" created="201005302234" modified="201404131332" changecount="6">
<pre>!res = winsh.mutex(scope [,ident [,command]])
Return Boolean ''true'' if this is the only instance of this process or ''false'' if one or more other instances are found. Optionally pass a command to any other instances that are found.

For processes to be considered the &quot;same&quot; all of the following must be true: They must exist within the same ''scope''; They must have the same file name (just the name, not the path); Both must have executed (or be executing) [[winsh.mutex]] with the same ''ident'' string parameter; and finally both must have the same ''UUID'' string in their string resources (which will be true unless this has been explicitly changed).

Parameter ''scope'' is a string key (defaulting to ''desktop''), one of:
;'''system'''
:Unique to this computer.
;'''desktop'''
:Unique to this desktop in multi-user terminal server systems.
;'''session'''
:Unique to this log-on (a given user may log-on more than once).
;'''user'''
:Unique to all log-on sessions for this user.

Parameter ''ident'' is an arbitrary string value which can be set differently to avoid two processes being considered identical.

Parameter ''command'' is a string which constitutes a valid Winsh [[command-line]]. If this is supplied it will be sent to and executed on any other instances which are found (this does not restart the other instance, just schedules additional scripts or code to run when the process is next idle). Lua variables can be passed to the script executed in the other instances as ''vararg'' parameters by concatenating the result of [[winsh.ps]] at the end of the ''command'' string.

This function can be used simply to prevent multiple instances running by exiting on a ''false'' return value. Or it can be used to implement a server and command system: the first instance executes the command and then continues running. Subsequent instances send the command to the first instance and then exit. Finally, it can be used to implement multi-processing with cross-process signaling: On a return ''true'' value, the process appoints itself master and uses [[winsh.spawn]] to start one or more worker processes. Each process can then execute further [[winsh.mutex]] calls to broadcast messages to all the others.

Example:
{{{
-- Start two instances of Winsh and run this in both:
if winsh.mutex(&quot;desktop&quot;, &quot;thisapp&quot;,
  [[&quot;-e'print('Message from the other instance')'&quot;]]) then
  print(&quot;This is the first instance&quot;)
else
  print(&quot;Another instance was already running&quot;)
end
}}}
</pre>
</div>
<div title="winsh.onevent" creator="John Hind" modifier="John Hind" created="201005152240" modified="201402211648" tags="[[winsh library]]" changecount="7">
<pre>!winsh.onevent(event, cmd [,wpfilter] [,processor])

Specify that a Lua callable object (such as a [[Command Class]] object, a [[DelegateList Class]] object or a simple Lua function) ''cmd'' should be called when the event coded by the number ''event'' occurs. Event codes are Windows Message Numbers and constants for commonly useful ones are in the [[WM table]] with Winsh specific ones in the [[GT table]]. The optional numeric parameter ''wpfilter'' specifies that the function should only be called if the ''wparam'' of the Windows message matches the value of ''wpfilter''. The ''processor'' parameter is rarely needed and is described below.

Whenever the event occurs, ''cmd'' is called with three numeric parameters, the first being an abstract index corresponding to ''cmd'' (rarely useful in simple handlers); the second is the event code (allowing one function to handle several events); the third is the ''lparam'' value from the Windows message (unless a non-default ''processor'' is specified). Generally, the parameters to the ''event'' function can be ignored and any return values from it are discarded.

Message processors control the translation from the Windows message to the Lua message and whether the Lua message is ''posted'' or ''sent''. For technical reasons, message processors cannot be written in Lua so a number of standard processors are supplied. There are four in the ''winsh'' library and additional more specialised ones may be added by other libraries. The ''processor'' parameter is a string key which specifies the processor to use (postl is used by default for WM events, sendl for GT events).
;'''postl'''
:Posts the Lua message and passes the lparam through as the third parameter.
;'''postw'''
:Posts the Lua message and passes the wparam through as the third parameter.
;'''sendl'''
:Sends the Lua message and passes the lparam through as the third parameter.
;'''sendw'''
:Sends the Lua message and passes the wparam through as the third parameter.
Example:
{{{
winsh.outputmode(&quot;gui&quot;, true) -- Suppress normal error reporting
winsh.onevent(GT.ERROR, function() print(&quot;error message: &quot;, winsh.lasterror()) end)
j = r / 0
}}}
</pre>
</div>
<div title="winsh.outputmode" creator="John Hind" modifier="John Hind" created="201005302206" modified="201406131008" changecount="10">
<pre>!winsh.outputmode(print [,error])
Set the destination for the print function and for error messages. If ''error'' is omitted, error messages use the ''print'' destination. Each parameter can either be a string being one of the key values below, or it can be an object of [[Set Class]] containing one or more of these keys.
{{{
winsh.outputmode(&quot;report&quot;, Set{[&quot;gui&quot;],[&quot;debugger&quot;]})
print(&quot;Message on Report Window&quot;)
error(&quot;error on console and debug&quot;)
}}}
The destination is a string key from the following set:
;'''void'''
:Output goes nowhere (ignored in a [[Set Class]] parameter).
;'''gui'''
:Output to the Graphical Console (the default).
;'''report'''
:Output to the Report Window.
;'''stdio'''
:Print output to ''stdout'', errors to ''stderr'' (for [[Console Applications]]).
;'''file'''
:Output to the file set by [[winsh.setfile]]. If there is no file set, this option is the same as '''void'''.
;'''debugger'''
:Output to the debugger channel.
Note that more advanced error reporting (such as sending an email for example) can be achieved using the ''{{{GT.ERROR}}}'' event and the [[winsh.lasterror]] function. Standard error reporting can be suppressed by setting the ''error'' parameter to ''void''.
</pre>
</div>
<div title="winsh.ps" creator="John Hind" modifier="John Hind" created="201008292146" modified="201402211706" changecount="3">
<pre>!string = winsh.ps( ... )
Prepares a string for passing as parameters to another Winsh.lua instance using [[winsh.spawn]] or [[winsh.mutex]] (or the process could be started using the [[ShellObject Class]] in the [[Shell Library]]). Any number of parameters of ''number'', ''string'', ''boolean'' or ''nil'' type may be supplied and they will be stringized and concatenated into the return string. The returned string may be concatenated directly to the end of a command line for another Winsh.lua process. The form is such that it will produce the same parameters of the same types in the ''vararg'' parameters to the script chunk.

Example:
{{{
print(winsh.ps(&quot;a string&quot;, nil, true, false, 123, &quot;another string&quot;))
}}}</pre>
</div>
<div title="winsh.setfile" creator="John Hind" modifier="John Hind" created="201005302214" modified="201404131201" changecount="17">
<pre>!res = winsh.setfile([name [, ...]])
Set the file to be used for the ''file'' option of [[winsh.outputmode]] or to be read using the [[winsh.file]] iterator. With no parameters, restores the default which is '''stdin''' for [[winsh.file]] or the same as the ''void'' option for [[winsh.outputmode]].

Parameter ''name'' must resolve to a full file path after processing. Any environment variables are expanded (as for [[winsh.environment]]) and then if the result is a relative path it is resolved relative to the path to the {{{winsh}}} executable.

Following the name may be any combination of the following string keys in any order:
;'''clear'''
:Normally, if ''name'' resolves to an existing file, new lines will be appended to it, however if you include this option the file will be cleared immediately before writing the first new line.
;'''unique'''
:If ''name'' resolves to an existing file, the file name is made unique by appending a serial number and a new file is created.
;'''build'''
:Normally this function will fail if the path specified in ''name'' does not already exist. If this option is specified, any missing path folders will be iteratively created if possible.
For compatability reasons, if the second parameter is other than a string and tests boolean {{{true}}}, the '''clear''' option is specified (and any further parameters are ignored).

Returns Boolean ''true'' if the file is ready, ''false'' if the file could not be created or opened.
{{{
winsh.setfile(&quot;%G_EXENAME%.log&quot;, 'clear')
winsh.outputmode('file', 'gui')
print(&quot;Line 1&quot;)
print(&quot;Line 2&quot;)
winsh.outputmode('gui')
for line in winsh.file() do print(&quot;Read: &quot; .. line) end
}}}</pre>
</div>
<div title="winsh.setidentity" creator="John Hind" modifier="John Hind" created="201005302101" modified="201402041545" changecount="1">
<pre>!winsh.setidentity(name [,icon])
Set the icon and title string for the application. Parameter ''name'' must be a string and parameter ''icon'' if present must be a string which matches an icon set resource name. If ''icon'' is missing, the icon is not changed. For example:
{{{
winsh.setidentity(&quot;The title of my app&quot;, &quot;lock&quot;)
}}}
</pre>
</div>
<div title="winsh.setreport" creator="John Hind" modifier="John Hind" created="201005302220" modified="201404131324" changecount="15">
<pre>!winsh.setreport(act [,px [,py]])
Performs various control actions on the Report Window according to the string key ''act'' using the optional parameters ''px'' and ''py''.

The ''act'' parameter must be one of the following:
;'''clear'''
:Clears the contents of the Report Window (optionally after delay ''px'').
;'''hide'''
:Hides the Report Window (optionally after delay ''px''). It will be shown again when and if further text is written to it.
;'''resize'''
:Sets the size of the Report Window to ''px'' pixels wide and ''py'' pixels high. Value of 0 for either (which is the default) leaves that dimension unchanged.
;'''position'''
:Sets the position of the Report Window. If ''px'' is a number, it is the offset from the left side of the virtual screen and ''py'' is the offset from the top. If ''px'' is not a number it must be a string key, one of '''center'''; '''centertop'''; '''righttop'''; '''rightcenter'''; '''rightbottom'''; '''centerbottom'''; '''leftbottom'''; '''leftcenter''' or '''lefttop''' which positions the window on the primary monitor. In either case, the window is shrunk if necessary to fit, so you can fill the available screen size by first using '''resize''' with a very large number and then using '''position'''.
;'''bottomright'''
:DEPRECATED. Use {{{winsh.setreport('position', 'rightbottom')}}}.
;'''delete'''
:Deletes the last line on the Report Window (useful for temporary messages).
;'''reset'''
:Clears any progress indication.
;'''running'''
:Sets the progress indication to indicate that a process is running. ''px'' may be a progress percentage value 1..100. If it is present, a scaled progress bar is shown, otherwise a non-specific progress animation is shown.
;'''paused'''
:Sets the progress indication to show a temporary pause to progress.
;'''error'''
:Sets the progress indication to show that progress has ended with failure.
;'''done'''
:Sets the progress indication to show that progress has ended with success.
;'''overlay'''
:On Windows 7 or later, sets an icon specified by name as the overlay icon shown on the taskbar button. ''px'' must be the name of an icon in the resources. If it is missing, or an icon of that name is not found, the exiting overlay if any will be removed. Has no effect on earlier Windows versions.
;'''minimise'''
:Minimises the Report Window. There is special handling for Windows 7 or later so that Aero Peek will still be actively updated.
When ''px'' is used as a timeout it specifies the delay in milliseconds with a minimum of 400. Note that delayed operations are non-blocking so if a delayed operation is followed by a non-delayed one, the latter will be executed first.

Progress indications are displayed in the Window title bar, using chevron animations in the bottom line of the report text and, in Windows 7 or later, on the taskbar button.
{{{
winsh.outputmode(&quot;report&quot;)
print(&quot;Message on the report window&quot;)
winsh.setreport(&quot;position&quot;, 10, 10)
winsh.setreport(&quot;resize&quot;, 500, 800)
print(&quot;Window will be cleared in 10 seconds time&quot;)
winsh.setreport(&quot;clear&quot;, 10000)
winsh.setreport(&quot;hide&quot;, 15000)
winsh.outputmode(&quot;gui&quot;)
}}}</pre>
</div>
<div title="winsh.spawn" creator="John Hind" modifier="John Hind" created="201005302226" modified="201402211650" changecount="5">
<pre>!res = winsh.spawn(command [,options ...])
Starts a new process using this Winsh Executable passing it the [[command-line]] specified by the string parameter ''command''. The command line may pass the new process a script file or resource to execute and/or use the ''-e'' option to execute a Lua string directly. If specifying a script file or resource, the values of Lua variables may be passed to this script using ''vararg'' by formatting them to a string using [[winsh.ps]] and concatenating the result to the end of the ''command'' string.

Two options are supported, specified in any order by string keys:
;'''admin'''
:Causes the process to be &quot;run as administrator&quot; on Vista or later.
;'''sync'''
:Suspends the current process until the spawned process terminates.
If ''sync'' is specified, [[winsh.spawn]] returns a number, the process exit code of the spawned process, or Boolean ''false'' if the process cannot be started. If ''sync'' is not specified [[winsh.spawn]] returns immediately with Boolean ''false'' or ''true'' indicating if the process was successfully started.

Example:
{{{
function startelevated(cmd, dir)
  local elc = [[&quot;-e task.Application(']] .. cmd .. [[']]
  if dir then elc = elc .. [[, ']] .. dir .. [[']] end
  elc = elc .. [[):open()&quot;]]
  return winsh.spawn(elc, 'admin')
end
startelevated(&quot;notepad.exe&quot;)
}}}
</pre>
</div>
<div title="winsh.taskicon" creator="John Hind" modifier="John Hind" created="201005151425" modified="201404131355" tags="[[winsh library]]" changecount="34">
<pre>!winsh.taskicon(icon , rightmenu[ ,leftmenu][ ,cmds])
Installs, changes or removes a taskbar notification icon and optionally assigns context menus to it. If ''icon'' is a string it must be the name of an icon resource in the exe file. Alternatively ''icon'' may be an object of [[Icon Class]] from the [[Shell Library]]. To remove a previously installed icon, pass Boolean ''false'' as the first (and only) parameter.

''rightmenu'' should be either an object of [[Menu Class]] to define a right-click menu or Boolean ''false'' for no menu.

''leftmenu'' should be either Boolean ''true'' to specify that the same menu will be shown on either left- or right-click, an object of [[Menu Class]] to define a different menu, or Boolean ''false'' to specify no menu on left-click (the default).

''cmds'' parameter, if present, must be a positive integer. It specifies the maximum number of commands that will be allowed on a displayed menu (including any sub-menus) and defaults to 10 (which is also the minimum value). Commands are allocated from a limited pool in a contiguous block. If ''cmds'' is increased in a subsequent call, a new block is allocated and the old block is wasted. A ''cmds'' parameter that would reduce the current allocation is ignored. It is therefore most efficient to allocate ''cmds'' once in the first call with a value just sufficient to accommodate the largest possible menu in the application.

Once a taskbar notification icon is present, [[winsh.balloon]] may be used to show a notification balloon.

A Lua callable (such as a [[Command Class]] object or a simple function) may be attached directly to the left- or right-click action using [[winsh.onevent]].
{{{
winsh.onevent(GT.NOTIFY_LCLICK, function() print(&quot;LCLICK&quot;) end)
winsh.onevent(GT.NOTIFY_RCLICK, function() print(&quot;RCLICK&quot;) end)
winsh.taskicon(&quot;LOCK&quot;, false)
}}}
If a menu is assigned to the click event, it is recommended to use the ''onshow'' field in the Menu Object if it is necessary to modify the menu before it is shown rather than the click event. The click events may be triggered before or after the menu has been displayed and the ''onshow'' handler receives a convenient reference to the Menu object.

Note: It is a (somewhat patchy) Windows convention for the right click to show a menu containing a default action while the left click executes that default action directly. This can be achieved as in the following example:
{{{
local cmd1 = winsh.Command(&quot;default command&quot;, function() print(&quot;default&quot;) end)
cmd1.default = true
local cmd2 = winsh.Command(&quot;other command&quot;, function() print(&quot;other&quot;) end)
local mnu1 = winsh.Menu(&quot;Menu&quot;)
mnu1:add(&quot;Menu title&quot;)
mnu1:add(cmd1)
mnu1:add(cmd2)
winsh.onevent(GT.NOTIFY_LCLICK, cmd1)
winsh.taskicon(&quot;LOCK&quot;, mnu1)
}}}
To remove the task icon:
{{{
winsh.taskicon(false)
}}}</pre>
</div>
<div title="winsh.waitkey" creator="John Hind" modifier="John Hind" created="201005302252" modified="201402211702" changecount="8">
<pre>!res = winsh.waitkey([prompt [,keys]])
This is for use in command-line utilities only (mode ''stdio'' in [[winsh.outputmode]]). It prints a message on the console and then blocks until the user presses a key. To test for a keypress without blocking, see [[winsh.kbhit]].

The string ''prompt'' can override the default prompt message ''&quot;Press any key to continue&quot;''.

The string ''keys'' specifies a set of keyboard keys constraining the key which will be accepted (if missing, any key will be accepted). If ''keys'' is specified, the result is a number being the position of the key actually pressed in the set ({{{1}}} being the first character). If ''keys'' is not specified, returns a single character string generated from the key that was pressed.

Example:
{{{
winsh.outputmode(&quot;stdio&quot;)
print(winsh.waitkey(&quot;Press one of these keys [Y, N, M]:&quot;, &quot;YNM&quot;))
print(&quot;Type some lines of text (will not echo until line terminated), ^c to exit.&quot;)
for s in winsh.file() do
  print(&quot;Echo: &quot;, s)
end
print(&quot;Finished&quot;)
}}}</pre>
</div>
<div title="zzJHFinalPlugin" creator="John Hind" modifier="John Hind" created="201102041558" modified="201103041742" tags="systemConfig settings excludeLists excludeSearch excludeMissing">
<pre>/***
|Name|zzJHFinalPlugin|
|Version|1.0.0|
|Author|John Hind|
|~CoreVersion|2.1|
|Type|plugin|
|Description|Final initialisation customisation implementing Publish features|
!!!!!Revisions
&lt;&lt;&lt;
2011.02.14 [1.0.0] initial release
&lt;&lt;&lt;
!!!!!Code
***/
//{{{
version.extensions.zzJHFinalPlugin= {major: 1, minor: 0, revision: 0, date: new Date(2011,02,14)};

// We do not want these states to be 'sticky' - it is confusing!
config.options.chkBackstage=false;
config.options.chkShowLeftSidebar=true;

// Options which appear on the Search Results Tiddler should not be 'sticky'.
config.options.chkSearchShadows=false;
config.options.chkSearchFields=false;
config.options.chkSearchTitles=true;
config.options.chkSearchText=true;
config.options.chkSearchTags=true;
config.options.txtIncrementalSearchDelay=500;
config.options.txtIncrementalSearchMin=3;
config.options.chkSearchByDate=false;
config.options.chkSearchExcludeTags=true
config.options.txtSearchExcludeTags=&quot;excludeSearch&quot;;
config.options.chkSearchHighlight=true;
config.options.chkSearchOpenTiddlers=false;
config.options.chkIncrementalSearch=true;
config.options.chkCaseSensitiveSearch=false;

// Some cosmetic changes:
config.macros.list.all.prompt=&quot;&quot;;
config.macros.list.story.prompt=&quot;&quot;;

// Default theme provides a different view template in readOnly:
if ((!config.options.txtTheme)||(!store.getTiddlerText(config.options.txtTheme)))
    config.options.txtTheme = &quot;DefaultTheme&quot;;

// Switch readOnly mode depending on existance of 'published' tiddler:
if (config.macros.publish.ispublished())
{
    readOnly=true;
    showBackstage=false;
    useJavaSaver=false;
}
else
{
    readOnly=false;
    showBackstage=true;
}
//}}}
</pre>
</div>
</div>
<!--POST-STOREAREA-->
<!--POST-BODY-START-->
<!--POST-BODY-END-->
<script id="jsArea" type="text/javascript">
//<![CDATA[
//
// Please note:
//
// * This code is designed to be readable but for compactness it only includes brief comments. You can see fuller comments
//   in the project repository at https://github.com/TiddlyWiki/tiddlywiki
//
// * You should never need to modify this source code directly. TiddlyWiki is carefully designed to allow deep customisation
//   without changing the core code. Please consult the development group at http://groups.google.com/group/TiddlyWikiDev
//
// JSLint directives
/*global jQuery:false, version:false */
/*jslint bitwise:true, browser:true, confusion:true, eqeq:true, evil:true, forin:true, maxerr:100, plusplus:true, regexp:true, sloppy:true, sub:true, undef:true, unparam:true, vars:true, white:true */

//--
//-- Configuration repository
//--

// Miscellaneous options
var config = {
	numRssItems: 20, // Number of items in the RSS feed
	animDuration: 400, // Duration of UI animations in milliseconds
	cascadeFast: 20, // Speed for cascade animations (higher == slower)
	cascadeSlow: 60, // Speed for EasterEgg cascade animations
	cascadeDepth: 5, // Depth of cascade animation
	locale: "en" // W3C language tag
};

// Hashmap of alternative parsers for the wikifier
config.parsers = {};

// Adaptors
config.adaptors = {};
config.defaultAdaptor = null;

// Backstage tasks
config.tasks = {};

// Annotations
config.annotations = {};

// Custom fields to be automatically added to new tiddlers
config.defaultCustomFields = {};

// Messages
config.messages = {
	messageClose: {},
	dates: {},
	tiddlerPopup: {}
};

// Options that can be set in the options panel and/or cookies
config.options = {
	chkRegExpSearch: false,
	chkCaseSensitiveSearch: false,
	chkIncrementalSearch: true,
	chkAnimate: true,
	chkSaveBackups: true,
	chkAutoSave: false,
	chkGenerateAnRssFeed: false,
	chkSaveEmptyTemplate: false,
	chkOpenInNewWindow: true,
	chkToggleLinks: false,
	chkHttpReadOnly: true,
	chkForceMinorUpdate: false,
	chkConfirmDelete: true,
	chkInsertTabs: false,
	chkUsePreForStorage: true, // Whether to use <pre> format for storage
	chkDisplayInstrumentation: false,
	txtBackupFolder: "",
	txtEditorFocus: "text",
	txtMainTab: "tabTimeline",
	txtMoreTab: "moreTabAll",
	txtMaxEditRows: "30",
	txtFileSystemCharSet: "UTF-8",
	txtTheme: ""
	};
config.optionsDesc = {};

config.optionsSource = {};

// Default tiddler templates
var DEFAULT_VIEW_TEMPLATE = 1;
var DEFAULT_EDIT_TEMPLATE = 2;
config.tiddlerTemplates = {
	1: "ViewTemplate",
	2: "EditTemplate"
};

// More messages (rather a legacy layout that should not really be like this)
config.views = {
	wikified: {
		tag: {}
	},
	editor: {
		tagChooser: {}
	}
};

// Backstage tasks
config.backstageTasks = ["save","importTask","tweak","upgrade","plugins"];

// Extensions
config.extensions = {};

// Macros; each has a 'handler' member that is inserted later
config.macros = {
	today: {},
	version: {},
	search: {sizeTextbox: 15},
	tiddler: {},
	tag: {},
	tags: {},
	tagging: {},
	timeline: {},
	allTags: {},
	list: {
		all: {},
		missing: {},
		orphans: {},
		shadowed: {},
		touched: {},
		filter: {}
	},
	closeAll: {},
	permaview: {},
	saveChanges: {},
	slider: {},
	option: {},
	options: {},
	newTiddler: {},
	newJournal: {},
	tabs: {},
	gradient: {},
	message: {},
	view: {defaultView: "text"},
	edit: {},
	tagChooser: {},
	toolbar: {},
	plugins: {},
	refreshDisplay: {},
	importTiddlers: {},
	upgrade: {
		source: "http://tiddlywiki-releases.tiddlyspace.com/upgrade",
		backupExtension: "pre.core.upgrade"
	},
	sync: {},
	annotations: {}
};

// Commands supported by the toolbar macro
config.commands = {
	closeTiddler: {},
	closeOthers: {},
	editTiddler: {},
	saveTiddler: {hideReadOnly: true},
	cancelTiddler: {},
	deleteTiddler: {hideReadOnly: true},
	permalink: {},
	references: {type: "popup"},
	jump: {type: "popup"},
	syncing: {type: "popup"},
	fields: {type: "popup"}
};

// Control of macro parameter evaluation
config.evaluateMacroParameters = "all";

// Basic regular expressions
config.textPrimitives = {
	upperLetter: "[A-Z\u00c0-\u00de\u0150\u0170]",
	lowerLetter: "[a-z0-9_\\-\u00df-\u00ff\u0151\u0171]",
	anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]",
	anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff\u0150\u0170\u0151\u0171]"
};
if(!((new RegExp("[\u0150\u0170]","g")).test("\u0150"))) {
	config.textPrimitives = {
		upperLetter: "[A-Z\u00c0-\u00de]",
		lowerLetter: "[a-z0-9_\\-\u00df-\u00ff]",
		anyLetter:   "[A-Za-z0-9_\\-\u00c0-\u00de\u00df-\u00ff]",
		anyLetterStrict: "[A-Za-z0-9\u00c0-\u00de\u00df-\u00ff]"
	};
}
config.textPrimitives.sliceSeparator = "::";
config.textPrimitives.sectionSeparator = "##";
config.textPrimitives.urlPattern = "(?:file|http|https|mailto|ftp|irc|news|data):[^\\s'\"]+(?:/|\\b)";
config.textPrimitives.unWikiLink = "~";
config.textPrimitives.wikiLink = "(?:(?:" + config.textPrimitives.upperLetter + "+" +
	config.textPrimitives.lowerLetter + "+" +
	config.textPrimitives.upperLetter +
	config.textPrimitives.anyLetter + "*)|(?:" +
	config.textPrimitives.upperLetter + "{2,}" +
	config.textPrimitives.lowerLetter + "+))";

config.textPrimitives.cssLookahead = "(?:(" + config.textPrimitives.anyLetter + "+)\\(([^\\)\\|\\n]+)(?:\\):))|(?:(" + config.textPrimitives.anyLetter + "+):([^;\\|\\n]+);)";
config.textPrimitives.cssLookaheadRegExp = new RegExp(config.textPrimitives.cssLookahead,"mg");

config.textPrimitives.brackettedLink = "\\[\\[([^\\]]+)\\]\\]";
config.textPrimitives.titledBrackettedLink = "\\[\\[([^\\[\\]\\|]+)\\|([^\\[\\]\\|]+)\\]\\]";
config.textPrimitives.tiddlerForcedLinkRegExp = new RegExp("(?:" + config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");
config.textPrimitives.tiddlerAnyLinkRegExp = new RegExp("("+ config.textPrimitives.wikiLink + ")|(?:" +
	config.textPrimitives.titledBrackettedLink + ")|(?:" +
	config.textPrimitives.brackettedLink + ")|(?:" +
	config.textPrimitives.urlPattern + ")","mg");

config.glyphs = {
	currBrowser: null,
	browsers: [],
	codes: {}
};

//--
//-- Shadow tiddlers
//--

config.shadowTiddlers = {
	StyleSheet: "",
	MarkupPreHead: "",
	MarkupPostHead: "",
	MarkupPreBody: "",
	MarkupPostBody: "",
	TabTimeline: '<<timeline>>',
	TabAll: '<<list all>>',
	TabTags: '<<allTags excludeLists>>',
	TabMoreMissing: '<<list missing>>',
	TabMoreOrphans: '<<list orphans>>',
	TabMoreShadowed: '<<list shadowed>>',
	AdvancedOptions: '<<options>>',
	PluginManager: '<<plugins>>',
	SystemSettings: '',
	ToolbarCommands: '|~ViewToolbar|closeTiddler closeOthers +editTiddler > fields syncing permalink references jump|\n|~EditToolbar|+saveTiddler -cancelTiddler deleteTiddler|',
	WindowTitle: '<<tiddler SiteTitle>> - <<tiddler SiteSubtitle>>'
};


// Browser detection... In a very few places, there's nothing else for it but to know what browser we're using.
config.userAgent = navigator.userAgent.toLowerCase();
config.browser = {
	isIE: config.userAgent.indexOf("msie") != -1 && config.userAgent.indexOf("opera") == -1,
	isGecko: navigator.product == "Gecko" && config.userAgent.indexOf("WebKit") == -1,
	ieVersion: /MSIE (\d.\d)/i.exec(config.userAgent), // config.browser.ieVersion[1], if it exists, will be the IE version string, eg "6.0"
	isSafari: config.userAgent.indexOf("applewebkit") != -1,
	isBadSafari: !((new RegExp("[\u0150\u0170]","g")).test("\u0150")),
	firefoxDate: /gecko\/(\d{8})/i.exec(config.userAgent), // config.browser.firefoxDate[1], if it exists, will be Firefox release date as "YYYYMMDD"
	isOpera: config.userAgent.indexOf("opera") != -1,
	isChrome: config.userAgent.indexOf('chrome') > -1,
	isLinux: config.userAgent.indexOf("linux") != -1,
	isUnix: config.userAgent.indexOf("x11") != -1,
	isMac: config.userAgent.indexOf("mac") != -1,
	isWindows: config.userAgent.indexOf("win") != -1
};

merge(config.glyphs,{
	browsers: [
		function() {return config.browser.isIE;},
		function() {return true;}
		],
	codes: {
		downTriangle: ["\u25BC","\u25BE"],
		downArrow: ["\u2193","\u2193"],
		bentArrowLeft: ["\u2190","\u21A9"],
		bentArrowRight: ["\u2192","\u21AA"]
	}
});


//--
//-- Translateable strings
//--

// Strings in "double quotes" should be translated; strings in 'single quotes' should be left alone

merge(config.options,{
	txtUserName: "YourName"});

merge(config.tasks,{
	save: {text: "save", tooltip: "Save your changes to this TiddlyWiki"},
	importTask: {text: "import", tooltip: "Import tiddlers and plugins from other TiddlyWiki files and servers", content: '<<importTiddlers>>'},
	tweak: {text: "tweak", tooltip: "Tweak the appearance and behaviour of TiddlyWiki", content: '<<options>>'},
	upgrade: {text: "upgrade", tooltip: "Upgrade TiddlyWiki core code", content: '<<upgrade>>'},
	plugins: {text: "plugins", tooltip: "Manage installed plugins", content: '<<plugins>>'}
});

// Options that can be set in the options panel and/or cookies
merge(config.optionsDesc,{
	txtUserName: "Username for signing your edits",
	chkRegExpSearch: "Enable regular expressions for searches",
	chkCaseSensitiveSearch: "Case-sensitive searching",
	chkIncrementalSearch: "Incremental key-by-key searching",
	chkAnimate: "Enable animations",
	chkSaveBackups: "Keep backup file when saving changes",
	chkAutoSave: "Automatically save changes",
	chkGenerateAnRssFeed: "Generate an RSS feed when saving changes",
	chkSaveEmptyTemplate: "Generate an empty template when saving changes",
	chkOpenInNewWindow: "Open external links in a new window",
	chkToggleLinks: "Clicking on links to open tiddlers causes them to close",
	chkHttpReadOnly: "Hide editing features when viewed over HTTP",
	chkForceMinorUpdate: "Don't update modifier username and date when editing tiddlers",
	chkConfirmDelete: "Require confirmation before deleting tiddlers",
	chkInsertTabs: "Use the tab key to insert tab characters instead of moving between fields",
	txtBackupFolder: "Name of folder to use for backups",
	txtMaxEditRows: "Maximum number of rows in edit boxes",
	txtTheme: "Name of the theme to use",
	txtFileSystemCharSet: "Default character set for saving changes (Firefox/Mozilla only)"});

merge(config.messages,{
	customConfigError: "Problems were encountered loading plugins. See PluginManager for details",
	pluginError: "Error: %0",
	pluginDisabled: "Not executed because disabled via 'systemConfigDisable' tag",
	pluginForced: "Executed because forced via 'systemConfigForce' tag",
	pluginVersionError: "Not executed because this plugin needs a newer version of TiddlyWiki",
	nothingSelected: "Nothing is selected. You must select one or more items first",
	savedSnapshotError: "It appears that this TiddlyWiki has been incorrectly saved. Please see http://www.tiddlywiki.com/#Download for details",
	subtitleUnknown: "(unknown)",
	undefinedTiddlerToolTip: "The tiddler '%0' doesn't yet exist",
	shadowedTiddlerToolTip: "The tiddler '%0' doesn't yet exist, but has a pre-defined shadow value",
	tiddlerLinkTooltip: "%0 - %1, %2",
	externalLinkTooltip: "External link to %0",
	noTags: "There are no tagged tiddlers",
	notFileUrlError: "You need to save this TiddlyWiki to a file before you can save changes",
	cantSaveError: "It's not possible to save changes. Possible reasons include:\n- your browser doesn't support saving (Firefox, Internet Explorer, Safari and Opera all work if properly configured)\n- the pathname to your TiddlyWiki file contains illegal characters\n- the TiddlyWiki HTML file has been moved or renamed",
	invalidFileError: "The original file '%0' does not appear to be a valid TiddlyWiki",
	backupSaved: "Backup saved",
	backupFailed: "Failed to save backup file",
	rssSaved: "RSS feed saved",
	rssFailed: "Failed to save RSS feed file",
	emptySaved: "Empty template saved",
	emptyFailed: "Failed to save empty template file",
	mainSaved: "Main TiddlyWiki file saved",
	mainFailed: "Failed to save main TiddlyWiki file. Your changes have not been saved",
	macroError: "Error in macro <<%0>>",
	macroErrorDetails: "Error while executing macro <<%0>>:\n%1",
	missingMacro: "No such macro",
	overwriteWarning: "A tiddler named '%0' already exists. Choose OK to overwrite it",
	unsavedChangesWarning: "WARNING! There are unsaved changes in TiddlyWiki\n\nChoose OK to save\nChoose CANCEL to discard",
	confirmExit: "--------------------------------\n\nThere are unsaved changes in TiddlyWiki. If you continue you will lose those changes\n\n--------------------------------",
	saveInstructions: "SaveChanges",
	unsupportedTWFormat: "Unsupported TiddlyWiki format '%0'",
	tiddlerSaveError: "Error when saving tiddler '%0'",
	tiddlerLoadError: "Error when loading tiddler '%0'",
	wrongSaveFormat: "Cannot save with storage format '%0'. Using standard format for save.",
	invalidFieldName: "Invalid field name %0",
	fieldCannotBeChanged: "Field '%0' cannot be changed",
	loadingMissingTiddler: "Attempting to retrieve the tiddler '%0' from the '%1' server at:\n\n'%2' in the workspace '%3'",
	upgradeDone: "The upgrade to version %0 is now complete\n\nClick 'OK' to reload the newly upgraded TiddlyWiki",
	invalidCookie: "Invalid cookie '%0'"});

merge(config.messages.messageClose,{
	text: "close",
	tooltip: "close this message area"});

config.messages.backstage = {
	open: {text: "backstage", tooltip: "Open the backstage area to perform authoring and editing tasks"},
	close: {text: "close", tooltip: "Close the backstage area"},
	prompt: "backstage: ",
	decal: {
		edit: {text: "edit", tooltip: "Edit the tiddler '%0'"}
	}
};

config.messages.listView = {
	tiddlerTooltip: "Click for the full text of this tiddler",
	previewUnavailable: "(preview not available)"
};

config.messages.dates.months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November","December"];
config.messages.dates.days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
config.messages.dates.shortMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
config.messages.dates.shortDays = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
// suffixes for dates, eg "1st","2nd","3rd"..."30th","31st"
config.messages.dates.daySuffixes = ["st","nd","rd","th","th","th","th","th","th","th",
		"th","th","th","th","th","th","th","th","th","th",
		"st","nd","rd","th","th","th","th","th","th","th",
		"st"];
config.messages.dates.am = "am";
config.messages.dates.pm = "pm";

merge(config.messages.tiddlerPopup,{
	});

merge(config.views.wikified.tag,{
	labelNoTags: "no tags",
	labelTags: "tags: ",
	openTag: "Open tag '%0'",
	tooltip: "Show tiddlers tagged with '%0'",
	openAllText: "Open all",
	openAllTooltip: "Open all of these tiddlers",
	popupNone: "No other tiddlers tagged with '%0'"});

merge(config.views.wikified,{
	defaultText: "The tiddler '%0' doesn't yet exist. Double-click to create it",
	defaultModifier: "(missing)",
	shadowModifier: "(built-in shadow tiddler)",
	dateFormat: "DD MMM YYYY",
	createdPrompt: "created"});

merge(config.views.editor,{
	tagPrompt: "Type tags separated with spaces, [[use double square brackets]] if necessary, or add existing",
	defaultText: "Type the text for '%0'"});

merge(config.views.editor.tagChooser,{
	text: "tags",
	tooltip: "Choose existing tags to add to this tiddler",
	popupNone: "There are no tags defined",
	tagTooltip: "Add the tag '%0'"});

merge(config.messages,{
	sizeTemplates:
		[
		{unit: 1024*1024*1024, template: "%0\u00a0GB"},
		{unit: 1024*1024, template: "%0\u00a0MB"},
		{unit: 1024, template: "%0\u00a0KB"},
		{unit: 1, template: "%0\u00a0B"}
		]});

merge(config.macros.search,{
	label: "search",
	prompt: "Search this TiddlyWiki",
	placeholder: "",
	accessKey: "F",
	successMsg: "%0 tiddlers found matching %1",
	failureMsg: "No tiddlers found matching %0"});

merge(config.macros.tagging,{
	label: "tagging: ",
	labelNotTag: "not tagging",
	tooltip: "List of tiddlers tagged with '%0'"});

merge(config.macros.timeline,{
	dateFormat: "DD MMM YYYY"});

merge(config.macros.allTags,{
	tooltip: "Show tiddlers tagged with '%0'",
	noTags: "There are no tagged tiddlers"});

config.macros.list.all.prompt = "All tiddlers in alphabetical order";
config.macros.list.missing.prompt = "Tiddlers that have links to them but are not defined";
config.macros.list.orphans.prompt = "Tiddlers that are not linked to from any other tiddlers";
config.macros.list.shadowed.prompt = "Tiddlers shadowed with default contents";
config.macros.list.touched.prompt = "Tiddlers that have been modified locally";

merge(config.macros.closeAll,{
	label: "close all",
	prompt: "Close all displayed tiddlers (except any that are being edited)"});

merge(config.macros.permaview,{
	label: "permaview",
	prompt: "Link to an URL that retrieves all the currently displayed tiddlers"});

merge(config.macros.saveChanges,{
	label: "save changes",
	prompt: "Save all tiddlers to create a new TiddlyWiki",
	accessKey: "S"});

merge(config.macros.newTiddler,{
	label: "new tiddler",
	prompt: "Create a new tiddler",
	title: "New Tiddler",
	accessKey: "N"});

merge(config.macros.newJournal,{
	label: "new journal",
	prompt: "Create a new tiddler from the current date and time",
	accessKey: "J"});

merge(config.macros.options,{
	wizardTitle: "Tweak advanced options",
	step1Title: "These options are saved in cookies in your browser",
	step1Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='false' name='chkUnknown'>Show unknown options</input>",
	unknownDescription: "//(unknown)//",
	listViewTemplate: {
		columns: [
			{name: 'Option', field: 'option', title: "Option", type: 'String'},
			{name: 'Description', field: 'description', title: "Description", type: 'WikiText'},
			{name: 'Name', field: 'name', title: "Name", type: 'String'}
			],
		rowClasses: [
			{className: 'lowlight', field: 'lowlight'}
			]}
	});

merge(config.macros.plugins,{
	wizardTitle: "Manage plugins",
	step1Title: "Currently loaded plugins",
	step1Html: "<input type='hidden' name='markList'></input>", // DO NOT TRANSLATE
	skippedText: "(This plugin has not been executed because it was added since startup)",
	noPluginText: "There are no plugins installed",
	confirmDeleteText: "Are you sure you want to delete these plugins:\n\n%0",
	removeLabel: "remove systemConfig tag",
	removePrompt: "Remove systemConfig tag",
	deleteLabel: "delete",
	deletePrompt: "Delete these tiddlers forever",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Forced', field: 'forced', title: "Forced", tag: 'systemConfigForce', type: 'TagCheckbox'},
			{name: 'Disabled', field: 'disabled', title: "Disabled", tag: 'systemConfigDisable', type: 'TagCheckbox'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]},
	listViewTemplateReadOnly: {
		columns: [
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Description', field: 'Description', title: "Description", type: 'String'},
			{name: 'Version', field: 'Version', title: "Version", type: 'String'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Executed', field: 'executed', title: "Loaded", type: 'Boolean', trueText: "Yes", falseText: "No"},
			{name: 'Startup Time', field: 'startupTime', title: "Startup Time", type: 'String'},
			{name: 'Error', field: 'error', title: "Status", type: 'Boolean', trueText: "Error", falseText: "OK"},
			{name: 'Log', field: 'log', title: "Log", type: 'StringList'}
			],
		rowClasses: [
			{className: 'error', field: 'error'},
			{className: 'warning', field: 'warning'}
			]}
	});

merge(config.macros.toolbar,{
	moreLabel: "more",
	morePrompt: "Show additional commands",
	lessLabel: "less",
	lessPrompt: "Hide additional commands",
	separator: "|"
	});

merge(config.macros.refreshDisplay,{
	label: "refresh",
	prompt: "Redraw the entire TiddlyWiki display"
	});

merge(config.macros.importTiddlers,{
	readOnlyWarning: "You cannot import into a read-only TiddlyWiki file. Try opening it from a file:// URL",
	wizardTitle: "Import tiddlers from another file or server",
	step1Title: "Step 1: Locate the server or TiddlyWiki file",
	step1Html: "Specify the type of the server: <select name='selTypes'><option value=''>Choose...</option></select><br>Enter the URL or pathname here: <input type='text' size=50 name='txtPath'><br>...or browse for a file: <input type='file' size=50 name='txtBrowse'><br><hr>...or select a pre-defined feed: <select name='selFeeds'><option value=''>Choose...</option></select>",
	openLabel: "open",
	openPrompt: "Open the connection to this file or server",
	statusOpenHost: "Opening the host",
	statusGetWorkspaceList: "Getting the list of available workspaces",
	step2Title: "Step 2: Choose the workspace",
	step2Html: "Enter a workspace name: <input type='text' size=50 name='txtWorkspace'><br>...or select a workspace: <select name='selWorkspace'><option value=''>Choose...</option></select>",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel this import",
	statusOpenWorkspace: "Opening the workspace",
	statusGetTiddlerList: "Getting the list of available tiddlers",
	errorGettingTiddlerList: "Error getting list of tiddlers, click Cancel to try again",
	errorGettingTiddlerListHttp404: "Error retrieving tiddlers from url, please ensure the url exists. Click Cancel to try again.",
	errorGettingTiddlerListHttp: "Error retrieving tiddlers from url, please ensure this url exists and is <a href='http://enable-cors.org/'>CORS</a> enabled",
	errorGettingTiddlerListFile: "Error retrieving tiddlers from local file, please make sure the file is in the same directory as your TiddlyWiki. Click Cancel to try again.",
	step3Title: "Step 3: Choose the tiddlers to import",
	step3Html: "<input type='hidden' name='markList'></input><br><input type='checkbox' checked='true' name='chkSync'>Keep these tiddlers linked to this server so that you can synchronise subsequent changes</input><br><input type='checkbox' name='chkSave'>Save the details of this server in a 'systemServer' tiddler called:</input> <input type='text' size=25 name='txtSaveTiddler'>",
	importLabel: "import",
	importPrompt: "Import these tiddlers",
	confirmOverwriteText: "Are you sure you want to overwrite these tiddlers:\n\n%0",
	step4Title: "Step 4: Importing %0 tiddler(s)",
	step4Html: "<input type='hidden' name='markReport'></input>", // DO NOT TRANSLATE
	doneLabel: "done",
	donePrompt: "Close this wizard",
	statusDoingImport: "Importing tiddlers",
	statusDoneImport: "All tiddlers imported",
	systemServerNamePattern: "%2 on %1",
	systemServerNamePatternNoWorkspace: "%1",
	confirmOverwriteSaveTiddler: "The tiddler '%0' already exists. Click 'OK' to overwrite it with the details of this server, or 'Cancel' to leave it unchanged",
	serverSaveTemplate: "|''Type:''|%0|\n|''URL:''|%1|\n|''Workspace:''|%2|\n\nThis tiddler was automatically created to record the details of this server",
	serverSaveModifier: "(System)",
	listViewTemplate: {
		columns: [
			{name: 'Selected', field: 'Selected', rowName: 'title', type: 'Selector'},
			{name: 'Tiddler', field: 'tiddler', title: "Tiddler", type: 'Tiddler'},
			{name: 'Size', field: 'size', tiddlerLink: 'size', title: "Size", type: 'Size'},
			{name: 'Tags', field: 'tags', title: "Tags", type: 'Tags'}
			],
		rowClasses: [
			]}
	});

merge(config.macros.upgrade,{
	wizardTitle: "Upgrade TiddlyWiki core code",
	step1Title: "Update or repair this TiddlyWiki to the latest release",
	step1Html: "You are about to upgrade to the latest release of the TiddlyWiki core code (from <a href='%0' class='externalLink' target='_blank'>%1</a>). Your content will be preserved across the upgrade.<br><br>Note that core upgrades have been known to interfere with older plugins. If you run into problems with the upgraded file, see <a href='http://www.tiddlywiki.org/wiki/CoreUpgrades' class='externalLink' target='_blank'>http://www.tiddlywiki.org/wiki/CoreUpgrades</a>",
	errorCantUpgrade: "Unable to upgrade this TiddlyWiki. You can only perform upgrades on TiddlyWiki files stored locally",
	errorNotSaved: "You must save changes before you can perform an upgrade",
	step2Title: "Confirm the upgrade details",
	step2Html_downgrade: "You are about to downgrade to TiddlyWiki version %0 from %1.<br><br>Downgrading to an earlier version of the core code is not recommended",
	step2Html_restore: "This TiddlyWiki appears to be already using the latest version of the core code (%0).<br><br>You can continue to upgrade anyway to ensure that the core code hasn't been corrupted or damaged",
	step2Html_upgrade: "You are about to upgrade to TiddlyWiki version %0 from %1",
	upgradeLabel: "upgrade",
	upgradePrompt: "Prepare for the upgrade process",
	statusPreparingBackup: "Preparing backup",
	statusSavingBackup: "Saving backup file",
	errorSavingBackup: "There was a problem saving the backup file",
	statusLoadingCore: "Loading core code",
	errorLoadingCore: "Error loading the core code",
	errorCoreFormat: "Error with the new core code",
	statusSavingCore: "Saving the new core code",
	statusReloadingCore: "Reloading the new core code",
	startLabel: "start",
	startPrompt: "Start the upgrade process",
	cancelLabel: "cancel",
	cancelPrompt: "Cancel the upgrade process",
	step3Title: "Upgrade cancelled",
	step3Html: "You have cancelled the upgrade process"
	});

merge(config.macros.annotations,{
	});

merge(config.commands.closeTiddler,{
	text: "close",
	tooltip: "Close this tiddler"});

merge(config.commands.closeOthers,{
	text: "close others",
	tooltip: "Close all other tiddlers"});

merge(config.commands.editTiddler,{
	text: "edit",
	tooltip: "Edit this tiddler",
	readOnlyText: "view",
	readOnlyTooltip: "View the source of this tiddler"});

merge(config.commands.saveTiddler,{
	text: "done",
	tooltip: "Save changes to this tiddler"});

merge(config.commands.cancelTiddler,{
	text: "cancel",
	tooltip: "Undo changes to this tiddler",
	warning: "Are you sure you want to abandon your changes to '%0'?",
	readOnlyText: "done",
	readOnlyTooltip: "View this tiddler normally"});

merge(config.commands.deleteTiddler,{
	text: "delete",
	tooltip: "Delete this tiddler",
	warning: "Are you sure you want to delete '%0'?"});

merge(config.commands.permalink,{
	text: "permalink",
	tooltip: "Permalink for this tiddler"});

merge(config.commands.references,{
	text: "references",
	tooltip: "Show tiddlers that link to this one",
	popupNone: "No references"});

merge(config.commands.jump,{
	text: "jump",
	tooltip: "Jump to another open tiddler"});

merge(config.commands.fields,{
	text: "fields",
	tooltip: "Show the extended fields of this tiddler",
	emptyText: "There are no extended fields for this tiddler",
	listViewTemplate: {
		columns: [
			{name: 'Field', field: 'field', title: "Field", type: 'String'},
			{name: 'Value', field: 'value', title: "Value", type: 'String'}
			],
		rowClasses: [
			],
		buttons: [
			]}});

merge(config.shadowTiddlers,{
	DefaultTiddlers: "[[GettingStarted]]",
	MainMenu: "[[GettingStarted]]",
	SiteTitle: "My TiddlyWiki",
	SiteSubtitle: "a reusable non-linear personal web notebook",
	SiteUrl: "",
	SideBarOptions: '<<search>><<closeAll>><<permaview>><<newTiddler>><<newJournal "DD MMM YYYY" "journal">><<saveChanges>><<slider chkSliderOptionsPanel OptionsPanel "options \u00bb" "Change TiddlyWiki advanced options">>',
	SideBarTabs: '<<tabs txtMainTab "Timeline" "Timeline" TabTimeline "All" "All tiddlers" TabAll "Tags" "All tags" TabTags "More" "More lists" TabMore>>',
	TabMore: '<<tabs txtMoreTab "Missing" "Missing tiddlers" TabMoreMissing "Orphans" "Orphaned tiddlers" TabMoreOrphans "Shadowed" "Shadowed tiddlers" TabMoreShadowed>>'
	});

merge(config.annotations,{
	AdvancedOptions: "This shadow tiddler provides access to several advanced options",
	ColorPalette: "These values in this shadow tiddler determine the colour scheme of the ~TiddlyWiki user interface",
	DefaultTiddlers: "The tiddlers listed in this shadow tiddler will be automatically displayed when ~TiddlyWiki starts up",
	EditTemplate: "The HTML template in this shadow tiddler determines how tiddlers look while they are being edited",
	GettingStarted: "This shadow tiddler provides basic usage instructions",
	ImportTiddlers: "This shadow tiddler provides access to importing tiddlers",
	MainMenu: "This shadow tiddler is used as the contents of the main menu in the left-hand column of the screen",
	MarkupPreHead: "This tiddler is inserted at the top of the <head> section of the TiddlyWiki HTML file",
	MarkupPostHead: "This tiddler is inserted at the bottom of the <head> section of the TiddlyWiki HTML file",
	MarkupPreBody: "This tiddler is inserted at the top of the <body> section of the TiddlyWiki HTML file",
	MarkupPostBody: "This tiddler is inserted at the end of the <body> section of the TiddlyWiki HTML file immediately after the script block",
	OptionsPanel: "This shadow tiddler is used as the contents of the options panel slider in the right-hand sidebar",
	PageTemplate: "The HTML template in this shadow tiddler determines the overall ~TiddlyWiki layout",
	PluginManager: "This shadow tiddler provides access to the plugin manager",
	SideBarOptions: "This shadow tiddler is used as the contents of the option panel in the right-hand sidebar",
	SideBarTabs: "This shadow tiddler is used as the contents of the tabs panel in the right-hand sidebar",
	SiteSubtitle: "This shadow tiddler is used as the second part of the page title",
	SiteTitle: "This shadow tiddler is used as the first part of the page title",
	SiteUrl: "This shadow tiddler should be set to the full target URL for publication",
	StyleSheetColors: "This shadow tiddler contains CSS definitions related to the color of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheet: "This tiddler can contain custom CSS definitions",
	StyleSheetLayout: "This shadow tiddler contains CSS definitions related to the layout of page elements. ''DO NOT EDIT THIS TIDDLER'', instead make your changes in the StyleSheet shadow tiddler",
	StyleSheetLocale: "This shadow tiddler contains CSS definitions related to the translation locale",
	StyleSheetPrint: "This shadow tiddler contains CSS definitions for printing",
	SystemSettings: "This tiddler is used to store configuration options for this TiddlyWiki document",
	TabAll: "This shadow tiddler contains the contents of the 'All' tab in the right-hand sidebar",
	TabMore: "This shadow tiddler contains the contents of the 'More' tab in the right-hand sidebar",
	TabMoreMissing: "This shadow tiddler contains the contents of the 'Missing' tab in the right-hand sidebar",
	TabMoreOrphans: "This shadow tiddler contains the contents of the 'Orphans' tab in the right-hand sidebar",
	TabMoreShadowed: "This shadow tiddler contains the contents of the 'Shadowed' tab in the right-hand sidebar",
	TabTags: "This shadow tiddler contains the contents of the 'Tags' tab in the right-hand sidebar",
	TabTimeline: "This shadow tiddler contains the contents of the 'Timeline' tab in the right-hand sidebar",
	ToolbarCommands: "This shadow tiddler determines which commands are shown in tiddler toolbars",
	ViewTemplate: "The HTML template in this shadow tiddler determines how tiddlers look"
	});

//--
//-- Main
//--

var params = null; // Command line parameters
var store = null; // TiddlyWiki storage
var story = null; // Main story
var formatter = null; // Default formatters for the wikifier
var anim = typeof Animator == "function" ? new Animator() : null; // Animation engine
var readOnly = false; // Whether we're in readonly mode
var highlightHack = null; // Embarrassing hack department...
var hadConfirmExit = false; // Don't warn more than once
var safeMode = false; // Disable all plugins and cookies
var showBackstage; // Whether to include the backstage area
var installedPlugins = []; // Information filled in when plugins are executed
var startingUp = false; // Whether we're in the process of starting up
var pluginInfo,tiddler; // Used to pass information to plugins in loadPlugins()

// Whether this file can be saved back to the same location [Preemption]
window.allowSave = window.allowSave || function(l)
{
	return (document.location.protocol == "file:");
}

// Whether to use the JavaSaver applet
var useJavaSaver = window.allowSave() && (config.browser.isSafari || config.browser.isOpera);

// Allow preemption code a chance to tweak config and useJavaSaver [Preemption]
if (window.tweakConfig) window.tweakConfig();

if(!window || !window.console) {
	console = {tiddlywiki:true,log:function(message) {displayMessage(message);}};
}

// Starting up
function main()
{
	var t10,t9,t8,t7,t6,t5,t4,t3,t2,t1,t0 = new Date();
	startingUp = true;
	var doc = jQuery(document);
	jQuery.noConflict();
	window.onbeforeunload = function(e) {if(window.confirmExit) return confirmExit();};
	params = getParameters();
	if(params)
		params = params.parseParams("open",null,false);
	store = new TiddlyWiki({config:config});
	invokeParamifier(params,"oninit");
	story = new Story("tiddlerDisplay","tiddler");
	addEvent(document,"click",Popup.onDocumentClick);
	saveTest();
	var s;
	for(s=0; s<config.notifyTiddlers.length; s++)
		store.addNotification(config.notifyTiddlers[s].name,config.notifyTiddlers[s].notify);
	t1 = new Date();
	loadShadowTiddlers();
	doc.trigger("loadShadows");
	t2 = new Date();
	store.loadFromDiv("storeArea","store",true);
	doc.trigger("loadTiddlers");
	loadOptions();
	t3 = new Date();
	invokeParamifier(params,"onload");
	t4 = new Date();
	readOnly = window.allowSave() ? false : config.options.chkHttpReadOnly;
	var pluginProblem = loadPlugins("systemConfig");
	doc.trigger("loadPlugins");
	t5 = new Date();
	formatter = new Formatter(config.formatters);
	invokeParamifier(params,"onconfig");
	story.switchTheme(config.options.txtTheme);
	showBackstage = showBackstage !== undefined ? showBackstage : !readOnly;
	t6 = new Date();
	var m;
	for(m in config.macros) {
		if(config.macros[m].init)
			config.macros[m].init();
	}
	t7 = new Date();
	store.notifyAll();
	t8 = new Date();
	restart();
	refreshDisplay();
	t9 = new Date();
	if(pluginProblem) {
		story.displayTiddler(null,"PluginManager");
		displayMessage(config.messages.customConfigError);
	}
	if(showBackstage)
		backstage.init();
	t10 = new Date();
	if(config.options.chkDisplayInstrumentation) {
		displayMessage("LoadShadows " + (t2-t1) + " ms");
		displayMessage("LoadFromDiv " + (t3-t2) + " ms");
		displayMessage("LoadPlugins " + (t5-t4) + " ms");
		displayMessage("Macro init " + (t7-t6) + " ms");
		displayMessage("Notify " + (t8-t7) + " ms");
		displayMessage("Restart " + (t9-t8) + " ms");
		displayMessage("Total: " + (t10-t0) + " ms");
	}
	startingUp = false;
	doc.trigger("startup");
}

// Called on unload. All functions called conditionally since they themselves may have been unloaded.
function unload()
{
	if(window.checkUnsavedChanges)
		checkUnsavedChanges();
	if(window.scrubNodes)
		scrubNodes(document.body);
}

// Restarting
function restart()
{
	invokeParamifier(params,"onstart");
	if(story.isEmpty()) {
		story.displayDefaultTiddlers();
	}
	window.scrollTo(0,0);
}

function saveTest()
{
	var s = document.getElementById("saveTest");
	if(s.hasChildNodes())
		alert(config.messages.savedSnapshotError);
	s.appendChild(document.createTextNode("savetest"));
}

function loadShadowTiddlers()
{
	var shadows = new TiddlyWiki();
	shadows.loadFromDiv("shadowArea","shadows",true);
	shadows.forEachTiddler(function(title,tiddler){config.shadowTiddlers[title] = tiddler.text;});
}

function loadPlugins(tag)
{
	if(safeMode)
		return false;
	var tiddlers = store.getTaggedTiddlers(tag);
	tiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : 1);});
	var toLoad = [];
	var nLoaded = 0;
	var map = {};
	var nPlugins = tiddlers.length;
	installedPlugins = [];
	var i;
	for(i=0; i<nPlugins; i++) {
		var p = getPluginInfo(tiddlers[i]);
		installedPlugins[i] = p;
		var n = p.Name || p.title;
		if(n)
			map[n] = p;
		n = p.Source;
		if(n)
			map[n] = p;
	}
	var visit = function(p) {
		if(!p || p.done)
			return;
		p.done = 1;
		var reqs = p.Requires;
		if(reqs) {
			reqs = reqs.readBracketedList();
			var i;
			for(i=0; i<reqs.length; i++)
				visit(map[reqs[i]]);
		}
		toLoad.push(p);
	};
	for(i=0; i<nPlugins; i++)
		visit(installedPlugins[i]);
	for(i=0; i<toLoad.length; i++) {
		p = toLoad[i];
		pluginInfo = p;
		tiddler = p.tiddler;
		if(isPluginExecutable(p)) {
			if(isPluginEnabled(p)) {
				p.executed = true;
				var startTime = new Date();
				try {
					if(tiddler.text)
						window.eval(tiddler.text);
					nLoaded++;
				} catch(ex) {
					p.log.push(config.messages.pluginError.format([exceptionText(ex)]));
					p.error = true;
					if(!console.tiddlywiki) {
						console.log("error evaluating " + tiddler.title, ex);
					}
				}
				pluginInfo.startupTime = String((new Date()) - startTime) + "ms";
			} else {
				nPlugins--;
			}
		} else {
			p.warning = true;
		}
	}
	return nLoaded != nPlugins;
}

function getPluginInfo(tiddler)
{
	var p = store.getTiddlerSlices(tiddler.title,["Name","Description","Version","Requires","CoreVersion","Date","Source","Author","License","Browsers"]);
	p.tiddler = tiddler;
	p.title = tiddler.title;
	p.log = [];
	return p;
}

// Check that a particular plugin is valid for execution
function isPluginExecutable(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigForce")) {
		plugin.log.push(config.messages.pluginForced);
		return true;
	}
	if(plugin["CoreVersion"]) {
		var coreVersion = plugin["CoreVersion"].split(".");
		var w = parseInt(coreVersion[0],10) - version.major;
		if(w == 0 && coreVersion[1])
			w = parseInt(coreVersion[1],10) - version.minor;
		if(w == 0 && coreVersion[2])
			w = parseInt(coreVersion[2],10) - version.revision;
		if(w > 0) {
			plugin.log.push(config.messages.pluginVersionError);
			return false;
		}
	}
	return true;
}

function isPluginEnabled(plugin)
{
	if(plugin.tiddler.isTagged("systemConfigDisable")) {
		plugin.log.push(config.messages.pluginDisabled);
		return false;
	}
	return true;
}


//--
//-- Paramifiers
//--

function getParameters()
{
	var p = null;
	if(window.location.hash) {
		p = decodeURIComponent(window.location.hash.substr(1));
		if(config.browser.firefoxDate != null && config.browser.firefoxDate[1] < "20051111")
			p = convertUTF8ToUnicode(p);
	}
	return p;
}

function invokeParamifier(params,handler)
{
	if(!params || params.length == undefined || params.length <= 1)
		return;
	var i;
	for(i=1; i<params.length; i++) {
		var p = config.paramifiers[params[i].name];
		if(p && p[handler] instanceof Function)
			p[handler](params[i].value);
		else {
			var h = config.optionHandlers[params[i].name.substr(0,3)];
			if(h && h.set instanceof Function)
				h.set(params[i].name,params[i].value);
		}
	}
}

config.paramifiers = {};

config.paramifiers.start = {
	oninit: function(v) {
		safeMode = v.toLowerCase() == "safe";
	}
};

config.paramifiers.open = {
	onstart: function(v) {
		if(!readOnly || store.tiddlerExists(v) || store.isShadowTiddler(v))
			story.displayTiddler("bottom",v,null,false,null);
	}
};

config.paramifiers.story = {
	onstart: function(v) {
		var list = store.getTiddlerText(v,"").parseParams("open",null,false);
		invokeParamifier(list,"onstart");
	}
};

config.paramifiers.search = {
	onstart: function(v) {
		story.search(v,false,false);
	}
};

config.paramifiers.searchRegExp = {
	onstart: function(v) {
		story.prototype.search(v,false,true);
	}
};

config.paramifiers.tag = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers("[tag["+v+"]]"),null,false,null);
	}
};

config.paramifiers.newTiddler = {
	onstart: function(v) {
		var args = v.parseParams("anon", null, null)[0];
		var title = args.title ? args.title[0] : v;
		var customFields = args.fields ? args.fields[0] : null;
		if(!readOnly) {
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,customFields);
			story.focusTiddler(title,"text");
			var i,tags = args.tag || [];
			for(i=0;i<tags.length;i++) {
				story.setTiddlerTag(title,tags[i],+1);
			}
		}
	}
};

config.paramifiers.newJournal = {
	onstart: function(v) {
		if(!readOnly) {
			var now = new Date();
			var title = now.formatString(v.trim());
			story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE);
			story.focusTiddler(title,"text");
		}
	}
};

config.paramifiers.readOnly = {
	onconfig: function(v) {
		var p = v.toLowerCase();
		readOnly = p == "yes" ? true : (p == "no" ? false : readOnly);
	}
};

config.paramifiers.theme = {
	onconfig: function(v) {
		story.switchTheme(v);
	}
};

config.paramifiers.upgrade = {
	onstart: function(v) {
		upgradeFrom(v);
	}
};

config.paramifiers.recent= {
	onstart: function(v) {
		var titles=[];
		var i,tiddlers=store.getTiddlers("modified","excludeLists").reverse();
		for(i=0; i<v && i<tiddlers.length; i++)
			titles.push(tiddlers[i].title);
		story.displayTiddlers(null,titles);
	}
};

config.paramifiers.filter = {
	onstart: function(v) {
		story.displayTiddlers(null,store.filterTiddlers(v),null,false);
	}
};


//--
//-- Formatter helpers
//--

function Formatter(formatters)
{
	var n;
	this.formatters = [];
	var pattern = [];
	for(n=0; n<formatters.length; n++) {
		pattern.push("(" + formatters[n].match + ")");
		this.formatters.push(formatters[n]);
	}
	this.formatterRegExp = new RegExp(pattern.join("|"),"mg");
}

config.formatterHelpers = {

	createElementAndWikify: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,this.element),this.termRegExp);
	},

	inlineCssHelper: function(w)
	{
		var styles = [];
		config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var s,v;
			if(lookaheadMatch[1]) {
				s = lookaheadMatch[1].unDash();
				v = lookaheadMatch[2];
			} else {
				s = lookaheadMatch[3].unDash();
				v = lookaheadMatch[4];
			}
			if(s=="bgcolor")
				s = "backgroundColor";
			if(s=="float")
				s = "cssFloat";
			styles.push({style: s, value: v});
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
			config.textPrimitives.cssLookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = config.textPrimitives.cssLookaheadRegExp.exec(w.source);
		}
		return styles;
	},

	applyCssHelper: function(e,styles)
	{
		var t;
		for(t=0; t< styles.length; t++) {
			try {
				e.style[styles[t].style] = styles[t].value;
			} catch (ex) {
			}
		}
	},

	enclosedTextHelper: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var text = lookaheadMatch[1];
			if(config.browser.isIE)
				text = text.replace(/\n/g,"\r");
			createTiddlyElement(w.output,this.element,null,null,text);
			w.nextMatch = lookaheadMatch.index + lookaheadMatch[0].length;
		}
	},

	isExternalLink: function(link)
	{
		if(store.tiddlerExists(link) || store.isShadowTiddler(link)) {
			return false;
		}
		var urlRegExp = new RegExp(config.textPrimitives.urlPattern,"mg");
		if(urlRegExp.exec(link)) {
			return true;
		}
		if(link.indexOf(".")!=-1 || link.indexOf("\\")!=-1 || link.indexOf("/")!=-1 || link.indexOf("#")!=-1) {
			return true;
		}
		return false;
	}

};


//--
//-- Standard formatters
//--

config.formatters = [
{
	name: "table",
	match: "^\\|(?:[^\\n]*)\\|(?:[fhck]?)$",
	lookaheadRegExp: /^\|([^\n]*)\|([fhck]?)$/mg,
	rowTermRegExp: /(\|(?:[fhck]?)$\n?)/mg,
	cellRegExp: /(?:\|([^\n\|]*)\|)|(\|[fhck]?$\n?)/mg,
	cellTermRegExp: /((?:\x20*)\|)/mg,
	rowTypes: {"c":"caption", "h":"thead", "":"tbody", "f":"tfoot"},
	handler: function(w)
	{
		var table = createTiddlyElement(w.output,"table",null,"twtable");
		var prevColumns = [];
		var currRowType = null;
		var rowContainer;
		var rowCount = 0;
		var onmouseover = function() {jQuery(this).addClass("hoverRow");};
		var onmouseout = function() {jQuery(this).removeClass("hoverRow");};
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			var nextRowType = lookaheadMatch[2];
			if(nextRowType == "k") {
				table.className = lookaheadMatch[1];
				w.nextMatch += lookaheadMatch[0].length+1;
			} else {
				if(nextRowType != currRowType) {
					rowContainer = createTiddlyElement(table,this.rowTypes[nextRowType]);
					currRowType = nextRowType;
				}
				if(currRowType == "c") {
					// Caption
					w.nextMatch++;
					if(rowContainer != table.firstChild)
						table.insertBefore(rowContainer,table.firstChild);
					rowContainer.setAttribute("align",rowCount == 0?"top":"bottom");
					w.subWikifyTerm(rowContainer,this.rowTermRegExp);
				} else {
					var theRow = createTiddlyElement(rowContainer,"tr",null,rowCount%2?"oddRow":"evenRow");
					theRow.onmouseover = onmouseover;
					theRow.onmouseout = onmouseout;
					this.rowHandler(w,theRow,prevColumns);
					rowCount++;
				}
			}
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	},
	rowHandler: function(w,e,prevColumns)
	{
		var col = 0;
		var colSpanCount = 1;
		var prevCell = null;
		this.cellRegExp.lastIndex = w.nextMatch;
		var cellMatch = this.cellRegExp.exec(w.source);
		while(cellMatch && cellMatch.index == w.nextMatch) {
			if(cellMatch[1] == "~") {
				// Rowspan
				var last = prevColumns[col];
				if(last) {
					last.rowSpanCount++;
					last.element.setAttribute("rowspan",last.rowSpanCount);
					last.element.setAttribute("rowSpan",last.rowSpanCount); // Needed for IE
					last.element.valign = "center";
					if(colSpanCount > 1) {
						last.element.setAttribute("colspan",colSpanCount);
						last.element.setAttribute("colSpan",colSpanCount); // Needed for IE
						colSpanCount = 1;
					}
				}
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[1] == ">") {
				// Colspan
				colSpanCount++;
				w.nextMatch = this.cellRegExp.lastIndex-1;
			} else if(cellMatch[2]) {
				// End of row
				if(prevCell && colSpanCount > 1) {
					prevCell.setAttribute("colspan",colSpanCount);
					prevCell.setAttribute("colSpan",colSpanCount); // Needed for IE
				}
				w.nextMatch = this.cellRegExp.lastIndex;
				break;
			} else {
				// Cell
				w.nextMatch++;
				var styles = config.formatterHelpers.inlineCssHelper(w);
				var spaceLeft = false;
				var chr = w.source.substr(w.nextMatch,1);
				while(chr == " ") {
					spaceLeft = true;
					w.nextMatch++;
					chr = w.source.substr(w.nextMatch,1);
				}
				var cell;
				if(chr == "!") {
					cell = createTiddlyElement(e,"th");
					w.nextMatch++;
				} else {
					cell = createTiddlyElement(e,"td");
				}
				prevCell = cell;
				prevColumns[col] = {rowSpanCount:1,element:cell};
				if(colSpanCount > 1) {
					cell.setAttribute("colspan",colSpanCount);
					cell.setAttribute("colSpan",colSpanCount); // Needed for IE
					colSpanCount = 1;
				}
				config.formatterHelpers.applyCssHelper(cell,styles);
				w.subWikifyTerm(cell,this.cellTermRegExp);
				if(w.matchText.substr(w.matchText.length-2,1) == " ") // spaceRight
					cell.align = spaceLeft ? "center" : "left";
				else if(spaceLeft)
					cell.align = "right";
				w.nextMatch--;
			}
			col++;
			this.cellRegExp.lastIndex = w.nextMatch;
			cellMatch = this.cellRegExp.exec(w.source);
		}
	}
},

{
	name: "heading",
	match: "^!{1,6}",
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		w.subWikifyTerm(createTiddlyElement(w.output,"h" + w.matchLength),this.termRegExp);
	}
},

{
	name: "list",
	match: "^(?:[\\*#;:]+)",
	lookaheadRegExp: /^(?:(?:(\*)|(#)|(;)|(:))+)/mg,
	termRegExp: /(\n)/mg,
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0, currType = null;
		var listLevel, listType, itemType, baseType;
		w.nextMatch = w.matchStart;
		this.lookaheadRegExp.lastIndex = w.nextMatch;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		while(lookaheadMatch && lookaheadMatch.index == w.nextMatch) {
			if(lookaheadMatch[1]) {
				listType = "ul";
				itemType = "li";
			} else if(lookaheadMatch[2]) {
				listType = "ol";
				itemType = "li";
			} else if(lookaheadMatch[3]) {
				listType = "dl";
				itemType = "dt";
			} else if(lookaheadMatch[4]) {
				listType = "dl";
				itemType = "dd";
			}
			if(!baseType)
				baseType = listType;
			listLevel = lookaheadMatch[0].length;
			w.nextMatch += lookaheadMatch[0].length;
			var t;
			if(listLevel > currLevel) {
				for(t=currLevel; t<listLevel; t++) {
					var target = (currLevel == 0) ? stack[stack.length-1] : stack[stack.length-1].lastChild;
					stack.push(createTiddlyElement(target,listType));
				}
			} else if(listType!=baseType && listLevel==1) {
				w.nextMatch -= lookaheadMatch[0].length;
				return;
			} else if(listLevel < currLevel) {
				for(t=currLevel; t>listLevel; t--)
					stack.pop();
			} else if(listLevel == currLevel && listType != currType) {
				stack.pop();
				stack.push(createTiddlyElement(stack[stack.length-1].lastChild,listType));
			}
			currLevel = listLevel;
			currType = listType;
			var e = createTiddlyElement(stack[stack.length-1],itemType);
			w.subWikifyTerm(e,this.termRegExp);
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		}
	}
},

{
	name: "quoteByBlock",
	match: "^<<<\\n",
	termRegExp: /(^<<<(\n|$))/mg,
	element: "blockquote",
	handler: config.formatterHelpers.createElementAndWikify
},

{
	name: "quoteByLine",
	match: "^>+",
	lookaheadRegExp: /^>+/mg,
	termRegExp: /(\n)/mg,
	element: "blockquote",
	handler: function(w)
	{
		var stack = [w.output];
		var currLevel = 0;
		var newLevel = w.matchLength;
		var t,matched;
		do {
			if(newLevel > currLevel) {
				for(t=currLevel; t<newLevel; t++)
					stack.push(createTiddlyElement(stack[stack.length-1],this.element));
			} else if(newLevel < currLevel) {
				for(t=currLevel; t>newLevel; t--)
					stack.pop();
			}
			currLevel = newLevel;
			w.subWikifyTerm(stack[stack.length-1],this.termRegExp);
			createTiddlyElement(stack[stack.length-1],"br");
			this.lookaheadRegExp.lastIndex = w.nextMatch;
			var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
			matched = lookaheadMatch && lookaheadMatch.index == w.nextMatch;
			if(matched) {
				newLevel = lookaheadMatch[0].length;
				w.nextMatch += lookaheadMatch[0].length;
			}
		} while(matched);
	}
},

{
	name: "rule",
	match: "^----+$\\n?|<hr ?/?>\\n?",
	handler: function(w)
	{
		createTiddlyElement(w.output,"hr");
	}
},

{
	name: "monospacedByLine",
	match: "^(?:/\\*\\{\\{\\{\\*/|\\{\\{\\{|//\\{\\{\\{|<!--\\{\\{\\{-->)\\n",
	element: "pre",
	handler: function(w)
	{
		switch(w.matchText) {
		case "/*{{{*/\n": // CSS
			this.lookaheadRegExp = /\/\*\{\{\{\*\/\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\*\}\}\}\*\/$\n?)/mg;
			break;
		case "{{{\n": // monospaced block
			this.lookaheadRegExp = /^\{\{\{\n((?:^[^\n]*\n)+?)(^\f*\}\}\}$\n?)/mg;
			break;
		case "//{{{\n": // plugin
			this.lookaheadRegExp = /^\/\/\{\{\{\n\n*((?:^[^\n]*\n)+?)(\n*^\f*\/\/\}\}\}$\n?)/mg;
			break;
		case "<!--{{{-->\n": //template
			this.lookaheadRegExp = /<!--\{\{\{-->\n*((?:^[^\n]*\n)+?)(\n*^\f*<!--\}\}\}-->$\n?)/mg;
			break;
		default:
			break;
		}
		config.formatterHelpers.enclosedTextHelper.call(this,w);
	}
},

{
	name: "wikifyComment",
	match: "^(?:/\\*\\*\\*|<!---)\\n",
	handler: function(w)
	{
		var termRegExp = (w.matchText == "/***\n") ? (/(^\*\*\*\/\n)/mg) : (/(^--->\n)/mg);
		w.subWikifyTerm(w.output,termRegExp);
	}
},

{
	name: "macro",
	match: "<<",
	lookaheadRegExp: /<<([^>\s]+)(?:\s*)((?:[^>]|(?:>(?!>)))*)>>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart && lookaheadMatch[1]) {
			w.nextMatch = this.lookaheadRegExp.lastIndex;
			invokeMacro(w.output,lookaheadMatch[1],lookaheadMatch[2],w,w.tiddler);
		}
	}
},

{
	name: "prettyLink",
	match: "\\[\\[",
	lookaheadRegExp: /\[\[(.*?)(?:\|(~)?(.*?))?\]\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e;
			var text = lookaheadMatch[1];
			if(lookaheadMatch[3]) {
				// Pretty bracketted link
				var link = lookaheadMatch[3];
				e = (!lookaheadMatch[2] && config.formatterHelpers.isExternalLink(link)) ?
						createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
			} else {
				// Simple bracketted link
				e = createTiddlyLink(w.output,text,false,null,w.isStatic,w.tiddler);
			}
			createTiddlyText(e,text);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "wikiLink",
	match: config.textPrimitives.unWikiLink+"?"+config.textPrimitives.wikiLink,
	handler: function(w)
	{
		if(w.matchText.substr(0,1) == config.textPrimitives.unWikiLink) {
			w.outputText(w.output,w.matchStart+1,w.nextMatch);
			return;
		}
		if(w.matchStart > 0) {
			var preRegExp = new RegExp(config.textPrimitives.anyLetterStrict,"mg");
			preRegExp.lastIndex = w.matchStart-1;
			var preMatch = preRegExp.exec(w.source);
			if(preMatch.index == w.matchStart-1) {
				w.outputText(w.output,w.matchStart,w.nextMatch);
				return;
			}
		}
		if(w.autoLinkWikiWords || store.isShadowTiddler(w.matchText)) {
			var link = createTiddlyLink(w.output,w.matchText,false,null,w.isStatic,w.tiddler);
			w.outputText(link,w.matchStart,w.nextMatch);
		} else {
			w.outputText(w.output,w.matchStart,w.nextMatch);
		}
	}
},

{
	name: "urlLink",
	match: config.textPrimitives.urlPattern,
	handler: function(w)
	{
		w.outputText(createExternalLink(w.output,w.matchText),w.matchStart,w.nextMatch);
	}
},

{
	name: "image",
	match: "\\[[<>]?[Ii][Mm][Gg]\\[",
	lookaheadRegExp: /\[([<]?)(>?)[Ii][Mm][Gg]\[(?:([^\|\]]+)\|)?([^\[\]\|]+)\](?:\[([^\]]*)\])?\]/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			var e = w.output;
			if(lookaheadMatch[5]) {
				var link = lookaheadMatch[5];
				e = config.formatterHelpers.isExternalLink(link) ? createExternalLink(w.output,link) : createTiddlyLink(w.output,link,false,null,w.isStatic,w.tiddler);
				jQuery(e).addClass("imageLink");
			}
			var img = createTiddlyElement(e,"img");
			if(lookaheadMatch[1])
				img.align = "left";
			else if(lookaheadMatch[2])
				img.align = "right";
			if(lookaheadMatch[3]) {
				img.title = lookaheadMatch[3];
				img.setAttribute("alt",lookaheadMatch[3]);
			}
			img.src = lookaheadMatch[4];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "html",
	match: "<[Hh][Tt][Mm][Ll]>",
	lookaheadRegExp: /<[Hh][Tt][Mm][Ll]>((?:.|\n)*?)<\/[Hh][Tt][Mm][Ll]>/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span").innerHTML = lookaheadMatch[1];
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "commentByBlock",
	match: "/%",
	lookaheadRegExp: /\/%((?:.|\n)*?)%\//mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart)
			w.nextMatch = this.lookaheadRegExp.lastIndex;
	}
},

{
	name: "characterFormat",
	match: "''|//|__|\\^\\^|~~|--(?!\\s|$)|\\{\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "''":
			w.subWikifyTerm(w.output.appendChild(document.createElement("strong")),/('')/mg);
			break;
		case "//":
			w.subWikifyTerm(createTiddlyElement(w.output,"em"),/(\/\/)/mg);
			break;
		case "__":
			w.subWikifyTerm(createTiddlyElement(w.output,"u"),/(__)/mg);
			break;
		case "^^":
			w.subWikifyTerm(createTiddlyElement(w.output,"sup"),/(\^\^)/mg);
			break;
		case "~~":
			w.subWikifyTerm(createTiddlyElement(w.output,"sub"),/(~~)/mg);
			break;
		case "--":
			w.subWikifyTerm(createTiddlyElement(w.output,"strike"),/(--)/mg);
			break;
		case "{{{":
			var lookaheadRegExp = /\{\{\{((?:.|\n)*?)\}\}\}/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
				createTiddlyElement(w.output,"code",null,null,lookaheadMatch[1]);
				w.nextMatch = lookaheadRegExp.lastIndex;
			}
			break;
		}
	}
},

{
	name: "customFormat",
	match: "@@|\\{\\{",
	handler: function(w)
	{
		switch(w.matchText) {
		case "@@":
			var e = createTiddlyElement(w.output,"span");
			var styles = config.formatterHelpers.inlineCssHelper(w);
			if(styles.length == 0)
				e.className = "marked";
			else
				config.formatterHelpers.applyCssHelper(e,styles);
			w.subWikifyTerm(e,/(@@)/mg);
			break;
		case "{{":
			var lookaheadRegExp = /\{\{[\s]*([\w]+[\s\w]*)[\s]*\{(\n?)/mg;
			lookaheadRegExp.lastIndex = w.matchStart;
			var lookaheadMatch = lookaheadRegExp.exec(w.source);
			if(lookaheadMatch) {
				w.nextMatch = lookaheadRegExp.lastIndex;
				e = createTiddlyElement(w.output,lookaheadMatch[2] == "\n" ? "div" : "span",null,lookaheadMatch[1]);
				w.subWikifyTerm(e,/(\}\}\})/mg);
			}
			break;
		}
	}
},

{
	name: "mdash",
	match: "--",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = "&mdash;";
	}
},

{
	name: "lineBreak",
	match: "\\n|<br ?/?>",
	handler: function(w)
	{
		createTiddlyElement(w.output,"br");
	}
},

{
	name: "rawText",
	match: "\"{3}|<nowiki>",
	lookaheadRegExp: /(?:\"{3}|<nowiki>)((?:.|\n)*?)(?:\"{3}|<\/nowiki>)/mg,
	handler: function(w)
	{
		this.lookaheadRegExp.lastIndex = w.matchStart;
		var lookaheadMatch = this.lookaheadRegExp.exec(w.source);
		if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
			createTiddlyElement(w.output,"span",null,null,lookaheadMatch[1]);
			w.nextMatch = this.lookaheadRegExp.lastIndex;
		}
	}
},

{
	name: "htmlEntitiesEncoding",
	match: "(?:(?:&#?[a-zA-Z0-9]{2,8};|.)(?:&#?(?:x0*(?:3[0-6][0-9a-fA-F]|1D[c-fC-F][0-9a-fA-F]|20[d-fD-F][0-9a-fA-F]|FE2[0-9a-fA-F])|0*(?:76[89]|7[7-9][0-9]|8[0-7][0-9]|761[6-9]|76[2-7][0-9]|84[0-3][0-9]|844[0-7]|6505[6-9]|6506[0-9]|6507[0-1]));)+|&#?[a-zA-Z0-9]{2,8};)",
	handler: function(w)
	{
		createTiddlyElement(w.output,"span").innerHTML = w.matchText;
	}
}

];


//--
//-- Wikifier
//--

function getParser(tiddler,format)
{
	if(tiddler) {
		if(!format)
			format = tiddler.fields["wikiformat"];
		var i;
		if(format) {
			for(i in config.parsers) {
				if(format == config.parsers[i].format)
					return config.parsers[i];
			}
		} else {
			for(i in config.parsers) {
				if(tiddler.isTagged(config.parsers[i].formatTag))
					return config.parsers[i];
			}
		}
	}
	return formatter;
}

function Wikifier(source,formatter,highlightRegExp,tiddler)
{
	this.source = source;
	this.output = null;
	this.formatter = formatter;
	this.nextMatch = 0;
	this.autoLinkWikiWords = tiddler && tiddler.autoLinkWikiWords() == false ? false : true;
	this.highlightRegExp = highlightRegExp;
	this.highlightMatch = null;
	this.isStatic = false;
	if(highlightRegExp) {
		highlightRegExp.lastIndex = 0;
		this.highlightMatch = highlightRegExp.exec(source);
	}
	this.tiddler = tiddler;
}

Wikifier.prototype.wikifyPlain = function()
{
	var e = createTiddlyElement(document.body,"div");
	e.style.display = "none";
	this.subWikify(e);
	var text = jQuery(e).text();
	jQuery(e).remove();
	return text;
};

Wikifier.prototype.subWikify = function(output,terminator)
{
	try {
		if(terminator)
			this.subWikifyTerm(output,new RegExp("(" + terminator + ")","mg"));
		else
			this.subWikifyUnterm(output);
	} catch(ex) {
		showException(ex);
	}
};

Wikifier.prototype.subWikifyUnterm = function(output)
{
	var oldOutput = this.output;
	this.output = output;
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	while(formatterMatch) {
		// Output any text before the match
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		// Set the match parameters for the handler
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		var t;
		for(t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		formatterMatch = this.formatter.formatterRegExp.exec(this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.subWikifyTerm = function(output,terminatorRegExp)
{
	var oldOutput = this.output;
	this.output = output;
	terminatorRegExp.lastIndex = this.nextMatch;
	var terminatorMatch = terminatorRegExp.exec(this.source);
	this.formatter.formatterRegExp.lastIndex = this.nextMatch;
	var formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	while(terminatorMatch || formatterMatch) {
		if(terminatorMatch && (!formatterMatch || terminatorMatch.index <= formatterMatch.index)) {
			if(terminatorMatch.index > this.nextMatch)
				this.outputText(this.output,this.nextMatch,terminatorMatch.index);
			this.matchText = terminatorMatch[1];
			this.matchLength = terminatorMatch[1].length;
			this.matchStart = terminatorMatch.index;
			this.nextMatch = this.matchStart + this.matchLength;
			this.output = oldOutput;
			return;
		}
		if(formatterMatch.index > this.nextMatch)
			this.outputText(this.output,this.nextMatch,formatterMatch.index);
		this.matchStart = formatterMatch.index;
		this.matchLength = formatterMatch[0].length;
		this.matchText = formatterMatch[0];
		this.nextMatch = this.formatter.formatterRegExp.lastIndex;
		var t;
		for(t=1; t<formatterMatch.length; t++) {
			if(formatterMatch[t]) {
				this.formatter.formatters[t-1].handler(this);
				this.formatter.formatterRegExp.lastIndex = this.nextMatch;
				break;
			}
		}
		terminatorRegExp.lastIndex = this.nextMatch;
		terminatorMatch = terminatorRegExp.exec(this.source);
		formatterMatch = this.formatter.formatterRegExp.exec(terminatorMatch ? this.source.substr(0,terminatorMatch.index) : this.source);
	}
	if(this.nextMatch < this.source.length) {
		this.outputText(this.output,this.nextMatch,this.source.length);
		this.nextMatch = this.source.length;
	}
	this.output = oldOutput;
};

Wikifier.prototype.outputText = function(place,startPos,endPos)
{
	while(this.highlightMatch && (this.highlightRegExp.lastIndex > startPos) && (this.highlightMatch.index < endPos) && (startPos < endPos)) {
		if(this.highlightMatch.index > startPos) {
			createTiddlyText(place,this.source.substring(startPos,this.highlightMatch.index));
			startPos = this.highlightMatch.index;
		}
		var highlightEnd = Math.min(this.highlightRegExp.lastIndex,endPos);
		createTiddlyElement(place,"span",null,"highlight",this.source.substring(startPos,highlightEnd));
		startPos = highlightEnd;
		if(startPos >= this.highlightRegExp.lastIndex)
			this.highlightMatch = this.highlightRegExp.exec(this.source);
	}
	if(startPos < endPos) {
		createTiddlyText(place,this.source.substring(startPos,endPos));
	}
};

function wikify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,getParser(tiddler),highlightRegExp,tiddler);
		var t0 = new Date();
		wikifier.subWikify(output);
		if(tiddler && config.options.chkDisplayInstrumentation)
			displayMessage("wikify:" +tiddler.title+ " in " + (new Date()-t0) + " ms");
	}
}

function wikifyStatic(source,highlightRegExp,tiddler,format)
{
	var e = createTiddlyElement(document.body,"pre");
	e.style.display = "none";
	var html = "";
	if(source && source != "") {
		if(!tiddler)
			tiddler = new Tiddler("temp");
		var wikifier = new Wikifier(source,getParser(tiddler,format),highlightRegExp,tiddler);
		wikifier.isStatic = true;
		wikifier.subWikify(e);
		html = e.innerHTML;
		jQuery(e).remove();
	}
	return html;
}

function wikifyPlainText(text,limit,tiddler)
{
	if(limit > 0)
		text = text.substr(0,limit);
	var wikifier = new Wikifier(text,formatter,null,tiddler);
	return wikifier.wikifyPlain();
}

function highlightify(source,output,highlightRegExp,tiddler)
{
	if(source) {
		var wikifier = new Wikifier(source,formatter,highlightRegExp,tiddler);
		wikifier.outputText(output,0,source.length);
	}
}


//--
//-- Macro definitions
//--

function invokeMacro(place,macro,params,wikifier,tiddler)
{
	try {
		var m = config.macros[macro];
		if(m && m.handler) {
			var tiddlerElem = story.findContainingTiddler(place);
			window.tiddler = tiddlerElem ? store.getTiddler(tiddlerElem.getAttribute("tiddler")) : null;
			window.place = place;
			var allowEval = true;
			if(config.evaluateMacroParameters=="system") {
				if(!tiddler || tiddler.tags.indexOf("systemAllowEval") == -1) {
					allowEval = false;
				}
			}
			m.handler(place,macro,m.noPreParse?null:params.readMacroParams(!allowEval),wikifier,params,tiddler);
		} else {
			createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,config.messages.missingMacro]));
		}
	} catch(ex) {
		createTiddlyError(place,config.messages.macroError.format([macro]),config.messages.macroErrorDetails.format([macro,ex.toString()]));
	}
}

config.macros.version.handler = function(place)
{
	jQuery("<span/>").text(formatVersion()).appendTo(place);
};

config.macros.today.handler = function(place,macroName,params)
{
	var now = new Date();
	var text = params[0] ? now.formatString(params[0].trim()) : now.toLocaleString();
	jQuery("<span/>").text(text).appendTo(place);
};

config.macros.list.template = "<<view title link>>";
config.macros.list.handler = function(place,macroName,params,wikifier,paramString)
{
	var list = document.createElement("ul");
	jQuery(list).attr({ refresh: "macro", macroName: macroName }).data("params", paramString);
	place.appendChild(list);
	this.refresh(list);
};

config.macros.list.refresh = function(list) {
	var paramString = jQuery(list).data("params");
	var params = paramString.readMacroParams();
	var args = paramString.parseParams("anon", null, null)[0];
	var type = args.anon ? args.anon[0] : "all";
	jQuery(list).empty().addClass("list list-" + type);
	var template = args.template ? store.getTiddlerText(args.template[0]) : false;
	if(!template) {
		template = config.macros.list.template;
	}
	if(this[type].prompt)
		createTiddlyElement(list,"li",null,"listTitle",this[type].prompt);
	var results;
	if(this[type].handler)
		results = this[type].handler(params);
	var t;
	for(t = 0; t < results.length; t++) {
		var li = document.createElement("li");
		list.appendChild(li);
		var tiddler = results[t];
		if(typeof(tiddler) == 'string') { // deal with missing etc..
				tiddler = store.getTiddler(tiddler) || new Tiddler(tiddler);
		}
		wikify(template, li, null, tiddler);
	}
	if(results.length === 0 && args.emptyMessage) {
		jQuery(list).addClass("emptyList");
		jQuery("<li />").text(args.emptyMessage[0]).appendTo(list);
	}
};

config.macros.list.all.handler = function(params)
{
	return store.reverseLookup("tags","excludeLists",false,"title");
};

config.macros.list.missing.handler = function(params)
{
	return store.getMissingLinks();
};

config.macros.list.orphans.handler = function(params)
{
	return store.getOrphans();
};

config.macros.list.shadowed.handler = function(params)
{
	return store.getShadowed();
};

config.macros.list.touched.handler = function(params)
{
	return store.getTouched();
};

config.macros.list.filter.handler = function(params)
{
	var filter = params[1];
	var results = [];
	if(filter) {
		var tiddlers = store.filterTiddlers(filter);
		var t;
		for(t=0; t<tiddlers.length; t++)
			results.push(tiddlers[t].title);
	}
	return results;
};

config.macros.allTags.handler = function(place,macroName,params)
{
	var tags = store.getTags(params[0]);
	var ul = createTiddlyElement(place,"ul");
	if(tags.length == 0)
		createTiddlyElement(ul,"li",null,"listTitle",this.noTags);
	var t;
	for(t=0; t<tags.length; t++) {
		var title = tags[t][0];
		var info = getTiddlyLinkInfo(title);
		var li = createTiddlyElement(ul,"li");
		var btn = createTiddlyButton(li,title + " (" + tags[t][1] + ")",this.tooltip.format([title]),onClickTag,info.classes);
		btn.setAttribute("tag",title);
		btn.setAttribute("refresh","link");
		btn.setAttribute("tiddlyLink",title);
		if(params[1]) {
			btn.setAttribute("sortby",params[1]);
		}
	}
};

var macro = config.macros.timeline;
merge(macro, {
	handler: function(place,macroName,params, wikifier, paramString, tiddler) {
		var container = jQuery("<div />").attr("params", paramString).
			attr("macroName", macroName).appendTo(place)[0];
		macro.refresh(container);
	},
	refresh: function(container) {
		jQuery(container).attr("refresh", "macro").empty();
		var paramString = jQuery(container).attr("params");
		var args = paramString.parseParams("anon", null, null)[0];
		var params = args.anon || [];

		var field = params[0] || "modified";
		var prefix = field.charAt(0);
		var no_prefix_field = prefix === "-" || prefix === "+" ? field.substr(1, field.length) : field;
		var dateFormat = params[2] || this.dateFormat;
		var groupTemplate = macro.groupTemplate.format(no_prefix_field, dateFormat);
		groupTemplate = args.groupTemplate ? store.getTiddlerText(args.groupTemplate[0]) || groupTemplate :
			groupTemplate;

		var itemTemplate = macro.itemTemplate;
		itemTemplate = args.template ? store.getTiddlerText(args.template[0]) || itemTemplate :
			itemTemplate;

		var tiddlers = args.filter ? store.sortTiddlers(store.filterTiddlers(args.filter[0]), field) :
			store.reverseLookup("tags", "excludeLists", false, field);
		var lastGroup = "", ul;
		var last = params[1] ? tiddlers.length-Math.min(tiddlers.length,parseInt(params[1],10)) : 0;
		var t;
		for(t=tiddlers.length-1; t>=last; t--) {
			var tiddler = tiddlers[t];
			var theGroup = wikifyPlainText(groupTemplate,0,tiddler);
			if(typeof(ul) == "undefined" || theGroup != lastGroup) {
				ul = document.createElement("ul");
				jQuery(ul).addClass("timeline");
				container.appendChild(ul);
				createTiddlyElement(ul,"li",null,"listTitle",theGroup);
				lastGroup = theGroup;
			}
			var item = createTiddlyElement(ul,"li",null,"listLink");
			wikify(itemTemplate,item,null,tiddler);
		}
	},
	groupTemplate: "<<view %0 date '%1'>>", 
	itemTemplate: "<<view title link>>"
});

config.macros.tiddler.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var allowEval = true;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.length > 0 && config.evaluateMacroParameters == "system") {
		// included tiddler and "system" evaluation required, so check tiddler tagged appropriately
		var title = stack[stack.length-1];
		var pos = title.indexOf(config.textPrimitives.sectionSeparator);
		if(pos != -1) {
			title = title.substr(0,pos); // get the base tiddler title
		}
		var t = store.getTiddler(title);
		if(!t || t.tags.indexOf("systemAllowEval") == -1) {
			allowEval = false;
		}
	}
	params = paramString.parseParams("name",null,allowEval,false,true);
	var names = params[0]["name"];
	var tiddlerName = names[0];
	var className = names[1] || null;
	var args = params[0]["with"];
	var wrapper = createTiddlyElement(place,"span",null,className,null,{
		refresh: "content", tiddler: tiddlerName
	});
	if(args!==undefined)
		wrapper.setAttribute("args","[["+args.join("]] [[")+"]]");
	this.transclude(wrapper,tiddlerName,args);
};

config.macros.tiddler.transclude = function(wrapper,tiddlerName,args)
{
	var text = store.getTiddlerText(tiddlerName);
	if(!text)
		return;
	var stack = config.macros.tiddler.tiddlerStack;
	if(stack.indexOf(tiddlerName) !== -1)
		return;
	stack.push(tiddlerName);
	try {
		if(typeof args == "string")
			args = args.readBracketedList();
		var n = args ? Math.min(args.length,9) : 0;
		var i;
		for(i=0; i<n; i++) {
			var placeholderRE = new RegExp("\\$" + (i + 1),"mg");
			text = text.replace(placeholderRE,args[i]);
		}
		config.macros.tiddler.renderText(wrapper,text,tiddlerName);
	} finally {
		stack.pop();
	}
};

config.macros.tiddler.renderText = function(place,text,tiddlerName)
{
	wikify(text,place,null,store.getTiddler(tiddlerName));
};

config.macros.tiddler.tiddlerStack = [];

config.macros.tag.handler = function(place,macroName,params)
{
	var btn = createTagButton(place,params[0],null,params[1],params[2]);
	if(params[3]) {
		btn.setAttribute('sortby',params[3]);
	}
};

config.macros.tags.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title && store.tiddlerExists(title))
		tiddler = store.getTiddler(title);
	var sep = getParam(params,"sep"," ");
	var lingo = config.views.wikified.tag;
	var label = null;
	var t;
	for(t=0; t<tiddler.tags.length; t++) {
		var tag = store.getTiddler(tiddler.tags[t]);
		if(!tag || !tag.tags.contains("excludeLists")) {
			if(!label)
				label = createTiddlyElement(ul,"li",null,"listTitle",lingo.labelTags.format([tiddler.title]));
			createTagButton(createTiddlyElement(ul,"li"),tiddler.tags[t],tiddler.title);
			if(t<tiddler.tags.length-1)
				createTiddlyText(ul,sep);
		}
	}
	if(!label)
		createTiddlyElement(ul,"li",null,"listTitle",lingo.labelNoTags.format([tiddler.title]));
};

config.macros.tagging.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,true,false,false);
	var ul = createTiddlyElement(place,"ul");
	var title = getParam(params,"anon","");
	if(title == "" && tiddler instanceof Tiddler)
		title = tiddler.title;
	var sep = getParam(params,"sep"," ");
	ul.setAttribute("title",this.tooltip.format([title]));
	var sortby = getParam(params,"sortBy",false);
	var tagged = store.getTaggedTiddlers(title,sortby);
	var prompt = tagged.length == 0 ? this.labelNotTag : this.label;
	createTiddlyElement(ul,"li",null,"listTitle",prompt.format([title,tagged.length]));
	var t;
	for(t=0; t<tagged.length; t++) {
		createTiddlyLink(createTiddlyElement(ul,"li"),tagged[t].title,true);
		if(t<tagged.length-1)
			createTiddlyText(ul,sep);
	}
};

config.macros.closeAll.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.closeAll.onClick = function(e)
{
	story.closeAllTiddlers();
	return false;
};

config.macros.permaview.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.permaview.onClick = function(e)
{
	story.permaView();
	return false;
};

config.macros.saveChanges.handler = function(place,macroName,params)
{
	if(!readOnly)
		createTiddlyButton(place,params[0] || this.label,params[1] || this.prompt,this.onClick,null,null,this.accessKey);
};

config.macros.saveChanges.onClick = function(e)
{
	saveChanges();
	return false;
};

config.macros.slider.onClickSlider = function(ev)
{
	var n = this.nextSibling;
	var cookie = n.getAttribute("cookie");
	var isOpen = n.style.display != "none";
	if(config.options.chkAnimate && anim && typeof Slider == "function")
		anim.startAnimating(new Slider(n,!isOpen,null,"none"));
	else
		n.style.display = isOpen ? "none" : "block";
	config.options[cookie] = !isOpen;
	saveOption(cookie);
	return false;
};

config.macros.slider.createSlider = function(place,cookie,title,tooltip)
{
	var c = cookie || "";
	createTiddlyButton(place,title,tooltip,this.onClickSlider);
	var panel = createTiddlyElement(null,"div",null,"sliderPanel");
	panel.setAttribute("cookie",c);
	panel.style.display = config.options[c] ? "block" : "none";
	place.appendChild(panel);
	return panel;
};

config.macros.slider.handler = function(place,macroName,params)
{
	var panel = this.createSlider(place,params[0],params[2],params[3]);
	var text = store.getTiddlerText(params[1]);
	panel.setAttribute("refresh","content");
	panel.setAttribute("tiddler",params[1]);
	if(text)
		wikify(text,panel,null,store.getTiddler(params[1]));
};

// <<gradient [[tiddler name]] vert|horiz rgb rgb rgb rgb... >>
config.macros.gradient.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var panel = wikifier ? createTiddlyElement(place,"div",null,"gradient") : place;
	panel.style.position = "relative";
	panel.style.overflow = "hidden";
	panel.style.zIndex = "0";
	if(wikifier) {
		var styles = config.formatterHelpers.inlineCssHelper(wikifier);
		config.formatterHelpers.applyCssHelper(panel,styles);
	}
	params = paramString.parseParams("color");
	var locolors = [], hicolors = [];
	var t;
	for(t=2; t<params.length; t++) {
		var c = params[t].value;
		if(params[t].name == "snap") {
			hicolors[hicolors.length-1] = c;
		} else {
			locolors.push(c);
			hicolors.push(c);
		}
	}
	drawGradient(panel,params[1].value != "vert",locolors,hicolors);
	if(wikifier)
		wikifier.subWikify(panel,">>");
	if(document.all) {
		panel.style.height = "100%";
		panel.style.width = "100%";
	}
};

config.macros.message.handler = function(place,macroName,params)
{
	if(params[0]) {
		var names = params[0].split(".");
		var lookupMessage = function(root,nameIndex) {
				if(root[names[nameIndex]]) {
					if(nameIndex < names.length-1)
						return (lookupMessage(root[names[nameIndex]],nameIndex+1));
					else
						return root[names[nameIndex]];
				} else
					return null;
			};
		var m = lookupMessage(config,0);
		if(m == null)
			m = lookupMessage(window,0);
		createTiddlyText(place,m.toString().format(params.splice(1)));
	}
};


config.macros.view.depth = 0;
config.macros.view.values = [];
config.macros.view.views = {
	text: function(value,place,params,wikifier,paramString,tiddler) {
		highlightify(value,place,highlightHack,tiddler);
	},
	link: function(value,place,params,wikifier,paramString,tiddler) {
		createTiddlyLink(place,value,true);
	},
	wikified: function(value,place,params,wikifier,paramString,tiddler) {
		if(config.macros.view.depth>50)
			return;
		if(config.macros.view.depth>0) {
			if (value==config.macros.view.values[config.macros.view.depth-1]) {
				return;
			}
		}
		config.macros.view.values[config.macros.view.depth] = value;
		config.macros.view.depth++;
		if(params[2])
			value=params[2].unescapeLineBreaks().format([value]);
		wikify(value,place,highlightHack,tiddler);
		config.macros.view.depth--;
		config.macros.view.values[config.macros.view.depth] = null;
	},
	date: function(value,place,params,wikifier,paramString,tiddler) {
		value = Date.convertFromYYYYMMDDHHMM(value);
		createTiddlyText(place,value.formatString(params[2] || config.views.wikified.dateFormat));
	}
};

config.macros.view.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if((tiddler instanceof Tiddler) && params[0]) {
		var value = store.getValue(tiddler,params[0]);
		if(value) {
			var type = params[1] || config.macros.view.defaultView;
			var handler = config.macros.view.views[type];
			if(handler)
				handler(value,place,params,wikifier,paramString,tiddler);
		}
	}
};

config.macros.edit.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var field = params[0];
	var rows = params[1] || 0;
	var defVal = params[2] || '';
	if((tiddler instanceof Tiddler) && field) {
		story.setDirty(tiddler.title,true);
		var e,v;
		if(field != "text" && !rows) {
			e = createTiddlyElement(null,"input",null,null,null,{
				type: "text", edit: field, size: "40", autocomplete: "off"
			});
			e.value = store.getValue(tiddler,field) || defVal;
			place.appendChild(e);
		} else {
			var wrapper1 = createTiddlyElement(null,"fieldset",null,"fieldsetFix");
			var wrapper2 = createTiddlyElement(wrapper1,"div");
			e = createTiddlyElement(wrapper2,"textarea");
			e.value = v = store.getValue(tiddler,field) || defVal;
			rows = rows || 10;
			var lines = v.match(/\n/mg);
			var maxLines = Math.max(parseInt(config.options.txtMaxEditRows,10),5);
			if(lines != null && lines.length > rows)
				rows = lines.length + 5;
			rows = Math.min(rows,maxLines);
			e.setAttribute("rows",rows);
			e.setAttribute("edit",field);
			place.appendChild(wrapper1);
		}
		if(tiddler.isReadOnly()) {
			e.setAttribute("readOnly","readOnly");
			jQuery(e).addClass("readOnly");
		}
		return e;
	}
};

config.macros.tagChooser.onClick = function(ev)
{
	var e = ev || window.event;
	var lingo = config.views.editor.tagChooser;
	var popup = Popup.create(this);
	var tags = store.getTags(this.getAttribute("tags"));
	if(tags.length == 0)
		jQuery("<li/>").text(lingo.popupNone).appendTo(popup);
	var t;
	for(t=0; t<tags.length; t++) {
		var tag = createTiddlyButton(createTiddlyElement(popup,"li"),tags[t][0],lingo.tagTooltip.format([tags[t][0]]),config.macros.tagChooser.onTagClick);
		tag.setAttribute("tag",tags[t][0]);
		tag.setAttribute("tiddler",this.getAttribute("tiddler"));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
};

config.macros.tagChooser.onTagClick = function(ev)
{
	var e = ev || window.event;
	if(e.metaKey || e.ctrlKey) stopEvent(e); //# keep popup open on CTRL-click
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(!readOnly)
		story.setTiddlerTag(title,tag,0);
	return false;
};

config.macros.tagChooser.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(tiddler instanceof Tiddler) {
		var lingo = config.views.editor.tagChooser;
		var btn = createTiddlyButton(place,lingo.text,lingo.tooltip,this.onClick);
		btn.setAttribute("tiddler",tiddler.title);
		btn.setAttribute("tags",params[0]);
	}
};

config.macros.refreshDisplay.handler = function(place)
{
	createTiddlyButton(place,this.label,this.prompt,this.onClick);
};

config.macros.refreshDisplay.onClick = function(e)
{
	refreshAll();
	return false;
};

config.macros.annotations.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var title = tiddler ? tiddler.title : null;
	var a = title ? config.annotations[title] : null;
	if(!tiddler || !title || !a)
		return;
	var text = a.format([title]);
	wikify(text,createTiddlyElement(place,"div",null,"annotation"),null,tiddler);
};

//--
//-- NewTiddler and NewJournal macros
//--

config.macros.newTiddler.createNewTiddlerButton = function(place,title,params,label,prompt,accessKey,newFocus,isJournal)
{
	var tags = [];
	var t;
	for(t=1; t<params.length; t++) {
		if((params[t].name == "anon" && t != 1) || (params[t].name == "tag"))
			tags.push(params[t].value);
	}
	label = getParam(params,"label",label);
	prompt = getParam(params,"prompt",prompt);
	accessKey = getParam(params,"accessKey",accessKey);
	newFocus = getParam(params,"focus",newFocus);
	var customFields = getParam(params,"fields","");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	var btn = createTiddlyButton(place,label,prompt,this.onClickNewTiddler,null,null,accessKey);
	btn.setAttribute("newTitle",title);
	btn.setAttribute("isJournal",isJournal ? "true" : "false");
	if(tags.length > 0)
		btn.setAttribute("params",tags.join("|"));
	btn.setAttribute("newFocus",newFocus);
	btn.setAttribute("newTemplate",getParam(params,"template",DEFAULT_EDIT_TEMPLATE));
	if(customFields !== "")
		btn.setAttribute("customFields",customFields);
	var text = getParam(params,"text");
	if(text !== undefined)
		btn.setAttribute("newText",text);
	return btn;
};

config.macros.newTiddler.onClickNewTiddler = function()
{
	var title = this.getAttribute("newTitle");
	if(this.getAttribute("isJournal") == "true") {
		title = new Date().formatString(title.trim());
	}
	var params = this.getAttribute("params");
	var tags = params ? params.split("|") : [];
	var focus = this.getAttribute("newFocus");
	var template = this.getAttribute("newTemplate");
	var customFields = this.getAttribute("customFields");
	if(!customFields && !store.isShadowTiddler(title))
		customFields = String.encodeHashMap(config.defaultCustomFields);
	story.displayTiddler(null,title,template,false,null,null);
	var tiddlerElem = story.getTiddler(title);
	if(customFields)
		story.addCustomFields(tiddlerElem,customFields);
	var text = this.getAttribute("newText");
	if(typeof text == "string" && story.getTiddlerField(title,"text"))
		story.getTiddlerField(title,"text").value = text.format([title]);
	var t;
	for(t=0;t<tags.length;t++)
		story.setTiddlerTag(title,tags[t],+1);
	story.focusTiddler(title,focus);
	return false;
};

config.macros.newTiddler.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : this.title;
		title = getParam(params,"title",title);
		this.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"title",false);
	}
};

config.macros.newJournal.handler = function(place,macroName,params,wikifier,paramString)
{
	if(!readOnly) {
		params = paramString.parseParams("anon",null,true,false,false);
		var title = params[1] && params[1].name == "anon" ? params[1].value : config.macros.timeline.dateFormat;
		title = getParam(params,"title",title);
		config.macros.newTiddler.createNewTiddlerButton(place,title,params,this.label,this.prompt,this.accessKey,"text",true);
	}
};


//--
//-- Search macro
//--

config.macros.search.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	params = paramString.parseParams("anon",null,false,false,false);
	createTiddlyButton(place,this.label,this.prompt,this.onClick,"searchButton");
	var txt = createTiddlyElement(null,"input",null,"txtOptionInput searchField");
	txt.value = getParam(params,"anon","");
	if(config.browser.isSafari) {
		txt.setAttribute("type","search");
		txt.setAttribute("results","5");
	} else {
		txt.setAttribute("type","text");
	}
	place.appendChild(txt);
	txt.onkeyup = this.onKeyPress;
	txt.onfocus = this.onFocus;
	txt.setAttribute("size",this.sizeTextbox);
	txt.setAttribute("accessKey",getParam(params,"accesskey",this.accessKey));
	txt.setAttribute("autocomplete","off");
	txt.setAttribute("lastSearchText","");
	txt.setAttribute("placeholder",getParam(params,"placeholder",this.placeholder));
};

// Global because there's only ever one outstanding incremental search timer
config.macros.search.timeout = null;

config.macros.search.doSearch = function(txt)
{
	if(txt.value.length > 0) {
		story.search(txt.value,config.options.chkCaseSensitiveSearch,config.options.chkRegExpSearch);
		txt.setAttribute("lastSearchText",txt.value);
	}
};

config.macros.search.onClick = function(e)
{
	config.macros.search.doSearch(this.nextSibling);
	return false;
};

config.macros.search.onKeyPress = function(ev)
{
	var me = config.macros.search;
	var e = ev || window.event;
	switch(e.keyCode) {
		case 9: // Tab
			return;
		case 13: // Ctrl-Enter
		case 10: // Ctrl-Enter on IE PC
			me.doSearch(this);
			break;
		case 27: // Escape
			this.value = "";
			clearMessage();
			break;
	}
	if(config.options.chkIncrementalSearch) {
		if(this.value.length > 2) {
			if(this.value != this.getAttribute("lastSearchText")) {
				if(me.timeout) {
					clearTimeout(me.timeout);
				}
				var txt = this;
				me.timeout = setTimeout(function() {me.doSearch(txt);},500);
			}
		} else {
			if(me.timeout) {
				clearTimeout(me.timeout);
			}
		}
	}
};

config.macros.search.onFocus = function(e)
{
	this.select();
};


//--
//-- Tabs macro
//--

config.macros.tabs.handler = function(place,macroName,params)
{
	var cookie = params[0];
	var numTabs = (params.length-1)/3;
	var wrapper = createTiddlyElement(null,"div",null,"tabsetWrapper " + cookie);
	var tabset = createTiddlyElement(wrapper,"div",null,"tabset");
	tabset.setAttribute("cookie",cookie);
	var validTab = false;
	var t;
	for(t=0; t<numTabs; t++) {
		var label = params[t*3+1];
		var prompt = params[t*3+2];
		var content = params[t*3+3];
		var tab = createTiddlyButton(tabset,label,prompt,this.onClickTab,"tab tabUnselected");
		createTiddlyElement(tab,"span",null,null," ",{style:"font-size:0pt;line-height:0px"});
		tab.setAttribute("tab",label);
		tab.setAttribute("content",content);
		tab.title = prompt;
		if(config.options[cookie] == label)
			validTab = true;
	}
	if(!validTab)
		config.options[cookie] = params[1];
	place.appendChild(wrapper);
	this.switchTab(tabset,config.options[cookie]);
};

config.macros.tabs.onClickTab = function(e)
{
	config.macros.tabs.switchTab(this.parentNode,this.getAttribute("tab"));
	return false;
};

config.macros.tabs.switchTab = function(tabset,tab)
{
	var cookie = tabset.getAttribute("cookie");
	var theTab = null;
	var nodes = tabset.childNodes;
	var t;
	for(t=0; t<nodes.length; t++) {
		if(nodes[t].getAttribute && nodes[t].getAttribute("tab") == tab) {
			theTab = nodes[t];
			theTab.className = "tab tabSelected";
		} else {
			nodes[t].className = "tab tabUnselected";
		}
	}
	if(theTab) {
		if(tabset.nextSibling && tabset.nextSibling.className == "tabContents")
			jQuery(tabset.nextSibling).remove();
		var tabContent = createTiddlyElement(null,"div",null,"tabContents");
		tabset.parentNode.insertBefore(tabContent,tabset.nextSibling);
		var contentTitle = theTab.getAttribute("content");
		wikify(store.getTiddlerText(contentTitle),tabContent,null,store.getTiddler(contentTitle));
		if(cookie) {
			config.options[cookie] = tab;
			saveOption(cookie);
		}
	}
};


//--
//-- Tiddler toolbar
//--

// Create a toolbar command button
config.macros.toolbar.createCommand = function(place,commandName,tiddler,className)
{
	if(typeof commandName != "string") {
		var c = null;
		var t;
		for(t in config.commands) {
			if(config.commands[t] == commandName)
				c = t;
		}
		commandName = c;
	}
	if((tiddler instanceof Tiddler) && (typeof commandName == "string")) {
		var command = config.commands[commandName];
		if(command.isEnabled ? command.isEnabled(tiddler) : this.isCommandEnabled(command,tiddler)) {
			var text = command.getText ? command.getText(tiddler) : this.getCommandText(command,tiddler);
			var tooltip = command.getTooltip ? command.getTooltip(tiddler) : this.getCommandTooltip(command,tiddler);
			var cmd = command.type == "popup" ? this.onClickPopup : this.onClickCommand;
			var btn = createTiddlyButton(null,text,tooltip,cmd);
			btn.setAttribute("commandName",commandName);
			btn.setAttribute("tiddler",tiddler.title);
			jQuery(btn).addClass("command_" + commandName);
			if(className)
				jQuery(btn).addClass(className);
			place.appendChild(btn);
		}
	}
};

config.macros.toolbar.isCommandEnabled = function(command,tiddler)
{
	var title = tiddler.title;
	var ro = tiddler.isReadOnly();
	var shadow = store.isShadowTiddler(title) && !store.tiddlerExists(title);
	return (!ro || (ro && !command.hideReadOnly)) && !(shadow && command.hideShadow);
};

config.macros.toolbar.getCommandText = function(command,tiddler)
{
	return (tiddler.isReadOnly() && command.readOnlyText) || command.text;
};

config.macros.toolbar.getCommandTooltip = function(command,tiddler)
{
	return (tiddler.isReadOnly() && command.readOnlyTooltip) || command.tooltip;
};

config.macros.toolbar.onClickCommand = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var command = config.commands[this.getAttribute("commandName")];
	return command.handler(e,this,this.getAttribute("tiddler"));
};

config.macros.toolbar.onClickPopup = function(ev)
{
	var e = ev || window.event;
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	var popup = Popup.create(this);
	var command = config.commands[this.getAttribute("commandName")];
	var title = this.getAttribute("tiddler");
	popup.setAttribute("tiddler",title);
	command.handlePopup(popup,title);
	Popup.show();
	return false;
};

// Invoke the first command encountered from a given place that is tagged with a specified class
config.macros.toolbar.invokeCommand = function(place,className,event)
{
	var children = place.getElementsByTagName("a");
	var t;
	for(t=0; t<children.length; t++) {
		var c = children[t];
		if(jQuery(c).hasClass(className) && c.getAttribute && c.getAttribute("commandName")) {
			if(c.onclick instanceof Function)
				c.onclick.call(c,event);
			break;
		}
	}
};

config.macros.toolbar.onClickMore = function(ev)
{
	var e = this.nextSibling;
	e.style.display = "inline";
	this.style.display = "none";
	return false;
};

config.macros.toolbar.onClickLess = function(ev)
{
	var e = this.parentNode;
	var m = e.previousSibling;
	e.style.display = "none";
	m.style.display = "inline";
	return false;
};

config.macros.toolbar.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	var t;
	for(t=0; t<params.length; t++) {
		var btn;
		var c = params[t];
		switch(c) {
		case "!":
			createTiddlyText(place,this.separator);
			break;
		case "*":
			createTiddlyElement(place,"br");
			break;
		case "<":
			btn = createTiddlyButton(place,this.lessLabel,this.lessPrompt,config.macros.toolbar.onClickLess);
			jQuery(btn).addClass("lessCommand");
			break;
		case ">":
			btn = createTiddlyButton(place,this.moreLabel,this.morePrompt,config.macros.toolbar.onClickMore);
			jQuery(btn).addClass("moreCommand");
			var e = createTiddlyElement(place,"span",null,"moreCommand");
			e.style.display = "none";
			place = e;
			break;
		default:
			var className = "";
			switch(c.substr(0,1)) {
			case "+":
				className = "defaultCommand";
				c = c.substr(1);
				break;
			case "-":
				className = "cancelCommand";
				c = c.substr(1);
				break;
			}
			if(config.commands[c]) {
				this.createCommand(place,c,tiddler,className);
			} else {
				this.customCommand(place,c,wikifier,tiddler);
			}
			break;
		}
	}
};

// Overrideable function to extend toolbar handler
config.macros.toolbar.customCommand = function(place,command,wikifier,tiddler)
{
};


//--
//-- Menu and toolbar commands
//--

config.commands.closeTiddler.handler = function(event,src,title)
{
	if(story.isDirty(title) && !readOnly) {
		if(!confirm(config.commands.cancelTiddler.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.closeTiddler(title,true);
	return false;
};

config.commands.closeOthers.handler = function(event,src,title)
{
	story.closeAllTiddlers(title);
	return false;
};

config.commands.editTiddler.handler = function(event,src,title)
{
	clearMessage();
	var tiddlerElem = story.getTiddler(title);
	var fields = tiddlerElem.getAttribute("tiddlyFields");
	story.displayTiddler(null,title,DEFAULT_EDIT_TEMPLATE,false,null,fields);
	var e = story.getTiddlerField(title,config.options.txtEditorFocus||"text");
	if(e) {
		setCaretPosition(e,0);
	}
	return false;
};

config.commands.saveTiddler.handler = function(event,src,title)
{
	var newTitle = story.saveTiddler(title,event.shiftKey);
	if(newTitle)
		story.displayTiddler(null,newTitle);
	return false;
};

config.commands.cancelTiddler.handler = function(event,src,title)
{
	if(story.hasChanges(title) && !readOnly) {
		if(!confirm(this.warning.format([title])))
			return false;
	}
	story.setDirty(title,false);
	story.displayTiddler(null,title);
	return false;
};

config.commands.deleteTiddler.handler = function(event,src,title)
{
	var deleteIt = true;
	if(config.options.chkConfirmDelete)
		deleteIt = confirm(this.warning.format([title]));
	if(deleteIt) {
		store.removeTiddler(title);
		story.closeTiddler(title,true);
		autoSaveChanges();
	}
	return false;
};

config.commands.permalink.handler = function(event,src,title)
{
	var t = encodeURIComponent(String.encodeTiddlyLink(title));
	if(window.location.hash != t)
		window.location.hash = t;
	return false;
};

config.commands.references.handlePopup = function(popup,title)
{
	var references = store.getReferringTiddlers(title);
	var c = false;
	var r;
	for(r=0; r<references.length; r++) {
		if(references[r].title != title && !references[r].isTagged("excludeLists")) {
			createTiddlyLink(createTiddlyElement(popup,"li"),references[r].title,true);
			c = true;
		}
	}
	if(!c)
		createTiddlyElement(popup,"li",null,"disabled",this.popupNone);
};

config.commands.jump.handlePopup = function(popup,title)
{
	story.forEachTiddler(function(title,element) {
		createTiddlyLink(createTiddlyElement(popup,"li"),title,true,null,false,null,true);
		});
};

config.commands.fields.handlePopup = function(popup,title)
{
	var tiddler = store.fetchTiddler(title);
	if(!tiddler)
		return;
	var items = [];
	store.forEachField(tiddler,function(tiddler,fieldName,value){items.push({field:fieldName,value:value});},true);
	items.sort(function(a,b) {return a.field < b.field ? -1 : (a.field == b.field ? 0 : +1);});
	if(items.length > 0)
		ListView.create(popup,items,this.listViewTemplate);
	else
		createTiddlyElement(popup,"div",null,null,this.emptyText);
};


//--
//-- Tiddler() object
//--

function Tiddler(title)
{
	this.title = title;
	this.text = "";
	this.creator = null;
	this.modifier = null;
	this.created = new Date();
	this.modified = this.created;
	this.links = [];
	this.linksUpdated = false;
	this.tags = [];
	this.fields = {};
	return this;
}

Tiddler.prototype.getLinks = function()
{
	if(this.linksUpdated==false)
		this.changed();
	return this.links;
};

// Returns the fields that are inherited in string field:"value" field2:"value2" format
Tiddler.prototype.getInheritedFields = function()
{
	var f = {};
	var i;
	for(i in this.fields) {
		if(i=="server.host" || i=="server.workspace" || i=="wikiformat"|| i=="server.type") {
			f[i] = this.fields[i];
		}
	}
	return String.encodeHashMap(f);
};

// Increment the changeCount of a tiddler
Tiddler.prototype.incChangeCount = function()
{
	var c = this.fields['changecount'];
	c = c ? parseInt(c,10) : 0;
	this.fields['changecount'] = String(c+1);
};

// Clear the changeCount of a tiddler
Tiddler.prototype.clearChangeCount = function()
{
	if(this.fields['changecount']) {
		delete this.fields['changecount'];
	}
};

Tiddler.prototype.doNotSave = function()
{
	return this.fields['doNotSave'];
};

// Returns true if the tiddler has been updated since the tiddler was created or downloaded
Tiddler.prototype.isTouched = function()
{
	var changecount = this.fields.changecount || 0;
	return changecount > 0;
};

// Change the text and other attributes of a tiddler
Tiddler.prototype.set = function(title,text,modifier,modified,tags,created,fields,creator)
{
	this.assign(title,text,modifier,modified,tags,created,fields,creator);
	this.changed();
	return this;
};

// Change the text and other attributes of a tiddler without triggered a tiddler.changed() call
Tiddler.prototype.assign = function(title,text,modifier,modified,tags,created,fields,creator)
{
	if(title != undefined)
		this.title = title;
	if(text != undefined)
		this.text = text;
	if(modifier != undefined)
		this.modifier = modifier;
	if(modified != undefined)
		this.modified = modified;
	if(creator != undefined)
		this.creator = creator;
	if(created != undefined)
		this.created = created;
	if(fields != undefined)
		this.fields = fields;
	if(tags != undefined)
		this.tags = (typeof tags == "string") ? tags.readBracketedList() : tags;
	else if(this.tags == undefined)
		this.tags = [];
	return this;
};

// Get the tags for a tiddler as a string (space delimited, using [[brackets]] for tags containing spaces)
Tiddler.prototype.getTags = function()
{
	return String.encodeTiddlyLinkList(this.tags);
};

// Test if a tiddler carries a tag
Tiddler.prototype.isTagged = function(tag)
{
	return this.tags.indexOf(tag) != -1;
};

// Static method to convert "\n" to newlines, "\s" to "\"
Tiddler.unescapeLineBreaks = function(text)
{
	return text ? text.unescapeLineBreaks() : "";
};

// Convert newlines to "\n", "\" to "\s"
Tiddler.prototype.escapeLineBreaks = function()
{
	return this.text.escapeLineBreaks();
};

// Updates the secondary information (like links[] array) after a change to a tiddler
Tiddler.prototype.changed = function()
{
	this.links = [];
	var text = this.text;
	// remove 'quoted' text before scanning tiddler source
	text = text.replace(/\/%((?:.|\n)*?)%\//g,"").
		replace(/\{{3}((?:.|\n)*?)\}{3}/g,"").
		replace(/"""((?:.|\n)*?)"""/g,"").
		replace(/<nowiki\>((?:.|\n)*?)<\/nowiki\>/g,"").
		replace(/<html\>((?:.|\n)*?)<\/html\>/g,"").
		replace(/<script((?:.|\n)*?)<\/script\>/g,"");
	var t = this.autoLinkWikiWords() ? 0 : 1;
	var tiddlerLinkRegExp = t==0 ? config.textPrimitives.tiddlerAnyLinkRegExp : config.textPrimitives.tiddlerForcedLinkRegExp;
	tiddlerLinkRegExp.lastIndex = 0;
	var formatMatch = tiddlerLinkRegExp.exec(text);
	while(formatMatch) {
		var lastIndex = tiddlerLinkRegExp.lastIndex;
		if(t==0 && formatMatch[1] && formatMatch[1] != this.title) {
			// wikiWordLink
			if(formatMatch.index > 0) {
				var preRegExp = new RegExp(config.textPrimitives.unWikiLink+"|"+config.textPrimitives.anyLetter,"mg");
				preRegExp.lastIndex = formatMatch.index-1;
				var preMatch = preRegExp.exec(text);
				if(preMatch.index != formatMatch.index-1)
					this.links.pushUnique(formatMatch[1]);
			} else {
				this.links.pushUnique(formatMatch[1]);
			}
		}
		else if(formatMatch[2-t] && !config.formatterHelpers.isExternalLink(formatMatch[3-t])) // titledBrackettedLink
			this.links.pushUnique(formatMatch[3-t]);
		else if(formatMatch[4-t] && formatMatch[4-t] != this.title) // brackettedLink
			this.links.pushUnique(formatMatch[4-t]);
		tiddlerLinkRegExp.lastIndex = lastIndex;
		formatMatch = tiddlerLinkRegExp.exec(text);
	}
	this.linksUpdated = true;
};

Tiddler.prototype.getSubtitle = function()
{
	var modifier = this.modifier;
	if(!modifier)
		modifier = config.messages.subtitleUnknown || "";
	var modified = this.modified;
	if(modified)
		modified = modified.toLocaleString();
	else
		modified = config.messages.subtitleUnknown || "";
	var f = config.messages.tiddlerLinkTooltip || "%0 - %1, %2";
	return f.format([this.title,modifier,modified]);
};

Tiddler.prototype.isReadOnly = function()
{
	return readOnly;
};

Tiddler.prototype.autoLinkWikiWords = function()
{
	return !(this.isTagged("systemConfig") || this.isTagged("excludeMissing"));
};

Tiddler.prototype.getServerType = function()
{
	var serverType = null;
	if(this.fields['server.type'])
		serverType = this.fields['server.type'];
	if(!serverType)
		serverType = this.fields['wikiformat'];
	if(serverType && !config.adaptors[serverType])
		serverType = null;
	return serverType;
};

Tiddler.prototype.getAdaptor = function()
{
	var serverType = this.getServerType();
	return serverType ? new config.adaptors[serverType]() : null;
};


//--
//-- TiddlyWiki instance contains TiddlerS
//--

function TiddlyWiki(params)
{
	var tiddlers = {}; // Hashmap by name of tiddlers
	if(params && params.config) {
		this.config = config;
	}
	this.tiddlersUpdated = false;
	this.namedNotifications = []; // Array of {name:,notify:} of notification functions
	this.notificationLevel = 0;
	this.slices = {}; // map tiddlerName->(map sliceName->sliceValue). Lazy.
	this.clear = function() {
		tiddlers = {};
		this.setDirty(false);
	};
	this.fetchTiddler = function(title) {
		var t = tiddlers[title];
		return t instanceof Tiddler ? t : null;
	};
	this.deleteTiddler = function(title) {
		delete this.slices[title];
		delete tiddlers[title];
	};
	this.addTiddler = function(tiddler) {
		delete this.slices[tiddler.title];
		tiddlers[tiddler.title] = tiddler;
	};
	this.forEachTiddler = function(callback) {
		var t;
		for(t in tiddlers) {
			var tiddler = tiddlers[t];
			if(tiddler instanceof Tiddler)
				callback.call(this,t,tiddler);
		}
	};
}

TiddlyWiki.prototype.setDirty = function(dirty)
{
	this.dirty = dirty;
};

TiddlyWiki.prototype.isDirty = function()
{
	return this.dirty;
};

TiddlyWiki.prototype.tiddlerExists = function(title)
{
	var t = this.fetchTiddler(title);
	return t != undefined;
};

TiddlyWiki.prototype.isShadowTiddler = function(title)
{
	return config.shadowTiddlers[title] === undefined ? false : true;
};

TiddlyWiki.prototype.isAvailable = function(title) {
	if (!title)
		return false;
	var s = title ? title.indexOf(config.textPrimitives.sectionSeparator) : -1;
	if(s!=-1)
		title = title.substr(0,s);
	return this.tiddlerExists(title) || this.isShadowTiddler(title);
};

TiddlyWiki.prototype.createTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler) {
		tiddler = new Tiddler(title);
		this.addTiddler(tiddler);
		this.setDirty(true);
	}
	return tiddler;
};

TiddlyWiki.prototype.getTiddler = function(title)
{
	var t = this.fetchTiddler(title);
	if(t != undefined)
		return t;
	else
		return null;
};

TiddlyWiki.prototype.getShadowTiddlerText = function(title)
{
	if(typeof config.shadowTiddlers[title] == "string")
		return config.shadowTiddlers[title];
	else
		return "";
};

// Retrieve tiddler contents
TiddlyWiki.prototype.getTiddlerText = function(title,defaultText)
{
	if(!title)
		return defaultText;
	var pos = title.indexOf(config.textPrimitives.sectionSeparator);
	var section = null;
	if(pos != -1) {
		section = title.substr(pos + config.textPrimitives.sectionSeparator.length);
		title = title.substr(0,pos);
	}
	pos = title.indexOf(config.textPrimitives.sliceSeparator);
	if(pos != -1) {
		var slice = this.getTiddlerSlice(title.substr(0,pos),title.substr(pos + config.textPrimitives.sliceSeparator.length));
		if(slice)
			return slice;
	}
	var tiddler = this.fetchTiddler(title);
	var text = tiddler ? tiddler.text : null;
	if(!tiddler && this.isShadowTiddler(title)) {
		text = this.getShadowTiddlerText(title);
	}
	if(text) {
		if(!section)
			return text;
		var re = new RegExp("(^!{1,6}[ \t]*" + section.escapeRegExp() + "[ \t]*\n)","mg");
		re.lastIndex = 0;
		var match = re.exec(text);
		if(match) {
			var t = text.substr(match.index+match[1].length);
			var re2 = /^!/mg;
			re2.lastIndex = 0;
			match = re2.exec(t); //# search for the next heading
			if(match)
				t = t.substr(0,match.index-1);//# don't include final \n
			return t;
		}
		return defaultText;
	}
	if(defaultText != undefined)
		return defaultText;
	return null;
};

TiddlyWiki.prototype.getRecursiveTiddlerText = function(title,defaultText,depth)
{
	var bracketRegExp = new RegExp("(?:\\[\\[([^\\]]+)\\]\\])","mg");
	var text = this.getTiddlerText(title,null);
	if(text == null)
		return defaultText;
	var textOut = [];
	var match,lastPos = 0;
	do {
		match = bracketRegExp.exec(text);
		if(match) {
			textOut.push(text.substr(lastPos,match.index-lastPos));
			if(match[1]) {
				if(depth <= 0)
					textOut.push(match[1]);
				else
					textOut.push(this.getRecursiveTiddlerText(match[1],"",depth-1));
			}
			lastPos = match.index + match[0].length;
		} else {
			textOut.push(text.substr(lastPos));
		}
	} while(match);
	return textOut.join("");
};

//TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]+)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\n]+)[\t\x20]*\|$)/gm;
TiddlyWiki.prototype.slicesRE = /(?:^([\'\/]{0,2})~?([\.\w]+)\:\1[\t\x20]*([^\n]*)[\t\x20]*$)|(?:^\|([\'\/]{0,2})~?([\.\w]+)\:?\4\|[\t\x20]*([^\|\n]*)[\t\x20]*\|$)/gm;
// @internal
TiddlyWiki.prototype.calcAllSlices = function(title)
{
	var slices = {};
	var text = this.getTiddlerText(title,"");
	this.slicesRE.lastIndex = 0;
	var m = this.slicesRE.exec(text);
	while(m) {
		if(m[2])
			slices[m[2]] = m[3];
		else
			slices[m[5]] = m[6];
		m = this.slicesRE.exec(text);
	}
	return slices;
};

// Returns the slice of text of the given name
TiddlyWiki.prototype.getTiddlerSlice = function(title,sliceName)
{
	var slices = this.slices[title];
	if(!slices) {
		slices = this.calcAllSlices(title);
		this.slices[title] = slices;
	}
	return slices[sliceName];
};

// Build an hashmap of the specified named slices of a tiddler
TiddlyWiki.prototype.getTiddlerSlices = function(title,sliceNames)
{
	var t,r = {};
	for(t=0; t<sliceNames.length; t++) {
		var slice = this.getTiddlerSlice(title,sliceNames[t]);
		if(slice)
			r[sliceNames[t]] = slice;
	}
	return r;
};

TiddlyWiki.prototype.suspendNotifications = function()
{
	this.notificationLevel--;
};

TiddlyWiki.prototype.resumeNotifications = function()
{
	this.notificationLevel++;
};

// Invoke the notification handlers for a particular tiddler
TiddlyWiki.prototype.notify = function(title,doBlanket)
{
	if(!this.notificationLevel) {
	    var t;
		for(t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if((n.name == null && doBlanket) || (n.name == title))
				n.notify(title);
		}
	}
};

// Invoke the notification handlers for all tiddlers
TiddlyWiki.prototype.notifyAll = function()
{
	if(!this.notificationLevel) {
	    var t;
		for(t=0; t<this.namedNotifications.length; t++) {
			var n = this.namedNotifications[t];
			if(n.name)
				n.notify(n.name);
		}
	}
};

// Add a notification handler to a tiddler
TiddlyWiki.prototype.addNotification = function(title,fn)
{
	var i;
	for(i=0; i<this.namedNotifications.length; i++) {
		if((this.namedNotifications[i].name == title) && (this.namedNotifications[i].notify == fn))
			return this;
	}
	this.namedNotifications.push({name: title, notify: fn});
	return this;
};

TiddlyWiki.prototype.removeTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		this.deleteTiddler(title);
		this.notify(title,true);
		this.setDirty(true);
	}
};

// Reset the sync status of a freshly synced tiddler
TiddlyWiki.prototype.resetTiddler = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		tiddler.clearChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.setTiddlerTag = function(title,status,tag)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler) {
		var t = tiddler.tags.indexOf(tag);
		if(t != -1)
			tiddler.tags.splice(t,1);
		if(status)
			tiddler.tags.push(tag);
		tiddler.changed();
		tiddler.incChangeCount();
		this.notify(title,true);
		this.setDirty(true);
	}
};

TiddlyWiki.prototype.addTiddlerFields = function(title,fields)
{
	var tiddler = this.fetchTiddler(title);
	if(!tiddler)
		return;
	merge(tiddler.fields,fields);
	tiddler.changed();
	tiddler.incChangeCount();
	this.notify(title,true);
	this.setDirty(true);
};

// Store tiddler in TiddlyWiki instance
TiddlyWiki.prototype.saveTiddler = function(title,newTitle,newBody,modifier,modified,tags,fields,clearChangeCount,created,creator)
{
	var tiddler;
	if(title instanceof Tiddler) {
		tiddler = title;
		tiddler.fields = merge(merge({},tiddler.fields),config.defaultCustomFields,true);
		title = tiddler.title;
		newTitle = title;
	} else {
		tiddler = this.fetchTiddler(title);
		if(tiddler) {
			created = created || tiddler.created; // Preserve created date
			creator = creator || tiddler.creator;
			this.deleteTiddler(title);
		} else {
			created = created || modified;
			tiddler = new Tiddler();
		}
		fields = merge(merge({},fields),config.defaultCustomFields,true);
		tiddler.set(newTitle,newBody,modifier,modified,tags,created,fields,creator);
	}
	this.addTiddler(tiddler);
	if(clearChangeCount)
		tiddler.clearChangeCount();
	else
		tiddler.incChangeCount();
	if(title != newTitle)
		this.notify(title,true);
	this.notify(newTitle,true);
	this.setDirty(true);
	return tiddler;
};

TiddlyWiki.prototype.incChangeCount = function(title)
{
	var tiddler = this.fetchTiddler(title);
	if(tiddler)
		tiddler.incChangeCount();
};

TiddlyWiki.prototype.getLoader = function()
{
	if(!this.loader)
		this.loader = new TW21Loader();
	return this.loader;
};

TiddlyWiki.prototype.getSaver = function()
{
	if(!this.saver)
		this.saver = new TW21Saver();
	return this.saver;
};

// Return all tiddlers formatted as an HTML string
TiddlyWiki.prototype.allTiddlersAsHtml = function()
{
	return this.getSaver().externalize(store);
};

// Load contents of a TiddlyWiki from an HTML DIV
TiddlyWiki.prototype.loadFromDiv = function(src,idPrefix,noUpdate)
{
	this.idPrefix = idPrefix;
	var storeElem = (typeof src == "string") ? document.getElementById(src) : src;
	if(!storeElem)
		return;
	var tiddlers = this.getLoader().loadTiddlers(this,storeElem.childNodes);
	this.setDirty(false);
	if(!noUpdate) {
		var i;
		for(i = 0;i<tiddlers.length; i++)
			tiddlers[i].changed();
	}
	jQuery(document).trigger("loadTiddlers");
};

// Load contents of a TiddlyWiki from a string
// Returns null if there's an error
TiddlyWiki.prototype.importTiddlyWiki = function(text)
{
	var posDiv = locateStoreArea(text);
	if(!posDiv)
		return null;
	var content = "<" + "html><" + "body>" + text.substring(posDiv[0],posDiv[1] + endSaveArea.length) + "<" + "/body><" + "/html>";
	// Create the iframe
	var iframe = document.createElement("iframe");
	iframe.style.display = "none";
	document.body.appendChild(iframe);
	var doc = iframe.document;
	if(iframe.contentDocument)
		doc = iframe.contentDocument; // For NS6
	else if(iframe.contentWindow)
		doc = iframe.contentWindow.document; // For IE5.5 and IE6
	// Put the content in the iframe
	doc.open();
	doc.writeln(content);
	doc.close();
	// Load the content into a TiddlyWiki() object
	var storeArea = doc.getElementById("storeArea");
	this.loadFromDiv(storeArea,"store");
	// Get rid of the iframe
	iframe.parentNode.removeChild(iframe);
	return this;
};

TiddlyWiki.prototype.updateTiddlers = function()
{
	this.tiddlersUpdated = true;
	this.forEachTiddler(function(title,tiddler) {
		tiddler.changed();
	});
};

// Return an array of tiddlers matching a search regular expression
TiddlyWiki.prototype.search = function(searchRegExp,sortField,excludeTag,match)
{
	var candidates = this.reverseLookup("tags",excludeTag,!!match);
	var t,results = [];
	for(t=0; t<candidates.length; t++) {
		if((candidates[t].title.search(searchRegExp) != -1) || (candidates[t].text.search(searchRegExp) != -1))
			results.push(candidates[t]);
	}
	if(!sortField)
		sortField = "title";
	results.sort(function(a,b) {return a[sortField] < b[sortField] ? -1 : (a[sortField] == b[sortField] ? 0 : +1);});
	return results;
};

// Returns a list of all tags in use
//   excludeTag - if present, excludes tags that are themselves tagged with excludeTag
// Returns an array of arrays where [tag][0] is the name of the tag and [tag][1] is the number of occurances
TiddlyWiki.prototype.getTags = function(excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
	    var g,c;
		for(g=0; g<tiddler.tags.length; g++) {
			var tag = tiddler.tags[g];
			var n = true;
			for(c=0; c<results.length; c++) {
				if(results[c][0] == tag) {
					n = false;
					results[c][1]++;
				}
			}
			if(n && excludeTag) {
				var t = this.fetchTiddler(tag);
				if(t && t.isTagged(excludeTag))
					n = false;
			}
			if(n)
				results.push([tag,1]);
		}
	});
	results.sort(function(a,b) {return a[0].toLowerCase() < b[0].toLowerCase() ? -1 : (a[0].toLowerCase() == b[0].toLowerCase() ? 0 : +1);});
	return results;
};

// Return an array of the tiddlers that are tagged with a given tag
TiddlyWiki.prototype.getTaggedTiddlers = function(tag,sortField)
{
	return this.reverseLookup("tags",tag,true,sortField);
};

TiddlyWiki.prototype.getValueTiddlers = function(field,value,sortField)
{
	return this.reverseLookup(field,value,true,sortField);
};

// Return an array of the tiddlers that link to a given tiddler
TiddlyWiki.prototype.getReferringTiddlers = function(title,unusedParameter,sortField)
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	return this.reverseLookup("links",title,true,sortField);
};

// Return an array of the tiddlers that do or do not have a specified entry in the specified storage array (ie, "links" or "tags")
// lookupMatch == true to match tiddlers, false to exclude tiddlers
TiddlyWiki.prototype.reverseLookup = function(lookupField,lookupValue,lookupMatch,sortField)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		var f = !lookupMatch;
		var values;
		if(["links", "tags"].contains(lookupField)) {
			values = tiddler[lookupField];
		} else {
			var accessor = TiddlyWiki.standardFieldAccess[lookupField];
			if(accessor) {
				values = [ accessor.get(tiddler) ];
			} else {
				values = tiddler.fields[lookupField] ? [tiddler.fields[lookupField]] : [];
			}
		}
		var lookup;
		for(lookup=0; lookup<values.length; lookup++) {
			if(values[lookup] == lookupValue)
				f = lookupMatch;
		}
		if(f)
			results.push(tiddler);
	});
	if(!sortField)
		sortField = "title";
	return this.sortTiddlers(results,sortField);
};

// Return the tiddlers as a sorted array
TiddlyWiki.prototype.getTiddlers = function(field,excludeTag)
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(excludeTag == undefined || !tiddler.isTagged(excludeTag))
			results.push(tiddler);
	});
	if(field)
		results.sort(function(a,b) {return a[field] < b[field] ? -1 : (a[field] == b[field] ? 0 : +1);});
	return results;
};

// Return array of names of tiddlers that are referred to but not defined
TiddlyWiki.prototype.getMissingLinks = function()
{
	if(!this.tiddlersUpdated)
		this.updateTiddlers();
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(tiddler.isTagged("excludeMissing") || tiddler.isTagged("systemConfig"))
			return;
		var n;
		for(n=0; n<tiddler.links.length;n++) {
			var link = tiddler.links[n];
			if(this.getTiddlerText(link,null) == null && !this.isShadowTiddler(link) && !config.macros[link])
				results.pushUnique(link);
		}
	});
	results.sort();
	return results;
};

// Return an array of names of tiddlers that are defined but not referred to
TiddlyWiki.prototype.getOrphans = function()
{
	var results = [];
	this.forEachTiddler(function (title,tiddler) {
		if(this.getReferringTiddlers(title).length == 0 && !tiddler.isTagged("excludeLists"))
			results.push(title);
	});
	results.sort();
	return results;
};

// Return an array of names of all the shadow tiddlers
TiddlyWiki.prototype.getShadowed = function()
{
	var t,results = [];
	for(t in config.shadowTiddlers) {
		if(this.isShadowTiddler(t))
			results.push(t);
	}
	results.sort();
	return results;
};

// Return an array of tiddlers that have been touched since they were downloaded or created
TiddlyWiki.prototype.getTouched = function()
{
	var results = [];
	this.forEachTiddler(function(title,tiddler) {
		if(tiddler.isTouched())
			results.push(tiddler);
		});
	results.sort();
	return results;
};

// Resolves a Tiddler reference or tiddler title into a Tiddler object, or null if it doesn't exist
TiddlyWiki.prototype.resolveTiddler = function(tiddler)
{
	var t = (typeof tiddler == "string") ? this.getTiddler(tiddler) : tiddler;
	return t instanceof Tiddler ? t : null;
};

// Sort a list of tiddlers
TiddlyWiki.prototype.sortTiddlers = function(tiddlers,field)
{
	var asc = +1;
	switch(field.substr(0,1)) {
	case "-":
		asc = -1;
		field = field.substr(1);
		break;
	case "+":
		field = field.substr(1);
		break;
	}
	if(TiddlyWiki.standardFieldAccess[field]) {
		if(field=="title") {
			tiddlers.sort(function(a,b) {return a[field].toLowerCase() < b[field].toLowerCase() ? -asc : (a[field].toLowerCase() == b[field].toLowerCase() ? 0 : asc);});
		} else {
			tiddlers.sort(function(a,b) {return a[field] < b[field] ? -asc : (a[field] == b[field] ? 0 : asc);});
		}
	} else {
		tiddlers.sort(function(a,b) {return a.fields[field] < b.fields[field] ? -asc : (a.fields[field] == b.fields[field] ? 0 : +asc);});
	}
	return tiddlers;
};


//--
//-- Filter a list of tiddlers
//--

config.filters = {
	tiddler: function(results,match) {
		var title = match[1]||match[4];
		var tiddler = this.fetchTiddler(title);
		if(tiddler) {
			results.pushUnique(tiddler);
		} else if(this.isShadowTiddler(title)) {
			tiddler = new Tiddler();
			tiddler.set(title,this.getTiddlerText(title));
			results.pushUnique(tiddler);
		} else {
			results.pushUnique(new Tiddler(title));
		}
		return results;
	},
	tag: function(results,match) {
		var m,matched = this.getTaggedTiddlers(match[3]);
		for(m=0; m<matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	},
	sort: function(results,match) {
		return this.sortTiddlers(results,match[3]);
	},
	limit: function(results,match) {
		return results.slice(0,parseInt(match[3],10));
	},
	field: function(results,match) {
		var m,matched = this.getValueTiddlers(match[2],match[3]);
		for (m = 0; m < matched.length; m++) {
			results.pushUnique(matched[m]);
		}
		return results;
	}
};

// Filter a list of tiddlers
TiddlyWiki.prototype.filterTiddlers = function(filter)
{
	var re = /([^\s\[\]]+)|(?:\[([ \w\.\-]+)\[([^\]]+)\]\])|(?:\[\[([^\]]+)\]\])/mg;

	var results = [];
	if(filter) {
		var match = re.exec(filter);
		while(match) {
			var handler = (match[1]||match[4])?'tiddler':config.filters[match[2]]?match[2]:'field';
			results = config.filters[handler].call(this,results,match);
			match = re.exec(filter);
		}
	}
	return results;
};

// Returns true if path is a valid field name (path),
// i.e. a sequence of identifiers, separated by "."
TiddlyWiki.isValidFieldName = function(name)
{
	var match = /[a-zA-Z_]\w*(\.[a-zA-Z_]\w*)*/.exec(name);
	return match && (match[0] == name);
};

// Throws an exception when name is not a valid field name.
TiddlyWiki.checkFieldName = function(name)
{
	if(!TiddlyWiki.isValidFieldName(name))
		throw config.messages.invalidFieldName.format([name]);
};

function StringFieldAccess(n,readOnly)
{
	this.set = readOnly ?
			function(t,v) {if(v != t[n]) throw config.messages.fieldCannotBeChanged.format([n]);} :
			function(t,v) {if(v != t[n]) {t[n] = v; return true;}};
	this.get = function(t) {return t[n];};
}

function DateFieldAccess(n)
{
	this.set = function(t,v) {
		var d = v instanceof Date ? v : Date.convertFromYYYYMMDDHHMM(v);
		if(d != t[n]) {
			t[n] = d; return true;
		}
	};
	this.get = function(t) {return t[n].convertToYYYYMMDDHHMM();};
}

function LinksFieldAccess(n)
{
	this.set = function(t,v) {
		var s = (typeof v == "string") ? v.readBracketedList() : v;
		if(s.toString() != t[n].toString()) {
			t[n] = s; return true;
		}
	};
	this.get = function(t) {return String.encodeTiddlyLinkList(t[n]);};
}

TiddlyWiki.standardFieldAccess = {
	// The set functions return true when setting the data has changed the value.
	"title":    new StringFieldAccess("title",true),
	// Handle the "tiddler" field name as the title
	"tiddler":  new StringFieldAccess("title",true),
	"text":     new StringFieldAccess("text"),
	"modifier": new StringFieldAccess("modifier"),
	"modified": new DateFieldAccess("modified"),
	"creator":  new StringFieldAccess("creator"),
	"created":  new DateFieldAccess("created"),
	"tags":     new LinksFieldAccess("tags")
};

TiddlyWiki.isStandardField = function(name)
{
	return TiddlyWiki.standardFieldAccess[name] != undefined;
};

// Sets the value of the given field of the tiddler to the value.
// Setting an ExtendedField's value to null or undefined removes the field.
// Setting a namespace to undefined removes all fields of that namespace.
// The fieldName is case-insensitive.
// All values will be converted to a string value.
TiddlyWiki.prototype.setValue = function(tiddler,fieldName,value)
{
	TiddlyWiki.checkFieldName(fieldName);
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return;
	fieldName = fieldName.toLowerCase();
	var isRemove = (value === undefined) || (value === null);
	var accessor = TiddlyWiki.standardFieldAccess[fieldName];
	if(accessor) {
		if(isRemove)
			// don't remove StandardFields
			return;
		var h = TiddlyWiki.standardFieldAccess[fieldName];
		if(!h.set(t,value))
			return;
	} else {
		var oldValue = t.fields[fieldName];
		if(isRemove) {
			if(oldValue !== undefined) {
				// deletes a single field
				delete t.fields[fieldName];
			} else {
				// no concrete value is defined for the fieldName
				// so we guess this is a namespace path.
				// delete all fields in a namespace
				var re = new RegExp("^"+fieldName+"\\.");
				var dirty = false;
				var n;
				for(n in t.fields) {
					if(n.match(re)) {
						delete t.fields[n];
						dirty = true;
					}
				}
				if(!dirty)
					return;
			}
		} else {
			// the "normal" set case. value is defined (not null/undefined)
			// For convenience provide a nicer conversion Date->String
			value = value instanceof Date ? value.convertToYYYYMMDDHHMMSSMMM() : String(value);
			if(oldValue == value)
				return;
			t.fields[fieldName] = value;
		}
	}
	// When we are here the tiddler/store really was changed.
	this.notify(t.title,true);
	if(!fieldName.match(/^temp\./))
		this.setDirty(true);
};

// Returns the value of the given field of the tiddler.
// The fieldName is case-insensitive.
// Will only return String values (or undefined).
TiddlyWiki.prototype.getValue = function(tiddler,fieldName)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	if(fieldName.indexOf(config.textPrimitives.sectionSeparator) === 0 || fieldName.indexOf(config.textPrimitives.sliceSeparator) === 0) {
		var sliceType = fieldName.substr(0, 2);
		var sliceName = fieldName.substring(2);
		return store.getTiddlerText("%0%1%2".format(t.title,sliceType,sliceName));
	} else {
		fieldName = fieldName.toLowerCase();
		var accessor = TiddlyWiki.standardFieldAccess[fieldName];
		if(accessor) {
			return accessor.get(t);
		}
	}
	return t.fields[fieldName];
};

// Calls the callback function for every field in the tiddler.
// When callback function returns a non-false value the iteration stops
// and that value is returned.
// The order of the fields is not defined.
// @param callback a function(tiddler,fieldName,value).
TiddlyWiki.prototype.forEachField = function(tiddler,callback,onlyExtendedFields)
{
	var t = this.resolveTiddler(tiddler);
	if(!t)
		return undefined;
	var n,result;
	for(n in t.fields) {
		result = callback(t,n,t.fields[n]);
		if(result)
			return result;
		}
	if(onlyExtendedFields)
		return undefined;
	for(n in TiddlyWiki.standardFieldAccess) {
		if(n != "tiddler") {
			// even though the "title" field can also be referenced through the name "tiddler"
			// we only visit this field once.
			result = callback(t,n,TiddlyWiki.standardFieldAccess[n].get(t));
			if(result)
				return result;
		}
	}
	return undefined;
};


//--
//-- Story functions
//--

function Story(containerId,idPrefix)
{
	this.container = containerId;
	this.idPrefix = idPrefix;
	this.highlightRegExp = null;
	this.tiddlerId = function(title) {
		title = title.replace(/_/g, "__").replace(/ /g, "_");
		var id = this.idPrefix + title;
		return id==this.container ? this.idPrefix + "_" + title : id;
	};
	this.containerId = function() {
		return this.container;
	};
}

Story.prototype.getTiddler = function(title)
{
	return document.getElementById(this.tiddlerId(title));
};

Story.prototype.getContainer = function()
{
	return document.getElementById(this.containerId());
};

Story.prototype.forEachTiddler = function(fn)
{
	var place = this.getContainer();
	if(!place)
		return;
	var e = place.firstChild;
	while(e) {
		var n = e.nextSibling;
		var title = e.getAttribute("tiddler");
		if(title) {
			fn.call(this,title,e);
		}
		e = n;
	}
};

Story.prototype.displayDefaultTiddlers = function()
{
	this.displayTiddlers(null,store.filterTiddlers(store.getTiddlerText("DefaultTiddlers")));
};

Story.prototype.displayTiddlers = function(srcElement,titles,template,animate,unused,customFields,toggle)
{
	var t;
	for(t = titles.length-1;t>=0;t--)
		this.displayTiddler(srcElement,titles[t],template,animate,unused,customFields);
};

Story.prototype.displayTiddler = function(srcElement,tiddler,template,animate,unused,customFields,toggle,animationSrc)
{
	var title = (tiddler instanceof Tiddler) ? tiddler.title : tiddler;
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(toggle) {
			if(tiddlerElem.getAttribute("dirty") != "true")
				this.closeTiddler(title,true);
		} else {
			this.refreshTiddler(title,template,false,customFields);
		}
	} else {
		var place = this.getContainer();
		var before = this.positionTiddler(srcElement);
		tiddlerElem = this.createTiddler(place,before,title,template,customFields);
	}
	if(animationSrc && typeof animationSrc !== "string") {
		srcElement = animationSrc;
	}
	if(srcElement && typeof srcElement !== "string") {
		if(config.options.chkAnimate && (animate == undefined || animate == true) && anim && typeof Zoomer == "function" && typeof Scroller == "function")
			anim.startAnimating(new Zoomer(title,srcElement,tiddlerElem),new Scroller(tiddlerElem));
		else
			window.scrollTo(0,ensureVisible(tiddlerElem));
	}
	return tiddlerElem;
};

Story.prototype.positionTiddler = function(srcElement)
{
	var place = this.getContainer();
	var before = null;
	if(typeof srcElement == "string") {
		switch(srcElement) {
		case "top":
			before = place.firstChild;
			break;
		case "bottom":
			before = null;
			break;
		}
	} else {
		var after = this.findContainingTiddler(srcElement);
		if(after == null) {
			before = place.firstChild;
		} else if(after.nextSibling) {
			before = after.nextSibling;
			if(before.nodeType != 1)
				before = null;
		}
	}
	return before;
};

Story.prototype.createTiddler = function(place,before,title,template,customFields)
{
	var tiddlerElem = createTiddlyElement(null,"div",this.tiddlerId(title),"tiddler");
	tiddlerElem.setAttribute("refresh","tiddler");
	if(customFields)
		tiddlerElem.setAttribute("tiddlyFields",customFields);
	place.insertBefore(tiddlerElem,before);
	var defaultText = null;
	if(!store.tiddlerExists(title) && !store.isShadowTiddler(title))
		defaultText = this.loadMissingTiddler(title,customFields);
	this.refreshTiddler(title,template,false,customFields,defaultText);
	return tiddlerElem;
};

Story.prototype.loadMissingTiddler = function(title,fields,callback)
{
	var getTiddlerCallback = function(context)
	{
		if(context.status) {
			var t = context.tiddler;
			if(!t.created)
				t.created = new Date();
			if(!t.modified)
				t.modified = t.created;
			var dirty = store.isDirty();
			context.tiddler = store.saveTiddler(t.title,t.title,t.text,t.modifier,t.modified,t.tags,t.fields,true,t.created,t.creator);
			if(!window.allowSave())
				store.setDirty(dirty);
			autoSaveChanges();
		} else {
			story.refreshTiddler(context.title,null,true);
		}
		context.adaptor.close();
		if(callback) {
			callback(context);
		}
	};
	var tiddler = new Tiddler(title);
	tiddler.fields = typeof fields == "string" ? fields.decodeHashMap() : fields||{};
	var context = {serverType:tiddler.getServerType()};
	if(!context.serverType)
		return "";
	context.host = tiddler.fields['server.host'];
	context.workspace = tiddler.fields['server.workspace'];
	var adaptor = new config.adaptors[context.serverType]();
	adaptor.getTiddler(title,context,null,getTiddlerCallback);
	return config.messages.loadingMissingTiddler.format([title,context.serverType,context.host,context.workspace]);
};

Story.prototype.chooseTemplateForTiddler = function(title,template)
{
	if(!template)
		template = DEFAULT_VIEW_TEMPLATE;
	if(template == DEFAULT_VIEW_TEMPLATE || template == DEFAULT_EDIT_TEMPLATE)
		template = config.tiddlerTemplates[template];
	return template;
};

Story.prototype.getTemplateForTiddler = function(title,template,tiddler)
{
	return store.getRecursiveTiddlerText(template,null,10);
};

Story.prototype.refreshTiddler = function(title,template,force,customFields,defaultText)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		if(tiddlerElem.getAttribute("dirty") == "true" && !force)
			return tiddlerElem;
		template = this.chooseTemplateForTiddler(title,template);
		var currTemplate = tiddlerElem.getAttribute("template");
		if((template != currTemplate) || force) {
			var tiddler = store.getTiddler(title);
			if(!tiddler) {
				tiddler = new Tiddler();
				if(store.isShadowTiddler(title)) {
					var tags = [];
					tiddler.set(title,store.getTiddlerText(title),config.views.wikified.shadowModifier,version.date,tags,version.date);
				} else {
					var text = template=="EditTemplate" ?
								config.views.editor.defaultText.format([title]) :
								config.views.wikified.defaultText.format([title]);
					text = defaultText || text;
					var fields = customFields ? customFields.decodeHashMap() : null;
					tiddler.set(title,text,config.views.wikified.defaultModifier,version.date,[],version.date,fields);
				}
			}
			tiddlerElem.setAttribute("tags",tiddler.tags.join(" "));
			tiddlerElem.setAttribute("tiddler",title);
			tiddlerElem.setAttribute("template",template);
			tiddlerElem.onmouseover = this.onTiddlerMouseOver;
			tiddlerElem.onmouseout = this.onTiddlerMouseOut;
			tiddlerElem.ondblclick = this.onTiddlerDblClick;
			tiddlerElem[window.event?"onkeydown":"onkeypress"] = this.onTiddlerKeyPress;
			tiddlerElem.innerHTML = this.getTemplateForTiddler(title,template,tiddler);
			applyHtmlMacros(tiddlerElem,tiddler);
			if(store.getTaggedTiddlers(title).length > 0)
				jQuery(tiddlerElem).addClass("isTag");
			else
				jQuery(tiddlerElem).removeClass("isTag");
			if(store.tiddlerExists(title)) {
				jQuery(tiddlerElem).removeClass("shadow");
				jQuery(tiddlerElem).removeClass("missing");
			} else {
				jQuery(tiddlerElem).addClass(store.isShadowTiddler(title) ? "shadow" : "missing");
			}
			if(customFields)
				this.addCustomFields(tiddlerElem,customFields);
		}
	}
	return tiddlerElem;
};

Story.prototype.addCustomFields = function(place,customFields)
{
	var fields = customFields.decodeHashMap();
	var w = createTiddlyElement(place,"div",null,"customFields");
	w.style.display = "none";
	var t;
	for(t in fields) {
		var e = document.createElement("input");
		e.setAttribute("type","text");
		e.setAttribute("value",fields[t]);
		w.appendChild(e);
		e.setAttribute("edit",t);
	}
};

Story.prototype.refreshAllTiddlers = function(force)
{
	var e = this.getContainer().firstChild;
	while(e) {
		var template = e.getAttribute("template");
		if(template && e.getAttribute("dirty") != "true") {
			this.refreshTiddler(e.getAttribute("tiddler"),force ? null : template,true);
		}
		e = e.nextSibling;
	}
};

Story.prototype.onTiddlerMouseOver = function(e)
{
	jQuery(this).addClass("selected");
};

Story.prototype.onTiddlerMouseOut = function(e)
{
	jQuery(this).removeClass("selected");
};

Story.prototype.onTiddlerDblClick = function(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	if(target && target.nodeName.toLowerCase() != "input" && target.nodeName.toLowerCase() != "textarea") {
		if(document.selection && document.selection.empty)
			document.selection.empty();
		config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
		e.cancelBubble = true;
		if(e.stopPropagation) e.stopPropagation();
		return true;
	}
	return false;
};

Story.prototype.onTiddlerKeyPress = function(ev)
{
	var e = ev || window.event;
	clearMessage();
	var consume = false;
	var title = this.getAttribute("tiddler");
	var target = resolveTarget(e);
	switch(e.keyCode) {
	case 9: // Tab
		var ed = story.getTiddlerField(title,"text");
		if(target.tagName.toLowerCase() == "input" && ed.value==config.views.editor.defaultText.format([title])) {
			// moving from input field and editor still contains default text, so select it
			ed.focus();
			ed.select();
			consume = true;
		}
		if(config.options.chkInsertTabs && target.tagName.toLowerCase() == "textarea") {
			replaceSelection(target,String.fromCharCode(9));
			consume = true;
		}
		if(config.isOpera) {
			target.onblur = function() {
				this.focus();
				this.onblur = null;
			};
		}
		break;
	case 13: // Ctrl-Enter
	case 10: // Ctrl-Enter on IE PC
	case 77: // Ctrl-Enter is "M" on some platforms
		if(e.ctrlKey) {
			blurElement(this);
			config.macros.toolbar.invokeCommand(this,"defaultCommand",e);
			consume = true;
		}
		break;
	case 27: // Escape
		blurElement(this);
		config.macros.toolbar.invokeCommand(this,"cancelCommand",e);
		consume = true;
		break;
	}
	e.cancelBubble = consume;
	if(consume) {
		if(e.stopPropagation) e.stopPropagation(); // Stop Propagation
		e.returnValue = true; // Cancel The Event in IE
		if(e.preventDefault ) e.preventDefault(); // Cancel The Event in Moz
	}
	return !consume;
};

Story.prototype.getTiddlerField = function(title,field)
{
	var tiddlerElem = this.getTiddler(title);
	var e = null;
	if(tiddlerElem) {
		var t,children = tiddlerElem.getElementsByTagName("*");
		for(t=0; t<children.length; t++) {
			var c = children[t];
			if(c.tagName.toLowerCase() == "input" || c.tagName.toLowerCase() == "textarea") {
				if(!e)
					e = c;
				if(c.getAttribute("edit") == field)
					e = c;
			}
		}
	}
	return e;
};

Story.prototype.focusTiddler = function(title,field)
{
	var e = this.getTiddlerField(title,field);
	if(e) {
		e.focus();
		e.select();
	}
};

Story.prototype.blurTiddler = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem && tiddlerElem.focus && tiddlerElem.blur) {
		tiddlerElem.focus();
		tiddlerElem.blur();
	}
};

Story.prototype.setTiddlerField = function(title,tag,mode,field)
{
	var c = this.getTiddlerField(title,field);
	var tags = c.value.readBracketedList();
	tags.setItem(tag,mode);
	c.value = String.encodeTiddlyLinkList(tags);
};

Story.prototype.setTiddlerTag = function(title,tag,mode)
{
	this.setTiddlerField(title,tag,mode,"tags");
};

Story.prototype.closeTiddler = function(title,animate,unused)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		clearMessage();
		this.scrubTiddler(tiddlerElem);
		if(config.options.chkAnimate && animate && anim && typeof Slider == "function")
			anim.startAnimating(new Slider(tiddlerElem,false,null,"all"));
		else {
			jQuery(tiddlerElem).remove();
		}
	}
};

Story.prototype.scrubTiddler = function(tiddlerElem)
{
	tiddlerElem.id = null;
};

Story.prototype.setDirty = function(title,dirty)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		tiddlerElem.setAttribute("dirty",dirty ? "true" : "false");
};

Story.prototype.isDirty = function(title)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem)
		return tiddlerElem.getAttribute("dirty") == "true";
	return null;
};

Story.prototype.areAnyDirty = function()
{
	var r = false;
	this.forEachTiddler(function(title,element) {
		if(this.isDirty(title))
			r = true;
	});
	return r;
};

Story.prototype.closeAllTiddlers = function(exclude)
{
	clearMessage();
	this.forEachTiddler(function(title,element) {
		if((title != exclude) && element.getAttribute("dirty") != "true")
			this.closeTiddler(title);
	});
	window.scrollTo(0,ensureVisible(this.container));
};

Story.prototype.isEmpty = function()
{
	var place = this.getContainer();
	return place && place.firstChild == null;
};

Story.prototype.search = function(text,useCaseSensitive,useRegExp)
{
	this.closeAllTiddlers();
	highlightHack = new RegExp(useRegExp ? text : text.escapeRegExp(),useCaseSensitive ? "mg" : "img");
	var matches = store.search(highlightHack,"title","excludeSearch");
	this.displayTiddlers(null,matches);
	highlightHack = null;
	var q = useRegExp ? "/" : "'";
	if(matches.length > 0)
		displayMessage(config.macros.search.successMsg.format([matches.length.toString(),q + text + q]));
	else
		displayMessage(config.macros.search.failureMsg.format([q + text + q]));
};

Story.prototype.findContainingTiddler = function(e)
{
	while(e && !jQuery(e).hasClass("tiddler")) {
		e = jQuery(e).hasClass("popup") && Popup.stack[0] ? Popup.stack[0].root : e.parentNode;
	}
	return e;
};

Story.prototype.gatherSaveFields = function(e,fields)
{
	if(e && e.getAttribute) {
		var f = e.getAttribute("edit");
		if(f)
			fields[f] = e.value.replace(/\r/mg,"");
		if(e.hasChildNodes()) {
			var t,c = e.childNodes;
			for(t=0; t<c.length; t++)
				this.gatherSaveFields(c[t],fields);
		}
	}
};

Story.prototype.hasChanges = function(title)
{
	var e = this.getTiddler(title);
	if(e) {
		var fields = {};
		this.gatherSaveFields(e,fields);
		if(store.fetchTiddler(title)) {
		    var n;
			for(n in fields) {
				if(store.getValue(title,n) != fields[n]) //# tiddler changed
					return true;
			}
		} else {
			if(store.isShadowTiddler(title) && store.getShadowTiddlerText(title) == fields.text) { //# not checking for title or tags
				return false;
			} else { //# changed shadow or new tiddler
				return true;
			}
		}
	}
	return false;
};

Story.prototype.saveTiddler = function(title,minorUpdate)
{
	var tiddlerElem = this.getTiddler(title);
	if(tiddlerElem) {
		var fields = {};
		this.gatherSaveFields(tiddlerElem,fields);
		var newTitle = fields.title || title;
		if(!store.tiddlerExists(newTitle)) {
			newTitle = newTitle.trim();
			var creator = config.options.txtUserName;
		}
		if(store.tiddlerExists(newTitle) && newTitle != title) {
			if(!confirm(config.messages.overwriteWarning.format([newTitle.toString()])))
				return null;
				title = newTitle;
		}
		if(newTitle != title)
			this.closeTiddler(newTitle,false);
		tiddlerElem.id = this.tiddlerId(newTitle);
		tiddlerElem.setAttribute("tiddler",newTitle);
		tiddlerElem.setAttribute("template",DEFAULT_VIEW_TEMPLATE);
		tiddlerElem.setAttribute("dirty","false");
		if(config.options.chkForceMinorUpdate)
			minorUpdate = !minorUpdate;
		if(!store.tiddlerExists(newTitle))
			minorUpdate = false;
		var newDate = new Date();
		if(store.tiddlerExists(title)) {
			var t = store.fetchTiddler(title);
			var extendedFields = t.fields;
			creator = t.creator;
		} else {
			extendedFields = merge({},config.defaultCustomFields);
		}
		var n;
		for(n in fields) {
			if(!TiddlyWiki.isStandardField(n))
				extendedFields[n] = fields[n];
		}
		var tiddler = store.saveTiddler(title,newTitle,fields.text,minorUpdate ? undefined : config.options.txtUserName,minorUpdate ? undefined : newDate,fields.tags,extendedFields,null,null,creator);
		autoSaveChanges(null,[tiddler]);
		return newTitle;
	}
	return null;
};

Story.prototype.permaView = function()
{
	var links = [];
	this.forEachTiddler(function(title,element) {
		links.push(String.encodeTiddlyLink(title));
	});
	var t = encodeURIComponent(links.join(" "));
	if(t == "")
		t = "#";
	if(window.location.hash != t)
		window.location.hash = t;
};

Story.prototype.switchTheme = function(theme)
{
	if(safeMode)
		return;

	var getSlice = function(theme,slice) {
		var r;
		if(readOnly)
			r = store.getTiddlerSlice(theme,slice+"ReadOnly") || store.getTiddlerSlice(theme,"Web"+slice);
		r = r || store.getTiddlerSlice(theme,slice);
		if(r && r.indexOf(config.textPrimitives.sectionSeparator)==0)
			r = theme + r;
		return store.isAvailable(r) ? r : slice;
	};

	var replaceNotification = function(i,name,theme,slice) {
		var newName = getSlice(theme,slice);
		if(name!=newName && store.namedNotifications[i].name==name) {
			store.namedNotifications[i].name = newName;
			return newName;
		}
		return name;
	};

	var pt = config.refresherData.pageTemplate;
	var vi = DEFAULT_VIEW_TEMPLATE;
	var vt = config.tiddlerTemplates[vi];
	var ei = DEFAULT_EDIT_TEMPLATE;
	var et = config.tiddlerTemplates[ei];

	var i;
	for(i=0; i<config.notifyTiddlers.length; i++) {
		var name = config.notifyTiddlers[i].name;
		switch(name) {
		case "PageTemplate":
			config.refresherData.pageTemplate = replaceNotification(i,config.refresherData.pageTemplate,theme,name);
			break;
		case "StyleSheet":
			removeStyleSheet(config.refresherData.styleSheet);
			config.refresherData.styleSheet = replaceNotification(i,config.refresherData.styleSheet,theme,name);
			break;
		case "ColorPalette":
			config.refresherData.colorPalette = replaceNotification(i,config.refresherData.colorPalette,theme,name);
			break;
		default:
			break;
		}
	}
	config.tiddlerTemplates[vi] = getSlice(theme,"ViewTemplate");
	config.tiddlerTemplates[ei] = getSlice(theme,"EditTemplate");
	if(!startingUp) {
		if(config.refresherData.pageTemplate!=pt || config.tiddlerTemplates[vi]!=vt || config.tiddlerTemplates[ei]!=et) {
			refreshAll();
			this.refreshAllTiddlers(true);
		} else {
			setStylesheet(store.getRecursiveTiddlerText(config.refresherData.styleSheet,"",10),config.refreshers.styleSheet);
		}
		config.options.txtTheme = theme;
		saveOption("txtTheme");
	}
};


//--
//-- Backstage
//--
// Backstage tasks
config.tasks.save.action = saveChanges;

var backstage = {
	area: null,
	toolbar: null,
	button: null,
	showButton: null,
	hideButton: null,
	cloak: null,
	panel: null,
	panelBody: null,
	panelFooter: null,
	currTabName: null,
	currTabElem: null,
	content: null,

	init: function() {
		var cmb = config.messages.backstage;
		this.area = document.getElementById("backstageArea");
		this.toolbar = jQuery("#backstageToolbar").empty()[0];
		this.button = jQuery("#backstageButton").empty()[0];
		this.button.style.display = "block";
		var t = cmb.open.text + " " + glyph("bentArrowLeft");
		this.showButton = createTiddlyButton(this.button,t,cmb.open.tooltip,
						function(e) {backstage.show(); return false;},null,"backstageShow");
		t = glyph("bentArrowRight") + " " + cmb.close.text;
		this.hideButton = createTiddlyButton(this.button,t,cmb.close.tooltip,
						function(e) {backstage.hide(); return false;},null,"backstageHide");
		this.cloak = document.getElementById("backstageCloak");
		this.panel = document.getElementById("backstagePanel");
		this.panelFooter = createTiddlyElement(this.panel,"div",null,"backstagePanelFooter");
		this.panelBody = createTiddlyElement(this.panel,"div",null,"backstagePanelBody");
		this.cloak.onmousedown = function(e) {backstage.switchTab(null);};
		createTiddlyText(this.toolbar,cmb.prompt);
		for(t=0; t<config.backstageTasks.length; t++) {
			var taskName = config.backstageTasks[t];
			var task = config.tasks[taskName];
			var handler = task.action ? this.onClickCommand : this.onClickTab;
			var text = task.text + (task.action ? "" : glyph("downTriangle"));
			var btn = createTiddlyButton(this.toolbar,text,task.tooltip,handler,"backstageTab");
			jQuery(btn).addClass(task.action ? "backstageAction" : "backstageTask");
			btn.setAttribute("task", taskName);
			}
		this.content = document.getElementById("contentWrapper");
		if(config.options.chkBackstage)
			this.show();
		else
			this.hide();
	},

	isVisible: function() {
		return this.area ? this.area.style.display == "block" : false;
	},

	show: function() {
		this.area.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.toolbar.style.left = findWindowWidth() + "px";
			var p = [{style: "left", start: findWindowWidth(), end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p));
		} else {
			backstage.area.style.left = "0px";
		}
		jQuery(this.showButton).hide();
		jQuery(this.hideButton).show();
		config.options.chkBackstage = true;
		saveOption("chkBackstage");
		jQuery(this.content).addClass("backstageVisible");
	},

	hide: function() {
		if(this.currTabElem) {
			this.switchTab(null);
		} else {
			backstage.toolbar.style.left = "0px";
			if(anim && config.options.chkAnimate) {
				var p = [{style: "left", start: 0, end: findWindowWidth(), template: "%0px"}];
				var c = function(element,properties) {backstage.area.style.display = "none";};
				anim.startAnimating(new Morpher(backstage.toolbar,config.animDuration,p,c));
			} else {
				this.area.style.display = "none";
			}
			this.showButton.style.display = "block";
			this.hideButton.style.display = "none";
			config.options.chkBackstage = false;
			saveOption("chkBackstage");
			jQuery(this.content).removeClass("backstageVisible");
		}
	},

	onClickCommand: function(e) {
		var task = config.tasks[this.getAttribute("task")];
		if(task.action) {
			backstage.switchTab(null);
			task.action();
		}
		return false;
	},

	onClickTab: function(e) {
		backstage.switchTab(this.getAttribute("task"));
		return false;
	},

	// Switch to a given tab, or none if null is passed
	switchTab: function(tabName) {
		var tabElem = null;
		var e = this.toolbar.firstChild;
		while(e) {
			if(e.getAttribute && e.getAttribute("task") == tabName)
				tabElem = e;
			e = e.nextSibling;
		}
		if(tabName == backstage.currTabName) {
			backstage.hidePanel();
			return;
		}
		if(backstage.currTabElem) {
			jQuery(this.currTabElem).removeClass("backstageSelTab");
		}
		if(tabElem && tabName) {
			backstage.preparePanel();
			jQuery(tabElem).addClass("backstageSelTab");
			var task = config.tasks[tabName];
			wikify(task.content,backstage.panelBody,null,null);
			backstage.showPanel();
		} else if(backstage.currTabElem) {
			backstage.hidePanel();
		}
		backstage.currTabName = tabName;
		backstage.currTabElem = tabElem;
	},

	isPanelVisible: function() {
		return backstage.panel ? backstage.panel.style.display == "block" : false;
	},

	preparePanel: function() {
		backstage.cloak.style.height = findDocHeight() + "px";
		backstage.cloak.style.display = "block";
		jQuery(backstage.panelBody).empty();
		return backstage.panelBody;
	},

	showPanel: function() {
		backstage.panel.style.display = "block";
		if(anim && config.options.chkAnimate) {
			backstage.panel.style.top = (-backstage.panel.offsetHeight) + "px";
			var p = [{style: "top", start: -backstage.panel.offsetHeight, end: 0, template: "%0px"}];
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p),new Scroller(backstage.panel,false));
		} else {
			backstage.panel.style.top = "0px";
		}
		return backstage.panelBody;
	},

	hidePanel: function() {
		if(backstage.currTabElem)
			jQuery(backstage.currTabElem).removeClass("backstageSelTab");
		backstage.currTabElem = null;
		backstage.currTabName = null;
		if(anim && config.options.chkAnimate) {
			var p = [
				{style: "top", start: 0, end: -(backstage.panel.offsetHeight), template: "%0px"},
				{style: "display", atEnd: "none"}
			];
			var c = function(element,properties) {backstage.cloak.style.display = "none";};
			anim.startAnimating(new Morpher(backstage.panel,config.animDuration,p,c));
		} else {
			jQuery([backstage.panel,backstage.cloak]).hide();
		}
	}
};

config.macros.backstage = {};

config.macros.backstage.handler = function(place,macroName,params)
{
	var backstageTask = config.tasks[params[0]];
	if(backstageTask)
		createTiddlyButton(place,backstageTask.text,backstageTask.tooltip,function(e) {backstage.switchTab(params[0]); return false;});
};


//--
//-- ImportTiddlers macro
//--

config.macros.importTiddlers.handler = function(place,macroName,params,wikifier,paramString,tiddler)
{
	if(readOnly) {
		createTiddlyElement(place,"div",null,"marked",this.readOnlyWarning);
		return;
	}
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	this.restart(w);
};

config.macros.importTiddlers.onCancel = function(e)
{
	var wizard = new Wizard(this);
	wizard.clear();
	config.macros.importTiddlers.restart(wizard);
	return false;
};

config.macros.importTiddlers.onClose = function(e)
{
	backstage.hidePanel();
	return false;
};

config.macros.importTiddlers.restart = function(wizard)
{
	var me = config.macros.importTiddlers;
	wizard.addStep(this.step1Title,this.step1Html);
	var t,s = wizard.getElement("selTypes");
	for(t in config.adaptors) {
		var e = createTiddlyElement(s,"option",null,null,config.adaptors[t].serverLabel || t);
		e.value = t;
	}
	if(config.defaultAdaptor)
		s.value = config.defaultAdaptor;
	s = wizard.getElement("selFeeds");
	var feeds = this.getFeeds();
	for(t in feeds) {
		e = createTiddlyElement(s,"option",null,null,t);
		e.value = t;
	}
	wizard.setValue("feeds",feeds);
	s.onchange = me.onFeedChange;
	var fileInput = wizard.getElement("txtBrowse");
	fileInput.onchange = me.onBrowseChange;
	fileInput.onkeyup = me.onBrowseChange;
	wizard.setButtons([{caption: this.openLabel, tooltip: this.openPrompt, onClick: me.onOpen}]);
	wizard.formElem.action = "javascript:;";
	wizard.formElem.onsubmit = function() {
		if(!this.txtPath || this.txtPath.value.length) //# check for manually entered path in first step
			this.lastChild.firstChild.onclick();
	};
};

config.macros.importTiddlers.getFeeds = function()
{
	var feeds = {};
	var t,tagged = store.getTaggedTiddlers("systemServer","title");
	for(t=0; t<tagged.length; t++) {
		var title = tagged[t].title;
		var serverType = store.getTiddlerSlice(title,"Type");
		if(!serverType)
			serverType = "file";
		feeds[title] = {title: title,
						url: store.getTiddlerSlice(title,"URL"),
						workspace: store.getTiddlerSlice(title,"Workspace"),
						workspaceList: store.getTiddlerSlice(title,"WorkspaceList"),
						tiddlerFilter: store.getTiddlerSlice(title,"TiddlerFilter"),
						serverType: serverType,
						description: store.getTiddlerSlice(title,"Description")};
	}
	return feeds;
};

config.macros.importTiddlers.onFeedChange = function(e)
{
	var wizard = new Wizard(this);
	var selTypes = wizard.getElement("selTypes");
	var fileInput = wizard.getElement("txtPath");
	var feeds = wizard.getValue("feeds");
	var f = feeds[this.value];
	if(f) {
		selTypes.value = f.serverType;
		fileInput.value = f.url;
		wizard.setValue("feedName",f.serverType);
		wizard.setValue("feedHost",f.url);
		wizard.setValue("feedWorkspace",f.workspace);
		wizard.setValue("feedWorkspaceList",f.workspaceList);
		wizard.setValue("feedTiddlerFilter",f.tiddlerFilter);
	}
	return false;
};

config.macros.importTiddlers.onBrowseChange = function(e)
{
	var wizard = new Wizard(this);
	var file = this.value;
	file = file.replace(/^C:\\fakepath\\/i,''); // remove fakepath (chrome/opera/safari)
	if(this.files && this.files[0]) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalFileRead");
			file = this.files[0].fileName; // REQUIRES PRIVILEGES.. NULL otherwise
		} catch (ex) {
			// non-priv fallback: combine filename with path to current document
			var path=getLocalPath(document.location.href);
			var slashpos=path.lastIndexOf('/'); if (slashpos==-1) slashpos=path.lastIndexOf('\\'); 
			if (slashpos!=-1) path=path.substr(0,slashpos+1); // remove filename, leave trailing 	slash
			file=path+file;
		}
	}
	var fileInput = wizard.getElement("txtPath");
	fileInput.value = config.macros.importTiddlers.getURLFromLocalPath(file);
	var serverType = wizard.getElement("selTypes");
	serverType.value = "file";
	return true;
};

config.macros.importTiddlers.getURLFromLocalPath = function(v)
{
	if(!v || !v.length)
		return v;
	v = v.replace(/\\/g,"/"); // use "/" for cross-platform consistency
	var u;
	var t = v.split(":");
	var p = t[1] || t[0]; // remove drive letter (if any)
	if(t[1] && (t[0] == "http" || t[0] == "https" || t[0] == "file")) {
		u = v;
	} else if(p.substr(0,1)=="/") {
		u = document.location.protocol + "//" + document.location.hostname + (t[1] ? "/" : "") + v;
	} else {
		var c = document.location.href.replace(/\\/g,"/");
		var pos = c.lastIndexOf("/");
		if(pos!=-1)
			c = c.substr(0,pos); // remove filename
		u = c + "/" + p;
	}
	return u;
};

config.macros.importTiddlers.onOpen = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var fileInput = wizard.getElement("txtPath");
	var url = fileInput.value;
	var serverType = wizard.getElement("selTypes").value || config.defaultAdaptor;
	var adaptor = new config.adaptors[serverType]();
	wizard.setValue("adaptor",adaptor);
	wizard.setValue("serverType",serverType);
	wizard.setValue("host",url);
	adaptor.openHost(url,null,wizard,me.onOpenHost);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenHost);
	return false;
};

config.macros.importTiddlers.onOpenHost = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	var adaptor = wizard.getValue("adaptor");
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenHost: " + context.statusText);
	adaptor.getWorkspaceList(context,wizard,me.onGetWorkspaceList);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusGetWorkspaceList);
};

config.macros.importTiddlers.onGetWorkspaceList = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onGetWorkspaceList: " + context.statusText);
	wizard.setValue("context",context);
	var workspace = wizard.getValue("feedWorkspace");
	if(!workspace && context.workspaces.length==1)
		workspace = context.workspaces[0].title;
	if(workspace) {
		context.adaptor.openWorkspace(workspace,context,wizard,me.onOpenWorkspace);
		wizard.setValue("workspace",workspace);
		wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenWorkspace);
		return;
	}
	wizard.addStep(me.step2Title,me.step2Html);
	var t,s = wizard.getElement("selWorkspace");
	s.onchange = me.onWorkspaceChange;
	for(t=0; t<context.workspaces.length; t++) {
		var e = createTiddlyElement(s,"option",null,null,context.workspaces[t].title);
		e.value = context.workspaces[t].title;
	}
	var workspaceList = wizard.getValue("feedWorkspaceList");
	if(workspaceList) {
		var n,list = workspaceList.parseParams("workspace",null,false,true);
		for(n=1; n<list.length; n++) {
			if(context.workspaces.findByField("title",list[n].value) == null) {
				e = createTiddlyElement(s,"option",null,null,list[n].value);
				e.value = list[n].value;
			}
		}
	}
	if(workspace) {
		t = wizard.getElement("txtWorkspace");
		t.value = workspace;
	}
	wizard.setButtons([{caption: me.openLabel, tooltip: me.openPrompt, onClick: me.onChooseWorkspace}]);
};

config.macros.importTiddlers.onWorkspaceChange = function(e)
{
	var wizard = new Wizard(this);
	var t = wizard.getElement("txtWorkspace");
	t.value = this.value;
	this.selectedIndex = 0;
	return false;
};

config.macros.importTiddlers.onChooseWorkspace = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	var adaptor = wizard.getValue("adaptor");
	var workspace = wizard.getElement("txtWorkspace").value;
	wizard.setValue("workspace",workspace);
	var context = wizard.getValue("context");
	adaptor.openWorkspace(workspace,context,wizard,me.onOpenWorkspace);
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusOpenWorkspace);
	return false;
};

config.macros.importTiddlers.onOpenWorkspace = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true)
		displayMessage("Error in importTiddlers.onOpenWorkspace: " + context.statusText);
	var adaptor = wizard.getValue("adaptor");
	adaptor.getTiddlerList(context,wizard,me.onGetTiddlerList,wizard.getValue("feedTiddlerFilter"));
	wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],me.statusGetTiddlerList);
};

config.macros.importTiddlers.onGetTiddlerList = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(context.status !== true) {
		var error = context.statusText||me.errorGettingTiddlerList;
		if(context.host.indexOf("file://") === 0) {
			error = me.errorGettingTiddlerListFile;
		} else {
			error = context.xhr && context.xhr.status == 404 ? me.errorGettingTiddlerListHttp404 :
				me.errorGettingTiddlerListHttp;
		}
		wizard.setButtons([{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}],"");
		jQuery("span.status", wizard.footerEl).html(error); // so error message can be html
		return;
	}
	// Extract data for the listview
	var listedTiddlers = [];
	if(context.tiddlers) {
		var n;
		for(n=0; n<context.tiddlers.length; n++) {
			var tiddler = context.tiddlers[n];
			listedTiddlers.push({
				title: tiddler.title,
				modified: tiddler.modified,
				modifier: tiddler.modifier,
				text: tiddler.text ? wikifyPlainText(tiddler.text,100) : "",
				tags: tiddler.tags,
				size: tiddler.text ? tiddler.text.length : 0,
				tiddler: tiddler
			});
		}
	}
	listedTiddlers.sort(function(a,b) {return a.title < b.title ? -1 : (a.title == b.title ? 0 : +1);});
	// Display the listview
	wizard.addStep(me.step3Title,me.step3Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	var listView = ListView.create(listWrapper,listedTiddlers,me.listViewTemplate);
	wizard.setValue("listView",listView);
	wizard.setValue("context",context);
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler");
	txtSaveTiddler.value = me.generateSystemServerName(wizard);
	wizard.setButtons([
			{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel},
			{caption: me.importLabel, tooltip: me.importPrompt, onClick: me.doImport}
		]);
};

config.macros.importTiddlers.generateSystemServerName = function(wizard)
{
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var pattern = config.macros.importTiddlers[workspace ? "systemServerNamePattern" : "systemServerNamePatternNoWorkspace"];
	return pattern.format([serverType,host,workspace]);
};

config.macros.importTiddlers.saveServerTiddler = function(wizard)
{
	var me = config.macros.importTiddlers;
	var txtSaveTiddler = wizard.getElement("txtSaveTiddler").value;
	if(store.tiddlerExists(txtSaveTiddler)) {
		if(!confirm(me.confirmOverwriteSaveTiddler.format([txtSaveTiddler])))
			return;
		store.suspendNotifications();
		store.removeTiddler(txtSaveTiddler);
		store.resumeNotifications();
	}
	var serverType = wizard.getValue("serverType");
	var host = wizard.getValue("host");
	var workspace = wizard.getValue("workspace");
	var text = me.serverSaveTemplate.format([serverType,host,workspace]);
	store.saveTiddler(txtSaveTiddler,txtSaveTiddler,text,me.serverSaveModifier,new Date(),["systemServer"]);
};

config.macros.importTiddlers.doImport = function(e)
{
	var me = config.macros.importTiddlers;
	var wizard = new Wizard(this);
	if(wizard.getElement("chkSave").checked)
		me.saveServerTiddler(wizard);
	var chkSync = wizard.getElement("chkSync").checked;
	wizard.setValue("sync",chkSync);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	var adaptor = wizard.getValue("adaptor");
	var overwrite = [];
	var t;
	for(t=0; t<rowNames.length; t++) {
		if(store.tiddlerExists(rowNames[t]))
			overwrite.push(rowNames[t]);
	}
	if(overwrite.length > 0) {
		if(!confirm(me.confirmOverwriteText.format([overwrite.join(", ")])))
			return false;
	}
	wizard.addStep(me.step4Title.format([rowNames.length]),me.step4Html);
	for(t=0; t<rowNames.length; t++) {
		var link = document.createElement("div");
		createTiddlyLink(link,rowNames[t],true);
		var place = wizard.getElement("markReport");
		place.parentNode.insertBefore(link,place);
	}
	wizard.setValue("remainingImports",rowNames.length);
	wizard.setButtons([
			{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}
		],me.statusDoingImport);
	var wizardContext = wizard.getValue("context");
	var tiddlers = wizardContext ? wizardContext.tiddlers : [];
	for(t=0; t<rowNames.length; t++) {
		var context = {
			allowSynchronous:true,
			tiddler:tiddlers[tiddlers.findByField("title",rowNames[t])]
		};
		adaptor.getTiddler(rowNames[t],context,wizard,me.onGetTiddler);
	}
	return false;
};

config.macros.importTiddlers.onGetTiddler = function(context,wizard)
{
	var me = config.macros.importTiddlers;
	if(!context.status)
		displayMessage("Error in importTiddlers.onGetTiddler: " + context.statusText);
	var tiddler = context.tiddler;
	store.suspendNotifications();
	store.saveTiddler(tiddler.title, tiddler.title, tiddler.text, tiddler.modifier, tiddler.modified, tiddler.tags, tiddler.fields, true, tiddler.created);
	if(!wizard.getValue("sync")) {
		store.setValue(tiddler.title,'server',null);
	}
	store.resumeNotifications();
	if(!context.isSynchronous)
		store.notify(tiddler.title,true);
	var remainingImports = wizard.getValue("remainingImports")-1;
	wizard.setValue("remainingImports",remainingImports);
	if(remainingImports == 0) {
		if(context.isSynchronous) {
			store.notifyAll();
			refreshDisplay();
		}
		wizard.setButtons([
				{caption: me.doneLabel, tooltip: me.donePrompt, onClick: me.onClose}
			],me.statusDoneImport);
		autoSaveChanges();
	}
};


//--
//-- Upgrade macro
//--

config.macros.upgrade.handler = function(place)
{
	var w = new Wizard();
	w.createWizard(place,this.wizardTitle);
	w.addStep(this.step1Title,this.step1Html.format([this.source,this.source]));
	w.setButtons([{caption: this.upgradeLabel, tooltip: this.upgradePrompt, onClick: this.onClickUpgrade}]);
};

config.macros.upgrade.onClickUpgrade = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	if(!window.allowSave()) {
		alert(me.errorCantUpgrade);
		return false;
	}
	if(story.areAnyDirty() || store.isDirty()) {
		alert(me.errorNotSaved);
		return false;
	}
	var localPath = getLocalPath(document.location.toString());
	var backupPath = getBackupPath(localPath,me.backupExtension);
	w.setValue("backupPath",backupPath);
	w.setButtons([],me.statusPreparingBackup);
	var original = loadOriginal(localPath);
	w.setButtons([],me.statusSavingBackup);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(!backup) {
		w.setButtons([],me.errorSavingBackup);
		alert(me.errorSavingBackup);
		return false;
	}
	w.setButtons([],me.statusLoadingCore);
	var options = {
		type:"GET",
		url:me.source,
		processData:false,
		success:function(data,textStatus,jqXHR) {
			me.onLoadCore(true,w,jqXHR.responseText,me.source,jqXHR);
		},
		error:function(jqXHR,textStatus,errorThrown) {
			me.onLoadCore(false,w,null,me.source,jqXHR);
		}
	};
	ajaxReq(options);
	return false;
};

config.macros.upgrade.onLoadCore = function(status,params,responseText,url,xhr)
{
	var me = config.macros.upgrade;
	var w = params;
	var errMsg;
	if(!status)
		errMsg = me.errorLoadingCore;
	var newVer = me.extractVersion(responseText);
	if(!newVer)
		errMsg = me.errorCoreFormat;
	if(errMsg) {
		w.setButtons([],errMsg);
		alert(errMsg);
		return;
	}
	var onStartUpgrade = function(e) {
		w.setButtons([],me.statusSavingCore);
		var localPath = getLocalPath(document.location.toString());
		saveFile(localPath,responseText);
		w.setButtons([],me.statusReloadingCore);
		var backupPath = w.getValue("backupPath");
		var newLoc = document.location.toString() + "?time=" + new Date().convertToYYYYMMDDHHMM() + "#upgrade:[[" + encodeURI(backupPath) + "]]";
		window.setTimeout(function () {window.location = newLoc;},10);
	};
	var step2 = [me.step2Html_downgrade,me.step2Html_restore,me.step2Html_upgrade][compareVersions(version,newVer) + 1];
	w.addStep(me.step2Title,step2.format([formatVersion(newVer),formatVersion(version)]));
	w.setButtons([{caption: me.startLabel, tooltip: me.startPrompt, onClick: onStartUpgrade},{caption: me.cancelLabel, tooltip: me.cancelPrompt, onClick: me.onCancel}]);
};

config.macros.upgrade.onCancel = function(e)
{
	var me = config.macros.upgrade;
	var w = new Wizard(this);
	w.addStep(me.step3Title,me.step3Html);
	w.setButtons([]);
	return false;
};

config.macros.upgrade.extractVersion = function(upgradeFile)
{
	var re = /^var version = \{title: "([^"]+)", major: (\d+), minor: (\d+), revision: (\d+)(, beta: (\d+)){0,1}, date: new Date\("([^"]+)"\)/mg;
	var m = re.exec(upgradeFile);
	return m ? {title: m[1], major: m[2], minor: m[3], revision: m[4], beta: m[6], date: new Date(m[7])} : null;
};

function upgradeFrom(path)
{
	var importStore = new TiddlyWiki();
	var tw = loadFile(path);
	if(window.netscape !== undefined)
		tw = convertUTF8ToUnicode(tw);
	importStore.importTiddlyWiki(tw);
	importStore.forEachTiddler(function(title,tiddler) {
		if(!store.getTiddler(title)) {
			store.addTiddler(tiddler);
		}
	});
	refreshDisplay();
	saveChanges(); //# To create appropriate Markup* sections
	alert(config.messages.upgradeDone.format([formatVersion()]));
	window.location = window.location.toString().substr(0,window.location.toString().lastIndexOf("?"));
}


//--
//-- Manager UI for groups of tiddlers
//--

config.macros.plugins.handler = function(place,macroName,params,wikifier,paramString)
{
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement("markList");
	var listWrapper = document.createElement("div");
	markList.parentNode.insertBefore(listWrapper,markList);
	listWrapper.setAttribute("refresh","macro");
	listWrapper.setAttribute("macroName","plugins");
	listWrapper.setAttribute("params",paramString);
	this.refresh(listWrapper,paramString);
};

config.macros.plugins.refresh = function(listWrapper,params)
{
	var me = config.macros.plugins;
	var wizard = new Wizard(listWrapper);
	var selectedRows = [];
	ListView.forEachSelector(listWrapper,function(e,rowName) {
			if(e.checked)
				selectedRows.push(e.getAttribute("rowName"));
		});
	jQuery(listWrapper).empty();
	params = params.parseParams("anon");
	var plugins = installedPlugins.slice(0);
	var t,tiddler,p;
	var configTiddlers = store.getTaggedTiddlers("systemConfig");
	for(t=0; t<configTiddlers.length; t++) {
		tiddler = configTiddlers[t];
		if(plugins.findByField("title",tiddler.title) == null) {
			p = getPluginInfo(tiddler);
			p.executed = false;
			p.log.splice(0,0,this.skippedText);
			plugins.push(p);
		}
	}
	for(t=0; t<plugins.length; t++) {
		p = plugins[t];
		p.size = p.tiddler.text ? p.tiddler.text.length : 0;
		p.forced = p.tiddler.isTagged("systemConfigForce");
		p.disabled = p.tiddler.isTagged("systemConfigDisable");
		p.Selected = selectedRows.indexOf(plugins[t].title) != -1;
	}
	if(plugins.length == 0) {
		createTiddlyElement(listWrapper,"em",null,null,this.noPluginText);
		wizard.setButtons([]);
	} else {
		var template = readOnly ? this.listViewTemplateReadOnly : this.listViewTemplate;
		var listView = ListView.create(listWrapper,plugins,template,this.onSelectCommand);
		wizard.setValue("listView",listView);
		if(!readOnly) {
			wizard.setButtons([
				{caption: me.removeLabel, tooltip: me.removePrompt, onClick: me.doRemoveTag},
				{caption: me.deleteLabel, tooltip: me.deletePrompt, onClick: me.doDelete}
			]);
		}
	}
};

config.macros.plugins.doRemoveTag = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		var t;
		for(t=0; t<rowNames.length; t++) {
			store.setTiddlerTag(rowNames[t],false,"systemConfig");
		}
		autoSaveChanges();
	}
};

config.macros.plugins.doDelete = function(e)
{
	var wizard = new Wizard(this);
	var listView = wizard.getValue("listView");
	var rowNames = ListView.getSelectedRows(listView);
	if(rowNames.length == 0) {
		alert(config.messages.nothingSelected);
	} else {
		if(confirm(config.macros.plugins.confirmDeleteText.format([rowNames.join(", ")]))) {
			var t;
			for(t=0; t<rowNames.length; t++) {
				store.removeTiddler(rowNames[t]);
				story.closeTiddler(rowNames[t],true);
			}
		}
		autoSaveChanges();
	}
};


//--
//-- Message area
//--

function getMessageDiv()
{
	var msgArea = document.getElementById("messageArea");
	if(!msgArea)
		return null;
	if(!msgArea.hasChildNodes())
		createTiddlyButton(createTiddlyElement(msgArea,"div",null,"messageToolbar"),
			config.messages.messageClose.text,
			config.messages.messageClose.tooltip,
			clearMessage);
	msgArea.style.display = "block";
	return createTiddlyElement(msgArea,"div");
}

function displayMessage(text,linkText)
{
	var e = getMessageDiv();
	if(!e) {
		alert(text);
		return;
	}
	if(linkText) {
		var link = createTiddlyElement(e,"a",null,null,text);
		link.href = linkText;
		link.target = "_blank";
	} else {
		e.appendChild(document.createTextNode(text));
	}
}

function clearMessage()
{
	var msgArea = document.getElementById("messageArea");
	if(msgArea) {
		jQuery(msgArea).empty();
		msgArea.style.display = "none";
	}
	return false;
}


//--
//-- Refresh mechanism
//--

config.notifyTiddlers = [
	{name: "SystemSettings", notify: onSystemSettingsChange},
	{name: "StyleSheetLayout", notify: refreshStyles},
	{name: "StyleSheetColors", notify: refreshStyles},
	{name: "StyleSheet", notify: refreshStyles},
	{name: "StyleSheetPrint", notify: refreshStyles},
	{name: "PageTemplate", notify: refreshPageTemplate},
	{name: "SiteTitle", notify: refreshPageTitle},
	{name: "SiteSubtitle", notify: refreshPageTitle},
	{name: "WindowTitle", notify: refreshPageTitle},
	{name: "ColorPalette", notify: refreshColorPalette},
	{name: null, notify: refreshDisplay}
];

config.refreshers = {
	link: function(e,changeList)
		{
		var title = e.getAttribute("tiddlyLink");
		refreshTiddlyLink(e,title);
		return true;
		},

	tiddler: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var template = e.getAttribute("template");
		if(changeList && (changeList.indexOf && changeList.indexOf(title) != -1) && !story.isDirty(title))
			story.refreshTiddler(title,template,true);
		else
			refreshElements(e,changeList);
		return true;
		},

	content: function(e,changeList)
		{
		var title = e.getAttribute("tiddler");
		var force = e.getAttribute("force");
		var args = e.getAttribute("args");
		if(force != null || changeList == null || (changeList.indexOf && changeList.indexOf(title) != -1)) {
			jQuery(e).empty();
			config.macros.tiddler.transclude(e,title,args);
			return true;
		} else
			return false;
		},

	macro: function(e,changeList)
		{
		var macro = e.getAttribute("macroName");
		var params = e.getAttribute("params");
		if(macro)
			macro = config.macros[macro];
		if(macro && macro.refresh)
			macro.refresh(e,params);
		return true;
		}
};

config.refresherData = {
	styleSheet: "StyleSheet",
	defaultStyleSheet: "StyleSheet",
	pageTemplate: "PageTemplate",
	defaultPageTemplate: "PageTemplate",
	colorPalette: "ColorPalette",
	defaultColorPalette: "ColorPalette"
};

function refreshElements(root,changeList)
{
	var c,nodes = root.childNodes;
	for(c=0; c<nodes.length; c++) {
		var e = nodes[c], type = null;
		if(e.getAttribute && (e.tagName ? e.tagName != "IFRAME" : true))
			type = e.getAttribute("refresh");
		var refresher = config.refreshers[type];
		var refreshed = false;
		if(refresher != undefined)
			refreshed = refresher(e,changeList);
		if(e.hasChildNodes() && !refreshed)
			refreshElements(e,changeList);
	}
}

function applyHtmlMacros(root,tiddler)
{
	var e = root.firstChild;
	while(e) {
		var nextChild = e.nextSibling;
		if(e.getAttribute) {
			var macro = e.getAttribute("macro");
			if(macro) {
				e.removeAttribute("macro");
				var params = "";
				var p = macro.indexOf(" ");
				if(p != -1) {
					params = macro.substr(p+1);
					macro = macro.substr(0,p);
				}
				invokeMacro(e,macro,params,null,tiddler);
			}
		}
		if(e.hasChildNodes())
			applyHtmlMacros(e,tiddler);
		e = nextChild;
	}
}

function refreshPageTemplate(title)
{
	var stash = jQuery("<div/>").appendTo("body").hide()[0];
	var display = story.getContainer();
	var nodes,t;
	if(display) {
		nodes = display.childNodes;
		for(t=nodes.length-1; t>=0; t--)
			stash.appendChild(nodes[t]);
	}
	var wrapper = document.getElementById("contentWrapper");

	if(!title || !store.isAvailable(title))
		title = config.refresherData.pageTemplate;
	if(!store.isAvailable(title))
		title = config.refresherData.defaultPageTemplate; //# this one is always avaialable
	wrapper.innerHTML = store.getRecursiveTiddlerText(title,null,10);
	applyHtmlMacros(wrapper);
	refreshElements(wrapper);
	display = story.getContainer();
	jQuery(display).empty();
	if(!display)
		display = createTiddlyElement(wrapper,"div",story.containerId());
	nodes = stash.childNodes;
	for(t=nodes.length-1; t>=0; t--)
		display.appendChild(nodes[t]);
	jQuery(stash).remove();
}

function refreshDisplay(hint)
{
	if(typeof hint == "string")
		hint = [hint];
	var e = document.getElementById("contentWrapper");
	refreshElements(e,hint);
	if(backstage.isPanelVisible()) {
		e = document.getElementById("backstage");
		refreshElements(e,hint);
	}
}

function refreshPageTitle()
{
	document.title = getPageTitle();
}

function getPageTitle()
{
	return wikifyPlainText(store.getTiddlerText("WindowTitle",""),null,tiddler);
}

function refreshStyles(title,doc)
{
	setStylesheet(title == null ? "" : store.getRecursiveTiddlerText(title,"",10),title,doc || document);
}

function refreshColorPalette(title)
{
	if(!startingUp)
		refreshAll();
}

function refreshAll()
{
	refreshPageTemplate();
	refreshDisplay();
	refreshStyles("StyleSheetLayout");
	refreshStyles("StyleSheetColors");
	refreshStyles(config.refresherData.styleSheet);
	refreshStyles("StyleSheetPrint");
}


//--
//-- Option handling
//--

config.optionHandlers = {
	'txt': {
		get: function(name) {return encodeCookie(config.options[name].toString());},
		set: function(name,value) {config.options[name] = decodeCookie(value);}
	},
	'chk': {
		get: function(name) {return config.options[name] ? 'true' : 'false';},
		set: function(name,value) {config.options[name] = value == 'true';}
	}
};

function setOption(name,value)
{
	var optType = name.substr(0,3);
	if(config.optionHandlers[optType] && config.optionHandlers[optType].set)
		config.optionHandlers[optType].set(name,value);
}

// Gets the value of an option as a string. Most code should just read from config.options.* directly
function getOption(name)
{
	var optType = name.substr(0,3);
	return config.optionHandlers[optType] && config.optionHandlers[optType].get ? config.optionHandlers[optType].get(name) : null;
}

function loadOptions()
{
	if(safeMode)
		return;
	loadCookies();
	loadSystemSettings();
}
// @Deprecated; retained for backwards compatibility
var loadOptionsCookie = loadOptions;

function getCookies()
{
	var cookieList = document.cookie.split(';');
	var i,cookies = {};
	for(i=0; i<cookieList.length; i++) {
		var p = cookieList[i].indexOf('=');
		if(p != -1) {
			var name = cookieList[i].substr(0,p).trim();
			var value = cookieList[i].substr(p+1).trim();
			cookies[name] = value;
		}
	}
	return cookies;
}

function loadCookies()
{
	var i,cookies = getCookies();
	if(cookies['TiddlyWiki']) {
		cookies = cookies['TiddlyWiki'].decodeHashMap();
	}
	for(i in cookies) {
		if(config.optionsSource[i] != 'setting') {
			setOption(i,cookies[i]);
		}
	}
}

function loadSystemSettings()
{
	var key,settings = store.calcAllSlices('SystemSettings');
	config.optionsSource = {};
	for(key in settings) {
		setOption(key,settings[key]);
		config.optionsSource[key] = 'setting';
	}
}

function onSystemSettingsChange()
{
	if(!startingUp) {
		loadSystemSettings();
	}
}

function saveOption(name)
{
	if(safeMode)
		return;
	if(name.match(/[()\s]/g, '_')) {
		alert(config.messages.invalidCookie.format([name]));
		return;
	}
	saveCookie(name);
	if(config.optionsSource[name] == 'setting') {
		saveSystemSetting(name,true);
	}
}
// @Deprecated; retained for backwards compatibility
var saveOptionCookie = saveOption;

function removeCookie(name)
{
	document.cookie = name + '=; expires=Thu, 01-Jan-1970 00:00:01 UTC; path=/;';
}

function saveCookie(name)
{
	var key,cookies = {};
	for(key in config.options) {
		var value = getOption(key);
		value = value == null ? 'false' : value;
		cookies[key] = value;
	}
	document.cookie = 'TiddlyWiki=' + String.encodeHashMap(cookies) + '; expires=Fri, 1 Jan 2038 12:00:00 UTC; path=/';
	cookies = getCookies();
	var c;
	for(c in cookies) {
		var optType = c.substr(0,3);
		if(config.optionHandlers[optType])
			removeCookie(c);
	}
}

var systemSettingSave;
function commitSystemSettings(storeWasDirty)
{
	if(systemSettingSave) {
		window.clearTimeout(systemSettingSave);
	}
	systemSettingSave = window.setTimeout(function() {
		var tiddler = store.getTiddler('SystemSettings');
		autoSaveChanges(null,[tiddler]);
	}, 1000);
}

function saveSystemSetting(name,saveFile)
{
	var title = 'SystemSettings';
	var slice = store.getTiddlerSlice(title,name);
	if(readOnly || slice === getOption(name)) {
		return; //# don't save if read-only or the option hasn't changed
	}
	var slices = store.calcAllSlices(title);
	var key;
	for(key in config.optionsSource) {
		var value = getOption(key) || '';
		if(slices[key] !== value) {
			slices[key] = value;
		}
	}
	var text = [];
	for(key in slices) {
		text.push('%0: %1'.format([key,slices[key]]));
	}
	text = text.sort().join('\n');
	var storeWasDirty = store.isDirty();
	var tiddler = store.getTiddler(title);
	if(tiddler) {
		tiddler.text = text;
		tiddler = store.saveTiddler(tiddler);
	} else {
		tiddler = store.saveTiddler(title,title,text,'System',new Date(),['excludeLists'],config.defaultCustomFields);
	}
	if(saveFile) {
		commitSystemSettings(storeWasDirty);
	}
}

function encodeCookie(s)
{
	return escape(convertUnicodeToHtmlEntities(s));
}

function decodeCookie(s)
{
	s = unescape(s);
	var re = /&#[0-9]{1,5};/g;
	return s.replace(re,function($0) {return String.fromCharCode(eval($0.replace(/[&#;]/g,'')));});
}

config.macros.option.genericCreate = function(place,type,opt,className,desc)
{
	var typeInfo = config.macros.option.types[type];
	var c = document.createElement(typeInfo.elementType);
	if(typeInfo.typeValue)
		c.setAttribute('type',typeInfo.typeValue);
	c[typeInfo.eventName] = typeInfo.onChange;
	c.setAttribute('option',opt);
	c.className = className || typeInfo.className;
	if(config.optionsDesc[opt])
		c.setAttribute('title',config.optionsDesc[opt]);
	place.appendChild(c);
	if(desc != 'no')
		createTiddlyText(place,config.optionsDesc[opt] || opt);
	c[typeInfo.valueField] = config.options[opt];
	return c;
};

config.macros.option.genericOnChange = function(e)
{
	var opt = this.getAttribute('option');
	if(opt) {
		var optType = opt.substr(0,3);
		var handler = config.macros.option.types[optType];
		if(handler.elementType && handler.valueField)
			config.macros.option.propagateOption(opt,handler.valueField,this[handler.valueField],handler.elementType,this);
	}
	return true;
};

config.macros.option.types = {
	'txt': {
		elementType: 'input',
		valueField: 'value',
		eventName: 'onchange',
		className: 'txtOptionInput',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	},
	'chk': {
		elementType: 'input',
		valueField: 'checked',
		eventName: 'onclick',
		className: 'chkOptionInput',
		typeValue: 'checkbox',
		create: config.macros.option.genericCreate,
		onChange: config.macros.option.genericOnChange
	}
};

config.macros.option.propagateOption = function(opt,valueField,value,elementType,elem)
{
	config.options[opt] = value;
	saveOption(opt);
	var t,nodes = document.getElementsByTagName(elementType);
	for(t=0; t<nodes.length; t++) {
		var optNode = nodes[t].getAttribute('option');
		if(opt == optNode && nodes[t]!=elem)
			nodes[t][valueField] = value;
	}
};

config.macros.option.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams('anon',null,true,false,false);
	var opt = (params[1] && params[1].name == 'anon') ? params[1].value : getParam(params,'name',null);
	var className = (params[2] && params[2].name == 'anon') ? params[2].value : getParam(params,'class',null);
	var desc = getParam(params,'desc','no');
	var type = opt.substr(0,3);
	var h = config.macros.option.types[type];
	if(h && h.create)
		h.create(place,type,opt,className,desc);
};

config.macros.options.handler = function(place,macroName,params,wikifier,paramString)
{
	params = paramString.parseParams('anon',null,true,false,false);
	var showUnknown = getParam(params,'showUnknown','no');
	var wizard = new Wizard();
	wizard.createWizard(place,this.wizardTitle);
	wizard.addStep(this.step1Title,this.step1Html);
	var markList = wizard.getElement('markList');
	var chkUnknown = wizard.getElement('chkUnknown');
	chkUnknown.checked = showUnknown == 'yes';
	chkUnknown.onchange = this.onChangeUnknown;
	var listWrapper = document.createElement('div');
	markList.parentNode.insertBefore(listWrapper,markList);
	wizard.setValue('listWrapper',listWrapper);
	this.refreshOptions(listWrapper,showUnknown == 'yes');
};

config.macros.options.refreshOptions = function(listWrapper,showUnknown)
{
	var n,opts = [];
	for(n in config.options) {
		var opt = {};
		opt.option = '';
		opt.name = n;
		opt.lowlight = !config.optionsDesc[n];
		opt.description = opt.lowlight ? this.unknownDescription : config.optionsDesc[n];
		if(!opt.lowlight || showUnknown)
			opts.push(opt);
	}
	opts.sort(function(a,b) {return a.name.substr(3) < b.name.substr(3) ? -1 : (a.name.substr(3) == b.name.substr(3) ? 0 : +1);});
	ListView.create(listWrapper,opts,this.listViewTemplate);
	for(n=0; n<opts.length; n++) {
		var type = opts[n].name.substr(0,3);
		var h = config.macros.option.types[type];
		if(h && h.create) {
			h.create(opts[n].colElements['option'],type,opts[n].name,null,'no');
		}
	}
};

config.macros.options.onChangeUnknown = function(e)
{
	var wizard = new Wizard(this);
	var listWrapper = wizard.getValue('listWrapper');
	jQuery(listWrapper).empty();
	config.macros.options.refreshOptions(listWrapper,this.checked);
	return false;
};


//--
//-- Saving
//--

var saveUsingSafari = false;

var startSaveArea = '<div id="' + 'storeArea">'; // Split up into two so that indexOf() of this source doesn't find it
var startSaveAreaRE = /<((div)|(DIV)) ((id)|(ID))=["']?storeArea['"]?>/; // Used for IE6
var endSaveArea = '</d' + 'iv>';
var endSaveAreaCaps = '</D' + 'IV>';

// If there are unsaved changes, force the user to confirm before exitting
function confirmExit()
{
	hadConfirmExit = true;
	if((store && store.isDirty && store.isDirty()) || (story && story.areAnyDirty && story.areAnyDirty()))
		return config.messages.confirmExit;
}

// Give the user a chance to save changes before exitting
function checkUnsavedChanges()
{
	if(store && store.isDirty && store.isDirty() && window.hadConfirmExit === false) {
		if(confirm(config.messages.unsavedChangesWarning))
			saveChanges();
	}
}

function updateLanguageAttribute(s)
{
	if(config.locale) {
		var mRE = /(<html(?:.*?)?)(?: xml:lang\="([a-z]+)")?(?: lang\="([a-z]+)")?>/;
		var m = mRE.exec(s);
		if(m) {
			var t = m[1];
			if(m[2])
				t += ' xml:lang="' + config.locale + '"';
			if(m[3])
				t += ' lang="' + config.locale + '"';
			t += ">";
			s = s.substr(0,m.index) + t + s.substr(m.index+m[0].length);
		}
	}
	return s;
}

function updateMarkupBlock(s,blockName,tiddlerName)
{
	return s.replaceChunk(
			"<!--%0-START-->".format([blockName]),
			"<!--%0-END-->".format([blockName]),
			"\n" + convertUnicodeToFileFormat(store.getRecursiveTiddlerText(tiddlerName,"")) + "\n");
}

function updateOriginal(original,posDiv,localPath)
{
	if(!posDiv)
		posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(config.messages.invalidFileError.format([localPath]));
		return null;
	}
	var revised = original.substr(0,posDiv[0] + startSaveArea.length) + "\n" +
				convertUnicodeToFileFormat(store.allTiddlersAsHtml()) + "\n" +
				original.substr(posDiv[1]);
	var newSiteTitle = convertUnicodeToFileFormat(getPageTitle()).htmlEncode();
	revised = revised.replaceChunk("<title"+">","</title"+">"," " + newSiteTitle + " ");
	revised = updateLanguageAttribute(revised);
	revised = updateMarkupBlock(revised,"PRE-HEAD","MarkupPreHead");
	revised = updateMarkupBlock(revised,"POST-HEAD","MarkupPostHead");
	revised = updateMarkupBlock(revised,"PRE-BODY","MarkupPreBody");
	revised = updateMarkupBlock(revised,"POST-SCRIPT","MarkupPostBody");
	return revised;
}

function locateStoreArea(original)
{
	// Locate the storeArea divs
	if(!original)
		return null;
	var posOpeningDiv = original.search(startSaveAreaRE);
	var limitClosingDiv = original.indexOf("<"+"!--POST-STOREAREA--"+">");
	if(limitClosingDiv == -1)
		limitClosingDiv = original.indexOf("<"+"!--POST-BODY-START--"+">");
	var start = limitClosingDiv == -1 ? original.length : limitClosingDiv;
	var posClosingDiv = original.lastIndexOf(endSaveArea,start);
	if(posClosingDiv == -1)
		posClosingDiv = original.lastIndexOf(endSaveAreaCaps,start);
	return (posOpeningDiv != -1 && posClosingDiv != -1) ? [posOpeningDiv,posClosingDiv] : null;
}

function autoSaveChanges(onlyIfDirty,tiddlers)
{
	if(config.options.chkAutoSave)
		saveChanges(onlyIfDirty,tiddlers);
}

function loadOriginal(localPath)
{
	return loadFile(localPath);
}

// Save this tiddlywiki with the pending changes
function saveChanges(onlyIfDirty,tiddlers)
{
	if(onlyIfDirty && !store.isDirty())
		return;
	clearMessage();
	var t0 = new Date();
	var msg = config.messages;
	var originalPath = document.location.toString();
	if(!window.allowSave()) {
		alert(msg.notFileUrlError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var localPath = getLocalPath(originalPath);
	var original = loadOriginal(localPath);
	if(original == null) {
		alert(msg.cantSaveError);
		if(store.tiddlerExists(msg.saveInstructions))
			story.displayTiddler(null,msg.saveInstructions);
		return;
	}
	var posDiv = locateStoreArea(original);
	if(!posDiv) {
		alert(msg.invalidFileError.format([localPath]));
		return;
	}
	saveMain(localPath,original,posDiv);
	if(config.options.chkSaveBackups)
		saveBackup(localPath,original);
	if(config.options.chkSaveEmptyTemplate)
		saveEmpty(localPath,original,posDiv);
	if(config.options.chkGenerateAnRssFeed && saveRss instanceof Function)
		saveRss(localPath);
	if(config.options.chkDisplayInstrumentation)
		displayMessage("saveChanges " + (new Date()-t0) + " ms");
}

function saveMain(localPath,original,posDiv)
{
	var save;
	try {
		var revised = updateOriginal(original,posDiv,localPath);
		save = saveFile(localPath,revised);
	} catch (ex) {
		showException(ex);
	}
	if(save) {
		displayMessage(config.messages.mainSaved,"file://" + localPath);
		store.setDirty(false);
	} else {
		alert(config.messages.mainFailed);
	}
}

function saveBackup(localPath,original)
{
	var backupPath = getBackupPath(localPath);
	var backup = copyFile(backupPath,localPath);
	if(!backup)
		backup = saveFile(backupPath,original);
	if(backup)
		displayMessage(config.messages.backupSaved,"file://" + backupPath);
	else
		alert(config.messages.backupFailed);
}

function saveEmpty(localPath,original,posDiv)
{
	var emptyPath,p;
	if((p = localPath.lastIndexOf("/")) != -1)
		emptyPath = localPath.substr(0,p) + "/";
	else if((p = localPath.lastIndexOf("\\")) != -1)
		emptyPath = localPath.substr(0,p) + "\\";
	else
		emptyPath = localPath + ".";
	emptyPath += "empty.html";
	var empty = original.substr(0,posDiv[0] + startSaveArea.length) + original.substr(posDiv[1]);
	var emptySave = saveFile(emptyPath,empty);
	if(emptySave)
		displayMessage(config.messages.emptySaved,"file://" + emptyPath);
	else
		alert(config.messages.emptyFailed);
}

// Translate URL to local path [Preemption]
window.getLocalPath = window.getLocalPath || function(origPath)
{
	var originalPath = convertUriToUTF8(origPath,config.options.txtFileSystemCharSet);
	// Remove any location or query part of the URL
	var argPos = originalPath.indexOf("?");
	if(argPos != -1)
		originalPath = originalPath.substr(0,argPos);
	var hashPos = originalPath.indexOf("#");
	if(hashPos != -1)
		originalPath = originalPath.substr(0,hashPos);
	// Convert file://localhost/ to file:///
	if(originalPath.indexOf("file://localhost/") == 0)
		originalPath = "file://" + originalPath.substr(16);
	// Convert to a native file format
	var localPath;
	if(originalPath.charAt(9) == ":") // pc local file
		localPath = unescape(originalPath.substr(8)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file://///") == 0) // FireFox pc network file
		localPath = "\\\\" + unescape(originalPath.substr(10)).replace(new RegExp("/","g"),"\\");
	else if(originalPath.indexOf("file:///") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(7));
	else if(originalPath.indexOf("file:/") == 0) // mac/unix local file
		localPath = unescape(originalPath.substr(5));
	else // pc network file
		localPath = "\\\\" + unescape(originalPath.substr(7)).replace(new RegExp("/","g"),"\\");
	return localPath;
}

function getBackupPath(localPath,title,extension)
{
	var slash = "\\";
	var dirPathPos = localPath.lastIndexOf("\\");
	if(dirPathPos == -1) {
		dirPathPos = localPath.lastIndexOf("/");
		slash = "/";
	}
	var backupFolder = config.options.txtBackupFolder;
	if(!backupFolder || backupFolder == "")
		backupFolder = ".";
	var backupPath = localPath.substr(0,dirPathPos) + slash + backupFolder + localPath.substr(dirPathPos);
	backupPath = backupPath.substr(0,backupPath.lastIndexOf(".")) + ".";
	if(title)
		backupPath += title.replace(/[\\\/\*\?\":<> ]/g,"_") + ".";
	backupPath += (new Date()).convertToYYYYMMDDHHMMSSMMM() + "." + (extension || "html");
	return backupPath;
}


//--
//-- RSS Saving
//--

function saveRss(localPath)
{
	var rssPath = localPath.substr(0,localPath.lastIndexOf(".")) + ".xml";
	if(saveFile(rssPath,convertUnicodeToFileFormat(generateRss())))
		displayMessage(config.messages.rssSaved,"file://" + rssPath);
	else
		alert(config.messages.rssFailed);
}

tiddlerToRssItem = function(tiddler,uri)
{
	var s = "<title" + ">" + tiddler.title.htmlEncode() + "</title" + ">\n";
	s += "<description>" + wikifyStatic(tiddler.text,null,tiddler).htmlEncode() + "</description>\n";
	var i;
	for(i=0; i<tiddler.tags.length; i++)
		s += "<category>" + tiddler.tags[i] + "</category>\n";
	s += "<link>" + uri + "#" + encodeURIComponent(String.encodeTiddlyLink(tiddler.title)) + "</link>\n";
	s +="<pubDate>" + tiddler.modified.toGMTString() + "</pubDate>\n";
	return s;
};

function generateRss()
{
	var s = [];
	var d = new Date();
	var u = store.getTiddlerText("SiteUrl");
	// Assemble the header
	s.push("<" + "?xml version=\"1.0\"?" + ">");
	s.push("<rss version=\"2.0\">");
	s.push("<channel>");
	s.push("<title" + ">" + wikifyPlainText(store.getTiddlerText("SiteTitle",""),null,tiddler).htmlEncode() + "</title" + ">");
	if(u)
		s.push("<link>" + u.htmlEncode() + "</link>");
	s.push("<description>" + wikifyPlainText(store.getTiddlerText("SiteSubtitle",""),null,tiddler).htmlEncode() + "</description>");
	s.push("<language>" + config.locale + "</language>");
	s.push("<copyright>Copyright " + d.getFullYear() + " " + config.options.txtUserName.htmlEncode() + "</copyright>");
	s.push("<pubDate>" + d.toGMTString() + "</pubDate>");
	s.push("<lastBuildDate>" + d.toGMTString() + "</lastBuildDate>");
	s.push("<docs>http://blogs.law.harvard.edu/tech/rss</docs>");
	s.push("<generator>TiddlyWiki " + formatVersion() + "</generator>");
	// The body
	var tiddlers = store.getTiddlers("modified","excludeLists");
	var i,n = config.numRssItems > tiddlers.length ? 0 : tiddlers.length-config.numRssItems;
	for(i=tiddlers.length-1; i>=n; i--) {
		s.push("<item>\n" + tiddlerToRssItem(tiddlers[i],u) + "\n</item>");
	}
	// And footer
	s.push("</channel>");
	s.push("</rss>");
	// Save it all
	return s.join("\n");
}


//--
//-- Filesystem code
//--

// Copy a file in filesystem [Preemption]
window.copyFile = window.copyFile || function(dest,source)
{
	return config.browser.isIE ? ieCopyFile(dest,source) : false;
}


// Save a file in filesystem [Preemption]
window.saveFile = window.saveFile || function(fileUrl,content)
{
	var r = mozillaSaveFile(fileUrl,content);
	if(!r)
		r = ieSaveFile(fileUrl,content);
	if(!r)
		r = javaSaveFile(fileUrl,content);
	return r;
}

// Load a file from filesystem [Preemption]
window.loadFile = window.loadFile || function(fileUrl)
{
	var r = mozillaLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = ieLoadFile(fileUrl);
	if((r == null) || (r == false))
		r = javaLoadFile(fileUrl);
	return r;
}

function ieCreatePath(path)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}

	var pos = path.lastIndexOf("\\");
	if(pos==-1)
		pos = path.lastIndexOf("/");
	if(pos!=-1)
		path = path.substring(0,pos+1);

	var scan = [path];
	var parent = fso.GetParentFolderName(path);
	while(parent && !fso.FolderExists(parent)) {
		scan.push(parent);
		parent = fso.GetParentFolderName(parent);
	}

	for(i=scan.length-1;i>=0;i--) {
		if(!fso.FolderExists(scan[i])) {
			fso.CreateFolder(scan[i]);
		}
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function ieSaveFile(filePath,content)
{
	ieCreatePath(filePath);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
	} catch(ex) {
		return null;
	}
	var file = fso.OpenTextFile(filePath,2,-1,0);
	file.Write(content);
	file.Close();
	return true;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function ieLoadFile(filePath)
{
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		var file = fso.OpenTextFile(filePath,1);
		var content = file.ReadAll();
		file.Close();
	} catch(ex) {
		return null;
	}
	return content;
}

function ieCopyFile(dest,source)
{
	ieCreatePath(dest);
	try {
		var fso = new ActiveXObject("Scripting.FileSystemObject");
		fso.GetFile(source).Copy(dest);
	} catch(ex) {
		return false;
	}
	return true;
}

// Returns null if it can't do it, false if there's an error, true if it saved OK
function mozillaSaveFile(filePath,content)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				file.create(0,0x01B4);// 0x01B4 = 0664
			var out = Components.classes["@mozilla.org/network/file-output-stream;1"].createInstance(Components.interfaces.nsIFileOutputStream);
			out.init(file,0x22,0x04,null);
			out.write(content,content.length);
			out.flush();
			out.close();
			return true;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

// Returns null if it can't do it, false if there's an error, or a string of the content if successful
function mozillaLoadFile(filePath)
{
	if(window.Components) {
		try {
			netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
			var file = Components.classes["@mozilla.org/file/local;1"].createInstance(Components.interfaces.nsILocalFile);
			file.initWithPath(filePath);
			if(!file.exists())
				return null;
			var inputStream = Components.classes["@mozilla.org/network/file-input-stream;1"].createInstance(Components.interfaces.nsIFileInputStream);
			inputStream.init(file,0x01,0x04,null);
			var sInputStream = Components.classes["@mozilla.org/scriptableinputstream;1"].createInstance(Components.interfaces.nsIScriptableInputStream);
			sInputStream.init(inputStream);
			var contents = sInputStream.read(sInputStream.available());
			sInputStream.close();
			inputStream.close();
			return contents;
		} catch(ex) {
			return false;
		}
	}
	return null;
}

function javaUrlToFilename(url)
{
	var f = "//localhost";
	if(url.indexOf(f) == 0)
		return url.substring(f.length);
	var i = url.indexOf(":");
	return i > 0 ? url.substring(i-1) : url;
}

/*
 *
 * in between when the applet has been started
 * and the user has given permission to run the applet
 * we get an applet object, but it doesn't have the methods
 * we expect yet.
 *
 */
var LOG_TIDDLYSAVER = true;
function logTiddlySaverException(msg, ex) {
	var applet = document.applets['TiddlySaver'];
	console.log(msg + ": " + ex);
	if (LOG_TIDDLYSAVER && applet) {
		try {
			console.log(msg + ": " + applet.getLastErrorMsg());
			console.log(msg + ": " + applet.getLastErrorStackTrace());
		} catch (ex) {}
	}
}

function javaDebugInformation () {
	var applet = document.applets['TiddlySaver'];
	var what = [
		["Java Version", applet.getJavaVersion],
		["Last Exception", applet.getLastErrorMessage],
		["Last Exception Stack Trace", applet.getLastErrorStackTrace],
		["System Properties", applet.getSystemProperties] ];

	function formatItem (description, method) {
		try {
			 result = String(method.call(applet));
		} catch (ex) {
			 result = String(ex)
		}
		return description + ": " + result
	}

	return jQuery.map(what, function (item) { return formatItem.apply(this, item) })
			.join('\n\n')
}

function javaSaveFile(filePath,content)
{
	var applet = document.applets['TiddlySaver'];
	try {
		if (applet && filePath) 
			return applet.saveFile(javaUrlToFilename(filePath), "UTF-8", content);
	} catch(ex) {
		logTiddlySaverException("javaSaveFile", ex);
	}
	// is this next block working anywhere ? -- grmble
	try {
		var s = new java.io.PrintStream(new java.io.FileOutputStream(javaUrlToFilename(filePath)));
		s.print(content);
		s.close();
	} catch(ex2) {
		return null;
	}
	return true;
}

function javaLoadFile(filePath)
{
	var applet = document.applets['TiddlySaver'];
	try {
		if (applet && filePath) {
			var ret = applet.loadFile(javaUrlToFilename(filePath),"UTF-8");
			if(!ret)
				return null;
			return String(ret);
		}
	} catch(ex) {
		logTiddlySaverException("javaLoadFile", ex);
	}
	// is this next block working anywhere ? -- grmble
	var content = [];
	try {
		var r = new java.io.BufferedReader(new java.io.FileReader(javaUrlToFilename(filePath)));
		var line;
		while((line = r.readLine()) != null)
			content.push(String(line));
		r.close();
	} catch(ex2) {
		return null;
	}
	return content.join("\n");
}


//--
//-- Filesystem utilities
//--

function convertUTF8ToUnicode(u)
{
	return config.browser.isOpera || !window.netscape ? manualConvertUTF8ToUnicode(u) : mozConvertUTF8ToUnicode(u);
}


function manualConvertUTF8ToUnicode(utf)
{
	var uni = utf;
	var src = 0;
	var dst = 0;
	var b1, b2, b3;
	var c;
	while(src < utf.length) {
		b1 = utf.charCodeAt(src++);
		if(b1 < 0x80) {
			dst++;
		} else if(b1 < 0xE0) {
			b2 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0x1F) << 6) | (b2 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		} else {
			b2 = utf.charCodeAt(src++);
			b3 = utf.charCodeAt(src++);
			c = String.fromCharCode(((b1 & 0xF) << 12) | ((b2 & 0x3F) << 6) | (b3 & 0x3F));
			uni = uni.substring(0,dst++).concat(c,utf.substr(src));
		}
	}
	return uni;
}

function mozConvertUTF8ToUnicode(u)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUTF8ToUnicode(u);
	} // fallback
	var s = converter.ConvertToUnicode(u);
	var fin = converter.Finish();
	return fin.length > 0 ? s+fin : s;
}

function convertUnicodeToFileFormat(s)
{
	return config.browser.isOpera || !window.netscape ? (config.browser.isIE ? convertUnicodeToHtmlEntities(s) : s) : mozConvertUnicodeToUTF8(s);
}

function convertUnicodeToHtmlEntities(s)
{
	var re = /[^\u0000-\u007F]/g;
	return s.replace(re,function($0) {return "&#" + $0.charCodeAt(0).toString() + ";";});
}

function convertUnicodeToUTF8(s)
{
// return convertUnicodeToFileFormat to allow plugin migration
	return convertUnicodeToFileFormat(s);
}

function manualConvertUnicodeToUTF8(s)
{
	return unescape(encodeURIComponent(s));
}

function mozConvertUnicodeToUTF8(s)
{
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/scriptableunicodeconverter"].createInstance(Components.interfaces.nsIScriptableUnicodeConverter);
		converter.charset = "UTF-8";
	} catch(ex) {
		return manualConvertUnicodeToUTF8(s);
	} // fallback
	var u = converter.ConvertFromUnicode(s);
	var fin = converter.Finish();
	return fin.length > 0 ? u + fin : u;
}

function convertUriToUTF8(uri,charSet)
{
	if(window.netscape == undefined || charSet == undefined || charSet == "")
		return uri;
	try {
		netscape.security.PrivilegeManager.enablePrivilege("UniversalXPConnect");
		var converter = Components.classes["@mozilla.org/intl/utf8converterservice;1"].getService(Components.interfaces.nsIUTF8ConverterService);
	} catch(ex) {
		return uri;
	}
	return converter.convertURISpecToUTF8(uri,charSet);
}

//--
//-- Server adaptor base class
//--

function AdaptorBase()
{
	this.host = null;
	this.store = null;
	return this;
}

AdaptorBase.prototype.close = function()
{
	return true;
};

AdaptorBase.prototype.fullHostName = function(host)
{
	if(!host)
		return '';
	host = host.trim();
	if(!host.match(/:\/\//))
		host = 'http://' + host;
	if(host.substr(host.length-1) == '/')
		host = host.substr(0,host.length-1);
	return host;
};

AdaptorBase.minHostName = function(host)
{
	return host;
};

AdaptorBase.prototype.setContext = function(context,userParams,callback)
{
	if(!context) context = {};
	context.userParams = userParams;
	if(callback) context.callback = callback;
	context.adaptor = this;
	if(!context.host)
		context.host = this.host;
	context.host = this.fullHostName(context.host);
	if(!context.workspace)
		context.workspace = this.workspace;
	return context;
};

// Open the specified host
AdaptorBase.prototype.openHost = function(host,context,userParams,callback)
{
	this.host = host;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {context.callback(context,userParams);},10);
	return true;
};

// Open the specified workspace
AdaptorBase.prototype.openWorkspace = function(workspace,context,userParams,callback)
{
	this.workspace = workspace;
	context = this.setContext(context,userParams,callback);
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};


//--
//-- Server adaptor for talking to static TiddlyWiki files
//--

function FileAdaptor()
{
}

FileAdaptor.prototype = new AdaptorBase();

FileAdaptor.serverType = 'file';
FileAdaptor.serverLabel = 'TiddlyWiki';

FileAdaptor.loadTiddlyWikiSuccess = function(context,jqXHR)
{
	context.status = true;
	context.adaptor.store = new TiddlyWiki();
	if(!context.adaptor.store.importTiddlyWiki(jqXHR.responseText)) {
		context.statusText = config.messages.invalidFileError.format([context.host]);
		context.status = false;
	}
	context.complete(context,context.userParams);
};

FileAdaptor.loadTiddlyWikiError = function(context,jqXHR)
{
	context.status = false;
	context.statusText = jqXHR.message;
	context.complete(context,context.userParams);
};

// Get the list of workspaces on a given server
FileAdaptor.prototype.getWorkspaceList = function(context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.workspaces = [{title:"(default)"}];
	context.status = true;
	if(callback)
		window.setTimeout(function() {callback(context,userParams);},10);
	return true;
};

// Gets the list of tiddlers within a given workspace
FileAdaptor.prototype.getTiddlerList = function(context,userParams,callback,filter)
{
	context = this.setContext(context,userParams,callback);
	if(!context.filter)
		context.filter = filter;
	context.complete = FileAdaptor.getTiddlerListComplete;
	if(this.store) {
		return context.complete(context,context.userParams);
	}
	var options = {
		type:"GET",
		url:context.host,
		processData:false,
		success:function(data,textStatus,jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context,jqXHR);
		},
		error:function(jqXHR,textStatus,errorThrown) {
			context.xhr = jqXHR;
			FileAdaptor.loadTiddlyWikiError(context,jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerListComplete = function(context,userParams)
{
	if(context.status) {
		if(context.filter) {
			context.tiddlers = context.adaptor.store.filterTiddlers(context.filter);
		} else {
			context.tiddlers = [];
			context.adaptor.store.forEachTiddler(function(title,tiddler) {context.tiddlers.push(tiddler);});
		}
		var i;
		for(i=0; i<context.tiddlers.length; i++) {
			context.tiddlers[i].fields['server.type'] = FileAdaptor.serverType;
			context.tiddlers[i].fields['server.host'] = AdaptorBase.minHostName(context.host);
			context.tiddlers[i].fields['server.page.revision'] = context.tiddlers[i].modified.convertToYYYYMMDDHHMM();
		}
		context.status = true;
	}
	if(context.callback) {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.generateTiddlerInfo = function(tiddler)
{
	var info = {};
	info.uri = tiddler.fields['server.host'] + "#" + tiddler.title;
	return info;
};

// Retrieve a tiddler from a given workspace on a given server
FileAdaptor.prototype.getTiddler = function(title,context,userParams,callback)
{
	context = this.setContext(context,userParams,callback);
	context.title = title;
	context.complete = FileAdaptor.getTiddlerComplete;
	if(context.adaptor.store) {
		return context.complete(context,context.userParams);
	}
	var options = {
		type:"GET",
		url:context.host,
		processData:false,
		success:function(data,textStatus,jqXHR) {
			FileAdaptor.loadTiddlyWikiSuccess(context,jqXHR);
		},
		error:function(jqXHR,textStatus,errorThrown) {
			FileAdaptor.loadTiddlyWikiError(context,jqXHR);
		}
	};
	return ajaxReq(options);
};

FileAdaptor.getTiddlerComplete = function(context,userParams)
{
	var t = context.adaptor.store.fetchTiddler(context.title);
	if(t) {
		t.fields['server.type'] = FileAdaptor.serverType;
		t.fields['server.host'] = AdaptorBase.minHostName(context.host);
		t.fields['server.page.revision'] = t.modified.convertToYYYYMMDDHHMM();
		context.tiddler = t;
		context.status = true;
	} else { //# tiddler does not exist in document
		context.status = false;
	}
	if(context.allowSynchronous) {
		context.isSynchronous = true;
		context.callback(context,userParams);
	} else {
		window.setTimeout(function() {context.callback(context,userParams);},10);
	}
	return true;
};

FileAdaptor.prototype.close = function()
{
	this.store = null;
};

config.adaptors[FileAdaptor.serverType] = FileAdaptor;

config.defaultAdaptor = FileAdaptor.serverType;


//--
//-- HTTP request code
//--

function ajaxReq(args)
{
	if (args.url.startsWith("file")) { // LOCAL FILE
		try {
			// get FireFox privileges (FF14 and earlier)
			if(window.Components && window.netscape && window.netscape.security)
				window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
		} catch (ex) {
			// FF15+ fallback: no privs for ajax-based LOCAL file access
			return localAjax(args);
		}
	}
	return jQuery.ajax(args);
}

function localAjax(args)
{
	var data=loadFile(getLocalPath(args.url));
	if (data) {
		var jqXHR = { responseText:data };
		args.success(data,"success",jqXHR);
	} else {
		var jqXHR = { message:"Cannot read local file" };
		args.error(jqXHR,"error",0);
	}
	return true;
}

function httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache)
{
	var httpSuccess = function(xhr) {
		try {
			// IE error sometimes returns 1223 when it should be 204 so treat it as success, see #1450
			return (!xhr.status && location.protocol === "file:") ||
				(xhr.status >= 200 && xhr.status < 300) ||
				xhr.status === 304 || xhr.status === 1223;
		} catch(e) {}
		return false;
	};

	var options = {
		type:type,
		url:url,
		processData:false,
		data:data,
		cache:!!allowCache,
		beforeSend: function(xhr) {
			var i;
			for(i in headers)
				xhr.setRequestHeader(i,headers[i]);
		}
	};

	if(callback) {
		options.complete = function(xhr,textStatus) {
			if(httpSuccess(xhr))
				callback(true,params,xhr.responseText,url,xhr);
			else
				callback(false,params,null,url,xhr);
		};
	}
	if(contentType)
		options.contentType = contentType;
	if(username)
		options.username = username;
	if(password)
		options.password = password;
	try {
		if(window.Components && window.netscape && window.netscape.security && document.location.protocol.indexOf("http") == -1)
			window.netscape.security.PrivilegeManager.enablePrivilege("UniversalBrowserRead");
	} catch (ex) {
	}
	return jQuery.ajax(options);
}

//--
//-- TiddlyWiki-specific utility functions
//--

// Returns TiddlyWiki version string
function formatVersion(v)
{
	v = v || version;
	return v.major + "." + v.minor + "." + v.revision +
		(v.alpha ? " (alpha " + v.alpha + ")" : "") +
		(v.beta ? " (beta " + v.beta + ")" : "");
}

function compareVersions(v1,v2)
{
	var x1,x2,i,a = ["major","minor","revision"];
	for(i = 0; i<a.length; i++) {
		x1 = v1[a[i]] || 0;
		x2 = v2[a[i]] || 0;
		if(x1<x2)
			return 1;
		if(x1>x2)
			return -1;
	}
	x1 = v1.beta || 9999;
	x2 = v2.beta || 9999;
	if(x1<x2)
		return 1;
	return x1 > x2 ? -1 : 0;
}

function merge(dst,src,preserveExisting)
{
	var i;
	for(i in src) {
		if(!preserveExisting || dst[i] === undefined)
			dst[i] = src[i];
	}
	return dst;
}

// Resolve the target object of an event
function resolveTarget(e)
{
	var obj;
	if(e.target)
		obj = e.target;
	else if(e.srcElement)
		obj = e.srcElement;
	if(obj.nodeType == 3) // defeat Safari bug
		obj = obj.parentNode;
	return obj;
}

// Returns a string containing the description of an exception, optionally prepended by a message
function exceptionText(e,message)
{
	var s = e.description || e.toString();
	return message ? "%0:\n%1".format([message,s]) : s;
}

// Displays an alert of an exception description with optional message
function showException(e,message)
{
	alert(exceptionText(e,message));
}

function alertAndThrow(m)
{
	alert(m);
	throw(m);
}

function glyph(name)
{
	var g = config.glyphs;
	var b = g.currBrowser;
	if(b == null) {
		b = 0;
		while(b < g.browsers.length-1 && !g.browsers[b]())
			b++;
		g.currBrowser = b;
	}
	if(!g.codes[name])
		return "";
	return g.codes[name][b];
}

function createTiddlyText(parent,text)
{
	return parent.appendChild(document.createTextNode(text));
}

function createTiddlyCheckbox(parent,caption,checked,onChange)
{
	var cb = document.createElement("input");
	cb.setAttribute("type","checkbox");
	cb.onclick = onChange;
	parent.appendChild(cb);
	cb.checked = checked;
	cb.className = "chkOptionInput";
	if(caption)
		wikify(caption,parent);
	return cb;
}

function createTiddlyElement(parent,element,id,className,text,attribs)
{
	var n,e = document.createElement(element);
	if(className != null)
		e.className = className;
	if(id != null)
		e.setAttribute("id",id);
	if(text != null)
		e.appendChild(document.createTextNode(text));
	if(attribs) {
		for(n in attribs) {
			e.setAttribute(n,attribs[n]);
		}
	}
	if(parent != null)
		parent.appendChild(e);
	return e;
}

function createTiddlyButton(parent,text,tooltip,action,className,id,accessKey,attribs)
{
	var i,btn = document.createElement("a");
	btn.setAttribute("href","javascript:;");
	if(action) {
		btn.onclick = action;
	}
	if(tooltip)
		btn.setAttribute("title",tooltip);
	if(text)
		btn.appendChild(document.createTextNode(text));
	btn.className = className || "button";
	if(id)
		btn.id = id;
	if(attribs) {
		for(i in attribs) {
			btn.setAttribute(i,attribs[i]);
		}
	}
	if(parent)
		parent.appendChild(btn);
	if(accessKey)
		btn.setAttribute("accessKey",accessKey);
	return btn;
}

function createExternalLink(place,url,label)
{
	var link = document.createElement("a");
	link.className = "externalLink";
	link.href = url;
	var f = config.messages.externalLinkTooltip;
	link.title = f ? f.format([url]) : url;
	if(config.options.chkOpenInNewWindow)
		link.target = "_blank";
	place.appendChild(link);
	if(label)
		createTiddlyText(link, label);
	return link;
}

function getTiddlyLinkInfo(title,currClasses)
{
	var classes = currClasses ? currClasses.split(" ") : [];
	classes.pushUnique("tiddlyLink");
	var tiddler = store.fetchTiddler(title);
	var subTitle;
	if(tiddler) {
		subTitle = tiddler.getSubtitle();
		classes.pushUnique("tiddlyLinkExisting");
		classes.remove("tiddlyLinkNonExisting");
		classes.remove("shadow");
	} else {
	    var f;
		classes.remove("tiddlyLinkExisting");
		classes.pushUnique("tiddlyLinkNonExisting");
		if(store.isShadowTiddler(title)) {
			f = config.messages.shadowedTiddlerToolTip;
			classes.pushUnique("shadow");
		} else {
			f = config.messages.undefinedTiddlerToolTip;
			classes.remove("shadow");
		}
		subTitle = f ? f.format([title]) : "";
	}
	if(typeof config.annotations[title]=="string")
		subTitle = config.annotations[title];
	return {classes: classes.join(" "),subTitle: subTitle};
}

// Event handler for clicking on a tiddly link
function onClickTiddlerLink(ev)
{
	var e = ev || window.event;
	var target = resolveTarget(e);
	var link = target;
	var title = null;
	var fields = null;
	var noToggle = null;
	do {
		title = link.getAttribute("tiddlyLink");
		fields = link.getAttribute("tiddlyFields");
		noToggle = link.getAttribute("noToggle");
		link = link.parentNode;
	} while(title == null && link != null);
	if(!store.isShadowTiddler(title)) {
		var f = fields ? fields.decodeHashMap() : {};
		fields = String.encodeHashMap(merge(f,config.defaultCustomFields,true));
	}
	if(title) {
		var toggling = e.metaKey || e.ctrlKey;
		if(config.options.chkToggleLinks)
			toggling = !toggling;
		if(noToggle)
			toggling = false;
		if(store.getTiddler(title))
			fields = null;
		story.displayTiddler(target,title,null,true,null,fields,toggling);
	}
	clearMessage();
	return false;
}

function createTiddlyLink(place,title,includeText,className,isStatic,linkedFromTiddler,noToggle)
{
	var title = jQuery.trim(title);
	var text = includeText ? title : null;
	var i = getTiddlyLinkInfo(title,className);
	var btn = isStatic ? createExternalLink(place,store.getTiddlerText("SiteUrl",null) + "#" + title) : createTiddlyButton(place,text,i.subTitle,onClickTiddlerLink,i.classes);
	if(isStatic)
		btn.className += ' ' + className;
	btn.setAttribute("refresh","link");
	btn.setAttribute("tiddlyLink",title);
	if(noToggle)
		btn.setAttribute("noToggle","true");
	if(linkedFromTiddler) {
		var fields = linkedFromTiddler.getInheritedFields();
		if(fields)
			btn.setAttribute("tiddlyFields",fields);
	}
	return btn;
}

function refreshTiddlyLink(e,title)
{
	var i = getTiddlyLinkInfo(title,e.className);
	e.className = i.classes;
	e.title = i.subTitle;
}

function createTiddlyDropDown(place,onchange,options,defaultValue)
{
	var sel = createTiddlyElement(place,"select");
	sel.onchange = onchange;
	var t;
	for(t=0; t<options.length; t++) {
		var e = createTiddlyElement(sel,"option",null,null,options[t].caption);
		e.value = options[t].name;
		if(options[t].name == defaultValue)
			e.selected = true;
	}
	return sel;
}


//--
//-- TiddlyWiki-specific popup utility functions
//--

// Event handler for 'open all' on a tiddler popup
function onClickTagOpenAll(ev)
{
	var tiddlers = store.getTaggedTiddlers(this.getAttribute("tag"));
	var sortby = this.getAttribute("sortby");
	if(sortby&&sortby.length) {
		store.sortTiddlers(tiddlers,sortby);
	}
	story.displayTiddlers(this,tiddlers);
	return false;
}

// Event handler for clicking on a tiddler tag
function onClickTag(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	jQuery(popup).addClass("taggedTiddlerList");
	var tag = this.getAttribute("tag");
	var title = this.getAttribute("tiddler");
	if(popup && tag) {
		var tagged = tag.indexOf("[")==-1 ? store.getTaggedTiddlers(tag) : store.filterTiddlers(tag);
		var sortby = this.getAttribute("sortby");
		if(sortby&&sortby.length) {
			store.sortTiddlers(tagged,sortby);
		}
		var titles = [];
		var r;
		for(r=0;r<tagged.length;r++) {
			if(tagged[r].title != title)
				titles.push(tagged[r].title);
		}
		var lingo = config.views.wikified.tag;
		if(titles.length > 0) {
			var openAll = createTiddlyButton(createTiddlyElement(popup,"li"),lingo.openAllText.format([tag]),lingo.openAllTooltip,onClickTagOpenAll);
			openAll.setAttribute("tag",tag);
			openAll.setAttribute("sortby",sortby);
			createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
			for(r=0; r<titles.length; r++) {
				createTiddlyLink(createTiddlyElement(popup,"li"),titles[r],true);
			}
		} else {
			createTiddlyElement(popup,"li",null,"disabled",lingo.popupNone.format([tag]));
		}
		createTiddlyElement(createTiddlyElement(popup,"li",null,"listBreak"),"div");
		var h = createTiddlyLink(createTiddlyElement(popup,"li"),tag,false);
		createTiddlyText(h,lingo.openTag.format([tag]));
	}
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

// Create a button for a tag with a popup listing all the tiddlers that it tags
function createTagButton(place,tag,excludeTiddler,title,tooltip)
{
	var btn = createTiddlyButton(place,title||tag,(tooltip||config.views.wikified.tag.tooltip).format([tag]),onClickTag);
	btn.setAttribute("tag",tag);
	if(excludeTiddler)
		btn.setAttribute("tiddler",excludeTiddler);
	return btn;
}

function onClickTiddlyPopup(ev)
{
	var e = ev || window.event;
	var tiddler = this.tiddler;
	if(tiddler.text) {
		var popup = Popup.create(this,"div","popupTiddler");
		wikify(tiddler.text,popup,null,tiddler);
		Popup.show();
	}
	if(e) e.cancelBubble = true;
	if(e && e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyPopup(place,caption,tooltip,tiddler)
{
	if(tiddler.text) {
		createTiddlyLink(place,caption,true);
		var btn = createTiddlyButton(place,glyph("downArrow"),tooltip,onClickTiddlyPopup,"tiddlerPopupButton");
		btn.tiddler = tiddler;
	} else {
		createTiddlyText(place,caption);
	}
}

function onClickError(ev)
{
	var e = ev || window.event;
	var popup = Popup.create(this);
	var lines = this.getAttribute("errorText").split("\n");
	var t;
	for(t=0; t<lines.length; t++)
		createTiddlyElement(popup,"li",null,null,lines[t]);
	Popup.show();
	e.cancelBubble = true;
	if(e.stopPropagation) e.stopPropagation();
	return false;
}

function createTiddlyError(place,title,text)
{
	var btn = createTiddlyButton(place,title,null,onClickError,"errorButton");
	if(text) btn.setAttribute("errorText",text);
}

//-
//- Animation engine
//-

function Animator()
{
	this.running = 0; // Incremented at start of each animation, decremented afterwards. If zero, the interval timer is disabled
	this.timerID = 0; // ID of the timer used for animating
	this.animations = []; // List of animations in progress
	return this;
}

// Start animation engine
Animator.prototype.startAnimating = function() //# Variable number of arguments
{
	var t;
	for(t=0; t<arguments.length; t++)
		this.animations.push(arguments[t]);
	if(this.running == 0) {
		var me = this;
		this.timerID = window.setInterval(function() {me.doAnimate(me);},10);
	}
	this.running += arguments.length;
};

// Perform an animation engine tick, calling each of the known animation modules
Animator.prototype.doAnimate = function(me)
{
	var a = 0;
	while(a < me.animations.length) {
		var animation = me.animations[a];
		if(animation.tick()) {
			a++;
		} else {
			me.animations.splice(a,1);
			if(--me.running == 0)
				window.clearInterval(me.timerID);
		}
	}
};

Animator.slowInSlowOut = function(progress)
{
	return(1-((Math.cos(progress * Math.PI)+1)/2));
};


//--
//-- Morpher animation
//--

// Animate a set of properties of an element
function Morpher(element,duration,properties,callback)
{
	this.element = element;
	this.duration = duration;
	this.properties = properties;
	this.startTime = new Date();
	this.endTime = Number(this.startTime) + duration;
	this.callback = callback;
	this.tick();
	return this;
}

Morpher.prototype.assignStyle = function(element,style,value)
{
	switch(style) {
	case "-tw-vertScroll":
		window.scrollTo(findScrollX(),value);
		break;
	case "-tw-horizScroll":
		window.scrollTo(value,findScrollY());
		break;
	default:
		element.style[style] = value;
		break;
	}
};

Morpher.prototype.stop = function()
{
	var t;
	for(t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.atEnd !== undefined) {
			this.assignStyle(this.element,p.style,p.atEnd);
		}
	}
	if(this.callback)
		this.callback(this.element,this.properties);
};

Morpher.prototype.tick = function()
{
	var currTime = Number(new Date());
	var t,progress = Animator.slowInSlowOut(Math.min(1,(currTime-this.startTime)/this.duration));
	for(t=0; t<this.properties.length; t++) {
		var p = this.properties[t];
		if(p.start !== undefined && p.end !== undefined) {
			var template = p.template || "%0";
			switch(p.format) {
			case undefined:
			case "style":
				var v = p.start + (p.end-p.start) * progress;
				this.assignStyle(this.element,p.style,template.format([v]));
				break;
			case "color":
				break;
			}
		}
	}
	if(currTime >= this.endTime) {
		this.stop();
		return false;
	}
	return true;
};


//--
//-- Zoomer animation
//--

function Zoomer(text,startElement,targetElement,unused)
{
	var e = createTiddlyElement(document.body,"div",null,"zoomer");
	createTiddlyElement(e,"div",null,null,text);
	var winWidth = findWindowWidth();
	var winHeight = findWindowHeight();
	var p = [
		{style: 'left', start: findPosX(startElement), end: findPosX(targetElement), template: '%0px'},
		{style: 'top', start: findPosY(startElement), end: findPosY(targetElement), template: '%0px'},
		{style: 'width', start: Math.min(startElement.scrollWidth,winWidth), end: Math.min(targetElement.scrollWidth,winWidth), template: '%0px', atEnd: 'auto'},
		{style: 'height', start: Math.min(startElement.scrollHeight,winHeight), end: Math.min(targetElement.scrollHeight,winHeight), template: '%0px', atEnd: 'auto'},
		{style: 'fontSize', start: 8, end: 24, template: '%0pt'}
	];
	var c = function(element,properties) {jQuery(element).remove();};
	return new Morpher(e,config.animDuration,p,c);
}


//--
//-- Scroller animation
//--

function Scroller(targetElement)
{
	var p = [{style: '-tw-vertScroll', start: findScrollY(), end: ensureVisible(targetElement)}];
	return new Morpher(targetElement,config.animDuration,p);
}


//--
//-- Slider animation
//--

// deleteMode - "none", "all" [delete target element and it's children], [only] "children" [but not the target element]
function Slider(element,opening,unused,deleteMode)
{
	element.style.overflow = 'hidden';
	if(opening)
		element.style.height = '0px'; // Resolves a Firefox flashing bug
	element.style.display = 'block';
	var height = element.scrollHeight;
	var p = [];
	var c = null;
	if(opening) {
		p.push({style: 'height', start: 0, end: height, template: '%0px', atEnd: 'auto'});
		p.push({style: 'opacity', start: 0, end: 1, template: '%0'});
		p.push({style: 'filter', start: 0, end: 100, template: 'alpha(opacity:%0)'});
	} else {
		p.push({style: 'height', start: height, end: 0, template: '%0px'});
		p.push({style: 'display', atEnd: 'none'});
		p.push({style: 'opacity', start: 1, end: 0, template: '%0'});
		p.push({style: 'filter', start: 100, end: 0, template: 'alpha(opacity:%0)'});
		switch(deleteMode) {
		case "all":
			c = function(element,properties) {jQuery(element).remove();};
			break;
		case "children":
			c = function(element,properties) {jQuery(element).empty();};
			break;
		}
	}
	return new Morpher(element,config.animDuration,p,c);
}


//--
//-- Popup menu
//--

var Popup = {
	stack: [] // Array of objects with members root: and popup:
	};

Popup.create = function(root,elem,className)
{
	var stackPosition = this.find(root,"popup");
	Popup.remove(stackPosition+1);
	var popup = createTiddlyElement(document.body,elem || "ol","popup",className || "popup");
	popup.stackPosition = stackPosition;
	Popup.stack.push({root: root, popup: popup});
	return popup;
};

Popup.onDocumentClick = function(ev)
{
	var e = ev || window.event;
	if(e.eventPhase == undefined)
		Popup.remove();
	else if(e.eventPhase == Event.BUBBLING_PHASE || e.eventPhase == Event.AT_TARGET)
		Popup.remove();
	return true;
};

Popup.show = function(valign,halign,offset)
{
	var curr = Popup.stack[Popup.stack.length-1];
	this.place(curr.root,curr.popup,valign,halign,offset);
	jQuery(curr.root).addClass("highlight");
	if(config.options.chkAnimate && anim && typeof Scroller == "function")
		anim.startAnimating(new Scroller(curr.popup));
	else
		window.scrollTo(0,ensureVisible(curr.popup));
};

Popup.place = function(root,popup,valign,halign,offset)
{
	if(!offset)
		offset = {x:0,y:0};
	if(popup.stackPosition >= 0 && !valign && !halign) {
		offset.x = offset.x + root.offsetWidth;
	} else {
		offset.x = (halign == "right") ? offset.x + root.offsetWidth : offset.x;
		offset.y = (valign == "top") ? offset.y : offset.y + root.offsetHeight;
	}
	var rootLeft = findPosX(root);
	var rootTop = findPosY(root);
	var popupLeft = rootLeft + offset.x;
	var popupTop = rootTop + offset.y;
	var winWidth = findWindowWidth();
	if(popup.offsetWidth > winWidth*0.75)
		popup.style.width = winWidth*0.75 + "px";
	var popupWidth = popup.offsetWidth;
	var scrollWidth = winWidth - document.body.offsetWidth;
	if(popupLeft + popupWidth > winWidth - scrollWidth - 1) {
		if(halign == "right")
			popupLeft = popupLeft - root.offsetWidth - popupWidth;
		else
			popupLeft = winWidth - popupWidth - scrollWidth - 1;
	}
	popup.style.left = popupLeft + "px";
	popup.style.top = popupTop + "px";
	popup.style.display = "block";
};

Popup.find = function(e)
{
	var t,pos = -1;
	for(t=this.stack.length-1; t>=0; t--) {
		if(isDescendant(e,this.stack[t].popup))
			pos = t;
	}
	return pos;
};

Popup.remove = function(pos)
{
	if(!pos) pos = 0;
	if(Popup.stack.length > pos) {
		Popup.removeFrom(pos);
	}
};

Popup.removeFrom = function(from)
{
	var t;
	for(t=Popup.stack.length-1; t>=from; t--) {
		var p = Popup.stack[t];
		jQuery(p.root).removeClass("highlight");
		jQuery(p.popup).remove();
	}
	Popup.stack = Popup.stack.slice(0,from);
};


//--
//-- Wizard support
//--

function Wizard(elem)
{
	if(elem) {
		this.formElem = findRelated(elem,"wizard","className");
		this.bodyElem = findRelated(this.formElem.firstChild,"wizardBody","className","nextSibling");
		this.footElem = findRelated(this.formElem.firstChild,"wizardFooter","className","nextSibling");
	} else {
		this.formElem = null;
		this.bodyElem = null;
		this.footElem = null;
	}
}

Wizard.prototype.setValue = function(name,value)
{
	jQuery(this.formElem).data(name, value);
};

Wizard.prototype.getValue = function(name)
{
	return this.formElem ? jQuery(this.formElem).data(name) : null;
};

Wizard.prototype.createWizard = function(place,title)
{
	this.formElem = createTiddlyElement(place,"form",null,"wizard");
	createTiddlyElement(this.formElem,"h1",null,null,title);
	this.bodyElem = createTiddlyElement(this.formElem,"div",null,"wizardBody");
	this.footElem = createTiddlyElement(this.formElem,"div",null,"wizardFooter");
	return this.formElem;
};

Wizard.prototype.clear = function()
{
	jQuery(this.bodyElem).empty();
};

Wizard.prototype.setButtons = function(buttonInfo,status)
{
	jQuery(this.footElem).empty();
	var t;
	for(t=0; t<buttonInfo.length; t++) {
		createTiddlyButton(this.footElem,buttonInfo[t].caption,buttonInfo[t].tooltip,buttonInfo[t].onClick);
		insertSpacer(this.footElem);
		}
	if(typeof status == "string") {
		createTiddlyElement(this.footElem,"span",null,"status",status);
	}
};

Wizard.prototype.addStep = function(stepTitle,html)
{
	jQuery(this.bodyElem).empty();
	var w = createTiddlyElement(this.bodyElem,"div");
	createTiddlyElement(w,"h2",null,null,stepTitle);
	var step = createTiddlyElement(w,"div",null,"wizardStep");
	step.innerHTML = html;
	applyHtmlMacros(step,tiddler);
};

Wizard.prototype.getElement = function(name)
{
	return this.formElem.elements[name];
};


//--
//-- ListView gadget
//--

var ListView = {};

// Create a listview
ListView.create = function(place,listObject,listTemplate,callback,className)
{
	var table = createTiddlyElement(place,"table",null,className || "listView twtable");
	var thead = createTiddlyElement(table,"thead");
	var t,r = createTiddlyElement(thead,"tr");
	for(t=0; t<listTemplate.columns.length; t++) {
		var columnTemplate = listTemplate.columns[t];
		var c = createTiddlyElement(r,"th");
		var colType = ListView.columnTypes[columnTemplate.type];
		if(colType && colType.createHeader) {
			colType.createHeader(c,columnTemplate,t);
			if(columnTemplate.className)
				jQuery(c).addClass(columnTemplate.className);
		}
	}
	var rc,tbody = createTiddlyElement(table,"tbody");
	for(rc=0; rc<listObject.length; rc++) {
		var rowObject = listObject[rc];
		r = createTiddlyElement(tbody,"tr");
		for(c=0; c<listTemplate.rowClasses.length; c++) {
			if(rowObject[listTemplate.rowClasses[c].field])
				jQuery(r).addClass(listTemplate.rowClasses[c].className);
		}
		rowObject.rowElement = r;
		rowObject.colElements = {};
		var cc;
		for(cc=0; cc<listTemplate.columns.length; cc++) {
			c = createTiddlyElement(r,"td");
			columnTemplate = listTemplate.columns[cc];
			var field = columnTemplate.field;
			colType = ListView.columnTypes[columnTemplate.type];
			if(colType && colType.createItem) {
				colType.createItem(c,rowObject,field,columnTemplate,cc,rc);
				if(columnTemplate.className)
					jQuery(c).addClass(columnTemplate.className);
			}
			rowObject.colElements[field] = c;
		}
	}
	if(callback && listTemplate.actions)
		createTiddlyDropDown(place,ListView.getCommandHandler(callback),listTemplate.actions);
	if(callback && listTemplate.buttons) {
		for(t=0; t<listTemplate.buttons.length; t++) {
			var a = listTemplate.buttons[t];
			if(a && a.name != "")
				createTiddlyButton(place,a.caption,null,ListView.getCommandHandler(callback,a.name,a.allowEmptySelection));
		}
	}
	return table;
};

ListView.getCommandHandler = function(callback,name,allowEmptySelection)
{
	return function(e) {
		var view = findRelated(this,"TABLE",null,"previousSibling");
		var tiddlers = [];
		ListView.forEachSelector(view,function(e,rowName) {
					if(e.checked)
						tiddlers.push(rowName);
					});
		if(tiddlers.length == 0 && !allowEmptySelection) {
			alert(config.messages.nothingSelected);
		} else {
			if(this.nodeName.toLowerCase() == "select") {
				callback(view,this.value,tiddlers);
				this.selectedIndex = 0;
			} else {
				callback(view,name,tiddlers);
			}
		}
	};
};

// Invoke a callback for each selector checkbox in the listview
ListView.forEachSelector = function(view,callback)
{
	var checkboxes = view.getElementsByTagName("input");
	var t,hadOne = false;
	for(t=0; t<checkboxes.length; t++) {
		var cb = checkboxes[t];
		if(cb.getAttribute("type") == "checkbox") {
			var rn = cb.getAttribute("rowName");
			if(rn) {
				callback(cb,rn);
				hadOne = true;
			}
		}
	}
	return hadOne;
};

ListView.getSelectedRows = function(view)
{
	var rowNames = [];
	ListView.forEachSelector(view,function(e,rowName) {
				if(e.checked)
					rowNames.push(rowName);
				});
	return rowNames;
};

ListView.columnTypes = {};

ListView.columnTypes.String = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyText(place,columnTemplate.title);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v);
		}
};

ListView.columnTypes.WikiText = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				wikify(v,place,null,null);
		}
};

ListView.columnTypes.Tiddler = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined && v.title)
				createTiddlyPopup(place,v.title,config.messages.listView.tiddlerTooltip,v);
		}
};

ListView.columnTypes.Size = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var msg = config.messages.sizeTemplates;
			var v = listObject[field];
			if(v != undefined) {
				var t = 0;
				while(t<msg.length-1 && v<msg[t].unit)
					t++;
				createTiddlyText(place,msg[t].template.format([Math.round(v/msg[t].unit)]));
			}
		}
};

ListView.columnTypes.Link = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			var c = columnTemplate.text;
			if(v != undefined)
				createExternalLink(place,v,c || v);
		}
};

ListView.columnTypes.Date = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined)
				createTiddlyText(place,v.formatString(columnTemplate.dateFormat));
		}
};

ListView.columnTypes.StringList = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var t;
				for(t=0; t<v.length; t++) {
					createTiddlyText(place,v[t]);
					createTiddlyElement(place,"br");
				}
			}
		}
};

ListView.columnTypes.Selector = {
	createHeader: function(place,columnTemplate,col)
		{
			createTiddlyCheckbox(place,null,false,this.onHeaderChange);
		},
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],null);
			e.setAttribute("rowName",listObject[columnTemplate.rowName]);
		},
	onHeaderChange: function(e)
		{
			var state = this.checked;
			var view = findRelated(this,"TABLE");
			if(!view)
				return;
			ListView.forEachSelector(view,function(e,rowName) {
								e.checked = state;
							});
		}
};

ListView.columnTypes.Tags = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var tags = listObject[field];
			createTiddlyText(place,String.encodeTiddlyLinkList(tags));
		}
};

ListView.columnTypes.Boolean = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			if(listObject[field] == true)
				createTiddlyText(place,columnTemplate.trueText);
			if(listObject[field] == false)
				createTiddlyText(place,columnTemplate.falseText);
		}
};

ListView.columnTypes.TagCheckbox = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var e = createTiddlyCheckbox(place,null,listObject[field],this.onChange);
			e.setAttribute("tiddler",listObject.title);
			e.setAttribute("tag",columnTemplate.tag);
		},
	onChange : function(e)
		{
			var tag = this.getAttribute("tag");
			var tiddler = this.getAttribute("tiddler");
			store.setTiddlerTag(tiddler,this.checked,tag);
		}
};

ListView.columnTypes.TiddlerLink = {
	createHeader: ListView.columnTypes.String.createHeader,
	createItem: function(place,listObject,field,columnTemplate,col,row)
		{
			var v = listObject[field];
			if(v != undefined) {
				var link = createTiddlyLink(place,listObject[columnTemplate.tiddlerLink],false,null);
				createTiddlyText(link,listObject[field]);
			}
		}
};


//--
//-- Augmented methods for the JavaScript Array() object
//--

// Add indexOf function if browser does not support it
if(!Array.indexOf) {
Array.prototype.indexOf = function(item,from)
{
	if(!from)
		from = 0;
	var i;
	for(i=from; i<this.length; i++) {
		if(this[i] === item)
			return i;
	}
	return -1;
};}

// Find an entry in a given field of the members of an array
Array.prototype.findByField = function(field,value)
{
	var t;
	for(t=0; t<this.length; t++) {
		if(this[t][field] === value)
			return t;
	}
	return null;
};

// Return whether an entry exists in an array
Array.prototype.contains = function(item)
{
	return this.indexOf(item) != -1;
};

// Adds, removes or toggles a particular value within an array
//  value - value to add
//  mode - +1 to add value, -1 to remove value, 0 to toggle it
Array.prototype.setItem = function(value,mode)
{
	var p = this.indexOf(value);
	if(mode == 0)
		mode = (p == -1) ? +1 : -1;
	if(mode == +1) {
		if(p == -1)
			this.push(value);
	} else if(mode == -1) {
		if(p != -1)
			this.splice(p,1);
	}
};

// Return whether one of a list of values exists in an array
Array.prototype.containsAny = function(items)
{
	var i;
	for(i=0; i<items.length; i++) {
		if(this.indexOf(items[i]) != -1)
			return true;
	}
	return false;
};

// Return whether all of a list of values exists in an array
Array.prototype.containsAll = function(items)
{
	var i;
	for(i = 0; i<items.length; i++) {
		if(this.indexOf(items[i]) == -1)
			return false;
	}
	return true;
};

// Push a new value into an array only if it is not already present in the array. If the optional unique parameter is false, it reverts to a normal push
Array.prototype.pushUnique = function(item,unique)
{
	if(unique === false) {
		this.push(item);
	} else {
		if(this.indexOf(item) == -1)
			this.push(item);
	}
};

Array.prototype.remove = function(item)
{
	var p = this.indexOf(item);
	if(p != -1)
		this.splice(p,1);
};

if(!Array.prototype.map) {
Array.prototype.map = function(fn,thisObj)
{
	var scope = thisObj || window;
	var i,j,a = [];
	for(i=0, j=this.length; i < j; ++i) {
		a.push(fn.call(scope,this[i],i,this));
	}
	return a;
};}


//--
//-- Augmented methods for the JavaScript String() object
//--

// Get characters from the right end of a string
String.prototype.right = function(n)
{
	return n < this.length ? this.slice(this.length-n) : this;
};

// Trim whitespace from both ends of a string
String.prototype.trim = function()
{
	return this.replace(/^\s*|\s*$/g,"");
};

// Convert a string from a CSS style property name to a JavaScript style name ("background-color" -> "backgroundColor")
String.prototype.unDash = function()
{
	var t,s = this.split("-");
	if(s.length > 1) {
		for(t=1; t<s.length; t++)
			s[t] = s[t].substr(0,1).toUpperCase() + s[t].substr(1);
	}
	return s.join("");
};

// Substitute substrings from an array into a format string that includes '%1'-type specifiers
String.prototype.format = function(s)
{
	var substrings = s && s.constructor == Array ? s : arguments;
	var subRegExp = /(?:%(\d+))/mg;
	var currPos = 0;
	var match,r = [];
	do {
		match = subRegExp.exec(this);
		if(match && match[1]) {
			if(match.index > currPos)
				r.push(this.substring(currPos,match.index));
			r.push(substrings[parseInt(match[1],10)]);
			currPos = subRegExp.lastIndex;
		}
	} while(match);
	if(currPos < this.length)
		r.push(this.substring(currPos,this.length));
	return r.join("");
};

// Escape any special RegExp characters with that character preceded by a backslash
String.prototype.escapeRegExp = function()
{
	var s = "\\^$*+?()=!|,{}[].";
	var t,c = this;
	for(t=0; t<s.length; t++)
		c = c.replace(new RegExp("\\" + s.substr(t,1),"g"),"\\" + s.substr(t,1));
	return c;
};

// Convert "\" to "\s", newlines to "\n" (and remove carriage returns)
String.prototype.escapeLineBreaks = function()
{
	return this.replace(/\\/mg,"\\s").replace(/\n/mg,"\\n").replace(/\r/mg,"");
};

// Convert "\n" to newlines, "\b" to " ", "\s" to "\" (and remove carriage returns)
String.prototype.unescapeLineBreaks = function()
{
	return this.replace(/\\n/mg,"\n").replace(/\\b/mg," ").replace(/\\s/mg,"\\").replace(/\r/mg,"");
};

// Convert & to "&amp;", < to "&lt;", > to "&gt;" and " to "&quot;"
String.prototype.htmlEncode = function()
{
	return this.replace(/&/mg,"&amp;").replace(/</mg,"&lt;").replace(/>/mg,"&gt;").replace(/\"/mg,"&quot;");
};

// Convert "&amp;" to &, "&lt;" to <, "&gt;" to > and "&quot;" to "
String.prototype.htmlDecode = function()
{
	return this.replace(/&lt;/mg,"<").replace(/&gt;/mg,">").replace(/&quot;/mg,"\"").replace(/&amp;/mg,"&");
};

// Parse a space-separated string of name:value parameters
// The result is an array of objects:
//   result[0] = object with a member for each parameter name, value of that member being an array of values
//   result[1..n] = one object for each parameter, with 'name' and 'value' members
String.prototype.parseParams = function(defaultName,defaultValue,allowEval,noNames,cascadeDefaults)
{
	var parseToken = function(match,p) {
		var n;
		if(match[p]) // Double quoted
			n = match[p];
		else if(match[p+1]) // Single quoted
			n = match[p+1];
		else if(match[p+2]) // Double-square-bracket quoted
			n = match[p+2];
		else if(match[p+3]) // Double-brace quoted
			try {
				n = match[p+3];
				if(allowEval && config.evaluateMacroParameters != "none") {
					if(config.evaluateMacroParameters == "restricted") {
						if(window.restrictedEval) {
							n = window.restrictedEval(n);
						}
					} else {
						n = window.eval(n);
					}
				}
			} catch(ex) {
				throw "Unable to evaluate {{" + match[p+3] + "}}: " + exceptionText(ex);
			}
		else if(match[p+4]) // Unquoted
			n = match[p+4];
		else if(match[p+5]) // empty quote
			n = "";
		return n;
	};
	var r = [{}];
	var dblQuote = "(?:\"((?:(?:\\\\\")|[^\"])+)\")";
	var sngQuote = "(?:'((?:(?:\\\\\')|[^'])+)')";
	var dblSquare = "(?:\\[\\[((?:\\s|\\S)*?)\\]\\])";
	var dblBrace = "(?:\\{\\{((?:\\s|\\S)*?)\\}\\})";
	var unQuoted = noNames ? "([^\"'\\s]\\S*)" : "([^\"':\\s][^\\s:]*)";
	var emptyQuote = "((?:\"\")|(?:''))";
	var skipSpace = "(?:\\s*)";
	var token = "(?:" + dblQuote + "|" + sngQuote + "|" + dblSquare + "|" + dblBrace + "|" + unQuoted + "|" + emptyQuote + ")";
	var re = noNames ? new RegExp(token,"mg") : new RegExp(skipSpace + token + skipSpace + "(?:(\\:)" + skipSpace + token + ")?","mg");
	var match;
	do {
		match = re.exec(this);
		if(match) {
			var n = parseToken(match,1);
			if(noNames) {
				r.push({name:"",value:n});
			} else {
				var v = parseToken(match,8);
				if(v == null && defaultName) {
					v = n;
					n = defaultName;
				} else if(v == null && defaultValue) {
					v = defaultValue;
				}
				r.push({name:n,value:v});
				if(cascadeDefaults) {
					defaultName = n;
					defaultValue = v;
				}
			}
		}
	} while(match);
	// Summarise parameters into first element
	var t;
	for(t=1; t<r.length; t++) {
		if(r[0][r[t].name])
			r[0][r[t].name].push(r[t].value);
		else
			r[0][r[t].name] = [r[t].value];
	}
	return r;
};

// Process a string list of macro parameters into an array. Parameters can be quoted with "", '',
// [[]], {{ }} or left unquoted (and therefore space-separated). Double-braces {{}} results in
// an *evaluated* parameter: e.g. {{config.options.txtUserName}} results in the current user's name.
String.prototype.readMacroParams = function(notAllowEval)
{
	var p = this.parseParams("list",null,!notAllowEval,true);
	var t,n = [];
	for(t=1; t<p.length; t++)
		n.push(p[t].value);
	return n;
};

// Process a string list of unique tiddler names into an array. Tiddler names that have spaces in them must be [[bracketed]]
String.prototype.readBracketedList = function(unique)
{
	var p = this.parseParams("list",null,false,true);
	var t,n = [];
	for(t=1; t<p.length; t++) {
		if(p[t].value)
			n.pushUnique(p[t].value,unique);
	}
	return n;
};

// Returns array with start and end index of chunk between given start and end marker, or undefined.
String.prototype.getChunkRange = function(start,end)
{
	var s = this.indexOf(start);
	if(s != -1) {
		s += start.length;
		var e = this.indexOf(end,s);
		if(e != -1)
			return [s,e];
	}
};

// Replace a chunk of a string given start and end markers
String.prototype.replaceChunk = function(start,end,sub)
{
	var r = this.getChunkRange(start,end);
	return r ? this.substring(0,r[0]) + sub + this.substring(r[1]) : this;
};

// Returns a chunk of a string between start and end markers, or undefined
String.prototype.getChunk = function(start,end)
{
	var r = this.getChunkRange(start,end);
	if(r)
		return this.substring(r[0],r[1]);
};


// Static method to bracket a string with double square brackets if it contains a space
String.encodeTiddlyLink = function(title)
{
	return title.indexOf(" ") == -1 ? title : "[[" + title + "]]";
};

// Static method to encodeTiddlyLink for every item in an array and join them with spaces
String.encodeTiddlyLinkList = function(list)
{
	if(list) {
		var t,results = [];
		for(t=0; t<list.length; t++)
			results.push(String.encodeTiddlyLink(list[t]));
		return results.join(" ");
	} else {
		return "";
	}
};

// Convert a string as a sequence of name:"value" pairs into a hashmap
String.prototype.decodeHashMap = function()
{
	var fields = this.parseParams("anon","",false);
	var t,r = {};
	for(t=1; t<fields.length; t++)
		r[fields[t].name] = fields[t].value;
	return r;
};

// Static method to encode a hashmap into a name:"value"... string
String.encodeHashMap = function(hashmap)
{
	var t,r = [];
	for(t in hashmap)
		r.push(t + ':"' + hashmap[t] + '"');
	return r.join(" ");
};

// Static method to left-pad a string with 0s to a certain width
String.zeroPad = function(n,d)
{
	var s = n.toString();
	if(s.length < d)
		s = "000000000000000000000000000".substr(0,d-s.length) + s;
	return s;
};

String.prototype.startsWith = function(prefix)
{
	return !prefix || this.substring(0,prefix.length) == prefix;
};

// Returns the first value of the given named parameter.
function getParam(params,name,defaultValue)
{
	if(!params)
		return defaultValue;
	var p = params[0][name];
	return p ? p[0] : defaultValue;
}

// Returns the first value of the given boolean named parameter.
function getFlag(params,name,defaultValue)
{
	return !!getParam(params,name,defaultValue);
}


//--
//-- Augmented methods for the JavaScript Date() object
//--

// Substitute date components into a string
Date.prototype.formatString = function(template)
{
	var t = template.replace(/0hh12/g,String.zeroPad(this.getHours12(),2));
	t = t.replace(/hh12/g,this.getHours12());
	t = t.replace(/0hh/g,String.zeroPad(this.getHours(),2));
	t = t.replace(/hh/g,this.getHours());
	t = t.replace(/mmm/g,config.messages.dates.shortMonths[this.getMonth()]);
	t = t.replace(/0mm/g,String.zeroPad(this.getMinutes(),2));
	t = t.replace(/mm/g,this.getMinutes());
	t = t.replace(/0ss/g,String.zeroPad(this.getSeconds(),2));
	t = t.replace(/ss/g,this.getSeconds());
	t = t.replace(/[ap]m/g,this.getAmPm().toLowerCase());
	t = t.replace(/[AP]M/g,this.getAmPm().toUpperCase());
	t = t.replace(/wYYYY/g,this.getYearForWeekNo());
	t = t.replace(/wYY/g,String.zeroPad(this.getYearForWeekNo()-2000,2));
	t = t.replace(/YYYY/g,this.getFullYear());
	t = t.replace(/YY/g,String.zeroPad(this.getFullYear()-2000,2));
	t = t.replace(/MMM/g,config.messages.dates.months[this.getMonth()]);
	t = t.replace(/0MM/g,String.zeroPad(this.getMonth()+1,2));
	t = t.replace(/MM/g,this.getMonth()+1);
	t = t.replace(/0WW/g,String.zeroPad(this.getWeek(),2));
	t = t.replace(/WW/g,this.getWeek());
	t = t.replace(/DDD/g,config.messages.dates.days[this.getDay()]);
	t = t.replace(/ddd/g,config.messages.dates.shortDays[this.getDay()]);
	t = t.replace(/0DD/g,String.zeroPad(this.getDate(),2));
	t = t.replace(/DDth/g,this.getDate()+this.daySuffix());
	t = t.replace(/DD/g,this.getDate());
	var tz = this.getTimezoneOffset();
	var atz = Math.abs(tz);
	t = t.replace(/TZD/g,(tz < 0 ? '+' : '-') + String.zeroPad(Math.floor(atz / 60),2) + ':' + String.zeroPad(atz % 60,2));
	t = t.replace(/\\/g,"");
	return t;
};

Date.prototype.getWeek = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week to calculate weekNo
	var n = Math.floor((dt.getTime()-new Date(dt.getFullYear(),0,1)+3600000)/86400000);
	return Math.floor(n/7)+1;
};

Date.prototype.getYearForWeekNo = function()
{
	var dt = new Date(this.getTime());
	var d = dt.getDay();
	if(d==0) d=7;// JavaScript Sun=0, ISO Sun=7
	dt.setTime(dt.getTime()+(4-d)*86400000);// shift day to Thurs of same week
	return dt.getFullYear();
};

Date.prototype.getHours12 = function()
{
	var h = this.getHours();
	return h > 12 ? h-12 : ( h > 0 ? h : 12 );
};

Date.prototype.getAmPm = function()
{
	return this.getHours() >= 12 ? config.messages.dates.pm : config.messages.dates.am;
};

Date.prototype.daySuffix = function()
{
	return config.messages.dates.daySuffixes[this.getDate()-1];
};

// Convert a date to local YYYYMMDDHHMM string format
Date.prototype.convertToLocalYYYYMMDDHHMM = function()
{
	return this.getFullYear() + String.zeroPad(this.getMonth()+1,2) + String.zeroPad(this.getDate(),2) + String.zeroPad(this.getHours(),2) + String.zeroPad(this.getMinutes(),2);
};

// Convert a date to UTC YYYYMMDDHHMM string format
Date.prototype.convertToYYYYMMDDHHMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2);
};

// Convert a date to UTC YYYYMMDD.HHMMSSMMM string format
Date.prototype.convertToYYYYMMDDHHMMSSMMM = function()
{
	return this.getUTCFullYear() + String.zeroPad(this.getUTCMonth()+1,2) + String.zeroPad(this.getUTCDate(),2) + "." + String.zeroPad(this.getUTCHours(),2) + String.zeroPad(this.getUTCMinutes(),2) + String.zeroPad(this.getUTCSeconds(),2) + String.zeroPad(this.getUTCMilliseconds(),3) +"0";
};

// Static method to create a date from a UTC YYYYMMDDHHMM format string
Date.convertFromYYYYMMDDHHMM = function(d)
{
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,12));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSS format string
Date.convertFromYYYYMMDDHHMMSS = function(d)
{
	d = d?d.replace(/[^0-9]/g, ""):"";
	return Date.convertFromYYYYMMDDHHMMSSMMM(d.substr(0,14));
};

// Static method to create a date from a UTC YYYYMMDDHHMMSSMMM format string
Date.convertFromYYYYMMDDHHMMSSMMM = function(d)
{
	d = d ? d.replace(/[^0-9]/g, "") : "";
	return new Date(Date.UTC(parseInt(d.substr(0,4),10),
			parseInt(d.substr(4,2),10)-1,
			parseInt(d.substr(6,2),10),
			parseInt(d.substr(8,2)||"00",10),
			parseInt(d.substr(10,2)||"00",10),
			parseInt(d.substr(12,2)||"00",10),
			parseInt(d.substr(14,3)||"000",10)));
};


//--
//-- RGB colour object
//--

// Construct an RGB colour object from a '#rrggbb', '#rgb' or 'rgb(n,n,n)' string or from separate r,g,b values
function RGB(r,g,b)
{
	this.r = 0;
	this.g = 0;
	this.b = 0;
	if(typeof r == "string") {
		if(r.substr(0,1) == "#") {
			if(r.length == 7) {
				this.r = parseInt(r.substr(1,2),16)/255;
				this.g = parseInt(r.substr(3,2),16)/255;
				this.b = parseInt(r.substr(5,2),16)/255;
			} else {
				this.r = parseInt(r.substr(1,1),16)/15;
				this.g = parseInt(r.substr(2,1),16)/15;
				this.b = parseInt(r.substr(3,1),16)/15;
			}
		} else {
			var rgbPattern = /rgb\s*\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)/;
			var c = r.match(rgbPattern);
			if(c) {
				this.r = parseInt(c[1],10)/255;
				this.g = parseInt(c[2],10)/255;
				this.b = parseInt(c[3],10)/255;
			}
		}
	} else {
		this.r = r;
		this.g = g;
		this.b = b;
	}
	return this;
}

// Mixes this colour with another in a specified proportion
// c = other colour to mix
// f = 0..1 where 0 is this colour and 1 is the new colour
// Returns an RGB object
RGB.prototype.mix = function(c,f)
{
	return new RGB(this.r + (c.r-this.r) * f,this.g + (c.g-this.g) * f,this.b + (c.b-this.b) * f);
};

// Return an rgb colour as a #rrggbb format hex string
RGB.prototype.toString = function()
{
	var clamp = function(x,min,max) {
		return x < min ? min : (x > max ? max : x);
	};
	return "#" +
			("0" + Math.floor(clamp(this.r,0,1) * 255).toString(16)).right(2) +
			("0" + Math.floor(clamp(this.g,0,1) * 255).toString(16)).right(2) +
			("0" + Math.floor(clamp(this.b,0,1) * 255).toString(16)).right(2);
};


//--
//-- DOM utilities - many derived from www.quirksmode.org
//--

function drawGradient(place,horiz,locolors,hicolors)
{
	if(!hicolors)
		hicolors = locolors;
	var t;
	for(t=0; t<= 100; t+=2) {
		var bar = document.createElement("div");
		place.appendChild(bar);
		bar.style.position = "absolute";
		bar.style.left = horiz ? t + "%" : 0;
		bar.style.top = horiz ? 0 : t + "%";
		bar.style.width = horiz ? (101-t) + "%" : "100%";
		bar.style.height = horiz ? "100%" : (101-t) + "%";
		bar.style.zIndex = -1;
		var p = t/100*(locolors.length-1);
		var hc = hicolors[Math.floor(p)];
		if(typeof hc == "string")
			hc = new RGB(hc);
		var lc = locolors[Math.ceil(p)];
		if(typeof lc == "string")
			lc = new RGB(lc);
		bar.style.backgroundColor = hc.mix(lc,p-Math.floor(p)).toString();
	}
}

function addEvent(obj,type,fn)
{
	if(obj.attachEvent) {
		obj["e"+type+fn] = fn;
		obj[type+fn] = function(){obj["e"+type+fn](window.event);};
		obj.attachEvent("on"+type,obj[type+fn]);
	} else {
		obj.addEventListener(type,fn,false);
	}
}

function removeEvent(obj,type,fn)
{
	if(obj.detachEvent) {
		obj.detachEvent("on"+type,obj[type+fn]);
		obj[type+fn] = null;
	} else {
		obj.removeEventListener(type,fn,false);
	}
}

// Find the closest relative with a given property value (property defaults to tagName, relative defaults to parentNode)
function findRelated(e,value,name,relative)
{
	name = name || "tagName";
	relative = relative || "parentNode";
	if(name == "className") {
		while(e && !jQuery(e).hasClass(value)) {
			e = e[relative];
		}
	} else {
		while(e && e[name] != value) {
			e = e[relative];
		}
	}
	return e;
}

// Get the scroll position for window.scrollTo necessary to scroll a given element into view
function ensureVisible(e)
{
	var posTop = findPosY(e);
	var posBot = posTop + e.offsetHeight;
	var winTop = findScrollY();
	var winHeight = findWindowHeight();
	var winBot = winTop + winHeight;
	if(posTop < winTop) {
		return posTop;
	} else if(posBot > winBot) {
		if(e.offsetHeight < winHeight)
			return posTop - (winHeight - e.offsetHeight);
		else
			return posTop;
	} else {
		return winTop;
	}
}

// Get the current width of the display window
function findWindowWidth()
{
	return window.innerWidth || document.documentElement.clientWidth;
}

// Get the current height of the display window
function findWindowHeight()
{
	return window.innerHeight || document.documentElement.clientHeight;
}

// Get the current height of the document
function findDocHeight() {
    var D = document;
    return Math.max(
        Math.max(D.body.scrollHeight, D.documentElement.scrollHeight),
        Math.max(D.body.offsetHeight, D.documentElement.offsetHeight),
        Math.max(D.body.clientHeight, D.documentElement.clientHeight)
    );
}

// Get the current horizontal page scroll position
function findScrollX()
{
	return window.scrollX || document.documentElement.scrollLeft;
}

// Get the current vertical page scroll position
function findScrollY()
{
	return window.scrollY || document.documentElement.scrollTop;
}

function findPosX(obj)
{
	var curleft = 0;
	while(obj.offsetParent) {
		curleft += obj.offsetLeft;
		obj = obj.offsetParent;
	}
	return curleft;
}

function findPosY(obj)
{
	var curtop = 0;
	while(obj.offsetParent) {
		curtop += obj.offsetTop;
		obj = obj.offsetParent;
	}
	return curtop;
}

// Blur a particular element
function blurElement(e)
{
	if(e && e.focus && e.blur) {
		e.focus();
		e.blur();
	}
}

// Create a non-breaking space
function insertSpacer(place)
{
	var e = document.createTextNode(String.fromCharCode(160));
	if(place)
		place.appendChild(e);
	return e;
}

// Replace the current selection of a textarea or text input and scroll it into view
function replaceSelection(e,text)
{
	if(e.setSelectionRange) {
		var oldpos = e.selectionStart;
		var isRange = e.selectionEnd > e.selectionStart;
		e.value = e.value.substr(0,e.selectionStart) + text + e.value.substr(e.selectionEnd);
		e.setSelectionRange(isRange ? oldpos : oldpos + text.length,oldpos + text.length);
		var linecount = e.value.split("\n").length;
		var thisline = e.value.substr(0,e.selectionStart).split("\n").length-1;
		e.scrollTop = Math.floor((thisline - e.rows / 2) * e.scrollHeight / linecount);
	} else if(document.selection) {
		var range = document.selection.createRange();
		if(range.parentElement() == e) {
			var isCollapsed = range.text == "";
			range.text = text;
			if(!isCollapsed) {
				range.moveStart("character", -text.length);
				range.select();
			}
		}
	}
}

// Set the caret position in a text area
function setCaretPosition(e,pos)
{
	if(e.selectionStart || e.selectionStart == '0') {
		e.selectionStart = pos;
		e.selectionEnd = pos;
		e.focus();
	} else if(document.selection) {
		// IE support
		e.focus ();
		var sel = document.selection.createRange();
		sel.moveStart('character', -e.value.length);
		sel.moveStart('character',pos);
		sel.moveEnd('character',0);
		sel.select();
	}
}

// Returns the text of the given (text) node, possibly merging subsequent text nodes
function getNodeText(e)
{
	var t = "";
	while(e && e.nodeName == "#text") {
		t += e.nodeValue;
		e = e.nextSibling;
	}
	return t;
}

// Returns true if the element e has a given ancestor element
function isDescendant(e,ancestor)
{
	while(e) {
		if(e === ancestor)
			return true;
		e = e.parentNode;
	}
	return false;
}


// deprecate the following...

// Prevent an event from bubbling
function stopEvent(e)
{
	var ev = e || window.event;
	ev.cancelBubble = true;
	if(ev.stopPropagation) ev.stopPropagation();
	return false;
}

// Remove any event handlers or non-primitve custom attributes
function scrubNode(e)
{
	if(!config.browser.isIE)
		return;
	var att = e.attributes;
	if(att) {
		var t;
		for(t=0; t<att.length; t++) {
			var n = att[t].name;
			if(n !== "style" && (typeof e[n] === "function" || (typeof e[n] === "object" && e[n] != null))) {
				try {
					e[n] = null;
				} catch(ex) {
				}
			}
		}
	}
	var c = e.firstChild;
	while(c) {
		scrubNode(c);
		c = c.nextSibling;
	}
}

function setStylesheet(s,id,doc)
{
	jQuery.twStylesheet(s,{id:id,doc:doc});
}

function removeStyleSheet(id)
{
	jQuery.twStylesheet.remove({id:id});
}


//--
//-- LoaderBase and SaverBase
//--

function LoaderBase() {}

LoaderBase.prototype.loadTiddler = function(store,node,tiddlers)
{
	var title = this.getTitle(store,node);
	if(safeMode && store.isShadowTiddler(title))
		return;
	if(title) {
		var tiddler = store.createTiddler(title);
		this.internalizeTiddler(store,tiddler,title,node);
		tiddlers.push(tiddler);
	}
};

LoaderBase.prototype.loadTiddlers = function(store,nodes)
{
	var t,tiddlers = [];
	for(t = 0; t < nodes.length; t++) {
		try {
			this.loadTiddler(store,nodes[t],tiddlers);
		} catch(ex) {
			showException(ex,config.messages.tiddlerLoadError.format([this.getTitle(store,nodes[t])]));
		}
	}
	return tiddlers;
};

function SaverBase() {}

SaverBase.prototype.externalize = function(store)
{
	var results = [];
	var t,tiddlers = store.getTiddlers("title");
	for(t = 0; t < tiddlers.length; t++) {
		if(!tiddlers[t].doNotSave())
			results.push(this.externalizeTiddler(store, tiddlers[t]));
	}
	return results.join("\n");
};


//--
//-- TW21Loader (inherits from LoaderBase)
//--

function TW21Loader() {}

TW21Loader.prototype = new LoaderBase();

TW21Loader.prototype.getTitle = function(store,node)
{
	var title = null;
	if(node.getAttribute) {
		title = node.getAttribute("title");
		if(!title)
			title = node.getAttribute("tiddler");
	}
	if(!title && node.id) {
		var lenPrefix = store.idPrefix.length;
		if(node.id.substr(0,lenPrefix) == store.idPrefix)
			title = node.id.substr(lenPrefix);
	}
	return title;
};

TW21Loader.prototype.internalizeTiddler = function(store,tiddler,title,node)
{
	var e = node.firstChild;
	var text = null;
	if(node.getAttribute("tiddler")) {
		text = getNodeText(e).unescapeLineBreaks();
	} else {
		while(e.nodeName!="PRE" && e.nodeName!="pre") {
			e = e.nextSibling;
		}
		text = e.innerHTML.replace(/\r/mg,"").htmlDecode();
	}
	var creator = node.getAttribute("creator");
	var modifier = node.getAttribute("modifier");
	var c = node.getAttribute("created");
	var m = node.getAttribute("modified");
	var created = c ? Date.convertFromYYYYMMDDHHMMSS(c) : version.date;
	var modified = m ? Date.convertFromYYYYMMDDHHMMSS(m) : created;
	var tags = node.getAttribute("tags");
	var fields = {};
	var i,attrs = node.attributes;
	for(i = attrs.length-1; i >= 0; i--) {
		var name = attrs[i].name;
		if(attrs[i].specified && !TiddlyWiki.isStandardField(name)) {
			fields[name] = attrs[i].value.unescapeLineBreaks();
		}
	}
	tiddler.assign(title,text,modifier,modified,tags,created,fields,creator);
	return tiddler;
};


//--
//-- TW21Saver (inherits from SaverBase)
//--

function TW21Saver() {}

TW21Saver.prototype = new SaverBase();

TW21Saver.prototype.externalizeTiddler = function(store,tiddler)
{
	try {
		var extendedAttributes = "";
		var usePre = config.options.chkUsePreForStorage;
		store.forEachField(tiddler,
			function(tiddler,fieldName,value) {
				// don't store stuff from the temp namespace
				if(typeof value != "string")
					value = "";
				if(!fieldName.match(/^temp\./))
					extendedAttributes += ' %0="%1"'.format([fieldName,value.escapeLineBreaks().htmlEncode()]);
			},true);
		var created = tiddler.created;
		var modified = tiddler.modified;
		var attributes = tiddler.creator ? ' creator="' + tiddler.creator.htmlEncode() + '"' : "";
		attributes += tiddler.modifier ? ' modifier="' + tiddler.modifier.htmlEncode() + '"' : "";
		attributes += (usePre && created == version.date) ? "" :' created="' + created.convertToYYYYMMDDHHMM() + '"';
		attributes += (usePre && modified == created) ? "" : ' modified="' + modified.convertToYYYYMMDDHHMM() +'"';
		var tags = tiddler.getTags();
		if(!usePre || tags)
			attributes += ' tags="' + tags.htmlEncode() + '"';
		return ('<div %0="%1"%2%3>%4</'+'div>').format([
				usePre ? "title" : "tiddler",
				tiddler.title.htmlEncode(),
				attributes,
				extendedAttributes,
				usePre ? "\n<pre>" + tiddler.text.htmlEncode() + "</pre>\n" : tiddler.text.escapeLineBreaks().htmlEncode()
			]);
	} catch (ex) {
		throw exceptionText(ex,config.messages.tiddlerSaveError.format([tiddler.title]));
	}
};

//]]>
</script>
<script id="jsdeprecatedArea" type="text/javascript">
//<![CDATA[
//--
//-- Deprecated Crypto functions and associated conversion routines.
//-- Use the jQuery.encoding functions directly instead.
//--

// Crypto 'namespace'
function Crypto() {}

// Convert a string to an array of big-endian 32-bit words
Crypto.strToBe32s = function(str)
{
	return jQuery.encoding.strToBe32s(str);
};

// Convert an array of big-endian 32-bit words to a string
Crypto.be32sToStr = function(be)
{
	return jQuery.encoding.be32sToStr(be);
};

// Convert an array of big-endian 32-bit words to a hex string
Crypto.be32sToHex = function(be)
{
	return jQuery.encoding.be32sToHex(be);
};

// Return, in hex, the SHA-1 hash of a string
Crypto.hexSha1Str = function(str)
{
	return jQuery.encoding.digests.hexSha1Str(str);
};

// Return the SHA-1 hash of a string
Crypto.sha1Str = function(str)
{
	return jQuery.encoding.digests.sha1Str(str);
};

// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
Crypto.sha1 = function(x,blen)
{
	return jQuery.encoding.digests.sha1(x,blen);
};


//--
//-- Deprecated code
//--

// @Deprecated: Use createElementAndWikify and this.termRegExp instead
config.formatterHelpers.charFormatHelper = function(w)
{
	w.subWikify(createTiddlyElement(w.output,this.element),this.terminator);
};

// @Deprecated: Use enclosedTextHelper and this.lookaheadRegExp instead
config.formatterHelpers.monospacedByLineHelper = function(w)
{
	var lookaheadRegExp = new RegExp(this.lookahead,"mg");
	lookaheadRegExp.lastIndex = w.matchStart;
	var lookaheadMatch = lookaheadRegExp.exec(w.source);
	if(lookaheadMatch && lookaheadMatch.index == w.matchStart) {
		var text = lookaheadMatch[1];
		if(config.browser.isIE)
			text = text.replace(/\n/g,"\r");
		createTiddlyElement(w.output,"pre",null,null,text);
		w.nextMatch = lookaheadRegExp.lastIndex;
	}
};

// @Deprecated: Use <br> or <br /> instead of <<br>>
config.macros.br = {};
config.macros.br.handler = function(place)
{
	createTiddlyElement(place,"br");
};

// Find an entry in an array. Returns the array index or null
// @Deprecated: Use indexOf instead
Array.prototype.find = function(item)
{
	var i = this.indexOf(item);
	return i == -1 ? null : i;
};

// Load a tiddler from an HTML DIV. The caller should make sure to later call Tiddler.changed()
// @Deprecated: Use store.getLoader().internalizeTiddler instead
Tiddler.prototype.loadFromDiv = function(divRef,title)
{
	return store.getLoader().internalizeTiddler(store,this,title,divRef);
};

// Format the text for storage in an HTML DIV
// @Deprecated Use store.getSaver().externalizeTiddler instead.
Tiddler.prototype.saveToDiv = function()
{
	return store.getSaver().externalizeTiddler(store,this);
};

// @Deprecated: Use store.allTiddlersAsHtml() instead
function allTiddlersAsHtml()
{
	return store.allTiddlersAsHtml();
}

// @Deprecated: Use refreshPageTemplate instead
function applyPageTemplate(title)
{
	refreshPageTemplate(title);
}

// @Deprecated: Use story.displayTiddlers instead
function displayTiddlers(srcElement,titles,template,unused1,unused2,animate,unused3)
{
	story.displayTiddlers(srcElement,titles,template,animate);
}

// @Deprecated: Use story.displayTiddler instead
function displayTiddler(srcElement,title,template,unused1,unused2,animate,unused3)
{
	story.displayTiddler(srcElement,title,template,animate);
}

// @Deprecated: Use functions on right hand side directly instead
var createTiddlerPopup = Popup.create;
var scrollToTiddlerPopup = Popup.show;
var hideTiddlerPopup = Popup.remove;

// @Deprecated: Use right hand side directly instead
var regexpBackSlashEn = new RegExp("\\\\n","mg");
var regexpBackSlash = new RegExp("\\\\","mg");
var regexpBackSlashEss = new RegExp("\\\\s","mg");
var regexpNewLine = new RegExp("\n","mg");
var regexpCarriageReturn = new RegExp("\r","mg");


//--
//-- Deprecated FileAdaptor functions
//--

FileAdaptor.loadTiddlyWikiCallback = function(status,context,responseText,url,xhr)
{
	context.status = status;
	if(!status) {
		context.statusText = "Error reading file";
	} else {
		context.adaptor.store = new TiddlyWiki();
		if(!context.adaptor.store.importTiddlyWiki(responseText)) {
			context.statusText = config.messages.invalidFileError.format([url]);
			context.status = false;
		}
	}
	context.complete(context,context.userParams);
};


//--
//-- Deprecated HTTP request code
//-- Use the jQuery ajax functions directly instead
//--

function loadRemoteFile(url,callback,params)
{
	return httpReq("GET",url,callback,params);
}

function doHttp(type,url,data,contentType,username,password,callback,params,headers,allowCache)
{
	return httpReq(type,url,callback,params,headers,data,contentType,username,password,allowCache);
}


//--
//-- Deprecated String functions
//--

// @Deprecated: no direct replacement, since not used in core code
String.prototype.toJSONString = function()
{
	// Convert a string to it's JSON representation by encoding control characters, double quotes and backslash. See json.org
	var m = {
		'\b': '\\b',
		'\f': '\\f',
		'\n': '\\n',
		'\r': '\\r',
		'\t': '\\t',
		'"' : '\\"',
		'\\': '\\\\'
		};
	var replaceFn = function(a,b) {
		var c = m[b];
		if(c)
			return c;
		c = b.charCodeAt();
		return '\\u00' + Math.floor(c / 16).toString(16) + (c % 16).toString(16);
		};
	if(/["\\\x00-\x1f]/.test(this))
		return '"' + this.replace(/([\x00-\x1f\\"])/g,replaceFn) + '"';
	return '"' + this + '"';
};


//--
//-- Deprecated Tiddler code
//--

// @Deprecated: Use tiddlerToRssItem(tiddler,uri) instead
Tiddler.prototype.toRssItem = function(uri)
{
	return tiddlerToRssItem(this,uri);
};

// @Deprecated: Use "<item>\n" + tiddlerToRssItem(tiddler,uri)  + "\n</item>" instead
Tiddler.prototype.saveToRss = function(uri)
{
	return "<item>\n" + tiddlerToRssItem(this,uri) + "\n</item>";
};

// @Deprecated: Use jQuery.encoding.digests.hexSha1Str instead
Tiddler.prototype.generateFingerprint = function()
{
	return "0x" + Crypto.hexSha1Str(this.text);
};


//--
//-- Deprecated Number functions
//--

// @Deprecated: no direct replacement, since not used in core code
// Clamp a number to a range
Number.prototype.clamp = function(min,max)
{
	var c = this;
	if(c < min)
		c = min;
	if(c > max)
		c = max;
	return Number(c);
};


//--
//-- Deprecated utility functions
//-- Use the jQuery functions directly instead
//--

// Remove all children of a node
function removeChildren(e)
{
	jQuery(e).empty();
}

// Remove a node and all it's children
function removeNode(e)
{
	jQuery(e).remove();
}

// Return the content of an element as plain text with no formatting
function getPlainText(e)
{
	return jQuery(e).text();
}

function addClass(e,className)
{
	jQuery(e).addClass(className);
}

function removeClass(e,className)
{
	jQuery(e).removeClass(className);
}

function hasClass(e,className)
{
	return jQuery(e).hasClass(className);
}


//--
//-- Deprecated Wikifier code
//--

function wikifyPlain(title,theStore,limit)
{
	if(!theStore)
		theStore = store;
	if(theStore.tiddlerExists(title) || theStore.isShadowTiddler(title)) {
		return wikifyPlainText(theStore.getTiddlerText(title),limit,tiddler);
	} else {
		return "";
	}
}

//]]>
</script>
<script id="jslibArea" type="text/javascript">
//<![CDATA[
/*! jQuery v@1.8.1 jquery.com | jquery.org/license */
(function(a,b){function G(a){var b=F[a]={};return p.each(a.split(s),function(a,c){b[c]=!0}),b}function J(a,c,d){if(d===b&&a.nodeType===1){var e="data-"+c.replace(I,"-$1").toLowerCase();d=a.getAttribute(e);if(typeof d=="string"){try{d=d==="true"?!0:d==="false"?!1:d==="null"?null:+d+""===d?+d:H.test(d)?p.parseJSON(d):d}catch(f){}p.data(a,c,d)}else d=b}return d}function K(a){var b;for(b in a){if(b==="data"&&p.isEmptyObject(a[b]))continue;if(b!=="toJSON")return!1}return!0}function ba(){return!1}function bb(){return!0}function bh(a){return!a||!a.parentNode||a.parentNode.nodeType===11}function bi(a,b){do a=a[b];while(a&&a.nodeType!==1);return a}function bj(a,b,c){b=b||0;if(p.isFunction(b))return p.grep(a,function(a,d){var e=!!b.call(a,d,a);return e===c});if(b.nodeType)return p.grep(a,function(a,d){return a===b===c});if(typeof b=="string"){var d=p.grep(a,function(a){return a.nodeType===1});if(be.test(b))return p.filter(b,d,!c);b=p.filter(b,d)}return p.grep(a,function(a,d){return p.inArray(a,b)>=0===c})}function bk(a){var b=bl.split("|"),c=a.createDocumentFragment();if(c.createElement)while(b.length)c.createElement(b.pop());return c}function bC(a,b){return a.getElementsByTagName(b)[0]||a.appendChild(a.ownerDocument.createElement(b))}function bD(a,b){if(b.nodeType!==1||!p.hasData(a))return;var c,d,e,f=p._data(a),g=p._data(b,f),h=f.events;if(h){delete g.handle,g.events={};for(c in h)for(d=0,e=h[c].length;d<e;d++)p.event.add(b,c,h[c][d])}g.data&&(g.data=p.extend({},g.data))}function bE(a,b){var c;if(b.nodeType!==1)return;b.clearAttributes&&b.clearAttributes(),b.mergeAttributes&&b.mergeAttributes(a),c=b.nodeName.toLowerCase(),c==="object"?(b.parentNode&&(b.outerHTML=a.outerHTML),p.support.html5Clone&&a.innerHTML&&!p.trim(b.innerHTML)&&(b.innerHTML=a.innerHTML)):c==="input"&&bv.test(a.type)?(b.defaultChecked=b.checked=a.checked,b.value!==a.value&&(b.value=a.value)):c==="option"?b.selected=a.defaultSelected:c==="input"||c==="textarea"?b.defaultValue=a.defaultValue:c==="script"&&b.text!==a.text&&(b.text=a.text),b.removeAttribute(p.expando)}function bF(a){return typeof a.getElementsByTagName!="undefined"?a.getElementsByTagName("*"):typeof a.querySelectorAll!="undefined"?a.querySelectorAll("*"):[]}function bG(a){bv.test(a.type)&&(a.defaultChecked=a.checked)}function bY(a,b){if(b in a)return b;var c=b.charAt(0).toUpperCase()+b.slice(1),d=b,e=bW.length;while(e--){b=bW[e]+c;if(b in a)return b}return d}function bZ(a,b){return a=b||a,p.css(a,"display")==="none"||!p.contains(a.ownerDocument,a)}function b$(a,b){var c,d,e=[],f=0,g=a.length;for(;f<g;f++){c=a[f];if(!c.style)continue;e[f]=p._data(c,"olddisplay"),b?(!e[f]&&c.style.display==="none"&&(c.style.display=""),c.style.display===""&&bZ(c)&&(e[f]=p._data(c,"olddisplay",cc(c.nodeName)))):(d=bH(c,"display"),!e[f]&&d!=="none"&&p._data(c,"olddisplay",d))}for(f=0;f<g;f++){c=a[f];if(!c.style)continue;if(!b||c.style.display==="none"||c.style.display==="")c.style.display=b?e[f]||"":"none"}return a}function b_(a,b,c){var d=bP.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function ca(a,b,c,d){var e=c===(d?"border":"content")?4:b==="width"?1:0,f=0;for(;e<4;e+=2)c==="margin"&&(f+=p.css(a,c+bV[e],!0)),d?(c==="content"&&(f-=parseFloat(bH(a,"padding"+bV[e]))||0),c!=="margin"&&(f-=parseFloat(bH(a,"border"+bV[e]+"Width"))||0)):(f+=parseFloat(bH(a,"padding"+bV[e]))||0,c!=="padding"&&(f+=parseFloat(bH(a,"border"+bV[e]+"Width"))||0));return f}function cb(a,b,c){var d=b==="width"?a.offsetWidth:a.offsetHeight,e=!0,f=p.support.boxSizing&&p.css(a,"boxSizing")==="border-box";if(d<=0||d==null){d=bH(a,b);if(d<0||d==null)d=a.style[b];if(bQ.test(d))return d;e=f&&(p.support.boxSizingReliable||d===a.style[b]),d=parseFloat(d)||0}return d+ca(a,b,c||(f?"border":"content"),e)+"px"}function cc(a){if(bS[a])return bS[a];var b=p("<"+a+">").appendTo(e.body),c=b.css("display");b.remove();if(c==="none"||c===""){bI=e.body.appendChild(bI||p.extend(e.createElement("iframe"),{frameBorder:0,width:0,height:0}));if(!bJ||!bI.createElement)bJ=(bI.contentWindow||bI.contentDocument).document,bJ.write("<!doctype html><html><body>"),bJ.close();b=bJ.body.appendChild(bJ.createElement(a)),c=bH(b,"display"),e.body.removeChild(bI)}return bS[a]=c,c}function ci(a,b,c,d){var e;if(p.isArray(b))p.each(b,function(b,e){c||ce.test(a)?d(a,e):ci(a+"["+(typeof e=="object"?b:"")+"]",e,c,d)});else if(!c&&p.type(b)==="object")for(e in b)ci(a+"["+e+"]",b[e],c,d);else d(a,b)}function cz(a){return function(b,c){typeof b!="string"&&(c=b,b="*");var d,e,f,g=b.toLowerCase().split(s),h=0,i=g.length;if(p.isFunction(c))for(;h<i;h++)d=g[h],f=/^\+/.test(d),f&&(d=d.substr(1)||"*"),e=a[d]=a[d]||[],e[f?"unshift":"push"](c)}}function cA(a,c,d,e,f,g){f=f||c.dataTypes[0],g=g||{},g[f]=!0;var h,i=a[f],j=0,k=i?i.length:0,l=a===cv;for(;j<k&&(l||!h);j++)h=i[j](c,d,e),typeof h=="string"&&(!l||g[h]?h=b:(c.dataTypes.unshift(h),h=cA(a,c,d,e,h,g)));return(l||!h)&&!g["*"]&&(h=cA(a,c,d,e,"*",g)),h}function cB(a,c){var d,e,f=p.ajaxSettings.flatOptions||{};for(d in c)c[d]!==b&&((f[d]?a:e||(e={}))[d]=c[d]);e&&p.extend(!0,a,e)}function cC(a,c,d){var e,f,g,h,i=a.contents,j=a.dataTypes,k=a.responseFields;for(f in k)f in d&&(c[k[f]]=d[f]);while(j[0]==="*")j.shift(),e===b&&(e=a.mimeType||c.getResponseHeader("content-type"));if(e)for(f in i)if(i[f]&&i[f].test(e)){j.unshift(f);break}if(j[0]in d)g=j[0];else{for(f in d){if(!j[0]||a.converters[f+" "+j[0]]){g=f;break}h||(h=f)}g=g||h}if(g)return g!==j[0]&&j.unshift(g),d[g]}function cD(a,b){var c,d,e,f,g=a.dataTypes.slice(),h=g[0],i={},j=0;a.dataFilter&&(b=a.dataFilter(b,a.dataType));if(g[1])for(c in a.converters)i[c.toLowerCase()]=a.converters[c];for(;e=g[++j];)if(e!=="*"){if(h!=="*"&&h!==e){c=i[h+" "+e]||i["* "+e];if(!c)for(d in i){f=d.split(" ");if(f[1]===e){c=i[h+" "+f[0]]||i["* "+f[0]];if(c){c===!0?c=i[d]:i[d]!==!0&&(e=f[0],g.splice(j--,0,e));break}}}if(c!==!0)if(c&&a["throws"])b=c(b);else try{b=c(b)}catch(k){return{state:"parsererror",error:c?k:"No conversion from "+h+" to "+e}}}h=e}return{state:"success",data:b}}function cL(){try{return new a.XMLHttpRequest}catch(b){}}function cM(){try{return new a.ActiveXObject("Microsoft.XMLHTTP")}catch(b){}}function cU(){return setTimeout(function(){cN=b},0),cN=p.now()}function cV(a,b){p.each(b,function(b,c){var d=(cT[b]||[]).concat(cT["*"]),e=0,f=d.length;for(;e<f;e++)if(d[e].call(a,b,c))return})}function cW(a,b,c){var d,e=0,f=0,g=cS.length,h=p.Deferred().always(function(){delete i.elem}),i=function(){var b=cN||cU(),c=Math.max(0,j.startTime+j.duration-b),d=1-(c/j.duration||0),e=0,f=j.tweens.length;for(;e<f;e++)j.tweens[e].run(d);return h.notifyWith(a,[j,d,c]),d<1&&f?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:p.extend({},b),opts:p.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:cN||cU(),duration:c.duration,tweens:[],createTween:function(b,c,d){var e=p.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(e),e},stop:function(b){var c=0,d=b?j.tweens.length:0;for(;c<d;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;cX(k,j.opts.specialEasing);for(;e<g;e++){d=cS[e].call(j,a,k,j.opts);if(d)return d}return cV(j,k),p.isFunction(j.opts.start)&&j.opts.start.call(a,j),p.fx.timer(p.extend(i,{anim:j,queue:j.opts.queue,elem:a})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}function cX(a,b){var c,d,e,f,g;for(c in a){d=p.camelCase(c),e=b[d],f=a[c],p.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=p.cssHooks[d];if(g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}}function cY(a,b,c){var d,e,f,g,h,i,j,k,l=this,m=a.style,n={},o=[],q=a.nodeType&&bZ(a);c.queue||(j=p._queueHooks(a,"fx"),j.unqueued==null&&(j.unqueued=0,k=j.empty.fire,j.empty.fire=function(){j.unqueued||k()}),j.unqueued++,l.always(function(){l.always(function(){j.unqueued--,p.queue(a,"fx").length||j.empty.fire()})})),a.nodeType===1&&("height"in b||"width"in b)&&(c.overflow=[m.overflow,m.overflowX,m.overflowY],p.css(a,"display")==="inline"&&p.css(a,"float")==="none"&&(!p.support.inlineBlockNeedsLayout||cc(a.nodeName)==="inline"?m.display="inline-block":m.zoom=1)),c.overflow&&(m.overflow="hidden",p.support.shrinkWrapBlocks||l.done(function(){m.overflow=c.overflow[0],m.overflowX=c.overflow[1],m.overflowY=c.overflow[2]}));for(d in b){f=b[d];if(cP.exec(f)){delete b[d];if(f===(q?"hide":"show"))continue;o.push(d)}}g=o.length;if(g){h=p._data(a,"fxshow")||p._data(a,"fxshow",{}),q?p(a).show():l.done(function(){p(a).hide()}),l.done(function(){var b;p.removeData(a,"fxshow",!0);for(b in n)p.style(a,b,n[b])});for(d=0;d<g;d++)e=o[d],i=l.createTween(e,q?h[e]:0),n[e]=h[e]||p.style(a,e),e in h||(h[e]=i.start,q&&(i.end=i.start,i.start=e==="width"||e==="height"?1:0))}}function cZ(a,b,c,d,e){return new cZ.prototype.init(a,b,c,d,e)}function c$(a,b){var c,d={height:a},e=0;b=b?1:0;for(;e<4;e+=2-b)c=bV[e],d["margin"+c]=d["padding"+c]=a;return b&&(d.opacity=d.width=a),d}function da(a){return p.isWindow(a)?a:a.nodeType===9?a.defaultView||a.parentWindow:!1}var c,d,e=a.document,f=a.location,g=a.navigator,h=a.jQuery,i=a.$,j=Array.prototype.push,k=Array.prototype.slice,l=Array.prototype.indexOf,m=Object.prototype.toString,n=Object.prototype.hasOwnProperty,o=String.prototype.trim,p=function(a,b){return new p.fn.init(a,b,c)},q=/[\-+]?(?:\d*\.|)\d+(?:[eE][\-+]?\d+|)/.source,r=/\S/,s=/\s+/,t=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,u=/^(?:[^#<]*(<[\w\W]+>)[^>]*$|#([\w\-]*)$)/,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^[\],:{}\s]*$/,x=/(?:^|:|,)(?:\s*\[)+/g,y=/\\(?:["\\\/bfnrt]|u[\da-fA-F]{4})/g,z=/"[^"\\\r\n]*"|true|false|null|-?(?:\d\d*\.|)\d+(?:[eE][\-+]?\d+|)/g,A=/^-ms-/,B=/-([\da-z])/gi,C=function(a,b){return(b+"").toUpperCase()},D=function(){e.addEventListener?(e.removeEventListener("DOMContentLoaded",D,!1),p.ready()):e.readyState==="complete"&&(e.detachEvent("onreadystatechange",D),p.ready())},E={};p.fn=p.prototype={constructor:p,init:function(a,c,d){var f,g,h,i;if(!a)return this;if(a.nodeType)return this.context=this[0]=a,this.length=1,this;if(typeof a=="string"){a.charAt(0)==="<"&&a.charAt(a.length-1)===">"&&a.length>=3?f=[null,a,null]:f=u.exec(a);if(f&&(f[1]||!c)){if(f[1])return c=c instanceof p?c[0]:c,i=c&&c.nodeType?c.ownerDocument||c:e,a=p.parseHTML(f[1],i,!0),v.test(f[1])&&p.isPlainObject(c)&&this.attr.call(a,c,!0),p.merge(this,a);g=e.getElementById(f[2]);if(g&&g.parentNode){if(g.id!==f[2])return d.find(a);this.length=1,this[0]=g}return this.context=e,this.selector=a,this}return!c||c.jquery?(c||d).find(a):this.constructor(c).find(a)}return p.isFunction(a)?d.ready(a):(a.selector!==b&&(this.selector=a.selector,this.context=a.context),p.makeArray(a,this))},selector:"",jquery:"1.8.1",length:0,size:function(){return this.length},toArray:function(){return k.call(this)},get:function(a){return a==null?this.toArray():a<0?this[this.length+a]:this[a]},pushStack:function(a,b,c){var d=p.merge(this.constructor(),a);return d.prevObject=this,d.context=this.context,b==="find"?d.selector=this.selector+(this.selector?" ":"")+c:b&&(d.selector=this.selector+"."+b+"("+c+")"),d},each:function(a,b){return p.each(this,a,b)},ready:function(a){return p.ready.promise().done(a),this},eq:function(a){return a=+a,a===-1?this.slice(a):this.slice(a,a+1)},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},slice:function(){return this.pushStack(k.apply(this,arguments),"slice",k.call(arguments).join(","))},map:function(a){return this.pushStack(p.map(this,function(b,c){return a.call(b,c,b)}))},end:function(){return this.prevObject||this.constructor(null)},push:j,sort:[].sort,splice:[].splice},p.fn.init.prototype=p.fn,p.extend=p.fn.extend=function(){var a,c,d,e,f,g,h=arguments[0]||{},i=1,j=arguments.length,k=!1;typeof h=="boolean"&&(k=h,h=arguments[1]||{},i=2),typeof h!="object"&&!p.isFunction(h)&&(h={}),j===i&&(h=this,--i);for(;i<j;i++)if((a=arguments[i])!=null)for(c in a){d=h[c],e=a[c];if(h===e)continue;k&&e&&(p.isPlainObject(e)||(f=p.isArray(e)))?(f?(f=!1,g=d&&p.isArray(d)?d:[]):g=d&&p.isPlainObject(d)?d:{},h[c]=p.extend(k,g,e)):e!==b&&(h[c]=e)}return h},p.extend({noConflict:function(b){return a.$===p&&(a.$=i),b&&a.jQuery===p&&(a.jQuery=h),p},isReady:!1,readyWait:1,holdReady:function(a){a?p.readyWait++:p.ready(!0)},ready:function(a){if(a===!0?--p.readyWait:p.isReady)return;if(!e.body)return setTimeout(p.ready,1);p.isReady=!0;if(a!==!0&&--p.readyWait>0)return;d.resolveWith(e,[p]),p.fn.trigger&&p(e).trigger("ready").off("ready")},isFunction:function(a){return p.type(a)==="function"},isArray:Array.isArray||function(a){return p.type(a)==="array"},isWindow:function(a){return a!=null&&a==a.window},isNumeric:function(a){return!isNaN(parseFloat(a))&&isFinite(a)},type:function(a){return a==null?String(a):E[m.call(a)]||"object"},isPlainObject:function(a){if(!a||p.type(a)!=="object"||a.nodeType||p.isWindow(a))return!1;try{if(a.constructor&&!n.call(a,"constructor")&&!n.call(a.constructor.prototype,"isPrototypeOf"))return!1}catch(c){return!1}var d;for(d in a);return d===b||n.call(a,d)},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},error:function(a){throw new Error(a)},parseHTML:function(a,b,c){var d;return!a||typeof a!="string"?null:(typeof b=="boolean"&&(c=b,b=0),b=b||e,(d=v.exec(a))?[b.createElement(d[1])]:(d=p.buildFragment([a],b,c?null:[]),p.merge([],(d.cacheable?p.clone(d.fragment):d.fragment).childNodes)))},parseJSON:function(b){if(!b||typeof b!="string")return null;b=p.trim(b);if(a.JSON&&a.JSON.parse)return a.JSON.parse(b);if(w.test(b.replace(y,"@").replace(z,"]").replace(x,"")))return(new Function("return "+b))();p.error("Invalid JSON: "+b)},parseXML:function(c){var d,e;if(!c||typeof c!="string")return null;try{a.DOMParser?(e=new DOMParser,d=e.parseFromString(c,"text/xml")):(d=new ActiveXObject("Microsoft.XMLDOM"),d.async="false",d.loadXML(c))}catch(f){d=b}return(!d||!d.documentElement||d.getElementsByTagName("parsererror").length)&&p.error("Invalid XML: "+c),d},noop:function(){},globalEval:function(b){b&&r.test(b)&&(a.execScript||function(b){a.eval.call(a,b)})(b)},camelCase:function(a){return a.replace(A,"ms-").replace(B,C)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toUpperCase()===b.toUpperCase()},each:function(a,c,d){var e,f=0,g=a.length,h=g===b||p.isFunction(a);if(d){if(h){for(e in a)if(c.apply(a[e],d)===!1)break}else for(;f<g;)if(c.apply(a[f++],d)===!1)break}else if(h){for(e in a)if(c.call(a[e],e,a[e])===!1)break}else for(;f<g;)if(c.call(a[f],f,a[f++])===!1)break;return a},trim:o&&!o.call(" ")?function(a){return a==null?"":o.call(a)}:function(a){return a==null?"":a.toString().replace(t,"")},makeArray:function(a,b){var c,d=b||[];return a!=null&&(c=p.type(a),a.length==null||c==="string"||c==="function"||c==="regexp"||p.isWindow(a)?j.call(d,a):p.merge(d,a)),d},inArray:function(a,b,c){var d;if(b){if(l)return l.call(b,a,c);d=b.length,c=c?c<0?Math.max(0,d+c):c:0;for(;c<d;c++)if(c in b&&b[c]===a)return c}return-1},merge:function(a,c){var d=c.length,e=a.length,f=0;if(typeof d=="number")for(;f<d;f++)a[e++]=c[f];else while(c[f]!==b)a[e++]=c[f++];return a.length=e,a},grep:function(a,b,c){var d,e=[],f=0,g=a.length;c=!!c;for(;f<g;f++)d=!!b(a[f],f),c!==d&&e.push(a[f]);return e},map:function(a,c,d){var e,f,g=[],h=0,i=a.length,j=a instanceof p||i!==b&&typeof i=="number"&&(i>0&&a[0]&&a[i-1]||i===0||p.isArray(a));if(j)for(;h<i;h++)e=c(a[h],h,d),e!=null&&(g[g.length]=e);else for(f in a)e=c(a[f],f,d),e!=null&&(g[g.length]=e);return g.concat.apply([],g)},guid:1,proxy:function(a,c){var d,e,f;return typeof c=="string"&&(d=a[c],c=a,a=d),p.isFunction(a)?(e=k.call(arguments,2),f=function(){return a.apply(c,e.concat(k.call(arguments)))},f.guid=a.guid=a.guid||f.guid||p.guid++,f):b},access:function(a,c,d,e,f,g,h){var i,j=d==null,k=0,l=a.length;if(d&&typeof d=="object"){for(k in d)p.access(a,c,k,d[k],1,g,e);f=1}else if(e!==b){i=h===b&&p.isFunction(e),j&&(i?(i=c,c=function(a,b,c){return i.call(p(a),c)}):(c.call(a,e),c=null));if(c)for(;k<l;k++)c(a[k],d,i?e.call(a[k],k,c(a[k],d)):e,h);f=1}return f?a:j?c.call(a):l?c(a[0],d):g},now:function(){return(new Date).getTime()}}),p.ready.promise=function(b){if(!d){d=p.Deferred();if(e.readyState==="complete")setTimeout(p.ready,1);else if(e.addEventListener)e.addEventListener("DOMContentLoaded",D,!1),a.addEventListener("load",p.ready,!1);else{e.attachEvent("onreadystatechange",D),a.attachEvent("onload",p.ready);var c=!1;try{c=a.frameElement==null&&e.documentElement}catch(f){}c&&c.doScroll&&function g(){if(!p.isReady){try{c.doScroll("left")}catch(a){return setTimeout(g,50)}p.ready()}}()}}return d.promise(b)},p.each("Boolean Number String Function Array Date RegExp Object".split(" "),function(a,b){E["[object "+b+"]"]=b.toLowerCase()}),c=p(e);var F={};p.Callbacks=function(a){a=typeof a=="string"?F[a]||G(a):p.extend({},a);var c,d,e,f,g,h,i=[],j=!a.once&&[],k=function(b){c=a.memory&&b,d=!0,h=f||0,f=0,g=i.length,e=!0;for(;i&&h<g;h++)if(i[h].apply(b[0],b[1])===!1&&a.stopOnFalse){c=!1;break}e=!1,i&&(j?j.length&&k(j.shift()):c?i=[]:l.disable())},l={add:function(){if(i){var b=i.length;(function d(b){p.each(b,function(b,c){var e=p.type(c);e==="function"&&(!a.unique||!l.has(c))?i.push(c):c&&c.length&&e!=="string"&&d(c)})})(arguments),e?g=i.length:c&&(f=b,k(c))}return this},remove:function(){return i&&p.each(arguments,function(a,b){var c;while((c=p.inArray(b,i,c))>-1)i.splice(c,1),e&&(c<=g&&g--,c<=h&&h--)}),this},has:function(a){return p.inArray(a,i)>-1},empty:function(){return i=[],this},disable:function(){return i=j=c=b,this},disabled:function(){return!i},lock:function(){return j=b,c||l.disable(),this},locked:function(){return!j},fireWith:function(a,b){return b=b||[],b=[a,b.slice?b.slice():b],i&&(!d||j)&&(e?j.push(b):k(b)),this},fire:function(){return l.fireWith(this,arguments),this},fired:function(){return!!d}};return l},p.extend({Deferred:function(a){var b=[["resolve","done",p.Callbacks("once memory"),"resolved"],["reject","fail",p.Callbacks("once memory"),"rejected"],["notify","progress",p.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return p.Deferred(function(c){p.each(b,function(b,d){var f=d[0],g=a[b];e[d[1]](p.isFunction(g)?function(){var a=g.apply(this,arguments);a&&p.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f+"With"](this===e?c:this,[a])}:c[f])}),a=null}).promise()},promise:function(a){return typeof a=="object"?p.extend(a,d):d}},e={};return d.pipe=d.then,p.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[a^1][2].disable,b[2][2].lock),e[f[0]]=g.fire,e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=k.call(arguments),d=c.length,e=d!==1||a&&p.isFunction(a.promise)?d:0,f=e===1?a:p.Deferred(),g=function(a,b,c){return function(d){b[a]=this,c[a]=arguments.length>1?k.call(arguments):d,c===h?f.notifyWith(b,c):--e||f.resolveWith(b,c)}},h,i,j;if(d>1){h=new Array(d),i=new Array(d),j=new Array(d);for(;b<d;b++)c[b]&&p.isFunction(c[b].promise)?c[b].promise().done(g(b,j,c)).fail(f.reject).progress(g(b,i,h)):--e}return e||f.resolveWith(j,c),f.promise()}}),p.support=function(){var b,c,d,f,g,h,i,j,k,l,m,n=e.createElement("div");n.setAttribute("className","t"),n.innerHTML="  <link/><table></table><a href='/a'>a</a><input type='checkbox'/>",c=n.getElementsByTagName("*"),d=n.getElementsByTagName("a")[0],d.style.cssText="top:1px;float:left;opacity:.5";if(!c||!c.length||!d)return{};f=e.createElement("select"),g=f.appendChild(e.createElement("option")),h=n.getElementsByTagName("input")[0],b={leadingWhitespace:n.firstChild.nodeType===3,tbody:!n.getElementsByTagName("tbody").length,htmlSerialize:!!n.getElementsByTagName("link").length,style:/top/.test(d.getAttribute("style")),hrefNormalized:d.getAttribute("href")==="/a",opacity:/^0.5/.test(d.style.opacity),cssFloat:!!d.style.cssFloat,checkOn:h.value==="on",optSelected:g.selected,getSetAttribute:n.className!=="t",enctype:!!e.createElement("form").enctype,html5Clone:e.createElement("nav").cloneNode(!0).outerHTML!=="<:nav></:nav>",boxModel:e.compatMode==="CSS1Compat",submitBubbles:!0,changeBubbles:!0,focusinBubbles:!1,deleteExpando:!0,noCloneEvent:!0,inlineBlockNeedsLayout:!1,shrinkWrapBlocks:!1,reliableMarginRight:!0,boxSizingReliable:!0,pixelPosition:!1},h.checked=!0,b.noCloneChecked=h.cloneNode(!0).checked,f.disabled=!0,b.optDisabled=!g.disabled;try{delete n.test}catch(o){b.deleteExpando=!1}!n.addEventListener&&n.attachEvent&&n.fireEvent&&(n.attachEvent("onclick",m=function(){b.noCloneEvent=!1}),n.cloneNode(!0).fireEvent("onclick"),n.detachEvent("onclick",m)),h=e.createElement("input"),h.value="t",h.setAttribute("type","radio"),b.radioValue=h.value==="t",h.setAttribute("checked","checked"),h.setAttribute("name","t"),n.appendChild(h),i=e.createDocumentFragment(),i.appendChild(n.lastChild),b.checkClone=i.cloneNode(!0).cloneNode(!0).lastChild.checked,b.appendChecked=h.checked,i.removeChild(h),i.appendChild(n);if(n.attachEvent)for(k in{submit:!0,change:!0,focusin:!0})j="on"+k,l=j in n,l||(n.setAttribute(j,"return;"),l=typeof n[j]=="function"),b[k+"Bubbles"]=l;return p(function(){var c,d,f,g,h="padding:0;margin:0;border:0;display:block;overflow:hidden;",i=e.getElementsByTagName("body")[0];if(!i)return;c=e.createElement("div"),c.style.cssText="visibility:hidden;border:0;width:0;height:0;position:static;top:0;margin-top:1px",i.insertBefore(c,i.firstChild),d=e.createElement("div"),c.appendChild(d),d.innerHTML="<table><tr><td></td><td>t</td></tr></table>",f=d.getElementsByTagName("td"),f[0].style.cssText="padding:0;margin:0;border:0;display:none",l=f[0].offsetHeight===0,f[0].style.display="",f[1].style.display="none",b.reliableHiddenOffsets=l&&f[0].offsetHeight===0,d.innerHTML="",d.style.cssText="box-sizing:border-box;-moz-box-sizing:border-box;-webkit-box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%;",b.boxSizing=d.offsetWidth===4,b.doesNotIncludeMarginInBodyOffset=i.offsetTop!==1,a.getComputedStyle&&(b.pixelPosition=(a.getComputedStyle(d,null)||{}).top!=="1%",b.boxSizingReliable=(a.getComputedStyle(d,null)||{width:"4px"}).width==="4px",g=e.createElement("div"),g.style.cssText=d.style.cssText=h,g.style.marginRight=g.style.width="0",d.style.width="1px",d.appendChild(g),b.reliableMarginRight=!parseFloat((a.getComputedStyle(g,null)||{}).marginRight)),typeof d.style.zoom!="undefined"&&(d.innerHTML="",d.style.cssText=h+"width:1px;padding:1px;display:inline;zoom:1",b.inlineBlockNeedsLayout=d.offsetWidth===3,d.style.display="block",d.style.overflow="visible",d.innerHTML="<div></div>",d.firstChild.style.width="5px",b.shrinkWrapBlocks=d.offsetWidth!==3,c.style.zoom=1),i.removeChild(c),c=d=f=g=null}),i.removeChild(n),c=d=f=g=h=i=n=null,b}();var H=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,I=/([A-Z])/g;p.extend({cache:{},deletedIds:[],uuid:0,expando:"jQuery"+(p.fn.jquery+Math.random()).replace(/\D/g,""),noData:{embed:!0,object:"clsid:D27CDB6E-AE6D-11cf-96B8-444553540000",applet:!0},hasData:function(a){return a=a.nodeType?p.cache[a[p.expando]]:a[p.expando],!!a&&!K(a)},data:function(a,c,d,e){if(!p.acceptData(a))return;var f,g,h=p.expando,i=typeof c=="string",j=a.nodeType,k=j?p.cache:a,l=j?a[h]:a[h]&&h;if((!l||!k[l]||!e&&!k[l].data)&&i&&d===b)return;l||(j?a[h]=l=p.deletedIds.pop()||++p.uuid:l=h),k[l]||(k[l]={},j||(k[l].toJSON=p.noop));if(typeof c=="object"||typeof c=="function")e?k[l]=p.extend(k[l],c):k[l].data=p.extend(k[l].data,c);return f=k[l],e||(f.data||(f.data={}),f=f.data),d!==b&&(f[p.camelCase(c)]=d),i?(g=f[c],g==null&&(g=f[p.camelCase(c)])):g=f,g},removeData:function(a,b,c){if(!p.acceptData(a))return;var d,e,f,g=a.nodeType,h=g?p.cache:a,i=g?a[p.expando]:p.expando;if(!h[i])return;if(b){d=c?h[i]:h[i].data;if(d){p.isArray(b)||(b in d?b=[b]:(b=p.camelCase(b),b in d?b=[b]:b=b.split(" ")));for(e=0,f=b.length;e<f;e++)delete d[b[e]];if(!(c?K:p.isEmptyObject)(d))return}}if(!c){delete h[i].data;if(!K(h[i]))return}g?p.cleanData([a],!0):p.support.deleteExpando||h!=h.window?delete h[i]:h[i]=null},_data:function(a,b,c){return p.data(a,b,c,!0)},acceptData:function(a){var b=a.nodeName&&p.noData[a.nodeName.toLowerCase()];return!b||b!==!0&&a.getAttribute("classid")===b}}),p.fn.extend({data:function(a,c){var d,e,f,g,h,i=this[0],j=0,k=null;if(a===b){if(this.length){k=p.data(i);if(i.nodeType===1&&!p._data(i,"parsedAttrs")){f=i.attributes;for(h=f.length;j<h;j++)g=f[j].name,g.indexOf("data-")===0&&(g=p.camelCase(g.substring(5)),J(i,g,k[g]));p._data(i,"parsedAttrs",!0)}}return k}return typeof a=="object"?this.each(function(){p.data(this,a)}):(d=a.split(".",2),d[1]=d[1]?"."+d[1]:"",e=d[1]+"!",p.access(this,function(c){if(c===b)return k=this.triggerHandler("getData"+e,[d[0]]),k===b&&i&&(k=p.data(i,a),k=J(i,a,k)),k===b&&d[1]?this.data(d[0]):k;d[1]=c,this.each(function(){var b=p(this);b.triggerHandler("setData"+e,d),p.data(this,a,c),b.triggerHandler("changeData"+e,d)})},null,c,arguments.length>1,null,!1))},removeData:function(a){return this.each(function(){p.removeData(this,a)})}}),p.extend({queue:function(a,b,c){var d;if(a)return b=(b||"fx")+"queue",d=p._data(a,b),c&&(!d||p.isArray(c)?d=p._data(a,b,p.makeArray(c)):d.push(c)),d||[]},dequeue:function(a,b){b=b||"fx";var c=p.queue(a,b),d=c.length,e=c.shift(),f=p._queueHooks(a,b),g=function(){p.dequeue(a,b)};e==="inprogress"&&(e=c.shift(),d--),e&&(b==="fx"&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return p._data(a,c)||p._data(a,c,{empty:p.Callbacks("once memory").add(function(){p.removeData(a,b+"queue",!0),p.removeData(a,c,!0)})})}}),p.fn.extend({queue:function(a,c){var d=2;return typeof a!="string"&&(c=a,a="fx",d--),arguments.length<d?p.queue(this[0],a):c===b?this:this.each(function(){var b=p.queue(this,a,c);p._queueHooks(this,a),a==="fx"&&b[0]!=="inprogress"&&p.dequeue(this,a)})},dequeue:function(a){return this.each(function(){p.dequeue(this,a)})},delay:function(a,b){return a=p.fx?p.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,c){var d,e=1,f=p.Deferred(),g=this,h=this.length,i=function(){--e||f.resolveWith(g,[g])};typeof a!="string"&&(c=a,a=b),a=a||"fx";while(h--)d=p._data(g[h],a+"queueHooks"),d&&d.empty&&(e++,d.empty.add(i));return i(),f.promise(c)}});var L,M,N,O=/[\t\r\n]/g,P=/\r/g,Q=/^(?:button|input)$/i,R=/^(?:button|input|object|select|textarea)$/i,S=/^a(?:rea|)$/i,T=/^(?:autofocus|autoplay|async|checked|controls|defer|disabled|hidden|loop|multiple|open|readonly|required|scoped|selected)$/i,U=p.support.getSetAttribute;p.fn.extend({attr:function(a,b){return p.access(this,p.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){p.removeAttr(this,a)})},prop:function(a,b){return p.access(this,p.prop,a,b,arguments.length>1)},removeProp:function(a){return a=p.propFix[a]||a,this.each(function(){try{this[a]=b,delete this[a]}catch(c){}})},addClass:function(a){var b,c,d,e,f,g,h;if(p.isFunction(a))return this.each(function(b){p(this).addClass(a.call(this,b,this.className))});if(a&&typeof a=="string"){b=a.split(s);for(c=0,d=this.length;c<d;c++){e=this[c];if(e.nodeType===1)if(!e.className&&b.length===1)e.className=a;else{f=" "+e.className+" ";for(g=0,h=b.length;g<h;g++)~f.indexOf(" "+b[g]+" ")||(f+=b[g]+" ");e.className=p.trim(f)}}}return this},removeClass:function(a){var c,d,e,f,g,h,i;if(p.isFunction(a))return this.each(function(b){p(this).removeClass(a.call(this,b,this.className))});if(a&&typeof a=="string"||a===b){c=(a||"").split(s);for(h=0,i=this.length;h<i;h++){e=this[h];if(e.nodeType===1&&e.className){d=(" "+e.className+" ").replace(O," ");for(f=0,g=c.length;f<g;f++)while(d.indexOf(" "+c[f]+" ")>-1)d=d.replace(" "+c[f]+" "," ");e.className=a?p.trim(d):""}}}return this},toggleClass:function(a,b){var c=typeof a,d=typeof b=="boolean";return p.isFunction(a)?this.each(function(c){p(this).toggleClass(a.call(this,c,this.className,b),b)}):this.each(function(){if(c==="string"){var e,f=0,g=p(this),h=b,i=a.split(s);while(e=i[f++])h=d?h:!g.hasClass(e),g[h?"addClass":"removeClass"](e)}else if(c==="undefined"||c==="boolean")this.className&&p._data(this,"__className__",this.className),this.className=this.className||a===!1?"":p._data(this,"__className__")||""})},hasClass:function(a){var b=" "+a+" ",c=0,d=this.length;for(;c<d;c++)if(this[c].nodeType===1&&(" "+this[c].className+" ").replace(O," ").indexOf(b)>-1)return!0;return!1},val:function(a){var c,d,e,f=this[0];if(!arguments.length){if(f)return c=p.valHooks[f.type]||p.valHooks[f.nodeName.toLowerCase()],c&&"get"in c&&(d=c.get(f,"value"))!==b?d:(d=f.value,typeof d=="string"?d.replace(P,""):d==null?"":d);return}return e=p.isFunction(a),this.each(function(d){var f,g=p(this);if(this.nodeType!==1)return;e?f=a.call(this,d,g.val()):f=a,f==null?f="":typeof f=="number"?f+="":p.isArray(f)&&(f=p.map(f,function(a){return a==null?"":a+""})),c=p.valHooks[this.type]||p.valHooks[this.nodeName.toLowerCase()];if(!c||!("set"in c)||c.set(this,f,"value")===b)this.value=f})}}),p.extend({valHooks:{option:{get:function(a){var b=a.attributes.value;return!b||b.specified?a.value:a.text}},select:{get:function(a){var b,c,d,e,f=a.selectedIndex,g=[],h=a.options,i=a.type==="select-one";if(f<0)return null;c=i?f:0,d=i?f+1:h.length;for(;c<d;c++){e=h[c];if(e.selected&&(p.support.optDisabled?!e.disabled:e.getAttribute("disabled")===null)&&(!e.parentNode.disabled||!p.nodeName(e.parentNode,"optgroup"))){b=p(e).val();if(i)return b;g.push(b)}}return i&&!g.length&&h.length?p(h[f]).val():g},set:function(a,b){var c=p.makeArray(b);return p(a).find("option").each(function(){this.selected=p.inArray(p(this).val(),c)>=0}),c.length||(a.selectedIndex=-1),c}}},attrFn:{},attr:function(a,c,d,e){var f,g,h,i=a.nodeType;if(!a||i===3||i===8||i===2)return;if(e&&p.isFunction(p.fn[c]))return p(a)[c](d);if(typeof a.getAttribute=="undefined")return p.prop(a,c,d);h=i!==1||!p.isXMLDoc(a),h&&(c=c.toLowerCase(),g=p.attrHooks[c]||(T.test(c)?M:L));if(d!==b){if(d===null){p.removeAttr(a,c);return}return g&&"set"in g&&h&&(f=g.set(a,d,c))!==b?f:(a.setAttribute(c,""+d),d)}return g&&"get"in g&&h&&(f=g.get(a,c))!==null?f:(f=a.getAttribute(c),f===null?b:f)},removeAttr:function(a,b){var c,d,e,f,g=0;if(b&&a.nodeType===1){d=b.split(s);for(;g<d.length;g++)e=d[g],e&&(c=p.propFix[e]||e,f=T.test(e),f||p.attr(a,e,""),a.removeAttribute(U?e:c),f&&c in a&&(a[c]=!1))}},attrHooks:{type:{set:function(a,b){if(Q.test(a.nodeName)&&a.parentNode)p.error("type property can't be changed");else if(!p.support.radioValue&&b==="radio"&&p.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}},value:{get:function(a,b){return L&&p.nodeName(a,"button")?L.get(a,b):b in a?a.value:null},set:function(a,b,c){if(L&&p.nodeName(a,"button"))return L.set(a,b,c);a.value=b}}},propFix:{tabindex:"tabIndex",readonly:"readOnly","for":"htmlFor","class":"className",maxlength:"maxLength",cellspacing:"cellSpacing",cellpadding:"cellPadding",rowspan:"rowSpan",colspan:"colSpan",usemap:"useMap",frameborder:"frameBorder",contenteditable:"contentEditable"},prop:function(a,c,d){var e,f,g,h=a.nodeType;if(!a||h===3||h===8||h===2)return;return g=h!==1||!p.isXMLDoc(a),g&&(c=p.propFix[c]||c,f=p.propHooks[c]),d!==b?f&&"set"in f&&(e=f.set(a,d,c))!==b?e:a[c]=d:f&&"get"in f&&(e=f.get(a,c))!==null?e:a[c]},propHooks:{tabIndex:{get:function(a){var c=a.getAttributeNode("tabindex");return c&&c.specified?parseInt(c.value,10):R.test(a.nodeName)||S.test(a.nodeName)&&a.href?0:b}}}}),M={get:function(a,c){var d,e=p.prop(a,c);return e===!0||typeof e!="boolean"&&(d=a.getAttributeNode(c))&&d.nodeValue!==!1?c.toLowerCase():b},set:function(a,b,c){var d;return b===!1?p.removeAttr(a,c):(d=p.propFix[c]||c,d in a&&(a[d]=!0),a.setAttribute(c,c.toLowerCase())),c}},U||(N={name:!0,id:!0,coords:!0},L=p.valHooks.button={get:function(a,c){var d;return d=a.getAttributeNode(c),d&&(N[c]?d.value!=="":d.specified)?d.value:b},set:function(a,b,c){var d=a.getAttributeNode(c);return d||(d=e.createAttribute(c),a.setAttributeNode(d)),d.value=b+""}},p.each(["width","height"],function(a,b){p.attrHooks[b]=p.extend(p.attrHooks[b],{set:function(a,c){if(c==="")return a.setAttribute(b,"auto"),c}})}),p.attrHooks.contenteditable={get:L.get,set:function(a,b,c){b===""&&(b="false"),L.set(a,b,c)}}),p.support.hrefNormalized||p.each(["href","src","width","height"],function(a,c){p.attrHooks[c]=p.extend(p.attrHooks[c],{get:function(a){var d=a.getAttribute(c,2);return d===null?b:d}})}),p.support.style||(p.attrHooks.style={get:function(a){return a.style.cssText.toLowerCase()||b},set:function(a,b){return a.style.cssText=""+b}}),p.support.optSelected||(p.propHooks.selected=p.extend(p.propHooks.selected,{get:function(a){var b=a.parentNode;return b&&(b.selectedIndex,b.parentNode&&b.parentNode.selectedIndex),null}})),p.support.enctype||(p.propFix.enctype="encoding"),p.support.checkOn||p.each(["radio","checkbox"],function(){p.valHooks[this]={get:function(a){return a.getAttribute("value")===null?"on":a.value}}}),p.each(["radio","checkbox"],function(){p.valHooks[this]=p.extend(p.valHooks[this],{set:function(a,b){if(p.isArray(b))return a.checked=p.inArray(p(a).val(),b)>=0}})});var V=/^(?:textarea|input|select)$/i,W=/^([^\.]*|)(?:\.(.+)|)$/,X=/(?:^|\s)hover(\.\S+|)\b/,Y=/^key/,Z=/^(?:mouse|contextmenu)|click/,$=/^(?:focusinfocus|focusoutblur)$/,_=function(a){return p.event.special.hover?a:a.replace(X,"mouseenter$1 mouseleave$1")};p.event={add:function(a,c,d,e,f){var g,h,i,j,k,l,m,n,o,q,r;if(a.nodeType===3||a.nodeType===8||!c||!d||!(g=p._data(a)))return;d.handler&&(o=d,d=o.handler,f=o.selector),d.guid||(d.guid=p.guid++),i=g.events,i||(g.events=i={}),h=g.handle,h||(g.handle=h=function(a){return typeof p!="undefined"&&(!a||p.event.triggered!==a.type)?p.event.dispatch.apply(h.elem,arguments):b},h.elem=a),c=p.trim(_(c)).split(" ");for(j=0;j<c.length;j++){k=W.exec(c[j])||[],l=k[1],m=(k[2]||"").split(".").sort(),r=p.event.special[l]||{},l=(f?r.delegateType:r.bindType)||l,r=p.event.special[l]||{},n=p.extend({type:l,origType:k[1],data:e,handler:d,guid:d.guid,selector:f,namespace:m.join(".")},o),q=i[l];if(!q){q=i[l]=[],q.delegateCount=0;if(!r.setup||r.setup.call(a,e,m,h)===!1)a.addEventListener?a.addEventListener(l,h,!1):a.attachEvent&&a.attachEvent("on"+l,h)}r.add&&(r.add.call(a,n),n.handler.guid||(n.handler.guid=d.guid)),f?q.splice(q.delegateCount++,0,n):q.push(n),p.event.global[l]=!0}a=null},global:{},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n,o,q,r=p.hasData(a)&&p._data(a);if(!r||!(m=r.events))return;b=p.trim(_(b||"")).split(" ");for(f=0;f<b.length;f++){g=W.exec(b[f])||[],h=i=g[1],j=g[2];if(!h){for(h in m)p.event.remove(a,h+b[f],c,d,!0);continue}n=p.event.special[h]||{},h=(d?n.delegateType:n.bindType)||h,o=m[h]||[],k=o.length,j=j?new RegExp("(^|\\.)"+j.split(".").sort().join("\\.(?:.*\\.|)")+"(\\.|$)"):null;for(l=0;l<o.length;l++)q=o[l],(e||i===q.origType)&&(!c||c.guid===q.guid)&&(!j||j.test(q.namespace))&&(!d||d===q.selector||d==="**"&&q.selector)&&(o.splice(l--,1),q.selector&&o.delegateCount--,n.remove&&n.remove.call(a,q));o.length===0&&k!==o.length&&((!n.teardown||n.teardown.call(a,j,r.handle)===!1)&&p.removeEvent(a,h,r.handle),delete m[h])}p.isEmptyObject(m)&&(delete r.handle,p.removeData(a,"events",!0))},customEvent:{getData:!0,setData:!0,changeData:!0},trigger:function(c,d,f,g){if(!f||f.nodeType!==3&&f.nodeType!==8){var h,i,j,k,l,m,n,o,q,r,s=c.type||c,t=[];if($.test(s+p.event.triggered))return;s.indexOf("!")>=0&&(s=s.slice(0,-1),i=!0),s.indexOf(".")>=0&&(t=s.split("."),s=t.shift(),t.sort());if((!f||p.event.customEvent[s])&&!p.event.global[s])return;c=typeof c=="object"?c[p.expando]?c:new p.Event(s,c):new p.Event(s),c.type=s,c.isTrigger=!0,c.exclusive=i,c.namespace=t.join("."),c.namespace_re=c.namespace?new RegExp("(^|\\.)"+t.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,m=s.indexOf(":")<0?"on"+s:"";if(!f){h=p.cache;for(j in h)h[j].events&&h[j].events[s]&&p.event.trigger(c,d,h[j].handle.elem,!0);return}c.result=b,c.target||(c.target=f),d=d!=null?p.makeArray(d):[],d.unshift(c),n=p.event.special[s]||{};if(n.trigger&&n.trigger.apply(f,d)===!1)return;q=[[f,n.bindType||s]];if(!g&&!n.noBubble&&!p.isWindow(f)){r=n.delegateType||s,k=$.test(r+s)?f:f.parentNode;for(l=f;k;k=k.parentNode)q.push([k,r]),l=k;l===(f.ownerDocument||e)&&q.push([l.defaultView||l.parentWindow||a,r])}for(j=0;j<q.length&&!c.isPropagationStopped();j++)k=q[j][0],c.type=q[j][1],o=(p._data(k,"events")||{})[c.type]&&p._data(k,"handle"),o&&o.apply(k,d),o=m&&k[m],o&&p.acceptData(k)&&o.apply(k,d)===!1&&c.preventDefault();return c.type=s,!g&&!c.isDefaultPrevented()&&(!n._default||n._default.apply(f.ownerDocument,d)===!1)&&(s!=="click"||!p.nodeName(f,"a"))&&p.acceptData(f)&&m&&f[s]&&(s!=="focus"&&s!=="blur"||c.target.offsetWidth!==0)&&!p.isWindow(f)&&(l=f[m],l&&(f[m]=null),p.event.triggered=s,f[s](),p.event.triggered=b,l&&(f[m]=l)),c.result}return},dispatch:function(c){c=p.event.fix(c||a.event);var d,e,f,g,h,i,j,k,l,m,n=(p._data(this,"events")||{})[c.type]||[],o=n.delegateCount,q=[].slice.call(arguments),r=!c.exclusive&&!c.namespace,s=p.event.special[c.type]||{},t=[];q[0]=c,c.delegateTarget=this;if(s.preDispatch&&s.preDispatch.call(this,c)===!1)return;if(o&&(!c.button||c.type!=="click"))for(f=c.target;f!=this;f=f.parentNode||this)if(f.disabled!==!0||c.type!=="click"){h={},j=[];for(d=0;d<o;d++)k=n[d],l=k.selector,h[l]===b&&(h[l]=p(l,this).index(f)>=0),h[l]&&j.push(k);j.length&&t.push({elem:f,matches:j})}n.length>o&&t.push({elem:this,matches:n.slice(o)});for(d=0;d<t.length&&!c.isPropagationStopped();d++){i=t[d],c.currentTarget=i.elem;for(e=0;e<i.matches.length&&!c.isImmediatePropagationStopped();e++){k=i.matches[e];if(r||!c.namespace&&!k.namespace||c.namespace_re&&c.namespace_re.test(k.namespace))c.data=k.data,c.handleObj=k,g=((p.event.special[k.origType]||{}).handle||k.handler).apply(i.elem,q),g!==b&&(c.result=g,g===!1&&(c.preventDefault(),c.stopPropagation()))}}return s.postDispatch&&s.postDispatch.call(this,c),c.result},props:"attrChange attrName relatedNode srcElement altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return a.which==null&&(a.which=b.charCode!=null?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY fromElement offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,c){var d,f,g,h=c.button,i=c.fromElement;return a.pageX==null&&c.clientX!=null&&(d=a.target.ownerDocument||e,f=d.documentElement,g=d.body,a.pageX=c.clientX+(f&&f.scrollLeft||g&&g.scrollLeft||0)-(f&&f.clientLeft||g&&g.clientLeft||0),a.pageY=c.clientY+(f&&f.scrollTop||g&&g.scrollTop||0)-(f&&f.clientTop||g&&g.clientTop||0)),!a.relatedTarget&&i&&(a.relatedTarget=i===a.target?c.toElement:i),!a.which&&h!==b&&(a.which=h&1?1:h&2?3:h&4?2:0),a}},fix:function(a){if(a[p.expando])return a;var b,c,d=a,f=p.event.fixHooks[a.type]||{},g=f.props?this.props.concat(f.props):this.props;a=p.Event(d);for(b=g.length;b;)c=g[--b],a[c]=d[c];return a.target||(a.target=d.srcElement||e),a.target.nodeType===3&&(a.target=a.target.parentNode),a.metaKey=!!a.metaKey,f.filter?f.filter(a,d):a},special:{load:{noBubble:!0},focus:{delegateType:"focusin"},blur:{delegateType:"focusout"},beforeunload:{setup:function(a,b,c){p.isWindow(this)&&(this.onbeforeunload=c)},teardown:function(a,b){this.onbeforeunload===b&&(this.onbeforeunload=null)}}},simulate:function(a,b,c,d){var e=p.extend(new p.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?p.event.trigger(e,null,b):p.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},p.event.handle=p.event.dispatch,p.removeEvent=e.removeEventListener?function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)}:function(a,b,c){var d="on"+b;a.detachEvent&&(typeof a[d]=="undefined"&&(a[d]=null),a.detachEvent(d,c))},p.Event=function(a,b){if(this instanceof p.Event)a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||a.returnValue===!1||a.getPreventDefault&&a.getPreventDefault()?bb:ba):this.type=a,b&&p.extend(this,b),this.timeStamp=a&&a.timeStamp||p.now(),this[p.expando]=!0;else return new p.Event(a,b)},p.Event.prototype={preventDefault:function(){this.isDefaultPrevented=bb;var a=this.originalEvent;if(!a)return;a.preventDefault?a.preventDefault():a.returnValue=!1},stopPropagation:function(){this.isPropagationStopped=bb;var a=this.originalEvent;if(!a)return;a.stopPropagation&&a.stopPropagation(),a.cancelBubble=!0},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=bb,this.stopPropagation()},isDefaultPrevented:ba,isPropagationStopped:ba,isImmediatePropagationStopped:ba},p.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(a,b){p.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj,g=f.selector;if(!e||e!==d&&!p.contains(d,e))a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b;return c}}}),p.support.submitBubbles||(p.event.special.submit={setup:function(){if(p.nodeName(this,"form"))return!1;p.event.add(this,"click._submit keypress._submit",function(a){var c=a.target,d=p.nodeName(c,"input")||p.nodeName(c,"button")?c.form:b;d&&!p._data(d,"_submit_attached")&&(p.event.add(d,"submit._submit",function(a){a._submit_bubble=!0}),p._data(d,"_submit_attached",!0))})},postDispatch:function(a){a._submit_bubble&&(delete a._submit_bubble,this.parentNode&&!a.isTrigger&&p.event.simulate("submit",this.parentNode,a,!0))},teardown:function(){if(p.nodeName(this,"form"))return!1;p.event.remove(this,"._submit")}}),p.support.changeBubbles||(p.event.special.change={setup:function(){if(V.test(this.nodeName)){if(this.type==="checkbox"||this.type==="radio")p.event.add(this,"propertychange._change",function(a){a.originalEvent.propertyName==="checked"&&(this._just_changed=!0)}),p.event.add(this,"click._change",function(a){this._just_changed&&!a.isTrigger&&(this._just_changed=!1),p.event.simulate("change",this,a,!0)});return!1}p.event.add(this,"beforeactivate._change",function(a){var b=a.target;V.test(b.nodeName)&&!p._data(b,"_change_attached")&&(p.event.add(b,"change._change",function(a){this.parentNode&&!a.isSimulated&&!a.isTrigger&&p.event.simulate("change",this.parentNode,a,!0)}),p._data(b,"_change_attached",!0))})},handle:function(a){var b=a.target;if(this!==b||a.isSimulated||a.isTrigger||b.type!=="radio"&&b.type!=="checkbox")return a.handleObj.handler.apply(this,arguments)},teardown:function(){return p.event.remove(this,"._change"),!V.test(this.nodeName)}}),p.support.focusinBubbles||p.each({focus:"focusin",blur:"focusout"},function(a,b){var c=0,d=function(a){p.event.simulate(b,a.target,p.event.fix(a),!0)};p.event.special[b]={setup:function(){c++===0&&e.addEventListener(a,d,!0)},teardown:function(){--c===0&&e.removeEventListener(a,d,!0)}}}),p.fn.extend({on:function(a,c,d,e,f){var g,h;if(typeof a=="object"){typeof c!="string"&&(d=d||c,c=b);for(h in a)this.on(h,c,d,a[h],f);return this}d==null&&e==null?(e=c,d=c=b):e==null&&(typeof c=="string"?(e=d,d=b):(e=d,d=c,c=b));if(e===!1)e=ba;else if(!e)return this;return f===1&&(g=e,e=function(a){return p().off(a),g.apply(this,arguments)},e.guid=g.guid||(g.guid=p.guid++)),this.each(function(){p.event.add(this,a,e,d,c)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,c,d){var e,f;if(a&&a.preventDefault&&a.handleObj)return e=a.handleObj,p(a.delegateTarget).off(e.namespace?e.origType+"."+e.namespace:e.origType,e.selector,e.handler),this;if(typeof a=="object"){for(f in a)this.off(f,c,a[f]);return this}if(c===!1||typeof c=="function")d=c,c=b;return d===!1&&(d=ba),this.each(function(){p.event.remove(this,a,d,c)})},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},live:function(a,b,c){return p(this.context).on(a,this.selector,b,c),this},die:function(a,b){return p(this.context).off(a,this.selector||"**",b),this},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return arguments.length==1?this.off(a,"**"):this.off(b,a||"**",c)},trigger:function(a,b){return this.each(function(){p.event.trigger(a,b,this)})},triggerHandler:function(a,b){if(this[0])return p.event.trigger(a,b,this[0],!0)},toggle:function(a){var b=arguments,c=a.guid||p.guid++,d=0,e=function(c){var e=(p._data(this,"lastToggle"+a.guid)||0)%d;return p._data(this,"lastToggle"+a.guid,e+1),c.preventDefault(),b[e].apply(this,arguments)||!1};e.guid=c;while(d<b.length)b[d++].guid=c;return this.click(e)},hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)}}),p.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){p.fn[b]=function(a,c){return c==null&&(c=a,a=null),arguments.length>0?this.on(b,null,a,c):this.trigger(b)},Y.test(b)&&(p.event.fixHooks[b]=p.event.keyHooks),Z.test(b)&&(p.event.fixHooks[b]=p.event.mouseHooks)}),function(a,b){function $(a,b,c,d){c=c||[],b=b||q;var e,f,g,j,k=b.nodeType;if(k!==1&&k!==9)return[];if(!a||typeof a!="string")return c;g=h(b);if(!g&&!d)if(e=L.exec(a))if(j=e[1]){if(k===9){f=b.getElementById(j);if(!f||!f.parentNode)return c;if(f.id===j)return c.push(f),c}else if(b.ownerDocument&&(f=b.ownerDocument.getElementById(j))&&i(b,f)&&f.id===j)return c.push(f),c}else{if(e[2])return u.apply(c,t.call(b.getElementsByTagName(a),0)),c;if((j=e[3])&&X&&b.getElementsByClassName)return u.apply(c,t.call(b.getElementsByClassName(j),0)),c}return bk(a,b,c,d,g)}function _(a){return function(b){var c=b.nodeName.toLowerCase();return c==="input"&&b.type===a}}function ba(a){return function(b){var c=b.nodeName.toLowerCase();return(c==="input"||c==="button")&&b.type===a}}function bb(a,b,c){if(a===b)return c;var d=a.nextSibling;while(d){if(d===b)return-1;d=d.nextSibling}return 1}function bc(a,b,c,d){var e,g,h,i,j,k,l,m,n,p,r=!c&&b!==q,s=(r?"<s>":"")+a.replace(H,"$1<s>"),u=y[o][s];if(u)return d?0:t.call(u,0);j=a,k=[],m=0,n=f.preFilter,p=f.filter;while(j){if(!e||(g=I.exec(j)))g&&(j=j.slice(g[0].length),h.selector=l),k.push(h=[]),l="",r&&(j=" "+j);e=!1;if(g=J.exec(j))l+=g[0],j=j.slice(g[0].length),e=h.push({part:g.pop().replace(H," "),string:g[0],captures:g});for(i in p)(g=S[i].exec(j))&&(!n[i]||(g=n[i](g,b,c)))&&(l+=g[0],j=j.slice(g[0].length),e=h.push({part:i,string:g.shift(),captures:g}));if(!e)break}return l&&(h.selector=l),d?j.length:j?$.error(a):t.call(y(s,k),0)}function bd(a,b,e,f){var g=b.dir,h=s++;return a||(a=function(a){return a===e}),b.first?function(b){while(b=b[g])if(b.nodeType===1)return a(b)&&b}:f?function(b){while(b=b[g])if(b.nodeType===1&&a(b))return b}:function(b){var e,f=h+"."+c,i=f+"."+d;while(b=b[g])if(b.nodeType===1){if((e=b[o])===i)return b.sizset;if(typeof e=="string"&&e.indexOf(f)===0){if(b.sizset)return b}else{b[o]=i;if(a(b))return b.sizset=!0,b;b.sizset=!1}}}}function be(a,b){return a?function(c){var d=b(c);return d&&a(d===!0?c:d)}:b}function bf(a,b,c){var d,e,g=0;for(;d=a[g];g++)f.relative[d.part]?e=bd(e,f.relative[d.part],b,c):e=be(e,f.filter[d.part].apply(null,d.captures.concat(b,c)));return e}function bg(a){return function(b){var c,d=0;for(;c=a[d];d++)if(c(b))return!0;return!1}}function bh(a,b,c,d){var e=0,f=b.length;for(;e<f;e++)$(a,b[e],c,d)}function bi(a,b,c,d,e,g){var h,i=f.setFilters[b.toLowerCase()];return i||$.error(b),(a||!(h=e))&&bh(a||"*",d,h=[],e),h.length>0?i(h,c,g):[]}function bj(a,c,d,e){var f,g,h,i,j,k,l,m,n,o,p,q,r,s=0,t=a.length,v=S.POS,w=new RegExp("^"+v.source+"(?!"+A+")","i"),x=function(){var a=1,c=arguments.length-2;for(;a<c;a++)arguments[a]===b&&(n[a]=b)};for(;s<t;s++){f=a[s],g="",m=e;for(h=0,i=f.length;h<i;h++){j=f[h],k=j.string;if(j.part==="PSEUDO"){v.exec(""),l=0;while(n=v.exec(k)){o=!0,p=v.lastIndex=n.index+n[0].length;if(p>l){g+=k.slice(l,n.index),l=p,q=[c],J.test(g)&&(m&&(q=m),m=e);if(r=O.test(g))g=g.slice(0,-5).replace(J,"$&*"),l++;n.length>1&&n[0].replace(w,x),m=bi(g,n[1],n[2],q,m,r)}g=""}}o||(g+=k),o=!1}g?J.test(g)?bh(g,m||[c],d,e):$(g,c,d,e?e.concat(m):m):u.apply(d,m)}return t===1?d:$.uniqueSort(d)}function bk(a,b,e,g,h){a=a.replace(H,"$1");var i,k,l,m,n,o,p,q,r,s,v=bc(a,b,h),w=b.nodeType;if(S.POS.test(a))return bj(v,b,e,g);if(g)i=t.call(g,0);else if(v.length===1){if((o=t.call(v[0],0)).length>2&&(p=o[0]).part==="ID"&&w===9&&!h&&f.relative[o[1].part]){b=f.find.ID(p.captures[0].replace(R,""),b,h)[0];if(!b)return e;a=a.slice(o.shift().string.length)}r=(v=N.exec(o[0].string))&&!v.index&&b.parentNode||b,q="";for(n=o.length-1;n>=0;n--){p=o[n],s=p.part,q=p.string+q;if(f.relative[s])break;if(f.order.test(s)){i=f.find[s](p.captures[0].replace(R,""),r,h);if(i==null)continue;a=a.slice(0,a.length-q.length)+q.replace(S[s],""),a||u.apply(e,t.call(i,0));break}}}if(a){k=j(a,b,h),c=k.dirruns++,i==null&&(i=f.find.TAG("*",N.test(a)&&b.parentNode||b));for(n=0;m=i[n];n++)d=k.runs++,k(m)&&e.push(m)}return e}var c,d,e,f,g,h,i,j,k,l,m=!0,n="undefined",o=("sizcache"+Math.random()).replace(".",""),q=a.document,r=q.documentElement,s=0,t=[].slice,u=[].push,v=function(a,b){return a[o]=b||!0,a},w=function(){var a={},b=[];return v(function(c,d){return b.push(c)>f.cacheLength&&delete a[b.shift()],a[c]=d},a)},x=w(),y=w(),z=w(),A="[\\x20\\t\\r\\n\\f]",B="(?:\\\\.|[-\\w]|[^\\x00-\\xa0])+",C=B.replace("w","w#"),D="([*^$|!~]?=)",E="\\["+A+"*("+B+")"+A+"*(?:"+D+A+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+C+")|)|)"+A+"*\\]",F=":("+B+")(?:\\((?:(['\"])((?:\\\\.|[^\\\\])*?)\\2|([^()[\\]]*|(?:(?:"+E+")|[^:]|\\\\.)*|.*))\\)|)",G=":(nth|eq|gt|lt|first|last|even|odd)(?:\\(((?:-\\d)?\\d*)\\)|)(?=[^-]|$)",H=new RegExp("^"+A+"+|((?:^|[^\\\\])(?:\\\\.)*)"+A+"+$","g"),I=new RegExp("^"+A+"*,"+A+"*"),J=new RegExp("^"+A+"*([\\x20\\t\\r\\n\\f>+~])"+A+"*"),K=new RegExp(F),L=/^(?:#([\w\-]+)|(\w+)|\.([\w\-]+))$/,M=/^:not/,N=/[\x20\t\r\n\f]*[+~]/,O=/:not\($/,P=/h\d/i,Q=/input|select|textarea|button/i,R=/\\(?!\\)/g,S={ID:new RegExp("^#("+B+")"),CLASS:new RegExp("^\\.("+B+")"),NAME:new RegExp("^\\[name=['\"]?("+B+")['\"]?\\]"),TAG:new RegExp("^("+B.replace("w","w*")+")"),ATTR:new RegExp("^"+E),PSEUDO:new RegExp("^"+F),CHILD:new RegExp("^:(only|nth|last|first)-child(?:\\("+A+"*(even|odd|(([+-]|)(\\d*)n|)"+A+"*(?:([+-]|)"+A+"*(\\d+)|))"+A+"*\\)|)","i"),POS:new RegExp(G,"ig"),needsContext:new RegExp("^"+A+"*[>+~]|"+G,"i")},T=function(a){var b=q.createElement("div");try{return a(b)}catch(c){return!1}finally{b=null}},U=T(function(a){return a.appendChild(q.createComment("")),!a.getElementsByTagName("*").length}),V=T(function(a){return a.innerHTML="<a href='#'></a>",a.firstChild&&typeof a.firstChild.getAttribute!==n&&a.firstChild.getAttribute("href")==="#"}),W=T(function(a){a.innerHTML="<select></select>";var b=typeof a.lastChild.getAttribute("multiple");return b!=="boolean"&&b!=="string"}),X=T(function(a){return a.innerHTML="<div class='hidden e'></div><div class='hidden'></div>",!a.getElementsByClassName||!a.getElementsByClassName("e").length?!1:(a.lastChild.className="e",a.getElementsByClassName("e").length===2)}),Y=T(function(a){a.id=o+0,a.innerHTML="<a name='"+o+"'></a><div name='"+o+"'></div>",r.insertBefore(a,r.firstChild);var b=q.getElementsByName&&q.getElementsByName(o).length===2+q.getElementsByName(o+0).length;return e=!q.getElementById(o),r.removeChild(a),b});try{t.call(r.childNodes,0)[0].nodeType}catch(Z){t=function(a){var b,c=[];for(;b=this[a];a++)c.push(b);return c}}$.matches=function(a,b){return $(a,null,null,b)},$.matchesSelector=function(a,b){return $(b,null,null,[a]).length>0},g=$.getText=function(a){var b,c="",d=0,e=a.nodeType;if(e){if(e===1||e===9||e===11){if(typeof a.textContent=="string")return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=g(a)}else if(e===3||e===4)return a.nodeValue}else for(;b=a[d];d++)c+=g(b);return c},h=$.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?b.nodeName!=="HTML":!1},i=$.contains=r.contains?function(a,b){var c=a.nodeType===9?a.documentElement:a,d=b&&b.parentNode;return a===d||!!(d&&d.nodeType===1&&c.contains&&c.contains(d))}:r.compareDocumentPosition?function(a,b){return b&&!!(a.compareDocumentPosition(b)&16)}:function(a,b){while(b=b.parentNode)if(b===a)return!0;return!1},$.attr=function(a,b){var c,d=h(a);return d||(b=b.toLowerCase()),f.attrHandle[b]?f.attrHandle[b](a):W||d?a.getAttribute(b):(c=a.getAttributeNode(b),c?typeof a[b]=="boolean"?a[b]?b:null:c.specified?c.value:null:null)},f=$.selectors={cacheLength:50,createPseudo:v,match:S,order:new RegExp("ID|TAG"+(Y?"|NAME":"")+(X?"|CLASS":"")),attrHandle:V?{}:{href:function(a){return a.getAttribute("href",2)},type:function(a){return a.getAttribute("type")}},find:{ID:e?function(a,b,c){if(typeof b.getElementById!==n&&!c){var d=b.getElementById(a);return d&&d.parentNode?[d]:[]}}:function(a,c,d){if(typeof c.getElementById!==n&&!d){var e=c.getElementById(a);return e?e.id===a||typeof e.getAttributeNode!==n&&e.getAttributeNode("id").value===a?[e]:b:[]}},TAG:U?function(a,b){if(typeof b.getElementsByTagName!==n)return b.getElementsByTagName(a)}:function(a,b){var c=b.getElementsByTagName(a);if(a==="*"){var d,e=[],f=0;for(;d=c[f];f++)d.nodeType===1&&e.push(d);return e}return c},NAME:function(a,b){if(typeof b.getElementsByName!==n)return b.getElementsByName(name)},CLASS:function(a,b,c){if(typeof b.getElementsByClassName!==n&&!c)return b.getElementsByClassName(a)}},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(R,""),a[3]=(a[4]||a[5]||"").replace(R,""),a[2]==="~="&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),a[1]==="nth"?(a[2]||$.error(a[0]),a[3]=+(a[3]?a[4]+(a[5]||1):2*(a[2]==="even"||a[2]==="odd")),a[4]=+(a[6]+a[7]||a[2]==="odd")):a[2]&&$.error(a[0]),a},PSEUDO:function(a,b,c){var d,e;if(S.CHILD.test(a[0]))return null;if(a[3])a[2]=a[3];else if(d=a[4])K.test(d)&&(e=bc(d,b,c,!0))&&(e=d.indexOf(")",d.length-e)-d.length)&&(d=d.slice(0,e),a[0]=a[0].slice(0,e)),a[2]=d;return a.slice(0,3)}},filter:{ID:e?function(a){return a=a.replace(R,""),function(b){return b.getAttribute("id")===a}}:function(a){return a=a.replace(R,""),function(b){var c=typeof b.getAttributeNode!==n&&b.getAttributeNode("id");return c&&c.value===a}},TAG:function(a){return a==="*"?function(){return!0}:(a=a.replace(R,"").toLowerCase(),function(b){return b.nodeName&&b.nodeName.toLowerCase()===a})},CLASS:function(a){var b=x[o][a];return b||(b=x(a,new RegExp("(^|"+A+")"+a+"("+A+"|$)"))),function(a){return b.test(a.className||typeof a.getAttribute!==n&&a.getAttribute("class")||"")}},ATTR:function(a,b,c){return b?function(d){var e=$.attr(d,a),f=e+"";if(e==null)return b==="!=";switch(b){case"=":return f===c;case"!=":return f!==c;case"^=":return c&&f.indexOf(c)===0;case"*=":return c&&f.indexOf(c)>-1;case"$=":return c&&f.substr(f.length-c.length)===c;case"~=":return(" "+f+" ").indexOf(c)>-1;case"|=":return f===c||f.substr(0,c.length+1)===c+"-"}}:function(b){return $.attr(b,a)!=null}},CHILD:function(a,b,c,d){if(a==="nth"){var e=s++;return function(a){var b,f,g=0,h=a;if(c===1&&d===0)return!0;b=a.parentNode;if(b&&(b[o]!==e||!a.sizset)){for(h=b.firstChild;h;h=h.nextSibling)if(h.nodeType===1){h.sizset=++g;if(h===a)break}b[o]=e}return f=a.sizset-d,c===0?f===0:f%c===0&&f/c>=0}}return function(b){var c=b;switch(a){case"only":case"first":while(c=c.previousSibling)if(c.nodeType===1)return!1;if(a==="first")return!0;c=b;case"last":while(c=c.nextSibling)if(c.nodeType===1)return!1;return!0}}},PSEUDO:function(a,b,c,d){var e,g=f.pseudos[a]||f.pseudos[a.toLowerCase()];return g||$.error("unsupported pseudo: "+a),g[o]?g(b,c,d):g.length>1?(e=[a,a,"",b],function(a){return g(a,0,e)}):g}},pseudos:{not:v(function(a,b,c){var d=j(a.replace(H,"$1"),b,c);return function(a){return!d(a)}}),enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&!!a.checked||b==="option"&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},parent:function(a){return!f.pseudos.empty(a)},empty:function(a){var b;a=a.firstChild;while(a){if(a.nodeName>"@"||(b=a.nodeType)===3||b===4)return!1;a=a.nextSibling}return!0},contains:v(function(a){return function(b){return(b.textContent||b.innerText||g(b)).indexOf(a)>-1}}),has:v(function(a){return function(b){return $(a,b).length>0}}),header:function(a){return P.test(a.nodeName)},text:function(a){var b,c;return a.nodeName.toLowerCase()==="input"&&(b=a.type)==="text"&&((c=a.getAttribute("type"))==null||c.toLowerCase()===b)},radio:_("radio"),checkbox:_("checkbox"),file:_("file"),password:_("password"),image:_("image"),submit:ba("submit"),reset:ba("reset"),button:function(a){var b=a.nodeName.toLowerCase();return b==="input"&&a.type==="button"||b==="button"},input:function(a){return Q.test(a.nodeName)},focus:function(a){var b=a.ownerDocument;return a===b.activeElement&&(!b.hasFocus||b.hasFocus())&&(!!a.type||!!a.href)},active:function(a){return a===a.ownerDocument.activeElement}},setFilters:{first:function(a,b,c){return c?a.slice(1):[a[0]]},last:function(a,b,c){var d=a.pop();return c?a:[d]},even:function(a,b,c){var d=[],e=c?1:0,f=a.length;for(;e<f;e=e+2)d.push(a[e]);return d},odd:function(a,b,c){var d=[],e=c?0:1,f=a.length;for(;e<f;e=e+2)d.push(a[e]);return d},lt:function(a,b,c){return c?a.slice(+b):a.slice(0,+b)},gt:function(a,b,c){return c?a.slice(0,+b+1):a.slice(+b+1)},eq:function(a,b,c){var d=a.splice(+b,1);return c?a:d}}},k=r.compareDocumentPosition?function(a,b){return a===b?(l=!0,0):(!a.compareDocumentPosition||!b.compareDocumentPosition?a.compareDocumentPosition:a.compareDocumentPosition(b)&4)?-1:1}:function(a,b){if(a===b)return l=!0,0;if(a.sourceIndex&&b.sourceIndex)return a.sourceIndex-b.sourceIndex;var c,d,e=[],f=[],g=a.parentNode,h=b.parentNode,i=g;if(g===h)return bb(a,b);if(!g)return-1;if(!h)return 1;while(i)e.unshift(i),i=i.parentNode;i=h;while(i)f.unshift(i),i=i.parentNode;c=e.length,d=f.length;for(var j=0;j<c&&j<d;j++)if(e[j]!==f[j])return bb(e[j],f[j]);return j===c?bb(a,f[j],-1):bb(e[j],b,1)},[0,0].sort(k),m=!l,$.uniqueSort=function(a){var b,c=1;l=m,a.sort(k);if(l)for(;b=a[c];c++)b===a[c-1]&&a.splice(c--,1);return a},$.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},j=$.compile=function(a,b,c){var d,e,f,g=z[o][a];if(g&&g.context===b)return g;d=bc(a,b,c);for(e=0,f=d.length;e<f;e++)d[e]=bf(d[e],b,c);return g=z(a,bg(d)),g.context=b,g.runs=g.dirruns=0,g},q.querySelectorAll&&function(){var a,b=bk,c=/'|\\/g,d=/\=[\x20\t\r\n\f]*([^'"\]]*)[\x20\t\r\n\f]*\]/g,e=[],f=[":active"],g=r.matchesSelector||r.mozMatchesSelector||r.webkitMatchesSelector||r.oMatchesSelector||r.msMatchesSelector;T(function(a){a.innerHTML="<select><option selected=''></option></select>",a.querySelectorAll("[selected]").length||e.push("\\["+A+"*(?:checked|disabled|ismap|multiple|readonly|selected|value)"),a.querySelectorAll(":checked").length||e.push(":checked")}),T(function(a){a.innerHTML="<p test=''></p>",a.querySelectorAll("[test^='']").length&&e.push("[*^$]="+A+"*(?:\"\"|'')"),a.innerHTML="<input type='hidden'/>",a.querySelectorAll(":enabled").length||e.push(":enabled",":disabled")}),e=e.length&&new RegExp(e.join("|")),bk=function(a,d,f,g,h){if(!g&&!h&&(!e||!e.test(a)))if(d.nodeType===9)try{return u.apply(f,t.call(d.querySelectorAll(a),0)),f}catch(i){}else if(d.nodeType===1&&d.nodeName.toLowerCase()!=="object"){var j,k,l,m=d.getAttribute("id"),n=m||o,p=N.test(a)&&d.parentNode||d;m?n=n.replace(c,"\\$&"):d.setAttribute("id",n),j=bc(a,d,h),n="[id='"+n+"']";for(k=0,l=j.length;k<l;k++)j[k]=n+j[k].selector;try{return u.apply(f,t.call(p.querySelectorAll(j.join(",")),0)),f}catch(i){}finally{m||d.removeAttribute("id")}}return b(a,d,f,g,h)},g&&(T(function(b){a=g.call(b,"div");try{g.call(b,"[test!='']:sizzle"),f.push(S.PSEUDO.source,S.POS.source,"!=")}catch(c){}}),f=new RegExp(f.join("|")),$.matchesSelector=function(b,c){c=c.replace(d,"='$1']");if(!h(b)&&!f.test(c)&&(!e||!e.test(c)))try{var i=g.call(b,c);if(i||a||b.document&&b.document.nodeType!==11)return i}catch(j){}return $(c,null,null,[b]).length>0})}(),f.setFilters.nth=f.setFilters.eq,f.filters=f.pseudos,$.attr=p.attr,p.find=$,p.expr=$.selectors,p.expr[":"]=p.expr.pseudos,p.unique=$.uniqueSort,p.text=$.getText,p.isXMLDoc=$.isXML,p.contains=$.contains}(a);var bc=/Until$/,bd=/^(?:parents|prev(?:Until|All))/,be=/^.[^:#\[\.,]*$/,bf=p.expr.match.needsContext,bg={children:!0,contents:!0,next:!0,prev:!0};p.fn.extend({find:function(a){var b,c,d,e,f,g,h=this;if(typeof a!="string")return p(a).filter(function(){for(b=0,c=h.length;b<c;b++)if(p.contains(h[b],this))return!0});g=this.pushStack("","find",a);for(b=0,c=this.length;b<c;b++){d=g.length,p.find(a,this[b],g);if(b>0)for(e=d;e<g.length;e++)for(f=0;f<d;f++)if(g[f]===g[e]){g.splice(e--,1);break}}return g},has:function(a){var b,c=p(a,this),d=c.length;return this.filter(function(){for(b=0;b<d;b++)if(p.contains(this,c[b]))return!0})},not:function(a){return this.pushStack(bj(this,a,!1),"not",a)},filter:function(a){return this.pushStack(bj(this,a,!0),"filter",a)},is:function(a){return!!a&&(typeof a=="string"?bf.test(a)?p(a,this.context).index(this[0])>=0:p.filter(a,this).length>0:this.filter(a).length>0)},closest:function(a,b){var c,d=0,e=this.length,f=[],g=bf.test(a)||typeof a!="string"?p(a,b||this.context):0;for(;d<e;d++){c=this[d];while(c&&c.ownerDocument&&c!==b&&c.nodeType!==11){if(g?g.index(c)>-1:p.find.matchesSelector(c,a)){f.push(c);break}c=c.parentNode}}return f=f.length>1?p.unique(f):f,this.pushStack(f,"closest",a)},index:function(a){return a?typeof a=="string"?p.inArray(this[0],p(a)):p.inArray(a.jquery?a[0]:a,this):this[0]&&this[0].parentNode?this.prevAll().length:-1},add:function(a,b){var c=typeof a=="string"?p(a,b):p.makeArray(a&&a.nodeType?[a]:a),d=p.merge(this.get(),c);return this.pushStack(bh(c[0])||bh(d[0])?d:p.unique(d))},addBack:function(a){return this.add(a==null?this.prevObject:this.prevObject.filter(a))}}),p.fn.andSelf=p.fn.addBack,p.each({parent:function(a){var b=a.parentNode;return b&&b.nodeType!==11?b:null},parents:function(a){return p.dir(a,"parentNode")},parentsUntil:function(a,b,c){return p.dir(a,"parentNode",c)},next:function(a){return bi(a,"nextSibling")},prev:function(a){return bi(a,"previousSibling")},nextAll:function(a){return p.dir(a,"nextSibling")},prevAll:function(a){return p.dir(a,"previousSibling")},nextUntil:function(a,b,c){return p.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return p.dir(a,"previousSibling",c)},siblings:function(a){return p.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return p.sibling(a.firstChild)},contents:function(a){return p.nodeName(a,"iframe")?a.contentDocument||a.contentWindow.document:p.merge([],a.childNodes)}},function(a,b){p.fn[a]=function(c,d){var e=p.map(this,b,c);return bc.test(a)||(d=c),d&&typeof d=="string"&&(e=p.filter(d,e)),e=this.length>1&&!bg[a]?p.unique(e):e,this.length>1&&bd.test(a)&&(e=e.reverse()),this.pushStack(e,a,k.call(arguments).join(","))}}),p.extend({filter:function(a,b,c){return c&&(a=":not("+a+")"),b.length===1?p.find.matchesSelector(b[0],a)?[b[0]]:[]:p.find.matches(a,b)},dir:function(a,c,d){var e=[],f=a[c];while(f&&f.nodeType!==9&&(d===b||f.nodeType!==1||!p(f).is(d)))f.nodeType===1&&e.push(f),f=f[c];return e},sibling:function(a,b){var c=[];for(;a;a=a.nextSibling)a.nodeType===1&&a!==b&&c.push(a);return c}});var bl="abbr|article|aside|audio|bdi|canvas|data|datalist|details|figcaption|figure|footer|header|hgroup|mark|meter|nav|output|progress|section|summary|time|video",bm=/ jQuery\d+="(?:null|\d+)"/g,bn=/^\s+/,bo=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bp=/<([\w:]+)/,bq=/<tbody/i,br=/<|&#?\w+;/,bs=/<(?:script|style|link)/i,bt=/<(?:script|object|embed|option|style)/i,bu=new RegExp("<(?:"+bl+")[\\s/>]","i"),bv=/^(?:checkbox|radio)$/,bw=/checked\s*(?:[^=]|=\s*.checked.)/i,bx=/\/(java|ecma)script/i,by=/^\s*<!(?:\[CDATA\[|\-\-)|[\]\-]{2}>\s*$/g,bz={option:[1,"<select multiple='multiple'>","</select>"],legend:[1,"<fieldset>","</fieldset>"],thead:[1,"<table>","</table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],col:[2,"<table><tbody></tbody><colgroup>","</colgroup></table>"],area:[1,"<map>","</map>"],_default:[0,"",""]},bA=bk(e),bB=bA.appendChild(e.createElement("div"));bz.optgroup=bz.option,bz.tbody=bz.tfoot=bz.colgroup=bz.caption=bz.thead,bz.th=bz.td,p.support.htmlSerialize||(bz._default=[1,"X<div>","</div>"]),p.fn.extend({text:function(a){return p.access(this,function(a){return a===b?p.text(this):this.empty().append((this[0]&&this[0].ownerDocument||e).createTextNode(a))},null,a,arguments.length)},wrapAll:function(a){if(p.isFunction(a))return this.each(function(b){p(this).wrapAll(a.call(this,b))});if(this[0]){var b=p(a,this[0].ownerDocument).eq(0).clone(!0);this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstChild&&a.firstChild.nodeType===1)a=a.firstChild;return a}).append(this)}return this},wrapInner:function(a){return p.isFunction(a)?this.each(function(b){p(this).wrapInner(a.call(this,b))}):this.each(function(){var b=p(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=p.isFunction(a);return this.each(function(c){p(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){p.nodeName(this,"body")||p(this).replaceWith(this.childNodes)}).end()},append:function(){return this.domManip(arguments,!0,function(a){(this.nodeType===1||this.nodeType===11)&&this.appendChild(a)})},prepend:function(){return this.domManip(arguments,!0,function(a){(this.nodeType===1||this.nodeType===11)&&this.insertBefore(a,this.firstChild)})},before:function(){if(!bh(this[0]))return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this)});if(arguments.length){var a=p.clean(arguments);return this.pushStack(p.merge(a,this),"before",this.selector)}},after:function(){if(!bh(this[0]))return this.domManip(arguments,!1,function(a){this.parentNode.insertBefore(a,this.nextSibling)});if(arguments.length){var a=p.clean(arguments);return this.pushStack(p.merge(this,a),"after",this.selector)}},remove:function(a,b){var c,d=0;for(;(c=this[d])!=null;d++)if(!a||p.filter(a,[c]).length)!b&&c.nodeType===1&&(p.cleanData(c.getElementsByTagName("*")),p.cleanData([c])),c.parentNode&&c.parentNode.removeChild(c);return this},empty:function(){var a,b=0;for(;(a=this[b])!=null;b++){a.nodeType===1&&p.cleanData(a.getElementsByTagName("*"));while(a.firstChild)a.removeChild(a.firstChild)}return this},clone:function(a,b){return a=a==null?!1:a,b=b==null?a:b,this.map(function(){return p.clone(this,a,b)})},html:function(a){return p.access(this,function(a){var c=this[0]||{},d=0,e=this.length;if(a===b)return c.nodeType===1?c.innerHTML.replace(bm,""):b;if(typeof a=="string"&&!bs.test(a)&&(p.support.htmlSerialize||!bu.test(a))&&(p.support.leadingWhitespace||!bn.test(a))&&!bz[(bp.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(bo,"<$1></$2>");try{for(;d<e;d++)c=this[d]||{},c.nodeType===1&&(p.cleanData(c.getElementsByTagName("*")),c.innerHTML=a);c=0}catch(f){}}c&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(a){return bh(this[0])?this.length?this.pushStack(p(p.isFunction(a)?a():a),"replaceWith",a):this:p.isFunction(a)?this.each(function(b){var c=p(this),d=c.html();c.replaceWith(a.call(this,b,d))}):(typeof a!="string"&&(a=p(a).detach()),this.each(function(){var b=this.nextSibling,c=this.parentNode;p(this).remove(),b?p(b).before(a):p(c).append(a)}))},detach:function(a){return this.remove(a,!0)},domManip:function(a,c,d){a=[].concat.apply([],a);var e,f,g,h,i=0,j=a[0],k=[],l=this.length;if(!p.support.checkClone&&l>1&&typeof j=="string"&&bw.test(j))return this.each(function(){p(this).domManip(a,c,d)});if(p.isFunction(j))return this.each(function(e){var f=p(this);a[0]=j.call(this,e,c?f.html():b),f.domManip(a,c,d)});if(this[0]){e=p.buildFragment(a,this,k),g=e.fragment,f=g.firstChild,g.childNodes.length===1&&(g=f);if(f){c=c&&p.nodeName(f,"tr");for(h=e.cacheable||l-1;i<l;i++)d.call(c&&p.nodeName(this[i],"table")?bC(this[i],"tbody"):this[i],i===h?g:p.clone(g,!0,!0))}g=f=null,k.length&&p.each(k,function(a,b){b.src?p.ajax?p.ajax({url:b.src,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0}):p.error("no ajax"):p.globalEval((b.text||b.textContent||b.innerHTML||"").replace(by,"")),b.parentNode&&b.parentNode.removeChild(b)})}return this}}),p.buildFragment=function(a,c,d){var f,g,h,i=a[0];return c=c||e,c=!c.nodeType&&c[0]||c,c=c.ownerDocument||c,a.length===1&&typeof i=="string"&&i.length<512&&c===e&&i.charAt(0)==="<"&&!bt.test(i)&&(p.support.checkClone||!bw.test(i))&&(p.support.html5Clone||!bu.test(i))&&(g=!0,f=p.fragments[i],h=f!==b),f||(f=c.createDocumentFragment(),p.clean(a,c,f,d),g&&(p.fragments[i]=h&&f)),{fragment:f,cacheable:g}},p.fragments={},p.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){p.fn[a]=function(c){var d,e=0,f=[],g=p(c),h=g.length,i=this.length===1&&this[0].parentNode;if((i==null||i&&i.nodeType===11&&i.childNodes.length===1)&&h===1)return g[b](this[0]),this;for(;e<h;e++)d=(e>0?this.clone(!0):this).get(),p(g[e])[b](d),f=f.concat(d);return this.pushStack(f,a,g.selector)}}),p.extend({clone:function(a,b,c){var d,e,f,g;p.support.html5Clone||p.isXMLDoc(a)||!bu.test("<"+a.nodeName+">")?g=a.cloneNode(!0):(bB.innerHTML=a.outerHTML,bB.removeChild(g=bB.firstChild));if((!p.support.noCloneEvent||!p.support.noCloneChecked)&&(a.nodeType===1||a.nodeType===11)&&!p.isXMLDoc(a)){bE(a,g),d=bF(a),e=bF(g);for(f=0;d[f];++f)e[f]&&bE(d[f],e[f])}if(b){bD(a,g);if(c){d=bF(a),e=bF(g);for(f=0;d[f];++f)bD(d[f],e[f])}}return d=e=null,g},clean:function(a,b,c,d){var f,g,h,i,j,k,l,m,n,o,q,r,s=b===e&&bA,t=[];if(!b||typeof b.createDocumentFragment=="undefined")b=e;for(f=0;(h=a[f])!=null;f++){typeof h=="number"&&(h+="");if(!h)continue;if(typeof h=="string")if(!br.test(h))h=b.createTextNode(h);else{s=s||bk(b),l=b.createElement("div"),s.appendChild(l),h=h.replace(bo,"<$1></$2>"),i=(bp.exec(h)||["",""])[1].toLowerCase(),j=bz[i]||bz._default,k=j[0],l.innerHTML=j[1]+h+j[2];while(k--)l=l.lastChild;if(!p.support.tbody){m=bq.test(h),n=i==="table"&&!m?l.firstChild&&l.firstChild.childNodes:j[1]==="<table>"&&!m?l.childNodes:[];for(g=n.length-1;g>=0;--g)p.nodeName(n[g],"tbody")&&!n[g].childNodes.length&&n[g].parentNode.removeChild(n[g])}!p.support.leadingWhitespace&&bn.test(h)&&l.insertBefore(b.createTextNode(bn.exec(h)[0]),l.firstChild),h=l.childNodes,l.parentNode.removeChild(l)}h.nodeType?t.push(h):p.merge(t,h)}l&&(h=l=s=null);if(!p.support.appendChecked)for(f=0;(h=t[f])!=null;f++)p.nodeName(h,"input")?bG(h):typeof h.getElementsByTagName!="undefined"&&p.grep(h.getElementsByTagName("input"),bG);if(c){q=function(a){if(!a.type||bx.test(a.type))return d?d.push(a.parentNode?a.parentNode.removeChild(a):a):c.appendChild(a)};for(f=0;(h=t[f])!=null;f++)if(!p.nodeName(h,"script")||!q(h))c.appendChild(h),typeof h.getElementsByTagName!="undefined"&&(r=p.grep(p.merge([],h.getElementsByTagName("script")),q),t.splice.apply(t,[f+1,0].concat(r)),f+=r.length)}return t},cleanData:function(a,b){var c,d,e,f,g=0,h=p.expando,i=p.cache,j=p.support.deleteExpando,k=p.event.special;for(;(e=a[g])!=null;g++)if(b||p.acceptData(e)){d=e[h],c=d&&i[d];if(c){if(c.events)for(f in c.events)k[f]?p.event.remove(e,f):p.removeEvent(e,f,c.handle);i[d]&&(delete i[d],j?delete e[h]:e.removeAttribute?e.removeAttribute(h):e[h]=null,p.deletedIds.push(d))}}}}),function(){var a,b;p.uaMatch=function(a){a=a.toLowerCase();var b=/(chrome)[ \/]([\w.]+)/.exec(a)||/(webkit)[ \/]([\w.]+)/.exec(a)||/(opera)(?:.*version|)[ \/]([\w.]+)/.exec(a)||/(msie) ([\w.]+)/.exec(a)||a.indexOf("compatible")<0&&/(mozilla)(?:.*? rv:([\w.]+)|)/.exec(a)||[];return{browser:b[1]||"",version:b[2]||"0"}},a=p.uaMatch(g.userAgent),b={},a.browser&&(b[a.browser]=!0,b.version=a.version),b.chrome?b.webkit=!0:b.webkit&&(b.safari=!0),p.browser=b,p.sub=function(){function a(b,c){return new a.fn.init(b,c)}p.extend(!0,a,this),a.superclass=this,a.fn=a.prototype=this(),a.fn.constructor=a,a.sub=this.sub,a.fn.init=function c(c,d){return d&&d instanceof p&&!(d instanceof a)&&(d=a(d)),p.fn.init.call(this,c,d,b)},a.fn.init.prototype=a.fn;var b=a(e);return a}}();var bH,bI,bJ,bK=/alpha\([^)]*\)/i,bL=/opacity=([^)]*)/,bM=/^(top|right|bottom|left)$/,bN=/^(none|table(?!-c[ea]).+)/,bO=/^margin/,bP=new RegExp("^("+q+")(.*)$","i"),bQ=new RegExp("^("+q+")(?!px)[a-z%]+$","i"),bR=new RegExp("^([-+])=("+q+")","i"),bS={},bT={position:"absolute",visibility:"hidden",display:"block"},bU={letterSpacing:0,fontWeight:400},bV=["Top","Right","Bottom","Left"],bW=["Webkit","O","Moz","ms"],bX=p.fn.toggle;p.fn.extend({css:function(a,c){return p.access(this,function(a,c,d){return d!==b?p.style(a,c,d):p.css(a,c)},a,c,arguments.length>1)},show:function(){return b$(this,!0)},hide:function(){return b$(this)},toggle:function(a,b){var c=typeof a=="boolean";return p.isFunction(a)&&p.isFunction(b)?bX.apply(this,arguments):this.each(function(){(c?a:bZ(this))?p(this).show():p(this).hide()})}}),p.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=bH(a,"opacity");return c===""?"1":c}}}},cssNumber:{fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":p.support.cssFloat?"cssFloat":"styleFloat"},style:function(a,c,d,e){if(!a||a.nodeType===3||a.nodeType===8||!a.style)return;var f,g,h,i=p.camelCase(c),j=a.style;c=p.cssProps[i]||(p.cssProps[i]=bY(j,i)),h=p.cssHooks[c]||p.cssHooks[i];if(d===b)return h&&"get"in h&&(f=h.get(a,!1,e))!==b?f:j[c];g=typeof d,g==="string"&&(f=bR.exec(d))&&(d=(f[1]+1)*f[2]+parseFloat(p.css(a,c)),g="number");if(d==null||g==="number"&&isNaN(d))return;g==="number"&&!p.cssNumber[i]&&(d+="px");if(!h||!("set"in h)||(d=h.set(a,d,e))!==b)try{j[c]=d}catch(k){}},css:function(a,c,d,e){var f,g,h,i=p.camelCase(c);return c=p.cssProps[i]||(p.cssProps[i]=bY(a.style,i)),h=p.cssHooks[c]||p.cssHooks[i],h&&"get"in h&&(f=h.get(a,!0,e)),f===b&&(f=bH(a,c)),f==="normal"&&c in bU&&(f=bU[c]),d||e!==b?(g=parseFloat(f),d||p.isNumeric(g)?g||0:f):f},swap:function(a,b,c){var d,e,f={};for(e in b)f[e]=a.style[e],a.style[e]=b[e];d=c.call(a);for(e in b)a.style[e]=f[e];return d}}),a.getComputedStyle?bH=function(b,c){var d,e,f,g,h=a.getComputedStyle(b,null),i=b.style;return h&&(d=h[c],d===""&&!p.contains(b.ownerDocument,b)&&(d=p.style(b,c)),bQ.test(d)&&bO.test(c)&&(e=i.width,f=i.minWidth,g=i.maxWidth,i.minWidth=i.maxWidth=i.width=d,d=h.width,i.width=e,i.minWidth=f,i.maxWidth=g)),d}:e.documentElement.currentStyle&&(bH=function(a,b){var c,d,e=a.currentStyle&&a.currentStyle[b],f=a.style;return e==null&&f&&f[b]&&(e=f[b]),bQ.test(e)&&!bM.test(b)&&(c=f.left,d=a.runtimeStyle&&a.runtimeStyle.left,d&&(a.runtimeStyle.left=a.currentStyle.left),f.left=b==="fontSize"?"1em":e,e=f.pixelLeft+"px",f.left=c,d&&(a.runtimeStyle.left=d)),e===""?"auto":e}),p.each(["height","width"],function(a,b){p.cssHooks[b]={get:function(a,c,d){if(c)return a.offsetWidth===0&&bN.test(bH(a,"display"))?p.swap(a,bT,function(){return cb(a,b,d)}):cb(a,b,d)},set:function(a,c,d){return b_(a,c,d?ca(a,b,d,p.support.boxSizing&&p.css(a,"boxSizing")==="border-box"):0)}}}),p.support.opacity||(p.cssHooks.opacity={get:function(a,b){return bL.test((b&&a.currentStyle?a.currentStyle.filter:a.style.filter)||"")?.01*parseFloat(RegExp.$1)+"":b?"1":""},set:function(a,b){var c=a.style,d=a.currentStyle,e=p.isNumeric(b)?"alpha(opacity="+b*100+")":"",f=d&&d.filter||c.filter||"";c.zoom=1;if(b>=1&&p.trim(f.replace(bK,""))===""&&c.removeAttribute){c.removeAttribute("filter");if(d&&!d.filter)return}c.filter=bK.test(f)?f.replace(bK,e):f+" "+e}}),p(function(){p.support.reliableMarginRight||(p.cssHooks.marginRight={get:function(a,b){return p.swap(a,{display:"inline-block"},function(){if(b)return bH(a,"marginRight")})}}),!p.support.pixelPosition&&p.fn.position&&p.each(["top","left"],function(a,b){p.cssHooks[b]={get:function(a,c){if(c){var d=bH(a,b);return bQ.test(d)?p(a).position()[b]+"px":d}}}})}),p.expr&&p.expr.filters&&(p.expr.filters.hidden=function(a){return a.offsetWidth===0&&a.offsetHeight===0||!p.support.reliableHiddenOffsets&&(a.style&&a.style.display||bH(a,"display"))==="none"},p.expr.filters.visible=function(a){return!p.expr.filters.hidden(a)}),p.each({margin:"",padding:"",border:"Width"},function(a,b){p.cssHooks[a+b]={expand:function(c){var d,e=typeof c=="string"?c.split(" "):[c],f={};for(d=0;d<4;d++)f[a+bV[d]+b]=e[d]||e[d-2]||e[0];return f}},bO.test(a)||(p.cssHooks[a+b].set=b_)});var cd=/%20/g,ce=/\[\]$/,cf=/\r?\n/g,cg=/^(?:color|date|datetime|datetime-local|email|hidden|month|number|password|range|search|tel|text|time|url|week)$/i,ch=/^(?:select|textarea)/i;p.fn.extend({serialize:function(){return p.param(this.serializeArray())},serializeArray:function(){return this.map(function(){return this.elements?p.makeArray(this.elements):this}).filter(function(){return this.name&&!this.disabled&&(this.checked||ch.test(this.nodeName)||cg.test(this.type))}).map(function(a,b){var c=p(this).val();return c==null?null:p.isArray(c)?p.map(c,function(a,c){return{name:b.name,value:a.replace(cf,"\r\n")}}):{name:b.name,value:c.replace(cf,"\r\n")}}).get()}}),p.param=function(a,c){var d,e=[],f=function(a,b){b=p.isFunction(b)?b():b==null?"":b,e[e.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};c===b&&(c=p.ajaxSettings&&p.ajaxSettings.traditional);if(p.isArray(a)||a.jquery&&!p.isPlainObject(a))p.each(a,function(){f(this.name,this.value)});else for(d in a)ci(d,a[d],c,f);return e.join("&").replace(cd,"+")};var cj,ck,cl=/#.*$/,cm=/^(.*?):[ \t]*([^\r\n]*)\r?$/mg,cn=/^(?:about|app|app\-storage|.+\-extension|file|res|widget):$/,co=/^(?:GET|HEAD)$/,cp=/^\/\//,cq=/\?/,cr=/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,cs=/([?&])_=[^&]*/,ct=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,cu=p.fn.load,cv={},cw={},cx=["*/"]+["*"];try{cj=f.href}catch(cy){cj=e.createElement("a"),cj.href="",cj=cj.href}ck=ct.exec(cj.toLowerCase())||[],p.fn.load=function(a,c,d){if(typeof a!="string"&&cu)return cu.apply(this,arguments);if(!this.length)return this;var e,f,g,h=this,i=a.indexOf(" ");return i>=0&&(e=a.slice(i,a.length),a=a.slice(0,i)),p.isFunction(c)?(d=c,c=b):c&&typeof c=="object"&&(f="POST"),p.ajax({url:a,type:f,dataType:"html",data:c,complete:function(a,b){d&&h.each(d,g||[a.responseText,b,a])}}).done(function(a){g=arguments,h.html(e?p("<div>").append(a.replace(cr,"")).find(e):a)}),this},p.each("ajaxStart ajaxStop ajaxComplete ajaxError ajaxSuccess ajaxSend".split(" "),function(a,b){p.fn[b]=function(a){return this.on(b,a)}}),p.each(["get","post"],function(a,c){p[c]=function(a,d,e,f){return p.isFunction(d)&&(f=f||e,e=d,d=b),p.ajax({type:c,url:a,data:d,success:e,dataType:f})}}),p.extend({getScript:function(a,c){return p.get(a,b,c,"script")},getJSON:function(a,b,c){return p.get(a,b,c,"json")},ajaxSetup:function(a,b){return b?cB(a,p.ajaxSettings):(b=a,a=p.ajaxSettings),cB(a,b),a},ajaxSettings:{url:cj,isLocal:cn.test(ck[1]),global:!0,type:"GET",contentType:"application/x-www-form-urlencoded; charset=UTF-8",processData:!0,async:!0,accepts:{xml:"application/xml, text/xml",html:"text/html",text:"text/plain",json:"application/json, text/javascript","*":cx},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText"},converters:{"* text":a.String,"text html":!0,"text json":p.parseJSON,"text xml":p.parseXML},flatOptions:{context:!0,url:!0}},ajaxPrefilter:cz(cv),ajaxTransport:cz(cw),ajax:function(a,c){function y(a,c,f,i){var k,s,t,u,w,y=c;if(v===2)return;v=2,h&&clearTimeout(h),g=b,e=i||"",x.readyState=a>0?4:0,f&&(u=cC(l,x,f));if(a>=200&&a<300||a===304)l.ifModified&&(w=x.getResponseHeader("Last-Modified"),w&&(p.lastModified[d]=w),w=x.getResponseHeader("Etag"),w&&(p.etag[d]=w)),a===304?(y="notmodified",k=!0):(k=cD(l,u),y=k.state,s=k.data,t=k.error,k=!t);else{t=y;if(!y||a)y="error",a<0&&(a=0)}x.status=a,x.statusText=""+(c||y),k?o.resolveWith(m,[s,y,x]):o.rejectWith(m,[x,y,t]),x.statusCode(r),r=b,j&&n.trigger("ajax"+(k?"Success":"Error"),[x,l,k?s:t]),q.fireWith(m,[x,y]),j&&(n.trigger("ajaxComplete",[x,l]),--p.active||p.event.trigger("ajaxStop"))}typeof a=="object"&&(c=a,a=b),c=c||{};var d,e,f,g,h,i,j,k,l=p.ajaxSetup({},c),m=l.context||l,n=m!==l&&(m.nodeType||m instanceof p)?p(m):p.event,o=p.Deferred(),q=p.Callbacks("once memory"),r=l.statusCode||{},t={},u={},v=0,w="canceled",x={readyState:0,setRequestHeader:function(a,b){if(!v){var c=a.toLowerCase();a=u[c]=u[c]||a,t[a]=b}return this},getAllResponseHeaders:function(){return v===2?e:null},getResponseHeader:function(a){var c;if(v===2){if(!f){f={};while(c=cm.exec(e))f[c[1].toLowerCase()]=c[2]}c=f[a.toLowerCase()]}return c===b?null:c},overrideMimeType:function(a){return v||(l.mimeType=a),this},abort:function(a){return a=a||w,g&&g.abort(a),y(0,a),this}};o.promise(x),x.success=x.done,x.error=x.fail,x.complete=q.add,x.statusCode=function(a){if(a){var b;if(v<2)for(b in a)r[b]=[r[b],a[b]];else b=a[x.status],x.always(b)}return this},l.url=((a||l.url)+"").replace(cl,"").replace(cp,ck[1]+"//"),l.dataTypes=p.trim(l.dataType||"*").toLowerCase().split(s),l.crossDomain==null&&(i=ct.exec(l.url.toLowerCase()),l.crossDomain=!(!i||i[1]==ck[1]&&i[2]==ck[2]&&(i[3]||(i[1]==="http:"?80:443))==(ck[3]||(ck[1]==="http:"?80:443)))),l.data&&l.processData&&typeof l.data!="string"&&(l.data=p.param(l.data,l.traditional)),cA(cv,l,c,x);if(v===2)return x;j=l.global,l.type=l.type.toUpperCase(),l.hasContent=!co.test(l.type),j&&p.active++===0&&p.event.trigger("ajaxStart");if(!l.hasContent){l.data&&(l.url+=(cq.test(l.url)?"&":"?")+l.data,delete l.data),d=l.url;if(l.cache===!1){var z=p.now(),A=l.url.replace(cs,"$1_="+z);l.url=A+(A===l.url?(cq.test(l.url)?"&":"?")+"_="+z:"")}}(l.data&&l.hasContent&&l.contentType!==!1||c.contentType)&&x.setRequestHeader("Content-Type",l.contentType),l.ifModified&&(d=d||l.url,p.lastModified[d]&&x.setRequestHeader("If-Modified-Since",p.lastModified[d]),p.etag[d]&&x.setRequestHeader("If-None-Match",p.etag[d])),x.setRequestHeader("Accept",l.dataTypes[0]&&l.accepts[l.dataTypes[0]]?l.accepts[l.dataTypes[0]]+(l.dataTypes[0]!=="*"?", "+cx+"; q=0.01":""):l.accepts["*"]);for(k in l.headers)x.setRequestHeader(k,l.headers[k]);if(!l.beforeSend||l.beforeSend.call(m,x,l)!==!1&&v!==2){w="abort";for(k in{success:1,error:1,complete:1})x[k](l[k]);g=cA(cw,l,c,x);if(!g)y(-1,"No Transport");else{x.readyState=1,j&&n.trigger("ajaxSend",[x,l]),l.async&&l.timeout>0&&(h=setTimeout(function(){x.abort("timeout")},l.timeout));try{v=1,g.send(t,y)}catch(B){if(v<2)y(-1,B);else throw B}}return x}return x.abort()},active:0,lastModified:{},etag:{}});var cE=[],cF=/\?/,cG=/(=)\?(?=&|$)|\?\?/,cH=p.now();p.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=cE.pop()||p.expando+"_"+cH++;return this[a]=!0,a}}),p.ajaxPrefilter("json jsonp",function(c,d,e){var f,g,h,i=c.data,j=c.url,k=c.jsonp!==!1,l=k&&cG.test(j),m=k&&!l&&typeof i=="string"&&!(c.contentType||"").indexOf("application/x-www-form-urlencoded")&&cG.test(i);if(c.dataTypes[0]==="jsonp"||l||m)return f=c.jsonpCallback=p.isFunction(c.jsonpCallback)?c.jsonpCallback():c.jsonpCallback,g=a[f],l?c.url=j.replace(cG,"$1"+f):m?c.data=i.replace(cG,"$1"+f):k&&(c.url+=(cF.test(j)?"&":"?")+c.jsonp+"="+f),c.converters["script json"]=function(){return h||p.error(f+" was not called"),h[0]},c.dataTypes[0]="json",a[f]=function(){h=arguments},e.always(function(){a[f]=g,c[f]&&(c.jsonpCallback=d.jsonpCallback,cE.push(f)),h&&p.isFunction(g)&&g(h[0]),h=g=b}),"script"}),p.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/javascript|ecmascript/},converters:{"text script":function(a){return p.globalEval(a),a}}}),p.ajaxPrefilter("script",function(a){a.cache===b&&(a.cache=!1),a.crossDomain&&(a.type="GET",a.global=!1)}),p.ajaxTransport("script",function(a){if(a.crossDomain){var c,d=e.head||e.getElementsByTagName("head")[0]||e.documentElement;return{send:function(f,g){c=e.createElement("script"),c.async="async",a.scriptCharset&&(c.charset=a.scriptCharset),c.src=a.url,c.onload=c.onreadystatechange=function(a,e){if(e||!c.readyState||/loaded|complete/.test(c.readyState))c.onload=c.onreadystatechange=null,d&&c.parentNode&&d.removeChild(c),c=b,e||g(200,"success")},d.insertBefore(c,d.firstChild)},abort:function(){c&&c.onload(0,1)}}}});var cI,cJ=a.ActiveXObject?function(){for(var a in cI)cI[a](0,1)}:!1,cK=0;p.ajaxSettings.xhr=a.ActiveXObject?function(){return!this.isLocal&&cL()||cM()}:cL,function(a){p.extend(p.support,{ajax:!!a,cors:!!a&&"withCredentials"in a})}(p.ajaxSettings.xhr()),p.support.ajax&&p.ajaxTransport(function(c){if(!c.crossDomain||p.support.cors){var d;return{send:function(e,f){var g,h,i=c.xhr();c.username?i.open(c.type,c.url,c.async,c.username,c.password):i.open(c.type,c.url,c.async);if(c.xhrFields)for(h in c.xhrFields)i[h]=c.xhrFields[h];c.mimeType&&i.overrideMimeType&&i.overrideMimeType(c.mimeType),!c.crossDomain&&!e["X-Requested-With"]&&(e["X-Requested-With"]="XMLHttpRequest");try{for(h in e)i.setRequestHeader(h,e[h])}catch(j){}i.send(c.hasContent&&c.data||null),d=function(a,e){var h,j,k,l,m;try{if(d&&(e||i.readyState===4)){d=b,g&&(i.onreadystatechange=p.noop,cJ&&delete cI[g]);if(e)i.readyState!==4&&i.abort();else{h=i.status,k=i.getAllResponseHeaders(),l={},m=i.responseXML,m&&m.documentElement&&(l.xml=m);try{l.text=i.responseText}catch(a){}try{j=i.statusText}catch(n){j=""}!h&&c.isLocal&&!c.crossDomain?h=l.text?200:404:h===1223&&(h=204)}}}catch(o){e||f(-1,o)}l&&f(h,j,l,k)},c.async?i.readyState===4?setTimeout(d,0):(g=++cK,cJ&&(cI||(cI={},p(a).unload(cJ)),cI[g]=d),i.onreadystatechange=d):d()},abort:function(){d&&d(0,1)}}}});var cN,cO,cP=/^(?:toggle|show|hide)$/,cQ=new RegExp("^(?:([-+])=|)("+q+")([a-z%]*)$","i"),cR=/queueHooks$/,cS=[cY],cT={"*":[function(a,b){var c,d,e,f=this.createTween(a,b),g=cQ.exec(b),h=f.cur(),i=+h||0,j=1;if(g){c=+g[2],d=g[3]||(p.cssNumber[a]?"":"px");if(d!=="px"&&i){i=p.css(f.elem,a,!0)||c||1;do e=j=j||".5",i=i/j,p.style(f.elem,a,i+d),j=f.cur()/h;while(j!==1&&j!==e)}f.unit=d,f.start=i,f.end=g[1]?i+(g[1]+1)*c:c}return f}]};p.Animation=p.extend(cW,{tweener:function(a,b){p.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");var c,d=0,e=a.length;for(;d<e;d++)c=a[d],cT[c]=cT[c]||[],cT[c].unshift(b)},prefilter:function(a,b){b?cS.unshift(a):cS.push(a)}}),p.Tween=cZ,cZ.prototype={constructor:cZ,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(p.cssNumber[c]?"":"px")},cur:function(){var a=cZ.propHooks[this.prop];return a&&a.get?a.get(this):cZ.propHooks._default.get(this)},run:function(a){var b,c=cZ.propHooks[this.prop];return this.options.duration?this.pos=b=p.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):this.pos=b=a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):cZ.propHooks._default.set(this),this}},cZ.prototype.init.prototype=cZ.prototype,cZ.propHooks={_default:{get:function(a){var b;return a.elem[a.prop]==null||!!a.elem.style&&a.elem.style[a.prop]!=null?(b=p.css(a.elem,a.prop,!1,""),!b||b==="auto"?0:b):a.elem[a.prop]},set:function(a){p.fx.step[a.prop]?p.fx.step[a.prop](a):a.elem.style&&(a.elem.style[p.cssProps[a.prop]]!=null||p.cssHooks[a.prop])?p.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},cZ.propHooks.scrollTop=cZ.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},p.each(["toggle","show","hide"],function(a,b){var c=p.fn[b];p.fn[b]=function(d,e,f){return d==null||typeof d=="boolean"||!a&&p.isFunction(d)&&p.isFunction(e)?c.apply(this,arguments):this.animate(c$(b,!0),d,e,f)}}),p.fn.extend({fadeTo:function(a,b,c,d){return this.filter(bZ).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=p.isEmptyObject(a),f=p.speed(b,c,d),g=function(){var b=cW(this,p.extend({},a),f);e&&b.stop(!0)};return e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,c,d){var e=function(a){var b=a.stop;delete a.stop,b(d)};return typeof a!="string"&&(d=c,c=a,a=b),c&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,c=a!=null&&a+"queueHooks",f=p.timers,g=p._data(this);if(c)g[c]&&g[c].stop&&e(g[c]);else for(c in g)g[c]&&g[c].stop&&cR.test(c)&&e(g[c]);for(c=f.length;c--;)f[c].elem===this&&(a==null||f[c].queue===a)&&(f[c].anim.stop(d),b=!1,f.splice(c,1));(b||!d)&&p.dequeue(this,a)})}}),p.each({slideDown:c$("show"),slideUp:c$("hide"),slideToggle:c$("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){p.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),p.speed=function(a,b,c){var d=a&&typeof a=="object"?p.extend({},a):{complete:c||!c&&b||p.isFunction(a)&&a,duration:a,easing:c&&b||b&&!p.isFunction(b)&&b};d.duration=p.fx.off?0:typeof d.duration=="number"?d.duration:d.duration in p.fx.speeds?p.fx.speeds[d.duration]:p.fx.speeds._default;if(d.queue==null||d.queue===!0)d.queue="fx";return d.old=d.complete,d.complete=function(){p.isFunction(d.old)&&d.old.call(this),d.queue&&p.dequeue(this,d.queue)},d},p.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},p.timers=[],p.fx=cZ.prototype.init,p.fx.tick=function(){var a,b=p.timers,c=0;for(;c<b.length;c++)a=b[c],!a()&&b[c]===a&&b.splice(c--,1);b.length||p.fx.stop()},p.fx.timer=function(a){a()&&p.timers.push(a)&&!cO&&(cO=setInterval(p.fx.tick,p.fx.interval))},p.fx.interval=13,p.fx.stop=function(){clearInterval(cO),cO=null},p.fx.speeds={slow:600,fast:200,_default:400},p.fx.step={},p.expr&&p.expr.filters&&(p.expr.filters.animated=function(a){return p.grep(p.timers,function(b){return a===b.elem}).length});var c_=/^(?:body|html)$/i;p.fn.offset=function(a){if(arguments.length)return a===b?this:this.each(function(b){p.offset.setOffset(this,a,b)});var c,d,e,f,g,h,i,j,k,l,m=this[0],n=m&&m.ownerDocument;if(!n)return;return(e=n.body)===m?p.offset.bodyOffset(m):(d=n.documentElement,p.contains(d,m)?(c=m.getBoundingClientRect(),f=da(n),g=d.clientTop||e.clientTop||0,h=d.clientLeft||e.clientLeft||0,i=f.pageYOffset||d.scrollTop,j=f.pageXOffset||d.scrollLeft,k=c.top+i-g,l=c.left+j-h,{top:k,left:l}):{top:0,left:0})},p.offset={bodyOffset:function(a){var b=a.offsetTop,c=a.offsetLeft;return p.support.doesNotIncludeMarginInBodyOffset&&(b+=parseFloat(p.css(a,"marginTop"))||0,c+=parseFloat(p.css(a,"marginLeft"))||0),{top:b,left:c}},setOffset:function(a,b,c){var d=p.css(a,"position");d==="static"&&(a.style.position="relative");var e=p(a),f=e.offset(),g=p.css(a,"top"),h=p.css(a,"left"),i=(d==="absolute"||d==="fixed")&&p.inArray("auto",[g,h])>-1,j={},k={},l,m;i?(k=e.position(),l=k.top,m=k.left):(l=parseFloat(g)||0,m=parseFloat(h)||0),p.isFunction(b)&&(b=b.call(a,c,f)),b.top!=null&&(j.top=b.top-f.top+l),b.left!=null&&(j.left=b.left-f.left+m),"using"in b?b.using.call(a,j):e.css(j)}},p.fn.extend({position:function(){if(!this[0])return;var a=this[0],b=this.offsetParent(),c=this.offset(),d=c_.test(b[0].nodeName)?{top:0,left:0}:b.offset();return c.top-=parseFloat(p.css(a,"marginTop"))||0,c.left-=parseFloat(p.css(a,"marginLeft"))||0,d.top+=parseFloat(p.css(b[0],"borderTopWidth"))||0,d.left+=parseFloat(p.css(b[0],"borderLeftWidth"))||0,{top:c.top-d.top,left:c.left-d.left}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||e.body;while(a&&!c_.test(a.nodeName)&&p.css(a,"position")==="static")a=a.offsetParent;return a||e.body})}}),p.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(a,c){var d=/Y/.test(c);p.fn[a]=function(e){return p.access(this,function(a,e,f){var g=da(a);if(f===b)return g?c in g?g[c]:g.document.documentElement[e]:a[e];g?g.scrollTo(d?p(g).scrollLeft():f,d?f:p(g).scrollTop()):a[e]=f},a,e,arguments.length,null)}}),p.each({Height:"height",Width:"width"},function(a,c){p.each({padding:"inner"+a,content:c,"":"outer"+a},function(d,e){p.fn[e]=function(e,f){var g=arguments.length&&(d||typeof e!="boolean"),h=d||(e===!0||f===!0?"margin":"border");return p.access(this,function(c,d,e){var f;return p.isWindow(c)?c.document.documentElement["client"+a]:c.nodeType===9?(f=c.documentElement,Math.max(c.body["scroll"+a],f["scroll"+a],c.body["offset"+a],f["offset"+a],f["client"+a])):e===b?p.css(c,d,e,h):p.style(c,d,e,h)},c,g?e:b,g,null)}})}),a.jQuery=a.$=p,typeof define=="function"&&define.amd&&define.amd.jQuery&&define("jquery",[],function(){return p})})(window);//]]>
</script>
<script id="jqueryArea" type="text/javascript">
//<![CDATA[
/*
jQuery.encoding.digests.sha1.js

SHA-1 digest and associated utility functions

Copyright (c) UnaMesa Association 2009

Dual licensed under the MIT and GPL licenses:
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

if(!$.encoding)
	$.encoding = {};
	$.extend($.encoding,{
		strToBe32s: function(str) {
			// Convert a string to an array of big-endian 32-bit words
			var be=[];
			var len=Math.floor(str.length/4);
			var i, j;
			for(i=0, j=0; i<len; i++, j+=4) {
				be[i]=((str.charCodeAt(j)&0xff) << 24)|((str.charCodeAt(j+1)&0xff) << 16)|((str.charCodeAt(j+2)&0xff) << 8)|(str.charCodeAt(j+3)&0xff);
			}
			while(j<str.length) {
				be[j>>2] |= (str.charCodeAt(j)&0xff)<<(24-(j*8)%32);
				j++;
			}
			return be;
		},
		be32sToStr: function(be) {
			// Convert an array of big-endian 32-bit words to a string
			var str='';
			for(var i=0;i<be.length*32;i+=8) {
				str += String.fromCharCode((be[i>>5]>>>(24-i%32)) & 0xff);
			}
			return str;
		},
		be32sToHex: function(be) {
			// Convert an array of big-endian 32-bit words to a hex string
			var hex='0123456789ABCDEF';
			var str='';
			for(var i=0;i<be.length*4;i++) {
				str += hex.charAt((be[i>>2]>>((3-i%4)*8+4))&0xF) + hex.charAt((be[i>>2]>>((3-i%4)*8))&0xF);
			}
			return str;
		}
	});
})(jQuery);


(function($) {

if(!$.encoding.digests)
	$.encoding.digests = {};
	$.extend($.encoding.digests,{
		hexSha1Str: function(str) {
			// Return, in hex, the SHA-1 hash of a string
			return $.encoding.be32sToHex($.encoding.digests.sha1Str(str));
		},
		sha1Str: function(str) {
			// Return the SHA-1 hash of a string
			return sha1($.encoding.strToBe32s(str),str.length);
		},
		sha1: function(x,blen) {
			// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
			return sha1($.encoding.strToBe32s(str),str.length);
		}
	});

	// Private functions.
	function sha1(x,blen) {
		// Calculate the SHA-1 hash of an array of blen bytes of big-endian 32-bit words
		function add32(a,b) {
			// Add 32-bit integers, wrapping at 32 bits
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			var lsw=(a&0xFFFF)+(b&0xFFFF);
			var msw=(a>>16)+(b>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function AA(a,b,c,d,e) {
			// Cryptographic round helper function. Add five 32-bit integers, wrapping at 32 bits, second parameter is rotated left 5 bits before the addition
			// Uses 16-bit operations internally to work around bugs in some JavaScript interpreters.
			b=(b>>>27)|(b<<5);
			var lsw=(a&0xFFFF)+(b&0xFFFF)+(c&0xFFFF)+(d&0xFFFF)+(e&0xFFFF);
			var msw=(a>>16)+(b>>16)+(c>>16)+(d>>16)+(e>>16)+(lsw>>16);
			return (msw<<16)|(lsw&0xFFFF);
		}
		function RR(w,j) {
			// Cryptographic round helper function.
			var n=w[j-3]^w[j-8]^w[j-14]^w[j-16];
			return (n>>>31)|(n<<1);
		}

		var len=blen*8;
		x[len>>5] |= 0x80 << (24-len%32);
		x[((len+64>>9)<<4)+15]=len;
		var w=new Array(80);

		var k1=0x5A827999;
		var k2=0x6ED9EBA1;
		var k3=0x8F1BBCDC;
		var k4=0xCA62C1D6;

		var h0=0x67452301;
		var h1=0xEFCDAB89;
		var h2=0x98BADCFE;
		var h3=0x10325476;
		var h4=0xC3D2E1F0;

		for(var i=0;i<x.length;i+=16) {
			var j=0;
			var t;
			var a=h0;
			var b=h1;
			var c=h2;
			var d=h3;
			var e=h4;
			while(j<16) {
				w[j]=x[i+j];
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<20) {
				w[j]=RR(w,j);
				t=AA(e,a,d^(b&(c^d)),w[j],k1);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<40) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k2);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<60) {
				w[j]=RR(w,j);
				t=AA(e,a,(b&c)|(d&(b|c)),w[j],k3);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			while(j<80) {
				w[j]=RR(w,j);
				t=AA(e,a,b^c^d,w[j],k4);
				e=d; d=c; c=(b>>>2)|(b<<30); b=a; a=t; j++;
			}
			h0=add32(h0,a);
			h1=add32(h1,b);
			h2=add32(h2,c);
			h3=add32(h3,d);
			h4=add32(h4,e);
		}
		return [h0,h1,h2,h3,h4];
	}
})(jQuery);

/*
jQuery.twStylesheet.js

jQuery plugin to dynamically insert CSS rules into a document

Usage:
  jQuery.twStylesheet applies style definitions
  jQuery.twStylesheet.remove neutralizes style definitions

Copyright (c) UnaMesa Association 2009

Triple licensed under the BSD, MIT and GPL licenses:
  http://www.opensource.org/licenses/bsd-license.php
  http://www.opensource.org/licenses/mit-license.php
  http://www.gnu.org/licenses/gpl.html
*/

(function($) {

var defaultId = "customStyleSheet"; // XXX: rename to dynamicStyleSheet?

// Add or replace a style sheet
// css argument is a string of CSS rule sets
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
// N.B.: Uses DOM methods instead of jQuery to ensure cross-browser comaptibility.
$.twStylesheet = function(css, options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(doc.createStyleSheet) { // IE-specific handling
		if(el) {
			el.parentNode.removeChild(el);
		}
		doc.getElementsByTagName("head")[0].insertAdjacentHTML("beforeEnd",
			'&nbsp;<style id="' + id + '" type="text/css">' + css + '</style>'); // fails without &nbsp;
	} else { // modern browsers
		if(el) {
			el.replaceChild(doc.createTextNode(css), el.firstChild);
		} else {
			el = doc.createElement("style");
			el.type = "text/css";
			el.id = id;
			el.appendChild(doc.createTextNode(css));
			doc.getElementsByTagName("head")[0].appendChild(el);
		}
	}
};

// Remove existing style sheet
// options.id is an optional name identifying the style sheet
// options.doc is an optional document reference
$.twStylesheet.remove = function(options) {
	options = options || {};
	var id = options.id || defaultId;
	var doc = options.doc || document;
	var el = doc.getElementById(id);
	if(el) {
		el.parentNode.removeChild(el);
	}
};

})(jQuery);
//]]>
</script>
<script type="text/javascript">
//<![CDATA[
if(useJavaSaver)
	document.write("<applet style='position:absolute;left:-1px' name='TiddlySaver' code='TiddlySaver.class' archive='TiddlySaver.jar' width='1' height='1'></applet>");
//]]>
</script>
<!--POST-SCRIPT-START-->

<!--POST-SCRIPT-END-->
</body>
</html>
